<?xml version="1.0" encoding="utf-8"?>
<search>
  <entry>
    <title>Personal works</title>
    <url>/2025/07/14/Researches/</url>
    <content><![CDATA[<h1 id="Secure-AI-Systems-A-Layered-Perspective"><a href="#Secure-AI-Systems-A-Layered-Perspective" class="headerlink" title="Secure AI Systems: A Layered Perspective"></a>Secure AI Systems: A Layered Perspective</h1><p>My Ph.D. research focuses on <strong>AI system security</strong>, from high-level application risks, through AI framework-level vulnerabilities, to low-level hardware exploitation. This layered exploration reveals systemic threats that span across the full AI software stack.</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250718095603049.png" alt="image-20250718095603049"></p>
<hr>
<h2 id="ğŸ§©-Layer-1-Application-Level-â€”-Python-Module-Conflicts"><a href="#ğŸ§©-Layer-1-Application-Level-â€”-Python-Module-Conflicts" class="headerlink" title="ğŸ§© Layer 1: Application-Level â€” Python Module Conflicts"></a>ğŸ§© Layer 1: Application-Level â€” Python Module Conflicts</h2><p><strong>Paper:</strong> <em>ModuleGuard: Understanding and Detecting Module Conflicts in Python Ecosystem</em> (ICSE 2024)<br><strong>Link:</strong> <a href="https://doi.org/10.1145/3597503.3639221">DOI: 10.1145&#x2F;3597503.3639221</a></p>
<p>Python has become the most important language for AI development. However, the ecosystem suffers from <strong>module conflicts</strong> (MCs), where different packages accidentally override or confuse module imports. These conflicts can cause runtime failures and make model deployment errors.</p>
<ul>
<li>Module overwriting at install time</li>
<li>Import confusion at runtime</li>
</ul>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250718100609973.png" alt="image-20250718100609973"></p>
<p>We systematically studied MCs across 4.2M PyPI packages and 3.7k GitHub projects. Our tool <strong>ModuleGuard</strong> leverages semantic-aware static analysis and installation simulation to detect:</p>
<blockquote>
<p>ğŸ”§ We proposed <code>ModuleGuard</code> and analyzed the ecosystem at scale, uncovering thousands of silent module-level module conflict issues in real-world projects.</p>
</blockquote>
<hr>
<h2 id="ğŸ§ -Layer-2-Framework-Level-â€”-Frameworkâ€™s-API-based-Malicious-Models"><a href="#ğŸ§ -Layer-2-Framework-Level-â€”-Frameworkâ€™s-API-based-Malicious-Models" class="headerlink" title="ğŸ§  Layer 2: Framework-Level â€” Frameworkâ€™s API-based Malicious Models"></a>ğŸ§  Layer 2: Framework-Level â€” Frameworkâ€™s API-based Malicious Models</h2><p><strong>Paper:</strong> <em>My Model is Malware to You: Transforming AI Models into Malware by Abusing TensorFlow APIs</em> (S&amp;P25)<br><strong>Link:</strong> <a href="https://github.com/ZJU-SEC/TensorAbuse">GitHub: TensorAbuse</a></p>
<p>Model sharing enables innovation â€” but also risk. We proposed the <strong>TensorAbuse</strong> attack, which abuses <strong>legitimate TensorFlow APIs</strong> (like <code>tf.io.matching_files</code>, <code>tf.raw_ops.DebugIdentityV3</code>) to:</p>
<ul>
<li>Read arbitrary files</li>
<li>Leak IPs</li>
<li>Send data to external servers</li>
<li>Get shell</li>
</ul>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250718101049930.png" alt="image-20250718101049930"></p>
<p>These <strong>attacks are embedded in the model graph</strong>, and get executed silently during inference â€” <strong>Users cannot be aware of them</strong>.</p>
<blockquote>
<p>ğŸš¨ We found 1,083 persistent TensorFlow APIs. 20 APIs in them can be abused to cause malicious behaviours. None of the current model hubs (e.g., Hugging Face, TensorFlow Hub) or scanners (e.g., ModelScan) could detect our synthetic malware.</p>
</blockquote>
<hr>
<h2 id="ğŸ”-Layer-3-Hardware-Level-â€”-GPU-ASLR-Weakness"><a href="#ğŸ”-Layer-3-Hardware-Level-â€”-GPU-ASLR-Weakness" class="headerlink" title="ğŸ” Layer 3: Hardware-Level â€” GPU ASLR Weakness"></a>ğŸ” Layer 3: Hardware-Level â€” GPU ASLR Weakness</h2><p><strong>Paper:</strong> <em>Demystifying and Exploiting ASLR on NVIDIA GPUs</em><br><strong>Status:</strong> Under submission </p>
<p>Modern AI workloads run on GPUs, but their memory layout is opaque. We reverse-engineered <strong>NVIDIA GPUâ€™s ASLR implementation</strong>, uncovering multiple critical flaws:</p>
<ul>
<li>GPU heap is entirely <strong>unrandomized</strong></li>
<li><strong>Correlated offsets</strong> between GPU and CPU ASLR undermine both</li>
<li>Some regions are shared across all CUDA processes, enabling <strong>covert channels</strong></li>
</ul>
<p>We built two tools:</p>
<ul>
<li><strong>FlagProbe</strong> to recover memory segment semantics</li>
<li><strong>AnchorTrace</strong> to trace randomized addresses recursively and infer ASLR entropy</li>
</ul>
<blockquote>
<p>ğŸ§ª We showed that GPU memory layout leaks can be exploited to infer CPU glibc addresses â€” undermining fundamental ASLR protections.</p>
</blockquote>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250718103738923.png" alt="image-20250718103738923"></p>
<hr>
<h2 id="ğŸ“«-Contact"><a href="#ğŸ“«-Contact" class="headerlink" title="ğŸ“« Contact"></a>ğŸ“« Contact</h2><p>If youâ€™re interested in collaboration, feel free to reach out:</p>
<ul>
<li>ğŸ“§ Email: <a href="mailto:&#122;&#104;&#117;&#x72;&#x75;&#x6f;&#x66;&#97;&#x6e;&#64;&#122;&#106;&#117;&#x2e;&#101;&#x64;&#117;&#x2e;&#99;&#x6e;">zhuruofan@zju.edu.cn</a></li>
<li>ğŸ”— GitHub: <a href="https://github.com/unsatisfying">ZJU-SEC</a></li>
</ul>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>gpu</tag>
      </tags>
  </entry>
  <entry>
    <title>å†…å­˜ç®¡ç†2</title>
    <url>/2025/09/19/note/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%862/</url>
    <content><![CDATA[<h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><p>Linuxçš„å†…å­˜ç®¡ç†å®é™…ä¸Šéå¸¸å¤æ‚ï¼ŒåŒ…æ‹¬ç‰©ç†å†…å­˜çš„ç®¡ç†ï¼Œè®¾å¤‡å†…å­˜çš„ç®¡ç†ä»¥åŠè™šæ‹Ÿå†…å­˜çš„ç®¡ç†ï¼Œæˆ‘ä»¬å°±ä¸€ç‚¹ç‚¹æ¥åˆ†æå‘—ã€‚é¦–å…ˆæ˜¯Linuxçš„å¯è®¿é—®çš„å†…å­˜å¹¶ä¸ä»…ä»…æŒ‡çš„æ˜¯å†…å­˜æ¡ä¸Šçš„ç‰©ç†å†…å­˜ï¼Œä¹ŸåŒ…æ‹¬å¾ˆå¤šè®¾å¤‡çš„å†…å­˜å’Œè®¾å¤‡å¯„å­˜å™¨çš„æ˜ å°„ï¼Œè¿™äº›å†…å­˜ä¼šé€šè¿‡MMIOæ˜ å°„åˆ°Linuxçš„ç‰©ç†å†…å­˜è¿›è¡Œç®¡ç†ã€‚</p>
<h1 id="ç‰©ç†å†…å­˜ç®¡ç†"><a href="#ç‰©ç†å†…å­˜ç®¡ç†" class="headerlink" title="ç‰©ç†å†…å­˜ç®¡ç†"></a>ç‰©ç†å†…å­˜ç®¡ç†</h1><p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹ç‰©ç†å†…å­˜æ˜¯æ€ä¹ˆç®¡ç†çš„ã€‚</p>
<p>é¦–å…ˆç°ä»£å¤„ç†å™¨åŸºæœ¬éƒ½æ˜¯NUMAæ¶æ„ï¼Œè¿™æ„å‘³ç€å¤„ç†å™¨é€šè¿‡å¢åŠ äº†å†…å­˜è®¿é—®æ§åˆ¶å™¨æ¥æé«˜äº†å†…å­˜è®¿é—®å¸¦å®½ï¼Œä½†æ˜¯ä¸åŒçš„coreåœ¨è®¿é—®ä¸åŒå†…å­˜åŒºåŸŸæ—¶ä¼šå­˜åœ¨ä¸€å®šçš„é€Ÿåº¦å·®å¼‚ï¼Œè¿™æ˜¯ç”±äºå†…å­˜çš„ç»„ç»‡å’Œæ¥å£åˆ†å¸ƒåœ¨ä¸åŒä½ç½®å†³å®šçš„ã€‚å› æ­¤ï¼Œç‰©ç†å†…å­˜ä¼šè¢«åˆ†ä¸ºå¤šä¸ªnodeæ¥è¿›è¡Œåˆ’åˆ†ã€‚</p>
<p>Linuxä¸­ç‰©ç†å†…å­˜çš„ç®¡ç†å¤§è‡´å¯ä»¥åˆ†ä¸ºNode-&gt;Zone-&gt;Page.</p>
<ul>
<li><p><strong>Nodeï¼ˆpglist_dataï¼‰</strong>ï¼šåœ¨ NUMAï¼ˆéä¸€è‡´å†…å­˜è®¿é—®ï¼‰ç³»ç»Ÿä¸­ï¼Œæ¯ä¸ª CPU èŠ‚ç‚¹éƒ½æœ‰è‡ªå·±ç‹¬ç«‹çš„å†…å­˜åŒºåŸŸã€‚æ¯ä¸ªè¿™æ ·çš„èŠ‚ç‚¹ç”±ä¸€ä¸ª <code>pglist_data</code> ç»“æ„ä½“ç®¡ç†ã€‚</p>
</li>
<li><p><strong>Zoneï¼ˆzoneï¼‰</strong>ï¼šèŠ‚ç‚¹å†…éƒ¨åˆåˆ†ä¸ºä¸åŒâ€œç±»å‹â€çš„å†…å­˜åŒºåŸŸï¼ˆä¾‹å¦‚ DMA åŒºã€æ™®é€šåŒºã€HighMem åŒºç­‰ï¼‰ã€‚</p>
</li>
<li><p><strong>Pageï¼ˆstruct pageï¼‰</strong>ï¼šZone å†…éƒ¨çš„æœ€å°ç®¡ç†å•ä½ï¼Œå³é¡µæ¡†ã€‚</p>
</li>
</ul>
<h2 id="Node"><a href="#Node" class="headerlink" title="Node"></a>Node</h2><p>åœ¨å†…æ ¸æºç ä¸­ï¼Œç”¨pglist_dataç»“æ„ä½“æ¥è¡¨ç¤ºä¸€ä¸ªnodeç»“ç‚¹çš„ä¸Šå†…å­˜ç›¸å…³æ•°æ®ã€‚åœ¨UMAæ¶æ„ä¸‹åªæœ‰ä¸€ä¸ªpglist_dataç»“æ„ä½“ï¼Œè€Œåœ¨numaæ¶æ„ä¸‹ä¼šæœ‰å¤šä¸ªã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//arch/x86/mm/numa.c</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> *<span class="title">node_data</span>[<span class="title">MAX_NUMNODES</span>] __<span class="title">read_mostly</span>;</span></span><br><span class="line">EXPORT_SYMBOL(node_data);</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> <span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * node_zones contains just the zones for THIS node. Not all of the</span></span><br><span class="line"><span class="comment">	 * zones may be populated, but it is the full list. It is referenced by</span></span><br><span class="line"><span class="comment">	 * this node&#x27;s node_zonelists as well as other node&#x27;s node_zonelists.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zone</span> <span class="title">node_zones</span>[<span class="title">MAX_NR_ZONES</span>];</span> <span class="comment">//ä¸€ä¸ªèŠ‚ç‚¹åŒ…å«å¤šä¸ªå†…å­˜åŒºï¼ˆzoneï¼‰ä¾‹å¦‚: ZONE_DMA,ZONE_DMA32,ZONE_NORMAL,ZONE_HIGHMEMï¼ˆåœ¨x86 32bitï¼‰.æ¯ä¸ª struct zone ç®¡ç†è¯¥åŒºåŸŸçš„é¡µæ¡†åˆ†é…ã€å›æ”¶ã€ç©ºé—²é¡µã€ä¼™ä¼´ç³»ç»Ÿç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * node_zonelists contains references to all zones in all nodes.</span></span><br><span class="line"><span class="comment">	 * Generally the first zones will be references to this node&#x27;s</span></span><br><span class="line"><span class="comment">	 * node_zones.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">zonelist</span> <span class="title">node_zonelists</span>[<span class="title">MAX_ZONELISTS</span>];</span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> nr_zones; <span class="comment">/* number of populated zones in this node */</span> <span class="comment">//å½“å‰èŠ‚ç‚¹ä¸Šå®é™…è¢«åˆå§‹åŒ–çš„ zone æ•°é‡ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_FLATMEM	<span class="comment">/* means !SPARSEMEM */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">node_mem_map</span>;</span>  <span class="comment">//è¿™æ˜¯èŠ‚ç‚¹çš„ struct page æ•°ç»„ï¼ˆå³ â€œmem_mapâ€ï¼‰ï¼Œæ¯ä¸ªç‰©ç†é¡µæ¡†å¯¹åº”ä¸€ä¸ª struct pageã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PAGE_EXTENSION</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page_ext</span> *<span class="title">node_page_ext</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">......</span><br><span class="line">&#125; <span class="type">pg_data_t</span>;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“è¿æ¥çš„æ–¹å¼å‚è€ƒå›¾ã€‚è¿˜æœ‰å…¶ä»–ä¸€äº›ç»“æ„æ˜¯é”å’Œæ•°æ®ç»Ÿè®¡ï¼Œä»¥åŠå’Œçƒ­æ’æ‹”ç›¸å…³çš„ï¼Œè¿™é‡Œå°±ä¸åšç»†è¯´</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251005211616201.png" alt="image-20251005211616201"></p>
<h2 id="Zone"><a href="#Zone" class="headerlink" title="Zone"></a>Zone</h2><p>é¦–å…ˆæ˜¯Zoneçš„ç±»å‹æœ‰ä»¥ä¸‹å‡ ç§,å…·ä½“æ¯ä¸€ç§Zoneçš„ç”¨æ³•çœ‹æ³¨é‡Šå³å¯ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">zone_type</span> &#123;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ZONE_DMA and ZONE_DMA32 are used when there are peripherals not able</span></span><br><span class="line"><span class="comment">	 * to DMA to all of the addressable memory (ZONE_NORMAL).</span></span><br><span class="line"><span class="comment">	 * On architectures where this area covers the whole 32 bit address</span></span><br><span class="line"><span class="comment">	 * space ZONE_DMA32 is used. ZONE_DMA is left for the ones with smaller</span></span><br><span class="line"><span class="comment">	 * DMA addressing constraints. This distinction is important as a 32bit</span></span><br><span class="line"><span class="comment">	 * DMA mask is assumed when ZONE_DMA32 is defined. Some 64-bit</span></span><br><span class="line"><span class="comment">	 * platforms may need both zones as they support peripherals with</span></span><br><span class="line"><span class="comment">	 * different DMA addressing limitations.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA</span></span><br><span class="line">	ZONE_DMA, <span class="comment">//ä½ç«¯ DMA å¯è¾¾å†…å­˜åŒºï¼ˆé€šå¸¸ä¸º &lt;16MB æˆ– &lt;32MBï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DMA32</span></span><br><span class="line">	ZONE_DMA32, <span class="comment">//ä½ç«¯ DMA å¯è¾¾å†…å­˜åŒºï¼ˆé€šå¸¸ä¸º &lt;16MB æˆ– &lt;32MBï¼‰</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Normal addressable memory is in ZONE_NORMAL. DMA operations can be</span></span><br><span class="line"><span class="comment">	 * performed on pages in ZONE_NORMAL if the DMA devices support</span></span><br><span class="line"><span class="comment">	 * transfers to all addressable memory.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_NORMAL,<span class="comment">//æ™®é€šçš„ã€å†…æ ¸ç›´æ¥çº¿æ€§æ˜ å°„çš„ç‰©ç†å†…å­˜åŒºã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_HIGHMEM</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A memory area that is only addressable by the kernel through</span></span><br><span class="line"><span class="comment">	 * mapping portions into its own address space. This is for example</span></span><br><span class="line"><span class="comment">	 * used by i386 to allow the kernel to address the memory beyond</span></span><br><span class="line"><span class="comment">	 * 900MB. The kernel will set up special mappings (page</span></span><br><span class="line"><span class="comment">	 * table entries on i386) for each page that the kernel needs to</span></span><br><span class="line"><span class="comment">	 * access.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_HIGHMEM, <span class="comment">//é«˜ç«¯å†…å­˜åŒºï¼šCPU ä¸èƒ½ç›´æ¥çº¿æ€§æ˜ å°„è®¿é—®çš„ç‰©ç†å†…å­˜ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * ZONE_MOVABLE is similar to ZONE_NORMAL, except that it contains</span></span><br><span class="line"><span class="comment">	 * movable pages with few exceptional cases described below. Main use</span></span><br><span class="line"><span class="comment">	 * cases for ZONE_MOVABLE are to make memory offlining/unplug more</span></span><br><span class="line"><span class="comment">	 * likely to succeed, and to locally limit unmovable allocations - e.g.,</span></span><br><span class="line"><span class="comment">	 * to increase the number of THP/huge pages. Notable special cases are:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * 1. Pinned pages: (long-term) pinning of movable pages might</span></span><br><span class="line"><span class="comment">	 *    essentially turn such pages unmovable. Therefore, we do not allow</span></span><br><span class="line"><span class="comment">	 *    pinning long-term pages in ZONE_MOVABLE. When pages are pinned and</span></span><br><span class="line"><span class="comment">	 *    faulted, they come from the right zone right away. However, it is</span></span><br><span class="line"><span class="comment">	 *    still possible that address space already has pages in</span></span><br><span class="line"><span class="comment">	 *    ZONE_MOVABLE at the time when pages are pinned (i.e. user has</span></span><br><span class="line"><span class="comment">	 *    touches that memory before pinning). In such case we migrate them</span></span><br><span class="line"><span class="comment">	 *    to a different zone. When migration fails - pinning fails.</span></span><br><span class="line"><span class="comment">	 * 2. memblock allocations: kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment">	 *    situations where ZONE_MOVABLE contains unmovable allocations</span></span><br><span class="line"><span class="comment">	 *    after boot. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">	 * 3. Memory holes: kernelcore/movablecore setups might create very rare</span></span><br><span class="line"><span class="comment">	 *    situations where ZONE_MOVABLE contains memory holes after boot,</span></span><br><span class="line"><span class="comment">	 *    for example, if we have sections that are only partially</span></span><br><span class="line"><span class="comment">	 *    populated. Memory offlining and allocations fail early.</span></span><br><span class="line"><span class="comment">	 * 4. PG_hwpoison pages: while poisoned pages can be skipped during</span></span><br><span class="line"><span class="comment">	 *    memory offlining, such pages cannot be allocated.</span></span><br><span class="line"><span class="comment">	 * 5. Unmovable PG_offline pages: in paravirtualized environments,</span></span><br><span class="line"><span class="comment">	 *    hotplugged memory blocks might only partially be managed by the</span></span><br><span class="line"><span class="comment">	 *    buddy (e.g., via XEN-balloon, Hyper-V balloon, virtio-mem). The</span></span><br><span class="line"><span class="comment">	 *    parts not manged by the buddy are unmovable PG_offline pages. In</span></span><br><span class="line"><span class="comment">	 *    some cases (virtio-mem), such pages can be skipped during</span></span><br><span class="line"><span class="comment">	 *    memory offlining, however, cannot be moved/allocated. These</span></span><br><span class="line"><span class="comment">	 *    techniques might use alloc_contig_range() to hide previously</span></span><br><span class="line"><span class="comment">	 *    exposed pages from the buddy again (e.g., to implement some sort</span></span><br><span class="line"><span class="comment">	 *    of memory unplug in virtio-mem).</span></span><br><span class="line"><span class="comment">	 * 6. ZERO_PAGE(0), kernelcore/movablecore setups might create</span></span><br><span class="line"><span class="comment">	 *    situations where ZERO_PAGE(0) which is allocated differently</span></span><br><span class="line"><span class="comment">	 *    on different platforms may end up in a movable zone. ZERO_PAGE(0)</span></span><br><span class="line"><span class="comment">	 *    cannot be migrated.</span></span><br><span class="line"><span class="comment">	 * 7. Memory-hotplug: when using memmap_on_memory and onlining the</span></span><br><span class="line"><span class="comment">	 *    memory to the MOVABLE zone, the vmemmap pages are also placed in</span></span><br><span class="line"><span class="comment">	 *    such zone. Such pages cannot be really moved around as they are</span></span><br><span class="line"><span class="comment">	 *    self-stored in the range, but they are treated as movable when</span></span><br><span class="line"><span class="comment">	 *    the range they describe is about to be offlined.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * In general, no unmovable allocations that degrade memory offlining</span></span><br><span class="line"><span class="comment">	 * should end up in ZONE_MOVABLE. Allocators (like alloc_contig_range())</span></span><br><span class="line"><span class="comment">	 * have to expect that migrating pages in ZONE_MOVABLE can fail (even</span></span><br><span class="line"><span class="comment">	 * if has_unmovable_pages() states that there are no unmovable pages,</span></span><br><span class="line"><span class="comment">	 * there can be false negatives).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ZONE_MOVABLE, <span class="comment">//å¯è¿ç§»å†…å­˜åŒºï¼Œä¸»è¦ç”¨äºå†…å­˜çƒ­æ’æ‹”å’Œå¤§é¡µç®¡ç†ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ZONE_DEVICE</span></span><br><span class="line">	ZONE_DEVICE, <span class="comment">//è®¾å¤‡ä¸“ç”¨å†…å­˜åŒºï¼ˆéæ ‡å‡† DRAM é¡µï¼‰ï¼Œå¦‚æŒä¹…å†…å­˜ï¼ˆNVDIMMï¼‰ã€GPU BARã€CXL Memoryã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	__MAX_NR_ZONES</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">ç‰©ç†åœ°å€ç©ºé—´</span></span><br><span class="line"><span class="comment">â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”</span></span><br><span class="line"><span class="comment">â”‚ ZONE_DMA        (&lt;16MB)      â”‚ â†’ legacy ISA DMA</span></span><br><span class="line"><span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span><br><span class="line"><span class="comment">â”‚ ZONE_DMA32      (&lt;4GB)       â”‚ â†’ 32-bit PCIe DMA</span></span><br><span class="line"><span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span><br><span class="line"><span class="comment">â”‚ ZONE_NORMAL     (&gt;=4GB)      â”‚ â†’ kernel, user, pagecache</span></span><br><span class="line"><span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span><br><span class="line"><span class="comment">â”‚ ZONE_MOVABLE                â”‚ â†’ movable pages, hotplug</span></span><br><span class="line"><span class="comment">â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤</span></span><br><span class="line"><span class="comment">â”‚ ZONE_DEVICE                 â”‚ â†’ device memory (PMEM, GPU)</span></span><br><span class="line"><span class="comment">â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>çœ‹å®Œäº†ä¸åŒç§ç±»çš„Zoneï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹Zoneç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span> &#123;</span></span><br><span class="line">	<span class="comment">/* Read-mostly fields */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone watermarks, access with *_wmark_pages(zone) macros */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> _watermark[NR_WMARK]; <span class="comment">//æœ¬å†…å­˜åŒºåŸŸçš„ä¸‰ä¸ªæ°´çº¿ï¼Œé«˜ä¸­ä½</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> watermark_boost;</span><br><span class="line"></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> nr_reserved_highatomic;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * We don&#x27;t know if the memory that we&#x27;re going to allocate will be</span></span><br><span class="line"><span class="comment">	 * freeable or/and it will be released eventually, so to avoid totally</span></span><br><span class="line"><span class="comment">	 * wasting several GB of ram we must reserve some of the lower zone</span></span><br><span class="line"><span class="comment">	 * memory (otherwise we risk to run OOM on the lower zones despite</span></span><br><span class="line"><span class="comment">	 * there being tons of freeable ram on the higher zones).  This array is</span></span><br><span class="line"><span class="comment">	 * recalculated at runtime if the sysctl_lowmem_reserve_ratio sysctl</span></span><br><span class="line"><span class="comment">	 * changes.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">long</span> lowmem_reserve[MAX_NR_ZONES]; <span class="comment">//ä¸ºå„å†…å­˜ä¸æŒ‡å®šè‹¥å¹²é¡µé¢ï¼Œç”¨äºæ— è®ºå¦‚ä½•éƒ½ä¸èƒ½å¤±è´¥çš„å†…å­˜åˆ†é…</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="type">int</span> node; <span class="comment">//æœ¬Zoneæ‰€å±Nodeçš„id</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pglist_data</span>	*<span class="title">zone_pgdat</span>;</span> <span class="comment">//æŒ‡å‘å¯¹åº”Nodeçš„pglist_dataç»“æ„ä½“</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_pages</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_pageset</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">per_cpu_zonestat</span>	__<span class="title">percpu</span> *<span class="title">per_cpu_zonestats</span>;</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * the high and batch values are copied to individual pagesets for</span></span><br><span class="line"><span class="comment">	 * faster access</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> pageset_high_min;</span><br><span class="line">	<span class="type">int</span> pageset_high_max;</span><br><span class="line">	<span class="type">int</span> pageset_batch;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_SPARSEMEM</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Flags for a pageblock_nr_pages block. See pageblock-flags.h.</span></span><br><span class="line"><span class="comment">	 * In SPARSEMEM, this map is stored in struct mem_section</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		*pageblock_flags;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* CONFIG_SPARSEMEM */</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone_start_pfn == zone_start_paddr &gt;&gt; PAGE_SHIFT */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		zone_start_pfn; <span class="comment">//èµ·å§‹é¡µå¸§å·</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * spanned_pages is the total pages spanned by the zone, including</span></span><br><span class="line"><span class="comment">	 * holes, which is calculated as:</span></span><br><span class="line"><span class="comment">	 * 	spanned_pages = zone_end_pfn - zone_start_pfn;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * present_pages is physical pages existing within the zone, which</span></span><br><span class="line"><span class="comment">	 * is calculated as:</span></span><br><span class="line"><span class="comment">	 *	present_pages = spanned_pages - absent_pages(pages in holes);</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * present_early_pages is present pages existing within the zone</span></span><br><span class="line"><span class="comment">	 * located on memory available since early boot, excluding hotplugged</span></span><br><span class="line"><span class="comment">	 * memory.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * managed_pages is present pages managed by the buddy system, which</span></span><br><span class="line"><span class="comment">	 * is calculated as (reserved_pages includes pages allocated by the</span></span><br><span class="line"><span class="comment">	 * bootmem allocator):</span></span><br><span class="line"><span class="comment">	 *	managed_pages = present_pages - reserved_pages;</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * cma pages is present pages that are assigned for CMA use</span></span><br><span class="line"><span class="comment">	 * (MIGRATE_CMA).</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * So present_pages may be used by memory hotplug or memory power</span></span><br><span class="line"><span class="comment">	 * management logic to figure out unmanaged pages by checking</span></span><br><span class="line"><span class="comment">	 * (present_pages - managed_pages). And managed_pages should be used</span></span><br><span class="line"><span class="comment">	 * by page allocator and vm scanner to calculate all kinds of watermarks</span></span><br><span class="line"><span class="comment">	 * and thresholds.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Locking rules:</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * zone_start_pfn and spanned_pages are protected by span_seqlock.</span></span><br><span class="line"><span class="comment">	 * It is a seqlock because it has to be read outside of zone-&gt;lock,</span></span><br><span class="line"><span class="comment">	 * and it is done in the main allocator path.  But, it is written</span></span><br><span class="line"><span class="comment">	 * quite infrequently.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * The span_seq lock is declared along with zone-&gt;lock because it is</span></span><br><span class="line"><span class="comment">	 * frequently read in proximity to zone-&gt;lock.  It&#x27;s good to</span></span><br><span class="line"><span class="comment">	 * give them a chance of being in the same cacheline.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Write access to present_pages at runtime should be protected by</span></span><br><span class="line"><span class="comment">	 * mem_hotplug_begin/done(). Any reader who can&#x27;t tolerant drift of</span></span><br><span class="line"><span class="comment">	 * present_pages should use get_online_mems() to get a stable value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">atomic_long_t</span>		managed_pages; <span class="comment">//ä¹Ÿå³ managed_pages æ˜¯è¿™ä¸ª zone è¢«ä¼™ä¼´ç³»ç»Ÿç®¡ç†çš„æ‰€æœ‰çš„ page æ•°ç›®ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		spanned_pages; <span class="comment">// æŒ‡çš„æ˜¯ä¸ç®¡ä¸­é—´æœ‰æ²¡æœ‰ç‰©ç†å†…å­˜ç©ºæ´ï¼Œåæ­£å°±æ˜¯æœ€åçš„é¡µå·å‡å»èµ·å§‹çš„é¡µå·ï¼Œå³spanned_pagesåŒ…å«å†…å­˜ç©ºæ´åŒºåŸŸé¡µã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		present_pages; <span class="comment">//ä¹Ÿå³ present_pages æ˜¯è¿™ä¸ª zone åœ¨ç‰©ç†å†…å­˜ä¸­çœŸå®å­˜åœ¨çš„æ‰€æœ‰ page æ•°ç›®ã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_MEMORY_HOTPLUG)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		present_early_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_CMA</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		cma_pages;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">const</span> <span class="type">char</span>		*name;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_ISOLATION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Number of isolated pageblock. It is used to solve incorrect</span></span><br><span class="line"><span class="comment">	 * freepage counting problem due to racy retrieving migratetype</span></span><br><span class="line"><span class="comment">	 * of pageblock. Protected by zone-&gt;lock.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		nr_isolate_pageblock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMORY_HOTPLUG</span></span><br><span class="line">	<span class="comment">/* see spanned/present_pages for more description */</span></span><br><span class="line">	<span class="type">seqlock_t</span>		span_seqlock;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">int</span> initialized;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write-intensive fields used from the page allocator */</span></span><br><span class="line">	CACHELINE_PADDING(_pad1_);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* free areas of different sizes */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">NR_PAGE_ORDERS</span>];</span> <span class="comment">//Buddyä¼™ä¼´ç³»ç»Ÿçš„æ ¸å¿ƒæ•°æ®ç»“æ„ï¼Œç®¡ç†ç©ºé—²é¡µå—é“¾è¡¨çš„æ•°ç»„ã€‚</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_UNACCEPTED_MEMORY</span></span><br><span class="line">	<span class="comment">/* Pages to be accepted. All pages on the list are MAX_PAGE_ORDER */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">unaccepted_pages</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* zone flags, see below */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		flags;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Primarily protects free_area */</span></span><br><span class="line">	<span class="type">spinlock_t</span>		lock;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Write-intensive fields used by compaction and vmstats. */</span></span><br><span class="line">	CACHELINE_PADDING(_pad2_);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * When free pages are below this point, additional steps are taken</span></span><br><span class="line"><span class="comment">	 * when reading the number of free pages to avoid per-cpu counter</span></span><br><span class="line"><span class="comment">	 * drift allowing watermarks to be breached</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> percpu_drift_mark;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/* pfn where compaction free scanner should start */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		compact_cached_free_pfn;</span><br><span class="line">	<span class="comment">/* pfn where compaction migration scanner should start */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		compact_cached_migrate_pfn[ASYNC_AND_SYNC];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		compact_init_migrate_pfn;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		compact_init_free_pfn;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_COMPACTION</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On compaction failure, 1&lt;&lt;compact_defer_shift compactions</span></span><br><span class="line"><span class="comment">	 * are skipped before trying again. The number attempted since</span></span><br><span class="line"><span class="comment">	 * last failure is tracked with compact_considered.</span></span><br><span class="line"><span class="comment">	 * compact_order_failed is the minimum compaction failed order.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		compact_considered;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		compact_defer_shift;</span><br><span class="line">	<span class="type">int</span>			compact_order_failed;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined CONFIG_COMPACTION || defined CONFIG_CMA</span></span><br><span class="line">	<span class="comment">/* Set to true when the PG_migrate_skip bits should be cleared */</span></span><br><span class="line">	<span class="type">bool</span>			compact_blockskip_flush;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="type">bool</span>			contiguous;</span><br><span class="line"></span><br><span class="line">	CACHELINE_PADDING(_pad3_);</span><br><span class="line">	<span class="comment">/* Zone statistics */</span></span><br><span class="line">	<span class="type">atomic_long_t</span>		vm_stat[NR_VM_ZONE_STAT_ITEMS];</span><br><span class="line">	<span class="type">atomic_long_t</span>		vm_numa_event[NR_VM_NUMA_EVENT_ITEMS];</span><br><span class="line">&#125; ____cacheline_internodealigned_in_smp;</span><br></pre></td></tr></table></figure>

<h2 id="Page"><a href="#Page" class="headerlink" title="Page"></a>Page</h2><p>çœ‹å®Œäº†ç»“ç‚¹å’Œå†…å­˜åŸŸä¹‹åï¼Œæˆ‘ä»¬æ¥è®¨è®ºå†…å­˜ç®¡ç†çš„æ ¸å¿ƒå…ƒç´ ï¼Œé¡µå¸§ã€‚æ¯ä¸ªç‰©ç†é¡µå¸§éƒ½æœ‰ä¸€ä¸ªstruct pageç»“æ„æ¥è¡¨ç¤º.</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;		<span class="comment">/* Atomic flags, some possibly</span></span><br><span class="line"><span class="comment">					 * updated asynchronously */</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Five words (20/40 bytes) are available in this union.</span></span><br><span class="line"><span class="comment">	 * WARNING: bit 0 of the first word is used for PageTail(). That</span></span><br><span class="line"><span class="comment">	 * means the other users of this union MUST NOT use the bit to</span></span><br><span class="line"><span class="comment">	 * avoid collision and false-positive PageTail().</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Page cache and anonymous pages */</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @lru: Pageout list, eg. active_list protected by</span></span><br><span class="line"><span class="comment">			 * lruvec-&gt;lru_lock.  Sometimes used as a generic list</span></span><br><span class="line"><span class="comment">			 * by the page owner.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span></span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Or, for the Unevictable &quot;LRU list&quot; slot */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">					<span class="comment">/* Always even, to negate PageTail */</span></span><br><span class="line">					<span class="type">void</span> *__filler;</span><br><span class="line">					<span class="comment">/* Count page&#x27;s or folio&#x27;s mlocks */</span></span><br><span class="line">					<span class="type">unsigned</span> <span class="type">int</span> mlock_count;</span><br><span class="line">				&#125;;</span><br><span class="line"></span><br><span class="line">				<span class="comment">/* Or, free page */</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buddy_list</span>;</span></span><br><span class="line">				<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">pcp_list</span>;</span></span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">/* See page-flags.h for PAGE_MAPPING_FLAGS */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">				<span class="type">pgoff_t</span> index;		<span class="comment">/* Our offset within mapping. */</span></span><br><span class="line">				<span class="type">unsigned</span> <span class="type">long</span> share;	<span class="comment">/* share count for fsdax */</span></span><br><span class="line">			&#125;;</span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @private: Mapping-private opaque data.</span></span><br><span class="line"><span class="comment">			 * Usually used for buffer_heads if PagePrivate.</span></span><br><span class="line"><span class="comment">			 * Used for swp_entry_t if PageSwapCache.</span></span><br><span class="line"><span class="comment">			 * Indicates order in the buddy system if PageBuddy.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* page_pool used by netstack */</span></span><br><span class="line">			<span class="comment">/**</span></span><br><span class="line"><span class="comment">			 * @pp_magic: magic value to avoid recycling non</span></span><br><span class="line"><span class="comment">			 * page_pool allocated pages.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> pp_magic;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">page_pool</span> *<span class="title">pp</span>;</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> _pp_mapping_pad;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> dma_addr;</span><br><span class="line">			<span class="type">atomic_long_t</span> pp_ref_count;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* Tail pages of compound page */</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> compound_head;	<span class="comment">/* Bit zero is set */</span></span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span>	<span class="comment">/* ZONE_DEVICE pages */</span></span><br><span class="line">			<span class="comment">/** @pgmap: Points to the hosting device page map. */</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span></span><br><span class="line">			<span class="type">void</span> *zone_device_data;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * ZONE_DEVICE private pages are counted as being</span></span><br><span class="line"><span class="comment">			 * mapped so the next 3 words hold the mapping, index,</span></span><br><span class="line"><span class="comment">			 * and private fields from the source anonymous or</span></span><br><span class="line"><span class="comment">			 * page cache page while the page is migrated to device</span></span><br><span class="line"><span class="comment">			 * private memory.</span></span><br><span class="line"><span class="comment">			 * ZONE_DEVICE MEMORY_DEVICE_FS_DAX pages also</span></span><br><span class="line"><span class="comment">			 * use the mapping, index, and private fields when</span></span><br><span class="line"><span class="comment">			 * pmem backed DAX files are mapped.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">		&#125;;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/** @rcu_head: You can use this to free a page by RCU. */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu_head</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span>		<span class="comment">/* This union is 4 bytes in size. */</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For head pages of typed folios, the value stored here</span></span><br><span class="line"><span class="comment">		 * allows for determining what this page is used for. The</span></span><br><span class="line"><span class="comment">		 * tail pages of typed folios will not store a type</span></span><br><span class="line"><span class="comment">		 * (page_type == _mapcount == -1).</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * See page-flags.h for a list of page types which are currently</span></span><br><span class="line"><span class="comment">		 * stored here.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Owners of typed folios may reuse the lower 16 bit of the</span></span><br><span class="line"><span class="comment">		 * head page page_type field after setting the page type,</span></span><br><span class="line"><span class="comment">		 * but must reset these 16 bit to -1 before clearing the</span></span><br><span class="line"><span class="comment">		 * page type.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> page_type;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For pages that are part of non-typed folios for which mappings</span></span><br><span class="line"><span class="comment">		 * are tracked via the RMAP, encodes the number of times this page</span></span><br><span class="line"><span class="comment">		 * is directly referenced by a page table.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * Note that the mapcount is always initialized to -1, so that</span></span><br><span class="line"><span class="comment">		 * transitions both from it and to it can be tracked, using</span></span><br><span class="line"><span class="comment">		 * atomic_inc_and_test() and atomic_add_negative(-1).</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="type">atomic_t</span> _mapcount;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Usage count. *DO NOT USE DIRECTLY*. See page_ref.h */</span></span><br><span class="line">	<span class="type">atomic_t</span> _refcount;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_MEMCG</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> memcg_data;</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_SLAB_OBJ_EXT)</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> _unused_slab_obj_exts;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On machines where all RAM is mapped into kernel address space,</span></span><br><span class="line"><span class="comment">	 * we can simply calculate the virtual address. On machines with</span></span><br><span class="line"><span class="comment">	 * highmem some memory is mapped into kernel virtual memory</span></span><br><span class="line"><span class="comment">	 * dynamically, so we need a place to store that address.</span></span><br><span class="line"><span class="comment">	 * Note that this field could be 16 bits on x86 ... ;)</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * Architectures with slow multiplication can define</span></span><br><span class="line"><span class="comment">	 * WANT_PAGE_VIRTUAL in asm/page.h</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(WANT_PAGE_VIRTUAL)</span></span><br><span class="line">	<span class="type">void</span> *virtual;			<span class="comment">/* Kernel virtual address (NULL if</span></span><br><span class="line"><span class="comment">					   not kmapped, ie. highmem) */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* WANT_PAGE_VIRTUAL */</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> LAST_CPUPID_NOT_IN_PAGE_FLAGS</span></span><br><span class="line">	<span class="type">int</span> _last_cpupid;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_KMSAN</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * KMSAN metadata for this page:</span></span><br><span class="line"><span class="comment">	 *  - shadow page: every bit indicates whether the corresponding</span></span><br><span class="line"><span class="comment">	 *    bit of the original page is initialized (0) or not (1);</span></span><br><span class="line"><span class="comment">	 *  - origin page: every 4 bytes contain an id of the stack trace</span></span><br><span class="line"><span class="comment">	 *    where the uninitialized value was created.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_shadow</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">kmsan_origin</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125; _struct_page_alignment;</span><br></pre></td></tr></table></figure>

<p>çœ‹ç€éå¸¸å¤æ‚ï¼Œå…¶å®å°±æ˜¯ä¸¤ä¸ªunionåŠ å‡ ä¸ªæ•°æ®ï¼Œæ¢ä¸ªæ–¹å¼å°±èƒ½å¤Ÿæ˜ç™½äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span></span></span><br><span class="line"><span class="class">â”œâ”€ <span class="title">flags</span>                // é¡µæ ‡å¿—ä½ (<span class="title">PG_locked</span>, <span class="title">PG_dirty</span>, <span class="title">etc</span>.)</span></span><br><span class="line"><span class="class">â”œâ”€ <span class="title">union</span> &#123;</span>              <span class="comment">// ä¸»è¦æ ¹æ®é¡µç±»å‹å¤ç”¨</span></span><br><span class="line">â”‚   â”œâ”€ Page cache / anon page</span><br><span class="line">â”‚   â”‚   â”œâ”€ lru / buddy_list / pcp_list / mlock_count</span><br><span class="line">â”‚   â”‚   â”œâ”€ mapping       â†’ <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>* //å¦‚æœé¡µå¸§ä¸æ–‡ä»¶ç›¸å…³ï¼ŒæŒ‡å‘<span class="title">address_space</span>å¯¹è±¡ï¼Œä¸”æœ€ä½ä½ä¸º0</span></span><br><span class="line"><span class="class">â”‚   â”‚   â”œâ”€ <span class="title">index</span>/<span class="title">share</span> // é¡µåœ¨ <span class="title">mapping</span> ä¸­çš„åç§» (<span class="title">file</span> <span class="title">offset</span> / <span class="title">page</span> <span class="title">index</span>)</span></span><br><span class="line"><span class="class">â”‚   â”‚   â””â”€ <span class="title">private</span></span></span><br><span class="line"><span class="class">â”‚   â”‚</span></span><br><span class="line"><span class="class">â”‚   â”œâ”€ <span class="title">page_pool</span> (ç½‘ç»œæ ˆä¸“ç”¨)</span></span><br><span class="line"><span class="class">â”‚   â”‚   â”œâ”€ <span class="title">pp_magic</span></span></span><br><span class="line"><span class="class">â”‚   â”‚   â”œâ”€ <span class="title">pp</span></span></span><br><span class="line"><span class="class">â”‚   â”‚   â”œâ”€ <span class="title">dma_addr</span></span></span><br><span class="line"><span class="class">â”‚   â”‚   â””â”€ <span class="title">pp_ref_count</span></span></span><br><span class="line"><span class="class">â”‚   â”‚</span></span><br><span class="line"><span class="class">â”‚   â”œâ”€ <span class="title">Tail</span> <span class="title">page</span></span></span><br><span class="line"><span class="class">â”‚   â”‚   â””â”€ <span class="title">compound_head</span> (<span class="title">bit0</span>=</span><span class="number">1</span> æŒ‡å‘ head)</span><br><span class="line">â”‚   â”‚</span><br><span class="line">â”‚   â”œâ”€ ZONE_DEVICE</span><br><span class="line">â”‚   â”‚   â”œâ”€ pgmap â†’ <span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span>*</span></span><br><span class="line"><span class="class">â”‚   â”‚   â””â”€ <span class="title">zone_device_data</span></span></span><br><span class="line"><span class="class">â”‚   â”‚</span></span><br><span class="line"><span class="class">â”‚   â””â”€ <span class="title">rcu_head</span></span></span><br><span class="line"><span class="class">â”‚</span></span><br><span class="line"><span class="class">â”œâ”€ <span class="title">union</span> &#123;</span> page_type / _mapcount &#125;   <span class="comment">// é¡µç±»å‹æˆ–æ˜ å°„è®¡æ•°(è¢«å¤šå°‘ä¸ªé¡µè¡¨é¡¹æ˜ å°„ï¼ˆPTE å¼•ç”¨æ•°ï¼‰) </span></span><br><span class="line">â”œâ”€ _refcount                         <span class="comment">// å¼•ç”¨è®¡æ•°ï¼ˆæ ¸å¿ƒå­—æ®µï¼‰,è¡¨ç¤ºå†…æ ¸æ˜¯å¦ä»æŒæœ‰è¯¥é¡µï¼ˆç¼“å­˜ã€IOã€LRUç­‰ï¼‰ã€‚</span></span><br><span class="line">â”œâ”€ memcg_data / _unused_slab_obj_exts</span><br><span class="line">â”œâ”€ (optional) virtual                <span class="comment">// é«˜ç«¯å†…å­˜è™šæ‹Ÿåœ°å€ï¼ˆé«˜ç«¯å†…å­˜ï¼‰</span></span><br><span class="line">â”œâ”€ (optional) _last_cpupid           <span class="comment">// æœ€è¿‘è®¿é—®CPU</span></span><br><span class="line">â””â”€ (optional) kmsan_shadow/origin    <span class="comment">// KMSAN å…ƒæ•°æ®</span></span><br></pre></td></tr></table></figure>



<p>ä»¥ä¸‹ç»™å‡ºå‡ ä¸ªå¸¸ç”¨çš„page structçš„å»é™¤unionä¹‹åçš„æˆå‘˜</p>
<ul>
<li><p>æ™®é€šé¡µç¼“å­˜&#x2F;åŒ¿åé¡µ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;          <span class="comment">// PG_locked, PG_uptodate, PG_dirty...</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">lru</span>;</span>         <span class="comment">// åœ¨ zone-&gt;lruvec çš„é“¾è¡¨ä¸Š</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span><span class="comment">// æ‰€å±çš„æ–‡ä»¶æˆ– anon_vma</span></span><br><span class="line">    <span class="type">pgoff_t</span> index;                <span class="comment">// é¡µåœ¨ mapping ä¸­çš„åç§» (file offset / page index)</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;        <span class="comment">// ç§æœ‰æ•°æ®: buffer_head, swap entry, ç­‰</span></span><br><span class="line">    <span class="type">atomic_t</span> _mapcount;           <span class="comment">// è¢«å¤šå°‘ä¸ªé¡µè¡¨é¡¹æ˜ å°„ï¼ˆPTE å¼•ç”¨æ•°ï¼‰</span></span><br><span class="line">    <span class="type">atomic_t</span> _refcount;           <span class="comment">// å†…æ ¸æ€»å¼•ç”¨è®¡æ•°</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


</li>
<li><p>å¤åˆé¡µï¼ˆCompound Pageï¼ŒHugepageæˆ–order&gt;0é¡µï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">[Head page] <span class="class"><span class="keyword">struct</span> <span class="title">page</span></span></span><br><span class="line"><span class="class">   â”œâ”€ <span class="title">flags</span> (æ ‡è®°ä¸º <span class="title">head</span>)</span></span><br><span class="line"><span class="class">   â”œâ”€ <span class="title">private</span> (<span class="title">order</span>)</span></span><br><span class="line"><span class="class">   â”œâ”€ ...</span></span><br><span class="line"><span class="class">   â””â”€ <span class="title">compound_mapcount</span>, <span class="title">refcount</span></span></span><br><span class="line"><span class="class"></span></span><br><span class="line"><span class="class">[<span class="title">Tail</span> <span class="title">page</span>] <span class="keyword">struct</span> <span class="title">page</span></span></span><br><span class="line"><span class="class">   â”œâ”€ <span class="title">compound_head</span> =</span> (head | <span class="number">1</span>)</span><br><span class="line">   â””â”€ å…¶ä»–å­—æ®µæœªä½¿ç”¨</span><br></pre></td></tr></table></figure>


</li>
<li><p>ä¼™ä¼´ç³»ç»Ÿç©ºé—²é¡µï¼ˆå½“é¡µå¤„äºç©ºé—²çŠ¶æ€æ—¶ï¼Œå®ƒå¹¶ä¸å±äºæ–‡ä»¶æ˜ å°„ï¼Œè€Œæ˜¯é“¾åœ¨ <code>zone-&gt;free_area[order].free_list</code> ä¸Šï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> flags;          <span class="comment">// PG_buddy</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">buddy_list</span>;</span>  <span class="comment">// è¿æ¥åˆ° buddy freelist</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;        <span class="comment">// å­˜å‚¨é¡µé˜¶ (order)</span></span><br><span class="line">    <span class="type">atomic_t</span> _refcount = <span class="number">0</span>;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


</li>
<li><p>ç½‘ç»œé¡µæ± ï¼Œä½œä¸ºå†…æ ¸é«˜é€Ÿå›æ”¶ DMA bufferã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> pp_magic;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">page_pool</span> *<span class="title">pp</span>;</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> dma_addr;</span><br><span class="line">    <span class="type">atomic_long_t</span> pp_ref_count;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>


</li>
<li><p>Zone_deviceé¡µï¼ˆè¿™äº›é¡µå¹¶éæ™®é€š RAMï¼Œè€Œæ˜¯è®¾å¤‡å†…å­˜ï¼ˆå¦‚ GPU æ˜¾å­˜æˆ–æŒä¹…å†…å­˜ï¼‰ã€‚å®ƒä»¬é€šè¿‡ <code>struct dev_pagemap</code> ç®¡ç†ã€‚ï¼‰</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">dev_pagemap</span> *<span class="title">pgmap</span>;</span>   <span class="comment">// è®¾å¤‡é¡µæ˜ å°„ä¿¡æ¯</span></span><br><span class="line">    <span class="type">void</span> *zone_device_data;      <span class="comment">// é©±åŠ¨è‡ªå®šä¹‰</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">address_space</span> *<span class="title">mapping</span>;</span></span><br><span class="line">    <span class="type">pgoff_t</span> index;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> private;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="ä¼™ä¼´ç³»ç»Ÿ"><a href="#ä¼™ä¼´ç³»ç»Ÿ" class="headerlink" title="ä¼™ä¼´ç³»ç»Ÿ"></a>ä¼™ä¼´ç³»ç»Ÿ</h2><p>å‰é¢è¯´è¿‡æ¯ä¸ªZoneç»“æ„å†…éƒ¨éƒ½æœ‰ä¸€ä¸ªfree_areaå­—æ®µ, é‚£æˆ‘ä»¬çœ‹çœ‹free_areaåˆ°åº•æ˜¯ä»€ä¹ˆä¸œè¥¿ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//include/linux/mmzone.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">zone</span>&#123;</span></span><br><span class="line">	...</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">free_area</span>	<span class="title">free_area</span>[<span class="title">NR_PAGE_ORDERS</span>];</span></span><br><span class="line">	...</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">free_area</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span>	<span class="title">free_list</span>[<span class="title">MIGRATE_TYPES</span>];</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>		nr_free;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>å¤§è‡´ç»“æ„å¦‚å›¾æ‰€ç¤ºï¼Œç¬¬ä¸€ä¸ªfree_area[0]è¡¨ç¤ºé¡µé¢å¤§å°ä¸º4Kçš„ç©ºé—²é¡µï¼Œç¬¬äºŒä¸ªfree_area[1]è¡¨ç¤ºé¡µé¢å¤§å°ä¸º8Kçš„ç©ºé—²å—ï¼Œä¾æ¬¡ç±»æ¨ã€‚è€Œæ¯ä¸ªfree_areaä¹‹é—´åˆæœ‰å¤šä¸ªfree_listï¼Œè¿™æ˜¯ç”±äºä¸åŒçš„é¡µæœ‰ä¸åŒçš„å±æ€§ï¼Œä¾‹å¦‚<code>MIGRATE_UNMOVABLE</code>,<code>MIGRATE_MOVABLE</code>,<code>MIGRATE_RECLAIMABLE</code>,<code>MIGRATE_PCPTYPES</code>ç­‰ï¼Œå› æ­¤å°±å¼„äº†å¤šä¸ªlist, ä½†æ˜¯æ€»æ•°è®°å½•åœ¨nr_freeä¸­ã€‚<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006010750662.png" alt="image-20251006010750662"></p>
<p>å¯¹äºä¸åŒç»“ç‚¹ä¸Šä¸åŒçš„zoneçš„ç»„ç»‡æ–¹å¼å°±ç®€åŒ–æˆå¦‚ä¸‹å›¾ï¼š</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006011505993.png" alt="image-20251006011505993"></p>
<h1 id="è™šæ‹Ÿå†…å­˜ç®¡ç†"><a href="#è™šæ‹Ÿå†…å­˜ç®¡ç†" class="headerlink" title="è™šæ‹Ÿå†…å­˜ç®¡ç†"></a>è™šæ‹Ÿå†…å­˜ç®¡ç†</h1><p>è®²å®Œäº†ç‰©ç†å†…å­˜ç®¡ç†ï¼Œæ¥ä¸‹æ¥è®²è®²Linuxæœ€æ ¸å¿ƒçš„æœºåˆ¶ï¼Œè™šæ‹Ÿå†…å­˜ï¼Œå³åœ°å€æ˜ å°„å’Œé¡µè¡¨ç›¸å…³çš„å†…å®¹ã€‚</p>
<p>åœ¨x86æ¶æ„ä¸‹ï¼Œå®é™…æœ‰ä¸‰ä¸ªåœ°å€ï¼Œé€»è¾‘åœ°å€ï¼Œçº¿æ€§åœ°å€å’Œç‰©ç†åœ°å€ï¼Œé€»è¾‘åœ°å€ç»è¿‡åˆ†æ®µç®¡ç†å•å…ƒè½¬åŒ–æˆçº¿æ€§åœ°å€ï¼Œçº¿æ€§åœ°å€ç»è¿‡åˆ†é¡µé¡µè¡¨å’ŒMMUè½¬åŒ–æˆç‰©ç†åœ°å€ã€‚è™½ç„¶å¬ç€æ¯”è¾ƒå¤æ‚ï¼Œä½†æ˜¯å®é™…ä¸Šx86å’Œx86_64é‡‡ç”¨çš„æ˜¯å¹³å¦å†…å­˜æ¨¡å‹ï¼Œä¹Ÿå°±æ˜¯ç»•è¿‡äº†é€»è¾‘åœ°å€åˆ°çº¿æ€§åœ°å€çš„è¿™å±‚ç¿»è¯‘ã€‚å…·ä½“æ¥è¯´å°±æ˜¯è™½ç„¶è¿˜æ˜¯ç”¨äº†æ®µå¯„å­˜å™¨å’Œæ®µé€‰æ‹©å­ç­‰æœºåˆ¶æ¥åˆ†æ®µï¼Œä½†æ˜¯æ‰€æœ‰æ®µéƒ½æ˜¯ä»ç‰©ç†åœ°å€0å¼€å§‹ï¼Œä¸”ç•Œé™éƒ½ä¸€æ ·ï¼Œä¹Ÿå°±æ˜¯è¯´è™½ç„¶æœ‰ç”¨æˆ·ä»£ç æ®µï¼Œæ•°æ®æ®µï¼Œå†…æ ¸ä»£ç æ®µï¼Œæ•°æ®æ®µä¹‹åˆ†ï¼Œä½†æ˜¯æŒ‡å‘çš„éƒ½æ˜¯åŒä¸€æ®µï¼Œåªæ˜¯ä½¿ç”¨äº†å®ƒä»¬çš„ç‰¹æƒçº§ä½œä¸ºç‰¹æƒæ§åˆ¶ã€‚</p>
<h2 id="äº”çº§é¡µè¡¨åœ°å€ç¿»è¯‘"><a href="#äº”çº§é¡µè¡¨åœ°å€ç¿»è¯‘" class="headerlink" title="äº”çº§é¡µè¡¨åœ°å€ç¿»è¯‘"></a>äº”çº§é¡µè¡¨åœ°å€ç¿»è¯‘</h2><p>äº”çº§é¡µè¡¨çš„å†…å®¹ç›¸ä¿¡éƒ½è€³ç†Ÿèƒ½è¯¦äº†ï¼Œè¿™é‡Œä¾¿ä¸å†è¿‡å¤šå™è¿°ã€‚PGD,P4D,PUD,PMD,PTEã€‚</p>
<p>å…·ä½“å°±è´´ä¸¤ä¸ªç½‘ä¸Šblogé‡Œæˆªçš„å›¾æŠŠã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006125155971.png" alt="image-20251006125155971"></p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006125218150.png" alt="image-20251006125218150"></p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006125228549.png" alt="image-20251006125228549"></p>
<h2 id="è¿›ç¨‹å¦‚ä½•ç®¡ç†åœ°å€ç©ºé—´ä¸é¡µè¡¨"><a href="#è¿›ç¨‹å¦‚ä½•ç®¡ç†åœ°å€ç©ºé—´ä¸é¡µè¡¨" class="headerlink" title="è¿›ç¨‹å¦‚ä½•ç®¡ç†åœ°å€ç©ºé—´ä¸é¡µè¡¨"></a>è¿›ç¨‹å¦‚ä½•ç®¡ç†åœ°å€ç©ºé—´ä¸é¡µè¡¨</h2><h3 id="task-struct"><a href="#task-struct" class="headerlink" title="task_struct"></a>task_struct</h3><p>æˆ‘ä»¬é¦–å…ˆäº†è§£ä¸€ä¸‹Linux ä¸­task_structç»“æ„ï¼Œä¹Ÿå°±æ˜¯æ‰€è°“çš„PCB</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">thread_info</span>		<span class="title">thread_info</span>;</span></span><br><span class="line">    <span class="type">void</span>				*<span class="built_in">stack</span>;<span class="comment">//å†…æ ¸æ ˆåœ°å€</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// è¿›ç¨‹æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span>  *<span class="title">files</span>;</span></span><br><span class="line">    <span class="comment">// å†…å­˜æè¿°ç¬¦è¡¨ç¤ºè¿›ç¨‹è™šæ‹Ÿåœ°å€ç©ºé—´</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span>  *<span class="title">mm</span>;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span>		*<span class="title">active_mm</span>;</span> <span class="comment">//å†…æ ¸çº¿ç¨‹ç”¨çš„æ˜¯ä¸Šä¸€ä¸ªçº¿ç¨‹çš„mmï¼Œå†…æ ¸çº¿ç¨‹å’Œç”¨æˆ·æ€çº¿ç¨‹çš„åŒºåˆ«å°±æ˜¯å†…æ ¸çº¿ç¨‹æ²¡æœ‰ç›¸å…³çš„å†…å­˜æè¿°ç¬¦ mm_struct ï¼Œå†…æ ¸çº¿ç¨‹å¯¹åº”çš„ task_struct ç»“æ„ä¸­çš„ mm åŸŸæŒ‡å‘ Nullï¼Œæ‰€ä»¥å†…æ ¸çº¿ç¨‹ä¹‹é—´è°ƒåº¦æ˜¯ä¸æ¶‰åŠåœ°å€ç©ºé—´åˆ‡æ¢çš„ã€‚å½“ä¸€ä¸ªå†…æ ¸çº¿ç¨‹è¢«è°ƒåº¦æ—¶ï¼Œå®ƒä¼šå‘ç°è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ä¸º Nullï¼Œè™½ç„¶å®ƒä¸ä¼šè®¿é—®ç”¨æˆ·æ€çš„å†…å­˜ï¼Œä½†æ˜¯å®ƒä¼šè®¿é—®å†…æ ¸å†…å­˜ï¼Œèªæ˜çš„å†…æ ¸ä¼šå°†è°ƒåº¦ä¹‹å‰çš„ä¸Šä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹çš„è™šæ‹Ÿå†…å­˜ç©ºé—´ mm_struct ç›´æ¥èµ‹å€¼ç»™å†…æ ¸çº¿ç¨‹ï¼Œå› ä¸ºå†…æ ¸çº¿ç¨‹ä¸ä¼šè®¿é—®ç”¨æˆ·ç©ºé—´çš„å†…å­˜ï¼Œå®ƒä»…ä»…åªä¼šè®¿é—®å†…æ ¸ç©ºé—´çš„å†…å­˜ï¼Œæ‰€ä»¥ç›´æ¥å¤ç”¨ä¸Šä¸€ä¸ªç”¨æˆ·æ€è¿›ç¨‹çš„è™šæ‹Ÿåœ°å€ç©ºé—´å°±å¯ä»¥é¿å…ä¸ºå†…æ ¸çº¿ç¨‹åˆ†é… mm_struct å’Œç›¸å…³é¡µè¡¨çš„å¼€é”€ï¼Œä»¥åŠé¿å…å†…æ ¸çº¿ç¨‹ä¹‹é—´è°ƒåº¦æ—¶åœ°å€ç©ºé—´çš„åˆ‡æ¢å¼€é”€ã€‚</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// è¿›ç¨‹id</span></span><br><span class="line">	<span class="type">pid_t</span>    pid;</span><br><span class="line">    <span class="comment">// ç”¨äºæ ‡è¯†çº¿ç¨‹æ‰€å±çš„è¿›ç¨‹ pid</span></span><br><span class="line">	<span class="type">pid_t</span>    tgid;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Real parent process: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> __<span class="title">rcu</span>	*<span class="title">real_parent</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Recipient of SIGCHLD, wait4() reports: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> __<span class="title">rcu</span>	*<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="mm-struct"><a href="#mm-struct" class="headerlink" title="mm_struct"></a>mm_struct</h3><p>å…¶ä¸­æœ€é‡è¦çš„ä¸€ä¸ªç»“æ„å°±æ˜¯mm_structï¼Œç”¨æ¥è¡¨ç¤ºå†…å­˜åœ°å€ç©ºé—´ç»“æ„ï¼Œæˆ‘ä»¬çœ‹çœ‹å®ƒåŒ…å«äº†ä»€ä¹ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> &#123;</span></span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">maple_tree</span> <span class="title">mm_mt</span>;</span> <span class="comment">//æ«æ ‘ï¼è¿™ä¸ªç”¨æ¥ä»£æ›¿çº¢é»‘æ ‘ï¼Œæ˜¯5.13ä¹‹ååŠ å…¥çš„æ–°ç‰¹æ€§</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mmap_base;	<span class="comment">/* base of mmap area */</span> <span class="comment">//ç°ç‰ˆæœ¬å†…æ ¸ä»ä¸Šå¾€ä¸‹ï¼Œä»é«˜åœ°å€å¾€ä½åœ°å€å¢é•¿</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> mmap_legacy_base;	<span class="comment">/* base of mmap area in bottom-up allocations */</span> <span class="comment">//æ—©ç‰ˆæœ¬å†…æ ¸mmapä»ä¸‹å¾€ä¸Šï¼Œä»ä½åœ°å€åˆ°é«˜åœ°å€å¢é•¿</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> task_size;	<span class="comment">/* size of task vm space */</span> <span class="comment">//task_sizeæ˜¯è¡¨æ˜å†…æ ¸ç©ºé—´çš„èµ·å§‹åœ°å€ï¼Œx86æ¶æ„ä¸‹ä¸º`0xC000 000`, x86_64æ¶æ„ä¸‹ä¸º`0x0000 7FFF FFFF F000`</span></span><br><span class="line">	<span class="type">pgd_t</span> * pgd; <span class="comment">//é¡µè¡¨åŸºå€ï¼Œè¿™æ˜¯è™šæ‹Ÿåœ°å€ï¼Œä¹Ÿå°±æ˜¯ç‰©ç†åœ°å€åœ¨directmappingä¸‹è®°å½•çš„è™šæ‹Ÿåœ°å€</span></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> start_code, end_code, start_data, end_data;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> start_brk, brk, start_stack;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> arg_start, arg_end, env_start, env_end;</span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­æœ‰ä¸€ä¸ªå…³é”®çš„ç»“æ„<code> struct maple_tree mm_mt;</code>,è¿™ä¸ªæ˜¯ç”¨æ¥ä»£æ›¿çº¢é»‘æ ‘çš„ï¼Œé€šè¿‡è¿™ä¸ªæ«æ ‘ï¼Œèƒ½å¤Ÿå¿«é€Ÿæ‰¾åˆ°ä¸åŒçš„vm_area_structç»“æ„ã€‚è¿™é‡Œæ›¿æ¢çš„ä¸»è¦åŸå› æ˜¯ï¼Œçº¢é»‘æ ‘è¿˜éœ€è¦ç”¨é“¾è¡¨æ¥è¾…åŠ©ï¼Œåœ¨å¤šçº¿ç¨‹ä¸­mmap&#x2F;unmapå­˜åœ¨ä»¥ä¸‹é—®é¢˜</p>
<table>
<thead>
<tr>
<th>é—®é¢˜</th>
<th>è¯´æ˜</th>
</tr>
</thead>
<tbody><tr>
<td>cache locality å·®</td>
<td>çº¢é»‘æ ‘èŠ‚ç‚¹åˆ†æ•£ï¼Œcache miss é«˜</td>
</tr>
<tr>
<td>é“¾è¡¨ + æ ‘åŒç»´æŠ¤</td>
<td>ç»´æŠ¤ä¸¤ç§ç»“æ„å¤æ‚</td>
</tr>
<tr>
<td>mmap_lock ç²—ç²’åº¦</td>
<td>è¯»å†™ mmap_lock å¯¼è‡´å…¨å±€ç«äº‰</td>
</tr>
<tr>
<td>RCU ä¸å‹å¥½</td>
<td>æŸ¥æ‰¾æ—¶éœ€è¦åŠ é”æˆ–å¼•ç”¨è®¡æ•°</td>
</tr>
</tbody></table>
<p>è€Œmaple_treeæœ‰ä»¥ä¸‹ä¼˜ç‚¹</p>
<ul>
<li><p>ä½¿ç”¨ã€Œå—çŠ¶èŠ‚ç‚¹ã€å­˜å‚¨å¤šä¸ª VMA æŒ‡é’ˆï¼›</p>
</li>
<li><p>èŠ‚ç‚¹å†…è¿ç»­æ•°ç»„ä¾¿äºç¼“å­˜ï¼›</p>
</li>
<li><p>æ”¯æŒ RCU å®‰å…¨éå†ï¼›</p>
</li>
<li><p>æå¤§å‡å°‘é”å†²çªã€‚</p>
</li>
</ul>
<h3 id="vm-area-struct"><a href="#vm-area-struct" class="headerlink" title="vm_area_struct"></a>vm_area_struct</h3><p>å…ˆçœ‹çœ‹ç»“æ„ä½“é‡Œæœ‰å“ªäº›ä¸œè¥¿, å¯ä»¥å‘ç°å·²ç»æ²¡æœ‰ä¹‹å‰çš„rb_nodeæˆå‘˜äº†ï¼Œä¹‹å‰è€ç‰ˆæœ¬ä¼šæœ‰ä¸€ä¸ª<code>struct rb_node vm_rb;</code>,ç°åœ¨å·²ç»åˆ é™¤äº†ï¼Œä½†æ˜¯åˆ«çš„ä¸œè¥¿è¿˜æ˜¯å¾ˆæ˜äº†çš„ï¼Œå°±æ˜¯è¡¨æ˜ä¸€ä¸ªåŒºåŸŸçš„èµ·å§‹å’Œç»“å°¾ï¼Œä»¥åŠæ–‡ä»¶æ˜ å°„ç›¸å…³çš„å†…å®¹ï¼Œè¿˜æœ‰ä¸€äº›æƒé™ä»€ä¹ˆçš„ï¼Œå…·ä½“çœ‹æ³¨é‡Šéƒ½èƒ½çŸ¥é“ä»€ä¹ˆæ„æ€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">vm_area_struct</span> &#123;</span></span><br><span class="line">	<span class="comment">/* The first cache line has the info for VMA tree walking. */</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="comment">/* VMA covers [vm_start; vm_end) addresses within mm */</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> vm_start;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">long</span> vm_end;</span><br><span class="line">		&#125;;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PER_VMA_LOCK</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">vm_rcu</span>;</span>	<span class="comment">/* Used for deferred freeing. */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mm_struct</span> *<span class="title">vm_mm</span>;</span>	<span class="comment">/* The address space we belong to. */</span></span><br><span class="line">	<span class="type">pgprot_t</span> vm_page_prot;          <span class="comment">/* Access permissions of this VMA. */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Flags, see mm.h.</span></span><br><span class="line"><span class="comment">	 * To modify use vm_flags_&#123;init|reset|set|clear|mod&#125; functions.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">const</span> <span class="type">vm_flags_t</span> vm_flags;</span><br><span class="line">		<span class="type">vm_flags_t</span> __private __vm_flags;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_PER_VMA_LOCK</span></span><br><span class="line">	<span class="comment">/* Flag to indicate areas detached from the mm-&gt;mm_mt tree */</span></span><br><span class="line">	<span class="type">bool</span> detached;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Can only be written (using WRITE_ONCE()) while holding both:</span></span><br><span class="line"><span class="comment">	 *  - mmap_lock (in write mode)</span></span><br><span class="line"><span class="comment">	 *  - vm_lock-&gt;lock (in write mode)</span></span><br><span class="line"><span class="comment">	 * Can be read reliably while holding one of:</span></span><br><span class="line"><span class="comment">	 *  - mmap_lock (in read or write mode)</span></span><br><span class="line"><span class="comment">	 *  - vm_lock-&gt;lock (in read or write mode)</span></span><br><span class="line"><span class="comment">	 * Can be read unreliably (using READ_ONCE()) for pessimistic bailout</span></span><br><span class="line"><span class="comment">	 * while holding nothing (except RCU to keep the VMA struct allocated).</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * This sequence counter is explicitly allowed to overflow; sequence</span></span><br><span class="line"><span class="comment">	 * counter reuse can only lead to occasional unnecessary use of the</span></span><br><span class="line"><span class="comment">	 * slowpath.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">int</span> vm_lock_seq;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vma_lock</span> *<span class="title">vm_lock</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For areas with an address space and backing store,</span></span><br><span class="line"><span class="comment">	 * linkage into the address_space-&gt;i_mmap interval tree.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb</span>;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">long</span> rb_subtree_last;</span><br><span class="line">	&#125; shared;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * A file&#x27;s MAP_PRIVATE vma can be in both i_mmap tree and anon_vma</span></span><br><span class="line"><span class="comment">	 * list, after a COW of one of the file pages.	A MAP_SHARED vma</span></span><br><span class="line"><span class="comment">	 * can only be in the i_mmap tree.  An anonymous MAP_PRIVATE, stack</span></span><br><span class="line"><span class="comment">	 * or brk vma (with NULL file) can only be in an anon_vma list.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">list_head</span> <span class="title">anon_vma_chain</span>;</span> <span class="comment">/* Serialized by mmap_lock &amp;</span></span><br><span class="line"><span class="comment">					  * page_table_lock */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">anon_vma</span> *<span class="title">anon_vma</span>;</span>	<span class="comment">/* Serialized by page_table_lock */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Function pointers to deal with this struct. */</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">vm_operations_struct</span> *<span class="title">vm_ops</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Information about our backing store: */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> vm_pgoff;		<span class="comment">/* Offset (within vm_file) in PAGE_SIZE</span></span><br><span class="line"><span class="comment">					   units */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> * <span class="title">vm_file</span>;</span>		<span class="comment">/* File we map to (can be NULL). */</span></span><br><span class="line">	<span class="type">void</span> * vm_private_data;		<span class="comment">/* was vm_pte (shared mem) */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_ANON_VMA_NAME</span></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * For private and shared anonymous mappings, a pointer to a null</span></span><br><span class="line"><span class="comment">	 * terminated string containing the name given to the vma, or NULL if</span></span><br><span class="line"><span class="comment">	 * unnamed. Serialized by mmap_lock. Use anon_vma_name to access.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">anon_vma_name</span> *<span class="title">anon_name</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SWAP</span></span><br><span class="line">	<span class="type">atomic_long_t</span> swap_readahead_info;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifndef</span> CONFIG_MMU</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_region</span> *<span class="title">vm_region</span>;</span>	<span class="comment">/* NOMMU mapping region */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mempolicy</span> *<span class="title">vm_policy</span>;</span>	<span class="comment">/* NUMA policy for the VMA */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_NUMA_BALANCING</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vma_numab_state</span> *<span class="title">numab_state</span>;</span>	<span class="comment">/* NUMA Balancing state */</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vm_userfaultfd_ctx</span> <span class="title">vm_userfaultfd_ctx</span>;</span></span><br><span class="line">&#125; __randomize_layout;</span><br></pre></td></tr></table></figure>

<h3 id="Maple-Tree-æ«æ ‘"><a href="#Maple-Tree-æ«æ ‘" class="headerlink" title="Maple Tree æ«æ ‘"></a>Maple Tree æ«æ ‘</h3><p>æ—¢ç„¶éƒ½çœ‹åˆ°è¿™äº†ï¼Œå°±å­¦ä¹ ä¸€ä¸‹æ«æ ‘å§ï¼Œé¡ºä¾¿æŠŠBæ ‘ä»€ä¹ˆéƒ½ä¸€èµ·çœ‹äº†ï¼Œè¿™ä¸ªåº”è¯¥å…¨ç½‘æ²¡å•¥æ•™ç¨‹ï¼Œåªèƒ½è‡ªå·±çœ‹æºç ã€‚</p>
<p>é¦–å…ˆæ˜¯mapleæ ‘çš„ä¸€ä¸ªå®šä¹‰ï¼Œå…·ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * If the tree contains a single entry at index 0, it is usually stored in</span></span><br><span class="line"><span class="comment"> * tree-&gt;ma_root.  To optimise for the page cache, an entry which ends in &#x27;00&#x27;,</span></span><br><span class="line"><span class="comment"> * &#x27;01&#x27; or &#x27;11&#x27; is stored in the root, but an entry which ends in &#x27;10&#x27; will be</span></span><br><span class="line"><span class="comment"> * stored in a node.  Bits 3-6 are used to store enum maple_type.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The flags are used both to store some immutable information about this tree</span></span><br><span class="line"><span class="comment"> * (set at tree creation time) and dynamic information set under the spinlock.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Another use of flags are to indicate global states of the tree.  This is the</span></span><br><span class="line"><span class="comment"> * case with the MAPLE_USE_RCU flag, which indicates the tree is currently in</span></span><br><span class="line"><span class="comment"> * RCU mode.  This mode was added to allow the tree to reuse nodes instead of</span></span><br><span class="line"><span class="comment"> * re-allocating and RCU freeing nodes when there is a single user.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">maple_tree</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">        <span class="comment">//å†™æ“ä½œï¼ˆä¾‹å¦‚æ’å…¥ã€åˆ é™¤ VMAï¼‰æ—¶é€šå¸¸éœ€è¦æŒæœ‰è¿™ä¸ªé”ã€‚</span></span><br><span class="line">		<span class="type">spinlock_t</span>	ma_lock;  <span class="comment">//å¦‚æœæœ¬ç»“æ„ä½“éœ€è¦åŠ é”åˆ™ä½¿ç”¨è¿™ä¸ªå†™é”ï¼Œè¯»ç»“æ„ä¸€èˆ¬ä¸åŠ é”ï¼Œæ‰€ä»¥å¯ä»¥RCUæ”¯æŒã€‚RCUï¼ˆread-copy updateï¼‰,æŒ‡çš„æ˜¯è¦å†™æŒ‡é’ˆçš„æ—¶å€™æ‹·è´ä¸€ä»½å†æ›´æ–°ï¼Œå› æ­¤è¯»å†™ä¸ç”¨äº’æ–¥ï¼Œä»…æœ‰å†™å†™éœ€è¦äº’æ–¥ã€‚</span></span><br><span class="line">		lockdep_map_p	ma_external_lock; <span class="comment">//æˆ–è€…ä½¿ç”¨å¤–éƒ¨ä»£ç çš„é”ï¼Œè¿™é‡Œå¯ä»¥å¿½ç•¥ã€‚å½“å¤–éƒ¨ä»£ç ï¼ˆä¾‹å¦‚ mmap_lockï¼‰è´Ÿè´£ä¿æŠ¤æ•´ä¸ªæ ‘æ—¶ï¼ŒMaple Tree å°±å¯ä»¥å¤ç”¨å¤–éƒ¨é”çš„ lockdep ä¿¡æ¯ï¼Œè€Œä¸ç”¨è‡ªå·±çš„ spinlockã€‚lockdep_map_p æ˜¯ä¸€ä¸ª â€œlockdep ä¼ªé”â€ ç±»å‹ï¼Œç”¨æ¥è®© lockdep å·¥å…·è¿½è¸ªé”é¡ºåºï¼Œè€Œä¸å®é™…å‚ä¸åŠ é”ã€‚</span></span><br><span class="line">	&#125;;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>	ma_flags; <span class="comment">//ç”¨äºè®°å½•æ ‘çš„å…¨å±€çŠ¶æ€ä¸é…ç½®é€‰é¡¹ï¼Œè‡³äºmaple_flagsçœ‹ä¸‹é¢å®šä¹‰</span></span><br><span class="line">	<span class="type">void</span> __rcu      *ma_root; <span class="comment">//è¿™ä¸ªæ˜¯ Maple Tree çš„æ ¹æŒ‡é’ˆï¼ˆroot pointerï¼‰ï¼Œä½†å®ƒæ˜¯ä¸€ä¸ª â€œencoded pointerâ€ï¼ˆå³ maple_enode ç±»å‹ï¼‰ï¼Œå¸¦æœ‰ä½åŸŸä¿¡æ¯ã€‚</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * DOC: Maple tree flags</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_ALLOC_RANGE	- Track gaps in this tree</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_USE_RCU		- Operate in RCU mode</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_HEIGHT_OFFSET	- The position of the tree height in the flags</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_HEIGHT_MASK	- The mask for the maple tree height value</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_LOCK_MASK		- How the mt_lock is used</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_LOCK_IRQ		- Acquired irq-safe</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_LOCK_BH		- Acquired bh-safe</span></span><br><span class="line"><span class="comment"> * * MT_FLAGS_LOCK_EXTERN	- mt_lock is not used</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * MAPLE_HEIGHT_MAX	The largest height that can be stored</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_ALLOC_RANGE	0x01</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_USE_RCU	0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_HEIGHT_OFFSET	0x02</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_HEIGHT_MASK	0x7C</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_LOCK_MASK	0x300</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_LOCK_IRQ	0x100</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_LOCK_BH	0x200</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_LOCK_EXTERN	0x300</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> MT_FLAGS_ALLOC_WRAPPED	0x0800</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * The Maple Tree squeezes various bits in at various points which aren&#x27;t</span></span><br><span class="line"><span class="comment"> * necessarily obvious.  Usually, this is done by observing that pointers are</span></span><br><span class="line"><span class="comment"> * N-byte aligned and thus the bottom log_2(N) bits are available for use.  We</span></span><br><span class="line"><span class="comment"> * don&#x27;t use the high bits of pointers to store additional information because</span></span><br><span class="line"><span class="comment"> * we don&#x27;t know what bits are unused on any given architecture.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Nodes are 256 bytes in size and are also aligned to 256 bytes, giving us 8</span></span><br><span class="line"><span class="comment"> * low bits for our own purposes.  Nodes are currently of 4 types:</span></span><br><span class="line"><span class="comment"> * 1. Single pointer (Range is 0-0)</span></span><br><span class="line"><span class="comment"> * 2. Non-leaf Allocation Range nodes</span></span><br><span class="line"><span class="comment"> * 3. Non-leaf Range nodes</span></span><br><span class="line"><span class="comment"> * 4. Leaf Range nodes All nodes consist of a number of node slots,</span></span><br><span class="line"><span class="comment"> *    pivots, and a parent pointer.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">maple_node</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">maple_pnode</span> *<span class="title">parent</span>;</span></span><br><span class="line">			<span class="type">void</span> __rcu *slot[MAPLE_NODE_SLOTS];</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">void</span> *pad;</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">maple_enode</span> *<span class="title">piv_parent</span>;</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">char</span> parent_slot;</span><br><span class="line">			<span class="class"><span class="keyword">enum</span> <span class="title">maple_type</span> <span class="title">type</span>;</span></span><br><span class="line">			<span class="type">unsigned</span> <span class="type">char</span> slot_len;</span><br><span class="line">			<span class="type">unsigned</span> <span class="type">int</span> ma_flags;</span><br><span class="line">		&#125;;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">maple_range_64</span> <span class="title">mr64</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">maple_arange_64</span> <span class="title">ma64</span>;</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">maple_alloc</span> <span class="title">alloc</span>;</span></span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>OKäº†ï¼Œçœ‹å®Œäº†æ ‘çš„å®šä¹‰ï¼Œå…¶å®æ ¸å¿ƒç»“æ„éƒ½åœ¨ma_rootè¿™ä¸ªæŒ‡é’ˆé‡Œã€‚æˆ‘ä»¬æ¥çœ‹çœ‹ä¸åŒæƒ…å†µä¸‹è¯¥æŒ‡é’ˆåŒ…å«çš„å†…å®¹ã€‚å½“æ ‘ä¸ºç©ºæ—¶ï¼Œma_rootå­˜æ”¾çš„å€¼å³ä¸ºNULLï¼Œéå¸¸å¥½ç†è§£ã€‚å½“æ ‘åªæœ‰ä¸€ä¸ªç»“ç‚¹æ—¶ï¼Œæ ¹æ®æ³¨é‡Šå¯çŸ¥ï¼Œå…¶æŒ‡é’ˆæœ€ä½å‡ ä½ï¼Œå³bit0,bit1,bit2ä½œä¸ºç±»å‹ä¿¡æ¯ï¼Œå¦‚æœè¯¥å•å…ƒç´ çš„åœ°å€ä½ä¸¤ä½æ¨¡å¼ä¸º <code>00</code> &#x2F; <code>01</code> &#x2F; <code>11</code>ï¼Œåˆ™ç›´æ¥å­˜åœ¨ <code>ma_root</code>ï¼›å¦‚æœæ˜¯ <code>10</code>ï¼ˆå³ <code>0b10</code>ï¼‰ï¼Œé‚£ä¼šä¸å†…éƒ¨ç¼–ç è§„åˆ™å†²çªï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¼šå¼ºåˆ¶æ”¾è¿›ä¸€ä¸ª node é‡Œã€‚</p>
<p>ç„¶åæˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸‹æ ‘çš„çŠ¶æ€æœºï¼Œç”¨æ¥æ ‡è¯†æ ‘çš„ä¸€ä¸ªçŠ¶æ€çš„</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Maple State Status</span></span><br><span class="line"><span class="comment"> * ma_active means the maple state is pointing to a node and offset and can</span></span><br><span class="line"><span class="comment"> * continue operating on the tree.</span></span><br><span class="line"><span class="comment"> * ma_start means we have not searched the tree.</span></span><br><span class="line"><span class="comment"> * ma_root means we have searched the tree and the entry we found lives in</span></span><br><span class="line"><span class="comment"> * the root of the tree (ie it has index 0, length 1 and is the only entry in</span></span><br><span class="line"><span class="comment"> * the tree).</span></span><br><span class="line"><span class="comment"> * ma_none means we have searched the tree and there is no node in the</span></span><br><span class="line"><span class="comment"> * tree for this entry.  For example, we searched for index 1 in an empty</span></span><br><span class="line"><span class="comment"> * tree.  Or we have a tree which points to a full leaf node and we</span></span><br><span class="line"><span class="comment"> * searched for an entry which is larger than can be contained in that</span></span><br><span class="line"><span class="comment"> * leaf node.</span></span><br><span class="line"><span class="comment"> * ma_pause means the data within the maple state may be stale, restart the</span></span><br><span class="line"><span class="comment"> * operation</span></span><br><span class="line"><span class="comment"> * ma_overflow means the search has reached the upper limit of the search</span></span><br><span class="line"><span class="comment"> * ma_underflow means the search has reached the lower limit of the search</span></span><br><span class="line"><span class="comment"> * ma_error means there was an error, check the node for the error number.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">enum</span> <span class="title">maple_status</span> &#123;</span></span><br><span class="line">	ma_active,  <span class="comment">//æŒ‡å‘ä¸€ä¸ªnodeï¼Œå¯ä»¥ç»§ç»­å¯¹æ ‘è¿›è¡Œæ“ä½œ</span></span><br><span class="line">	ma_start, <span class="comment">//è¿˜æ²¡å¼€å§‹æœç´¢æ ‘</span></span><br><span class="line">	ma_root,  <span class="comment">//æ ‘å·²ç»å¼€å§‹æœç´¢äº†ï¼Œä½†æ˜¯ç›®å‰åªæœ‰ä¸€ä¸ªæ ¹èŠ‚ç‚¹</span></span><br><span class="line">	ma_none, <span class="comment">//æ ‘å·²ç»å¼€å§‹æœç´¢äº†ï¼Œä½†æ˜¯ç›®å‰æ²¡æœ‰è¿™ä¸ªèŠ‚ç‚¹</span></span><br><span class="line">	ma_pause,</span><br><span class="line">	ma_overflow,</span><br><span class="line">	ma_underflow,</span><br><span class="line">	ma_error,</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶åçœ‹çœ‹å¾€ä¸€é¢—ç©ºæ ‘æ·»åŠ èŠ‚ç‚¹çš„æ“ä½œï¼Œåˆ†ä¸ºæ’å…¥ä¸€ä¸ªå€¼å’Œæ’å…¥ä¸€ä¸ªrange</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">mtree_insert</span><span class="params">(<span class="keyword">struct</span> maple_tree *mt, <span class="type">unsigned</span> <span class="type">long</span> index, <span class="type">void</span> *entry,</span></span><br><span class="line"><span class="params">		 <span class="type">gfp_t</span> gfp)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> mtree_insert_range(mt, index, index, entry, gfp);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(mtree_insert);</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mtree_insert_range() - Insert an entry at a given range if there is no value.</span></span><br><span class="line"><span class="comment"> * @mt: The maple tree</span></span><br><span class="line"><span class="comment"> * @first: The start of the range</span></span><br><span class="line"><span class="comment"> * @last: The end of the range</span></span><br><span class="line"><span class="comment"> * @entry: The entry to store</span></span><br><span class="line"><span class="comment"> * @gfp: The GFP_FLAGS to use for allocations.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: 0 on success, -EEXISTS if the range is occupied, -EINVAL on invalid</span></span><br><span class="line"><span class="comment"> * request, -ENOMEM if memory could not be allocated.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">int</span> <span class="title function_">mtree_insert_range</span><span class="params">(<span class="keyword">struct</span> maple_tree *mt, <span class="type">unsigned</span> <span class="type">long</span> first,</span></span><br><span class="line"><span class="params">		<span class="type">unsigned</span> <span class="type">long</span> last, <span class="type">void</span> *entry, <span class="type">gfp_t</span> gfp)</span></span><br><span class="line">&#123;</span><br><span class="line">	MA_STATE(ms, mt, first, last);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE(xa_is_advanced(entry)))</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (first &gt; last)</span><br><span class="line">		<span class="keyword">return</span> -EINVAL;</span><br><span class="line"></span><br><span class="line">	mtree_lock(mt);</span><br><span class="line">retry:</span><br><span class="line">	mas_insert(&amp;ms, entry);</span><br><span class="line">	<span class="keyword">if</span> (mas_nomem(&amp;ms, gfp))</span><br><span class="line">		<span class="keyword">goto</span> retry;</span><br><span class="line"></span><br><span class="line">	mtree_unlock(mt);</span><br><span class="line">	<span class="keyword">if</span> (mas_is_err(&amp;ms))</span><br><span class="line">		<span class="keyword">return</span> xa_err(ms.node);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(mtree_insert_range);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°æ ¸å¿ƒåœ¨äºå£°æ˜äº†ä¸€ä¸ªmså˜é‡ï¼Œå³ma_stateç»“æ„ä½“,</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> MA_STATE(name, mt, first, end)					\</span></span><br><span class="line"><span class="meta">	struct ma_state name = &#123;					\</span></span><br><span class="line"><span class="meta">		.tree = mt,						\</span></span><br><span class="line"><span class="meta">		.index = first,						\</span></span><br><span class="line"><span class="meta">		.last = end,						\</span></span><br><span class="line"><span class="meta">		.node = NULL,						\ <span class="comment">//åˆå§‹çŠ¶æ€æ ‘æ²¡æœ‰ä»»ä½•èŠ‚ç‚¹</span></span></span><br><span class="line">		.status = ma_start,					\</span><br><span class="line">		.min = <span class="number">0</span>,						\</span><br><span class="line">		.max = ULONG_MAX,					\</span><br><span class="line">		.alloc = <span class="literal">NULL</span>,						\  </span><br><span class="line">		.mas_flags = <span class="number">0</span>,						\</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> ma_state &#123;</span><br><span class="line">	<span class="keyword">struct</span> maple_tree *tree;	<span class="comment">/* The tree we&#x27;re operating in */</span><span class="comment">// æŒ‡å‘ç›®æ ‡æ ‘</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> index;		<span class="comment">// å½“å‰æ“ä½œçš„èµ·å§‹indexï¼ˆfirstï¼‰</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> last;		<span class="comment">// å½“å‰æ“ä½œçš„ç»ˆæ­¢indexï¼ˆlastï¼‰</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_enode</span> *<span class="title">node</span>;</span>	<span class="comment">/* The node containing this entry */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> min;		<span class="comment">/* The minimum index - implied pivot min */</span><span class="comment">// å½“å‰èŠ‚ç‚¹ç®¡ç†çš„indexåŒºé—´</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> max;		<span class="comment">/* The maximum index - implied pivot max */</span><span class="comment">// å½“å‰èŠ‚ç‚¹ç®¡ç†çš„indexåŒºé—´</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_alloc</span> *<span class="title">alloc</span>;</span>	<span class="comment">/* Allocated nodes for this operation */</span> <span class="comment">// è‹¥éœ€è¦åˆ†é…æ–°èŠ‚ç‚¹ï¼ŒæŒ‡å‘é¢„åˆ†é…é¡µ</span></span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">maple_status</span> <span class="title">status</span>;</span>	<span class="comment">/* The status of the state (active, start, none, etc) */</span> <span class="comment">// çŠ¶æ€æœºæ ‡è®°ï¼ˆma_start, ma_none, ma_dataç­‰ï¼‰</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> depth;		<span class="comment">/* depth of tree descent during write */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> offset;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> mas_flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">char</span> end;		<span class="comment">/* The end of the node */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>ç„¶åè°ƒç”¨mas_insert(&amp;ms, entry);é‚£æˆ‘ä»¬æ¥çœ‹çœ‹mas_insertç›¸å…³ä»£ç , åœ¨è¯¥å‡½æ•°ä¸­ï¼ŒåŒæ ·ç”¨å®å£°æ˜äº†ä¸€ä¸ªMA_WR_STATEï¼Œ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * mas_insert() - Internal call to insert a value</span></span><br><span class="line"><span class="comment"> * @mas: The maple state</span></span><br><span class="line"><span class="comment"> * @entry: The entry to store</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Return: %NULL or the contents that already exists at the requested index</span></span><br><span class="line"><span class="comment"> * otherwise.  The maple state needs to be checked for error conditions.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> *<span class="title function_">mas_insert</span><span class="params">(<span class="keyword">struct</span> ma_state *mas, <span class="type">void</span> *entry)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define MA_WR_STATE(name, ma_state, wr_entry)				\</span></span><br><span class="line"><span class="comment">	struct ma_wr_state name = &#123;					\</span></span><br><span class="line"><span class="comment">		.mas = ma_state,					\</span></span><br><span class="line"><span class="comment">		.content = NULL,					\</span></span><br><span class="line"><span class="comment">		.entry = wr_entry,					\</span></span><br><span class="line"><span class="comment">	&#125;</span></span><br><span class="line"><span class="comment">	è¿™é‡Œè¿›æ¥é¦–å…ˆåˆ›å»ºä¸€ä¸ªmas_stateä¸Šä¸‹æ–‡ï¼Œ</span></span><br><span class="line"><span class="comment">	struct ma_wr_state &#123;</span></span><br><span class="line"><span class="comment">    	struct ma_state *mas;  // æŒ‡å‘å½“å‰ ma_state</span></span><br><span class="line"><span class="comment">    	void *content;         // ç°æœ‰å†…å®¹ï¼ˆå¦‚æœå·²å­˜åœ¨ï¼‰</span></span><br><span class="line"><span class="comment">    	void *entry;           // è¦æ’å…¥çš„æ–° entry</span></span><br><span class="line"><span class="comment">	&#125;;</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	MA_WR_STATE(wr_mas, mas, entry);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Inserting a new range inserts either 0, 1, or 2 pivots within the</span></span><br><span class="line"><span class="comment">	 * tree.  If the insert fits exactly into an existing gap with a value</span></span><br><span class="line"><span class="comment">	 * of NULL, then the slot only needs to be written with the new value.</span></span><br><span class="line"><span class="comment">	 * If the range being inserted is adjacent to another range, then only a</span></span><br><span class="line"><span class="comment">	 * single pivot needs to be inserted (as well as writing the entry).  If</span></span><br><span class="line"><span class="comment">	 * the new range is within a gap but does not touch any other ranges,</span></span><br><span class="line"><span class="comment">	 * then two pivots need to be inserted: the start - 1, and the end.  As</span></span><br><span class="line"><span class="comment">	 * usual, the entry must be written.  Most operations require a new node</span></span><br><span class="line"><span class="comment">	 * to be allocated and replace an existing node to ensure RCU safety,</span></span><br><span class="line"><span class="comment">	 * when in RCU mode.  The exception to requiring a newly allocated node</span></span><br><span class="line"><span class="comment">	 * is when inserting at the end of a node (appending).  When done</span></span><br><span class="line"><span class="comment">	 * carefully, appending can reuse the node in place.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	wr_mas.content = mas_start(mas);</span><br><span class="line">	<span class="keyword">if</span> (wr_mas.content)</span><br><span class="line">		<span class="keyword">goto</span> exists; <span class="comment">//å·²å­˜åœ¨ï¼Œä¸å…è®¸é‡å¤æ’å…¥</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mas_is_none(mas) || mas_is_ptr(mas)) &#123;</span><br><span class="line">		mas_store_root(mas, entry);  <span class="comment">//å¦‚æœæ˜¯ç©ºæ ‘ï¼Œç›´æ¥åœ¨rootæ’å…¥entry</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* spanning writes always overwrite something */</span></span><br><span class="line">	<span class="keyword">if</span> (!mas_wr_walk(&amp;wr_mas))</span><br><span class="line">		<span class="keyword">goto</span> exists;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* At this point, we are at the leaf node that needs to be altered. */</span></span><br><span class="line">	wr_mas.offset_end = mas-&gt;offset;</span><br><span class="line">	wr_mas.end_piv = wr_mas.r_max;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (wr_mas.content || (mas-&gt;last &gt; wr_mas.r_max))</span><br><span class="line">		<span class="keyword">goto</span> exists;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!entry)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	mas_wr_modify(&amp;wr_mas);</span><br><span class="line">	<span class="keyword">return</span> wr_mas.content;</span><br><span class="line"></span><br><span class="line">exists:</span><br><span class="line">	mas_set_err(mas, -EEXIST);</span><br><span class="line">	<span class="keyword">return</span> wr_mas.content;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯è¯´å¦‚æœæ˜¯ç©ºæ ‘ï¼Œåˆ™åˆ°mas_store_rootå‡½æ•°ä¸­è¿›è¡Œå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">mas_store_root</span><span class="params">(<span class="keyword">struct</span> ma_state *mas, <span class="type">void</span> *entry)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (likely((mas-&gt;last != <span class="number">0</span>) || (mas-&gt;index != <span class="number">0</span>)))  <span class="comment">//æ’å…¥æ˜¯ä¸€ä¸ªèŒƒå›´</span></span><br><span class="line">		mas_root_expand(mas, entry);</span><br><span class="line">	<span class="keyword">else</span> <span class="keyword">if</span> (((<span class="type">unsigned</span> <span class="type">long</span>) (entry) &amp; <span class="number">3</span>) == <span class="number">2</span>)  <span class="comment">//ä½ä¸¤ä½æ˜¯10</span></span><br><span class="line">		mas_root_expand(mas, entry); <span class="comment">//å°†æ ¹æ‰©å¤§</span></span><br><span class="line">	<span class="keyword">else</span> &#123;</span><br><span class="line">		rcu_assign_pointer(mas-&gt;tree-&gt;ma_root, entry);  <span class="comment">//å¦‚æœæ˜¯æ’å…¥å•ç‹¬ä¸€ä¸ªæ•°å­—ï¼Œåˆ™ç›´æ¥æŠŠè¯¥entryä½œä¸ºæ ¹</span></span><br><span class="line">		mas-&gt;status = ma_start; <span class="comment">//çŠ¶æ€æ”¹æˆè¿˜æ²¡å¼€å§‹æœç´¢æ ‘</span></span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * mas_root_expand() - Expand a root to a node</span></span><br><span class="line"><span class="comment"> * @mas: The maple state</span></span><br><span class="line"><span class="comment"> * @entry: The entry to store into the tree</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">int</span> <span class="title function_">mas_root_expand</span><span class="params">(<span class="keyword">struct</span> ma_state *mas, <span class="type">void</span> *entry)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">void</span> *contents = mas_root_locked(mas);</span><br><span class="line">	<span class="class"><span class="keyword">enum</span> <span class="title">maple_type</span> <span class="title">type</span> =</span> maple_leaf_64;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_node</span> *<span class="title">node</span>;</span></span><br><span class="line">	<span class="type">void</span> __rcu **slots;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *pivots;</span><br><span class="line">	<span class="type">int</span> slot = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	mas_node_count(mas, <span class="number">1</span>); <span class="comment">//ç¡®ä¿allocatedæ•°é‡è¦å¤§äº1ï¼Œä¸ç„¶å°±å¤šé¢„åˆ†é…å‡ ä¸ª</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(mas_is_err(mas)))</span><br><span class="line">		<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	node = mas_pop_node(mas);  <span class="comment">// åˆ†é…ä¸€ä¸ªæ–°çš„ maple_node</span></span><br><span class="line">	pivots = ma_pivots(node, type);</span><br><span class="line">	slots = ma_slots(node, type);</span><br><span class="line">	node-&gt;parent = ma_parent_ptr(mas_tree_parent(mas));</span><br><span class="line">	mas-&gt;node = mt_mk_node(node, type);</span><br><span class="line">	mas-&gt;status = ma_active;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (mas-&gt;index) &#123;</span><br><span class="line">		<span class="keyword">if</span> (contents) &#123;</span><br><span class="line">			rcu_assign_pointer(slots[slot], contents);</span><br><span class="line">			<span class="keyword">if</span> (likely(mas-&gt;index &gt; <span class="number">1</span>))</span><br><span class="line">				slot++;</span><br><span class="line">		&#125;</span><br><span class="line">		pivots[slot++] = mas-&gt;index - <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	rcu_assign_pointer(slots[slot], entry); <span class="comment">//slotsæˆå‘˜ç”¨äºå­˜å‚¨entry,ä¹Ÿå°±æ˜¯vm_area_struct</span></span><br><span class="line">	mas-&gt;offset = slot;</span><br><span class="line">	pivots[slot] = mas-&gt;last;</span><br><span class="line">	<span class="keyword">if</span> (mas-&gt;last != ULONG_MAX)</span><br><span class="line">		pivots[++slot] = ULONG_MAX;</span><br><span class="line"></span><br><span class="line">	mas-&gt;depth = <span class="number">1</span>;</span><br><span class="line">	mas_set_height(mas);</span><br><span class="line">	ma_set_meta(node, maple_leaf_64, <span class="number">0</span>, slot);</span><br><span class="line">	<span class="comment">/* swap the new root into the tree */</span></span><br><span class="line">	rcu_assign_pointer(mas-&gt;tree-&gt;ma_root, mte_mk_root(mas-&gt;node));</span><br><span class="line">	<span class="keyword">return</span> slot;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>æœ€åç»™ä¸€ä¸ªå®Œæ•´çš„vm_area_structæ˜¯å¦‚ä½•ç»„ç»‡æˆmaple_treeçš„ï¼Œè¿™ä¸ªç½‘ä¸Šèµ„æ–™å¤ªå°‘äº†ï¼Œæ‰¾åˆ°ä¸€ç¯‡è®ºæ–‡é‡Œçš„å›¾ï¼Œèƒ½å¤Ÿå¾ˆå¥½åœ°è¯´æ˜å„ä¸ªèŠ‚ç‚¹å’Œå†…å®¹ã€‚å…·ä½“æ¥è¯´pivotæ¥è¡¨ç¤ºå„ä¸ªvm_area_structçš„èŒƒå›´ï¼Œslots ç”¨æ¥å­˜å‚¨vm_area_structï¼ˆå¶å­èŠ‚ç‚¹ï¼‰æˆ–è€…ä¸‹ä¸€çº§slotsï¼ˆéå¶å­èŠ‚ç‚¹ï¼‰çš„åœ°å€ã€‚è¿™æ ·çœ‹å°±éå¸¸äº†ç„¶äº†ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251006215530853.png" alt="image-20251006215530853"></p>
<p>å¯ä»¥çœ‹åˆ°éleaf nodeç”¨çš„æ˜¯maple_arange_64ç»“æ„ä½“ï¼Œå…¶slotså­˜å‚¨çš„éƒ½æ˜¯ä¸‹ä¸€çº§slotsçš„æŒ‡é’ˆï¼Œè€Œleaf nodeä½¿ç”¨çš„æ˜¯maple_range_64ç»“æ„ä½“ï¼Œå…¶slotså­˜å‚¨user dataã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Leaf nodes do not store pointers to nodes, they store user data.  Users may</span></span><br><span class="line"><span class="comment"> * store almost any bit pattern.  As noted above, the optimisation of storing an</span></span><br><span class="line"><span class="comment"> * entry at 0 in the root pointer cannot be done for data which have the bottom</span></span><br><span class="line"><span class="comment"> * two bits set to &#x27;10&#x27;.  We also reserve values with the bottom two bits set to</span></span><br><span class="line"><span class="comment"> * &#x27;10&#x27; which are below 4096 (ie 2, 6, 10 .. 4094) for internal use.  Some APIs</span></span><br><span class="line"><span class="comment"> * return errnos as a negative errno shifted right by two bits and the bottom</span></span><br><span class="line"><span class="comment"> * two bits set to &#x27;10&#x27;, and while choosing to store these values in the array</span></span><br><span class="line"><span class="comment"> * is not an error, it may lead to confusion if you&#x27;re testing for an error with</span></span><br><span class="line"><span class="comment"> * mas_is_err().</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * Non-leaf nodes store the type of the node pointed to (enum maple_type in bits</span></span><br><span class="line"><span class="comment"> * 3-6), bit 2 is reserved.  That leaves bits 0-1 unused for now.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * In regular B-Tree terms, pivots are called keys.  The term pivot is used to</span></span><br><span class="line"><span class="comment"> * indicate that the tree is specifying ranges,  Pivots may appear in the</span></span><br><span class="line"><span class="comment"> * subtree with an entry attached to the value whereas keys are unique to a</span></span><br><span class="line"><span class="comment"> * specific position of a B-tree.  Pivot values are inclusive of the slot with</span></span><br><span class="line"><span class="comment"> * the same index.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">maple_range_64</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_pnode</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> pivot[MAPLE_RANGE64_SLOTS - <span class="number">1</span>];</span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="type">void</span> __rcu *slot[MAPLE_RANGE64_SLOTS];</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> &#123;</span></span><br><span class="line">			<span class="type">void</span> __rcu *pad[MAPLE_RANGE64_SLOTS - <span class="number">1</span>];</span><br><span class="line">			<span class="class"><span class="keyword">struct</span> <span class="title">maple_metadata</span> <span class="title">meta</span>;</span></span><br><span class="line">		&#125;;</span><br><span class="line">	&#125;;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * At tree creation time, the user can specify that they&#x27;re willing to trade off</span></span><br><span class="line"><span class="comment"> * storing fewer entries in a tree in return for storing more information in</span></span><br><span class="line"><span class="comment"> * each node.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * The maple tree supports recording the largest range of NULL entries available</span></span><br><span class="line"><span class="comment"> * in this node, also called gaps.  This optimises the tree for allocating a</span></span><br><span class="line"><span class="comment"> * range.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">maple_arange_64</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_pnode</span> *<span class="title">parent</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> pivot[MAPLE_ARANGE64_SLOTS - <span class="number">1</span>];</span><br><span class="line">	<span class="type">void</span> __rcu *slot[MAPLE_ARANGE64_SLOTS];</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> gap[MAPLE_ARANGE64_SLOTS];</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">maple_metadata</span> <span class="title">meta</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>





<h1 id="å†…æ ¸ä¸­ä¸€äº›å†…å­˜åˆ†é…å‡½æ•°çš„ç»†èŠ‚ä¸åŒºåˆ«"><a href="#å†…æ ¸ä¸­ä¸€äº›å†…å­˜åˆ†é…å‡½æ•°çš„ç»†èŠ‚ä¸åŒºåˆ«" class="headerlink" title="å†…æ ¸ä¸­ä¸€äº›å†…å­˜åˆ†é…å‡½æ•°çš„ç»†èŠ‚ä¸åŒºåˆ«"></a>å†…æ ¸ä¸­ä¸€äº›å†…å­˜åˆ†é…å‡½æ•°çš„ç»†èŠ‚ä¸åŒºåˆ«</h1><h2 id="ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡½æ•°"><a href="#ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡½æ•°" class="headerlink" title="ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡½æ•°"></a>ä¼™ä¼´ç³»ç»Ÿåˆ†é…å‡½æ•°</h2><p>é¦–å…ˆæ˜¯å‰é¢è¯´è¿‡çš„ä¼™ä¼´ç³»ç»Ÿï¼Œä¸»è¦åˆ†é…å‡½æ•°æœ‰<code>alloc_page</code>,<code>alloc_pages</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//include/linux/gfp.h</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_page(gfp_mask) alloc_pages(gfp_mask, 0)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> alloc_pages(...)			alloc_hooks(alloc_pages_noprof(__VA_ARGS__))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">//NUMAæ¶æ„</span></span><br><span class="line"><span class="keyword">struct</span> page *<span class="title function_">alloc_pages_noprof</span><span class="params">(<span class="type">gfp_t</span> gfp, <span class="type">unsigned</span> <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mempolicy</span> *<span class="title">pol</span> =</span> &amp;default_policy;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * No reference counting needed for current-&gt;mempolicy</span></span><br><span class="line"><span class="comment">	 * nor system default_policy</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!in_interrupt() &amp;&amp; !(gfp &amp; __GFP_THISNODE))</span><br><span class="line">		pol = get_task_policy(current);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> alloc_pages_mpol_noprof(gfp, order, pol, NO_INTERLEAVE_INDEX,</span><br><span class="line">				       numa_node_id());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">//éNUMAæ¶æ„</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">alloc_pages_noprof</span><span class="params">(<span class="type">gfp_t</span> gfp_mask, <span class="type">unsigned</span> <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> alloc_pages_node_noprof(numa_node_id(), gfp_mask, order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¯ä»¥çœ‹åˆ°å°±æ˜¯åˆ†ä¸ºNUMAæ¶æ„å’ŒéNUMAæ¶æ„çš„åŒºåˆ«äº†ï¼Œè¿™é‡Œæˆ‘ä»¬åˆ†åˆ«æ¥çœ‹ï¼Œå› ä¸ºè°ƒç”¨çš„æ˜¯ä¸åŒå‡½æ•°</p>
<h3 id="NUMAæ¶æ„"><a href="#NUMAæ¶æ„" class="headerlink" title="NUMAæ¶æ„"></a>NUMAæ¶æ„</h3><p>NUMAæ¶æ„æ˜¯ä»å†…å­˜æ± ä¸­è·å–<code>1&lt;&lt;order</code>ä¸ªé¡µé¢ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> page *<span class="title function_">alloc_pages_mpol_noprof</span><span class="params">(<span class="type">gfp_t</span> gfp, <span class="type">unsigned</span> <span class="type">int</span> order,</span></span><br><span class="line"><span class="params">		<span class="keyword">struct</span> mempolicy *pol, <span class="type">pgoff_t</span> ilx, <span class="type">int</span> nid)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">nodemask_t</span> *nodemask; <span class="comment">//å‡†å¤‡nodeæ©ç </span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span> <span class="comment">//å‡†å¤‡return value</span></span><br><span class="line"></span><br><span class="line">	nodemask = policy_nodemask(gfp, pol, ilx, &amp;nid);  <span class="comment">//æ ¹æ®mempoolçš„ç­–ç•¥ï¼Œåˆ†æå¯ä»¥ä»å“ªäº›nodeä¸Šåˆ†é…é¡µé¢ã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (pol-&gt;mode == MPOL_PREFERRED_MANY) <span class="comment">//å½“ç­–ç•¥å…è®¸å¤šä¸ªâ€œé¦–é€‰èŠ‚ç‚¹â€æ—¶ï¼Œè·³è¿‡åç»­é€»è¾‘ï¼Œç”¨ä¸“é—¨è·¯å¾„åˆ†é…ã€‚</span></span><br><span class="line">		<span class="keyword">return</span> alloc_pages_preferred_many(gfp, order, nid, nodemask);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_TRANSPARENT_HUGEPAGE) &amp;&amp;</span><br><span class="line">	    <span class="comment">/* filter &quot;hugepage&quot; allocation, unless from alloc_pages() */</span></span><br><span class="line">	    order == HPAGE_PMD_ORDER &amp;&amp; ilx != NO_INTERLEAVE_INDEX) &#123; <span class="comment">//åˆ†é…é€æ˜å¤§é¡µï¼Œä¼˜å…ˆä»æœ¬èŠ‚ç‚¹è·å–</span></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * For hugepage allocation and non-interleave policy which</span></span><br><span class="line"><span class="comment">		 * allows the current node (or other explicitly preferred</span></span><br><span class="line"><span class="comment">		 * node) we only try to allocate from the current/preferred</span></span><br><span class="line"><span class="comment">		 * node and don&#x27;t fall back to other nodes, as the cost of</span></span><br><span class="line"><span class="comment">		 * remote accesses would likely offset THP benefits.</span></span><br><span class="line"><span class="comment">		 *</span></span><br><span class="line"><span class="comment">		 * If the policy is interleave or does not allow the current</span></span><br><span class="line"><span class="comment">		 * node in its nodemask, we allocate the standard way.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (pol-&gt;mode != MPOL_INTERLEAVE &amp;&amp;</span><br><span class="line">		    pol-&gt;mode != MPOL_WEIGHTED_INTERLEAVE &amp;&amp;</span><br><span class="line">		    (!nodemask || node_isset(nid, *nodemask))) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * First, try to allocate THP only on local node, but</span></span><br><span class="line"><span class="comment">			 * don&#x27;t reclaim unnecessarily, just compact.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			page = __alloc_pages_node_noprof(nid,</span><br><span class="line">				gfp | __GFP_THISNODE | __GFP_NORETRY, order); <span class="comment">//å°è¯•å…ˆåœ¨æœ¬åœ°èŠ‚ç‚¹è·¯å¾„ä¸Šå¿«é€Ÿåˆ†é…ï¼Œä¸è§¦å‘å†…å­˜å›æ”¶</span></span><br><span class="line">			<span class="keyword">if</span> (page || !(gfp &amp; __GFP_DIRECT_RECLAIM))</span><br><span class="line">				<span class="keyword">return</span> page;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * If hugepage allocations are configured to always</span></span><br><span class="line"><span class="comment">			 * synchronous compact or the vma has been madvised</span></span><br><span class="line"><span class="comment">			 * to prefer hugepage backing, retry allowing remote</span></span><br><span class="line"><span class="comment">			 * memory with both reclaim and compact as well.</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	page = __alloc_pages_noprof(gfp, order, nid, nodemask);  <span class="comment">//å¦‚æœå‰é¢å¤±è´¥äº†ï¼Œå°±è°ƒç”¨æ­£å¸¸è·¯å¾„åˆ†é…ï¼Œå¯ä»¥è·¨èŠ‚ç‚¹ï¼Œå¯èƒ½è§¦å‘å†…å­˜å›æ”¶ï¼Œä¼šæ ¹æ®nodemaské™åˆ¶åˆ†é…èŠ‚ç‚¹</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (unlikely(pol-&gt;mode == MPOL_INTERLEAVE) &amp;&amp; page) &#123;</span><br><span class="line">		<span class="comment">/* skip NUMA_INTERLEAVE_HIT update if numa stats is disabled */</span></span><br><span class="line">		<span class="keyword">if</span> (static_branch_likely(&amp;vm_numa_stat_key) &amp;&amp;</span><br><span class="line">		    page_to_nid(page) == nid) &#123;</span><br><span class="line">			preempt_disable();</span><br><span class="line">			__count_numa_event(page_zone(page), NUMA_INTERLEAVE_HIT);</span><br><span class="line">			preempt_enable();</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œå‡½æ•°ä¸ä¼šè§¦å‘å†…å­˜å›æ”¶ï¼Œå› ä¸ºè®¾ç½®äº†gfp_maskï¼Œåç»­æ…¢é€Ÿè·¯å¾„ä½¿ç”¨åŸæ¥çš„mask</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="class"><span class="keyword">struct</span> <span class="title">page</span> *</span></span><br><span class="line"><span class="class">__<span class="title">alloc_pages_node_noprof</span>(<span class="title">int</span> <span class="title">nid</span>, <span class="title">gfp_t</span> <span class="title">gfp_mask</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	VM_BUG_ON(nid &lt; <span class="number">0</span> || nid &gt;= MAX_NUMNODES);</span><br><span class="line">	warn_if_node_offline(nid, gfp_mask); <span class="comment">//æ£€æŸ¥èŠ‚ç‚¹æ²¡æœ‰ä¸‹çº¿ï¼Œæ˜¯å¦åˆæ³•</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __alloc_pages_noprof(gfp_mask, order, nid, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * This is the &#x27;heart&#x27; of the zoned buddy allocator.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">page</span> *__<span class="title">alloc_pages_noprof</span>(<span class="title">gfp_t</span> <span class="title">gfp</span>, <span class="title">unsigned</span> <span class="title">int</span> <span class="title">order</span>,</span></span><br><span class="line"><span class="class">				      <span class="title">int</span> <span class="title">preferred_nid</span>, <span class="title">nodemask_t</span> *<span class="title">nodemask</span>)</span></span><br><span class="line"><span class="class">&#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">page</span> *<span class="title">page</span>;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> alloc_flags = ALLOC_WMARK_LOW; <span class="comment">//ä½æ°´ä½çº¿</span></span><br><span class="line">	<span class="type">gfp_t</span> alloc_gfp; <span class="comment">/* The gfp_t that was actually used for allocation */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">alloc_context</span> <span class="title">ac</span> =</span> &#123; &#125;;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * There are several places where we assume that the order value is sane</span></span><br><span class="line"><span class="comment">	 * so bail out early if the request is out of bound.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (WARN_ON_ONCE_GFP(order &gt; MAX_PAGE_ORDER, gfp)) <span class="comment">//é˜²æ­¢åˆ†é…è¿‡å¤§çš„é¡µé¢ è¿™é‡ŒæŒ‡çš„æ˜¯å¤§äº2^10</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	gfp &amp;= gfp_allowed_mask;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Apply scoped allocation constraints. This is mainly about GFP_NOFS</span></span><br><span class="line"><span class="comment">	 * resp. GFP_NOIO which has to be inherited for all allocation requests</span></span><br><span class="line"><span class="comment">	 * from a particular context which has been marked by</span></span><br><span class="line"><span class="comment">	 * memalloc_no&#123;fs,io&#125;_&#123;save,restore&#125;. And PF_MEMALLOC_PIN which ensures</span></span><br><span class="line"><span class="comment">	 * movable zones are not used during allocation.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	gfp = current_gfp_context(gfp);</span><br><span class="line">	alloc_gfp = gfp;</span><br><span class="line">	<span class="keyword">if</span> (!prepare_alloc_pages(gfp, order, preferred_nid, nodemask, &amp;ac,</span><br><span class="line">			&amp;alloc_gfp, &amp;alloc_flags)) <span class="comment">//åšä¸€äº›å‡†å¤‡å·¥ä½œï¼Œæ¯”å¦‚ç¡®å®šç›®æ ‡Zoneï¼Œè°ƒæ•´gfpï¼Œæ£€æŸ¥CPUSETç›¸å…³ç­‰ã€‚</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Forbid the first pass from falling back to types that fragment</span></span><br><span class="line"><span class="comment">	 * memory until all local zones are considered.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	alloc_flags |= alloc_flags_nofragment(ac.preferred_zoneref-&gt;zone, gfp);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* First allocation attempt */</span></span><br><span class="line">	page = get_page_from_freelist(alloc_gfp, order, alloc_flags, &amp;ac); <span class="comment">//å¿«é€Ÿè·¯å¾„å°è¯•ï¼Œæœ€åè°ƒç”¨rmqueue() ä»ä¼™ä¼´ç³»ç»Ÿå–é¡µ</span></span><br><span class="line">	<span class="keyword">if</span> (likely(page))</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	alloc_gfp = gfp;</span><br><span class="line">	ac.spread_dirty_pages = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Restore the original nodemask if it was potentially replaced with</span></span><br><span class="line"><span class="comment">	 * &amp;cpuset_current_mems_allowed to optimize the fast-path attempt.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	ac.nodemask = nodemask;</span><br><span class="line"></span><br><span class="line">	page = __alloc_pages_slowpath(alloc_gfp, order, &amp;ac); <span class="comment">//æ‰§è¡Œæ»¡é€Ÿåˆ†é…ï¼Œä¼šæ‰§è¡Œå†…å­˜å‹ç¼©ï¼Œä¼šè§¦å‘OOMç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	<span class="keyword">if</span> (memcg_kmem_online() &amp;&amp; (gfp &amp; __GFP_ACCOUNT) &amp;&amp; page &amp;&amp;</span><br><span class="line">	    unlikely(__memcg_kmem_charge_page(page, gfp, order) != <span class="number">0</span>)) &#123;</span><br><span class="line">		__free_pages(page, order);</span><br><span class="line">		page = <span class="literal">NULL</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	trace_mm_page_alloc(page, order, alloc_gfp, ac.migratetype);</span><br><span class="line">	kmsan_alloc_page(page, order, alloc_gfp);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> page;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="éNUMAæ¶æ„"><a href="#éNUMAæ¶æ„" class="headerlink" title="éNUMAæ¶æ„"></a>éNUMAæ¶æ„</h3><p>éNUMAæ¶æ„å…¶å®ä¹Ÿæ˜¯è°ƒç”¨çš„ä»¥ä¸Šå‡½æ•°ï¼Œåªæ˜¯è°ƒç”¨çš„å‚æ•°ä¸å¤ªä¸€æ ·ï¼Œè¿™é‡Œå°±ä¸è¯¦ç»†è¯´æ˜äº†</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> page *<span class="title function_">alloc_pages_node_noprof</span><span class="params">(<span class="type">int</span> nid, <span class="type">gfp_t</span> gfp_mask,</span></span><br><span class="line"><span class="params">						   <span class="type">unsigned</span> <span class="type">int</span> order)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (nid == NUMA_NO_NODE)</span><br><span class="line">		nid = numa_mem_id();</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> __alloc_pages_node_noprof(nid, gfp_mask, order);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="å…¶ä»–buddyä¹‹ä¸Šçš„åˆ†é…å‡½æ•°"><a href="#å…¶ä»–buddyä¹‹ä¸Šçš„åˆ†é…å‡½æ•°" class="headerlink" title="å…¶ä»–buddyä¹‹ä¸Šçš„åˆ†é…å‡½æ•°"></a>å…¶ä»–buddyä¹‹ä¸Šçš„åˆ†é…å‡½æ•°</h2><p>get_free_page</p>
<p>get_dma_pages</p>
<p>alloc_pages_exact</p>
<p>get_zerod_page</p>
<p>æœ€åéƒ½ä¼šè°ƒç”¨__get_free_pages, ç„¶åå†è°ƒç”¨åº•å±‚çš„buddyå‡½æ•°ã€‚</p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>æ–‡ä»¶ç³»ç»Ÿ</title>
    <url>/2025/09/19/note/%E6%96%87%E4%BB%B6%E7%B3%BB%E7%BB%9F/</url>
    <content><![CDATA[<h1 id="Linux-æ–‡ä»¶ç³»ç»Ÿè¯¦è§£"><a href="#Linux-æ–‡ä»¶ç³»ç»Ÿè¯¦è§£" class="headerlink" title="Linux æ–‡ä»¶ç³»ç»Ÿè¯¦è§£"></a>Linux æ–‡ä»¶ç³»ç»Ÿè¯¦è§£</h1><p>è¦è®²æ–‡ä»¶ç³»ç»Ÿä¸»è¦æœ‰ä¸‰ä¸ªæ–¹é¢çš„å†…å®¹éœ€è¦äº†è§£ï¼š</p>
<ul>
<li>ç”¨æˆ·è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå³ä¸€ä¸ªæ ‘çŠ¶çš„ç›®å½•ç»“æ„ï¼ŒåŒ…æ‹¬å„ä¸ªä¸åŒç£ç›˜çš„mountå…³ç³»ï¼Œå„ä¸ªæ–‡ä»¶çš„å±æ€§å’Œæƒé™ä»¥åŠæ–‡ä»¶æœ¬èº«ï¼ˆä¸€ä¸ªæ•°ç»„å½¢çŠ¶çš„å­—èŠ‚åˆé›†ï¼‰ã€‚</li>
<li>Linuxç³»ç»Ÿä¸‹çš„æ–‡ä»¶ç³»ç»Ÿï¼Œå³å†…æ ¸ä¸­æ–‡ä»¶ç›¸å…³çš„æ•°æ®ç»“æ„ï¼ŒåŒ…æ‹¬super blockï¼Œ inodeï¼Œ dentryç­‰ï¼Œè¿˜æœ‰ç£ç›˜ä¸Šæ–‡ä»¶çš„é¡µç¼“å­˜ã€‚</li>
<li>ç£ç›˜ä¸Šç‰©ç†ç»„ç»‡æ–‡ä»¶çš„è§†è§’ï¼Œç£ç›˜ä¸Šçš„å„ä¸ªå—ä¹‹é—´çš„å…³ç³»ä»¥åŠå„ä¸ªinodeç­‰ã€‚</li>
</ul>
<h1 id="ç”¨æˆ·è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#ç”¨æˆ·è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="ç”¨æˆ·è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ"></a>ç”¨æˆ·è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ</h1><p>ç”¨æˆ·è§†è§’ä¸‹æ–‡ä»¶ç³»ç»Ÿå…¶å®å°±æ˜¯ä¸€ä¸ªæ ‘çŠ¶çš„ç›®å½•ï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å…¶ä¸­ä¸»ç£ç›˜å³rootfsï¼Œåœ¨ç³»ç»Ÿå¯åŠ¨é˜¶æ®µè¢«è£…è½½åœ¨æ ¹ç›®å½•ï¼Œè€Œå…¶ä»–æ–‡ä»¶ç³»ç»Ÿä¾‹å¦‚Uç›˜æˆ–è€…ç§»åŠ¨ç¡¬ç›˜å›ºæ€ç­‰ï¼Œå°±ä¼šè£…è½½åœ¨ä¸€ä¸ªç‰¹å®šçš„èŠ‚ç‚¹ä¸Šï¼Œä¾‹å¦‚å›¾ä¸­homeå’Œusb1å°±æ˜¯ä¸¤ä¸ªæŒ‚è½½ç‚¹ï¼ŒæŒ‚åœ¨äº†ä¸¤ä¸ªæ–‡ä»¶ç³»ç»Ÿã€‚æ•´ä½“å½¢æˆä¸€æ£µç›®å½•æ ‘ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/20251002221915949.png" alt="image-20251002220629047"></p>
<h1 id="è¿›ç¨‹è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ"><a href="#è¿›ç¨‹è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="è¿›ç¨‹è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ"></a>è¿›ç¨‹è§†è§’ä¸‹çš„æ–‡ä»¶ç³»ç»Ÿ</h1><h2 id="task-structä¸­å’Œæ–‡ä»¶ç›¸å…³å†…å®¹"><a href="#task-structä¸­å’Œæ–‡ä»¶ç›¸å…³å†…å®¹" class="headerlink" title="task_structä¸­å’Œæ–‡ä»¶ç›¸å…³å†…å®¹"></a>task_structä¸­å’Œæ–‡ä»¶ç›¸å…³å†…å®¹</h2><p>è¿›ç¨‹åœ¨Linux kernelä¸­ä¸»è¦æ˜¯ç”¨task_structè¿™ä¸ªç»“æ„æ¥è¡¨ç¤ºï¼Œä¸€ä¸ªè¿›ç¨‹æœ‰ä¸€ä¸ªtask_structï¼Œå³æ“ä½œç³»ç»Ÿä¸­æ‰€è°“çš„TCBã€‚åœ¨task_structä¸­æœ‰å¾ˆå¤šå­—æ®µå’Œæ–‡ä»¶ç›¸å…³ï¼Œè¿™é‡Œåªåˆ—å‡ºå‡ ä¸ªå…³é”®çš„ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/sched.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> &#123;</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">/* Filesystem information: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span>		*<span class="title">fs</span>;</span> <span class="comment">//å­˜æ”¾è¿›ç¨‹çš„æ–‡ä»¶ç³»ç»Ÿä¸Šä¸‹æ–‡ï¼šå½“å‰ç›®å½• (cwd)ã€æ ¹ç›®å½• (root)ã€umaskã€chdir ç­‰ä¿¡æ¯ã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Open file information: */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span>		*<span class="title">files</span>;</span> <span class="comment">//æŒ‡å‘è¿›ç¨‹çš„æ‰“å¼€æ–‡ä»¶è¡¨ï¼ˆfd tableï¼‰ã€‚åŒ…å« fd æ•°ç»„ã€close_on_exec ä½å›¾ã€å¼•ç”¨è®¡æ•°ç­‰ï¼ˆåœ¨ fdtable.h å®šä¹‰ï¼‰</span></span><br><span class="line">    </span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span>		*<span class="title">nameidata</span>;</span> <span class="comment">//ä¸è·¯å¾„æŸ¥æ‰¾ï¼ˆlookupï¼‰ç›¸å…³çš„ä¸´æ—¶ç»“æ„ï¼ˆlookup æ“ä½œæ—¶ä½¿ç”¨ï¼‰ã€‚</span></span><br><span class="line">    </span><br><span class="line">    ......</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆæ¯ä¸ªè¿›ç¨‹ä¼šæœ‰è‡ªå·±çš„è¿›ç¨‹ä¸Šä¸‹æ–‡ï¼Œå³å½“å‰çš„å·¥ä½œç›®å½•å’Œæ ¹ç›®å½•ï¼Œè®°å½•åœ¨fs_structç»“æ„ä½“ä¸­ã€‚åŒæ—¶ä¼šæ‰“å¼€å¤šä¸ªæ–‡ä»¶ï¼Œè®°å½•åœ¨files_structç»“æ„ä½“ä¸­ã€‚æ­¤å¤–è¿˜æœ‰ä¸€ä¸ª<code>nameidata</code>å­—æ®µï¼Œ<em>struct nameidata</em> æ˜¯ Linux å†…æ ¸ä¸­ç”¨äºè·¯å¾„æŸ¥æ‰¾çš„è¾…åŠ©ç»“æ„ä½“ã€‚å®ƒåœ¨æ–‡ä»¶ç³»ç»Ÿä¸­èµ·ç€å…³é”®ä½œç”¨ï¼Œå¸®åŠ©æ ¹æ®è·¯å¾„åæ‰¾åˆ°ç›®æ ‡èŠ‚ç‚¹çš„ dentry å’Œ inodeã€‚</p>
<h2 id="fs-structç»“æ„ä½“"><a href="#fs-structç»“æ„ä½“" class="headerlink" title="fs_structç»“æ„ä½“"></a>fs_structç»“æ„ä½“</h2><p>å‰é¢è¯´åˆ°äº†ä¸€ä¸ªè¿›ç¨‹å†…æœ‰ä¸€ä¸ªfs_structç»“æ„ä½“ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹å®ƒåŒ…å«ä»€ä¹ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fs_struct.h</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fs_struct</span> &#123;</span></span><br><span class="line">	<span class="type">int</span> users;  <span class="comment">//è¢«å…±äº«ï¼ˆå¼•ç”¨ï¼‰çš„æ¬¡æ•°ï¼Œå³å…±äº«è¯¥fs_structçš„è¿›ç¨‹æ•°ç›®ï¼Œå½“è¯¥è®¡æ•°å½’0ï¼Œè¯¥ç»“æ„ä½“ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line">	<span class="type">spinlock_t</span> lock; <span class="comment">//ä¿æŠ¤è¯¥ç»“æ„çš„è‡ªæ—‹é”</span></span><br><span class="line">	<span class="type">seqcount_spinlock_t</span> seq; <span class="comment">//è¯»å†™ç›¸å…³çš„åºåˆ—é”ï¼Œç”¨äºå¯¹ rootã€pwd çš„å¹¶å‘è®¿é—®æä¾›â€œä¹è§‚è¯»å–â€æœºåˆ¶ã€‚è¯»è€…ä¸åŠ é”ï¼Œåªæ˜¯è¯»å–å¹¶æ£€æŸ¥åºå·æ˜¯å¦ä¸€è‡´ï¼›å†™è€…éœ€è¦æŒæœ‰ lock å¹¶æ›´æ–° seqã€‚è¿™æ ·å‡å°‘äº†å¯¹é¢‘ç¹è¯»æ“ä½œçš„é”ç«äº‰ã€‚</span></span><br><span class="line">	<span class="type">int</span> umask; <span class="comment">//è¿›ç¨‹åˆ›å»ºæ–‡ä»¶æ—¶é»˜è®¤çš„è®¿é—®æƒé™</span></span><br><span class="line">	<span class="type">int</span> in_exec;<span class="comment">//å½“è¿›ç¨‹è°ƒç”¨ execve() æ‰§è¡Œæ–°ç¨‹åºæ—¶è®¾ç½®ï¼Œç”¨æ¥é˜²æ­¢å¹¶å‘ä¿®æ”¹ fs_structï¼ˆæ¯”å¦‚åˆ«çš„çº¿ç¨‹åœ¨ exec æ—¶æ”¹å·¥ä½œç›®å½•ï¼‰ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span> <span class="title">root</span>, <span class="title">pwd</span>;</span> <span class="comment">//æ ¹ç›®å½•å’Œå½“å‰ç›®å½•</span></span><br><span class="line">&#125; __randomize_layout;  <span class="comment">//éšæœºåŒ–æˆå‘˜ï¼Œåœ¨ç¼–è¯‘é˜¶æ®µéšæœºåŒ–éƒ¨åˆ†æˆå‘˜çš„é¡ºåº</span></span><br></pre></td></tr></table></figure>

<h2 id="files-structç»“æ„ä½“"><a href="#files-structç»“æ„ä½“" class="headerlink" title="files_structç»“æ„ä½“"></a>files_structç»“æ„ä½“</h2><p>å†…æ ¸ä¸­è¿˜æœ‰ä¸€ä¸ªfiles_structç»“æ„ä½“ï¼ŒåŒæ ·çœ‹çœ‹é‡Œé¢åŒ…å«äº†å“ªäº›å†…å®¹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fdtable.h</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * Open file table structure</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> &#123;</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * read mostly part</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">	<span class="type">atomic_t</span> count; <span class="comment">//è¢«å…±äº«å¼•ç”¨çš„æ¬¡æ•°ï¼Œå¤šä¸ªè¿›ç¨‹ï¼ˆä¾‹å¦‚é€šè¿‡ clone(CLONE_FILES)ï¼‰å¯ä»¥å…±äº«åŒä¸€ä¸ªæ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œcount è¡¨ç¤ºæœ‰å¤šå°‘è¿›ç¨‹åœ¨å…±äº«ã€‚ä¸º 0 æ—¶é‡Šæ”¾ã€‚</span></span><br><span class="line">	<span class="type">bool</span> resize_in_progress; <span class="comment">//æ–‡ä»¶æè¿°ç¬¦è¡¨æ˜¯å¦æ­£åœ¨æ‰©å®¹ã€‚å½“æ‰“å¼€çš„æ–‡ä»¶æ•°è¶…è¿‡å½“å‰è¡¨å¤§å°æ—¶ï¼Œéœ€è¦æ‰©å±• fdtableã€‚è¿™ä¸ªæ ‡å¿—ç”¨æ¥é˜²æ­¢å¹¶å‘æ‰©å±•ï¼ˆresize raceï¼‰ã€‚</span></span><br><span class="line">	<span class="type">wait_queue_head_t</span> resize_wait; <span class="comment">//ç­‰å¾…é˜Ÿåˆ—ï¼Œå¦‚æœæœ‰å¤šä¸ªçº¿ç¨‹åŒæ—¶è§¦å‘æ‰©å®¹ï¼Œåªæœ‰ä¸€ä¸ªæ‰§è¡Œ resizeï¼Œå…¶ä½™åœ¨æ­¤é˜Ÿåˆ—ç­‰å¾…ï¼Œé¿å…é‡å¤æ‰©å±•ã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> __<span class="title">rcu</span> *<span class="title">fdt</span>;</span> <span class="comment">//å½“å‰æ­£åœ¨ä½¿ç”¨çš„æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼ŒæŒ‡é’ˆå¸¦æœ‰ RCU ä¿æŠ¤ã€‚å­˜æ”¾æ–‡ä»¶æè¿°ç¬¦ï¼ˆfdï¼‰ä¸æ–‡ä»¶å¯¹è±¡çš„æ˜ å°„è¡¨ï¼ŒæŒ‡é’ˆå¯èƒ½åœ¨æ‰©å±•æ—¶åˆ‡æ¢åˆ°æ–°çš„ fdtableã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> <span class="title">fdtab</span>;</span> <span class="comment">//å†…åµŒçš„ä¸€ä¸ªå° fdtableã€‚åˆå§‹æ—¶è¿›ç¨‹ç›´æ¥ä½¿ç”¨è¿™ä¸ªå†…åµŒè¡¨ï¼Œé¿å…é¢‘ç¹ kmallocã€‚é€šå¸¸èƒ½å®¹çº³å°‘é‡ fdï¼ˆæ¯”å¦‚ NR_OPEN_DEFAULT ä¸ªï¼‰ã€‚åªæœ‰æ‰“å¼€çš„æ–‡ä»¶æ•°è¶…è¿‡é»˜è®¤å¤§å°æ‰ä¼šåˆ†é…æ–°çš„å¤§è¡¨ã€‚</span></span><br><span class="line">  <span class="comment">/*</span></span><br><span class="line"><span class="comment">   * written part on a separate cache line in SMP</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">	<span class="type">spinlock_t</span> file_lock ____cacheline_aligned_in_smp; <span class="comment">//ä¿æŠ¤æ–‡ä»¶æè¿°ç¬¦è¡¨çš„è‡ªæ—‹é”ã€‚æ§åˆ¶å¯¹æ–‡ä»¶æè¿°ç¬¦ï¼ˆæ‰“å¼€ã€å…³é—­ã€dup ç­‰ï¼‰çš„å¹¶å‘ä¿®æ”¹ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> next_fd; <span class="comment">//ä¸‹ä¸€ä¸ªå¯ç”¨çš„æ–‡ä»¶æè¿°ç¬¦å·ã€‚æé«˜åˆ†é… fd çš„æ•ˆç‡ï¼Œæ¯æ¬¡åˆ†é…æ—¶ä» next_fd å¼€å§‹æœç´¢ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> close_on_exec_init[<span class="number">1</span>]; <span class="comment">//ä½å›¾ï¼ˆåˆå§‹å†…åµŒéƒ¨åˆ†ï¼‰ï¼Œå¯¹åº” FD_CLOEXEC æ ‡å¿—ã€‚è®°å½•å“ªäº› fd åœ¨ execve() æ—¶éœ€è¦è‡ªåŠ¨å…³é—­ã€‚è¶…å‡ºèŒƒå›´æ—¶åœ¨ fdtable çš„åŠ¨æ€éƒ¨åˆ†é‡Œæ‰©å±•ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> open_fds_init[<span class="number">1</span>]; <span class="comment">//ä½å›¾ï¼ˆåˆå§‹å†…åµŒéƒ¨åˆ†ï¼‰ï¼Œè®°å½•å“ªäº› fd å½“å‰æ˜¯æ‰“å¼€çŠ¶æ€ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> full_fds_bits_init[<span class="number">1</span>]; <span class="comment">//ä½å›¾ï¼ˆåˆå§‹å†…åµŒéƒ¨åˆ†ï¼‰ï¼Œè¾…åŠ©ä½å›¾ï¼Œç”¨äºåŠ é€Ÿ fd åˆ†é…ï¼ˆå¿«é€Ÿåˆ¤æ–­å“ªäº› fd å·²ç”¨/ç©ºé—²ï¼‰ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> * <span class="title">fd_array</span>[<span class="title">NR_OPEN_DEFAULT</span>];</span> <span class="comment">//æ–‡ä»¶æŒ‡é’ˆæ•°ç»„ï¼ˆåˆå§‹å†…åµŒéƒ¨åˆ†ï¼‰ã€‚å­˜æ”¾é»˜è®¤æ•°é‡çš„ struct file * æŒ‡é’ˆï¼ˆä¾‹å¦‚å‰ 32 ä¸ª fdï¼‰ã€‚è¶…è¿‡æ—¶ä¼šåˆ‡æ¢åˆ°åŠ¨æ€åˆ†é…çš„ fdtableã€‚</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å…·ä½“å¦‚å›¾æ‰€ç¤º</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/20251003130434537.png" alt="image-20251003130430704"></p>
<h2 id="struct-fdtableç»“æ„ä½“"><a href="#struct-fdtableç»“æ„ä½“" class="headerlink" title="struct fdtableç»“æ„ä½“"></a>struct fdtableç»“æ„ä½“</h2><p>ä¸Šé¢files_structç»“æ„ä½“ä¸­æœ‰ä¸€ä¸ªå…³é”®æ•°æ®ç»“æ„fdtable,å³æ–‡ä»¶æè¿°ç¬¦è¡¨ï¼Œå…¶åœ¨ç»“æ„ä½“å†…éƒ¨æœ‰ä¸€ä¸ªå†…åµŒçš„fdtableç»“æ„ä½“fdtabï¼ŒåŒæ—¶è¿˜æœ‰ä¸€ä¸ªæŒ‡é’ˆfdtæŒ‡å‘ä¸€ä¸ªfdtableç»“æ„ä½“ã€‚åˆå§‹åŒ–æ—¶å€™fdtæŒ‡é’ˆæ˜¯æŒ‡å‘å†…åµŒåœ¨ç»“æ„ä½“files_structä¸­çš„fdtabæˆå‘˜çš„ï¼Œå¹¶ä¸”è¯¥ç»“æ„ç”¨äº†RCUåŒæ­¥ä¿æŠ¤æœºåˆ¶ã€‚å…·ä½“ç»“æ„å®šä¹‰å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/fdtable.h</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> max_fds;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> __<span class="title">rcu</span> **<span class="title">fd</span>;</span>      <span class="comment">/* current fd array */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *close_on_exec;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *open_fds;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> *full_fds_bits;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rcu_head</span> <span class="title">rcu</span>;</span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">//ps è¿™é‡Œä»‹ç»ä¸€ä¸‹RCUåŒæ­¥æœºåˆ¶ï¼Œå› ä¸ºæœ‰äº›æŒ‡é’ˆä½¿ç”¨äº†__rcuæ ‡å¿—æ¥æ ‡è¯†ï¼Œå®é™…ä¸Šè¯¥æ ‡å¿—å‘Šè¯‰äº†é™æ€åˆ†æå·¥å…·å’Œç¼–è¯‘å™¨ï¼Œè¿™ä¸ªæŒ‡é’ˆè¯»å¾—å¤šï¼Œå†™å¾—å°‘ï¼Œä¸”è¯»çš„æ—¶å€™ä¸éœ€è¦åŠ é”ã€‚__rcu æ˜¯ä¸€ä¸ª sparse æ³¨è§£å®ï¼ˆé™æ€åˆ†æå·¥å…·ç”¨çš„æ ‡è®°ï¼Œä¸å½±å“ç¼–è¯‘å‡ºçš„ä»£ç ï¼‰ï¼Œå®ƒå‘Šè¯‰å†…æ ¸å¼€å‘è€…å’Œé™æ€åˆ†æå™¨ï¼š1. è¿™ä¸ªæŒ‡é’ˆåªèƒ½é€šè¿‡ RCU å®‰å…¨åœ°è¯»/å†™ã€‚2. è¯»å®ƒçš„æ—¶å€™è¦ç”¨ rcu_dereference()ï¼Œè€Œä¸æ˜¯ç›´æ¥è§£å¼•ç”¨ã€‚3. æ”¹å®ƒçš„æ—¶å€™è¦ç”¨ rcu_assign_pointer()ï¼Œè€Œä¸æ˜¯ç›´æ¥èµ‹å€¼ã€‚</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">è¯»å–è¯¥æŒ‡é’ˆï¼š</span></span><br><span class="line"><span class="comment">rcu_read_lock();</span></span><br><span class="line"><span class="comment">struct fdtable *fdt = rcu_dereference(files-&gt;fdt);</span></span><br><span class="line"><span class="comment">struct file *filp = rcu_dereference(fdt-&gt;fd[fd]);</span></span><br><span class="line"><span class="comment">if (filp)</span></span><br><span class="line"><span class="comment">    get_file(filp); // å¢åŠ å¼•ç”¨è®¡æ•°ï¼Œä¿è¯ä¸ä¼šè¢«é‡Šæ”¾</span></span><br><span class="line"><span class="comment">rcu_read_unlock();</span></span><br><span class="line"><span class="comment"></span></span><br><span class="line"><span class="comment">å†™å…¥è¯¥æŒ‡é’ˆï¼š</span></span><br><span class="line"><span class="comment">spin_lock(&amp;files-&gt;file_lock);</span></span><br><span class="line"><span class="comment">rcu_assign_pointer(fdt-&gt;fd[fd], new_filp);</span></span><br><span class="line"><span class="comment">spin_unlock(&amp;files-&gt;file_lock);</span></span><br><span class="line"><span class="comment">*/</span></span><br></pre></td></tr></table></figure>

<p>åŒæ—¶ç±»ä¼¼ï¼Œåˆå§‹æ—¶å†…åµŒæˆå‘˜fdtabä¸­<code>struct file __rcu **fd</code>å°±æŒ‡å‘files_structä¸­çš„fd_arrayæˆå‘˜ç­‰ï¼Œå…·ä½“çœ‹å›¾ï¼Œè¿™æ ·åšçš„å¥½å¤„æ˜¯ä¸ç”¨kmallocè¿™æ ·è€—æ—¶çš„æ“ä½œï¼Œå…ˆé¢„å…ˆåˆ†é…NR_OPEN_DEFAULTä¸ªã€‚</p>
<h2 id="struct-file-ç»“æ„ä½“"><a href="#struct-file-ç»“æ„ä½“" class="headerlink" title="struct file ç»“æ„ä½“"></a>struct file ç»“æ„ä½“</h2><p>æœ€åå°±æ˜¯å†…æ ¸è§†è§’çš„æ–‡ä»¶ç»“æ„ï¼Œå³fileç»“æ„ä½“ï¼Œåœ¨ç”¨æˆ·è§†è§’ä¸‹ä¸€ä¸ªæ–‡ä»¶å…¶å®å°±æ˜¯ä¸€ä¸ªintå€¼ï¼Œä¹Ÿå«æ–‡ä»¶æè¿°ç¬¦fdï¼Œä½†æ˜¯å¯¹åº”å†…æ ¸æ•°æ®ç»“æ„å…¶å®å°±æ˜¯fileç»“æ„ä½“æ•°ç»„çš„ä¸€ä¸ªä¸‹è¡¨ï¼ŒçœŸå®çš„fileç»“æ„ä½“å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * f_&#123;lock,count,pos_lock&#125; members can be highly contended and share</span></span><br><span class="line"><span class="comment"> * the same cacheline. f_&#123;lock,mode&#125; are very frequently used together</span></span><br><span class="line"><span class="comment"> * and so share the same cacheline as well. The read-mostly</span></span><br><span class="line"><span class="comment"> * f_&#123;path,inode,op&#125; are kept on a separate cacheline.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">union</span> &#123;</span></span><br><span class="line">		<span class="comment">/* fput() uses task work when closing and freeing file (default). */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">callback_head</span> 	<span class="title">f_task_work</span>;</span></span><br><span class="line">		<span class="comment">/* fput() must use workqueue (most kernel threads).åœ¨å†…æ ¸çº¿ç¨‹ä¸­ï¼Œä¸èƒ½ä½¿ç”¨ task workï¼Œæ‰€ä»¥æ”¹ç”¨ workqueue + lockless listã€‚ */</span></span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">llist_node</span>	<span class="title">f_llist</span>;</span></span><br><span class="line">		<span class="type">unsigned</span> <span class="type">int</span> 		f_iocb_flags; <span class="comment">//æœ‰æ—¶æ­¤å­—æ®µå­˜å‚¨å¼‚æ­¥ IO æ§åˆ¶å— (iocb) çš„æ ‡å¿—ã€‚</span></span><br><span class="line">	&#125;; <span class="comment">//è¿™å—è¡¨ç¤ºå…³é—­å’Œå›æ”¶æ–‡ä»¶æ—¶å€™ä½¿ç”¨çš„ä¸€ä¸ªunionã€‚</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Protects f_ep, f_flags.</span></span><br><span class="line"><span class="comment">	 * Must not be taken from IRQ context.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">spinlock_t</span>		f_lock <span class="comment">//ä¿æŠ¤ f_ep å’Œ f_flagsï¼Œé¿å…å¹¶å‘ä¿®æ”¹ã€‚</span></span><br><span class="line">	<span class="type">fmode_t</span>			f_mode; <span class="comment">//æ–‡ä»¶æ‰“å¼€æ¨¡å¼ï¼ˆè¯»/å†™/è¿½åŠ ç­‰ï¼‰ï¼Œå¯¹åº”ç”¨æˆ·ç©ºé—´çš„ O_RDONLY/O_WRONLY/O_RDWRã€‚</span></span><br><span class="line">	<span class="type">atomic_long_t</span>		f_count; <span class="comment">//æ–‡ä»¶å¯¹è±¡çš„å¼•ç”¨è®¡æ•°,æ¯ä¸ª dup()ã€fork(CLONE_FILES) éƒ½ä¼šå¢åŠ è®¡æ•°ï¼Œclose() æ—¶å‡å°‘ã€‚ä¸º 0 æ—¶é‡Šæ”¾ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">mutex</span>		<span class="title">f_pos_lock</span>;</span> <span class="comment">//ä¿æŠ¤f_posçš„é”</span></span><br><span class="line">	<span class="type">loff_t</span>			f_pos; <span class="comment">//æ–‡ä»¶çš„å½“å‰åç§»é‡ï¼ˆç›¸å½“äºç”¨æˆ·ç©ºé—´çš„ file pointerï¼‰ã€‚ä¸åŒè¿›ç¨‹å¦‚æœç‹¬ç«‹ open åŒä¸€ä¸ª inodeï¼Œä¼šæœ‰ä¸åŒçš„ f_posã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span>		f_flags; <span class="comment">//æ–‡ä»¶æ‰“å¼€æ—¶å€™çš„flag</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fown_struct</span>	<span class="title">f_owner</span>;</span> <span class="comment">//è®°å½•ä¿¡å·æ‰€æœ‰è€…ï¼ˆF_SETOWN/F_SETFL ç”¨äºå¼‚æ­¥ IO/ä¿¡å·ï¼‰ã€‚</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">cred</span>	*<span class="title">f_cred</span>;</span> <span class="comment">//æ‰“å¼€æ–‡ä»¶æ—¶çš„å‡­æ®ï¼ˆUID/GID/capabilitiesï¼‰ã€‚å³ä½¿è¿›ç¨‹ä¹‹åææƒ/é™æƒï¼Œè¿™é‡Œä»ä¿æŒå½“æ—¶çš„ credã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file_ra_state</span>	<span class="title">f_ra</span>;</span> <span class="comment">//readahead çŠ¶æ€ï¼ˆé¢„è¯»ä¼˜åŒ–ï¼‰ï¼Œå†…æ ¸è¯»æ–‡ä»¶æ—¶å¯èƒ½ä¼šæå‰åŠ è½½åç»­é¡µã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">path</span>		<span class="title">f_path</span>;</span> <span class="comment">//è®°å½•è¯¥æ–‡ä»¶æ‰€åœ¨çš„ vfsmount + dentryï¼ˆå³è·¯å¾„ä½ç½®ï¼‰ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">inode</span>		*<span class="title">f_inode</span>;</span>	<span class="comment">/* cached value, ç¼“å­˜çš„ inode æŒ‡é’ˆï¼ŒåŠ å¿«è®¿é—®é€Ÿåº¦ã€‚ */</span></span><br><span class="line">	<span class="type">const</span> <span class="class"><span class="keyword">struct</span> <span class="title">file_operations</span>	*<span class="title">f_op</span>;</span> <span class="comment">//æ–‡ä»¶æ“ä½œå‡½æ•°è¡¨ï¼ˆopen/read/write/mmap/ioctl ç­‰ï¼‰ã€‚</span></span><br><span class="line"></span><br><span class="line">	u64			f_version; <span class="comment">//æ–‡ä»¶ç‰ˆæœ¬å·ï¼Œç”¨äºæ”¯æŒ NFS ç­‰ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿçš„ cache consistencyã€‚</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SECURITY</span></span><br><span class="line">	<span class="type">void</span>			*f_security;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	<span class="comment">/* needed for tty driver, and maybe others */</span></span><br><span class="line">	<span class="type">void</span>			*private_data;</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_EPOLL</span></span><br><span class="line">	<span class="comment">/* Used by fs/eventpoll.c to link all the hooks to this file, epoll ç”¨æ¥è·Ÿè¸ªå“ªäº› epoll_fd æ­£åœ¨ç›‘å¬æ­¤æ–‡ä»¶ã€‚ */</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">hlist_head</span>	*<span class="title">f_ep</span>;</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* #ifdef CONFIG_EPOLL */</span></span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">address_space</span>	*<span class="title">f_mapping</span>;</span> <span class="comment">//æ–‡ä»¶çš„é¡µç¼“å­˜æ˜ å°„ï¼Œç”¨äºè¯»å†™é¡µç¼“å­˜ã€mmap ç­‰ã€‚é€šå¸¸æŒ‡å‘ inode-&gt;i_mappingï¼Œä½†ç‰¹æ®Šæ–‡ä»¶ï¼ˆå¦‚ pipesã€socketsï¼‰å¯èƒ½ä¸åŒã€‚</span></span><br><span class="line">	<span class="type">errseq_t</span>		f_wb_err;</span><br><span class="line">	<span class="type">errseq_t</span>		f_sb_err; <span class="comment">/* for syncfs */</span></span><br><span class="line">&#125; __randomize_layout</span><br><span class="line">  __attribute__((aligned(<span class="number">4</span>)));	<span class="comment">/* lest something weird decides that 2 is OK */</span></span><br></pre></td></tr></table></figure>

<p>OKäº†ï¼Œæˆ‘ä»¬ç°åœ¨å¤§æ¦‚çŸ¥é“ä¸€ä¸ªæ–‡ä»¶åœ¨ç”¨æˆ·è§†è§’å’Œåœ¨å†…æ ¸è§†è§’çš„åŒºåˆ«ä¸è”ç³»äº†ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±å¯ä»¥çœ‹VFSçš„å®ç°äº†ã€‚é¦–å…ˆç”¨æˆ·è¿›ç¨‹è¦æ“ä½œæ–‡ä»¶ï¼Œé¦–å…ˆéœ€è¦ä½¿ç”¨openå‡½æ•°å¯¹å…¶æ‰“å¼€ï¼Œç„¶åé€šè¿‡readå’Œwriteå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚ï¼ˆè¿™é‡Œçš„read, writeéƒ½æ˜¯åº“å‡½æ•°ï¼Œä¹Ÿå¯ä»¥ç›´æ¥è°ƒç”¨ç³»ç»Ÿè°ƒç”¨è¿›è¡Œå¤„ç†ï¼‰</p>
<h1 id="VFSè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"><a href="#VFSè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ" class="headerlink" title="VFSè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ"></a>VFSè™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿ</h1><p>VFSå…¶å®ä½œç”¨å…¶å®å°±æ˜¯éšè—äº†åº•å±‚ä¸åŒæ–‡ä»¶ç³»ç»Ÿçš„å·®å¼‚ï¼Œå‘ä¸Šæä¾›ç»Ÿä¸€çš„æ•°æ®ç»“æ„å’Œæ¥å£ã€‚å°±æ¯”å¦‚ç”¨æˆ·æ‰§è¡Œcpå‘½ä»¤ï¼ŒæŠŠUç›˜çš„æ–‡ä»¶æ‹·è´åˆ°æœ¬åœ°ï¼Œå…¶æ— éœ€è€ƒè™‘Uç›˜çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼å’Œæ“ä½œå‡½æ•°ï¼Œä¹Ÿæ— éœ€è€ƒè™‘æœ¬åœ°æ ¹ç›®å½•æˆ–è€…å®‰è£…çš„ç¡¬ç›˜çš„æ–‡ä»¶ç³»ç»Ÿæ ¼å¼å’Œæ“ä½œå‡½æ•°ï¼Œè€Œæ˜¯ç»Ÿä¸€åœ°ç”¨writeï¼Œreadè¿™æ ·çš„æ“ä½œæ¥å®ç°ï¼Œæå¤§åœ°æ–¹ä¾¿äº†ç”¨æˆ·ã€‚</p>
<p>VFSå®ç°ä¸»è¦æŠ½è±¡å‡ºäº†å››å¤§ç»„ä»¶å¯¹è±¡ï¼ŒåŒ…æ‹¬æ–‡ä»¶ï¼ˆfileï¼‰,ç›®å½•ï¼ˆdentryï¼‰,ç´¢å¼•ç»“ç‚¹ï¼ˆinodeï¼‰ï¼Œè¶…çº§å—ï¼ˆsuper blockï¼‰ã€‚</p>
<ul>
<li>æ–‡ä»¶ï¼šstruct fileï¼Œå­˜æ”¾è¿›ç¨‹å·²ç»æ‰“å¼€çš„æ–‡ä»¶ä¿¡æ¯å’Œå¯¹å…¶è¿›è¡Œæ“ä½œçš„å‡½æ•°ï¼Œç±»ä¼¼æˆ·å£ï¼Œå¹¶ä¸èƒ½ç›´æ¥çœ‹åˆ°æ–‡ä»¶æ•°æ®ã€‚<ul>
<li>è¡¨ç¤ºä¸€ä¸ª<strong>æ‰“å¼€çš„æ–‡ä»¶å®ä¾‹</strong>ï¼ŒåŒ…å«åç§»é‡ (<code>f_pos</code>)ã€æ‰“å¼€æ ‡å¿— (<code>f_flags</code>)ã€æ‰€å±è¿›ç¨‹çš„ cred ç­‰ã€‚</li>
<li>æ¯æ¬¡ <code>open()</code>ï¼ˆæˆ– <code>dup()</code>ï¼‰éƒ½ä¼šäº§ç”Ÿ&#x2F;å¼•ç”¨ä¸€ä¸ªæ–°çš„ <code>struct file</code>ã€‚</li>
<li>å³ä½¿ä¸¤ä¸ª file æŒ‡é’ˆæŒ‡å‘åŒä¸€ä¸ª dentryï¼Œå®ƒä»¬çš„åç§»é‡ã€flags å¯ä»¥ä¸åŒã€‚</li>
</ul>
</li>
<li>ç›®å½•é¡¹ï¼šå­˜åœ¨æ–‡ä»¶çš„ç‰¹å®šè¯†åˆ«åå’Œå…³è”ä¿¡æ¯ã€‚ç”¨æ¥è®°å½•æ–‡ä»¶çš„åå­—ã€ç´¢å¼•èŠ‚ç‚¹æŒ‡é’ˆä»¥åŠä¸å…¶ä»–ç›®å½•é¡¹çš„å±‚çº§å…³è”å…³ç³»ã€‚ å¤šä¸ªç›®å½•é¡¹å…³è”èµ·æ¥ï¼Œå°±ä¼šå½¢æˆç›®å½•ç»“æ„ï¼Œä½†å®ƒä¸ç´¢å¼•èŠ‚ç‚¹ä¸åŒçš„æ˜¯ï¼Œç›®å½•é¡¹æ˜¯ç”±å†…æ ¸ç»´æŠ¤çš„ä¸€ä¸ªæ•°æ®ç»“æ„ï¼Œä¸å­˜æ”¾äºç£ç›˜ï¼Œè€Œæ˜¯ç¼“å­˜åœ¨å†…å­˜ã€‚<strong>ç®€å•æ¥è¯´è¯´ç›®å½•é¡¹çºªå½•äº†å·²è®¿é—®è¿‡çš„æ–‡ä»¶å’Œç›®å½•çš„å†…å­˜å½±åƒï¼Œæ˜¯æ•´ä¸ªæ–‡ä»¶ç³»ç»Ÿæ ‘ç»“æ„çš„ä¸€ä¸ªå­é›†</strong>ã€‚<ul>
<li>è¡¨ç¤ºä¸€ä¸ªç›®å½•é¡¹ï¼ˆåå­—å’Œ inode çš„æ˜ å°„å…³ç³»ï¼‰ã€‚</li>
<li>åŒä¸€ä¸ªæ–‡ä»¶è·¯å¾„å¯¹åº”ä¸€ä¸ªå”¯ä¸€çš„ dentryï¼ˆdcache ç¼“å­˜ï¼‰ã€‚</li>
<li>å¤šä¸ª dentry å¯ä»¥æŒ‡å‘åŒä¸€ä¸ª inodeï¼ˆç¡¬é“¾æ¥ï¼‰ã€‚</li>
</ul>
</li>
<li>ç´¢å¼•ç»“ç‚¹ï¼šæ¯ä¸ªç´¢å¼•ç»“ç‚¹çš„ç¼–å·å¯ä»¥å”¯ä¸€åœ°æ ‡è¯†æœ¬æ–‡ä»¶ç³»ç»Ÿä¸­çš„æ–‡ä»¶ï¼Œä¸åŒæ–‡ä»¶ç³»ç»Ÿä¸Šå¯ä»¥æœ‰ç›¸åŒçš„ç´¢å¼•å·ã€‚å®ƒçºªå½•äº†æ–‡ä»¶çš„åå­—ã€ç´¢å¼•èŠ‚ç‚¹æŒ‡é’ˆä»¥åŠä¸å…¶ä»–ç›®å½•é¡¹çš„å±‚çº§å…³è”å…³ç³»ã€‚ å¤šä¸ªç›®å½•é¡¹å…³è”èµ·æ¥ï¼Œå°±ä¼šå½¢æˆç›®å½•ç»“æ„ï¼Œå› ä¸ºç›®å½•ä¹Ÿæ˜¯ä¸€ä¸ªç‰¹æ®Šçš„æ–‡ä»¶ã€‚ä¸”ç´¢å¼•èŠ‚ç‚¹å…¶æ˜¯ç£ç›˜ä¸Šç´¢å¼•èŠ‚ç‚¹çš„å†…å­˜å½±åƒå’Œæ‹“å±•ã€‚<ul>
<li>è¡¨ç¤ºä¸€ä¸ªæ–‡ä»¶ç³»ç»Ÿå¯¹è±¡ï¼ˆæ–‡ä»¶&#x2F;ç›®å½•&#x2F;è®¾å¤‡èŠ‚ç‚¹ï¼‰çš„å…ƒæ•°æ®ï¼ˆæƒé™ã€å¤§å°ã€æ—¶é—´æˆ³ç­‰ï¼‰ã€‚</li>
<li>åœ¨å†…å­˜ä¸­æ˜¯å”¯ä¸€çš„ï¼šä¸€ä¸ª inode number åœ¨ä¸€ä¸ªè¶…çº§å—é‡Œåªæœ‰ä¸€ä¸ª <code>struct inode</code>ã€‚</li>
</ul>
</li>
<li>è¶…çº§å—ï¼šå­˜æ”¾å®‰è£…å’ŒæŒ‚è½½çš„æ–‡ä»¶ç³»ç»ŸåŸºæœ¬ä¿¡æ¯ã€‚è¶…çº§å—æ˜¯ç£ç›˜ä¸Šè¶…çº§å—çš„å†…å­˜å½±åƒå’Œæ‹“å±•ã€‚</li>
</ul>
<p>å…·ä½“å…³ç³»å¦‚å›¾æ‰€ç¤ºï¼Œå¹¶ä¸”éƒ½æ˜¯å¤šå¯¹ä¸€çš„å…³ç³»ï¼Œå³å¤šä¸ªæ–‡ä»¶æè¿°ç¬¦å¯ä»¥æŒ‡å‘ç›¸åŒçš„æ–‡ä»¶å¯¹è±¡ï¼ˆä¸åŒè¿›ç¨‹æ‰“å¼€ç›¸åŒçš„æ–‡ä»¶ï¼‰ï¼Œå¤šä¸ªæ–‡ä»¶å¯¹è±¡å¯ä»¥æŒ‡å‘ç›¸åŒçš„ç›®å½•é¡¹ï¼ˆæ¯”å¦‚åŒä¸€ä¸ªæ–‡ä»¶è¢«æ‰“å¼€å¤šæ¬¡ï¼Œä¼šäº§ç”Ÿå¤šä¸ªstruct fileï¼ˆfdï¼‰, ä½†æ˜¯dentryç›¸åŒï¼‰å’ŒinodeèŠ‚ç‚¹ï¼Œå¤šä¸ªç›®å½•é¡¹å¯ä»¥æŒ‡å‘ç›¸åŒçš„ç´¢å¼•èŠ‚ç‚¹ï¼ˆç¡¬é“¾æ¥ï¼‰ï¼š</p>
<blockquote>
<p>PS: è¿™é‡Œé¡ºä¾¿è¯´ä¸€ä¸‹è½¯é“¾æ¥ï¼Œè½¯é“¾æ¥æ˜¯ä¸€ä¸ªå•ç‹¬çš„æ–‡ä»¶ï¼Œé‡Œé¢å­˜æ”¾è·¯å¾„å­—ç¬¦ä¸²ã€‚è½¯é“¾æ¥æ–‡ä»¶æœ‰è‡ªå·±çš„ inodeï¼ˆç±»å‹ <code>S_IFLNK</code>ï¼‰ï¼Œå­˜æ”¾ç›®æ ‡è·¯å¾„ã€‚è½¯é“¾æ¥æœ‰ç‹¬ç«‹çš„ dentryï¼Œ<code>dentry-&gt;d_inode</code> æŒ‡å‘è½¯é“¾æ¥è‡ªå·±çš„ inodeã€‚<code>open(&quot;symlink&quot;)</code> é€šå¸¸è§¦å‘è·¯å¾„è§£æï¼ŒVFS è°ƒç”¨ <code>-&gt;follow_link</code>ï¼ˆæ—§ APIï¼Œå†…æ ¸æ–°ç‰ˆæœ¬æ”¹ä¸º <code>-&gt;get_link</code>ï¼‰ï¼Œè§£æç›®æ ‡è·¯å¾„ï¼Œå†è¿”å›ç›®æ ‡æ–‡ä»¶çš„ dentry&#x2F;inodeã€‚</p>
</blockquote>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/20251003135609606.png" alt="image-20251003135608114"></p>
<p>å¯¹äºæŸ¥æ‰¾ä¸€ä¸ªæ–‡ä»¶ï¼Œæˆ‘ä»¬ä»¥ä¸‹å›¾ä½œä¸ºä¾‹å­ï¼Œå‡è®¾éœ€è¦æ‰¾<code>/home/lqm/file1</code>,å…ˆåœ¨ç£ç›˜ä¸Šæ‰¾åˆ°<code>/</code>æ ¹ç›®å½•å¯¹åº”çš„ç´¢å¼•èŠ‚ç‚¹å’Œå†…å®¹ï¼Œå–åˆ°å†…å­˜æ„é€ dentryï¼Œå’Œinodeçš„å†…å­˜æ˜ åƒï¼Œç„¶åæ‰¾åˆ°ä¸‹ä¸€çº§ç›®å½•l2çš„ç´¢å¼•èŠ‚ç‚¹ï¼Œè¿™æ ·ä¾æ¬¡ç±»æ¨ã€‚</p>
<ul>
<li><strong>èµ·ç‚¹</strong>ï¼šå†…æ ¸é€šè¿‡è¿›ç¨‹çš„ <code>fs_struct</code> çŸ¥é“å½“å‰æ ¹ç›®å½•ï¼ˆå¯èƒ½æ˜¯ <code>/</code>ï¼Œä¹Ÿå¯èƒ½æ˜¯ chroot&#x2F;jail çš„æŸä¸ªå­ç›®å½•ï¼‰å’Œå½“å‰å·¥ä½œç›®å½• <code>pwd</code>ã€‚<br> å¯¹äºç»å¯¹è·¯å¾„ <code>/home/lqm/file1</code>ï¼ŒæŸ¥æ‰¾ä»æ ¹ç›®å½• inode å¼€å§‹ã€‚</li>
<li><strong>ç¬¬ä¸€çº§ <code>/</code></strong>ï¼š<ul>
<li>æ‰¾åˆ°æ ¹ç›®å½• inodeï¼ˆå‡è®¾ç¼–å· <code>0</code> æˆ– <code>1</code>ï¼‰ï¼ŒæŠŠå®ƒè¯»å…¥å†…å­˜å½¢æˆ <code>struct inode</code>ã€‚</li>
<li>å†…æ ¸ä¸º <code>/</code> ç›®å½•é¡¹å»ºç«‹ä¸€ä¸ª <code>struct dentry</code>ï¼Œå¹¶ä¸ inode å…³è”ã€‚</li>
<li>è¯»å‡ºrootçš„ç›®å½•é¡µï¼Œåˆ°page_cache, ç„¶åç”¨look_upæŸ¥çœ‹å¯¹åº”ä¸‹ä¸€çº§æ˜¯å¦å­˜åœ¨</li>
</ul>
</li>
<li><strong>ç¬¬äºŒçº§ <code>home</code></strong>ï¼š<ul>
<li>åœ¨æ ¹ç›®å½•æ•°æ®å—ä¸­æ‰¾åˆ° <code>home</code> è¿™ä¸ªç›®å½•é¡¹ï¼ˆdentry åå­— -&gt; inode å·ï¼‰ã€‚</li>
<li>è¯»å‡º <code>home</code> çš„ inodeï¼Œå»ºç«‹ <code>dentry(&quot;home&quot;)</code>ï¼ŒæŒ‚åˆ° <code>/</code> çš„ dentry æ ‘ä¸‹ã€‚</li>
</ul>
</li>
<li><strong>ç¬¬ä¸‰çº§ <code>lqm</code></strong>ï¼šåŒæ ·ï¼Œæ‰¾åˆ° inode <code>X3</code>ï¼Œå»ºç«‹ <code>dentry(&quot;lqm&quot;)</code>ã€‚</li>
<li><strong>ç¬¬å››çº§ <code>file1</code></strong>ï¼š<ul>
<li>åœ¨ <code>lqm</code> ç›®å½•æ•°æ®é‡Œæ‰¾åˆ° <code>file1</code> â†’ inode <code>Y4</code>ã€‚</li>
<li>è¯»å‡º <code>Y4</code> çš„ inodeï¼Œå»ºç«‹ <code>dentry(&quot;file1&quot;)</code>ã€‚</li>
</ul>
</li>
</ul>
<p>æ­¤æ—¶è·¯å¾„è§£æå®Œæˆï¼Œ<code>dentry(&quot;file1&quot;)</code> + <code>inode(Y4)</code> å·²ç»åœ¨å†…æ ¸å†…å­˜é‡Œã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/20251003141120967.png" alt="image-20251003141119081"></p>
<h1 id="æ‰“å¼€æ–‡ä»¶çš„æºç è§£æ"><a href="#æ‰“å¼€æ–‡ä»¶çš„æºç è§£æ" class="headerlink" title="æ‰“å¼€æ–‡ä»¶çš„æºç è§£æ"></a>æ‰“å¼€æ–‡ä»¶çš„æºç è§£æ</h1><p>çœ‹äº†é‚£ä¹ˆå¤šç†è®ºï¼Œshow me the codeï¼Œæˆ‘ä»¬å°±çœ‹çœ‹è¿›ç¨‹è°ƒç”¨openä¹‹åï¼Œåˆ›å»ºfile_structç­‰è¿‡ç¨‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//include/linux/syscalls.h</span></span><br><span class="line"><span class="comment">//é¦–å…ˆsyscallè¡¨å¤„ç†å‡½æ•°è·³è½¬åˆ°sys_openï¼Œå…·ä½“çœ‹æ–‡ä»¶arch/x86/entry/syscalls/syscall_64.tblä¸­</span></span><br><span class="line"><span class="comment">//2	 common	 open			sys_open</span></span><br><span class="line">    </span><br><span class="line"><span class="comment">// ç„¶åsys_open è°ƒç”¨ä¸€ä¸ªå®åµŒå¥—</span></span><br><span class="line"></span><br><span class="line">SYSCALL_DEFINE3(open, <span class="type">const</span> <span class="type">char</span> __user *, filename, <span class="type">int</span>, flags, <span class="type">umode_t</span>, mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">		flags |= O_LARGEFILE;</span><br><span class="line">	<span class="keyword">return</span> do_sys_open(AT_FDCWD, filename, flags, mode);</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">//SYSCALL_DEFINEx(3, open, const char __user *, filename, int, flags, umode_t, mode)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSCALL_DEFINE3(name, ...) SYSCALL_DEFINEx(3, _##name, __VA_ARGS__)</span></span><br><span class="line"><span class="comment">//__SYSCALL_DEFINEx(3, _open, const char __user *, filename, int, flags, umode_t, mode)</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSCALL_DEFINEx(x, sname, ...)				\</span></span><br><span class="line"><span class="meta">	SYSCALL_METADATA(sname, x, __VA_ARGS__)			\ <span class="comment">//è¿™ä¸ªå®å®šä¹‰æ˜¯ç©ºï¼Œç›´æ¥çœ‹ä¸‹é¢è¿™ä¸€è¡Œ</span></span></span><br><span class="line">	__SYSCALL_DEFINEx(x, sname, __VA_ARGS__)</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="comment">/*ç”Ÿæˆä¸€ä¸ªåˆ«åå‡½æ•°asmlinkage long sys_open(const char __user * filename, int flags, umode_t mode)</span></span><br><span class="line"><span class="comment">    __attribute__((alias(&quot;__se_sys_open&quot;))); </span></span><br><span class="line"><span class="comment">å£°æ˜ä¸€ä¸ªå‡½æ•°static inline long __do_sys_open(const char __user * filename, int flags, umode_t mode);</span></span><br><span class="line"><span class="comment">å£°æ˜ä¸€ä¸ªå‡½æ•°å¹¶å®ç°</span></span><br><span class="line"><span class="comment">	asmlinkage long __se_sys_open(const char __user * filename, int flags, umode_t mode);	\</span></span><br><span class="line"><span class="comment">	asmlinkage long __se_sys_open(const char __user * filename, int flags, umode_t mode)	\</span></span><br><span class="line"><span class="comment">	&#123;								\</span></span><br><span class="line"><span class="comment">		long ret = __do_sys_open(const char __user * filename, int flags, umode_t mode);\</span></span><br><span class="line"><span class="comment">		åšä¸€äº›å‚æ•°æ£€æŸ¥</span></span><br><span class="line"><span class="comment">		return ret;						\</span></span><br><span class="line"><span class="comment">	&#125;			</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> __SYSCALL_DEFINEx(x, name, ...)					\</span></span><br><span class="line"><span class="meta">	__diag_push();							\</span></span><br><span class="line"><span class="meta">	__diag_ignore(GCC, 8, <span class="string">&quot;-Wattribute-alias&quot;</span>,			\</span></span><br><span class="line"><span class="meta">		      <span class="string">&quot;Type aliasing is used to sanitize syscall arguments&quot;</span>);\</span></span><br><span class="line"><span class="meta">	asmlinkage long sys##name(__MAP(x,__SC_DECL,__VA_ARGS__))	\</span></span><br><span class="line"><span class="meta">		__attribute__((alias(__stringify(__se_sys##name))));	\</span></span><br><span class="line"><span class="meta">	ALLOW_ERROR_INJECTION(sys##name, ERRNO);			\</span></span><br><span class="line"><span class="meta">	static inline long __do_sys##name(__MAP(x,__SC_DECL,__VA_ARGS__));\</span></span><br><span class="line"><span class="meta">	asmlinkage long __se_sys##name(__MAP(x,__SC_LONG,__VA_ARGS__));	\</span></span><br><span class="line"><span class="meta">	asmlinkage long __se_sys##name(__MAP(x,__SC_LONG,__VA_ARGS__))	\</span></span><br><span class="line"><span class="meta">	&#123;								\</span></span><br><span class="line"><span class="meta">		long ret = __do_sys##name(__MAP(x,__SC_CAST,__VA_ARGS__));\</span></span><br><span class="line"><span class="meta">		__MAP(x,__SC_TEST,__VA_ARGS__);				\</span></span><br><span class="line"><span class="meta">		__PROTECT(x, ret,__MAP(x,__SC_ARGS,__VA_ARGS__));	\</span></span><br><span class="line"><span class="meta">		return ret;						\</span></span><br><span class="line"><span class="meta">	&#125;								\</span></span><br><span class="line"><span class="meta">	__diag_pop();							\</span></span><br><span class="line"><span class="meta">	static inline long __do_sys##name(__MAP(x,__SC_DECL,__VA_ARGS__))</span></span><br><span class="line"><span class="meta">#<span class="keyword">endif</span> <span class="comment">/* __SYSCALL_DEFINEx */</span></span></span><br><span class="line">        </span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">æœ€åè·‘åˆ°äº†static inline long __do_sys##name(__MAP(x,__SC_DECL,__VA_ARGS__))ï¼Œå†åŠ ä¸Šæœ€å¼€å§‹çš„å£°æ˜éƒ¨åˆ†ï¼Œå®é™…__do_sys_openå‡½æ•°å†…å®¹å°±æ˜¯å¦‚ä¸‹ï¼š</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">long</span> __do_sys_open(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename,</span><br><span class="line">                                 <span class="type">int</span> flags, <span class="type">umode_t</span> mode)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">if</span> (force_o_largefile())</span><br><span class="line">		flags |= O_LARGEFILE;</span><br><span class="line">	<span class="keyword">return</span> do_sys_open(AT_FDCWD, filename, flags, mode);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç»è¿‡ä¸Šé¢åˆ†æè¿™äº›å®ï¼Œå…¶å®æœ€ç»ˆæ˜¯åˆ°do_sys_openå‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹çœ‹è¿™ä¸ªå‡½æ•°</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// fs/open.c</span></span><br><span class="line"><span class="comment">//dfdï¼šç›®å½•æ–‡ä»¶æè¿°ç¬¦ï¼ˆé€šå¸¸æ˜¯ AT_FDCWD è¡¨ç¤ºå½“å‰ç›®å½•ï¼‰ã€‚</span></span><br><span class="line"><span class="type">long</span> <span class="title function_">do_sys_open</span><span class="params">(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename, <span class="type">int</span> flags, <span class="type">umode_t</span> mode)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">open_how</span> <span class="title">how</span> =</span> build_open_how(flags, mode); <span class="comment">//æŠŠè€å¼ flags + mode å‚æ•°è½¬æ¢æˆç»Ÿä¸€çš„ struct open_howï¼Œä¸º openat2 æ¥å£æœåŠ¡ã€‚</span></span><br><span class="line">	<span class="keyword">return</span> do_sys_openat2(dfd, filename, &amp;how);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">long</span> <span class="title function_">do_sys_openat2</span><span class="params">(<span class="type">int</span> dfd, <span class="type">const</span> <span class="type">char</span> __user *filename,</span></span><br><span class="line"><span class="params">			   <span class="keyword">struct</span> open_how *how)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">open_flags</span> <span class="title">op</span>;</span></span><br><span class="line">	<span class="type">int</span> fd = build_open_flags(how, &amp;op); <span class="comment">//è§£æç”¨æˆ·ä¼ è¿›æ¥çš„ flagsï¼ˆå¦‚ O_CREAT, O_TRUNC, O_APPENDï¼‰ï¼Œå¡«å……æˆ open_flags ç»“æ„ã€‚æˆåŠŸä¼šreturn 0. ä¸ç„¶è¿”å›-EINVAL; è¿™ä¸ªfdå‘½åä¹Ÿå¿’ã€‚ã€‚ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">filename</span> *<span class="title">tmp</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd)</span><br><span class="line">		<span class="keyword">return</span> fd;</span><br><span class="line"></span><br><span class="line">	tmp = getname(filename); <span class="comment">//ä»ç”¨æˆ·ç©ºé—´æ‹·è´æ–‡ä»¶ååˆ°å†…æ ¸ç©ºé—´ï¼Œå¾—åˆ°ä¸€ä¸ª struct filename å¯¹è±¡ã€‚ç”¨æˆ·æ€æŒ‡é’ˆ const char __user *filename â†’ å†…æ ¸å®‰å…¨çš„ filenameã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (IS_ERR(tmp))</span><br><span class="line">		<span class="keyword">return</span> PTR_ERR(tmp);</span><br><span class="line"></span><br><span class="line">	fd = get_unused_fd_flags(how-&gt;flags); <span class="comment">//ä»å½“å‰è¿›ç¨‹çš„ fd è¡¨é‡Œæ‰¾ä¸€ä¸ªç©ºé—²çš„ fd slotã€‚</span></span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= <span class="number">0</span>) &#123;</span><br><span class="line">		<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span> =</span> do_filp_open(dfd, tmp, &amp;op);</span><br><span class="line">		<span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">			put_unused_fd(fd);</span><br><span class="line">			fd = PTR_ERR(f);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fd_install(fd, f);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">	putname(tmp);</span><br><span class="line">	<span class="keyword">return</span> fd;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…ˆå…³æ³¨å¦‚ä½•è·å–ç©ºé—²fdçš„ï¼Œå³<code>get_unused_fd_flags(how-&gt;flags)</code>ï¼Œå°±æ˜¯å‰é¢è¯´çš„åˆ©ç”¨file_structç»“æ„ä½“ä¸­çš„å­—æ®µæ¥è·å–åˆ°ä¸€ä¸ªç©ºé—²çš„fdçš„ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">get_unused_fd_flags</span><span class="params">(<span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> __get_unused_fd_flags(flags, rlimit(RLIMIT_NOFILE));</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(get_unused_fd_flags);</span><br><span class="line"></span><br><span class="line"><span class="type">int</span> __get_unused_fd_flags(<span class="type">unsigned</span> flags, <span class="type">unsigned</span> <span class="type">long</span> nofile)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> alloc_fd(<span class="number">0</span>, nofile, flags);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">alloc_fd</span><span class="params">(<span class="type">unsigned</span> start, <span class="type">unsigned</span> end, <span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">files_struct</span> *<span class="title">files</span> =</span> current-&gt;files; <span class="comment">//è·å–åˆ°å½“å‰task_structä¸­çš„files_structï¼Œå³æ‰€æœ‰æ‰“å¼€çš„filesç›¸å…³å†…å®¹ï¼Œé‡Œé¢æœ‰fdtableè¡¨ã€‚</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> fd;</span><br><span class="line">	<span class="type">int</span> error;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">fdtable</span> *<span class="title">fdt</span>;</span></span><br><span class="line"></span><br><span class="line">	spin_lock(&amp;files-&gt;file_lock); <span class="comment">//åŠ é”</span></span><br><span class="line">repeat:</span><br><span class="line">    <span class="comment">/*</span></span><br><span class="line"><span class="comment">    #define files_fdtable(files) \</span></span><br><span class="line"><span class="comment">	rcu_dereference_check_fdtable((files), (files)-&gt;fdt)</span></span><br><span class="line"><span class="comment">    */</span></span><br><span class="line">	fdt = files_fdtable(files); <span class="comment">//RCUè¯»é”ï¼Œè¯»fdtæŒ‡é’ˆ</span></span><br><span class="line">	fd = start; <span class="comment">//fdä»0å¼€å§‹</span></span><br><span class="line">	<span class="keyword">if</span> (fd &lt; files-&gt;next_fd)  <span class="comment">//ä»next_fdå¼€å§‹æœç´¢</span></span><br><span class="line">		fd = files-&gt;next_fd;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (fd &lt; fdt-&gt;max_fds)  <span class="comment">//å¦‚æœæ‰¾åˆ°å°±æ‰¾åˆ°äº†ï¼Œä¸ç„¶éœ€è¦æ‰©å±•fdtã€‚</span></span><br><span class="line">		fd = find_next_fd(fdt, fd);  <span class="comment">//æ ¹æ®ä½å›¾å¯»æ‰¾</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * N.B. For clone tasks sharing a files structure, this test</span></span><br><span class="line"><span class="comment">	 * will limit the total number of files that can be opened.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	error = -EMFILE;</span><br><span class="line">	<span class="keyword">if</span> (fd &gt;= end)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	error = expand_files(files, fd);</span><br><span class="line">	<span class="keyword">if</span> (error &lt; <span class="number">0</span>)</span><br><span class="line">		<span class="keyword">goto</span> out;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we needed to expand the fs array we</span></span><br><span class="line"><span class="comment">	 * might have blocked - try again.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (error)</span><br><span class="line">		<span class="keyword">goto</span> repeat;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (start &lt;= files-&gt;next_fd)</span><br><span class="line">		files-&gt;next_fd = fd + <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	__set_open_fd(fd, fdt);</span><br><span class="line">	<span class="keyword">if</span> (flags &amp; O_CLOEXEC)</span><br><span class="line">		__set_close_on_exec(fd, fdt);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		__clear_close_on_exec(fd, fdt);</span><br><span class="line">	error = fd;</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> 1</span></span><br><span class="line">	<span class="comment">/* Sanity check */</span></span><br><span class="line">	<span class="keyword">if</span> (rcu_access_pointer(fdt-&gt;fd[fd]) != <span class="literal">NULL</span>) &#123;</span><br><span class="line">		printk(KERN_WARNING <span class="string">&quot;alloc_fd: slot %d not NULL!\n&quot;</span>, fd);</span><br><span class="line">		rcu_assign_pointer(fdt-&gt;fd[fd], <span class="literal">NULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">out:</span><br><span class="line">	spin_unlock(&amp;files-&gt;file_lock);</span><br><span class="line">	<span class="keyword">return</span> error;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—åˆ°ç©ºé—²fdå·ä¹‹åï¼Œæ„å»ºå¯¹åº”çš„struct fileç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span> =</span> do_filp_open(dfd, tmp, &amp;op);</span><br><span class="line"><span class="keyword">if</span> (IS_ERR(f)) &#123;</span><br><span class="line">			put_unused_fd(fd); <span class="comment">//å¤±è´¥ï¼šé‡Šæ”¾åˆšåˆšé¢„ç•™çš„ fd slotã€‚</span></span><br><span class="line">			fd = PTR_ERR(f);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			fd_install(fd, f); <span class="comment">//æˆåŠŸåˆ™è°ƒç”¨ fd_install(fd, f)ï¼ŒæŠŠ struct file * å®‰è£…åˆ°å½“å‰è¿›ç¨‹çš„æ–‡ä»¶æè¿°ç¬¦è¡¨é‡Œã€‚</span></span><br><span class="line">		&#125;</span><br></pre></td></tr></table></figure>

<p>é‚£ä¹ˆå…³é”®å°±æ˜¯æ„å»ºfile structè¿™ä¸ªç»“æ„ä½“çš„å‡½æ•°do_filp_open, ç„¶åæ ¸å¿ƒå°±æ˜¯ä½¿ç”¨kmem_cache_zallocå»åˆ†é…ä¸€ä¸ªç»“æ„ä½“ï¼Œè¿™ä¸ªæ˜¯ä¸€ä¸ªslab cacheï¼Œå†åˆå§‹åŒ–ç›¸åº”å­—æ®µï¼Œæœ€åå°±è¿”å›äº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> file *<span class="title function_">do_filp_open</span><span class="params">(<span class="type">int</span> dfd, <span class="keyword">struct</span> filename *pathname,</span></span><br><span class="line"><span class="params">		<span class="type">const</span> <span class="keyword">struct</span> open_flags *op)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> <span class="title">nd</span>;</span></span><br><span class="line">	<span class="type">int</span> flags = op-&gt;lookup_flags;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">filp</span>;</span></span><br><span class="line"></span><br><span class="line">	set_nameidata(&amp;nd, dfd, pathname, <span class="literal">NULL</span>); <span class="comment">//å¡«å……nameidataæ•°æ®ç»“æ„</span></span><br><span class="line">	filp = path_openat(&amp;nd, op, flags | LOOKUP_RCU);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ECHILD)))</span><br><span class="line">		filp = path_openat(&amp;nd, op, flags);</span><br><span class="line">	<span class="keyword">if</span> (unlikely(filp == ERR_PTR(-ESTALE)))</span><br><span class="line">		filp = path_openat(&amp;nd, op, flags | LOOKUP_REVAL);</span><br><span class="line">	restore_nameidata();</span><br><span class="line">	<span class="keyword">return</span> filp;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __set_nameidata(<span class="keyword">struct</span> nameidata *p, <span class="type">int</span> dfd, <span class="keyword">struct</span> filename *name)</span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">nameidata</span> *<span class="title">old</span> =</span> current-&gt;nameidata;</span><br><span class="line">    p-&gt;<span class="built_in">stack</span> = p-&gt;internal;</span><br><span class="line">    p-&gt;depth = <span class="number">0</span>;</span><br><span class="line">    p-&gt;dfd = dfd;</span><br><span class="line">    p-&gt;name = name;</span><br><span class="line">    p-&gt;path.mnt = <span class="literal">NULL</span>;</span><br><span class="line">    p-&gt;path.dentry = <span class="literal">NULL</span>;</span><br><span class="line">    p-&gt;total_link_count = old ? old-&gt;total_link_count : <span class="number">0</span>;</span><br><span class="line">    p-&gt;saved = old;</span><br><span class="line">    current-&gt;nameidata = p;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">struct</span> file *<span class="title function_">path_openat</span><span class="params">(<span class="keyword">struct</span> nameidata *nd,</span></span><br><span class="line"><span class="params">                                <span class="type">const</span> <span class="keyword">struct</span> open_flags *op, <span class="type">unsigned</span> flags)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">file</span>;</span></span><br><span class="line">    <span class="type">int</span> error;</span><br><span class="line"></span><br><span class="line">    file = alloc_empty_file(op-&gt;open_flag, current_cred());</span><br><span class="line">    <span class="keyword">if</span> (IS_ERR(file))</span><br><span class="line">        <span class="keyword">return</span> file;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (unlikely(file-&gt;f_flags &amp; __O_TMPFILE)) &#123;</span><br><span class="line">        error = do_tmpfile(nd, flags, op, file); <span class="comment">//open(..., O_TMPFILE, ...)ï¼Œè¡¨ç¤ºåˆ›å»ºåŒ¿åä¸´æ—¶æ–‡ä»¶ï¼ˆä¸ä¼šå‡ºç°åœ¨ç›®å½•æ ‘ä¸­ï¼‰ã€‚äº¤ç»™ do_tmpfile å¤„ç†ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> <span class="keyword">if</span> (unlikely(file-&gt;f_flags &amp; O_PATH)) &#123;</span><br><span class="line">        error = do_o_path(nd, flags, file); <span class="comment">//open(..., O_PATH)ï¼Œè¡¨ç¤ºåªè·å–ä¸€ä¸ªè·¯å¾„å¥æŸ„ï¼Œä¸çœŸæ­£æ‰“å¼€æ–‡ä»¶ï¼ˆä¸èƒ½è¯»å†™ï¼‰ã€‚äº¤ç»™ do_o_path å¤„ç†ã€‚</span></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="type">const</span> <span class="type">char</span> *s = path_init(nd, flags); <span class="comment">//åˆå§‹åŒ–è·¯å¾„èµ·ç‚¹æ˜¯rootè¿˜æ˜¯pwdï¼Œè¿”å›ä¸‹ä¸€ä¸ªéœ€è¦è§£æçš„è·¯å¾„å­—ç¬¦ä¸²</span></span><br><span class="line">        <span class="keyword">while</span> (!(error = link_path_walk(s, nd)) &amp;&amp; <span class="comment">//é€çº§è§£æè·¯å¾„åˆ†é‡ï¼Œä¾‹å¦‚ /home/lqm/file1 å°±ä¼šä¾æ¬¡è§£æ home â†’ lqm â†’ file1ï¼Œåœ¨å†…å­˜ä¸­æ‰¾åˆ°ç›¸åº”çš„ dentry å’Œ inodeã€‚</span></span><br><span class="line">               (s = open_last_lookups(nd, file, op)) != <span class="literal">NULL</span>) <span class="comment">//å¤„ç†è·¯å¾„çš„æœ€åä¸€éƒ¨åˆ†ï¼ˆå¯èƒ½æ˜¯æ–‡ä»¶æœ¬èº«ï¼Œæˆ–è€…ç¬¦å·é“¾æ¥ï¼‰ã€‚</span></span><br><span class="line">            ;</span><br><span class="line">        <span class="keyword">if</span> (!error)</span><br><span class="line">            error = do_open(nd, file, op); <span class="comment">//æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨å°±åˆ›å»ºã€‚æ£€æŸ¥æƒé™ï¼Œæœ€åè°ƒç”¨æ–‡ä»¶ç³»ç»Ÿçš„openå‡½æ•°</span></span><br><span class="line">        terminate_walk(nd); <span class="comment">//ç»“æŸè·¯å¾„éå†ï¼Œé‡Šæ”¾ä¸´æ—¶èµ„æºï¼ˆæ¯”å¦‚ nameidata é‡Œä¿å­˜çš„è·¯å¾„æ ˆï¼‰ã€‚</span></span><br><span class="line">    &#125;</span><br><span class="line">    ...</span><br><span class="line">&#125;      </span><br><span class="line"><span class="keyword">struct</span> file *<span class="title function_">alloc_empty_file</span><span class="params">(<span class="type">int</span> flags, <span class="type">const</span> <span class="keyword">struct</span> cred *cred)</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">file</span> *<span class="title">f</span>;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (get_nr_files() &gt;= files_stat.max_files &amp;&amp; !capable(CAP_SYS_ADMIN)) &#123;</span><br><span class="line">        <span class="keyword">if</span> (percpu_counter_sum_positive(&amp;nr_files) &gt;= files_stat.max_files)</span><br><span class="line">            <span class="keyword">goto</span> over;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    f = kmem_cache_zalloc(filp_cachep, GFP_KERNEL);</span><br><span class="line">	...</span><br><span class="line">    <span class="keyword">return</span> f;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>x86_64ç³»ç»Ÿè°ƒç”¨</title>
    <url>/2025/09/19/note/%E7%B3%BB%E7%BB%9F%E8%B0%83%E7%94%A8/</url>
    <content><![CDATA[<h1 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h1><p>æœ¬æ–‡ä¸“æ³¨äºx86_64æ¶æ„çš„ç³»ç»Ÿè°ƒç”¨ï¼Œä¸x86æ¶æ„ä¸åŒçš„æ˜¯ï¼Œ32ä½ä½¿ç”¨çš„æ˜¯int80ä¸­æ–­æ¥å¤„ç†çš„ç³»ç»Ÿè°ƒç”¨ï¼Œå…·ä½“çœ‹<code>arch/x86/entry/entry_32.S</code>æ–‡ä»¶ã€‚ è€Œx86_64æ¶æ„å¯¹åº”çš„kernelå…¥å£åœ¨entry_64.Sä¸­ï¼Œå…¶ç›´æ¥ä½¿ç”¨syscallæŒ‡ä»¤ã€‚äºŒè€…çš„åŒºåˆ«åœ¨äºï¼Œ</p>
<ul>
<li><p>ç›´æ¥ä½¿ç”¨syscalléœ€è¦ä¿å­˜çš„å¯„å­˜å™¨æ•°é‡æ›´å°‘ã€‚x86 çš„ <code>int 0x80</code>éœ€è¦ä¿å­˜æ›´å¤šå¯„å­˜å™¨ï¼ˆå¦‚ <code>CS:EIP</code>ã€<code>SS:ESP</code>ã€<code>EFLAGS</code>ç­‰ï¼‰ï¼Œè€Œ <code>syscall</code>ä»…ä¿å­˜ <code>RFLAGS</code>å’Œ <code>CS:RIP</code>ï¼Œå› æ­¤å‡å°‘äº†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„å¼€é”€ã€‚æ­¤å¤–x86_64è¿˜é¿å…äº†ä¸­æ–­å¤„ç†çš„å¼€é”€ã€‚</p>
</li>
<li><p>å‚æ•°ä¼ é€’çš„å¯„å­˜å™¨ä¸åŒã€‚<strong>x86</strong>ï¼šå‰6ä¸ªå‚æ•°ä¾æ¬¡é€šè¿‡ <code>ebx</code>ã€<code>ecx</code>ã€<code>edx</code>ã€<code>esi</code>ã€<code>edi</code>ã€<code>ebp</code>ä¼ é€’ï¼Œè¶…å‡ºéƒ¨åˆ†é€šè¿‡æ ˆä¼ é€’ã€‚<strong>x86_64</strong>ï¼šå‰6ä¸ªå‚æ•°é€šè¿‡ <code>rdi</code>ã€<code>rsi</code>ã€<code>rdx</code>ã€<code>r10</code>ã€<code>r8</code>ã€<code>r9</code>ä¼ é€’ï¼Œä¸”ç¬¬å››ä¸ªå‚æ•°ï¼ˆåŸ <code>ecx</code>ï¼‰æ”¹ä¸º <code>r10</code>ï¼Œä»¥é¿å…ä¸è¿”å›åœ°å€å†²çªã€‚<strong>å…³é”®åŒºåˆ«</strong>åœ¨äºx86_64 çš„ <code>rcx</code>å¯„å­˜å™¨ç”¨äºä¿å­˜è¿”å›åœ°å€ï¼Œå› æ­¤å‚æ•°ä¼ é€’éœ€é¿å¼€è¯¥å¯„å­˜å™¨ã€‚</p>
</li>
<li><p>é”™è¯¯ç è¿”å›ä¸åŒã€‚ä¸¤è€…å‡é€šè¿‡ <code>eax/rax</code>è¿”å›ç»“æœï¼Œä½† x86_64 çš„é”™è¯¯ç ä»¥è´Ÿæ•°å½¢å¼ï¼ˆèŒƒå›´ <code>-4095</code>è‡³ <code>-1</code>ï¼‰è¡¨ç¤ºï¼Œè€Œ x86 ä½¿ç”¨æ­£æ•°é”™è¯¯ç ã€‚</p>
</li>
</ul>
<h2 id="ç³»ç»Ÿè°ƒç”¨çš„åˆå§‹åŒ–"><a href="#ç³»ç»Ÿè°ƒç”¨çš„åˆå§‹åŒ–" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨çš„åˆå§‹åŒ–"></a>ç³»ç»Ÿè°ƒç”¨çš„åˆå§‹åŒ–</h2><p>åœ¨ç³»ç»Ÿå¯åŠ¨ä¹‹åˆçš„CPU_inité˜¶æ®µï¼Œä¼šå¯¹CPUä¸Šä¸€äº›MSRå¯„å­˜å™¨è¿›è¡Œåˆå§‹åŒ–ï¼Œè€Œå¯¹äºsyscall_initéƒ¨åˆ†çš„åˆå§‹åŒ–åœ¨syscall_initå‡½æ•°ä¸­ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// file: arch/x86/kernel/cpu/common.c</span></span><br><span class="line"></span><br><span class="line"><span class="type">void</span> <span class="title function_">syscall_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/* The default user and kernel segments */</span></span><br><span class="line">	wrmsr(MSR_STAR, <span class="number">0</span>, (__USER32_CS &lt;&lt; <span class="number">16</span>) | __KERNEL_CS);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Except the IA32_STAR MSR, there is NO need to setup SYSCALL and</span></span><br><span class="line"><span class="comment">	 * SYSENTER MSRs for FRED, because FRED uses the ring 3 FRED</span></span><br><span class="line"><span class="comment">	 * entrypoint for SYSCALL and SYSENTER, and ERETU is the only legit</span></span><br><span class="line"><span class="comment">	 * instruction to return to ring 3 (both sysexit and sysret cause</span></span><br><span class="line"><span class="comment">	 * #UD when FRED is enabled).</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (!cpu_feature_enabled(X86_FEATURE_FRED))</span><br><span class="line">		idt_syscall_init();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">idt_syscall_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	wrmsrl(MSR_LSTAR, (<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_64);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (ia32_enabled()) &#123;</span><br><span class="line">		wrmsrl_cstar((<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_compat);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This only works on Intel CPUs.</span></span><br><span class="line"><span class="comment">		 * On AMD CPUs these MSRs are 32-bit, CPU truncates MSR_IA32_SYSENTER_EIP.</span></span><br><span class="line"><span class="comment">		 * This does not cause SYSENTER to jump to the wrong location, because</span></span><br><span class="line"><span class="comment">		 * AMD doesn&#x27;t allow SYSENTER in long mode (either 32- or 64-bit).</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_CS, (u64)__KERNEL_CS);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_ESP,</span><br><span class="line">			    (<span class="type">unsigned</span> <span class="type">long</span>)(cpu_entry_stack(smp_processor_id()) + <span class="number">1</span>));</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_EIP, (u64)entry_SYSENTER_compat);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		wrmsrl_cstar((<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL32_ignore);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_CS, (u64)GDT_ENTRY_INVALID_SEG);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_ESP, <span class="number">0ULL</span>);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_EIP, <span class="number">0ULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Flags to clear on syscall; clear as much as possible</span></span><br><span class="line"><span class="comment">	 * to minimize user space-kernel interference.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	wrmsrl(MSR_SYSCALL_MASK,</span><br><span class="line">	       X86_EFLAGS_CF|X86_EFLAGS_PF|X86_EFLAGS_AF|</span><br><span class="line">	       X86_EFLAGS_ZF|X86_EFLAGS_SF|X86_EFLAGS_TF|</span><br><span class="line">	       X86_EFLAGS_IF|X86_EFLAGS_DF|X86_EFLAGS_OF|</span><br><span class="line">	       X86_EFLAGS_IOPL|X86_EFLAGS_NT|X86_EFLAGS_RF|</span><br><span class="line">	       X86_EFLAGS_AC|X86_EFLAGS_ID);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­åœ¨ç¬¬6è¡Œï¼Œå°†Useræ®µçš„cså’Œkernelæ®µçš„cså†™å…¥MSR_STARå¯„å­˜å™¨ã€‚ç¬¬ä¸€ä¸ªç‰¹æ®Šæ¨¡å—é›†å¯„å­˜å™¨- <code>MSR_STAR</code> çš„ <code>63:48</code> ä¸ºç”¨æˆ·ä»£ç çš„ä»£ç æ®µã€‚è¿™äº›æ•°æ®å°†åŠ è½½è‡³ <code>CS</code> å’Œ <code>SS</code> æ®µé€‰æ‹©ç¬¦ï¼Œç”±æä¾›å°†ç³»ç»Ÿè°ƒç”¨è¿”å›è‡³ç›¸åº”ç‰¹æƒçº§çš„ç”¨æˆ·ä»£ç åŠŸèƒ½çš„ <code>sysret</code> æŒ‡ä»¤ä½¿ç”¨ã€‚ åŒæ—¶ä»å†…æ ¸ä»£ç æ¥çœ‹ï¼Œ å½“ç”¨æˆ·ç©ºé—´åº”ç”¨ç¨‹åºæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶ï¼Œ<code>MSR_STAR</code> çš„ <code>47:32</code> å°†ä½œä¸º <code>CS</code> and <code>SS</code>æ®µé€‰æ‹©å¯„å­˜å™¨çš„åŸºåœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* The default user and kernel segments */</span></span><br><span class="line">	wrmsr(MSR_STAR, <span class="number">0</span>, (__USER32_CS &lt;&lt; <span class="number">16</span>) | __KERNEL_CS);</span><br></pre></td></tr></table></figure>

<p>ç„¶ååœ¨ç¬¬21è¡Œå†™å…¥entry_SYSCALL_64å‡½æ•°çš„åœ°å€ï¼Œå³kernel entryçš„å…¥å£åœ°å€ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">wrmsrl(MSR_LSTAR, (<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_64);</span><br></pre></td></tr></table></figure>

<p>è®¾ç½®å¥½ç³»ç»Ÿè°ƒç”¨å…¥å£åï¼Œéœ€è¦ä»¥ä¸‹ç‰¹æ®Šæ¨¡å¼çš„å¯„å­˜å™¨è¿›è¡Œæ“ä½œï¼Œä»¥æ–¹ä¾¿64ä½CPUèƒ½å¤Ÿæ‰§è¡Œ32ä½çš„ç¨‹åºã€‚</p>
<ul>
<li><code>MSR_CSTAR</code> - target <code>rip</code> for the compability mode callers;</li>
<li><code>MSR_IA32_SYSENTER_CS</code> - target <code>cs</code> for the <code>sysenter</code> instruction;</li>
<li><code>MSR_IA32_SYSENTER_ESP</code> - target <code>esp</code> for the <code>sysenter</code> instruction;</li>
<li><code>MSR_IA32_SYSENTER_EIP</code> - target <code>eip</code> for the <code>sysenter</code> instruction.</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (ia32_enabled()) &#123;</span><br><span class="line">		wrmsrl_cstar((<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_compat);</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * This only works on Intel CPUs.</span></span><br><span class="line"><span class="comment">		 * On AMD CPUs these MSRs are 32-bit, CPU truncates MSR_IA32_SYSENTER_EIP.</span></span><br><span class="line"><span class="comment">		 * This does not cause SYSENTER to jump to the wrong location, because</span></span><br><span class="line"><span class="comment">		 * AMD doesn&#x27;t allow SYSENTER in long mode (either 32- or 64-bit).</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_CS, (u64)__KERNEL_CS);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_ESP,</span><br><span class="line">			    (<span class="type">unsigned</span> <span class="type">long</span>)(cpu_entry_stack(smp_processor_id()) + <span class="number">1</span>));</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_EIP, (u64)entry_SYSENTER_compat);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		wrmsrl_cstar((<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL32_ignore);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_CS, (u64)GDT_ENTRY_INVALID_SEG);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_ESP, <span class="number">0ULL</span>);</span><br><span class="line">		wrmsrl_safe(MSR_IA32_SYSENTER_EIP, <span class="number">0ULL</span>);</span><br><span class="line">	&#125;</span><br><span class="line">	wrmsrl(MSR_SYSCALL_MASK,</span><br><span class="line">	       X86_EFLAGS_CF|X86_EFLAGS_PF|X86_EFLAGS_AF|</span><br><span class="line">	       X86_EFLAGS_ZF|X86_EFLAGS_SF|X86_EFLAGS_TF|</span><br><span class="line">	       X86_EFLAGS_IF|X86_EFLAGS_DF|X86_EFLAGS_OF|</span><br><span class="line">	       X86_EFLAGS_IOPL|X86_EFLAGS_NT|X86_EFLAGS_RF|</span><br><span class="line">	       X86_EFLAGS_AC|X86_EFLAGS_ID);  <span class="comment">//ç¦æ­¢ä¸­æ–­å’Œä¸€äº›åˆ«çš„æ©ç ä½ï¼Œæœ€é‡è¦çš„æ˜¯ç¦æ­¢ä¸­æ–­ã€‚ä¹Ÿå°±æ˜¯è¯´syscallæ˜¯ä¸å…è®¸ä¸­æ–­çš„</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œéœ€è¦äº†è§£ä¸€ä¸‹å‡ ä¸ªå¯„å­˜å™¨çš„ä½œç”¨</p>
<ul>
<li><code>esp </code>- å½“å‰æ ˆé¡¶</li>
<li><code>eip</code> - ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€</li>
<li><code>ebp</code> - å½“å‰æ ˆåº•</li>
<li><code>cs</code> - ä»£ç æ®µåœ°å€</li>
</ul>
<p>è¿™é‡Œä»£ç å°±æ˜¯æ¯”è¾ƒæ˜äº†ï¼Œå°±æ˜¯æŠŠ32ä½ç¨‹åºçš„ä½¿ç”¨çš„ä¸€äº›MSRå¯„å­˜å™¨ç­‰è¿›è¡Œè®¾ç½®ï¼ŒæŠŠ64ä½ä¸‹çš„å€¼ç»™ä»–ä»¬ã€‚ä¸è¿‡è¿™æ˜¯å…³äº64ä½ç¨‹åºè¿è¡Œ32ä½çš„éƒ¨åˆ†ï¼Œå› æ­¤æˆ‘ä»¬å…ˆè·³è¿‡è¿™å—ï¼Œç›´æ¥çœ‹å…·ä½“çš„å…¥å£å‡½æ•°ï¼Œå³<code>entry_SYSCALL_64</code>ï¼Œè¯¥å‡½æ•°åœ°å€è¢«å†™å…¥MSR_LSTARå¯„å­˜å™¨ï¼Œä¸€æ—¦ç”¨æˆ·æ€æ‰§è¡ŒsyscallæŒ‡ä»¤ï¼Œå°±ä¼šè·³è½¬åˆ°è¯¥åœ°å€è¿›è¡Œæ‰§è¡Œã€‚</p>
<p>syscallæŒ‡ä»¤ä¸»è¦åšäº†ä»¥ä¸‹å‡ ä»¶äº‹ï¼š</p>
<ul>
<li><p>æŠŠ<code>syscall</code>æŒ‡ä»¤çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼ˆä¹Ÿå°±æ˜¯è¿”å›åœ°å€ï¼‰å­˜å…¥ <code>%rcx</code> å¯„å­˜ï¼Œç„¶åæŠŠæŒ‡ä»¤æŒ‡é’ˆå¯„å­˜å™¨ <code>%rip</code> æ›¿æ¢æˆIA32_LSTAR MSRå¯„å­˜å™¨é‡Œçš„å€¼ã€‚</p>
</li>
<li><p>æŠŠ rflags æ ‡å¿—å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ° <code>%r11</code>ï¼Œç„¶åæŠŠ rflags çš„å€¼ä¸ IA32_FMASK MSR é‡Œçš„å€¼åšæ©ç è¿ç®—ã€‚</p>
</li>
<li><p>æŠŠ IA32_STAR MSRå¯„å­˜å™¨é‡Œç¬¬32~47ä½åŠ è½½åˆ° CS å’Œ SS æ®µå¯„å­˜å™¨ã€‚</p>
</li>
</ul>
<h2 id="çœŸæ­£ç³»ç»Ÿè°ƒç”¨"><a href="#çœŸæ­£ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="çœŸæ­£ç³»ç»Ÿè°ƒç”¨"></a>çœŸæ­£ç³»ç»Ÿè°ƒç”¨</h2><h3 id="è¿›å…¥å†…æ ¸æ€è¿è¡Œä»£ç ä¹‹å‰éœ€è¦çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼ˆåˆ‡æ¢æ®µå¯„å­˜å™¨å’ŒCR3ç­‰ï¼‰"><a href="#è¿›å…¥å†…æ ¸æ€è¿è¡Œä»£ç ä¹‹å‰éœ€è¦çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼ˆåˆ‡æ¢æ®µå¯„å­˜å™¨å’ŒCR3ç­‰ï¼‰" class="headerlink" title="è¿›å…¥å†…æ ¸æ€è¿è¡Œä»£ç ä¹‹å‰éœ€è¦çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼ˆåˆ‡æ¢æ®µå¯„å­˜å™¨å’ŒCR3ç­‰ï¼‰"></a>è¿›å…¥å†…æ ¸æ€è¿è¡Œä»£ç ä¹‹å‰éœ€è¦çš„ä¸€äº›å‡†å¤‡å·¥ä½œï¼ˆåˆ‡æ¢æ®µå¯„å­˜å™¨å’ŒCR3ç­‰ï¼‰</h3><p>ç„¶åæˆ‘ä»¬æ¥çœ‹çœŸæ­£çš„å†…æ ¸å…¥å£çš„æ±‡ç¼–ä»£ç </p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_CODE_START(entry_SYSCALL_64)</span><br><span class="line">	UNWIND_HINT_ENTRY</span><br><span class="line">	ENDBR</span><br><span class="line">	</span><br><span class="line">	swapgs </span><br><span class="line">	/* tss.sp2 is scratch space. */</span><br><span class="line">	movq	%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line">	movq	PER_CPU_VAR(pcpu_hot + X86_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_safe_stack, SYM_L_GLOBAL)</span><br><span class="line">	ANNOTATE_NOENDBR</span><br><span class="line"></span><br><span class="line">	/* Construct struct pt_regs on stack */</span><br><span class="line">	pushq	$__USER_DS				/* pt_regs-&gt;ss */</span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	/* pt_regs-&gt;sp */</span><br><span class="line">	pushq	%r11					/* pt_regs-&gt;flags */</span><br><span class="line">	pushq	$__USER_CS				/* pt_regs-&gt;cs */</span><br><span class="line">	pushq	%rcx					/* pt_regs-&gt;ip */</span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					/* pt_regs-&gt;orig_ax */</span><br><span class="line"></span><br><span class="line">	PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line"></span><br><span class="line">	/* IRQs are off. */</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	/* Sign extend the lower 32bit as syscall numbers are treated as int */</span><br><span class="line">	movslq	%eax, %rsi</span><br><span class="line"></span><br><span class="line">	/* clobbers %rax, make sure it is after saving the syscall nr */</span><br><span class="line">	IBRS_ENTER</span><br><span class="line">	UNTRAIN_RET</span><br><span class="line">	CLEAR_BRANCH_HISTORY</span><br><span class="line"></span><br><span class="line">	call	do_syscall_64		/* returns with IRQs disabled */</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆå‰ä¸¤è¡Œï¼Œç¬¬ä¸€è¡Œæ˜¯å¤„ç†ftrace,kprobeç­‰å…³äºå†…æ ¸æ ˆè°ƒç”¨å’Œè°ƒè¯•ä¿¡æ¯ç›¸å…³çš„éƒ¨åˆ†ï¼Œæˆ‘ä»¬ä¸å…³å¿ƒï¼Œå› æ­¤è·³è¿‡ï¼Œç¬¬äºŒè¡Œæ˜¯x86å¼€å¯CETä¿æŠ¤åï¼Œå‡½æ•°callè¿‡æ¥å¿…é¡»è·³è½¬çš„æŒ‡ä»¤ï¼Œä¸ç„¶ä¼šå¼‚å¸¸ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¹Ÿä¸å…³å¿ƒã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">UNWIND_HINT_ENTRY</span><br><span class="line">ENDBR</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯åˆ‡æ¢GSæ®µåŸºå€ï¼Œä»ç”¨æˆ·æ€åˆ‡æ¢åˆ°å†…æ ¸æ€ã€‚å› ä¸ºx86-64ä¸Šæœ‰ä¸€ä¸ªper CPUæ•°æ®åŒºåŸŸï¼Œæ˜¯éœ€è¦é€šè¿‡GSå¯„å­˜å™¨è®¿é—®çš„ï¼Œåœ¨ç”¨æˆ·æ€ä¸‹GS æŒ‡å‘ç”¨æˆ·çº¿ç¨‹çš„ TLSï¼›å†…æ ¸æ€ä¸‹ï¼ŒGS æŒ‡å‘å†…æ ¸çš„ <code>per_cpu</code> æ•°æ®ã€‚è¿™ä¸€æ­¥æ˜¯ä»ç”¨æˆ·æ€çš„æ®µåˆ‡æ¢åˆ°å†…æ ¸æ€çš„æ®µã€‚<code>PSï¼šå…¶å®è¿™é‡Œåˆ‡æ¢æ¥åˆ‡æ¢å»éƒ½æ˜¯åŒä¸€ä¸ªæ®µï¼Œå› ä¸ºå¹³å¦å†…å­˜æ¨¡å‹ï¼Œåœ¨GDTè¡¨ä¸­ï¼Œæ‰€æœ‰çš„æ®µçš„åŸºå€éƒ½æ˜¯0ï¼Œåªæ˜¯ä¸åŒæ®µçš„idxä¸åŒï¼Œæ¯”å¦‚12 - kernel code segmentï¼Œ 13 - kernel data segmentï¼Œ 14 - default user CS ï¼ˆå…·ä½“çœ‹æ–‡ä»¶arch/x86/include/asm/segment.hä¸­çš„æ³¨é‡Šï¼‰æ‰€ä»¥è¿™é‡Œåªæ˜¯ä¸€ä¸ªå†å²é—ç•™é—®é¢˜ï¼Œä¸ºäº†ä¿è¯æ—©æœŸåªæ”¯æŒæ®µçš„è®¾å¤‡åšçš„ã€‚</code></p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">swapgs </span><br></pre></td></tr></table></figure>

<p>ç„¶åæŠŠå½“å‰ç”¨æˆ·æ€çš„æ ˆæŒ‡é’ˆ<code>%RSP</code>ä¸´æ—¶å­˜å‚¨çš„TSSæ®µï¼Œæ³¨é‡Šå·²ç»å‘Šè¯‰æˆ‘ä»¬è¿™ä¸ªæ®µçš„sp2å­—æ®µæ˜¯ç©ºçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* tss.sp2 is scratch space. */</span><br><span class="line">movq	%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯åˆ‡æ¢é¡µè¡¨åˆ°å†…æ ¸é¡µè¡¨ï¼Œå³ä¿®æ”¹CR3å¯„å­˜å™¨ã€‚è¿™ä¸ªå®æŠŠrspå½“ä½œä¸€ä¸ªä¸´æ—¶å¯„å­˜å™¨ï¼Œå› ä¸ºrspçš„å€¼å·²ç»å­˜å‚¨è¿‡çš„ã€‚ç„¶åæ˜¯ä¸€ä¸ªå¤„ç†CPUç‰¹æ€§çš„å®ï¼Œåˆ¤æ–­CPUæ”¯ä¸æ”¯æŒPTIï¼ˆPage Table Isolationï¼‰ï¼Œå¦‚æœä¸æ”¯æŒå°±ç›´æ¥è·³è½¬åˆ°æœ«å°¾<code>.Lend_\@</code>, æ”¯æŒçš„è¯å°±æ¥ç€æ‰§è¡Œä¸‹é¢çš„è¯­å¥ï¼Œå½“å‰è¯­å¥æ˜¯ç©º<code>&quot;&quot;</code>.</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line"></span><br><span class="line">.macro SWITCH_TO_KERNEL_CR3 scratch_reg:req</span><br><span class="line">	ALTERNATIVE &quot;jmp .Lend_\@&quot;, &quot;&quot;, X86_FEATURE_PTI</span><br><span class="line">	mov	%cr3, \scratch_reg</span><br><span class="line">	ADJUST_KERNEL_CR3 \scratch_reg</span><br><span class="line">	mov	\scratch_reg, %cr3</span><br><span class="line">.Lend_\@:</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro ADJUST_KERNEL_CR3 reg:req</span><br><span class="line">	ALTERNATIVE &quot;&quot;, &quot;SET_NOFLUSH_BIT \reg&quot;, X86_FEATURE_PCID</span><br><span class="line">	/* Clear PCID and &quot;MITIGATION_PAGE_TABLE_ISOLATION bit&quot;, point CR3 at kernel pagetables: */</span><br><span class="line">	andq    $(~PTI_USER_PGTABLE_AND_PCID_MASK), \reg</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">#define PTI_USER_PGTABLE_BIT		PAGE_SHIFT</span><br><span class="line">#define PTI_USER_PGTABLE_MASK		(1 &lt;&lt; PTI_USER_PGTABLE_BIT)</span><br><span class="line">#define PTI_USER_PCID_BIT		X86_CR3_PTI_PCID_USER_BIT</span><br><span class="line">#define PTI_USER_PCID_MASK		(1 &lt;&lt; PTI_USER_PCID_BIT)</span><br><span class="line">#define PTI_USER_PGTABLE_AND_PCID_MASK  (PTI_USER_PCID_MASK | PTI_USER_PGTABLE_MASK)</span><br></pre></td></tr></table></figure>

<p>ç„¶åä¸Šé¢çš„å®ç¬¬å››è¡ŒæŠŠCR3å¯„å­˜å™¨ä¸´æ—¶å­˜åˆ°rspå¯„å­˜å™¨é‡Œï¼Œç„¶ååˆæ˜¯ä¸€ä¸ªå®ï¼Œè¿™é‡Œåˆ¤æ–­CPUæ”¯ä¸æ”¯æŒPCID(Process Context ID)ï¼Œå¦‚æœæ”¯æŒå°±ä¸éœ€è¦flush TLBã€‚åŒæ—¶æŠŠç”¨æˆ·æ€CR3çš„PTI_USER_PCID_MASKå’ŒPTI_USER_PGTABLE_MASKæ¸…ç©ºï¼Œç„¶åå†å°†å…¶å†™å›CR3å¯„å­˜å™¨ä¸­ã€‚è¿™é‡Œå…¶å®å…³é”®çš„åœ°æ–¹åœ¨äºï¼Œç”¨æˆ·æ€çš„CR3å’Œå†…æ ¸æ€çš„CR3åªå·®äº†ä¸€é¡µã€‚ç”¨ä¸€å¼ ç½‘ä¸Šçš„å›¾å°±æ˜¯å¦‚ä¸‹æ‰€ç¤ºï¼Œæ‰€ä»¥è¿™é‡ŒæŠŠPTI_USER_PGTABLE_MASKï¼Œå³1&lt;&lt;12è¿™é‡Œå˜æˆäº†0ï¼Œè¡¨æ˜æ˜¯kernelçš„CR3äº†ã€‚è¿™é‡Œå…¶å®å°±æ˜¯ä¸ºäº†é˜²æŠ¤ç†”æ–­å’Œå¹½çµæ¼æ´è®¾ç½®çš„KPTIéƒ¨åˆ†ã€‚<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251001204334700.png" alt="image-20251001204334700"></p>
<p>æœ€åå°±æ˜¯åˆ‡æ¢åˆ°å†…æ ¸æ ˆäº†,å³æŠŠper-cpuå˜é‡ä¸­çš„æ ˆé¡¶å†™å…¥RSPã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">movq PER_CPU_VAR(pcpu_hot + X86_top_of_stack), %rsp</span><br></pre></td></tr></table></figure>



<h3 id="ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨å€¼"><a href="#ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨å€¼" class="headerlink" title="ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨å€¼"></a>ä¿å­˜ç”¨æˆ·æ€å¯„å­˜å™¨å€¼</h3><p>å‰é¢å·²ç»è®¾ç½®å¥½å†…æ ¸æ ˆå’Œå†…æ ¸æ€é¡µè¡¨äº†ä¹‹åï¼Œå°±å¼€å§‹ä¿å­˜ä¸€äº›å¯„å­˜å™¨çš„å€¼äº†ï¼Œæˆ‘ä»¬ä¸€è¡Œè¡Œæ¥çœ‹</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_safe_stack, SYM_L_GLOBAL)</span><br><span class="line">	ANNOTATE_NOENDBR #æ ‡è®°è¿™ä¸ªåœ°å€æ²¡æœ‰endbræŒ‡ä»¤ï¼Œå¹¶ä¸åšä»€ä¹ˆå…³é”®çš„äº‹æƒ…ã€‚</span><br><span class="line"></span><br><span class="line">	/* Construct struct pt_regs on stack */</span><br><span class="line">	pushq	$__USER_DS				/* pt_regs-&gt;ss */</span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	/* pt_regs-&gt;sp */</span><br><span class="line">	pushq	%r11					/* pt_regs-&gt;flags */</span><br><span class="line">	pushq	$__USER_CS				/* pt_regs-&gt;cs */</span><br><span class="line">	pushq	%rcx					/* pt_regs-&gt;ip */</span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					/* pt_regs-&gt;orig_ax */</span><br><span class="line"></span><br><span class="line">	PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line">	</span><br><span class="line">.macro PUSH_AND_CLEAR_REGS rdx=%rdx rcx=%rcx rax=%rax save_ret=0 clear_bp=1 unwind_hint=1</span><br><span class="line">	PUSH_REGS rdx=\rdx, rcx=\rcx, rax=\rax, save_ret=\save_ret unwind_hint=\unwind_hint</span><br><span class="line">	CLEAR_REGS clear_bp=\clear_bp</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro PUSH_REGS rdx=%rdx rcx=%rcx rax=%rax save_ret=0 unwind_hint=1</span><br><span class="line">	.if \save_ret</span><br><span class="line">	pushq	%rsi		/* pt_regs-&gt;si */  # æœ‰äº›æƒ…å†µæ ˆä¸Šå·²ç»ä¼šå­˜åœ¨è¿”å›åœ°å€ï¼Œä¾‹å¦‚callæŒ‡ä»¤å‹å…¥çš„ï¼Œå¦‚æœç›´æ¥pushä¼šå¯¼è‡´è¿”å›åœ°å€è¢«ç ´åï¼Œå› æ­¤å…ˆæŠŠè¿”å›åœ°å€ä¿å­˜ä¸€ä¸‹ï¼Œ</span><br><span class="line">	movq	8(%rsp), %rsi	/* temporarily store the return address in %rsi */</span><br><span class="line">	movq	%rdi, 8(%rsp)	/* pt_regs-&gt;di (overwriting original return address) */</span><br><span class="line">	.else</span><br><span class="line">	pushq   %rdi		/* pt_regs-&gt;di */</span><br><span class="line">	pushq   %rsi		/* pt_regs-&gt;si */</span><br><span class="line">	.endif</span><br><span class="line">	pushq	\rdx		/* pt_regs-&gt;dx */</span><br><span class="line">	pushq   \rcx		/* pt_regs-&gt;cx */</span><br><span class="line">	pushq   \rax		/* pt_regs-&gt;ax */</span><br><span class="line">	pushq   %r8		/* pt_regs-&gt;r8 */</span><br><span class="line">	pushq   %r9		/* pt_regs-&gt;r9 */</span><br><span class="line">	pushq   %r10		/* pt_regs-&gt;r10 */</span><br><span class="line">	pushq   %r11		/* pt_regs-&gt;r11 */</span><br><span class="line">	pushq	%rbx		/* pt_regs-&gt;rbx */</span><br><span class="line">	pushq	%rbp		/* pt_regs-&gt;rbp */</span><br><span class="line">	pushq	%r12		/* pt_regs-&gt;r12 */</span><br><span class="line">	pushq	%r13		/* pt_regs-&gt;r13 */</span><br><span class="line">	pushq	%r14		/* pt_regs-&gt;r14 */</span><br><span class="line">	pushq	%r15		/* pt_regs-&gt;r15 */</span><br><span class="line"></span><br><span class="line">	.if \unwind_hint</span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	.if \save_ret</span><br><span class="line">	pushq	%rsi		/* return address on top of stack */ # æœ€åå†å†™å…¥rsiï¼Œå³è¿”å›åœ°å€</span><br><span class="line">	.endif</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro CLEAR_REGS clear_bp=1</span><br><span class="line">	/*</span><br><span class="line">	 * Sanitize registers of values that a speculation attack might</span><br><span class="line">	 * otherwise want to exploit. The lower registers are likely clobbered</span><br><span class="line">	 * well before they could be put to use in a speculative execution</span><br><span class="line">	 * gadget.</span><br><span class="line">	 */</span><br><span class="line">	xorl	%esi,  %esi	/* nospec si  */</span><br><span class="line">	xorl	%edx,  %edx	/* nospec dx  */</span><br><span class="line">	xorl	%ecx,  %ecx	/* nospec cx  */</span><br><span class="line">	xorl	%r8d,  %r8d	/* nospec r8  */</span><br><span class="line">	xorl	%r9d,  %r9d	/* nospec r9  */</span><br><span class="line">	xorl	%r10d, %r10d	/* nospec r10 */</span><br><span class="line">	xorl	%r11d, %r11d	/* nospec r11 */</span><br><span class="line">	xorl	%ebx,  %ebx	/* nospec rbx */</span><br><span class="line">	.if \clear_bp</span><br><span class="line">	xorl	%ebp,  %ebp	/* nospec rbp */</span><br><span class="line">	.endif</span><br><span class="line">	xorl	%r12d, %r12d	/* nospec r12 */</span><br><span class="line">	xorl	%r13d, %r13d	/* nospec r13 */</span><br><span class="line">	xorl	%r14d, %r14d	/* nospec r14 */</span><br><span class="line">	xorl	%r15d, %r15d	/* nospec r15 */</span><br><span class="line"></span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<p>ç„¶åå¼€å§‹pushå¯„å­˜å™¨åˆ°pt_regsç»“æ„ä½“</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	/* Construct struct pt_regs on stack */</span><br><span class="line">	pushq	$__USER_DS				/* pt_regs-&gt;ss  ç”¨æˆ·æ®µDS*/</span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	/* pt_regs-&gt;sp ä¹‹å‰ä¿å­˜åˆ°tssæ®µçš„ç”¨æˆ·æ€rspå¯„å­˜å™¨*/</span><br><span class="line">	pushq	%r11					/* pt_regs-&gt;flags syscallæŒ‡ä»¤è‡ªåŠ¨å­˜å‚¨çš„rflagså¯„å­˜å™¨*/</span><br><span class="line">	pushq	$__USER_CS				/* pt_regs-&gt;cs ç”¨æˆ·æ®µCSå¯„å­˜å™¨*/</span><br><span class="line">	pushq	%rcx					/* pt_regs-&gt;ip ç”¨æˆ·æ€çš„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œæ˜¯ç”±syscallæŒ‡ä»¤æ‰§è¡Œæ—¶å€™CPUè‡ªåŠ¨å­˜å‚¨åˆ°rcxå¯„å­˜å™¨ä¸­çš„*/</span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					/* pt_regs-&gt;orig_ax æŠŠraxå¯„å­˜å™¨å‹å…¥æ ˆï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿè°ƒç”¨å·*/</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯ä¸€ä¸ªå®è°ƒç”¨, å°±æ˜¯æŒ‰é¡ºåºå‹å…¥</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line">.macro PUSH_AND_CLEAR_REGS rdx=%rdx rcx=%rcx rax=%rax save_ret=0 clear_bp=1 unwind_hint=1</span><br><span class="line">	PUSH_REGS rdx=\rdx, rcx=\rcx, rax=\rax, save_ret=\save_ret unwind_hint=\unwind_hint</span><br><span class="line">	CLEAR_REGS clear_bp=\clear_bp</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro PUSH_REGS rdx=%rdx rcx=%rcx rax=%rax save_ret=0 unwind_hint=1</span><br><span class="line">	.if \save_ret</span><br><span class="line">	pushq	%rsi		/* pt_regs-&gt;si */</span><br><span class="line">	movq	8(%rsp), %rsi	/* temporarily store the return address in %rsi */</span><br><span class="line">	movq	%rdi, 8(%rsp)	/* pt_regs-&gt;di (overwriting original return address) */</span><br><span class="line">	.else</span><br><span class="line">	pushq   %rdi		/* pt_regs-&gt;di */</span><br><span class="line">	pushq   %rsi		/* pt_regs-&gt;si */</span><br><span class="line">	.endif</span><br><span class="line">	pushq	\rdx		/* pt_regs-&gt;dx */</span><br><span class="line">	pushq   \rcx		/* pt_regs-&gt;cx */</span><br><span class="line">	pushq   \rax		/* pt_regs-&gt;ax */</span><br><span class="line">	pushq   %r8		/* pt_regs-&gt;r8 */</span><br><span class="line">	pushq   %r9		/* pt_regs-&gt;r9 */</span><br><span class="line">	pushq   %r10		/* pt_regs-&gt;r10 */</span><br><span class="line">	pushq   %r11		/* pt_regs-&gt;r11 */</span><br><span class="line">	pushq	%rbx		/* pt_regs-&gt;rbx */</span><br><span class="line">	pushq	%rbp		/* pt_regs-&gt;rbp */</span><br><span class="line">	pushq	%r12		/* pt_regs-&gt;r12 */</span><br><span class="line">	pushq	%r13		/* pt_regs-&gt;r13 */</span><br><span class="line">	pushq	%r14		/* pt_regs-&gt;r14 */</span><br><span class="line">	pushq	%r15		/* pt_regs-&gt;r15 */</span><br><span class="line"></span><br><span class="line">	.if \unwind_hint</span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	.if \save_ret</span><br><span class="line">	pushq	%rsi		/* return address on top of stack */</span><br><span class="line">	.endif</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<p>åœ¨çœ‹è¿™ä¸€éƒ¨åˆ†çš„æ—¶å€™å¯ä»¥ç»“åˆpt_regsç»“æ„ä½“ä¸€èµ·æ¥çœ‹, å› ä¸ºå‹å…¥æ ˆçš„é¡ºåºä¸pt_regsçš„é¡ºåºç›¸åã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">struct pt_regs &#123;</span><br><span class="line">	/*</span><br><span class="line">	 * C ABI says these regs are callee-preserved. They aren&#x27;t saved on</span><br><span class="line">	 * kernel entry unless syscall needs a complete, fully filled</span><br><span class="line">	 * &quot;struct pt_regs&quot;.</span><br><span class="line">	 */</span><br><span class="line">	unsigned long r15;</span><br><span class="line">	unsigned long r14;</span><br><span class="line">	unsigned long r13;</span><br><span class="line">	unsigned long r12;</span><br><span class="line">	unsigned long bp;</span><br><span class="line">	unsigned long bx;</span><br><span class="line"></span><br><span class="line">	/* These regs are callee-clobbered. Always saved on kernel entry. */</span><br><span class="line">	unsigned long r11;</span><br><span class="line">	unsigned long r10;</span><br><span class="line">	unsigned long r9;</span><br><span class="line">	unsigned long r8;</span><br><span class="line">	unsigned long ax;</span><br><span class="line">	unsigned long cx;</span><br><span class="line">	unsigned long dx;</span><br><span class="line">	unsigned long si;</span><br><span class="line">	unsigned long di;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * orig_ax is used on entry for:</span><br><span class="line">	 * - the syscall number (syscall, sysenter, int80)</span><br><span class="line">	 * - error_code stored by the CPU on traps and exceptions</span><br><span class="line">	 * - the interrupt number for device interrupts</span><br><span class="line">	 *</span><br><span class="line">	 * A FRED stack frame starts here:</span><br><span class="line">	 *   1) It _always_ includes an error code;</span><br><span class="line">	 *</span><br><span class="line">	 *   2) The return frame for ERET[US] starts here, but</span><br><span class="line">	 *      the content of orig_ax is ignored.</span><br><span class="line">	 */</span><br><span class="line">	unsigned long orig_ax;</span><br><span class="line"></span><br><span class="line">	/* The IRETQ return frame starts here */</span><br><span class="line">	unsigned long ip;</span><br><span class="line"></span><br><span class="line">	union &#123;</span><br><span class="line">		/* CS selector */</span><br><span class="line">		u16		cs;</span><br><span class="line">		/* The extended 64-bit data slot containing CS */</span><br><span class="line">		u64		csx;</span><br><span class="line">		/* The FRED CS extension */</span><br><span class="line">		struct fred_cs	fred_cs;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	unsigned long flags;</span><br><span class="line">	unsigned long sp;</span><br><span class="line"></span><br><span class="line">	union &#123;</span><br><span class="line">		/* SS selector */</span><br><span class="line">		u16		ss;</span><br><span class="line">		/* The extended 64-bit data slot containing SS */</span><br><span class="line">		u64		ssx;</span><br><span class="line">		/* The FRED SS extension */</span><br><span class="line">		struct fred_ss	fred_ss;</span><br><span class="line">	&#125;;</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Top of stack on IDT systems, while FRED systems have extra fields</span><br><span class="line">	 * defined above for storing exception related information, e.g. CR2 or</span><br><span class="line">	 * DR6.</span><br><span class="line">	 */</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æŠŠä»¥ä¸Šä¸¤ä¸ªç»“åˆèµ·æ¥å…¶å®å°±æ˜¯ä»¥ä¸‹è¿™å¼ å›¾ï¼š</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251001220608653.png" alt="image-20251001220608653"></p>
<p>ç„¶åä»”ç»†è§‚å¯Ÿä¼šå‘ç°ï¼Œraxå…¶å®è¢«å‹å…¥æ ˆäº†ä¸¤æ¬¡ï¼Œ</p>
<ul>
<li><p><code>orig_ax</code> ç”¨äº restart_syscall &#x2F; ptrace &#x2F; syscall traceï¼šå¯ä»¥çŸ¥é“ç”¨æˆ·æœ€åˆè°ƒç”¨å“ªä¸ª syscallã€‚</p>
</li>
<li><p><code>ax</code> æ˜¯å¸¸è§„ç”¨æˆ·å¯„å­˜å™¨å¿«ç…§ï¼Œå’Œå…¶ä»–é€šç”¨å¯„å­˜å™¨ä¸€æ ·ï¼Œç”¨äº pt_regs å®Œæ•´ä¿å­˜ï¼Œè™½ç„¶ä¸¤ä¸ªå€¼ä¸€æ ·ï¼Œä½†æ˜¯è¿™é‡Œéœ€è¦ç»™è¿”å›å€¼ä¸€ä¸ªå ä½ã€‚</p>
</li>
</ul>
<p>å¦å¤–è¿˜æœ‰%rdiå¹¶æ²¡æœ‰è¢«æ¸…é™¤ï¼Œè¿™æ˜¯å› ä¸ºrdiæ˜¯syscallçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œå› ä¸ºä¼šç›´æ¥è¢«ç”¨ï¼Œæ‰€ä»¥å°±ä¸æ¸…0äº†ã€‚</p>
<p>OK åˆ°è¿™é‡Œå°±å·²ç»æŠŠæ‰€æœ‰å¯„å­˜å™¨çš„å€¼ä¿å­˜åˆ°å†…æ ¸æ ˆä¸Šäº†ï¼Œç„¶åå°±å¯ä»¥è°ƒç”¨çœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/* IRQs are off. */</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	/* Sign extend the lower 32bit as syscall numbers are treated as int */</span><br><span class="line">	movslq	%eax, %rsi</span><br><span class="line"></span><br><span class="line">	/* clobbers %rax, make sure it is after saving the syscall nr */</span><br><span class="line">	IBRS_ENTER  # é™åˆ¶é—´æ¥åˆ†æ”¯é¢„æµ‹</span><br><span class="line">	UNTRAIN_RET # æ¸…ç†è¿”å›æ ˆé¢„æµ‹å™¨</span><br><span class="line">	CLEAR_BRANCH_HISTORY # æ¸…åˆ†æ”¯å†å²ï¼Œé˜²æ­¢ spec leak</span><br><span class="line">	</span><br><span class="line">	call	do_syscall_64		/* returns with IRQs disabled */</span><br><span class="line">	</span><br><span class="line">	</span><br><span class="line">__visible noinstr bool do_syscall_64(struct pt_regs *regs, int nr)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆçœ‹è¿™ä¸ªå‡½æ•°æœ‰ä¸¤ä¸ªå‚æ•°ï¼Œç¬¬ä¸€ä¸ªæ˜¯pt_regsåœ°å€ï¼Œç¬¬äºŒä¸ªæ˜¯ç³»ç»Ÿè°ƒç”¨å·ï¼Œæ‰€ä»¥è¿™é‡Œæ±‡ç¼–å°†rspçš„å€¼ï¼Œä¹Ÿå°±æ˜¯pt_regsçš„åœ°å€ç»™rdiå¯„å­˜å™¨ï¼Œä¹Ÿå°±æ˜¯ABIè§„çº¦é‡Œçš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œç„¶åæŠŠeaxï¼Œä¹Ÿå°±æ˜¯ç³»ç»Ÿè°ƒç”¨å·ç»™rsiï¼Œä¹Ÿå°±æ˜¯ABIè§„çº¦é‡Œçš„ç¬¬äºŒä¸ªå‚æ•°ã€‚ç„¶ååšäº†ä¸€äº›é˜²æ­¢å¹½çµæ”»å‡»çš„æªæ–½ã€‚ï¼ˆè¿™é‡Œå°±ä¸è¯¦ç»†äº†è§£äº†ï¼Œå¯ä»¥å…·ä½“æŸ¥çœ‹ç›¸å…³å¹½çµå’Œç†”æ–­æ¼æ´<a href="https://events19.linuxfoundation.cn/wp-content/uploads/2017/11/Understanding-Spectre-v2-and-How-the-Vulnerability-Impact-the-Cloud-Security_Gavin-Guo.pdf">Understanding-Spectre-v2-and-How-the-Vulnerability-Impact-the-Cloud-Security_Gavin-Guo.pdf</a>ï¼‰</p>
<h3 id="do-syscall-64"><a href="#do-syscall-64" class="headerlink" title="do_syscall_64"></a>do_syscall_64</h3><p>ç»ˆäºæˆ‘ä»¬è·³å‡ºäº†æ±‡ç¼–çš„å‡½æ•°ï¼Œæ¥åˆ°äº†çœ‹å¾—æ˜ç™½ä¸€ç‚¹çš„Cå‡½æ•°ï¼Œæˆ‘å…ˆè´´ä¸ªå®Œæ•´çš„ä»£ç ï¼Œç„¶åæˆ‘ä»¬å†ä¸€ç‚¹ç‚¹çœ‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__visible noinstr <span class="type">bool</span> <span class="title function_">do_syscall_64</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs, <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">	add_random_kstack_offset(); <span class="comment">//ç»™å†…æ ¸æ ˆåŠ ä¸€ä¸ªéšæœºåç§»</span></span><br><span class="line">	nr = syscall_enter_from_user_mode(regs, nr); <span class="comment">// åšä¸€äº›é™åˆ¶æ£€æŸ¥ï¼Œæ¯”å¦‚syscall è¿‡æ»¤/é™åˆ¶ï¼ˆseccomp ç­‰ï¼‰ï¼Œç„¶åå¯èƒ½è¦è°ƒæ•´syscallçš„ç¼–å·ï¼Œæœ€ç»ˆnræ‰æ˜¯éœ€è¦è°ƒç”¨çš„ç¼–å·ã€‚</span></span><br><span class="line"></span><br><span class="line">	instrumentation_begin(); <span class="comment">//ç”¨äºkprobe, ftraceçš„è·Ÿè¸ª</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!do_syscall_x64(regs, nr) &amp;&amp; !do_syscall_x32(regs, nr) &amp;&amp; nr != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="comment">/* Invalid system call, but still a system call. */</span></span><br><span class="line">		regs-&gt;ax = __x64_sys_ni_syscall(regs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instrumentation_end();</span><br><span class="line">	syscall_exit_to_user_mode(regs);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Check that the register state is valid for using SYSRET to exit</span></span><br><span class="line"><span class="comment">	 * to userspace.  Otherwise use the slower but fully capable IRET</span></span><br><span class="line"><span class="comment">	 * exit path.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* XEN PV guests always use the IRET path */</span></span><br><span class="line">	<span class="keyword">if</span> (cpu_feature_enabled(X86_FEATURE_XENPV))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* SYSRET requires RCX == RIP and R11 == EFLAGS */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(regs-&gt;cx != regs-&gt;ip || regs-&gt;r11 != regs-&gt;flags))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* CS and SS must match the values set in MSR_STAR */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(regs-&gt;cs != __USER_CS || regs-&gt;ss != __USER_DS))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * On Intel CPUs, SYSRET with non-canonical RCX/RIP will #GP</span></span><br><span class="line"><span class="comment">	 * in kernel space.  This essentially lets the user take over</span></span><br><span class="line"><span class="comment">	 * the kernel, since userspace controls RSP.</span></span><br><span class="line"><span class="comment">	 *</span></span><br><span class="line"><span class="comment">	 * TASK_SIZE_MAX covers all user-accessible addresses other than</span></span><br><span class="line"><span class="comment">	 * the deprecated vsyscall page.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(regs-&gt;ip &gt;= TASK_SIZE_MAX))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * SYSRET cannot restore RF.  It can restore TF, but unlike IRET,</span></span><br><span class="line"><span class="comment">	 * restoring TF results in a trap from userspace immediately after</span></span><br><span class="line"><span class="comment">	 * SYSRET.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (unlikely(regs-&gt;flags &amp; (X86_EFLAGS_RF | X86_EFLAGS_TF)))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Use SYSRET to exit to userspace */</span></span><br><span class="line">	<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…³é”®åœ¨äºè°ƒç”¨ç³»ç»Ÿè°ƒç”¨çš„åœ°æ–¹åœ¨ä»¥ä¸‹ä»£ç ç‰‡æ®µã€‚å…ˆå°è¯•ç”¨64ä½ï¼Œå†å°è¯•32ä½ï¼Œå¦‚æœå®åœ¨éƒ½å¤±è´¥ï¼Œå°±ç”¨ä¸€ä¸ªniï¼ˆnot implementedï¼‰çš„ç³»ç»Ÿè°ƒç”¨ï¼Œè¿™æ ·ä¸ä¼šæŒ‚å†…æ ¸ã€‚</p>
<ul>
<li><p><strong>do_syscall_x64(regs, nr)</strong> â†’ å°è¯•è°ƒç”¨ 64-bit syscall</p>
</li>
<li><p><strong>do_syscall_x32(regs, nr)</strong> â†’ å°è¯•è°ƒç”¨ 32-bit compatibility syscall</p>
</li>
<li><p>å¦‚æœä¸¤è€…éƒ½å¤±è´¥ï¼Œä¸” syscall ç¼–å·æœ‰æ•ˆ (<code>nr != -1</code>)ï¼š</p>
<ul>
<li><p>è°ƒç”¨ <code>__x64_sys_ni_syscall()</code> â†’ <strong>â€œnot implementedâ€</strong> syscall</p>
</li>
<li><p>å°†è¿”å›å€¼å­˜åˆ° <code>regs-&gt;ax</code>ï¼Œä¿è¯ç”¨æˆ·æ€çœ‹åˆ°æ­£ç¡®çš„è¿”å›å€¼ï¼ˆ-ENOSYSï¼‰</p>
</li>
</ul>
</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">	<span class="keyword">if</span> (!do_syscall_x64(regs, nr) &amp;&amp; !do_syscall_x32(regs, nr) &amp;&amp; nr != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="comment">/* Invalid system call, but still a system call. */</span></span><br><span class="line">		regs-&gt;ax = __x64_sys_ni_syscall(regs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">bool</span> <span class="title function_">do_syscall_x64</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs, <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Convert negative numbers to very high and thus out of range</span></span><br><span class="line"><span class="comment">	 * numbers for comparisons.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> unr = nr;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (likely(unr &lt; NR_syscalls)) &#123;</span><br><span class="line">		unr = array_index_nospec(unr, NR_syscalls); <span class="comment">//é˜²æ­¢å¹½çµæ”»å‡»ï¼Œæ¯”å¦‚ä¼ å…¥ä¸€ä¸ªnr=-1çš„å€¼ï¼Œç„¶åè½¬uintæ—¶å€™ä¼šå˜å¾—å¾ˆå¤§ã€‚</span></span><br><span class="line">		regs-&gt;ax = x64_sys_call(regs, unr); <span class="comment">//æ ¹æ®unrçš„ç¼–å·è°ƒç”¨å…·ä½“å‡½æ•°</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">bool</span> <span class="title function_">do_syscall_x32</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs, <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Adjust the starting offset of the table, and convert numbers</span></span><br><span class="line"><span class="comment">	 * &lt; __X32_SYSCALL_BIT to very high and thus out of range</span></span><br><span class="line"><span class="comment">	 * numbers for comparisons.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">int</span> xnr = nr - __X32_SYSCALL_BIT;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (IS_ENABLED(CONFIG_X86_X32_ABI) &amp;&amp; likely(xnr &lt; X32_NR_syscalls)) &#123;</span><br><span class="line">		xnr = array_index_nospec(xnr, X32_NR_syscalls);</span><br><span class="line">		regs-&gt;ax = x32_sys_call(regs, xnr);</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">	&#125;</span><br><span class="line">	<span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å…¶å®x64_sys_callçš„ä»£ç ä¹Ÿå¾ˆå·§å¦™,å°±æ˜¯ä¸€ä¸ªç®€å•çš„switchï¼Œç„¶åä¸­é—´ç”¨ä¸€ä¸ªå¤´æ–‡ä»¶å¼„äº†ä¸€ä¸ªè‡ªåŠ¨ç”Ÿæˆçš„syscallè¡¨ï¼Œå…·ä½“å†…å®¹çœ‹æ–‡ä»¶<code>arch/x86/entry/syscalls/syscall_64.tbl</code></p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">long</span> <span class="title function_">x64_sys_call</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> pt_regs *regs, <span class="type">unsigned</span> <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">switch</span> (nr) &#123;</span><br><span class="line">	<span class="meta">#<span class="keyword">include</span> <span class="string">&lt;asm/syscalls_64.h&gt;</span></span></span><br><span class="line">	<span class="keyword">default</span>: <span class="keyword">return</span> __x64_sys_ni_syscall(regs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>OKåˆ°è¿™é‡Œå°±å¤§æ¦‚æ¸…æ¥šäº†å…·ä½“çš„ç³»ç»Ÿè°ƒç”¨æ€ä¹ˆè°ƒç”¨çš„ï¼Œæ€ä¹ˆcallåˆ°è¡¨é‡Œçš„è¡¨é¡¹çš„ã€‚</p>
<h3 id="ç³»ç»Ÿè°ƒç”¨çš„è¿”å›"><a href="#ç³»ç»Ÿè°ƒç”¨çš„è¿”å›" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨çš„è¿”å›"></a>ç³»ç»Ÿè°ƒç”¨çš„è¿”å›</h3><p>å…ˆçœ‹çœ‹å®Œæ•´çš„ä»£ç è·¯å¾„, æ‰§è¡Œå®Œdo_syscall_64ä¹‹åï¼Œä¼šæŠŠsyscallè¿”å›çš„ç»“æœå†™å…¥pt_regs-&gt;axéƒ¨åˆ†ï¼Œç„¶ådo_syscall_64çš„è¿”å›å€¼å¦‚æœæ˜¯trueï¼Œåˆ™æ˜¯ä½¿ç”¨sysretè¿”å›ï¼Œæ˜¯å¿«é€Ÿè·¯å¾„ï¼Œå¦‚æœæ˜¯falseï¼Œåˆ™ä½¿ç”¨iretæ»¡é€Ÿè·¯å¾„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	call	do_syscall_64		/* returns with IRQs disabled */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Try to use SYSRET instead of IRET if we&#x27;re returning to</span><br><span class="line">	 * a completely clean 64-bit userspace context.  If we&#x27;re not,</span><br><span class="line">	 * go to the slow exit path.</span><br><span class="line">	 * In the Xen PV case we must use iret anyway.</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	ALTERNATIVE &quot;testb %al, %al; jz swapgs_restore_regs_and_return_to_usermode&quot;, \</span><br><span class="line">		&quot;jmp swapgs_restore_regs_and_return_to_usermode&quot;, X86_FEATURE_XENPV</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We win! This label is here just for ease of understanding</span><br><span class="line">	 * perf profiles. Nothing jumps here.</span><br><span class="line">	 */</span><br><span class="line">syscall_return_via_sysret:</span><br><span class="line">	IBRS_EXIT #æ¸…é™¤IBRSç›¸å…³å¯„å­˜å™¨</span><br><span class="line">	POP_REGS pop_rdi=0 # æŠŠæ‰€æœ‰pt_regså¯„å­˜å™¨å¼¹å‡ºæ¥ï¼Œå¹¶ä¸”ä¸å¼¹å‡º%rdiï¼Œå› ä¸ºæœ¬èº«æ²¡æœ‰å‹å…¥è¿‡</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Now all regs are restored except RSP and RDI.</span><br><span class="line">	 * Save old stack pointer and switch to trampoline stack.</span><br><span class="line">	 */</span><br><span class="line">	movq	%rsp, %rdi # æŠŠå½“å‰æ ˆé¡¶%rsp ç»™ rdiå¯„å­˜å™¨</span><br><span class="line">	movq	PER_CPU_VAR(cpu_tss_rw + TSS_sp0), %rsp  #æŠŠtrampolineçš„æ ˆç»™rspï¼Œè¿™æ˜¯ä¸€ä¸ªå›ºå®šçš„å°æ ˆ</span><br><span class="line">	UNWIND_HINT_END_OF_STACK</span><br><span class="line"></span><br><span class="line">	pushq	RSP-RDI(%rdi)	/* RSP */  </span><br><span class="line">	pushq	(%rdi)		/* RDI */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We are on the trampoline stack.  All regs except RDI are live.</span><br><span class="line">	 * We can do future final exit work right here.</span><br><span class="line">	 */</span><br><span class="line">	STACKLEAK_ERASE_NOCLOBBER</span><br><span class="line"></span><br><span class="line">	SWITCH_TO_USER_CR3_STACK scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	popq	%rdi</span><br><span class="line">	popq	%rsp</span><br><span class="line">SYM_INNER_LABEL(entry_SYSRETQ_unsafe_stack, SYM_L_GLOBAL)</span><br><span class="line">	ANNOTATE_NOENDBR</span><br><span class="line">	swapgs #æŠŠ GS åŸºå€ä»å†…æ ¸çš„ per-cpu åŸºå€äº¤æ¢å›ç”¨æˆ·æ€ GSï¼ˆTLSï¼‰çš„å€¼ã€‚è¿™ä¸€æ­¥å¿…é¡»åœ¨æ¢å¤ç”¨æˆ·å¯„å­˜å™¨å¹¶åœ¨æœ€ç»ˆ sysretq ä¹‹å‰æ‰§è¡Œï¼Œå› ä¸ºç”¨æˆ·æ€çš„ GS/FS å¿…é¡»æ˜¯ç”¨æˆ·åŸå€¼ã€‚</span><br><span class="line">	CLEAR_CPU_BUFFERS</span><br><span class="line">	sysretq #è¿™é‡Œå°±è¿”å›ç”¨æˆ·æ€äº†ï¼Œåç»­ä»£ç éƒ½ä¸ä¼šè¢«è°ƒç”¨åˆ°ã€‚ sysretqï¼šçœŸæ­£çš„ã€å¿«é€Ÿçš„è¿”å›åˆ°ç”¨æˆ·æ€ï¼ˆä½¿ç”¨ RCX = RIP, R11 = RFLAGSï¼ŒCS/SS ç”± MSR_STAR æŒ‡å®šï¼Œä¸” RSP å·²ç»è¢«æ¢å¤ä¸ºç”¨æˆ· RSPï¼‰ã€‚sysretq ä¹‹å CPU ç«‹å³åœ¨ç”¨æˆ·æ€ç»§ç»­æ‰§è¡Œã€‚</span><br><span class="line">SYM_INNER_LABEL(entry_SYSRETQ_end, SYM_L_GLOBAL)</span><br><span class="line">	ANNOTATE_NOENDBR</span><br><span class="line">	int3  # int3 æ˜¯è°ƒè¯•æ–­ç‚¹æŒ‡ä»¤ï¼ˆå¦‚æœæ§åˆ¶æµä¸è¯¥åˆ°è¿™é‡Œå´åˆ°è¿™é‡Œï¼Œè§¦å‘ oops / bugcheckï¼‰ã€‚åœ¨æ­£ç¡®çš„ç³»ç»Ÿé‡Œ sysretq ä¸ä¼šè¿”å›åˆ°ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œè¿™é‡Œçš„ int3 åªæ˜¯ä¿é™©ï¼ˆ&quot;should not reach&quot;ï¼‰ã€‚</span><br><span class="line">SYM_CODE_END(entry_SYSCALL_64)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæœ‰ä¸¤è¡Œä»£ç æ¯”è¾ƒé­”å¹»</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">	pushq	RSP-RDI(%rdi)	<span class="comment">/* RSP */</span>  </span><br><span class="line">	pushq	(%rdi)		<span class="comment">/* RDI */</span></span><br><span class="line">        </span><br><span class="line"><span class="meta">#<span class="keyword">define</span> DATA(offset)		(KEXEC_CONTROL_CODE_MAX_SIZE+(offset))</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Minimal CPU state */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RSP			DATA(0x0)</span></span><br></pre></td></tr></table></figure>

<p>å› ä¸ºæˆ‘ä»¬è¿›å…¥äº†trampolineæ ˆï¼Œä½†æ˜¯å‘¢åŸæœ¬å†…æ ¸æ ˆè¿˜æœ‰ä¸€äº›æ•°æ®æ²¡æœ‰popå®Œï¼Œå¦‚ä¸‹æ‰€ç¤º, æ‰€ä»¥è¿™ä¸¤è¡Œæ€»çš„ä½œç”¨å°±æ˜¯å¤åˆ¶åŸæ¥æ—§å†…æ ¸æ ˆä¸Šä¿å­˜çš„ RSP å’Œ RDI åˆ°å½“å‰ trampoline æ ˆä»¥ä¾¿æ¢å¤ã€‚é‚£ä¹ˆä»¥ä¸‹è¿™äº›å¯„å­˜å™¨å°±ä¸popäº†å˜›ï¼Œæœ‰äººè‚¯å®šä¼šæœ‰ç–‘é—®ã€‚è¿™å°±æœ‰äº†iretå’Œsysretçš„åŒºåˆ«ï¼Œiretè¦æ±‚æ ˆä¸Šéœ€è¦æœ‰ss spè¿™äº›ä¸œè¥¿ï¼Œä»è€Œè‡ªåŠ¨ä¼špopï¼Œä½†æ˜¯sysretä¸ä¼šï¼Œè¿™äº›è„ä¸œè¥¿ä¼šç•™åœ¨å†…æ ¸æ ˆä¸Šï¼Œä½†æ˜¯æ— æ‰€è°“ï¼Œä¸‹æ¬¡è¿›æ¥çš„æ—¶å€™ä¼šæŠŠè¿™äº›è¦†ç›–ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20251001233147305.png" alt="image-20251001233147305"></p>
<p>å…·ä½“ä¸€ç‚¹å°±æ˜¯</p>
<ul>
<li><p><strong><code>iretq</code></strong> è¦æ±‚æ ˆä¸Šæœ‰ä¸¥æ ¼çš„ frameï¼ˆSS, RSP, RFLAGS, CS, RIPï¼‰ï¼Œæ‰€ä»¥ CPU ä¼šçœŸæ­£ pop å®ƒä»¬ã€‚</p>
</li>
<li><p><strong><code>sysretq</code></strong> æ›´è½»é‡ï¼šå®ƒç›´æ¥ä» <code>%rcx</code> å–è¿”å›åœ°å€ï¼Œä» <code>%r11</code> å– RFLAGSï¼Œç„¶åè·³å›ç”¨æˆ·æ€ã€‚å®ƒæ ¹æœ¬ä¸ä¼šç†ä¼šæ ˆä¸Šçš„é‚£ä¸€å¨ã€‚</p>
</li>
</ul>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>çº¢é»‘æ ‘</title>
    <url>/2025/09/19/note/%E7%BA%A2%E9%BB%91%E6%A0%91/</url>
    <content><![CDATA[<h1 id="çº¢é»‘æ ‘"><a href="#çº¢é»‘æ ‘" class="headerlink" title="çº¢é»‘æ ‘"></a>çº¢é»‘æ ‘</h1><h2 id="çº¢é»‘æ ‘ç‰¹ç‚¹"><a href="#çº¢é»‘æ ‘ç‰¹ç‚¹" class="headerlink" title="çº¢é»‘æ ‘ç‰¹ç‚¹"></a>çº¢é»‘æ ‘ç‰¹ç‚¹</h2><p>çº¢é»‘æ ‘å’Œåˆ«çš„æ ‘çš„ä¼˜åŠ¿åœ¨äºï¼š</p>
<ul>
<li>é¦–å…ˆå®ƒæ˜¯ä¸€ä¸ªäºŒå‰æ ‘ï¼Œè¿™æ„å‘³ç€äºŒå‰æ ‘çš„æ’å…¥ï¼ŒæŸ¥æ‰¾å’Œåˆ é™¤çš„å¹³å‡å¤æ‚åº¦åœ¨æœ€å¿«æƒ…å†µä¸‹éƒ½æ˜¯<code>O(logN)</code>ï¼Œå› æ­¤åœ¨é¢‘ç¹æ’å…¥åˆ é™¤å’ŒæŸ¥æ‰¾çš„æƒ…å†µä¸‹æ•ˆç‡éå¸¸é«˜ã€‚</li>
<li>é‚£ä¸ºä»€ä¹ˆä¸é‡‡ç”¨äºŒå‰æœç´¢æ ‘å‘¢ï¼Œè¿™æ˜¯å› ä¸ºäºŒå‰æœç´¢æ ‘åœ¨æ’å…¥çš„æ—¶å€™å¯èƒ½ä¼šå¯¼è‡´æ ‘å˜æˆé“¾è¡¨ï¼ˆæ¯”å¦‚æŒ‰é¡ºåºæ’å…¥ä»å°åˆ°å¤§çš„ç»“ç‚¹ï¼Œä¸€ç›´æ’å…¥åˆ°å³å­æ ‘ï¼‰ï¼Œè¿™æ ·æŸ¥æ‰¾çš„æ•ˆç‡å°±å˜æˆ<code>O(N)</code>äº†ã€‚</li>
<li>æ—¢ç„¶äºŒå‰æœç´¢æ ‘å¤ªå¼±äº†ï¼Œé‚£ä¸ºä»€ä¹ˆä¸ç”¨äºŒå‰å¹³è¡¡æ ‘å‘¢ï¼Œå³AVLã€‚è¿™æ˜¯å› ä¸ºäºŒå‰å¹³è¡¡æ ‘éœ€è¦å·¦å³å­æ ‘é«˜åº¦å·®&lt;&#x3D;1, è€Œçº¢é»‘æ ‘å…è®¸å·¦å³å­æ ‘é«˜åº¦å·®å¤§äº1ï¼Œåªæ˜¯é™å®šäº†è·¯å¾„ä¸Šé»‘è‰²ç»“ç‚¹æ•°ç›®ç›¸åŒï¼Œå¹¶ä¸”ä¸å­˜åœ¨è¿ç»­çš„çº¢è‰²ç»“ç‚¹ï¼ˆæœ€é•¿è·¯å¾„ä¸ºæœ€çŸ­è·¯å¾„çš„ä¸¤å€ï¼Œæœ€é•¿è·¯å¾„æ˜¯çº¢é»‘äº¤æ›¿çš„ï¼Œæœ€çŸ­è·¯å¾„ä¸ºå…¨é»‘çš„ï¼‰ã€‚è¿™æ ·é€šè¿‡æ”¾å®½å¹³è¡¡æ¡ä»¶å¯ä»¥æ¢å–æ›´å°‘çš„æ—‹è½¬æ“ä½œï¼Œæ›´å°‘çš„æ—‹è½¬æ“ä½œæ„å‘³ç€åœ¨é¢‘ç¹æ’å…¥åˆ é™¤çš„åœºæ™¯ä¸‹æ¯”AVLæ›´é«˜æ•ˆã€‚</li>
</ul>
<p>æ€»çš„æ¥è¯´ï¼Œçº¢é»‘æ ‘å…·å¤‡ä»¥ä¸‹ç‰¹ç‚¹</p>
<ul>
<li>å®ƒæ˜¯ä¸€æ£µäºŒå‰æœç´¢æ ‘</li>
<li>æ¯ä¸€ä¸ªèŠ‚ç‚¹éƒ½ä¼šè¢«ç€è‰²ï¼Œä¸æ˜¯<strong>é»‘è‰²</strong>å°±æ˜¯<strong>çº¢è‰²</strong></li>
<li><strong>æ ¹èŠ‚ç‚¹å¿…é¡»ä¸ºé»‘è‰²</strong></li>
<li>å¯¹äºä¸€ä¸ªçº¢è‰²èŠ‚ç‚¹ï¼Œå®ƒçš„å­©å­æˆ–ä¸ºç©ºï¼Œæˆ–æ˜¯é»‘è‰²ã€‚ä¹Ÿå°±æ˜¯è¯´<strong>è·¯å¾„ä¸Šä¸èƒ½æœ‰è¿ç»­çº¢è‰²èŠ‚ç‚¹</strong></li>
<li>ä»æ ¹èŠ‚ç‚¹åˆ°NULLèŠ‚ç‚¹çš„æ‰€æœ‰è·¯å¾„ä¸Šï¼Œ<strong>é»‘è‰²èŠ‚ç‚¹çš„æ•°é‡éƒ½ç›¸åŒ</strong></li>
</ul>
<h2 id="Linuxä¸­çº¢é»‘æ ‘çš„å®ç°"><a href="#Linuxä¸­çº¢é»‘æ ‘çš„å®ç°" class="headerlink" title="Linuxä¸­çº¢é»‘æ ‘çš„å®ç°"></a>Linuxä¸­çº¢é»‘æ ‘çš„å®ç°</h2><p>OKæœ‰äº†ä»¥ä¸Šç›´è§‚çš„è§‚å¿µåï¼Œå’±ä»¬æ¥çœ‹çœ‹Linuxä¸­å®ç°çº¢é»‘æ ‘çš„æºç ã€‚</p>
<p>é¦–å…ˆæ˜¯çº¢é»‘æ ‘çš„å®šä¹‰ï¼ˆLinux 6.11ç‰ˆæœ¬ï¼‰, åœ¨å†…æ ¸æ–‡ä»¶<code>include/linux/rbtree_types.h</code>ä¸­ï¼Œå¯ä»¥çœ‹åˆ°å…¶å®å°±æ˜¯ä¸€ä¸ªä¼ ç»Ÿçš„æ•°æ®ç»“æ„ï¼Œä¸‰ä¸ªæŒ‡é’ˆï¼Œåˆ†åˆ«æŒ‡å‘çˆ¶èŠ‚ç‚¹ï¼Œä¸¤ä¸ªå·¦å³å­æ ‘ï¼Œä½†æ˜¯è¿™ä¸ªçˆ¶èŠ‚ç‚¹è¿™ä¸ªå€¼ï¼ˆ<code>__rb_parent_color</code>ï¼‰åšäº†ä¸€ä¸ªä¼˜åŒ–ï¼Œå…·ä½“çœ‹æ³¨é‡Šï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> &#123;</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span>  __rb_parent_color; <span class="comment">//çˆ¶èŠ‚ç‚¹åœ°å€&amp;0b00, è¿™æ˜¯å› ä¸ºçˆ¶èŠ‚ç‚¹çš„æŒ‡é’ˆéƒ½æ˜¯8å­—èŠ‚å¯¹é½çš„ï¼ˆå³åé¢ä»£ç æ‰€ç¤º__attribute__((aligned(sizeof(long))));ï¼‰ï¼Œæ‰€ä»¥ä½ä½è‚¯å®šæ˜¯0ï¼Œé‚£ä¹ˆå°±ç”¨ä½ä½æ¥å­˜å‚¨å¯¹åº”å½“å‰èŠ‚ç‚¹çš„é¢œè‰²å³å¯ã€‚</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_right</span>;</span> <span class="comment">//å³å­æ ‘</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_left</span>;</span>  <span class="comment">//å·¦å­æ ‘</span></span><br><span class="line">&#125; __attribute__((aligned(<span class="keyword">sizeof</span>(<span class="type">long</span>))));</span><br><span class="line"><span class="comment">/* The alignment might seem pointless, but allegedly CRIS needs it */</span></span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">rb_root</span> &#123;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">rb_node</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æœ‰äº†æ•°æ®ç»“æ„å®šä¹‰ä¹‹åï¼Œæˆ‘ä»¬å†æ¥çœ‹çœ‹ç›¸å…³çš„ä¸€äº›å®å®šä¹‰ç”¨æ¥æ“ä½œè¿™ä¸ªæ•°æ®ç»“æ„çš„ã€‚ä¸»è¦ä»£ç åœ¨æ–‡ä»¶åœ¨<code>include/linux/rbtree.h</code>ä¸­</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/rbtree.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> rb_parent(r)   ((struct rb_node *)((r)-&gt;__rb_parent_color &amp; ~3)) <span class="comment">//è¿™é‡Œå°±æ˜¯è·å–åˆ°parentçš„æŒ‡é’ˆï¼ŒæŠŠ__rb_parent_coloræˆå‘˜çš„ä½ä½ç½®0ã€‚</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span>	rb_entry(ptr, type, member) container_of(ptr, type, member) <span class="comment">//</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_EMPTY_ROOT(root)  (READ_ONCE((root)-&gt;rb_node) == NULL) <span class="comment">//åˆ¤æ–­rootæ˜¯ä¸æ˜¯ç©º</span></span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* &#x27;empty&#x27; nodes are nodes that are known not to be inserted in an rbtree */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_EMPTY_NODE(node)  \</span></span><br><span class="line"><span class="meta">	((node)-&gt;__rb_parent_color == (unsigned long)(node)) <span class="comment">//åˆ¤æ–­RBnodeçš„çˆ¶èŠ‚ç‚¹æ˜¯ä¸æ˜¯è‡ªå·±</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> RB_CLEAR_NODE(node)  \</span></span><br><span class="line"><span class="meta">	((node)-&gt;__rb_parent_color = (unsigned long)(node))</span></span><br></pre></td></tr></table></figure>



<p>ç„¶åå†æ¥çœ‹çœ‹ç¬¬äºŒä¸ªæ¯”è¾ƒé‡è¦çš„å®å®šä¹‰ <code>contain_of</code>,  è¿™æ˜¯å› ä¸ºLinuxçš„æ•°æ®ç»“æ„ï¼Œä¾‹å¦‚é“¾è¡¨å’Œçº¢é»‘æ ‘ï¼Œéƒ½æ˜¯åµŒå…¥åˆ°ç»“æ„ä½“é‡Œé¢çš„ï¼Œå› æ­¤æŒ‡é’ˆæŒ‡å‘çš„ä¹Ÿæ˜¯rb_nodeç»“æ„ï¼Œå¹¶ä¸æ˜¯åŒ…å«è¯¥rbnodeçš„ç»“æ„ä½“(ä¾‹å¦‚mm_struct)ï¼Œè¦æå–çœŸå®çš„mm_structç»“æ„ä½“ï¼Œåˆ™éœ€è¦ä½¿ç”¨ç±»ä¼¼è¿™ç§container_ofå®ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/container_of.h</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> container_of(ptr, type, member) (&#123;				\</span></span><br><span class="line"><span class="meta">	void *__mptr = (void *)(ptr);					\ <span class="comment">//æŠŠptræŒ‡é’ˆå¼ºè½¬æˆvoid*ï¼Œ é˜²æ­¢ç±»å‹è­¦å‘Šã€‚</span></span></span><br><span class="line">	<span class="keyword">static_assert</span>(__same_type(*(ptr), ((type *)<span class="number">0</span>)-&gt;member) ||	\ <span class="comment">//__same_type  GCCå†…ç½®å®ï¼Œç¡®ä¿*(ptr)å’Œ((type *)0)-&gt;memberç±»å‹ç›¸åŒï¼Œè¿™é‡Œç”¨äº†ä¸€ä¸ªæŠ€å·§å†™æ³•ï¼Œå³å‡è®¾0æ˜¯(type *)ç±»å‹çš„æŒ‡é’ˆï¼Œä»è€Œå–å…¶memberæˆå‘˜ã€‚</span></span><br><span class="line">		      __same_type(*(ptr), <span class="type">void</span>),			\  <span class="comment">//å…è®¸ ptræ˜¯ void*ï¼ˆæŸäº›ç‰¹æ®Šæƒ…å†µï¼Œå¦‚ list_headå¯èƒ½æ˜¯ void*ï¼‰ã€‚</span></span><br><span class="line">		      <span class="string">&quot;pointer type mismatch in container_of()&quot;</span>);	\  <span class="comment">//ç¼–è¯‘æ—¶æ£€æŸ¥</span></span><br><span class="line">	((type *)(__mptr - offsetof(type, member))); &#125;) <span class="comment">// offsetof(type, member)ï¼šè®¡ç®— memberåœ¨ typeç»“æ„ä½“ä¸­çš„åç§»é‡ï¼ˆå­—èŠ‚ï¼‰ã€‚ç„¶åæŠŠå½“å‰çš„rbnodeå‡å»åç§»å°±æ˜¯çœŸå®çš„</span></span><br><span class="line">        </span><br><span class="line"><span class="comment">// include/linux/stddef.h        </span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> offsetof(TYPE, MEMBER)	__builtin_offsetof(TYPE, MEMBER) <span class="comment">// GCCå‡½æ•°ï¼Œ</span></span></span><br></pre></td></tr></table></figure>

<p>å‡è®¾æœ‰ä¸€ä¸ªç»“æ„ä½“</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">person</span> &#123;</span></span><br><span class="line">    <span class="type">int</span> age;</span><br><span class="line">    <span class="type">char</span> name[<span class="number">20</span>];</span><br><span class="line">    <span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> <span class="title">rb</span>;</span>  <span class="comment">// å‡è®¾è¿™æ˜¯ä¸€ä¸ªçº¢é»‘æ ‘èŠ‚ç‚¹</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>å¹¶ä¸”å‡è®¾æˆ‘ä»¬ç°åœ¨æœ‰ä¸€ä¸ª<code>struct rb_node* node</code>æŒ‡é’ˆ,æˆ‘ä»¬ä½¿ç”¨å¦‚ä¸‹è¯­å¥å°±èƒ½è·å–åˆ°è¯¥ç»“æ„ä½“ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">person</span> *<span class="title">p</span> =</span> container_of(node, <span class="keyword">struct</span> person, rb);</span><br></pre></td></tr></table></figure>



<p>æ­¤å¤–è¿˜æœ‰ä¸€äº›æ¯”è¾ƒå¸¸ç”¨çš„å‡½æ•°ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// lib/rbtree.c  </span></span><br><span class="line">  <span class="keyword">struct</span> rb_node *<span class="title function_">rb_first</span><span class="params">(<span class="keyword">struct</span> rb_root *tree)</span>;</span><br><span class="line">  <span class="keyword">struct</span> rb_node *<span class="title function_">rb_last</span><span class="params">(<span class="keyword">struct</span> rb_root *tree)</span>;</span><br><span class="line">  <span class="keyword">struct</span> rb_node *<span class="title function_">rb_next</span><span class="params">(<span class="keyword">struct</span> rb_node *node)</span>;</span><br><span class="line">  <span class="keyword">struct</span> rb_node *<span class="title function_">rb_prev</span><span class="params">(<span class="keyword">struct</span> rb_node *node)</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rb_node *<span class="title function_">rb_first</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rb_root *root)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span>	*<span class="title">n</span>;</span></span><br><span class="line"></span><br><span class="line">	n = root-&gt;rb_node;</span><br><span class="line">	<span class="keyword">if</span> (!n)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">while</span> (n-&gt;rb_left) <span class="comment">// ä¸€ç›´å–æœ€å·¦è¾¹çš„ç»“ç‚¹</span></span><br><span class="line">		n = n-&gt;rb_left;</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125; </span><br><span class="line">EXPORT_SYMBOL(rb_first);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rb_node *<span class="title function_">rb_last</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rb_root *root)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span>	*<span class="title">n</span>;</span></span><br><span class="line"></span><br><span class="line">	n = root-&gt;rb_node;</span><br><span class="line">	<span class="keyword">if</span> (!n)</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line">	<span class="keyword">while</span> (n-&gt;rb_right)	<span class="comment">// ä¸€ç›´å–æœ€å³è¾¹çš„ç»“ç‚¹</span></span><br><span class="line">		n = n-&gt;rb_right;</span><br><span class="line">	<span class="keyword">return</span> n;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(rb_last);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rb_node *<span class="title function_">rb_next</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rb_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RB_EMPTY_NODE(node)) <span class="comment">// åˆ¤æ–­å½“å‰nodeçš„parentæ˜¯ä¸æ˜¯æŒ‡å‘è‡ªå·±ï¼Œå¦‚æœæ˜¯è¯´æ˜è¯¥nodeæ²¡æœ‰è¢«æ’å…¥rb_rootä¸­ï¼Œæ‰€ä»¥è¿”å›NULLã€‚</span></span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we have a right-hand child, go down and then left as far</span></span><br><span class="line"><span class="comment">	 * as we can.  å¦‚æœæœ‰å³å­æ ‘ï¼Œåˆ™å–å³å­æ ‘çš„æœ€å·¦ç»“ç‚¹</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (node-&gt;rb_right) &#123;</span><br><span class="line">		node = node-&gt;rb_right;</span><br><span class="line">		<span class="keyword">while</span> (node-&gt;rb_left)</span><br><span class="line">			node = node-&gt;rb_left;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">struct</span> rb_node *)node;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * No right-hand children. Everything down and left is smaller than us,</span></span><br><span class="line"><span class="comment">	 * so any &#x27;next&#x27; node must be in the general direction of our parent.</span></span><br><span class="line"><span class="comment">	 * Go up the tree; any time the ancestor is a right-hand child of its</span></span><br><span class="line"><span class="comment">	 * parent, keep going up. First time it&#x27;s a left-hand child of its</span></span><br><span class="line"><span class="comment">	 * parent, said parent is our &#x27;next&#x27; node.  å¦‚æœæ²¡æœ‰å³å­æ ‘ï¼Œåˆ™ä¸€ç›´é€’å½’å¾€ä¸Šå–ã€‚ä¸è¿‡è¿™é‡Œæœ‰ä¸ªç–‘é—®ï¼Œå¦‚æœæœ¬èº«æ˜¯æœ€åä¸€ä¸ªç»“ç‚¹äº†ï¼Œé‚£æœ€åä¸€ä¸ªç»“ç‚¹çš„æœ€åä¸€ä¸ªç»“ç‚¹æ˜¯ä»€ä¹ˆï¼Ÿ</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">while</span> ((parent = rb_parent(node)) &amp;&amp; node == parent-&gt;rb_right)</span><br><span class="line">		node = parent;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(rb_next);</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> rb_node *<span class="title function_">rb_prev</span><span class="params">(<span class="type">const</span> <span class="keyword">struct</span> rb_node *node)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (RB_EMPTY_NODE(node))</span><br><span class="line">		<span class="keyword">return</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * If we have a left-hand child, go down and then right as far</span></span><br><span class="line"><span class="comment">	 * as we can.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">if</span> (node-&gt;rb_left) &#123;</span><br><span class="line">		node = node-&gt;rb_left;</span><br><span class="line">		<span class="keyword">while</span> (node-&gt;rb_right)</span><br><span class="line">			node = node-&gt;rb_right;</span><br><span class="line">		<span class="keyword">return</span> (<span class="keyword">struct</span> rb_node *)node;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * No left-hand children. Go up till we find an ancestor which</span></span><br><span class="line"><span class="comment">	 * is a right-hand child of its parent.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	<span class="keyword">while</span> ((parent = rb_parent(node)) &amp;&amp; node == parent-&gt;rb_left)</span><br><span class="line">		node = parent;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> parent;</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(rb_prev);</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<h2 id="å¢åˆ æ”¹æŸ¥"><a href="#å¢åˆ æ”¹æŸ¥" class="headerlink" title="å¢åˆ æ”¹æŸ¥"></a>å¢åˆ æ”¹æŸ¥</h2><p>æˆ‘ä»¬æœ€ä¸ºå…³å¿ƒçš„å¢åˆ æ”¹æŸ¥ã€‚</p>
<h3 id="åœ¨rb-treeä¸­å¢åŠ ä¸€ä¸ªnode"><a href="#åœ¨rb-treeä¸­å¢åŠ ä¸€ä¸ªnode" class="headerlink" title="åœ¨rb_treeä¸­å¢åŠ ä¸€ä¸ªnode"></a>åœ¨rb_treeä¸­å¢åŠ ä¸€ä¸ªnode</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">// include/linux/rbtree.h</span></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * rb_add() - insert @node into @tree</span></span><br><span class="line"><span class="comment"> * @node: node to insert</span></span><br><span class="line"><span class="comment"> * @tree: tree to insert @node into</span></span><br><span class="line"><span class="comment"> * @less: operator defining the (partial) node order</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line"><span class="title function_">rb_add</span><span class="params">(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_root *tree,</span></span><br><span class="line"><span class="params">       <span class="type">bool</span> (*less)(<span class="keyword">struct</span> rb_node *, <span class="type">const</span> <span class="keyword">struct</span> rb_node *))</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> **<span class="title">link</span> =</span> &amp;tree-&gt;rb_node;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (*link) &#123;</span><br><span class="line">		parent = *link;</span><br><span class="line">		<span class="keyword">if</span> (less(node, parent))</span><br><span class="line">			link = &amp;parent-&gt;rb_left;</span><br><span class="line">		<span class="keyword">else</span></span><br><span class="line">			link = &amp;parent-&gt;rb_right;</span><br><span class="line">	&#125; <span class="comment">//è¿™é‡Œå…ˆæ‰¾åˆ°å¯¹åº”parentå’Œlinkï¼Œå³nodeè¦æ’å…¥çš„ä½ç½®çš„parentã€‚</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//ä¸‹é¢ä¸¤ä¸ªå‡½æ•°æ‰æ˜¯å¢åŠ ç»“ç‚¹å’Œå¹³è¡¡çš„å…³é”®</span></span><br><span class="line">	rb_link_node(node, parent, link);</span><br><span class="line">	rb_insert_color(node, tree);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹rb_link_nodeå‡½æ•°ã€‚å…¶å®å°±æ˜¯æŠŠlinkçš„å€¼æ”¹æˆnodeã€‚åŸæœ¬linkæ˜¯nullã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  include/linux/rbtree.h</span></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">rb_link_node</span><span class="params">(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_node *parent,</span></span><br><span class="line"><span class="params">				<span class="keyword">struct</span> rb_node **rb_link)</span></span><br><span class="line">&#123;</span><br><span class="line">	node-&gt;__rb_parent_color = (<span class="type">unsigned</span> <span class="type">long</span>)parent;</span><br><span class="line">	node-&gt;rb_left = node-&gt;rb_right = <span class="literal">NULL</span>;</span><br><span class="line"></span><br><span class="line">	*rb_link = node;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç„¶åæ˜¯rb_insert_colorå‡½æ•°, å†…æ ¸ä»£ç é‡Œéƒ½å†™äº†å¾ˆå¥½çš„æ³¨é‡Šã€‚å…¶ä¸­å¾ˆå…³é”®çš„ç‚¹éƒ½ç”»å›¾äº†ï¼Œè¿™é‡Œæ³¨é‡Šå°å†™è¯æ˜çº¢è‰²ï¼ˆn, p, g, uï¼‰ï¼Œå¤§å†™è¯æ˜é»‘è‰²(N,P,G,U)</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//  lib/rbtree.c</span></span><br><span class="line"><span class="type">void</span> <span class="title function_">rb_insert_color</span><span class="params">(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_root *root)</span></span><br><span class="line">&#123;</span><br><span class="line">	__rb_insert(node, root, dummy_rotate);</span><br><span class="line">&#125;</span><br><span class="line">EXPORT_SYMBOL(rb_insert_color);</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="type">void</span> <span class="title function_">dummy_rotate</span><span class="params">(<span class="keyword">struct</span> rb_node *old, <span class="keyword">struct</span> rb_node *new)</span> &#123;&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="keyword">inline</span> <span class="keyword">struct</span> rb_node *<span class="title function_">rb_red_parent</span><span class="params">(<span class="keyword">struct</span> rb_node *red)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="keyword">return</span> (<span class="keyword">struct</span> rb_node *)red-&gt;__rb_parent_color;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> __always_inline <span class="type">void</span></span><br><span class="line">__rb_insert(<span class="keyword">struct</span> rb_node *node, <span class="keyword">struct</span> rb_root *root,</span><br><span class="line">	    <span class="type">void</span> (*augment_rotate)(<span class="keyword">struct</span> rb_node *old, <span class="keyword">struct</span> rb_node *new))</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">rb_node</span> *<span class="title">parent</span> =</span> rb_red_parent(node), *gparent, *tmp; <span class="comment">//æ’å…¥çš„ç»“ç‚¹å¿…å®šæ˜¯çº¢è‰²çš„</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * Loop invariant: node is red.</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span> (unlikely(!parent)) &#123;</span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * The inserted node is root. Either this is the</span></span><br><span class="line"><span class="comment">			 * first node, or we recursed at Case 1 below and</span></span><br><span class="line"><span class="comment">			 * are no longer violating 4). å¦‚æœæ’å…¥çš„ç»“ç‚¹å°±æ˜¯rootï¼Œå°±æŠŠå½“å‰ç»“ç‚¹è®¾ç½®æˆé»‘è‰²ï¼Œåˆç”±äºæ˜¯rootï¼Œä¹Ÿå°±æ˜¯æ²¡æœ‰çˆ¶ç»“ç‚¹ï¼Œæ‰€ä»¥çˆ¶ç»“ç‚¹æ˜¯NULLã€‚</span></span><br><span class="line"><span class="comment">			 * static inline void rb_set_parent_color(struct rb_node *rb,</span></span><br><span class="line"><span class="comment">			 *        struct rb_node *p, int color)</span></span><br><span class="line"><span class="comment">             *  &#123;</span></span><br><span class="line"><span class="comment">             *      rb-&gt;__rb_parent_color = (unsigned long)p + color;</span></span><br><span class="line"><span class="comment">             *  &#125;</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			rb_set_parent_color(node, <span class="literal">NULL</span>, RB_BLACK);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line"></span><br><span class="line">		<span class="comment">/*</span></span><br><span class="line"><span class="comment">		 * If there is a black parent, we are done.</span></span><br><span class="line"><span class="comment">		 * Otherwise, take some corrective action as,</span></span><br><span class="line"><span class="comment">		 * per 4), we don&#x27;t want a red root or two</span></span><br><span class="line"><span class="comment">		 * consecutive red nodes.  å¦‚æœçˆ¶äº²æ˜¯é»‘è‰²ï¼Œé‚£ä¹ˆç›´æ¥æ’å…¥å³å¯ï¼Œå› ä¸ºä¸ä¼šæ‰“ç ´å¹³è¡¡ã€‚</span></span><br><span class="line"><span class="comment">		 */</span></span><br><span class="line">		<span class="keyword">if</span>(rb_is_black(parent))</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line"></span><br><span class="line">		gparent = rb_red_parent(parent);  <span class="comment">//è·å–çˆ¶äº²çš„çˆ¶äº² grandparent</span></span><br><span class="line"></span><br><span class="line">		tmp = gparent-&gt;rb_right;  <span class="comment">//å°è¯•è·å–uncleç»“ç‚¹ã€‚</span></span><br><span class="line">		<span class="keyword">if</span> (parent != tmp) &#123;	<span class="comment">/* parent == gparent-&gt;rb_left */</span> <span class="comment">//è¯´æ˜æ˜¯å·¦å­æ ‘ï¼Œ uncleæ˜¯gçš„å³å­æ ‘</span></span><br><span class="line">			<span class="keyword">if</span> (tmp &amp;&amp; rb_is_red(tmp)) &#123; <span class="comment">//å…¶å®å°±æ˜¯ä»åº•éƒ¨å¾€ä¸Šï¼Œå› ä¸ºå½“å‰ç»“ç‚¹æ˜¯çº¢çš„ï¼Œå¹¶ä¸”uncleæ˜¯çº¢çš„ï¼ŒæŠŠparentå’Œuncleéƒ½å˜æˆé»‘çš„ï¼Œå†æŠŠgrandparentå˜æˆçº¢çš„ï¼Œç„¶åå¾€ä¸Šé€’å½’ã€‚</span></span><br><span class="line">				<span class="comment">/*</span></span><br><span class="line"><span class="comment">				 * Case 1 - node&#x27;s uncle is red (color flips).</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 *       G            g</span></span><br><span class="line"><span class="comment">				 *      / \          / \</span></span><br><span class="line"><span class="comment">				 *     p   u  --&gt;   P   U</span></span><br><span class="line"><span class="comment">				 *    /            /</span></span><br><span class="line"><span class="comment">				 *   n            n</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 * However, since g&#x27;s parent might be red, and</span></span><br><span class="line"><span class="comment">				 * 4) does not allow this, we need to recurse</span></span><br><span class="line"><span class="comment">				 * at g.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				rb_set_parent_color(tmp, gparent, RB_BLACK);</span><br><span class="line">				rb_set_parent_color(parent, gparent, RB_BLACK);</span><br><span class="line">				node = gparent;</span><br><span class="line">				parent = rb_parent(node);</span><br><span class="line">				rb_set_parent_color(node, parent, RB_RED);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tmp = parent-&gt;rb_right; </span><br><span class="line">			<span class="keyword">if</span> (node == tmp) &#123;</span><br><span class="line">				<span class="comment">/* è¯´æ˜å½“å‰nodeå°±æ˜¯parentçš„å³å­æ ‘ï¼Œå°±æ—‹è½¬</span></span><br><span class="line"><span class="comment">				 * Case 2 - node&#x27;s uncle is black and node is</span></span><br><span class="line"><span class="comment">				 * the parent&#x27;s right child (left rotate at parent).</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 *      G             G</span></span><br><span class="line"><span class="comment">				 *     / \           / \</span></span><br><span class="line"><span class="comment">				 *    p   U  --&gt;    n   U</span></span><br><span class="line"><span class="comment">				 *     \           /</span></span><br><span class="line"><span class="comment">				 *      n         p</span></span><br><span class="line"><span class="comment">				 *</span></span><br><span class="line"><span class="comment">				 * This still leaves us in violation of 4), the</span></span><br><span class="line"><span class="comment">				 * continuation into Case 3 will fix that.</span></span><br><span class="line"><span class="comment">				 */</span></span><br><span class="line">				tmp = node-&gt;rb_left;</span><br><span class="line">				WRITE_ONCE(parent-&gt;rb_right, tmp);</span><br><span class="line">				WRITE_ONCE(node-&gt;rb_left, parent);</span><br><span class="line">				<span class="keyword">if</span> (tmp)</span><br><span class="line">					rb_set_parent_color(tmp, parent,</span><br><span class="line">							    RB_BLACK);</span><br><span class="line">				rb_set_parent_color(parent, node, RB_RED);</span><br><span class="line">				augment_rotate(parent, node);</span><br><span class="line">				parent = node;</span><br><span class="line">				tmp = node-&gt;rb_right;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/*</span></span><br><span class="line"><span class="comment">			 * Case 3 - node&#x27;s uncle is black and node is</span></span><br><span class="line"><span class="comment">			 * the parent&#x27;s left child (right rotate at gparent).</span></span><br><span class="line"><span class="comment">			 *</span></span><br><span class="line"><span class="comment">			 *        G           P</span></span><br><span class="line"><span class="comment">			 *       / \         / \</span></span><br><span class="line"><span class="comment">			 *      p   U  --&gt;  n   g</span></span><br><span class="line"><span class="comment">			 *     /                 \</span></span><br><span class="line"><span class="comment">			 *    n                   U</span></span><br><span class="line"><span class="comment">			 */</span></span><br><span class="line">			WRITE_ONCE(gparent-&gt;rb_left, tmp); <span class="comment">/* == parent-&gt;rb_right */</span></span><br><span class="line">			WRITE_ONCE(parent-&gt;rb_right, gparent);</span><br><span class="line">			<span class="keyword">if</span> (tmp)</span><br><span class="line">				rb_set_parent_color(tmp, gparent, RB_BLACK);</span><br><span class="line">			__rb_rotate_set_parents(gparent, parent, root, RB_RED);</span><br><span class="line">			augment_rotate(gparent, parent);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			tmp = gparent-&gt;rb_left;</span><br><span class="line">			<span class="keyword">if</span> (tmp &amp;&amp; rb_is_red(tmp)) &#123;</span><br><span class="line">				<span class="comment">/* Case 1 - color flips */</span></span><br><span class="line">				rb_set_parent_color(tmp, gparent, RB_BLACK);</span><br><span class="line">				rb_set_parent_color(parent, gparent, RB_BLACK);</span><br><span class="line">				node = gparent;</span><br><span class="line">				parent = rb_parent(node);</span><br><span class="line">				rb_set_parent_color(node, parent, RB_RED);</span><br><span class="line">				<span class="keyword">continue</span>;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			tmp = parent-&gt;rb_left;</span><br><span class="line">			<span class="keyword">if</span> (node == tmp) &#123;</span><br><span class="line">				<span class="comment">/* Case 2 - right rotate at parent */</span></span><br><span class="line">				tmp = node-&gt;rb_right;</span><br><span class="line">				WRITE_ONCE(parent-&gt;rb_left, tmp);</span><br><span class="line">				WRITE_ONCE(node-&gt;rb_right, parent);</span><br><span class="line">				<span class="keyword">if</span> (tmp)</span><br><span class="line">					rb_set_parent_color(tmp, parent,</span><br><span class="line">							    RB_BLACK);</span><br><span class="line">				rb_set_parent_color(parent, node, RB_RED);</span><br><span class="line">				augment_rotate(parent, node);</span><br><span class="line">				parent = node;</span><br><span class="line">				tmp = node-&gt;rb_left;</span><br><span class="line">			&#125;</span><br><span class="line"></span><br><span class="line">			<span class="comment">/* Case 3 - left rotate at gparent */</span></span><br><span class="line">			WRITE_ONCE(gparent-&gt;rb_right, tmp); <span class="comment">/* == parent-&gt;rb_left */</span></span><br><span class="line">			WRITE_ONCE(parent-&gt;rb_left, gparent);</span><br><span class="line">			<span class="keyword">if</span> (tmp)</span><br><span class="line">				rb_set_parent_color(tmp, gparent, RB_BLACK);</span><br><span class="line">			__rb_rotate_set_parents(gparent, parent, root, RB_RED);</span><br><span class="line">			augment_rotate(gparent, parent);</span><br><span class="line">			<span class="keyword">break</span>;</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œçœ‹ç€ä»£ç æ¯”è¾ƒå¤æ‚ï¼Œå…¶å®å°±æ˜¯åˆ©ç”¨é€’å½’æ¥åšæ—‹è½¬å’Œå˜è‰²ï¼Œå…·ä½“å¦‚ä¸‹ï¼š</p>
<h4 id="åœºæ™¯1ï¼šçº¢é»‘æ ‘ä¸ºç©ºæ ‘"><a href="#åœºæ™¯1ï¼šçº¢é»‘æ ‘ä¸ºç©ºæ ‘" class="headerlink" title="åœºæ™¯1ï¼šçº¢é»‘æ ‘ä¸ºç©ºæ ‘"></a>åœºæ™¯1ï¼šçº¢é»‘æ ‘ä¸ºç©ºæ ‘</h4><p>ç›´æ¥æŠŠæ’å…¥ç»“ç‚¹ä½œä¸ºæ ¹èŠ‚ç‚¹å°±å¯ä»¥äº†</p>
<p>å¦å¤–ï¼šæ ¹æ®çº¢é»‘æ ‘æ€§è´¨ 2æ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²çš„ã€‚è¿˜éœ€è¦æŠŠæ’å…¥èŠ‚ç‚¹è®¾ç½®ä¸ºé»‘è‰²</p>
<h4 id="åœºæ™¯2ï¼šæ’å…¥èŠ‚ç‚¹çš„Keyå·²ç»å­˜åœ¨"><a href="#åœºæ™¯2ï¼šæ’å…¥èŠ‚ç‚¹çš„Keyå·²ç»å­˜åœ¨" class="headerlink" title="åœºæ™¯2ï¼šæ’å…¥èŠ‚ç‚¹çš„Keyå·²ç»å­˜åœ¨"></a>åœºæ™¯2ï¼šæ’å…¥èŠ‚ç‚¹çš„Keyå·²ç»å­˜åœ¨</h4><p>æ›´æ–°å½“å‰èŠ‚ç‚¹çš„å€¼ï¼Œä¸ºæ’å…¥èŠ‚ç‚¹çš„å€¼ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190317643.png" alt="image-20250930190317643"></p>
<h4 id="æƒ…æ™¯3ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²"><a href="#æƒ…æ™¯3ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²" class="headerlink" title="æƒ…æ™¯3ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²"></a>æƒ…æ™¯3ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºé»‘è‰²</h4><p>ç”±äºæ’å…¥çš„èŠ‚ç‚¹æ˜¯çº¢è‰²çš„ï¼Œå½“æ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²æ—¶ï¼Œä¸ä¼šå½±å“çº¢é»‘æ ‘çš„å¹³è¡¡ï¼Œ</p>
<p>æ‰€ä»¥ï¼š <strong>ç›´æ¥æ’å…¥æ— éœ€åšè‡ªå¹³è¡¡</strong>ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190359749.png" alt="image-20250930190359749"></p>
<h4 id="æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²"><a href="#æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²" class="headerlink" title="æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²"></a>æƒ…æ™¯4ï¼šæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²</h4><p>æ ¹æ®æ€§è´¨2ï¼šæ ¹èŠ‚ç‚¹æ˜¯é»‘è‰²ã€‚</p>
<p>å¦‚æœæ’å…¥èŠ‚ç‚¹çš„çˆ¶èŠ‚ç‚¹ä¸ºçº¢è‰²èŠ‚ç‚¹ï¼Œé‚£ä¹ˆè¯¥çˆ¶èŠ‚ç‚¹ä¸å¯èƒ½ä¸ºæ ¹èŠ‚ç‚¹ï¼Œæ‰€ä»¥æ’å…¥èŠ‚ç‚¹æ€»æ˜¯å­˜åœ¨ç¥–çˆ¶èŠ‚ç‚¹(ä¸‰ä»£å…³ç³»)ã€‚</p>
<p>æ ¹æ®æ€§è´¨4ï¼šæ¯ä¸ª<strong>çº¢è‰²</strong>èŠ‚ç‚¹çš„ä¸¤ä¸ªå­èŠ‚ç‚¹ä¸€å®šæ˜¯<strong>é»‘è‰²</strong>çš„ã€‚ä¸èƒ½æœ‰<strong>ä¸¤ä¸ªçº¢è‰²èŠ‚ç‚¹ç›¸è¿</strong>ã€‚</p>
<p>æ­¤æ—¶ä¼šå‡ºç°ä¸¤ç§çŠ¶æ€ï¼š</p>
<ul>
<li>çˆ¶äº²å’Œå”å”ä¸ºçº¢è‰²</li>
<li>çˆ¶äº²ä¸ºçº¢è‰²ï¼Œå”å”ä¸ºé»‘è‰²</li>
</ul>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190427233.png" alt="image-20250930190427233"></p>
<h5 id="åœºæ™¯4-1ï¼šçˆ¶äº²å’Œå”å”ä¸ºçº¢è‰²èŠ‚ç‚¹"><a href="#åœºæ™¯4-1ï¼šçˆ¶äº²å’Œå”å”ä¸ºçº¢è‰²èŠ‚ç‚¹" class="headerlink" title="åœºæ™¯4.1ï¼šçˆ¶äº²å’Œå”å”ä¸ºçº¢è‰²èŠ‚ç‚¹"></a>åœºæ™¯4.1ï¼šçˆ¶äº²å’Œå”å”ä¸ºçº¢è‰²èŠ‚ç‚¹</h5><p>æ ¹æ®æ€§è´¨4ï¼š<strong>çº¢è‰²èŠ‚ç‚¹ä¸èƒ½ç›¸è¿ &#x3D;&#x3D;ã€‹ç¥–çˆ¶èŠ‚ç‚¹è‚¯å®šä¸ºé»‘è‰²èŠ‚ç‚¹ï¼š</strong></p>
<p>çˆ¶äº²ä¸ºçº¢è‰²ï¼Œé‚£ä¹ˆæ­¤æ—¶è¯¥æ’å…¥å­æ ‘çš„çº¢é»‘æ ‘å±‚æ•°çš„æƒ…å†µæ˜¯ï¼šé»‘çº¢çº¢ã€‚</p>
<p>å› ä¸ºä¸å¯èƒ½åŒæ—¶å­˜åœ¨ä¸¤ä¸ªç›¸è¿çš„çº¢è‰²èŠ‚ç‚¹ï¼Œéœ€è¦è¿›è¡Œ å˜è‰²ï¼Œ æ˜¾ç„¶å¤„ç†æ–¹å¼æ˜¯æŠŠå…¶æ”¹ä¸ºï¼šçº¢é»‘çº¢</p>
<p><strong>å˜è‰² å¤„ç†</strong>ï¼šé»‘çº¢çº¢ &#x3D;&#x3D;&gt; çº¢é»‘çº¢</p>
<p>1.å°†Få’ŒVèŠ‚ç‚¹æ”¹ä¸ºé»‘è‰²</p>
<p>2.å°†Pæ”¹ä¸ºçº¢è‰²</p>
<p>3.å°†Pè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œè¿›è¡Œåç»­å¤„ç†</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190513948.png" alt="image-20250930190513948"></p>
<p>å°†Pè®¾ç½®ä¸ºçº¢è‰²äº†ï¼Œ</p>
<p>å¦‚æœ<strong>Pçš„çˆ¶èŠ‚ç‚¹æ˜¯é»‘è‰²</strong>ï¼Œé‚£ä¹ˆæ— éœ€åšå¤„ç†ï¼›</p>
<p>ä½†å¦‚æœPçš„çˆ¶èŠ‚ç‚¹æ˜¯çº¢è‰²ï¼Œåˆ™è¿åçº¢é»‘æ ‘æ€§è´¨äº†ï¼Œæ‰€ä»¥éœ€è¦å°†Pè®¾ç½®ä¸ºå½“å‰èŠ‚ç‚¹ï¼Œç»§ç»­æ’å…¥æ“ä½œ, ä½œè‡ªå¹³è¡¡å¤„ç†ï¼Œç›´åˆ°æ•´ä½“å¹³è¡¡ä¸ºæ­¢ã€‚</p>
<h5 id="åœºæ™¯4-2ï¼šå”å”ä¸ºé»‘è‰²ï¼Œçˆ¶äº²ä¸ºçº¢è‰²ï¼Œå¹¶ä¸”æ’åœ¨çˆ¶äº²çš„å·¦èŠ‚ç‚¹"><a href="#åœºæ™¯4-2ï¼šå”å”ä¸ºé»‘è‰²ï¼Œçˆ¶äº²ä¸ºçº¢è‰²ï¼Œå¹¶ä¸”æ’åœ¨çˆ¶äº²çš„å·¦èŠ‚ç‚¹" class="headerlink" title="åœºæ™¯4.2ï¼šå”å”ä¸ºé»‘è‰²ï¼Œçˆ¶äº²ä¸ºçº¢è‰²ï¼Œå¹¶ä¸”æ’åœ¨çˆ¶äº²çš„å·¦èŠ‚ç‚¹"></a>åœºæ™¯4.2ï¼šå”å”ä¸ºé»‘è‰²ï¼Œçˆ¶äº²ä¸ºçº¢è‰²ï¼Œå¹¶ä¸”æ’åœ¨çˆ¶äº²çš„å·¦èŠ‚ç‚¹</h5><p>åˆ†ä¸ºä¸¤ç§æƒ…å†µï¼Œå½“å‰ç»“ç‚¹æ˜¯å·¦èŠ‚ç‚¹å’Œå½“å‰ç»“ç‚¹æ˜¯å³ç»“ç‚¹</p>
<ul>
<li>åœºæ™¯4.2.1 LLå‹å¤±è¡¡</li>
</ul>
<p>æŠŠFè®¾ç½®æˆé»‘è‰²ï¼ŒPè®¾ç½®æˆçº¢è‰²ï¼Œç„¶åå³æ—‹ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190759084.png" alt="image-20250930190759084"></p>
<ul>
<li>åœºæ™¯4.2.2 LRå‹å¤±è¡¡</li>
</ul>
<p>æŠŠKå’ŒFè¿›è¡Œå·¦æ—‹ï¼Œè½¬æ¢æˆ4.2.1</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20250930190824711.png" alt="image-20250930190824711"></p>
<p>åŒç†RRå¤±è¡¡å’ŒRLå¤±è¡¡åˆ™ä¸å†é‡å¤ã€‚</p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>Tensorflow OP ä»£ç åˆ†æ</title>
    <url>/2023/09/22/note/Tensorflow%20C++%20op/</url>
    <content><![CDATA[<h1 id="Tensorflow-OP-ä»£ç åˆ†æ"><a href="#Tensorflow-OP-ä»£ç åˆ†æ" class="headerlink" title="Tensorflow OP ä»£ç åˆ†æ"></a>Tensorflow OP ä»£ç åˆ†æ</h1><p>[TOC]</p>
<h2 id="å¢åŠ ä¸€ä¸ªæ–°çš„op"><a href="#å¢åŠ ä¸€ä¸ªæ–°çš„op" class="headerlink" title="å¢åŠ ä¸€ä¸ªæ–°çš„op"></a>å¢åŠ ä¸€ä¸ªæ–°çš„op</h2><p>å¢åŠ ä¸€ä¸ªæ–°çš„opéœ€è¦é€šè¿‡<code>REGISTER_OP</code> å®è¿›è¡Œæ³¨å†Œï¼Œå¦‚ä¸‹ä»£ç æ‰€ç¤ºã€‚å®ä¸­å®šä¹‰äº†è¿™ä¸ªOPçš„è¾“å…¥ï¼Œè¾“å‡ºï¼Œattrå±æ€§ç­‰ã€‚åˆ›å»ºæ–‡ä»¶<code>tensorflow/core/user_ops/zero_out.cc</code>å¹¶è¾“å…¥å¦‚ä¸‹ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;ZeroOut&quot;</span>)</span><br><span class="line">    .<span class="built_in">Input</span>(<span class="string">&quot;to_zero: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">Output</span>(<span class="string">&quot;zeroed: int32&quot;</span>);</span><br></pre></td></tr></table></figure>

<blockquote>
<p>ZeroOutè¿™ä¸ªopåå­—å¿…é¡»æ˜¯å”¯ä¸€çš„ï¼Œè€Œä»¥ä¸‹åˆ’çº¿<code>_</code>å¼€å¤´çš„åå­—ä¸€èˆ¬æ˜¯ä¿ç•™å†…éƒ¨ä½¿ç”¨çš„</p>
</blockquote>
<h2 id="å¢åŠ OPçš„å®ç°"><a href="#å¢åŠ OPçš„å®ç°" class="headerlink" title="å¢åŠ OPçš„å®ç°"></a>å¢åŠ OPçš„å®ç°</h2><p>OPä»…ä»…æ˜¯å®šä¹‰äº†ä¸€ä¸ªæ¥å£ï¼Œè€Œä¸€ä¸ªOPå¯ä»¥æœ‰å¾ˆå¤šä¸ªå®ç°ï¼ŒåŒ…æ‹¬<code>CPU</code>, <code>GPU</code>ç­‰çš„å®ç°ï¼Œå¯ä»¥é€šè¿‡ç»§æ‰¿ä¸€ä¸ª<code>OpKernel </code>çš„ç±»ï¼Œå¹¶ä¸”é‡å†™<code>Compute</code>å‡½æ•°æ¥å®ç°ä¸€ä¸ªtensorflow OP implement. <code>Compute</code>å‡½æ•°æ¥æ”¶ä¸€ä¸ª<code>OpKernelContext</code>ç±»å‹çš„å‚æ•°ï¼Œèƒ½å¤Ÿé€šè¿‡å®ƒè·å–ç›¸å…³çš„opä¸Šä¸‹æ–‡ï¼Œä¾‹å¦‚è¾“å…¥ï¼Œç„¶åå¯¹å…¶è¿›è¡Œå¤„ç†ã€‚å¦‚ä¸‹æ˜¯ä¸€ä¸ªä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op_kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tensorflow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZeroOutOp</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ZeroOutOp</span><span class="params">(OpKernelConstruction* context)</span> : OpKernel(context) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Grab the input tensor</span></span><br><span class="line">    <span class="type">const</span> Tensor&amp; input_tensor = context-&gt;<span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">auto</span> input = input_tensor.<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an output tensor</span></span><br><span class="line">    Tensor* output_tensor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(context, context-&gt;<span class="built_in">allocate_output</span>(<span class="number">0</span>, input_tensor.<span class="built_in">shape</span>(),</span><br><span class="line">                                                     &amp;output_tensor));</span><br><span class="line">    <span class="keyword">auto</span> output = output_tensor-&gt;<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set all but the first element of the output tensor to 0.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N = input.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="built_in">output</span>(i) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Preserve the first input value if possible.</span></span><br><span class="line">    <span class="keyword">if</span> (N &gt; <span class="number">0</span>) <span class="built_in">output</span>(<span class="number">0</span>) = <span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„Computeå‡½æ•°éœ€è¦ä¿è¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå¦åˆ™å¯èƒ½ä¼šæœ‰ç«äº‰ã€‚</p>
</blockquote>
<p>åœ¨å®ç°å†…æ ¸ä¹‹åï¼Œå°†å…¶æ³¨å†Œåˆ°TensorFlowç³»ç»Ÿã€‚åœ¨æ³¨å†Œä¸­ï¼Œæ‚¨å¯ä»¥æŒ‡å®šè¿è¡Œè¯¥å†…æ ¸çš„ä¸åŒçº¦æŸã€‚ä¾‹å¦‚ï¼Œæ‚¨å¯èƒ½æœ‰ä¸€ä¸ªç”¨äºcpuçš„å†…æ ¸ï¼Œå¦ä¸€ä¸ªç”¨äºgpuçš„å†…æ ¸ã€‚éœ€è¦ä½¿ç”¨å¦‚ä¸‹å®åˆ°<code>zero_out.cc</code>æ–‡ä»¶ä¸­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_KERNEL_BUILDER</span>(<span class="built_in">Name</span>(<span class="string">&quot;ZeroOut&quot;</span>).<span class="built_in">Device</span>(DEVICE_CPU), ZeroOutOp);</span><br></pre></td></tr></table></figure>

<h2 id="Build-OP-åº“"><a href="#Build-OP-åº“" class="headerlink" title="Build OP åº“"></a>Build OP åº“</h2><p>éœ€è¦æœ¬åœ°å®‰è£…æœ‰g++ï¼Œç„¶åå¯¹<code>zero_out.cc</code>è¿›è¡Œç¼–è¯‘ï¼Œæ‰¾åˆ°<code>zero_out.cc</code>æ–‡ä»¶ï¼Œå¯¹å…¶è¿›è¡Œç¼–è¯‘</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">TF_CFLAGS=( $(python -c &#x27;import tensorflow as tf; print(&quot; &quot;.join(tf.sysconfig.get_compile_flags()))&#x27;) )</span><br><span class="line">TF_LFLAGS=( $(python -c &#x27;import tensorflow as tf; print(&quot; &quot;.join(tf.sysconfig.get_link_flags()))&#x27;) )</span><br><span class="line">g++ -std=c++11 -shared zero_out.cc -o zero_out.so -fPIC $&#123;TF_CFLAGS[@]&#125; $&#123;TF_LFLAGS[@]&#125; -O2</span><br></pre></td></tr></table></figure>

<p><code>zero_out.cc</code>å…¨éƒ¨å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op_kernel.h&quot;</span></span></span><br><span class="line"></span><br><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;ZeroOutzrf&quot;</span>).<span class="built_in">Input</span>(<span class="string">&quot;to_zero: int32&quot;</span>).<span class="built_in">Output</span>(<span class="string">&quot;zeroed: int32&quot;</span>);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tensorflow;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZeroOutOpZRF</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ZeroOutOpZRF</span><span class="params">(OpKernelConstruction* context)</span> : OpKernel(context) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Grab the input tensor</span></span><br><span class="line">    <span class="type">const</span> Tensor&amp; input_tensor = context-&gt;<span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">auto</span> input = input_tensor.<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an output tensor</span></span><br><span class="line">    Tensor* output_tensor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(context, context-&gt;<span class="built_in">allocate_output</span>(<span class="number">0</span>, input_tensor.<span class="built_in">shape</span>(),</span><br><span class="line">                                                     &amp;output_tensor));</span><br><span class="line">    <span class="keyword">auto</span> output = output_tensor-&gt;<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set all but the first element of the output tensor to 0.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N = input.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="built_in">output</span>(i) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Preserve the first input value if possible.</span></span><br><span class="line">    <span class="keyword">if</span> (N &gt; <span class="number">0</span>) <span class="built_in">output</span>(<span class="number">0</span>) = <span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="built_in">REGISTER_KERNEL_BUILDER</span>(<span class="built_in">Name</span>(<span class="string">&quot;ZeroOutzrf&quot;</span>).<span class="built_in">Device</span>(DEVICE_CPU), ZeroOutOpZRF);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ä½¿ç”¨bazelç¼–è¯‘æ“ä½œ"><a href="#ä½¿ç”¨bazelç¼–è¯‘æ“ä½œ" class="headerlink" title="ä½¿ç”¨bazelç¼–è¯‘æ“ä½œ"></a>ä½¿ç”¨bazelç¼–è¯‘æ“ä½œ</h2><p>å¦‚æœä½ å®‰è£…äº† TensorFlow æºç ï¼Œåˆ™ä½ å¯ä»¥åˆ©ç”¨ TensorFLow çš„æ„å»ºç³»ç»Ÿæ¥ç¼–è¯‘ä½ çš„æ“ä½œã€‚æŠŠä¸€ä¸ª BUILD æ–‡ä»¶æ”¾åœ¨<br><a href="https://www.tensorflow.org/code/tensorflow/core/user_ops/"><code>tensorflow/core/user_ops</code></a> ç›®å½•ä¸­ï¼Œå…¶ä¸­åŒ…å« Bazel çš„æ„å»ºè§„åˆ™ï¼Œå†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">load</span>(<span class="string">&quot;//tensorflow:tensorflow.bzl&quot;</span>, <span class="string">&quot;tf_custom_op_library&quot;</span>)</span><br><span class="line"></span><br><span class="line"><span class="built_in">tf_custom_op_library</span>(</span><br><span class="line">    name = <span class="string">&quot;zero_out.so&quot;</span>,</span><br><span class="line">    srcs = [<span class="string">&quot;zero_out.cc&quot;</span>],</span><br><span class="line">)</span><br></pre></td></tr></table></figure>

<p>è¿è¡Œä¸‹åˆ—å‘½ä»¤æ¥æ„å»º <code>zero_out.so</code>.</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">bazel build --config opt //tensorflow/core/user_ops:zero_out.so</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<blockquote>
<p>æ³¨æ„ï¼šè™½ç„¶ä½ å¯ä»¥ç”¨æ ‡å‡† <code>cc_library</code> è§„åˆ™æ¥ç”Ÿæˆä¸€ä¸ªå…±äº«åº“æ–‡ä»¶ï¼ˆ<code>.so</code> æ–‡ä»¶ï¼‰ï¼Œæˆ‘ä»¬è¿˜æ˜¯å¼ºçƒˆæ¨èä½¿ç”¨ <code>tf_custom_op_library</code> å®ã€‚è¿™ä¸ªå®åŠ äº†ä¸€äº›å¿…è¦çš„ä¾èµ–é¡¹ï¼Œè€Œä¸”è¿˜åŒ…å«ä¸€äº›æ£€æŸ¥ï¼Œä»¥ç¡®ä¿è¾“å‡ºçš„å…±äº«åº“æ–‡ä»¶ä¸ TensorFlow çš„æ’ä»¶åŠ è½½æœºåˆ¶å…¼å®¹ã€‚</p>
</blockquote>
<h2 id="æ¡ä»¶æ£€æŸ¥å’ŒéªŒè¯"><a href="#æ¡ä»¶æ£€æŸ¥å’ŒéªŒè¯" class="headerlink" title="æ¡ä»¶æ£€æŸ¥å’ŒéªŒè¯"></a>æ¡ä»¶æ£€æŸ¥å’ŒéªŒè¯</h2><p>ä¸Šè¿°ç¤ºä¾‹å‡å®šæ“ä½œé€‚ç”¨äºä»»æ„å½¢çŠ¶çš„å¼ é‡ã€‚ä½†å¦‚æœæˆ‘ä»¬åªå¤„ç†çŸ¢é‡å‘¢ï¼Ÿé‚£ä¹ˆæˆ‘ä»¬å°±éœ€è¦åœ¨ OpKernel çš„å®ç°ä¸­åŠ å…¥ä¸€ä¸ªæ£€æŸ¥ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="comment">// è·å¾—è¾“å…¥å¼ é‡</span></span><br><span class="line">  <span class="type">const</span> Tensor&amp; input_tensor = context-&gt;<span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OP_REQUIRES</span>(context, TensorShapeUtils::<span class="built_in">IsVector</span>(input_tensor.<span class="built_in">shape</span>()),</span><br><span class="line">              errors::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;ZeroOut expects a 1-D vector.&quot;</span>));</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œæˆ‘ä»¬åŠ äº†ä¸€ä¸ªæ–­è¨€ï¼Œå®ƒè¦æ±‚è¾“å…¥æ˜¯ä¸€ä¸ªçŸ¢é‡ï¼Œå¦åˆ™å°†è®¾ç½® <code>InvalidArgument</code> çŠ¶æ€ã€‚<a href="https://www.tensorflow.org/code/tensorflow/core/lib/core/errors.h"><code>OP_REQUIRES</code> å®</a> æœ‰ä¸‰ä¸ªå‚æ•°ï¼š</p>
<ul>
<li>ä¸Šä¸‹æ–‡ <code>context</code>ï¼šæ—¢å¯ä»¥æ˜¯ä¸€ä¸ª <code>OpKernelContext</code>ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ª <code>OpKernelConstruction</code> æŒ‡é’ˆï¼ˆå‚è§<br> <a href="https://www.tensorflow.org/code/tensorflow/core/framework/op_kernel.h"><code>tensorflow/core/framework/op_kernel.h</code></a> æ–‡ä»¶ï¼‰ï¼Œç”¨äºå…¶ <code>SetStatus()</code> æ–¹æ³•ã€‚</li>
<li>æ¡ä»¶ï¼šå…³äºéªŒè¯å¼ é‡å½¢çŠ¶çš„æ›´å¤šå‡½æ•°ï¼Œå‚è§æ–‡ä»¶<br> <a href="https://www.tensorflow.org/code/tensorflow/core/framework/tensor_shape.h"><code>tensorflow/core/framework/tensor_shape.h</code></a></li>
<li>é”™è¯¯æœ¬èº«ï¼šå®ƒç”±ä¸€ä¸ª <code>Status</code> å¯¹è±¡è¡¨ç¤ºï¼Œå‚è§æ–‡ä»¶<br> <a href="https://www.tensorflow.org/code/tensorflow/core/lib/core/status.h"><code>tensorflow/core/lib/core/status.h</code></a>ã€‚ä¸€ä¸ª <code>Status</code> å¯¹è±¡åŒ…å«ä¸€ä¸ªç±»å‹ï¼ˆå¸¸ä¸º <code>InvalidArgument</code>ï¼Œä½†èƒ½çœ‹åˆ°ç±»å‹åˆ—è¡¨ï¼‰å’Œä¸€æ¡æ¶ˆæ¯ã€‚æ„å»ºä¸€ä¸ªé”™è¯¯çš„å‡½æ•°å‚è§æ–‡ä»¶<br>  <a href="https://www.tensorflow.org/code/tensorflow/core/lib/core/errors.h"><code>tensorflow/core/lib/core/errors.h</code></a>ã€‚</li>
</ul>
<p>å¦å¤–ï¼Œå¦‚æœä½ æƒ³æµ‹è¯•ä»æŸä¸ªå‡½æ•°è¿”å›çš„ <code>Status</code> å¯¹è±¡æ˜¯å¦ä¸ºé”™è¯¯ï¼Œåˆ™ä½¿ç”¨å® <a href="https://www.tensorflow.org/code/tensorflow/core/lib/core/errors.h"><code>OP_REQUIRES_OK</code></a>ã€‚è¿™ä¸¤ä¸ªå®éƒ½ä¼šåœ¨é”™è¯¯æŠ¥é”™æ—¶è¿”å›é”™è¯¯å¯¹è±¡ã€‚</p>
<h2 id="å±æ€§"><a href="#å±æ€§" class="headerlink" title="å±æ€§"></a>å±æ€§</h2><p>æ“ä½œå¯ä»¥æœ‰å±æ€§ï¼Œå½“ä¸€ä¸ªæ“ä½œè¢«åŠ åˆ°è®¡ç®—å›¾ä¸­æ—¶ï¼Œå®ƒçš„å±æ€§å°±ä¼šè¢«èµ‹å€¼ã€‚è¿™äº›å±æ€§ç”¨äºé…ç½®æ­¤æ“ä½œï¼Œå®ƒä»¬çš„å€¼æ—¢å¯ä»¥åœ¨å†…æ ¸å®ç°ä¸­è®¿é—®ï¼Œä¹Ÿå¯ä»¥åœ¨æ“ä½œæ³¨å†Œæ—¶çš„è¾“å…¥è¾“å‡ºç±»å‹ä¸­è¿›è¡Œè®¿é—®ã€‚ç›¸è¾ƒäºè¾“å…¥ï¼Œå‚æ•°çš„ä½¿ç”¨è¦å°½é‡é¿å…ï¼Œå› ä¸ºè¾“å…¥æ›´ä¸ºçµæ´»ä¸€äº›ã€‚è¿™æ˜¯å› ä¸ºå±æ€§æ˜¯å¸¸æ•°ï¼Œ<br>å¿…é¡»åœ¨è®¡ç®—å›¾æ„é€ æ—¶å®šä¹‰ã€‚ç›¸åï¼Œè¾“å…¥ä½œä¸ºå¼ é‡ï¼Œå®ƒçš„å€¼æ˜¯åŠ¨æ€çš„ï¼›å³è¾“å…¥çš„å€¼åœ¨æ¯ä¸€æ­¥éƒ½å¯ä»¥ä¿®æ”¹ï¼Œæ¯”å¦‚ä½¿ç”¨ feedã€‚å±æ€§ä¸»è¦ç”¨äºæ— æ³•ä½¿ç”¨è¾“å…¥çš„åœºåˆï¼šä»»ä½•å½±å“ç‰¹å¾ï¼ˆè¾“å…¥è¾“å‡ºçš„æ•°é‡å’Œç±»å‹ï¼‰çš„é…ç½®ï¼Œæˆ–æ— æ³•åœ¨æ¯ä¸€æ­¥ä¿®æ”¹çš„æ—¶å€™ã€‚</p>
<p>ä½ éœ€è¦åœ¨æ³¨å†Œæ“ä½œæ—¶å®šä¹‰å±æ€§ï¼Œå®šä¹‰æ—¶è¦æŒ‡å®šåç§°å’Œä½¿ç”¨ <code>Attr</code> æ–¹æ³•çš„ç±»å‹ï¼Œæ­¤æ–¹æ³•çš„å‚æ•°è§„èŒƒå¦‚ä¸‹ï¼š</p>
<figure class="highlight xml"><table><tr><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">name</span>&gt;</span>: <span class="tag">&lt;<span class="name">attr-type-expr</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>å…¶ä¸­ <code>&lt;name&gt;</code> ä»¥å­—æ¯å¼€å¤´ï¼Œç”±æ•°å­—ã€å­—æ¯å’Œä¸‹åˆ’çº¿ç»„æˆï¼Œè€Œ <code>&lt;attr-type-expr&gt;</code> ä¸€ä¸ªç±»å‹è¡¨è¾¾å¼ï¼ˆå‚è§<a href="https://tensorflow.juejin.im/extend/adding_an_op.html#attr_types">ä¸‹æ–¹</a>ï¼‰ã€‚</p>
<p>æ¯”å¦‚ï¼Œå¦‚æœä½ æƒ³è®© <code>ZeroOut</code> æ“ä½œä¿ç•™ç”¨æˆ·æŒ‡å®šçš„ç´¢å¼•ï¼Œè€Œä¸æ˜¯ä»…ä¿ç•™ç¬¬ 0 ä¸ªå…ƒç´ ï¼Œä½ å¯ä»¥æŒ‰ä¸‹é¢çš„æ–¹å¼æ¥æ³¨å†Œæ“ä½œï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;ZeroOut&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;preserve_index: int&quot;</span>)</span><br><span class="line">    .<span class="built_in">Input</span>(<span class="string">&quot;to_zero: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">Output</span>(<span class="string">&quot;zeroed: int32&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><a href="https://www.tensorflow.org/api_docs/python/tf/DType"><code>tf.DType</code></a></p>
<p>ä½ å®ç°çš„å†…æ ¸å¯ä»¥åœ¨æ„é€ å‡½æ•°ä¸­é€šè¿‡ <code>context</code> å‚æ•°æ¥è®¿é—®å±æ€§ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">ZeroOutOp</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ZeroOutOp</span><span class="params">(OpKernelConstruction* context)</span> : OpKernel(context) &#123;</span></span><br><span class="line">    <span class="comment">// è·å–å¾…ä¿å­˜çš„ç´¢å¼•å€¼</span></span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(context,</span><br><span class="line">                   context-&gt;<span class="built_in">GetAttr</span>(<span class="string">&quot;preserve_index&quot;</span>, &amp;preserve_index_));</span><br><span class="line">    <span class="comment">// æ£€æŸ¥ preserve_index æ˜¯å¦ä¸ºæ­£å€¼</span></span><br><span class="line">    <span class="built_in">OP_REQUIRES</span>(context, preserve_index_ &gt;= <span class="number">0</span>,</span><br><span class="line">                errors::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;Need preserve_index &gt;= 0, got &quot;</span>,</span><br><span class="line">                                        preserve_index_));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> preserve_index_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿˜å¯ä»¥åœ¨ <code>Compute</code> æ–¹æ³•ä¸­ä½¿ç”¨è¿™ä¸ªå‚æ•°ï¼š</p>
<figure class="highlight cpp"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æˆ‘ä»¬ç”¨ä¿å­˜çš„å±æ€§æ¥æ£€æŸ¥åŠ¨æ€è¾“å…¥çš„åˆæ³•æ€§</span></span><br><span class="line">  <span class="comment">// æ‰€ä»¥ï¼Œæˆ‘ä»¬æ£€æŸ¥ preserve_index æ˜¯å¦åœ¨å…è®¸çš„å€¼åŸŸèŒƒå›´å†…</span></span><br><span class="line">  <span class="built_in">OP_REQUIRES</span>(context, preserve_index_ &lt; input.<span class="built_in">dimension</span>(<span class="number">0</span>),</span><br><span class="line">              errors::<span class="built_in">InvalidArgument</span>(<span class="string">&quot;preserve_index out of range&quot;</span>));</span><br><span class="line">  <span class="comment">// å°†è¾“å‡ºå¼ é‡ä¸­æ‰€æœ‰å…ƒç´ è®¾ç½®ä¸º 0</span></span><br><span class="line">  <span class="type">const</span> <span class="type">int</span> N = input.<span class="built_in">size</span>();</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</span><br><span class="line">    <span class="built_in">output_flat</span>(i) = <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// ä¿å­˜æŒ‡å®šä½ç½®çš„è¾“å…¥å€¼</span></span><br><span class="line">  <span class="built_in">output_flat</span>(preserve_index_) = <span class="built_in">input</span>(preserve_index_);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="å±æ€§ç±»å‹"><a href="#å±æ€§ç±»å‹" class="headerlink" title="å±æ€§ç±»å‹"></a>å±æ€§ç±»å‹</h3><p>å±æ€§æ”¯æŒä¸‹åˆ—æ•°æ®ç±»å‹ï¼š</p>
<ul>
<li><code>string</code>ï¼šä»»æ„å­—èŠ‚åºåˆ—ï¼ˆä¸è¦æ±‚æ˜¯ UTF8 ç¼–ç ï¼‰</li>
<li><code>int</code>ï¼šæœ‰ç¬¦å·æ•´æ•°</li>
<li><code>float</code>: æµ®ç‚¹æ•°</li>
<li><code>bool</code>: True æˆ– false</li>
<li><code>type</code>ï¼š <a href="https://www.tensorflow.org/code/tensorflow/core/framework/types.cc"><code>DataType</code></a> çš„å…¶ä¸­ä¸€ä¸ªï¼ˆéå¼•ç”¨ï¼‰å€¼</li>
<li><code>shape</code>ï¼šä¸€ä¸ª <a href="https://www.tensorflow.org/code/tensorflow/core/framework/tensor_shape.proto"><code>TensorShapeProto</code></a></li>
<li><code>tensor</code>ï¼šä¸€ä¸ª <a href="https://www.tensorflow.org/code/tensorflow/core/framework/tensor.proto"><code>TensorProto</code></a></li>
<li><code>list(&lt;type&gt;)</code>ï¼š <code>&lt;type&gt;</code> çš„åˆ—è¡¨ï¼Œå…¶ä¸­ <code>&lt;type&gt;</code> ä¸ºå…¶ä¸­ä¸€ç§ä¸Šè¿°ç±»å‹<br> æ³¨æ„ï¼š <code>list(list(&lt;type&gt;))</code> æ˜¯éæ³•çš„ã€‚</li>
</ul>
<p>æ¬²äº†è§£é™å®šæ€§åˆ—è¡¨ï¼Œå‚è§ <a href="https://www.tensorflow.org/code/tensorflow/core/framework/op_def_builder.cc"><code>op_def_builder.cc:FinalizeAttr</code></a>ã€‚</p>
<h3 id="é»˜è®¤å€¼å’Œçº¦æŸ"><a href="#é»˜è®¤å€¼å’Œçº¦æŸ" class="headerlink" title="é»˜è®¤å€¼å’Œçº¦æŸ"></a>é»˜è®¤å€¼å’Œçº¦æŸ</h3><p>å±æ€§å¯ä»¥æœ‰é»˜è®¤å€¼ï¼Œæœ‰ä¸€äº›å±æ€§åˆ™è¿˜å¯ä»¥æœ‰çº¦æŸã€‚ä¸ºäº†å®šä¹‰ä¸€ä¸ªæœ‰çº¦æŸçš„å±æ€§ï¼Œå¯ä»¥ä½¿ç”¨ä¸‹åˆ—å±æ€§ç±»å‹è¡¨è¾¾å¼ï¼ˆ<code>&lt;attr-type-expr&gt;</code>ï¼‰ï¼š</p>
<ul>
<li><p><code>{&#39;&lt;string1&gt;&#39;, &#39;&lt;string2&gt;&#39;}</code>ï¼šè¡¨ç¤ºåœ¨ <code>&lt;string1&gt;</code> æˆ– <code>&lt;string2&gt;</code> è¿™ä¸¤ç§å–å€¼ä¸­äºŒé€‰ä¸€ã€‚å½“ä½ ä½¿ç”¨è¿™ç§è¯­æ³•æ—¶ï¼Œç³»ç»Ÿè‡ªåŠ¨æ¨æ–­å‡ºå±æ€§ç±»å‹ä¸º <code>string</code>ã€‚è¿™ç›¸å½“äºæ¨¡ä»¿æ„é€ äº†ä¸€ä¸ªæšä¸¾ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;EnumExample&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;e: &#123;&#x27;apple&#x27;, &#x27;orange&#x27;&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><a href="https://www.tensorflow.org/api_docs/python/tf/DType"><code>tf.DType</code></a></p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;RestrictedTypeExample&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;t: &#123;int32, float, bool&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p>å¸¸ç”¨çš„ç±»å‹çº¦æŸå¯ä»¥æœ‰å¦‚ä¸‹åˆ«åï¼š</p>
<ul>
<li><p><code>numbertype</code>ï¼š<code>type</code> ç±»å‹è¢«é™åˆ¶ä¸ºæ•°å€¼ç±»å‹ï¼ˆä¸æ˜¯å­—ç¬¦ä¸²ï¼Œä¹Ÿä¸æ˜¯å¸ƒå°”ç±»å‹ï¼‰</p>
</li>
<li><p><code>realnumbertype</code>ï¼šç±»ä¼¼äº <code>numbertype</code> ç±»å‹ï¼Œä½†ä¸åŒ…æ‹¬å¤æ•°ç±»å‹</p>
</li>
<li><p><code>quantizedtype</code>ï¼šç±»å‹äº <code>numbertype</code> ç±»å‹ï¼Œä½†åªåŒ…æ‹¬é‡åŒ–æ•°å€¼ç±»å‹</p>
<p>å±æ€§æ‰€æ”¯æŒçš„ç±»å‹åˆ—è¡¨å¯é€šè¿‡ <a href="https://www.tensorflow.org/code/tensorflow/core/framework/types.h"><code>tensorflow/core/framework/types.h</code></a> ä¸­çš„ä¸€äº›å‡½æ•°æ¥å®šä¹‰ï¼ˆæ¯”å¦‚ <code>NumberTypes()</code>ï¼‰ã€‚åœ¨æœ¬ä¾‹ä¸­ï¼Œå±æ€§ <code>t</code> å¿…é¡»æ˜¯ä¸‹é¢ä¸€ç§æ•°å€¼ç±»å‹ï¼š</p>
</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;NumberType&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;t: numbertype&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>  å¯¹äºè¿™ä¸ªæ“ä½œï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf.number_type(t=tf.int32)  <span class="comment"># åˆæ³•</span></span><br><span class="line">tf.number_type(t=tf.<span class="built_in">bool</span>)   <span class="comment"># ä¸åˆæ³•</span></span><br></pre></td></tr></table></figure>

<p>  åˆ—è¡¨å¯ä»¥å’Œå…¶ä»–åˆ—è¡¨åŠå•ä¸€ç±»å‹ç»„åˆã€‚ä¸‹é¢çš„æ“ä½œå…è®¸å±æ€§ <code>t</code> ä¸ºä»»æ„æ•°å€¼ç±»å‹æˆ–å¸ƒå°”ç±»å‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;NumberOrBooleanType&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;t: &#123;numbertype, bool&#125;&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>  å¯¹äºè¿™ä¸ªæ“ä½œï¼š</p>
<figure class="highlight python"><table><tr><td class="code"><pre><span class="line">tf.number_or_boolean_type(t=tf.int32)  <span class="comment"># åˆæ³•</span></span><br><span class="line">tf.number_or_boolean_type(t=tf.<span class="built_in">bool</span>)   <span class="comment"># åˆæ³•</span></span><br><span class="line">tf.number_or_boolean_type(t=tf.string) <span class="comment"># ä¸åˆæ³•</span></span><br></pre></td></tr></table></figure>
</li>
<li><p><code>int &gt;= &lt;n&gt;</code>ï¼šå–å€¼å¿…é¡»æ˜¯æ•´å‹ï¼Œä¸”è¦æ±‚å¤§äºç­‰äº <code>&lt;n&gt;</code>ï¼Œå…¶ä¸­ <code>&lt;n&gt;</code> æ˜¯ä¸€ä¸ªè‡ªç„¶æ•°ã€‚</p>
<p> æ¯”å¦‚ï¼Œä¸‹åˆ—æ“ä½œæ³¨å†Œä¸­ï¼ŒæŒ‡å®šäº†å±æ€§ <code>a</code> å¿…é¡»ä¸ºä¸€ä¸ªè‡³å°‘ä¸º <code>2</code> çš„å€¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;MinIntExample&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;a: int &gt;= 2&quot;</span>);</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>list(&lt;type&gt;) &gt;= &lt;n&gt;</code>: å–å€¼ä¸º<code>&lt;type&gt;</code> ç±»å‹çš„ä¸€ä¸ªåˆ—è¡¨ï¼Œå…¶é•¿åº¦å¤§äºç­‰äº <code>&lt;n&gt;</code>ã€‚</p>
<p> æ¯”å¦‚ï¼Œä¸‹åˆ—æ“ä½œæ³¨å†ŒæŒ‡å®šå±æ€§ <code>a</code> æ˜¯ä¸€ä¸ªç±»å‹åˆ—è¡¨ï¼ˆè¦ä¹ˆæ˜¯ <code>int32</code>ï¼Œè¦ä¹ˆæ˜¯ <code>float</code>ï¼‰ï¼Œä¸”è¦æ±‚é•¿åº¦å¤§äºç­‰äº <code>3</code>ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;TypeListExample&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;a: list(&#123;int32, float&#125;) &gt;= 3&quot;</span>);</span><br></pre></td></tr></table></figure></li>
</ul>
<p>ä¸ºè®¾ç½®ä¸€ä¸ªå±æ€§çš„é»˜è®¤å€¼ï¼ˆè®©å®ƒåœ¨ç”Ÿæˆä»£ç ä¸­æˆä¸ºå¯é€‰é¡¹ï¼‰ï¼Œå¯ä»¥åœ¨æœ€ååŠ ä¸Š <code>= &lt;default&gt;</code>ï¼Œå¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;AttrDefaultExample&quot;</span>)</span><br><span class="line">    .<span class="built_in">Attr</span>(<span class="string">&quot;i: int = 0&quot;</span>);</span><br></pre></td></tr></table></figure>

<p>è¿™ç§é»˜è®¤å€¼çš„æ”¯æŒè¯­æ³•æ­£æ˜¯è®¡ç®—å›¾çš„ GraphDef å®šä¹‰çš„åè®®ç¼“å­˜è¡¨è¾¾ä¸­æ‰€ç”¨çš„è¯­æ³•ã€‚</p>
<p>ä¸‹é¢çš„ç¤ºä¾‹å±•ç¤ºå¦‚ä½•ä¸ºæ‰€æœ‰ç±»å‹æŒ‡å®šé»˜è®¤å€¼ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;AttrDefaultExampleForAllTypes&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;s: string = &#x27;foo&#x27;&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;i: int = 0&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;f: float = 1.0&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;b: bool = true&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;ty: type = DT_INT32&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;sh: shape = &#123; dim &#123; size: 1 &#125; dim &#123; size: 2 &#125; &#125;&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;te: tensor = &#123; dtype: DT_INT32 int_val: 5 &#125;&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;l_empty: list(int) = []&quot;</span>)</span><br><span class="line">   .<span class="built_in">Attr</span>(<span class="string">&quot;l_int: list(int) = [2, 3, 5, 7]&quot;</span>);</span><br></pre></td></tr></table></figure>

<p><a href="https://www.tensorflow.org/api_docs/python/tf/DType"><code>tf.DType</code></a></p>
<h1 id="OPæºç éƒ¨åˆ†"><a href="#OPæºç éƒ¨åˆ†" class="headerlink" title="OPæºç éƒ¨åˆ†"></a>OPæºç éƒ¨åˆ†</h1><h2 id="REGISTER-OP"><a href="#REGISTER-OP" class="headerlink" title="REGISTER_OP"></a>REGISTER_OP</h2><p> operator(op)æ˜¯tensorflowæ‰©å±•åŠŸèƒ½çš„çš„æ–¹å¼ã€‚OPåˆ†ä¸ºå£°æ˜å’Œå®šä¹‰ã€‚å£°æ˜å«op,å®ç°å«kernel.ä¸€ä¸ªå£°æ˜å¯ä»¥æœ‰å¤šä¸ªå®ç°ã€‚æˆ–è€…è¯´åœ¨ä¸åŒè®¾å¤‡ä¸Šçš„ä¸åŒå®ç°ã€‚OPéœ€è¦æ³¨å†Œã€‚</p>
<p>æ—¶åˆ»æ³¨æ„ï¼ŒOPåªæ˜¯ä¸€ä¸ªå£°æ˜ã€‚å¦‚åŒC++çš„å‡½æ•°å£°æ˜ã€‚å¹¶ä¸æ¶‰åŠè¿™äº›OPå¦‚ä½•å®ç°ã€‚æ¯”å¦‚å¯ä»¥å£°æ˜ä¸€ä¸ªOPå«Addï¼Œå…¶åŠŸèƒ½æ˜¯å¯ä»¥åšä¸¤ä¸ªæ•°çš„åŠ æ³•int Add(int a, int b); è€Œè¿™ä¸ªå£°æ˜ç”¨ä¸€ä¸ªproto messageè¡¨ç¤ºå°±æ˜¯message OpDefã€‚è€Œå›¾å°±æ˜¯å¤šä¸ªOPçš„è¾“å…¥è¾“å‡ºé¦–å°¾ç›¸æ¥ç»„æˆçš„æœ‰å‘æ— ç¯å›¾ï¼Œè¿™ä¸ªå›¾å®é™…ä¸Šè¡¨ç¤ºäº†å‡½æ•°çš„è°ƒç”¨å…³ç³»ã€‚</p>
<h2 id="OPæ³¨å†Œä¸­å¿ƒæ¥å£"><a href="#OPæ³¨å†Œä¸­å¿ƒæ¥å£" class="headerlink" title="OPæ³¨å†Œä¸­å¿ƒæ¥å£"></a>OPæ³¨å†Œä¸­å¿ƒæ¥å£</h2><p>åªæä¾›äº†æ ¹æ®åå­—æŸ¥æ‰¾OPçš„æ¥å£ã€‚tensorflow&#x2F;core&#x2F;framework&#x2F;op.h</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OpRegistryInterface</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">OpRegistryInterface</span>();</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> Status <span class="title">LookUp</span><span class="params">(<span class="type">const</span> std::string&amp; op_type_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                        <span class="type">const</span> OpRegistrationData** op_reg_data)</span> <span class="type">const</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">LookUpOpDef</span><span class="params">(<span class="type">const</span> std::string&amp; op_type_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                     <span class="type">const</span> OpDef** op_def)</span> <span class="type">const</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">//å®é™…çš„ä¸€ä¸ªå®ç°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpRegistry</span> : <span class="keyword">public</span> OpRegistryInterface &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">typedef</span> std::function&lt;Status(OpRegistrationData*)&gt; OpRegistrationDataFactory;</span><br><span class="line"></span><br><span class="line">  <span class="built_in">OpRegistry</span>();</span><br><span class="line">  ~<span class="built_in">OpRegistry</span>() <span class="keyword">override</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Register</span><span class="params">(<span class="type">const</span> OpRegistrationDataFactory&amp; op_data_factory)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">Status <span class="title">LookUp</span><span class="params">(<span class="type">const</span> std::string&amp; op_type_name,</span></span></span><br><span class="line"><span class="params"><span class="function">                <span class="type">const</span> OpRegistrationData** op_reg_data)</span> <span class="type">const</span> <span class="keyword">override</span></span>;</span><br><span class="line">  <span class="keyword">mutable</span> mutex mu_;</span><br><span class="line">  <span class="comment">// Functions in deferred_ may only be called with mu_ held.</span></span><br><span class="line">  <span class="function"><span class="keyword">mutable</span> std::vector&lt;OpRegistrationDataFactory&gt; deferred_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line">  <span class="comment">// Values are owned.</span></span><br><span class="line">  <span class="function"><span class="keyword">mutable</span> std::unordered_map&lt;string, <span class="type">const</span> OpRegistrationData*&gt; registry_</span></span><br><span class="line"><span class="function">      <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>; <span class="comment">//opå°±æ˜¯æ³¨å†Œåœ¨è¿™é‡Œäº†</span></span><br><span class="line">  <span class="function"><span class="keyword">mutable</span> <span class="type">bool</span> initialized_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Registry watcher.</span></span><br><span class="line">  <span class="function"><span class="keyword">mutable</span> Watcher watcher_ <span class="title">TF_GUARDED_BY</span><span class="params">(mu_)</span></span>;</span><br><span class="line"></span><br><span class="line">  std::function&lt;Status(<span class="type">const</span> OpRegistryInterface&amp;)&gt; op_registry_validator_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>çœ‹è¿™å‡ ä¸ªæ¥å£å¾ˆç®€å•ï¼Œä½†æ˜¯å…¶å‚æ•°OpDef, OpRegistrationDataå¾ˆå¤æ‚ã€‚</p>
<h2 id="OpDef"><a href="#OpDef" class="headerlink" title="OpDef"></a>OpDef</h2><p>ä¸€ä¸ªopæœ‰å¤šä¸ªè¾“å…¥å‚æ•°ï¼Œå’Œå¤šä¸ªè¾“å…¥å±æ€§ï¼Œè¿˜æœ‰å¤šä¸ªè¾“å‡ºå‚æ•°ï¼Œå¤šä¸ªæ§åˆ¶è¾“å‡ºã€‚å®ƒä»¬éƒ½æ˜¯Tensorã€‚</p>
<p>è¾“å…¥å±æ€§çš„å€¼åœ¨æ„å›¾æ—¶å·²ç»ç¡®å®šä¸å˜äº†ã€‚è€Œè¾“å…¥å‚æ•°æ˜¯æ‰§è¡Œå›¾æ—¶å˜åŒ–æ•°æ®ã€‚</p>
<p><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/image-20240320181116772.png" alt="image-20240320181116772"></p>
<p>class OpDef æ˜¯å®šä¹‰åœ¨protoä¸­çš„ã€‚tensorflow&#x2F;core&#x2F;framework&#x2F;op_def.proto</p>
<p>è¿™ä¸ªprotoå°±å£°æ˜äº†ä¸ªOP.å®é™…ä¸Šå°±æ˜¯æŠŠè¾“å…¥è¾“å‡ºå‚æ•°ï¼ŒOPåå­—ç­‰ç­‰å…ƒä¿¡æ¯ä¿å­˜ä¸‹æ¥ã€‚</p>
<figure class="highlight protobuf"><table><tr><td class="code"><pre><span class="line"><span class="keyword">message </span><span class="title class_">OpDef</span> &#123;</span><br><span class="line"></span><br><span class="line">  <span class="type">string</span> name = <span class="number">1</span>; <span class="comment">// opåå­—</span></span><br><span class="line">  <span class="keyword">message </span><span class="title class_">ArgDef</span> &#123; <span class="comment">// opè¾“å…¥è¾“å‡ºå‚æ•°</span></span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> description = <span class="number">2</span>;</span><br><span class="line">    DataType type = <span class="number">3</span>;</span><br><span class="line">    <span class="type">string</span> type_attr = <span class="number">4</span>;    <span class="comment">// if specified, attr must have type &quot;type&quot;</span></span><br><span class="line">    <span class="type">string</span> number_attr = <span class="number">5</span>;  <span class="comment">// if specified, attr must have type &quot;int&quot;</span></span><br><span class="line">    <span class="type">string</span> type_list_attr = <span class="number">6</span>;</span><br><span class="line">    <span class="keyword">repeated</span> ResourceHandleProto.DtypeAndShape handle_data = <span class="number">7</span>;</span><br><span class="line">    <span class="type">bool</span> is_ref = <span class="number">16</span>;</span><br><span class="line">    FullTypeDef experimental_full_type = <span class="number">17</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">repeated</span> ArgDef input_arg = <span class="number">2</span>;</span><br><span class="line">  <span class="keyword">repeated</span> ArgDef output_arg = <span class="number">3</span>;</span><br><span class="line">  <span class="keyword">repeated</span> <span class="type">string</span> control_output = <span class="number">20</span>; <span class="comment">//æ§åˆ¶å‚æ•°</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">message </span><span class="title class_">AttrDef</span> &#123;   <span class="comment">//opå±æ€§ï¼Œæ„å›¾æ—¶å·²ç»ç¡®å®šä¸å˜</span></span><br><span class="line"></span><br><span class="line">    <span class="type">string</span> name = <span class="number">1</span>;</span><br><span class="line">    <span class="type">string</span> type = <span class="number">2</span>;</span><br><span class="line">    AttrValue default_value = <span class="number">3</span>;</span><br><span class="line">    <span class="type">string</span> description = <span class="number">4</span>;</span><br><span class="line">    <span class="type">bool</span> has_minimum = <span class="number">5</span>;</span><br><span class="line">    <span class="type">int64</span> minimum = <span class="number">6</span>;</span><br><span class="line"></span><br><span class="line">    AttrValue allowed_values = <span class="number">7</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">repeated</span> AttrDef attr = <span class="number">4</span>; <span class="comment">//å±æ€§</span></span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">OpDeprecation</span> &#123;</span><br><span class="line">  <span class="type">int32</span> version = <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">  <span class="type">string</span> explanation = <span class="number">2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">message </span><span class="title class_">OpList</span> &#123;  <span class="comment">//ä¸€ç»„op</span></span><br><span class="line">  <span class="keyword">repeated</span> OpDef op = <span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="OpDefBuilderæ¥ç”ŸæˆOP"><a href="#OpDefBuilderæ¥ç”ŸæˆOP" class="headerlink" title="OpDefBuilderæ¥ç”ŸæˆOP"></a>OpDefBuilderæ¥ç”ŸæˆOP</h2><p>Builderå¯ä»¥é€šè¿‡ç‰¹å®šè¯­æ³•æ ¼å¼çš„å­—ç¬¦ä¸²æ¥æ·»åŠ  è¾“å…¥å‚æ•°ï¼Œè¾“å‡ºå‚æ•°ç­‰ã€‚æ·»åŠ å®Œæˆåè°ƒç”¨Finalize(OpRegistrationData* op_reg_data)ç”Ÿæˆäº†OpRegistrationData. OpRegistrationDataæœ‰OpDef</p>
<p>tensorflow&#x2F;core&#x2F;framework&#x2F;op_def_builder.h</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">// Builder class passed to the REGISTER_OP() macro.</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpDefBuilder</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OpDefBuilder</span><span class="params">(std::string op_name)</span></span>;</span><br><span class="line">  <span class="comment">//å®šä¹‰å±æ€§</span></span><br><span class="line">  <span class="function">OpDefBuilder&amp; <span class="title">Attr</span><span class="params">(std::string spec)</span></span>;</span><br><span class="line">  <span class="comment">//å®šä¹‰è¾“å…¥è¾“å‡º</span></span><br><span class="line">  <span class="function">OpDefBuilder&amp; <span class="title">Input</span><span class="params">(std::string spec)</span></span>;</span><br><span class="line">  <span class="function">OpDefBuilder&amp; <span class="title">Output</span><span class="params">(std::string spec)</span></span>;</span><br><span class="line"></span><br><span class="line">  OpRegistrationData op_reg_data_;</span><br><span class="line">  std::vector&lt;string&gt; attrs_;</span><br><span class="line">  std::vector&lt;string&gt; inputs_;</span><br><span class="line">  std::vector&lt;string&gt; outputs_;</span><br><span class="line">  std::vector&lt;string&gt; control_outputs_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>Opæ³¨å†ŒåŸç†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;ZeroOut&quot;</span>)</span><br><span class="line">    .<span class="built_in">Input</span>(<span class="string">&quot;to_zero: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">Output</span>(<span class="string">&quot;zeroed: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">SetShapeFn</span>([](::tensorflow::shape_inference::InferenceContext* c) &#123;</span><br><span class="line">      c-&gt;<span class="built_in">set_output</span>(<span class="number">0</span>, c-&gt;<span class="built_in">input</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;);</span><br></pre></td></tr></table></figure>

<p>REGISTER_OPå®ï¼Œå®é™…ä¸Šå®šä¹‰äº†å¦‚ä¸‹çš„OpDefBuilderWrapperçš„å¯¹è±¡ã€‚</p>
<p>åç»­è°ƒç”¨çš„.Input, .Output,ç­‰éƒ½æ˜¯å¯¹æ­¤å¯¹è±¡ä¸­çš„Input, Outputçš„æ–¹æ³•çš„è°ƒç”¨ã€‚è€ŒInputé‡Œå®ç°ä¸Šè½¬è€Œè°ƒç”¨äº†OpDefBuilderçš„Inputã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">namespace</span> register_op &#123;</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpDefBuilderWrapper</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OpDefBuilderWrapper</span><span class="params">(<span class="type">const</span> <span class="type">char</span> name[])</span> : builder_(name) &#123;</span>&#125;</span><br><span class="line">  <span class="comment">//å±æ€§</span></span><br><span class="line">  <span class="function">OpDefBuilderWrapper&amp; <span class="title">Attr</span><span class="params">(std::string spec)</span> </span>&#123;</span><br><span class="line">    builder_.<span class="built_in">Attr</span>(std::<span class="built_in">move</span>(spec));</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è¾“å…¥</span></span><br><span class="line">  <span class="function">OpDefBuilderWrapper&amp; <span class="title">Input</span><span class="params">(std::string spec)</span> </span>&#123;</span><br><span class="line">    builder_.<span class="built_in">Input</span>(std::<span class="built_in">move</span>(spec));</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">//è¾“å‡º</span></span><br><span class="line">  <span class="function">OpDefBuilderWrapper&amp; <span class="title">Output</span><span class="params">(std::string spec)</span> </span>&#123;</span><br><span class="line">    builder_.<span class="built_in">Output</span>(std::<span class="built_in">move</span>(spec));</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ä¸‹æ–‡ä¸­æåˆ°çš„InitOnStartupMarker ä¸­è°ƒç”¨äº†è¿™ä¸ª</span></span><br><span class="line">  <span class="function">InitOnStartupMarker <span class="title">operator</span><span class="params">()</span><span class="params">()</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="keyword">mutable</span> ::tensorflow::OpDefBuilder builder_;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_OP_IMPL(ctr, name, is_system_op)                         \</span></span><br><span class="line"><span class="meta">  static ::tensorflow::InitOnStartupMarker const register_op##ctr         \</span></span><br><span class="line"><span class="meta">      TF_ATTRIBUTE_UNUSED =                                               \</span></span><br><span class="line"><span class="meta">          TF_INIT_ON_STARTUP_IF(is_system_op || SHOULD_REGISTER_OP(name)) \</span></span><br><span class="line"><span class="meta">          &lt;&lt; ::tensorflow::register_op::OpDefBuilderWrapper(name)</span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_OP(name)        \</span></span><br><span class="line"><span class="meta">  TF_ATTRIBUTE_ANNOTATE(<span class="string">&quot;tf:op&quot;</span>) \</span></span><br><span class="line"><span class="meta">  TF_NEW_ID_FOR_INIT(REGISTER_OP_IMPL, name, false)</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_SYSTEM_OP(name)        \</span></span><br><span class="line"><span class="meta">  TF_ATTRIBUTE_ANNOTATE(<span class="string">&quot;tf:op&quot;</span>)        \</span></span><br><span class="line"><span class="meta">  TF_ATTRIBUTE_ANNOTATE(<span class="string">&quot;tf:op:system&quot;</span>) \</span></span><br><span class="line"><span class="meta">  TF_NEW_ID_FOR_INIT(REGISTER_OP_IMPL, name, true)</span></span><br><span class="line"></span><br><span class="line">&#125; </span><br></pre></td></tr></table></figure>

<ul>
<li>REGISTER_OPè¿™ä¸ªå®è°ƒç”¨TF_NEW_ID_FOR_INIT. ä¼šä½¿ç”¨__COUNTER__å®ç”Ÿæˆå”¯ä¸€ID.</li>
<li>è°ƒç”¨REGISTER_OP_IMPLEæ—¶ï¼Œå‚æ•°ctrå°±æ˜¯counterã€‚</li>
<li>REGISTER_OP_IMPLEæ‰€æœ‰å®šä¹‰äº†ä¸€ä¸ªstaticå˜é‡ã€‚å˜é‡ç±»å‹æ˜¯ tensorlfow::InitOnStartUpMarkerã€‚å˜é‡åæ˜¯register_op##ctr,å®é™…ä¸Šå°±æ˜¯register_op0, register_op1, â€¦.</li>
<li>TF_INIT_ON_STARTUP_IFå®å¦‚æœå‚æ•°æ˜¯false,åˆ™ä»€ä¹ˆä¹Ÿä¸åšï¼Œå¦åˆ™ è°ƒç”¨åè¾¹çš„&lt;&lt; OpeDefBuilderã€‚è¿™ä¸ªå®æ ¹ç›¸å½“äºï¼š!cond ? InitOnStartupMarker{} : (InitOnStartupMarker{} &lt;&lt; f);  få°±æ˜¯::tensorflow::register_op::OpDefBuilderWrapper(name)ã€‚å› ä¸ºInitOnStartUpmarkeré‡è½½äº†operator&lt;&lt;ã€‚</li>
<li>åœ¨ä¸‹å›¾ä»£ç InitOpStartupMarkeré‡Œè°ƒç”¨äº†OpDefBuilderWrapperçš„Operator()æ–¹æ³•ã€‚</li>
</ul>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">InitOnStartupMarker</span> &#123;</span><br><span class="line">  <span class="keyword">constexpr</span> InitOnStartupMarker <span class="keyword">operator</span>&lt;&lt;(InitOnStartupMarker) <span class="type">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> *<span class="keyword">this</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line">  <span class="keyword">constexpr</span> InitOnStartupMarker <span class="keyword">operator</span>&lt;&lt;(T&amp;&amp; v) <span class="type">const</span> &#123;</span><br><span class="line">    <span class="keyword">return</span> std::forward&lt;T&gt;(v)();  #ç›¸å½“äºè°ƒç”¨OpDefBuilderWrapperå¯¹åƒçš„<span class="built_in">operator</span>()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">// æ˜¯å¦åœ¨å¯åŠ¨æ—¶å°±æ³¨å†Œ</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> TF_INIT_ON_STARTUP_IF(cond)                \</span></span><br><span class="line"><span class="meta">  (::std::integral_constant<span class="string">&lt;bool, !(cond)&gt;</span>::value) \</span></span><br><span class="line"><span class="meta">      ? ::tensorflow::InitOnStartupMarker&#123;&#125;        \</span></span><br><span class="line"><span class="meta">      : ::tensorflow::InitOnStartupMarker &#123;&#125;</span></span><br></pre></td></tr></table></figure>

<p>çœŸæ­£æ³¨å†Œåœ¨è¿™é‡Œï¼šé€šè¿‡builderè·å–å…¨å±€æ³¨å†Œä¸­å¿ƒï¼Œå®é™…ä¸Šæ˜¯ä¸å°OPçš„æ„å»ºå™¨functionä¿å­˜ä¸‹æ¥ï¼Œåœ¨éœ€è¦çš„æ—¶å€™å°±å¯ä»¥é€šè¿‡å®ƒæ¥newå‡ºæ–°çš„OPå¯¹è±¡äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">arduinoå¤åˆ¶ä»£ç <span class="function">InitOnStartupMarker <span class="title">OpDefBuilderWrapper::operator</span><span class="params">()</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  OpRegistry::<span class="built_in">Global</span>()-&gt;<span class="built_in">Register</span>(</span><br><span class="line">      [builder =</span><br><span class="line">           std::<span class="built_in">move</span>(builder_)](OpRegistrationData* op_reg_data) -&gt; Status &#123;</span><br><span class="line">        <span class="keyword">return</span> builder.<span class="built_in">Finalize</span>(op_reg_data);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">return</span> &#123;&#125;;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// static,å•ä¾‹</span></span><br><span class="line"><span class="function">OpRegistry* <span class="title">OpRegistry::Global</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> OpRegistry* global_op_registry = <span class="keyword">new</span> OpRegistry;</span><br><span class="line">  <span class="keyword">return</span> global_op_registry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">OpRegistry::Register</span><span class="params">(<span class="type">const</span> OpRegistrationDataFactory&amp; op_data_factory)</span> </span>&#123;</span><br><span class="line">  <span class="function">mutex_lock <span class="title">lock</span><span class="params">(mu_)</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (initialized_) &#123;</span><br><span class="line">    <span class="built_in">TF_QCHECK_OK</span>(<span class="built_in">RegisterAlreadyLocked</span>(op_data_factory));</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    deferred_.<span class="built_in">push_back</span>(op_data_factory);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">typedef</span> std::function&lt;Status(OpRegistrationData*)&gt; OpRegistrationDataFactory;</span><br></pre></td></tr></table></figure>

<p>æœ€ç»ˆæŠŠæ„å»ºå¥½çš„op,å…¶å®å°±æ˜¯OpRegistrationDataæ’å…¥åˆ°map&lt;op_name, OpRegistrationData*&gt; OpRegistry::registry_ä¸­ã€‚</p>
<h1 id="KERNELæºç éƒ¨åˆ†"><a href="#KERNELæºç éƒ¨åˆ†" class="headerlink" title="KERNELæºç éƒ¨åˆ†"></a>KERNELæºç éƒ¨åˆ†</h1><p>tensorflowå›¾ç»“ç‚¹å«OP(operator)ã€‚OPæ˜¯C++å†™çš„å¯ä»¥ç”±ä½¿ç”¨è€…ä»»æ„æ‰©å±•çš„ã€‚æ‰©å±•OPåˆ†ä¸¤æ­¥ï¼Œ1æ˜¯OPçš„å£°æ˜ï¼Œä¹Ÿå°±OPæ³¨å†Œï¼Œä½¿ç”¨REGISTER_OPæ¥å®Œæˆã€‚2æ˜¯OPçš„å®ç°ï¼Œå«op_kernelã€‚KERNELä¹Ÿéœ€è¦æ³¨å†Œï¼Œå«REGISTER_KERNEL_BUILDERã€‚OPåœ¨å®ç°æ—¶éœ€è¦ç»§æ‰¿OpKernelç±»ã€‚</p>
<p>æ„å›¾æ—¶åªéœ€è¦OPå£°æ˜å³å¯ã€‚è¿è¡Œæ—¶æ‰éœ€è¦æŸ¥æ‰¾å¹¶å®ä¾‹åŒ–Kernelã€‚ä¸€ä¸ªOPåœ¨ä¸åŒçš„è®¾å¤‡ä¸Šå¯ä»¥æœ‰ä¸åŒçš„å®ç°ã€‚ä¸‹é¢çš„ä¾‹å­æ˜¯å®˜ç½‘æœ€ç®€å•çš„ZeroOut OPå£°æ˜å’ŒKernelçš„å®ç°ã€‚å®é™…ä¸Šï¼Œå£°æ˜å’Œå®ç°å®Œå…¨å¯ä»¥ç‹¬ç«‹åœ¨ä¸åŒçš„æ–‡ä»¶ã€‚æœ¬æ–‡åˆ™ç€é‡åˆ†æKernel</p>
<p>Kernelæ˜¯çœŸæ­£å®ç°è®¡ç®—åŠŸèƒ½çš„ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/shape_inference.h&quot;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;tensorflow/core/framework/op_kernel.h&quot;</span></span></span><br><span class="line"><span class="keyword">using</span> <span class="keyword">namespace</span> tensorflow;</span><br><span class="line"><span class="comment">//OPçš„å£°æ˜</span></span><br><span class="line"><span class="built_in">REGISTER_OP</span>(<span class="string">&quot;ZeroOut&quot;</span>)</span><br><span class="line">    .<span class="built_in">Input</span>(<span class="string">&quot;to_zero: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">Output</span>(<span class="string">&quot;zeroed: int32&quot;</span>)</span><br><span class="line">    .<span class="built_in">SetShapeFn</span>([](::tensorflow::shape_inference::InferenceContext* c) &#123;</span><br><span class="line">      c-&gt;<span class="built_in">set_output</span>(<span class="number">0</span>, c-&gt;<span class="built_in">input</span>(<span class="number">0</span>));</span><br><span class="line">      <span class="keyword">return</span> Status::<span class="built_in">OK</span>();</span><br><span class="line">    &#125;);</span><br><span class="line"></span><br><span class="line"><span class="comment">//OPå®ç°</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ZeroOutOp</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">ZeroOutOp</span><span class="params">(OpKernelConstruction* context)</span> : OpKernel(context) &#123;</span>&#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Grab the input tensor</span></span><br><span class="line">    <span class="type">const</span> Tensor&amp; input_tensor = context-&gt;<span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">    <span class="keyword">auto</span> input = input_tensor.<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Create an output tensor</span></span><br><span class="line">    Tensor* output_tensor = <span class="literal">NULL</span>;</span><br><span class="line">    <span class="built_in">OP_REQUIRES_OK</span>(context, context-&gt;<span class="built_in">allocate_output</span>(<span class="number">0</span>, input_tensor.<span class="built_in">shape</span>(),</span><br><span class="line">                                                     &amp;output_tensor));</span><br><span class="line">    <span class="keyword">auto</span> output_flat = output_tensor-&gt;<span class="built_in">flat</span>&lt;int32&gt;();</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Set all but the first element of the output tensor to 0.</span></span><br><span class="line">    <span class="type">const</span> <span class="type">int</span> N = input.<span class="built_in">size</span>();</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">1</span>; i &lt; N; i++) &#123;</span><br><span class="line">      <span class="built_in">output_flat</span>(i) = <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">// Preserve the first input value if possible.</span></span><br><span class="line">    <span class="keyword">if</span> (N &gt; <span class="number">0</span>) <span class="built_in">output_flat</span>(<span class="number">0</span>) = <span class="built_in">input</span>(<span class="number">0</span>);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br><span class="line"><span class="comment">//æ³¨å†ŒKERNEL</span></span><br><span class="line"><span class="built_in">REGISTER_KERNEL_BUILDER</span>(<span class="built_in">Name</span>(<span class="string">&quot;ZeroOut&quot;</span>).<span class="built_in">Device</span>(DEVICE_CPU), ZeroOutOp);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Kernel"><a href="#Kernel" class="headerlink" title="Kernel"></a>Kernel</h2><p>tensorflow&#x2F;core&#x2F;framework&#x2F;op_kernel.h</p>
<h2 id="åŒæ­¥è®¡ç®—-Computeæ–¹æ³•"><a href="#åŒæ­¥è®¡ç®—-Computeæ–¹æ³•" class="headerlink" title="åŒæ­¥è®¡ç®— Computeæ–¹æ³•"></a>åŒæ­¥è®¡ç®— Computeæ–¹æ³•</h2><ol>
<li>kernelè®¡ç®—å¯ä»¥æ˜¯åŒæ­¥ä¹Ÿå¯ä»¥æ˜¯å¼‚æ­¥ã€‚Computeå¿…é¡»æ˜¯çº¿ç¨‹å®‰å…¨ã€‚å¤§å¤šæ•°æ˜¯åŒæ­¥ã€‚</li>
<li>åŒæ­¥ kernel ç»ä¸èƒ½ç”¨é”ï¼Œæ¡ä»¶å˜é‡ç­‰é˜»å¡å½“å‰çº¿ç¨‹ï¼Œè¯•å›¾åœ¨å…¶ä»–kernelé‡Œè§£é”ã€‚æœ‰</li>
<li>å› ä¸ºexecutorå¯èƒ½åªæœ‰å›ºå®šæ•°é‡çš„çº¿ç¨‹ï¼Œéƒ½é˜»å¡å°±ä¼šæ­»é”</li>
<li>å¦‚æœçœŸæƒ³åŠ é”ï¼Œå¦‚RecvOp, DequeueOp,å¿…é¡»ç»§æ‰¿OpKernelçš„å­ç±»AsyncOpKernelã€‚</li>
<li>å¤§å¤šæ•°æƒ…å†µä¸‹ï¼ŒAsyncOpKerenlåº”å½“ä½¿ç”¨cancellationæœºåˆ¶ï¼šcontext-&gt;cancellation_manager()</li>
<li>opçš„è¾“å…¥è¾“å‡ºéƒ½è¦é€šè¿‡å‚æ•°OpKernelContext contextæ¥è·å¾—ã€‚è¿”å›çŠ¶æ€ä¹Ÿé€šè¿‡ctx-&gt;SetStatus()</li>
<li>åŒæ­¥è®¡ç®—ä¸­ï¼Œcontextå¯ä»¥ä¿è¯å‡½æ•°è¿”å›å‰ç›´å­˜åœ¨ã€‚</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ„é€ ä¸ææ„</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpKernel</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">//kernelä¸ä¼šåœ¨è°ƒåº¦å™¨ä¸­åˆå§‹åŒ–ï¼Œæ‰€ä»¥å¯ä»¥åœ¨å­ç±»ä¸­å®ç°é‡é€»è¾‘</span></span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OpKernel</span><span class="params">(OpKernelConstruction* context)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//å…è®¸å»¶æ—¶OP. executorä¼šä½¿ç”¨OpKernelContext::inc_num_deferred_ops_function()` and</span></span><br><span class="line">  <span class="comment">// `OpKernelContext::dec_num_deferred_ops_function()` methods at run-time.</span></span><br><span class="line">  <span class="built_in">OpKernel</span>(OpKernelConstruction* context, <span class="type">bool</span> is_deferred);</span><br><span class="line">  <span class="comment">//èƒ½è¯·å…è®¸å­ç±»è‡ªå®šä¹‰NodeDef</span></span><br><span class="line">  <span class="built_in">OpKernel</span>(OpKernelConstruction* context, NodeDef&amp;&amp; custom_def,</span><br><span class="line">           <span class="type">bool</span> is_deferred);</span><br><span class="line"></span><br><span class="line">  <span class="keyword">virtual</span> ~<span class="built_in">OpKernel</span>();</span><br><span class="line">     </span><br><span class="line">  <span class="comment">//æ ¸å¿ƒè®¡ç®—å‡½æ•°ï¼Œå­ç±»é‡å†™å®ƒæ¥å®ç°è‡ªå·±çš„åŠŸèƒ½</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> </span>= <span class="number">0</span>;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> AsyncOpKernel* <span class="title">AsAsync</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> <span class="literal">nullptr</span>; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">bool</span> <span class="title">IsExpensive</span><span class="params">()</span> </span>&#123; <span class="keyword">return</span> expensive_; &#125;</span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">const</span> Tensor* <span class="title">const_tensor</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> <span class="literal">nullptr</span>; &#125;</span><br><span class="line">  <span class="comment">// Accessors. èƒ½è¿”å›ç»“ç‚¹å®šä¹‰ï¼Œç»“ç‚¹åå­—ï¼Œ</span></span><br><span class="line">  <span class="function"><span class="type">const</span> NodeDef&amp; <span class="title">def</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> props_-&gt;node_def; &#125;</span><br><span class="line">  <span class="function"><span class="type">const</span> std::string&amp; <span class="title">name</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> props_-&gt;node_def.<span class="built_in">name</span>(); &#125;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="å¼‚æ­¥è®¡ç®—ï¼šAsyncOpKernel"><a href="#å¼‚æ­¥è®¡ç®—ï¼šAsyncOpKernel" class="headerlink" title="å¼‚æ­¥è®¡ç®—ï¼šAsyncOpKernel"></a>å¼‚æ­¥è®¡ç®—ï¼šAsyncOpKernel</h2><p>å¼‚æ­¥ä¹Ÿå°±æ˜¯computeAsyncè¦ç«‹å³è¿”å›ã€‚å½“ç„¶tensorflowä¼šä¸€ç›´ä¿æŒcontextå­˜åœ¨ï¼Œç›´åˆ°doneè¢«è°ƒç”¨ã€‚ä¸€ä½†doneè¢«è°ƒç”¨ï¼Œä¸åº”å½“å†ä½¿ç”¨contextã€‚å¦åˆ™ä¼šcoreã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">AsyncOpKernel</span> : <span class="keyword">public</span> OpKernel &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="keyword">using</span> OpKernel::OpKernel;  <span class="comment">// Lift OpKernel constructors.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">//å¼‚æ­¥è®¡ç®—å®Œæˆåè¦è°ƒç”¨æ­¤å›è°ƒå‡½æ•°é€šçŸ¥è°ƒåº¦å™¨ã€‚</span></span><br><span class="line">  <span class="comment">//åªèƒ½è°ƒç”¨ä¸€æ¬¡ï¼Œä¸€æ—¦è°ƒç”¨ï¼Œcontext, å’Œthiséƒ½å¯èƒ½å·²ç»é”€æ¯äº†</span></span><br><span class="line">  <span class="keyword">typedef</span> std::function&lt;<span class="type">void</span>()&gt; DoneCallback;</span><br><span class="line">  <span class="comment">//å¼‚æ­¥è®¡ç®—å°±é‡å†™æ­¤æ¥å£</span></span><br><span class="line">  <span class="function"><span class="keyword">virtual</span> <span class="type">void</span> <span class="title">ComputeAsync</span><span class="params">(OpKernelContext* context, DoneCallback done)</span> </span>= <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  <span class="function">AsyncOpKernel* <span class="title">AsAsync</span><span class="params">()</span> <span class="keyword">override</span> </span>&#123; <span class="keyword">return</span> <span class="keyword">this</span>; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Compute</span><span class="params">(OpKernelContext* context)</span> <span class="keyword">override</span></span>;</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="Kernelæ„é€ æ—¶çš„OpKernelConstruction"><a href="#Kernelæ„é€ æ—¶çš„OpKernelConstruction" class="headerlink" title="Kernelæ„é€ æ—¶çš„OpKernelConstruction"></a>Kernelæ„é€ æ—¶çš„OpKernelConstruction</h2><p>ä¼ å…¥äº†</p>
<ol>
<li>è®¾å¤‡:device</li>
<li>åˆ†é…å™¨Allocator</li>
<li>èµ„æºç®¡ç†å™¨ï¼šResourceMgr</li>
<li>Node</li>
<li>Env</li>
<li>FunctionLib</li>
</ol>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//åˆ›å»ºOPæ—¶ç”±tensorflowæ¡†æ¶åˆ›å»ºæ­¤ç±»ï¼Œå¹¶ä¼ å…¥ç»™OPçš„æ„å»ºå‡½æ•°ã€‚</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">OpKernelConstruction</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line"></span><br><span class="line">  <span class="comment">//ç¯å¢ƒï¼Œè®¿é—®æ“ä½œç³»ç»Ÿå¦‚æ–‡ä»¶ç³»ç»Ÿï¼Œçº¿ç¨‹åˆ›å»ºè¦ä½¿ç”¨æ­¤env.</span></span><br><span class="line">  <span class="function">Env* <span class="title">env</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> device_-&gt;<span class="built_in">env</span>(); &#125;</span><br><span class="line"> </span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">SetStatus</span><span class="params">(<span class="type">const</span> Status&amp; status)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">const</span> Status&amp; <span class="title">status</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> *status_; &#125;</span><br><span class="line">  <span class="comment">//å±æ€§æ—¶åœ¨æ„å›¾æ—¶ç¡®å®šäº†çš„ï¼Œæ‰€ä»¥åœ¨æ²¡æœ‰è¿è¡Œå›¾æ—¶å°±èƒ½è·å–å€¼ã€‚</span></span><br><span class="line">  <span class="keyword">template</span> &lt;<span class="keyword">class</span> <span class="title class_">T</span>&gt;</span><br><span class="line">  <span class="function">Status <span class="title">GetAttr</span><span class="params">(StringPiece attr_name, T* value)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function"><span class="type">const</span> DeviceType&amp; <span class="title">device_type</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> device_type_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function">FunctionLibraryRuntime* <span class="title">function_library</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> flib_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Shared resources accessible to this kernel.</span></span><br><span class="line">  <span class="function">ResourceMgr* <span class="title">resource_manager</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> resource_mgr_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// The GraphDef version whose behavior we should follow.</span></span><br><span class="line">  <span class="function"><span class="type">int</span> <span class="title">graph_def_version</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> graph_def_version_; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">//è·å–è®¾å¤‡</span></span><br><span class="line">  <span class="function">DeviceBase* <span class="title">device</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> device_; &#125;</span><br><span class="line"></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="OPè¾“å…¥è¾“å‡ºå‚æ•°å¸®åŠ©ç±»"><a href="#OPè¾“å…¥è¾“å‡ºå‚æ•°å¸®åŠ©ç±»" class="headerlink" title="OPè¾“å…¥è¾“å‡ºå‚æ•°å¸®åŠ©ç±»"></a>OPè¾“å…¥è¾“å‡ºå‚æ•°å¸®åŠ©ç±»</h2><p>æœ‰çš„è¾“å…¥æ˜¯ä¸ªList,ç”¨ä¸€ä¸ªåå­—ï¼Œä»£è¡¨äº†åŒç±»å‹çš„å¤šä¸ªè¾“å…¥ã€‚ å¯ä»¥è®¤ä¸ºæ˜¯Tensor tensors[N].è¾“å‡ºä¹Ÿæœ‰è¿™ç§æƒ…å†µã€‚</p>
<ol>
<li>OpInputList</li>
<li>OpMutableInputList</li>
<li>OpOutputList</li>
</ol>
<h2 id="Computeçš„å‚æ•°OpKernelContext"><a href="#Computeçš„å‚æ•°OpKernelContext" class="headerlink" title="Computeçš„å‚æ•°OpKernelContext"></a>Computeçš„å‚æ•°OpKernelContext</h2><p>è¿™ä¸ªç±»ååˆ†å·¨å¤§ï¼Œå†…å®¹ä¸°å¯Œã€‚è¿™ä¸ªContextæä¾›äº†Op Computeæ—¶æ‰€éœ€è¦çš„ä¸€åˆ‡ã€‚ä»é€»è¾‘ä¸Šè®²ï¼Œå¯åˆ†ä¸ºä»¥ä¸‹å‡ ç±»</p>
<h3 id="è¾“å…¥è¾“å‡ºå‚æ•°è·å–"><a href="#è¾“å…¥è¾“å‡ºå‚æ•°è·å–" class="headerlink" title="è¾“å…¥è¾“å‡ºå‚æ•°è·å–"></a>è¾“å…¥è¾“å‡ºå‚æ•°è·å–</h3><p>Input, Output. è‡³äºAttr,æ˜¯åœ¨æ„å›¾æ—¶è·å¾—ï¼ŒOpKernelConstructioné‡Œå°±èƒ½è·å–</p>
<p>è¾“å‡ºè¿˜æ¶‰åŠåˆ°Tensorå†…å­˜åˆ†é…</p>
<h3 id="æ‰§è¡Œç¯å¢ƒ"><a href="#æ‰§è¡Œç¯å¢ƒ" class="headerlink" title="æ‰§è¡Œç¯å¢ƒ"></a>æ‰§è¡Œç¯å¢ƒ</h3><p>env, device, resource_mgr, node, graph, session, step_id, function_library, allocator, session</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">OpKernelContext</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">//åŸºæœ¬ä¿¡æ¯</span></span><br><span class="line">   <span class="type">const</span> SessionMetadata* session_metadata = <span class="literal">nullptr</span>;</span><br><span class="line">   TensorStore* tensor_store = <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="function"><span class="keyword">explicit</span> <span class="title">OpKernelContext</span><span class="params">(Params* params)</span></span>;</span><br><span class="line">  <span class="built_in">OpKernelContext</span>(Params* params, <span class="type">int</span> num_outputs);</span><br><span class="line">  ~<span class="built_in">OpKernelContext</span>();</span><br><span class="line">  <span class="function">Env* <span class="title">env</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> params_-&gt;device-&gt;<span class="built_in">env</span>(); &#125;</span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">step_id</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> params_-&gt;step_id; &#125;</span><br><span class="line">  <span class="function"><span class="type">int64_t</span> <span class="title">start_time_usecs</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> params_-&gt;start_time_usecs; &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">// æ“ä½œopçš„è¾“å…¥ï¼Œå¯ä»¥æŒ‰id,æˆ–è€…åå­—ï¼Œåªè¯»å–æˆ–è€…è¯»å†™Input</span></span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="type">const</span> Tensor&amp; <span class="title">input</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">input</span><span class="params">(StringPiece name, <span class="type">const</span> Tensor** tensor)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">input_list</span><span class="params">(StringPiece name, OpInputList* list)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">input_ref_mutex</span><span class="params">(StringPiece name, mutex** out_mutex)</span></span>;</span><br><span class="line">  <span class="function">Tensor <span class="title">mutable_input</span><span class="params">(<span class="type">int</span> index, <span class="type">bool</span> lock_held)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">mutable_input</span><span class="params">(StringPiece name, Tensor* tensor, <span class="type">bool</span> lock_held)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">mutable_input_list</span><span class="params">(StringPiece name, OpMutableInputList* list)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">replace_ref_input</span><span class="params">(<span class="type">int</span> index, <span class="type">const</span> Tensor&amp; tensor, <span class="type">bool</span> lock_held)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">replace_ref_input</span><span class="params">(StringPiece name, <span class="type">const</span> Tensor&amp; tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">                           <span class="type">bool</span> lock_held)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">delete_ref_input</span><span class="params">(<span class="type">int</span> input_index, <span class="type">bool</span> lock_held)</span></span>;</span><br><span class="line">  <span class="function"><span class="type">bool</span> <span class="title">has_input</span><span class="params">(<span class="type">int</span> index)</span> <span class="type">const</span></span>;</span><br><span class="line"></span><br><span class="line"> <span class="comment">// æ“ä½œopçš„è¾“è¾“å‡ºï¼Œå¯ä»¥æŒ‰id,æˆ–è€…åå­—ï¼Œåªè¯»å–æˆ–è€…è¯»å†™output. åŒæ—¶å¯ä»¥ç»™outputåˆ†é…å†…å­˜</span></span><br><span class="line">  <span class="function">Status <span class="title">output_list</span><span class="params">(StringPiece name, OpOutputList* list)</span></span>;</span><br><span class="line">  <span class="function">Status <span class="title">allocate_output</span><span class="params">(<span class="type">int</span> index, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">                         Tensor** tensor)</span> TF_MUST_USE_RESULT</span>;</span><br><span class="line">  <span class="function">Status <span class="title">allocate_output</span><span class="params">(StringPiece name, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">  Status allocate_output(<span class="type">int</span> index, <span class="type">const</span> TensorShape&amp; shape, Tensor** tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">                         AllocatorAttributes attr) TF_MUST_USE_RESULT;</span></span></span><br><span class="line"><span class="params"><span class="function">  Status allocate_output(StringPiece name, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">                         Tensor** tensor,</span></span></span><br><span class="line"><span class="params"><span class="function">                         AllocatorAttributes attr) TF_MUST_USE_RESULT;</span></span></span><br><span class="line"><span class="params"><span class="function">  <span class="comment">//åˆ†é…ä¸€ä¸ªä¸´æ—¶tensorå˜é‡</span></span></span></span><br><span class="line"><span class="params"><span class="function">  Status allocate_temp(DataType type, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">                       Tensor* out_temp, AllocatorAttributes allocator_attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                       <span class="type">const</span> AllocationAttributes&amp; allocation_attr);</span></span></span><br><span class="line"><span class="params"><span class="function">  Status allocate_temp(DataType type, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">                       Tensor* out_temp, AllocatorAttributes allocator_attr) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">return</span> allocate_temp(type, shape, out_temp, allocator_attr,</span></span></span><br><span class="line"><span class="params"><span class="function">                         AllocationAttributes());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span></span></span><br><span class="line"><span class="params"><span class="function">  Status allocate_temp(DataType type, <span class="type">const</span> TensorShape&amp; shape,</span></span></span><br><span class="line"><span class="params"><span class="function">                       Tensor* out_temp) &#123;</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="keyword">return</span> allocate_temp(type, shape, out_temp, AllocatorAttributes());</span></span></span><br><span class="line"><span class="params"><span class="function">  &#125;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br><span class="line"><span class="params"><span class="function">&#125;;</span></span></span><br><span class="line"><span class="params"><span class="function"></span></span></span><br></pre></td></tr></table></figure>

<h2 id="kernelå®ä¾‹åŒ–"><a href="#kernelå®ä¾‹åŒ–" class="headerlink" title="kernelå®ä¾‹åŒ–"></a>kernelå®ä¾‹åŒ–</h2><p>è¿è¡Œæ—¶è°ƒç”¨å¦‚ä¸‹æ–¹æ³•åˆ›å»ºKernel</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">std::unique_ptr&lt;OpKernel&gt; <span class="title">CreateOpKernel</span><span class="params">(DeviceType device_type,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         DeviceBase* device,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         Allocator* allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">const</span> NodeDef&amp; node_def,</span></span></span><br><span class="line"><span class="params"><span class="function">                                         <span class="type">int</span> graph_def_version, Status* status)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">std::unique_ptr&lt;OpKernel&gt; <span class="title">CreateOpKernel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    DeviceType device_type, DeviceBase* device, Allocator* allocator,</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> NodeProperties&gt;&amp; props, <span class="type">int</span> graph_def_version,</span></span></span><br><span class="line"><span class="params"><span class="function">    Status* status)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">CreateOpKernel</span><span class="params">(DeviceType device_type, DeviceBase* device,</span></span></span><br><span class="line"><span class="params"><span class="function">                      Allocator* allocator, FunctionLibraryRuntime* flib,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> NodeProperties&gt;&amp; props,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">int</span> graph_def_version, OpKernel** kernel)</span></span>;</span><br><span class="line"></span><br><span class="line"><span class="function">Status <span class="title">CreateOpKernel</span><span class="params">(DeviceType device_type, DeviceBase* device,</span></span></span><br><span class="line"><span class="params"><span class="function">                      Allocator* allocator, FunctionLibraryRuntime* flib,</span></span></span><br><span class="line"><span class="params"><span class="function">                      ResourceMgr* resource_mgr,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">const</span> std::shared_ptr&lt;<span class="type">const</span> NodeProperties&gt;&amp; props,</span></span></span><br><span class="line"><span class="params"><span class="function">                      <span class="type">int</span> graph_def_version, OpKernel** kernel)</span></span>;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>Kernelæ³¨å†ŒåŒæ ·ä½¿ç”¨äº†å®ï¼Œå·¥å‚ç­‰</p>
<h3 id="REGISTER-KERNEL-BUILDERæµç¨‹åˆ†æ"><a href="#REGISTER-KERNEL-BUILDERæµç¨‹åˆ†æ" class="headerlink" title="REGISTER_KERNEL_BUILDERæµç¨‹åˆ†æ"></a>REGISTER_KERNEL_BUILDERæµç¨‹åˆ†æ</h3><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//REGISTER_KERNEL_BUILDER è°ƒç”¨äº†REGISTER_KERNEL_BUILDER_IMPL è°ƒç”¨äº†TF_EXTRACT_KERNEL_NAME è°ƒç”¨äº†TF_EXTRACT_KERNEL_NAME_IMPL è°ƒç”¨äº†REGISTER_KERNEL_BUILDER_IMPL_2 è°ƒç”¨äº†TF_NEW_ID_FOR_INITè°ƒç”¨äº†REGISTER_KERNEL_BUILDER_IMPL_3</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// REGISTER_KERNEL_BUILDER_IMPL_2, with a unique &#x27;ctr&#x27; as the first argument.</span></span><br><span class="line"><span class="comment">// TODO(dodgen): There are some uses of this macro inside functions, where</span></span><br><span class="line"><span class="comment">// kernel_builder refers to (non-const) locals (they should be fixed). To</span></span><br><span class="line"><span class="comment">// accommodate those, kernel_builder.Build() appears as an argument to an</span></span><br><span class="line"><span class="comment">// immediately-called lambda (not in the lambda itself).</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> REGISTER_KERNEL_BUILDER_IMPL_3(ctr, op_name, kernel_builder_expr,   \</span></span><br><span class="line"><span class="meta">                                       is_system_kernel, ...)               \</span></span><br><span class="line"><span class="meta">  static ::tensorflow::InitOnStartupMarker const register_kernel_##ctr      \</span></span><br><span class="line"><span class="meta">      TF_ATTRIBUTE_UNUSED =                                                 \</span></span><br><span class="line"><span class="meta">          TF_INIT_ON_STARTUP_IF(is_system_kernel ||                         \</span></span><br><span class="line"><span class="meta">                                (SHOULD_REGISTER_OP_KERNEL(#__VA_ARGS__) &amp;&amp; \</span></span><br><span class="line"><span class="meta">                                 SHOULD_REGISTER_OP(op_name)))              \</span></span><br><span class="line"><span class="meta">          &lt;&lt; ([](::tensorflow::KernelDef const* kernel_def) &#123;               \</span></span><br><span class="line"><span class="meta">               ä¹Ÿå°±æ˜¯åˆ°è¿™é‡Œäº†ï¼Œä½¿ç”¨kernel_factoryæ¥æ³¨å†Œäº†ä¸€ä¸ªlambdaå‡½æ•°      \</span></span><br><span class="line"><span class="meta">               ::tensorflow::kernel_factory::OpKernelRegistrar registrar(   \</span></span><br><span class="line"><span class="meta">                   kernel_def, #__VA_ARGS__,                                \</span></span><br><span class="line"><span class="meta">                   [](::tensorflow::OpKernelConstruction* context)          \</span></span><br><span class="line"><span class="meta">                       -&gt; ::tensorflow::OpKernel* &#123;                         \</span></span><br><span class="line"><span class="meta">                     return new __VA_ARGS__(context); è¿™é‡Œå°±æ˜¯åœ¨new ZeroOut               \</span></span><br><span class="line"><span class="meta">                   &#125;);                                                      \</span></span><br><span class="line"><span class="meta">               (void)registrar;                                             \</span></span><br><span class="line"><span class="meta">               return ::tensorflow::InitOnStartupMarker&#123;&#125;;                  \</span></span><br><span class="line"><span class="meta">             &#125;)(kernel_builder_expr.Build()); <span class="comment">//è¿™é‡Œçš„kernel_builder_exprå°±æ˜¯KernelDefBuilder,å…¶å®å°±æ˜¯Name(&quot;ZeroOut&quot;).Device(DEVICE_CPU).Build(); è€Œä¸”è¿™é‡Œæ˜¯å¯¹lambdaå‡½æ•°çš„è°ƒç”¨ï¼Œæ‰€ä»¥ä¼šç«‹å³è¿›å…¥å‡½æ•°å†…</span></span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>REGISTER_KERNEL_BUILDER(Name(â€œZeroOutâ€).Device(DEVICE_CPU), ZeroOutOp);è¿™ä¸ªå®šä¹‰ä¸­ï¼ŒNameå®é™…ä¸Šæ˜¯KernelDefBuilder. Deviceå°±æ˜¯KernelDefBuilder::Device. </p>
<p>REGISTER_KERNEL_BUILDER( KernelDefBuilderå¯¹è±¡ï¼Œ ZeroOutè¿™ä¸ªç±»)ã€‚</p>
<p>OpkernelRegistrarçš„æ„å»ºå‡½æ•°é‡Œæœ€ç»ˆè°ƒç”¨åˆ°è¿™ä¸ªGlobalKernelRegistryçš„Reigster</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span>* <span class="title">GlobalKernelRegistry</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="type">static</span> KernelRegistry* global_kernel_registry = []() &#123;</span><br><span class="line">    KernelRegistry* registry = <span class="keyword">new</span> KernelRegistry;</span><br><span class="line">    OpRegistry::<span class="built_in">Global</span>()-&gt;<span class="built_in">RegisterValidator</span>(ValidateKernelRegistrations);</span><br><span class="line">    <span class="keyword">return</span> registry;</span><br><span class="line">  &#125;();</span><br><span class="line">  <span class="keyword">return</span> global_kernel_registry;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">struct</span> <span class="title class_">KernelRegistry</span> &#123;</span><br><span class="line">  mutex mu;</span><br><span class="line">  std::unordered_multimap&lt;string, KernelRegistration&gt; registry <span class="comment">//å°±æ˜¯æ”¾åœ¨è¿™ä¸ªmapé‡Œäº†</span></span><br><span class="line">      <span class="built_in">TF_GUARDED_BY</span>(mu);</span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="ä»åŠ¨æ€åº“åŠ è½½kernel"><a href="#ä»åŠ¨æ€åº“åŠ è½½kernel" class="headerlink" title="ä»åŠ¨æ€åº“åŠ è½½kernel"></a>ä»åŠ¨æ€åº“åŠ è½½kernel</h2><p>tensorflow&#x2F;core&#x2F;framework&#x2F;op_kernel.cc</p>
<p>åŠ è½½ç›®å½•:tensorflow&#x2F;core&#x2F;kernelsç›®å½•ä¸­çš„æ‰€æœ‰soã€‚å®é™…ä¸Šä½¿ç”¨äº†Env-&gt;LoadDynamicLibrary è¿™ç§æ–¹å¼æ˜¯æˆ‘ä»¬æ‰©å±•tensorflow kernelçš„æ–¹å¼ã€‚ç›´æ¥è‡ªå·±æ‰“åŒ…æˆç‹¬ç«‹çš„åŠ¨æ€åº“ï¼Œç”±tfåŠ è½½å³å¯ã€‚æ— é¡»ä¸tfæºç ç¼–è¯‘åˆ°ä¸€èµ·ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadDynamicKernelsInternal</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  Env* env = Env::<span class="built_in">Default</span>();</span><br><span class="line">  env-&gt;<span class="built_in">LoadDynamicLibrary</span>(fullpath.<span class="built_in">c_str</span>(), &amp;unused_filehandle)); <span class="comment">//åŠ è½½åŠ¨æ€åº“ã€‚ä¸åŒç¯å¢ƒä¸ç°ã€‚æ¯”è¾ƒlinuxä¸Šæ˜¯åŠ è½½soæ–‡ä»¶ã€‚windowsæ˜¯åŠ è½½dllæ–‡ä»¶ã€‚</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">LoadDynamicKernels</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="comment">//åªè°ƒç”¨ä¸€æ¬¡</span></span><br><span class="line">  <span class="type">static</span> absl::once_flag dll_loader_flag;</span><br><span class="line">  absl::<span class="built_in">call_once</span>(dll_loader_flag, LoadDynamicKernelsInternal);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Kernelä»contextä¸­è·å–è¾“å…¥ï¼Œåˆ†é…è¾“å‡ºæ—¶è¿”å›é”™è¯¯"><a href="#Kernelä»contextä¸­è·å–è¾“å…¥ï¼Œåˆ†é…è¾“å‡ºæ—¶è¿”å›é”™è¯¯" class="headerlink" title="Kernelä»contextä¸­è·å–è¾“å…¥ï¼Œåˆ†é…è¾“å‡ºæ—¶è¿”å›é”™è¯¯"></a>Kernelä»contextä¸­è·å–è¾“å…¥ï¼Œåˆ†é…è¾“å‡ºæ—¶è¿”å›é”™è¯¯</h2><p>tensorflow&#x2F;core&#x2F;framework&#x2F;op_requires.hä¸­å®šä¹‰äº†å¤§é‡çš„å®ï¼Œå¸®åŠ©æˆ‘ä»¬å®ç°è¿™äº›åŠŸèƒ½ã€‚è¿™äº›å®èƒ½æ ¹æ®éœ€è¦è¿”å›é”™è¯¯ã€‚è¿™å®éå¸¸å®ç”¨ï¼Œé¿å…æˆ‘ä»¬å†™å¤§é‡çš„ifåˆ¤æ–­ï¼Œreturnè¿”å›ä¹‹ç±»çš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> OP_REQUIRES_OK(CTX, ...)                             \</span></span><br><span class="line"><span class="meta">  do &#123;                                                       \</span></span><br><span class="line"><span class="meta">    ::tensorflow::Status _s(__VA_ARGS__);                    \</span></span><br><span class="line"><span class="meta">    <span class="keyword">if</span> (!TF_PREDICT_TRUE(_s.ok())) &#123;                         \</span></span><br><span class="line"><span class="meta">      CheckNotInComputeAsync((CTX), <span class="string">&quot;OP_REQUIRES_OK_ASYNC&quot;</span>); \</span></span><br><span class="line"><span class="meta">      (CTX)-&gt;CtxFailureWithWarning(__FILE__, __LINE__, _s);  \</span></span><br><span class="line"><span class="meta">      return;                                                \</span></span><br><span class="line"><span class="meta">    &#125;                                                        \</span></span><br><span class="line"><span class="meta">  &#125; while (0)</span></span><br></pre></td></tr></table></figure>]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>gpu</tag>
      </tags>
  </entry>
  <entry>
    <title>Tensorflow liteæºç åˆ†æ(Tensorflow 2.14)</title>
    <url>/2023/09/22/note/Tensorflow-lite%20source%20code%20analysis/</url>
    <content><![CDATA[<h1 id="Tensorflow-liteæºç åˆ†æ-Tensorflow-2-14"><a href="#Tensorflow-liteæºç åˆ†æ-Tensorflow-2-14" class="headerlink" title="Tensorflow liteæºç åˆ†æ(Tensorflow 2.14)"></a>Tensorflow liteæºç åˆ†æ(Tensorflow 2.14)</h1><h2 id="è£…è½½ç°æœ‰æ¨¡å‹"><a href="#è£…è½½ç°æœ‰æ¨¡å‹" class="headerlink" title="è£…è½½ç°æœ‰æ¨¡å‹"></a>è£…è½½ç°æœ‰æ¨¡å‹</h2><p>â€‹	é¦–å…ˆAndroid appä½¿ç”¨tensorflow apiä¸­çš„interpreteråˆ›å»ºäº†ä¸€ä¸ªè§£é‡Šå™¨ï¼Œè¯¥è§£é‡Šå™¨æœ‰å¤šç§æ„é€ å‡½æ•°å’Œç»§æ‰¿ï¼Œè¿™é‡Œä½¿ç”¨çš„æ˜¯æ–‡ä»¶ä¸­è¯»å–æ¨¡å‹ï¼ŒåŒæ—¶ä½¿ç”¨äº†ä¸€ä¸ªå§”æ‰˜(delegate)ï¼Œä½†æ˜¯æˆ‘ä»¬æœ€åå†æ¥çœ‹è¿™ä¸ªå§”æ‰˜æ˜¯ä»€ä¹ˆã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="keyword">private</span> val tflite by lazy &#123;</span><br><span class="line">       Interpreter(</span><br><span class="line">           FileUtil.loadMappedFile(<span class="built_in">this</span>, MODEL_PATH),</span><br><span class="line">           Interpreter.Options().addDelegate(nnApiDelegate))</span><br><span class="line">   &#125;</span><br><span class="line">   <span class="keyword">private</span> val detector by lazy &#123;</span><br><span class="line">       ObjectDetectionHelper(</span><br><span class="line">           tflite,</span><br><span class="line">           FileUtil.loadLabels(<span class="built_in">this</span>, LABELS_PATH)</span><br><span class="line">       )</span><br><span class="line">   &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	è¯¥å‡½æ•°è°ƒç”¨äº†<code>Interpreter</code>ç±»ï¼Œå…·ä½“å‡½æ•°è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//tensorflow/lite/java/src/main/java/org/tensorflow/lite/NativeInterpreterWrapper.java</span></span><br><span class="line">NativeInterpreterWrapper(ByteBuffer buffer, InterpreterImpl.Options options) &#123;</span><br><span class="line">    TensorFlowLite.init();</span><br><span class="line">	......</span><br><span class="line">    <span class="built_in">this</span>.modelByteBuffer = buffer;</span><br><span class="line">    <span class="type">long</span> <span class="variable">errorHandle</span> <span class="operator">=</span> createErrorReporter(ERROR_BUFFER_SIZE);</span><br><span class="line">    <span class="type">long</span> <span class="variable">modelHandle</span> <span class="operator">=</span> createModelWithBuffer(modelByteBuffer, errorHandle);</span><br><span class="line">    init(errorHandle, modelHandle, options);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>â€‹	æ ¸å¿ƒåœ¨äºç¬¬å››è¡Œå’Œç¬¬å…­è¡Œï¼Œç¬¬å››è¡Œå°†bufferèµ‹ç»™thiså¯¹è±¡ï¼Œç¬¬å…­è¡Œé€šè¿‡bufferåˆ›å»ºæ¨¡å‹ã€‚è¿™é‡Œå°±æ¥ç€è°ƒç”¨äº†JNIè·³è½¬åˆ°C&#x2F;C++çš„å®ç°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//tensorflow/lite/java/src/main/native/nativeinterpreterwrapper_jni.cc</span></span><br><span class="line"><span class="function">JNIEXPORT jlong JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_org_tensorflow_lite_NativeInterpreterWrapper_createModelWithBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    JNIEnv* env, jclass <span class="comment">/*clazz*/</span>, jobject model_buffer, jlong error_handle)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!tflite::jni::<span class="built_in">CheckJniInitializedOrThrow</span>(env)) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  BufferErrorReporter* error_reporter =</span><br><span class="line">      <span class="built_in">convertLongToErrorReporter</span>(env, error_handle);</span><br><span class="line">  <span class="keyword">if</span> (error_reporter == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  <span class="type">const</span> <span class="type">char</span>* buf =</span><br><span class="line">      <span class="built_in">static_cast</span>&lt;<span class="type">char</span>*&gt;(env-&gt;<span class="built_in">GetDirectBufferAddress</span>(model_buffer));</span><br><span class="line">  jlong capacity = env-&gt;<span class="built_in">GetDirectBufferCapacity</span>(model_buffer);</span><br><span class="line">  <span class="keyword">if</span> (!<span class="built_in">VerifyModel</span>(buf, capacity)) &#123;</span><br><span class="line">    <span class="built_in">ThrowException</span>(</span><br><span class="line">        env, tflite::jni::kIllegalArgumentException,</span><br><span class="line">        <span class="string">&quot;ByteBuffer is not a valid TensorFlow Lite model flatbuffer&quot;</span>);</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">auto</span> model = FlatBufferModel::<span class="built_in">BuildFromBuffer</span>(</span><br><span class="line">      buf, <span class="built_in">static_cast</span>&lt;<span class="type">size_t</span>&gt;(capacity), error_reporter);</span><br><span class="line">  <span class="keyword">if</span> (!model) &#123;</span><br><span class="line">    <span class="built_in">ThrowException</span>(env, tflite::jni::kIllegalArgumentException,</span><br><span class="line">                   <span class="string">&quot;ByteBuffer does not encode a valid model: %s&quot;</span>,</span><br><span class="line">                   error_reporter-&gt;<span class="built_in">CachedErrorMessage</span>());</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;jlong&gt;(model.<span class="built_in">release</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	åœ¨ä¸Šé¢é€»è¾‘ä¸­ï¼Œæœ€æ ¸å¿ƒçš„ä¸€è¡Œæ˜¯ç¬¬18è¡Œï¼Œä»bufferåˆ›å»ºæ¨¡å‹ã€‚å…¶è°ƒç”¨çš„æ˜¯<code>model_builder.cc</code>æ–‡ä»¶ä¸‹çš„<code>BuildFromBuffer</code>å‡½æ•°.</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//tensorflow/lite/core/model_builder.cc</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;FlatBufferModel&gt; <span class="title">FlatBufferModel::BuildFromBuffer</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    <span class="type">const</span> <span class="type">char</span>* caller_owned_buffer, <span class="type">size_t</span> buffer_size,</span></span></span><br><span class="line"><span class="params"><span class="function">    ErrorReporter* error_reporter)</span> </span>&#123;</span><br><span class="line"><span class="comment">//è°ƒç”¨ValidateErrorReporterå‡½æ•°ï¼Œæ£€æŸ¥error_reporteræ˜¯å¦ä¸ºnullptrï¼Œå¦‚æœæ˜¯ï¼Œåˆ™è¿”å›é»˜è®¤çš„é”™è¯¯æŠ¥å‘Šå™¨ï¼Œå¦åˆ™è¿”å›åŸæ¥çš„error_reporterã€‚</span></span><br><span class="line">  error_reporter = <span class="built_in">ValidateErrorReporter</span>(error_reporter);</span><br><span class="line"><span class="comment">//åˆ›å»ºä¸€ä¸ªMemoryAllocationå¯¹è±¡ï¼Œå®ƒæ˜¯Allocationç±»çš„å­ç±»ï¼Œç”¨äºå°è£…ç¼“å†²åŒºçš„åœ°å€å’Œå¤§å°ï¼Œå¹¶æä¾›è¯»å–å’Œå†™å…¥çš„æ¥å£ã€‚MemoryAllocationå¯¹è±¡ä½¿ç”¨newæ“ä½œç¬¦åœ¨å †ä¸Šåˆ†é…å†…å­˜ï¼Œå¹¶ä½¿ç”¨caller_owned_buffer, buffer_size, error_reporterä½œä¸ºæ„é€ å‡½æ•°çš„å‚æ•°ã€‚</span></span><br><span class="line">  <span class="function">std::unique_ptr&lt;Allocation&gt; <span class="title">allocation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">      <span class="keyword">new</span> MemoryAllocation(caller_owned_buffer, buffer_size, error_reporter))</span></span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">BuildFromAllocation</span>(std::<span class="built_in">move</span>(allocation), error_reporter);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function">ErrorReporter* <span class="title">ValidateErrorReporter</span><span class="params">(ErrorReporter* e)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> e ? e : <span class="built_in">DefaultErrorReporter</span>();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">MemoryAllocation::<span class="built_in">MemoryAllocation</span>(<span class="type">const</span> <span class="type">void</span>* ptr, <span class="type">size_t</span> num_bytes, ErrorReporter* error_reporter)</span><br><span class="line">: <span class="built_in">Allocation</span>(error_reporter, Allocation::Type::kMemory) &#123;</span><br><span class="line">	......</span><br><span class="line">  buffer_ = ptr;</span><br><span class="line">  buffer_size_bytes_ = num_bytes;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	åœ¨åšäº†ä¸€äº›é”™è¯¯æ£€æŸ¥å’Œç»™bufferåˆ†é…å†…å­˜åè½¬åŒ–æˆä¸“é—¨çš„Allocationç±»(è¿™ä¹ˆåšçš„åŸå› è¿˜æ˜¯ä¸ºäº†æŠ½è±¡ï¼ŒæŠŠå„ç§ä»æ–‡ä»¶è¯»çš„æ¨¡å‹ï¼Œä»å†…å­˜bufferè¯»çš„æ¨¡å‹éƒ½è½¬åŒ–æˆallocationç±»ï¼Œæœ€åè¿›è¡Œç»Ÿä¸€å¤„ç†)ï¼Œç„¶åè¿›è¡Œæ ¸å¿ƒçš„å‡½æ•°å¤„ç†<code>BuildFromAllocation</code>:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/lite/core/model_builder.cc</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;FlatBufferModel&gt; <span class="title">FlatBufferModel::BuildFromAllocation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    std::unique_ptr&lt;Allocation&gt; allocation, ErrorReporter* error_reporter)</span> </span>&#123;</span><br><span class="line">  <span class="function">std::unique_ptr&lt;FlatBufferModel&gt; <span class="title">model</span><span class="params">(<span class="keyword">new</span> FlatBufferModel(</span></span></span><br><span class="line"><span class="params"><span class="function">      std::move(allocation), ValidateErrorReporter(error_reporter)))</span></span>;</span><br><span class="line">  <span class="keyword">if</span> (!model-&gt;<span class="built_in">initialized</span>()) &#123;</span><br><span class="line">    model.<span class="built_in">reset</span>();</span><br><span class="line">  &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    model-&gt;<span class="built_in">ValidateModelBuffers</span>(error_reporter);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> model;</span><br><span class="line">&#125;</span><br><span class="line"><span class="comment">// FlatBufferModelçš„æ„é€ å‡½æ•°å®ç°</span></span><br><span class="line"><span class="comment">// å°†modelç›´æ¥ä¼ é€’ç»™ç±»å‹model_æˆå‘˜å˜é‡</span></span><br><span class="line">FlatBufferModel::<span class="built_in">FlatBufferModel</span>(<span class="type">const</span> Model* model, ErrorReporter* error_reporter)</span><br><span class="line">    : <span class="built_in">model_</span>(model), <span class="built_in">error_reporter_</span>(<span class="built_in">ValidateErrorReporter</span>(error_reporter)) &#123;&#125;</span><br><span class="line"><span class="comment">//å°†allocationå˜é‡ç›´æ¥ä¼ é€’ç»™allocation_å˜é‡ï¼Œç„¶åä½¿ç”¨GetModelå¯¹allocationè¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">FlatBufferModel::<span class="built_in">FlatBufferModel</span>(std::unique_ptr&lt;Allocation&gt; allocation, ErrorReporter* error_reporter)</span><br><span class="line">    : <span class="built_in">error_reporter_</span>(<span class="built_in">ValidateErrorReporter</span>(error_reporter)), <span class="built_in">allocation_</span>(std::<span class="built_in">move</span>(allocation)) &#123;</span><br><span class="line">  <span class="keyword">if</span> (!allocation_ || !allocation_-&gt;<span class="built_in">valid</span>() || !<span class="built_in">CheckModelIdentifier</span>()) &#123;</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  model_ = ::tflite::<span class="built_in">GetModel</span>(allocation_-&gt;<span class="built_in">base</span>());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	å®ƒä½¿ç”¨äº†<code>GetModel</code>æ–¹æ³•ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/core/model_builder.h</span></span><br><span class="line"><span class="function"><span class="type">const</span> tflite::Model* <span class="title">GetModel</span><span class="params">()</span> <span class="type">const</span> </span>&#123; <span class="keyword">return</span> model_; &#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tensorflow/tensorflow/lite/schema/schema_generated.h</span></span><br><span class="line"><span class="function"><span class="keyword">inline</span> <span class="type">const</span> tflite::Model *<span class="title">GetModel</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ::flatbuffers::<span class="built_in">GetRoot</span>&lt;tflite::Model&gt;(buf);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥å‘ç°è¿™é‡Œè°ƒç”¨äº†googleçš„<code>flatbuffer</code>åº“ï¼Œå…·ä½“æºç å‚è€ƒ<a href="https://github.com/google/flatbuffers/blob/d3e8cb60a133be5387008864d3fc212e31774b63/include/flatbuffers/buffer.h">flatbuffers&#x2F;include&#x2F;flatbuffers&#x2F;buffer.h at d3e8cb60a133be5387008864d3fc212e31774b63 Â· google&#x2F;flatbuffers (github.com)</a>ã€‚å®é™…è°ƒç”¨å¼•å…¥è¿‡ç¨‹æ˜¯<code>schema_generated.h</code> ä»£ç ä¸­å¼•å…¥äº†å¤´æ–‡ä»¶ <code>#include &quot;flatbuffers/flatbuffers.h&quot;</code> ï¼Œç„¶å <code>flatbuffers/flatbuffers.h</code> å¼•å…¥å¤´æ–‡ä»¶<code>flatbuffers/buffer.h</code>,æœ€ç»ˆå¾—åˆ°<code>GetModel</code>çš„å®ç°ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// https://github.com/google/flatbuffers/blob/d3e8cb60a133be5387008864d3fc212e31774b63/include/flatbuffers/buffer.h</span></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; <span class="type">const</span> T *<span class="title">GetRoot</span><span class="params">(<span class="type">const</span> <span class="type">void</span> *buf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">GetMutableRoot</span>&lt;T&gt;(<span class="built_in">const_cast</span>&lt;<span class="type">void</span> *&gt;(buf));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">template</span>&lt;<span class="keyword">typename</span> T&gt; T *<span class="title">GetMutableRoot</span><span class="params">(<span class="type">void</span> *buf)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (!buf) <span class="keyword">return</span> <span class="literal">nullptr</span>;</span><br><span class="line">  <span class="built_in">EndianCheck</span>();</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">reinterpret_cast</span>&lt;T *&gt;(</span><br><span class="line">      <span class="built_in">reinterpret_cast</span>&lt;<span class="type">uint8_t</span> *&gt;(buf) +</span><br><span class="line">      <span class="built_in">EndianScalar</span>(*<span class="built_in">reinterpret_cast</span>&lt;<span class="type">uoffset_t</span> *&gt;(buf)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	OK åˆ°è¿™ä¸€æ­¥ä¸ºæ­¢ï¼Œæˆ‘ä»¬å¯ä»¥çŸ¥é“å®é™…ä»…ä»…æ˜¯å§flatbufferæ ¼å¼çš„æ–‡ä»¶è¯»è¿›äº†å†…å­˜ï¼Œå¹¶ç”¨å„ç§æŠ½è±¡è¿›è¡Œç®¡ç†ï¼Œå†…å­˜å¸ƒå±€ä»ç„¶æ˜¯flatbufferä¸­å®šä¹‰çš„å†…å­˜å¸ƒå±€ã€‚å¹¶ä¸”æœ€åçš„åŒ…è£…æˆäº†ä¸€ä¸ªModelå¯¹è±¡ï¼Œ<code>Model *_model</code>ã€‚</p>
<p>ç„¶åè®©æˆ‘ä»¬æ¥çœ‹çœ‹TFLiteä¸­æ¨¡å‹å…·ä½“æ˜¯æ€ä¹ˆå®šä¹‰çš„å§ï¼Œè¿™ä¸ªæ¶‰åŠåˆ°çš„æ–‡ä»¶ä¸º<code>schema.fbs(tensorflow/tensorflow/lite/schema/schema.fbs)</code></p>
<ul>
<li><p>Model:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">table Model &#123;</span><br><span class="line">  <span class="comment">// ä¸€ä¸ªint32ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºæ¨¡å‹çš„ç‰ˆæœ¬å·ã€‚ç›®å‰æœ€æ–°çš„ç‰ˆæœ¬å·æ˜¯3</span></span><br><span class="line">  version:uint;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªOperatorCodeç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å‹ä¸­ä½¿ç”¨çš„ç®—å­çš„ç¼–ç ã€‚æ¯ä¸ªç®—å­æœ‰ä¸€ä¸ªå”¯ä¸€çš„ç¼–ç ï¼Œç”¨äºæ ‡è¯†ç®—å­çš„åç§°å’Œç‰ˆæœ¬ã€‚</span></span><br><span class="line">  operator_codes:[OperatorCode];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªSubGraphç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å‹ä¸­åŒ…å«çš„å­å›¾ã€‚æ¯ä¸ªå­å›¾æœ‰ä¸€ä¸ªè¾“å…¥å¼ é‡åˆ—è¡¨ã€ä¸€ä¸ªè¾“å‡ºå¼ é‡åˆ—è¡¨ã€ä¸€ä¸ªçŠ¶æ€å¼ é‡åˆ—è¡¨ã€ä¸€ä¸ªç®—å­èŠ‚ç‚¹åˆ—è¡¨å’Œä¸€ä¸ªåç§°ã€‚å­å›¾æ˜¯æ¨¡å‹æ‰§è¡Œçš„åŸºæœ¬å•å…ƒï¼Œå¯ä»¥ç†è§£ä¸ºä¸€ä¸ªè®¡ç®—å›¾. 0thå­å›¾ä¸ºmainå›¾</span></span><br><span class="line">  subgraphs:[SubGraph];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// A description of the model.</span></span><br><span class="line">  description:string;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªBufferç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å‹ä¸­æ‰€æœ‰å¼ é‡æ•°æ®çš„å­˜å‚¨ç©ºé—´ã€‚æ¯ä¸ªç¼“å†²åŒºæœ‰ä¸€ä¸ªå­—èŠ‚æ•°ç»„å’Œä¸€ä¸ªå“ˆå¸Œå€¼ã€‚é€šè¿‡ç¼“å†²åŒºçš„ç´¢å¼•ï¼Œå¯ä»¥ä»å­—èŠ‚æ•°ç»„ä¸­è¯»å–æˆ–å†™å…¥å¼ é‡çš„æ•°æ®ã€‚0thçš„bufferå¿…é¡»æ˜¯ç©ºbuffer</span></span><br><span class="line">  <span class="comment">// Note the 0th entry of this array must be an empty buffer (sentinel).</span></span><br><span class="line">  <span class="comment">// This is a convention so that tensors without a buffer can provide 0 as</span></span><br><span class="line">  <span class="comment">// their buffer.</span></span><br><span class="line">  buffers:[Buffer];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªint32ç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å‹ä¸­åŒ…å«çš„å…ƒæ•°æ®æ‰€åœ¨çš„ç¼“å†²åŒºçš„ç´¢å¼•ã€‚å…ƒæ•°æ®æ˜¯ä¸€ç§ç”¨äºæè¿°æ¨¡å‹å±æ€§å’Œå…³è”æ–‡ä»¶ç­‰ä¿¡æ¯çš„ç»“æ„ï¼Œå¯ä»¥ç”¨äºæé«˜æ¨¡å‹çš„å¯è§£é‡Šæ€§å’Œå…¼å®¹æ€§ã€‚</span></span><br><span class="line">  metadata_buffer:[<span class="type">int</span>];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Metadata about the model. åŒ…å«nameå’Œbufferï¼Œå³åå­—å­—æ®µå’Œè¯¥metadataæ‰€åœ¨çš„buffer</span></span><br><span class="line">  metadata:[Metadata];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªSignatureDefç±»å‹çš„æ•°ç»„ï¼Œè¡¨ç¤ºæ¨¡å‹ä¸­åŒ…å«çš„ç­¾åå®šä¹‰ã€‚æ¯ä¸ªç­¾åå®šä¹‰æœ‰ä¸€ä¸ªè¾“å…¥æ˜ å°„ã€ä¸€ä¸ªè¾“å‡ºæ˜ å°„å’Œä¸€ä¸ªæ–¹æ³•åç§°ã€‚ç­¾åå®šä¹‰æ˜¯ä¸€ç§ç”¨äºæè¿°æ¨¡å‹è¾“å…¥å’Œè¾“å‡ºæ¥å£ä»¥åŠåŠŸèƒ½ç­‰ä¿¡æ¯çš„ç»“æ„ï¼Œå¯ä»¥ç”¨äºæé«˜æ¨¡å‹çš„å¯ç”¨æ€§å’Œçµæ´»æ€§ã€‚</span></span><br><span class="line">  signature_defs:[SignatureDef];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Subgraph:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">table SubGraph &#123;</span><br><span class="line">  <span class="comment">// A list of all tensors used in this subgraph.</span></span><br><span class="line">  tensors:[Tensor];</span><br><span class="line"></span><br><span class="line">  <span class="comment">// å­å›¾çš„è¾“å…¥å¼ é‡ç´¢å¼•ï¼Œä¾‹å¦‚inputs [0] è¡¨ç¤ºtensorsæ•°ç»„ä¸­ç¬¬0ä¸ªå¼ é‡è¡¨ç¤ºè¾“å…¥å¼ é‡</span></span><br><span class="line">  inputs:[<span class="type">int</span>];</span><br><span class="line">  <span class="comment">// è¾“å‡ºå¼ é‡ç´¢å¼•</span></span><br><span class="line">  outputs:[<span class="type">int</span>];</span><br><span class="line">  <span class="comment">// operatorsæ•°ç»„</span></span><br><span class="line">  operators:[Operator];</span><br><span class="line">  name:string;</span><br><span class="line">&#125;</span><br><span class="line">    </span><br></pre></td></tr></table></figure>
</li>
<li><p>Tensor: </p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">table Tensor &#123;</span><br><span class="line">  <span class="comment">// int ç±»å‹çš„æ•°å­—ï¼Œè¡¨ç¤ºå¼ é‡çš„å½¢çŠ¶ï¼Œä¾‹å¦‚[1, 224, 224, 3],è¡¨ç¤º1ä¸ªå›¾ç‰‡æ ·æœ¬ï¼Œ224*224åƒç´ å¤§å°ï¼ŒRGB3ä¸ªé€šé“</span></span><br><span class="line">  shape:[<span class="type">int</span>];</span><br><span class="line">  <span class="comment">// å¼ é‡çš„æ•°æ®ç±»å‹ï¼Œæ¯”å¦‚int32ï¼Œ float32ï¼Œ int8ç­‰ç­‰ ï¼Œä¹Ÿå®šä¹‰åœ¨è¯¥æ–‡ä»¶ä¸­çš„enum TensorTypeå­—æ®µ</span></span><br><span class="line">  type:TensorType;</span><br><span class="line">  <span class="comment">// bufferï¼šä¸€ä¸ªint32ç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºå¼ é‡çš„æ•°æ®æ‰€åœ¨çš„ç¼“å†²åŒºçš„ç´¢å¼•ã€‚ç¼“å†²åŒºæ˜¯ä¸€ç§å­˜å‚¨æ¨¡å‹ä¸­æ‰€æœ‰å¼ é‡æ•°æ®çš„ç»“æ„ï¼Œæ¯ä¸ªç¼“å†²åŒºæœ‰ä¸€ä¸ªå”¯ä¸€çš„ç´¢å¼•å’Œä¸€ä¸ªå­—èŠ‚æ•°ç»„ã€‚é€šè¿‡è¿™ä¸ªå­—æ®µï¼Œå¯ä»¥ä»ç¼“å†²åŒºä¸­è¯»å–æˆ–å†™å…¥å¼ é‡çš„æ•°æ®ã€‚</span></span><br><span class="line">  buffer:uint;</span><br><span class="line">  name:string;  <span class="comment">// ä¸€ä¸ªstringç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºå¼ é‡çš„åç§°ã€‚è¿™ä¸ªå­—æ®µå¯ä»¥ç”¨äºæ ‡è¯†æˆ–æè¿°å¼ é‡çš„ä½œç”¨æˆ–æ¥æºï¼Œä¹Ÿå¯ä»¥ç”¨äºè°ƒè¯•æˆ–å¯è§†åŒ–ã€‚</span></span><br><span class="line">  quantization:QuantizationParameters;  <span class="comment">// Optional. ä¸€ä¸ªQuantizationParametersç±»å‹çš„è¡¨ï¼Œè¡¨ç¤ºå¼ é‡çš„é‡åŒ–å‚æ•°ã€‚é‡åŒ–æ˜¯ä¸€ç§å°†æµ®ç‚¹æ•°è½¬æ¢ä¸ºæ•´æ•°æˆ–ä½ä½æ•°æ¥å‡å°‘æ¨¡å‹å¤§å°å’Œæé«˜æ€§èƒ½çš„æŠ€æœ¯ã€‚è¿™ä¸ªè¡¨ä¸­åŒ…å«äº†ä¸€äº›ç”¨äºåé‡åŒ–æˆ–é‡æ–°é‡åŒ–å¼ é‡æ•°æ®çš„å‚æ•°ï¼Œå¦‚æœ€å°å€¼ã€æœ€å¤§å€¼ã€æ¯”ä¾‹å› å­ã€é›¶ç‚¹ç­‰ã€‚</span></span><br><span class="line"></span><br><span class="line">  is_variable:<span class="type">bool</span> = <span class="literal">false</span>; <span class="comment">//ä¸€ä¸ªboolç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºå¼ é‡æ˜¯å¦æ˜¯å˜é‡ã€‚å˜é‡æ˜¯ä¸€ç§å¯ä»¥åœ¨æ¨¡å‹è¿è¡Œè¿‡ç¨‹ä¸­æ”¹å˜å€¼çš„å¼ é‡ï¼Œé€šå¸¸ç”¨äºå­˜å‚¨æ¨¡å‹çš„å‚æ•°æˆ–çŠ¶æ€ã€‚å¦‚æœè¿™ä¸ªå­—æ®µä¸ºtrueï¼Œåˆ™è¡¨ç¤ºå¼ é‡æ˜¯å˜é‡ï¼Œå¦åˆ™è¡¨ç¤ºå¼ é‡æ˜¯å¸¸é‡ã€‚</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// ä¸€ä¸ªSparsityParametersç±»å‹çš„è¡¨ï¼Œè¡¨ç¤ºå¼ é‡çš„ç¨€ç–æ€§å‚æ•°ã€‚ç¨€ç–æ€§æ˜¯ä¸€ç§å°†å¼ é‡ä¸­å¤§éƒ¨åˆ†ä¸ºé›¶çš„å…ƒç´ å‹ç¼©æˆ–çœç•¥æ¥å‡å°‘æ¨¡å‹å¤§å°å’Œæé«˜æ€§èƒ½çš„æŠ€æœ¯ã€‚è¿™ä¸ªè¡¨ä¸­åŒ…å«äº†ä¸€äº›ç”¨äºè§£å‹ç¼©æˆ–é‡æ–°å‹ç¼©å¼ é‡æ•°æ®çš„å‚æ•°ï¼Œå¦‚ç¨€ç–ç»´åº¦ã€éé›¶å€¼ç´¢å¼•ã€éé›¶å€¼å—ç­‰ã€‚</span></span><br><span class="line">  sparsity:SparsityParameters;  <span class="comment">// Optional.</span></span><br><span class="line"></span><br><span class="line">  shape_signature:[<span class="type">int</span>]; <span class="comment">// Optional.</span></span><br><span class="line">  has_rank: <span class="type">bool</span> = <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ç”¨ä½œåµŒå¥—å¼ é‡ç±»å‹å­—æ®µ</span></span><br><span class="line">  variant_tensors:[VariantSubType];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</li>
<li><p>Buffer:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">table Buffer &#123;</span><br><span class="line">  data:[ubyte] (force_align: <span class="number">16</span>);</span><br><span class="line"></span><br><span class="line">  <span class="comment">// In a model that is larger than 2GB, then buffers instead uses the following</span></span><br><span class="line">  <span class="comment">// attributes to find stored data, which is outside of flatbuffers</span></span><br><span class="line">  <span class="comment">// the offset is calculated relative to the beginning of the file and is only</span></span><br><span class="line">  <span class="comment">// valid if &gt; 1.</span></span><br><span class="line">  offset: ulong;</span><br><span class="line">  size: ulong;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>
<h2 id="å¤„ç†æ¨¡å‹"><a href="#å¤„ç†æ¨¡å‹" class="headerlink" title="å¤„ç†æ¨¡å‹"></a>å¤„ç†æ¨¡å‹</h2><p>â€‹	æ¥ç€ä¸Šé¢çš„æ­¥éª¤ï¼Œæˆ‘ä»¬å›åˆ°javaåŒ…è£…å™¨çš„åœ°æ–¹ï¼Œå›é¡¾ä¸€ä¸‹ä»£ç ï¼š</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">//tensorflow/lite/java/src/main/java/org/tensorflow/lite/NativeInterpreterWrapper.java</span></span><br><span class="line">NativeInterpreterWrapper(ByteBuffer buffer, InterpreterImpl.Options options) &#123;</span><br><span class="line">    TensorFlowLite.init();</span><br><span class="line">	......</span><br><span class="line">    <span class="built_in">this</span>.modelByteBuffer = buffer;</span><br><span class="line">    <span class="type">long</span> <span class="variable">errorHandle</span> <span class="operator">=</span> createErrorReporter(ERROR_BUFFER_SIZE);</span><br><span class="line">    <span class="type">long</span> <span class="variable">modelHandle</span> <span class="operator">=</span> createModelWithBuffer(modelByteBuffer, errorHandle);</span><br><span class="line">    init(errorHandle, modelHandle, options);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	è¿™é‡Œå°†æ¨¡å‹è¯»å…¥bufferåï¼Œæ¥ç€è¿è¡Œäº†initå‡½æ•°ï¼Œé‚£ä¹ˆinitå‡½æ•°é‡Œé¢å¹²äº†ä»€ä¹ˆäº‹æƒ…å‘¢ï¼Ÿ</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/java/src/main/java/org/tensorflow/lite/NativeInterpreterWrapper.java</span></span><br><span class="line"></span><br><span class="line"><span class="comment">// errorHandleï¼šä¸€ä¸ªlongç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªé”™è¯¯å¤„ç†å™¨çš„å¥æŸ„ï¼Œç”¨äºæŠ¥å‘Šè§£é‡Šå™¨è¿è¡Œè¿‡ç¨‹ä¸­çš„é”™è¯¯ä¿¡æ¯ã€‚</span></span><br><span class="line"><span class="comment">// modelHandleï¼šä¸€ä¸ªlongç±»å‹çš„å€¼ï¼Œè¡¨ç¤ºä¸€ä¸ªæ¨¡å‹çš„å¥æŸ„ï¼Œç”¨äºåŠ è½½å’Œè®¿é—®TensorFlow Liteæ¨¡å‹çš„æ•°æ®å’Œå…ƒæ•°æ®ã€‚</span></span><br><span class="line"><span class="comment">// optionsï¼šä¸€ä¸ªInterpreterImpl.Optionsç±»å‹çš„å¯¹è±¡ï¼Œè¡¨ç¤ºä¸€äº›è§£é‡Šå™¨çš„é€‰é¡¹ï¼Œå¦‚çº¿ç¨‹æ•°ã€åŠ é€Ÿé…ç½®ã€ç²¾åº¦æ§åˆ¶ç­‰</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">init</span><span class="params">(<span class="type">long</span> errorHandle, <span class="type">long</span> modelHandle, InterpreterImpl.Options options)</span> &#123;</span><br><span class="line">	<span class="comment">// some error handle, æ£€æŸ¥optionsæ˜¯å¦ä¸ºç©ºï¼Œæ£€æŸ¥optionsä¸­æ˜¯å¦æœ‰åŠ é€Ÿé…ç½®</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">        </span><br><span class="line">    <span class="built_in">this</span>.errorHandle = errorHandle;</span><br><span class="line">    <span class="built_in">this</span>.modelHandle = modelHandle;</span><br><span class="line">    <span class="comment">// First create the interpreter without delegates.  We need an interpreter in order to figure</span></span><br><span class="line">    <span class="comment">// out whether the model contains any unresolved flex ops, and creating the interpreter with</span></span><br><span class="line">    <span class="comment">// delegates might fail if there are any unresolved flex ops.</span></span><br><span class="line">    <span class="comment">// (Alternatively, we could determine this without needing to recreate the interpreter</span></span><br><span class="line">    <span class="comment">// by passing the tflite::Model in to here, and then traversing that?)</span></span><br><span class="line">    <span class="comment">// ä¸Šé¢è¿™æ®µè‹±æ–‡ç½—é‡Œå§å—¦ä¸€å¤§å †ï¼Œå®é™…å°±æ˜¯å…ˆåˆ›å»ºä¸€ä¸ªåŸºæœ¬çš„è§£é‡Šå™¨ï¼Œå¦‚æœåç»­æœ‰ä»£ç†å†è¿›è¡Œå¤„ç†ã€‚</span></span><br><span class="line">    ArrayList&lt;Long&gt; delegateHandles = <span class="keyword">new</span> <span class="title class_">ArrayList</span>&lt;&gt;();</span><br><span class="line">    <span class="built_in">this</span>.interpreterHandle =</span><br><span class="line">        createInterpreter(</span><br><span class="line">            modelHandle,</span><br><span class="line">            errorHandle,</span><br><span class="line">            options.getNumThreads(),</span><br><span class="line">            options.getUseXNNPACK(),</span><br><span class="line">            delegateHandles);</span><br><span class="line">    <span class="comment">// åˆ¤æ–­æ˜¯å¦æœ‰ä¸Šè¿°interpreteræ²¡æ³•å¤„ç†çš„opï¼Œä¹Ÿå°±æ˜¯è¯´ä¸Šé¢è¿™ä¸ªå‡½æ•°å°±æ˜¯å¤„ç†æ¨¡å‹æˆopçš„çœŸå®è¿‡ç¨‹</span></span><br><span class="line">    <span class="built_in">this</span>.originalGraphHasUnresolvedFlexOp = hasUnresolvedFlexOp(interpreterHandle);</span><br><span class="line">    <span class="comment">// è¿™é‡Œæ·»åŠ å§”æ‰˜ï¼Œå§”æ‰˜å°±æ˜¯ä¸€ç§å¯ä»¥æé«˜æ¨¡å‹æ‰§è¡Œæ•ˆç‡å’Œå…¼å®¹æ€§çš„æœºåˆ¶ï¼Œå¯ä»¥å°†æ¨¡å‹ä¸­çš„ä¸€äº›æ“ä½œäº¤ç»™ç‰¹å®šçš„ç¡¬ä»¶æˆ–è½¯ä»¶æ¥æ‰§è¡Œã€‚</span></span><br><span class="line">    addDelegates(options);</span><br><span class="line">    <span class="comment">// åˆå§‹åŒ–å½“å‰å¯¹è±¡ä¸­åŒ…å«InterpreterFactoryæ¥å£çš„ä»£ç†ã€‚InterpreterFactoryæ¥å£æ˜¯ä¸€ç§å¯ä»¥è®©ä»£ç†è‡ªå·±åˆ›å»ºè§£é‡Šå™¨å¹¶ç®¡ç†å…¶ç”Ÿå‘½å‘¨æœŸçš„æœºåˆ¶ã€‚</span></span><br><span class="line">    initDelegatesWithInterpreterFactory();</span><br><span class="line">    delegateHandles.ensureCapacity(delegates.size());</span><br><span class="line">    <span class="keyword">for</span> (Delegate delegate : delegates) &#123;</span><br><span class="line">      delegateHandles.add(delegate.getNativeHandle());</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// è¯´æ˜æœ‰ä»£ç†éœ€è¦å¤„ç†ï¼Œæ‰€ä»¥æŠŠä¹‹å‰åˆ›å»ºçš„åŸºæœ¬è§£é‡Šå™¨åˆ é™¤ï¼Œæ·»åŠ æœ‰ä»£ç†çš„è§£é‡Šå™¨</span></span><br><span class="line">    <span class="keyword">if</span> (!delegateHandles.isEmpty()) &#123;</span><br><span class="line">      <span class="comment">// If there are any delegates enabled, recreate the interpreter with those delegates.</span></span><br><span class="line">      delete(<span class="comment">/* errorHandle= */</span> <span class="number">0</span>, <span class="comment">/* modelHandle= */</span> <span class="number">0</span>, <span class="built_in">this</span>.interpreterHandle);</span><br><span class="line">      <span class="built_in">this</span>.interpreterHandle =</span><br><span class="line">          createInterpreter(</span><br><span class="line">              modelHandle,</span><br><span class="line">              errorHandle,</span><br><span class="line">              options.getNumThreads(),</span><br><span class="line">              options.getUseXNNPACK(),</span><br><span class="line">              delegateHandles);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">// åˆ›å»ºä¸¤ä¸ªTensorImplç±»å‹çš„æ•°ç»„ï¼Œåˆ†åˆ«èµ‹å€¼ç»™å½“å‰å¯¹è±¡çš„inputTensorså’ŒoutputTensorsæˆå‘˜å˜é‡ã€‚è¿™ä¸¤ä¸ªæ•°ç»„ç”¨äºå­˜å‚¨æ¨¡å‹çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„å¯¹è±¡ã€‚æ•°ç»„çš„å¤§å°åˆ†åˆ«ç”±è°ƒç”¨getInputCountå’ŒgetOutputCountæ–¹æ³•å¾—åˆ°ã€‚</span></span><br><span class="line">    <span class="built_in">this</span>.inputTensors = <span class="keyword">new</span> <span class="title class_">TensorImpl</span>[getInputCount(interpreterHandle)];</span><br><span class="line">    <span class="built_in">this</span>.outputTensors = <span class="keyword">new</span> <span class="title class_">TensorImpl</span>[getOutputCount(interpreterHandle)];</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// ......</span></span><br><span class="line">    <span class="comment">// ä¸ºæ¨¡å‹çš„è¾“å…¥å’Œè¾“å‡ºå¼ é‡åˆ†é…å†…å­˜</span></span><br><span class="line">    allocateTensors(interpreterHandle, errorHandle);</span><br><span class="line">    <span class="built_in">this</span>.isMemoryAllocated = <span class="literal">true</span>;</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	å¾ˆå¤æ‚ï¼Œä½†æ˜¯æˆ‘ä»¬å…³æ³¨ä¸€ä¸ªæ ¸å¿ƒå‡½æ•°ï¼Œ<code>createInterpreter</code>ã€‚åŒæ ·è¿™é‡Œæ˜¯ä¸€ä¸ªJNIåŒ…è£…å™¨ï¼Œå®é™…ä»javaä»£ç è°ƒç”¨åˆ°äº†C++çš„APIã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/java/src/main/native/nativeinterpreterwrapper_jni.cc</span></span><br><span class="line"><span class="function">JNIEXPORT jlong JNICALL</span></span><br><span class="line"><span class="function"><span class="title">Java_org_tensorflow_lite_NativeInterpreterWrapper_createInterpreter</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    JNIEnv* env, jclass clazz, jlong model_handle, jlong error_handle,</span></span></span><br><span class="line"><span class="params"><span class="function">    jint num_threads, jboolean useXnnpack, jobject delegate_handle_list)</span> </span>&#123;</span><br><span class="line">  <span class="comment">// some handler check for JNI</span></span><br><span class="line">  <span class="comment">// è·å–ä¸¤ä¸ªè°ƒç”¨çš„å‚æ•°ï¼Œåº”è¯¥æ˜¯JNIè°ƒç”¨è¿‡æ¥çš„æ—¶å€™éœ€è¦è¿›è¡Œä¸€ä¸ªæ•°æ®ç»“æ„çš„è½¬æ¢ã€‚</span></span><br><span class="line">  FlatBufferModel* model = <span class="built_in">convertLongToModel</span>(env, model_handle);</span><br><span class="line">  <span class="keyword">if</span> (model == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  BufferErrorReporter* error_reporter =</span><br><span class="line">      <span class="built_in">convertLongToErrorReporter</span>(env, error_handle);</span><br><span class="line">  <span class="keyword">if</span> (error_reporter == <span class="literal">nullptr</span>) <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">  std::unique_ptr&lt;OpResolver&gt; resolver =</span><br><span class="line">      std::<span class="built_in">make_unique</span>&lt;tflite::jni::OpResolverLazyDelegateProxy&gt;(</span><br><span class="line">          tflite::<span class="built_in">CreateOpResolver</span>(), useXnnpack != JNI_FALSE);</span><br><span class="line"></span><br><span class="line">  <span class="function">InterpreterBuilder <span class="title">interpreter_builder</span><span class="params">(*model, *resolver)</span></span>;</span><br><span class="line">  interpreter_builder.<span class="built_in">SetNumThreads</span>(<span class="built_in">static_cast</span>&lt;<span class="type">int</span>&gt;(num_threads));</span><br><span class="line"></span><br><span class="line">  <span class="comment">// Add delegate_list to interpreter_builder.</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">// Java: int size = delegate_list.size();</span></span><br><span class="line">  jint size = env-&gt;<span class="built_in">CallIntMethod</span>(delegate_handle_list, list_size_method);</span><br><span class="line">  <span class="keyword">for</span> (jint i = <span class="number">0</span>; i &lt; size; ++i) &#123;</span><br><span class="line">    <span class="comment">// Java: Long jdelegate_handle = delegate_handle_list-&gt;get(i);</span></span><br><span class="line">    jobject jdelegate_handle =</span><br><span class="line">        env-&gt;<span class="built_in">CallObjectMethod</span>(delegate_handle_list, list_get_method, i);</span><br><span class="line">    <span class="keyword">if</span> (jdelegate_handle == <span class="literal">nullptr</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">        <span class="built_in">ThrowException</span>(env, tflite::jni::kIllegalArgumentException,</span><br><span class="line">                       <span class="string">&quot;Internal error: null object in Delegate handle list&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// Java: long delegate_handle = jdelegate_handle.longValue();</span></span><br><span class="line">    jlong delegate_handle =</span><br><span class="line">        env-&gt;<span class="built_in">CallLongMethod</span>(jdelegate_handle, long_value_method);</span><br><span class="line">    <span class="keyword">if</span> (delegate_handle == <span class="number">0</span>) &#123;</span><br><span class="line">      <span class="keyword">if</span> (!env-&gt;<span class="built_in">ExceptionCheck</span>()) &#123;</span><br><span class="line">        <span class="built_in">ThrowException</span>(env, tflite::jni::kIllegalArgumentException,</span><br><span class="line">                       <span class="string">&quot;Internal error: Found invalid handle&quot;</span>);</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">auto</span> delegate = <span class="built_in">reinterpret_cast</span>&lt;TfLiteOpaqueDelegate*&gt;(delegate_handle);</span><br><span class="line">    interpreter_builder.<span class="built_in">AddDelegate</span>(delegate);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>çœ‹æ¥æ ¸å¿ƒå°±åœ¨ç¬¬15è¡Œå¼€å§‹çš„å‡½æ•°ã€‚è¿™ä¸€è¡Œæ˜¯ä»€ä¹ˆæ„æ€å‘¢ï¼ŒæŠŠä¸€äº›ä¿®é¥°ç¬¦åˆ å»åå¯ä»¥çŸ¥é“ï¼Œ<code>resolver = OpResolverLazyDelegateProxy(CreateOpResolver(), useXnnpack != JNI_FALSE) </code> æ‰€ä»¥æˆ‘ä»¬å…ˆçœ‹çœ‹ <code>CreateOpResolver</code> å¹²äº†ä»€ä¹ˆäº‹æƒ…ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/create_op_resolver_with_selected_ops.cc</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;MutableOpResolver&gt; <span class="title">CreateOpResolver</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  std::unique_ptr&lt;MutableOpResolver&gt; resolver =</span><br><span class="line">      std::<span class="built_in">make_unique</span>&lt;MutableOpResolver&gt;();</span><br><span class="line">  <span class="built_in">RegisterSelectedOps</span>(resolver.<span class="built_in">get</span>());</span><br><span class="line">  <span class="keyword">return</span> resolver;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// tensorflow/tensorflow/lite/core/create_op_resolver_with_builtin_ops.cc</span></span><br><span class="line"><span class="function">std::unique_ptr&lt;MutableOpResolver&gt; <span class="title">CreateOpResolver</span><span class="params">()</span> </span>&#123;  <span class="comment">// NOLINT</span></span><br><span class="line">  <span class="keyword">return</span> std::<span class="built_in">unique_ptr</span>&lt;tflite::ops::builtin::BuiltinOpResolver&gt;(</span><br><span class="line">      <span class="keyword">new</span> tflite::ops::builtin::<span class="built_in">BuiltinOpResolverWithoutDefaultDelegates</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">BuiltinOpResolver::<span class="built_in">BuiltinOpResolver</span>() &#123;</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_ABS, <span class="built_in">Register_ABS</span>(), <span class="comment">/* min_version = */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version = */</span> <span class="number">5</span>);</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_HARD_SWISH, <span class="built_in">Register_HARD_SWISH</span>());</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_RELU, <span class="built_in">Register_RELU</span>(), <span class="comment">/* min_version = */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version = */</span> <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_RELU_N1_TO_1, <span class="built_in">Register_RELU_N1_TO_1</span>());</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_RELU_0_TO_1, <span class="built_in">Register_RELU_0_TO_1</span>());</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_RELU6, <span class="built_in">Register_RELU6</span>(), <span class="comment">/* min_version = */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version = */</span> <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_TANH, <span class="built_in">Register_TANH</span>(), <span class="comment">/* min_version = */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version = */</span> <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_LOGISTIC, <span class="built_in">Register_LOGISTIC</span>(),</span><br><span class="line">             <span class="comment">/* min_version = */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version = */</span> <span class="number">3</span>);</span><br><span class="line">  <span class="built_in">AddBuiltin</span>(BuiltinOperator_AVERAGE_POOL_2D, <span class="built_in">Register_AVERAGE_POOL_2D</span>(),</span><br><span class="line">             <span class="comment">/* min_version */</span> <span class="number">1</span>,</span><br><span class="line">             <span class="comment">/* max_version */</span> <span class="number">3</span>);</span><br><span class="line">    </span><br><span class="line"></span><br><span class="line"> <span class="keyword">enum</span> <span class="title class_">BuiltinOperator</span> : <span class="type">int32_t</span> &#123;</span><br><span class="line">  BuiltinOperator_ADD = <span class="number">0</span>,</span><br><span class="line">  BuiltinOperator_AVERAGE_POOL_2D = <span class="number">1</span>,</span><br><span class="line">  BuiltinOperator_CONCATENATION = <span class="number">2</span>,</span><br><span class="line">  BuiltinOperator_CONV_2D = <span class="number">3</span>,</span><br><span class="line">  BuiltinOperator_DEPTHWISE_CONV_2D = <span class="number">4</span>,</span><br><span class="line">  BuiltinOperator_DEPTH_TO_SPACE = <span class="number">5</span>,</span><br><span class="line">  BuiltinOperator_DEQUANTIZE = <span class="number">6</span>,</span><br><span class="line">  BuiltinOperator_EMBEDDING_LOOKUP = <span class="number">7</span>,</span><br><span class="line">  BuiltinOperator_FLOOR = <span class="number">8</span>,</span><br><span class="line">     ...</span><br><span class="line">  BuiltinOperator_ABS = <span class="number">101</span>,</span><br><span class="line">     ...</span><br><span class="line">         </span><br><span class="line"><span class="comment">//tensorflow/tensorflow/lite/kernels/elementwise.cc   </span></span><br><span class="line"><span class="comment">// elementwise::ElementWiseQuantizedInitï¼šè¿™ä¸ªå‡½æ•°ç”¨äºåˆå§‹åŒ–ä¸€ä¸ªé€å…ƒç´ è¿ç®—çš„ç®—å­ï¼Œå®ƒä¼šæ ¹æ®è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ç±»å‹å’Œé‡åŒ–å‚æ•°ï¼Œåˆ›å»ºä¸€ä¸ªé€å…ƒç´ è¿ç®—çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶è¿”å›å…¶æŒ‡é’ˆã€‚</span></span><br><span class="line"><span class="comment">// elementwise::ElementWiseQuantizedFreeï¼šè¿™ä¸ªå‡½æ•°ç”¨äºé‡Šæ”¾ä¸€ä¸ªé€å…ƒç´ è¿ç®—çš„ç®—å­ï¼Œå®ƒä¼šåˆ é™¤ä¹‹å‰åˆ›å»ºçš„é€å…ƒç´ è¿ç®—çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œå¹¶é‡Šæ”¾å…¶å†…å­˜ç©ºé—´ã€‚</span></span><br><span class="line"><span class="comment">// PrepareAbsï¼šè¿™ä¸ªå‡½æ•°ç”¨äºå‡†å¤‡ä¸€ä¸ªç»å¯¹å€¼ç®—å­ï¼Œå®ƒä¼šæ£€æŸ¥è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„å½¢çŠ¶æ˜¯å¦ä¸€è‡´ï¼Œå¹¶æ ¹æ®è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ç±»å‹å’Œé‡åŒ–å‚æ•°ï¼Œè®¡ç®—å‡ºç»å¯¹å€¼è¿ç®—æ‰€éœ€çš„ä¹˜æ³•å’Œåç§»é‡ï¼Œå¹¶ä¿å­˜åœ¨é€å…ƒç´ è¿ç®—çš„ä¸Šä¸‹æ–‡å¯¹è±¡ä¸­ã€‚</span></span><br><span class="line"><span class="comment">// elementwise::AbsEvalï¼šè¿™ä¸ªå‡½æ•°ç”¨äºæ‰§è¡Œä¸€ä¸ªç»å¯¹å€¼ç®—å­ï¼Œå®ƒä¼šæ ¹æ®è¾“å…¥å’Œè¾“å‡ºå¼ é‡çš„ç±»å‹å’Œé‡åŒ–å‚æ•°ï¼Œä»¥åŠä¹‹å‰è®¡ç®—å‡ºçš„ä¹˜æ³•å’Œåç§»é‡ï¼Œå¯¹è¾“å…¥å¼ é‡ä¸­çš„æ¯ä¸ªå…ƒç´ æ±‚å…¶ç»å¯¹å€¼ï¼Œå¹¶å°†ç»“æœå†™å…¥è¾“å‡ºå¼ é‡ä¸­ã€‚</span></span><br><span class="line"><span class="built_in">GENERIC_PREPARE</span>(PrepareAbs, elementwise::IsAbsSupportedType,</span><br><span class="line">                elementwise::kAbsName)</span><br><span class="line">TfLiteRegistration* <span class="built_in">Register_ABS</span>() &#123;</span><br><span class="line">  <span class="type">static</span> TfLiteRegistration r = &#123;elementwise::ElementWiseQuantizedInit,</span><br><span class="line">                                 elementwise::ElementWiseQuantizedFree,</span><br><span class="line">                                 PrepareAbs, elementwise::AbsEval&#125;;</span><br><span class="line">  <span class="keyword">return</span> &amp;r;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br><span class="line"><span class="function">TfLiteStatus <span class="title">AbsEval</span><span class="params">(TfLiteContext* context, TfLiteNode* node)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> TfLiteTensor* input = <span class="built_in">GetInput</span>(context, node, <span class="number">0</span>);</span><br><span class="line">  <span class="type">const</span> TfLiteType type = input-&gt;type;</span><br><span class="line">  <span class="keyword">switch</span> (type) &#123;</span><br><span class="line">    <span class="keyword">case</span> kTfLiteFloat32:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">EvalImpl</span>&lt;<span class="type">float</span>&gt;(context, node, std::abs&lt;<span class="type">float</span>&gt;, type);</span><br><span class="line">    <span class="keyword">case</span> kTfLiteInt8:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">AbsEvalQuantized</span>&lt;<span class="type">int8_t</span>&gt;(context, node, type);</span><br><span class="line">    <span class="keyword">case</span> kTfLiteInt16:</span><br><span class="line">      <span class="keyword">return</span> input-&gt;quantization.type == kTfLiteNoQuantization</span><br><span class="line">                 ? <span class="built_in">AbsInt16EvalImpl</span>(context, node, type)</span><br><span class="line">                 : <span class="built_in">AbsEvalQuantized</span>&lt;<span class="type">int16_t</span>&gt;(context, node, type);</span><br><span class="line">    <span class="keyword">case</span> kTfLiteInt32:</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">EvalImpl</span>&lt;<span class="type">int32_t</span>&gt;(context, node, std::abs&lt;<span class="type">int32_t</span>&gt;, type);</span><br><span class="line">    <span class="keyword">default</span>:</span><br><span class="line">      <span class="built_in">TF_LITE_KERNEL_LOG</span>(context, <span class="string">&quot;Current data type %s is not supported.&quot;</span>,</span><br><span class="line">                         <span class="built_in">TfLiteTypeGetName</span>(type));</span><br><span class="line">      <span class="keyword">return</span> kTfLiteError;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line">     </span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> T&gt;</span><br><span class="line"><span class="function"><span class="keyword">inline</span> TfLiteStatus <span class="title">EvalImpl</span><span class="params">(TfLiteContext* context, TfLiteNode* node,</span></span></span><br><span class="line"><span class="params"><span class="function">                             std::function&lt;T(T)&gt; func,</span></span></span><br><span class="line"><span class="params"><span class="function">                             std::function&lt;TfLiteStatus(T)&gt; validate_input_func,</span></span></span><br><span class="line"><span class="params"><span class="function">                             TfLiteType expected_type)</span> </span>&#123;</span><br><span class="line">  <span class="type">const</span> TfLiteTensor* input;</span><br><span class="line">  <span class="built_in">TF_LITE_ENSURE_OK</span>(context, <span class="built_in">GetInputSafe</span>(context, node, <span class="number">0</span>, &amp;input));</span><br><span class="line">  TfLiteTensor* output;</span><br><span class="line">  <span class="built_in">TF_LITE_ENSURE_OK</span>(context, <span class="built_in">GetOutputSafe</span>(context, node, <span class="number">0</span>, &amp;output));</span><br><span class="line">  <span class="built_in">TF_LITE_ENSURE_TYPES_EQ</span>(context, input-&gt;type, expected_type);</span><br><span class="line">  <span class="type">const</span> <span class="type">int64_t</span> num_elements = <span class="built_in">NumElements</span>(input);</span><br><span class="line">  <span class="type">const</span> T* in_data = <span class="built_in">GetTensorData</span>&lt;T&gt;(input);</span><br><span class="line">  T* out_data = <span class="built_in">GetTensorData</span>&lt;T&gt;(output);</span><br><span class="line">  <span class="keyword">for</span> (<span class="type">int64_t</span> i = <span class="number">0</span>; i &lt; num_elements; ++i) &#123;</span><br><span class="line">    <span class="keyword">if</span> (validate_input_func) &#123;</span><br><span class="line">      <span class="built_in">TF_LITE_ENSURE_OK</span>(context, <span class="built_in">validate_input_func</span>(in_data[i]));</span><br><span class="line">    &#125;</span><br><span class="line">    out_data[i] = <span class="built_in">func</span>(in_data[i]);</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> kTfLiteOk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥å‘ç°æ³¨å†Œäº†å¾ˆå¤šå†…ç½®çš„ç®—å­ã€‚è¿™äº›ç®—å­åº”è¯¥æ˜¯tensorflowä¸­å®ç°çš„ã€‚å®ç°éƒ½åœ¨tensorflow&#x2F;tensorflow&#x2F;lite&#x2F;kernelsæ–‡ä»¶å¤¹ä¸­ã€‚ç„¶åå®é™…æ ¸å¿ƒè¿ç®—å¯ä»¥çœ‹åˆ°ï¼Œä½¿ç”¨çš„æ˜¯stdæ ‡å‡†åº“ä¸­çš„<code>std::abs&lt;int32_t&gt;</code>, è¿™é‡Œå°±èƒ½å¤Ÿå’Œå†…æ ¸é©±åŠ¨è¿›è¡Œä¸€ä¸ªè¿æ¥ã€‚</p>
<p>ç„¶åå†å›å¤´æ¥çœ‹çœ‹<code>InterpreterBuilder interpreter_builder(*model, *resolver);</code> è¿™ä¸ªè°ƒç”¨äº†ä»¥ä¸‹æ„é€ å‡½æ•°ï¼Œå…¶ä¸­<code>options_experimental</code> ä¸ºé»˜è®¤çš„å‚æ•°, ä¹Ÿå°±æ˜¯è¿›è¡Œä¸€äº›èµ‹å€¼åè¿”å›ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/core/interpreter_builder.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">InterpreterBuilder</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:</span><br><span class="line">  <span class="comment">/// For this constructor, the ErrorReporter will be extracted from the</span></span><br><span class="line">  <span class="comment">/// FlatBufferModel.</span></span><br><span class="line">  <span class="comment">/// `options` object is copied during construction. So caller can release it</span></span><br><span class="line">  <span class="comment">// after calling the constructor.</span></span><br><span class="line">  <span class="built_in">InterpreterBuilder</span>(<span class="type">const</span> FlatBufferModel&amp; model,</span><br><span class="line">                     <span class="type">const</span> OpResolver&amp; op_resolver,</span><br><span class="line">                     <span class="type">const</span> InterpreterOptions* options_experimental = <span class="literal">nullptr</span>);</span><br><span class="line">    </span><br><span class="line">    </span><br><span class="line"><span class="comment">// tensorflow/tensorflow/lite/core/interpreter_builder.cc</span></span><br><span class="line">InterpreterBuilder::<span class="built_in">InterpreterBuilder</span>(</span><br><span class="line">    <span class="type">const</span> FlatBufferModel&amp; model, <span class="type">const</span> OpResolver&amp; op_resolver,</span><br><span class="line">    <span class="type">const</span> InterpreterOptions* options_experimental)</span><br><span class="line">    : <span class="built_in">model_</span>(model.<span class="built_in">GetModel</span>()),</span><br><span class="line">      <span class="built_in">op_resolver_</span>(op_resolver),</span><br><span class="line">      <span class="built_in">error_reporter_</span>(<span class="built_in">ValidateErrorReporter</span>(model.<span class="built_in">error_reporter</span>())),</span><br><span class="line">      <span class="built_in">metadata_</span>(model.<span class="built_in">ReadAllMetadata</span>()),</span><br><span class="line">      <span class="built_in">allocation_</span>(model.<span class="built_in">allocation</span>()) &#123;</span><br><span class="line">  <span class="keyword">if</span> (options_experimental) &#123;</span><br><span class="line">    options_ = *options_experimental;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h2 id="è¿è¡Œæ¨¡å‹"><a href="#è¿è¡Œæ¨¡å‹" class="headerlink" title="è¿è¡Œæ¨¡å‹"></a>è¿è¡Œæ¨¡å‹</h2><p>â€‹	è¿è¡Œæ¨¡å‹é¦–å…ˆè¿˜æ˜¯è°ƒç”¨çš„æ˜¯javaçš„APIï¼Œè¿™é‡Œæ˜¯runå‡½æ•°ã€‚è¿™ä¸ªå‡½æ•°å…ˆåˆ¤æ–­ä¸€äº›é”™è¯¯æ£€æŸ¥ï¼Œç„¶åè·å–åˆ°input tensorï¼Œè¿™ä¸ªå¯ä»¥ä»ä¹‹å‰è¯´è¿‡çš„graphä¸­çš„indexè·å–ã€‚ç„¶åå¦‚æœæ²¡æœ‰ç»™tensoråˆ†é…ç©ºé—´åˆ™åˆ†é…ç©ºé—´ã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/java/src/main/java/org/tensorflow/lite/NativeInterpreterWrapper.java</span></span><br><span class="line"><span class="keyword">void</span> <span class="title function_">run</span><span class="params">(Object[] inputs, Map&lt;Integer, Object&gt; outputs)</span> &#123;</span><br><span class="line">    <span class="comment">// some error check</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// get input tensor and allocate space</span></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; inputs.length; ++i) &#123;</span><br><span class="line">      <span class="type">TensorImpl</span> <span class="variable">tensor</span> <span class="operator">=</span> getInputTensor(i);</span><br><span class="line">      <span class="type">int</span>[] newShape = tensor.getInputShapeIfDifferent(inputs[i]);</span><br><span class="line">      <span class="keyword">if</span> (newShape != <span class="literal">null</span>) &#123;</span><br><span class="line">        resizeInput(i, newShape);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">boolean</span> <span class="variable">allocatedTensors</span> <span class="operator">=</span> allocateTensorsIfNeeded();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; inputs.length; ++i) &#123;</span><br><span class="line">      getInputTensor(i).setTo(inputs[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="type">long</span> <span class="variable">inferenceStartNanos</span> <span class="operator">=</span> System.nanoTime();</span><br><span class="line">    run(interpreterHandle, errorHandle);</span><br><span class="line">    <span class="type">long</span> <span class="variable">inferenceDurationNanoseconds</span> <span class="operator">=</span> System.nanoTime() - inferenceStartNanos;</span><br><span class="line">    ......</span><br><span class="line"></span><br><span class="line">        </span><br><span class="line"><span class="comment">// tensorflow/tensorflow/lite/java/src/main/java/org/tensorflow/lite/NativeInterpreterWrapper.java        </span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">native</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">(<span class="type">long</span> interpreterHandle, <span class="type">long</span> errorHandle)</span>;</span><br></pre></td></tr></table></figure>

<p>æœ€ååˆè°ƒç”¨äº†é‡è½½çš„runå‡½æ•°ï¼Œå¯ä»¥çœ‹åˆ°åˆæ˜¯ä¸€ä¸ªJNIè·³è½¬ï¼Œäºæ˜¯å†æ¬¡å›åˆ°<code>tensorflow/tensorflow/lite/java/src/main/native/nativeinterpreterwrapper_jni.cc</code> æœç´¢è·³è½¬çš„åŒ…è£…å‡½æ•°runã€‚</p>
<figure class="highlight java"><table><tr><td class="code"><pre><span class="line">JNIEXPORT <span class="keyword">void</span> JNICALL <span class="title function_">Java_org_tensorflow_lite_NativeInterpreterWrapper_run</span><span class="params">(</span></span><br><span class="line"><span class="params">    JNIEnv* env, jclass clazz, jlong interpreter_handle, jlong error_handle)</span> &#123;</span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (interpreter-&gt;Invoke() != kTfLiteOk) &#123;</span><br><span class="line">    <span class="comment">// TODO(b/168266570): Return InterruptedException.</span></span><br><span class="line">    ThrowException(env, tflite::jni::kIllegalArgumentException,</span><br><span class="line">                   <span class="string">&quot;Internal error: Failed to run on the given Interpreter: %s&quot;</span>,</span><br><span class="line">                   error_reporter-&gt;CachedErrorMessage());</span><br><span class="line">    <span class="keyword">return</span>;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	æ ¸å¿ƒåœ¨äºç¬¬äº”è¡Œï¼Œè°ƒç”¨äº†interpreterç»“æ„ä½“çš„invokeå‡½æ•°ã€‚æˆ‘ä»¬çœ‹çœ‹invokeå‡½æ•°åšäº†ä»€ä¹ˆ, è¿™ä¸ªinterpreterå·²ç»æ˜¯C++çš„ç»“æ„ä½“äº†ï¼Œä¸å†æ˜¯javaçš„ç»“æ„ä½“äº†ï¼Œæ‰€ä»¥ç›´æ¥è°ƒç”¨çš„C++ä»£ç ï¼Œåœ¨<code>tensorflow/tensorflow/lite/core/interpreter.cc</code>æ–‡ä»¶ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">// tensorflow/tensorflow/lite/core/interpreter.cc</span></span><br><span class="line"><span class="function">TfLiteStatus <span class="title">Interpreter::Invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="function">ScopedRuntimeInstrumentationProfile <span class="title">scoped_runtime_event</span><span class="params">(root_profiler_.get(),</span></span></span><br><span class="line"><span class="params"><span class="function">                                                           <span class="string">&quot;invoke&quot;</span>)</span></span>;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line"></span><br><span class="line">  <span class="built_in">TF_LITE_ENSURE_STATUS_WITH_SCOPED_INSTRUMENTATION</span>(</span><br><span class="line">      scoped_runtime_event, <span class="built_in">primary_subgraph</span>().<span class="built_in">Invoke</span>());</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!allow_buffer_handle_output_) &#123;</span><br><span class="line">    <span class="keyword">for</span> (<span class="type">int</span> tensor_index : <span class="built_in">outputs</span>()) &#123;</span><br><span class="line">      <span class="built_in">TF_LITE_ENSURE_STATUS_WITH_SCOPED_INSTRUMENTATION</span>(</span><br><span class="line">          scoped_runtime_event,</span><br><span class="line">          <span class="built_in">primary_subgraph</span>().<span class="built_in">EnsureTensorDataIsReadable</span>(tensor_index));</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">return</span> kTfLiteOk;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>â€‹	å¯ä»¥å‘ç°è°ƒç”¨äº†<code>primary_subgraph().Invoke()</code>,æˆ‘ä»¬å…ˆçœ‹çœ‹<code>primary_subgraph()</code> æ˜¯ä»€ä¹ˆä¸œè¥¿:</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">  <span class="comment">//tensorflow/tensorflow/lite/core/interpreter.h</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">Interpreter</span> &#123;</span><br><span class="line"> <span class="keyword">public</span>:  </span><br><span class="line">    <span class="function">Subgraph&amp; <span class="title">primary_subgraph</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">return</span> *subgraphs_.<span class="built_in">front</span>();  <span class="comment">// Safe as subgraphs_ always has 1 entry.</span></span><br><span class="line">      &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="comment">// Subgraphs</span></span><br><span class="line">  std::vector&lt;std::unique_ptr&lt;Subgraph&gt;&gt; subgraphs_;</span><br><span class="line">   <span class="comment">// ......</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">	<span class="comment">//tensorflow/tensorflow/lite/core/interpreter.cc</span></span><br><span class="line">    Interpreter::<span class="built_in">Interpreter</span>(ErrorReporter* error_reporter)</span><br><span class="line">        : <span class="built_in">error_reporter_</span>(error_reporter ? error_reporter</span><br><span class="line">                                         : <span class="built_in">DefaultErrorReporter</span>()) &#123;</span><br><span class="line">    <span class="comment">//......</span></span><br><span class="line">            <span class="built_in">AddSubgraphs</span>(<span class="number">1</span>);</span><br><span class="line">            ...</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Interpreter::AddSubgraphs</span><span class="params">(<span class="type">int</span> subgraphs_to_add,</span></span></span><br><span class="line"><span class="params"><span class="function">                                   <span class="type">int</span>* first_new_subgraph_index)</span> </span>&#123;</span><br><span class="line">       <span class="comment">// first_new_subgraph_index é»˜è®¤æ˜¯nullptr</span></span><br><span class="line">      <span class="type">const</span> <span class="type">size_t</span> base_index = subgraphs_.<span class="built_in">size</span>();</span><br><span class="line">      <span class="keyword">if</span> (first_new_subgraph_index) *first_new_subgraph_index = base_index;</span><br><span class="line"></span><br><span class="line">      subgraphs_.<span class="built_in">reserve</span>(base_index + subgraphs_to_add);</span><br><span class="line">      <span class="keyword">for</span> (<span class="type">int</span> i = <span class="number">0</span>; i &lt; subgraphs_to_add; ++i) &#123;</span><br><span class="line">        Subgraph* subgraph = <span class="keyword">new</span> <span class="built_in">Subgraph</span>(</span><br><span class="line">            error_reporter_, external_contexts_, &amp;subgraphs_, &amp;resources_,</span><br><span class="line">            &amp;resource_ids_, &amp;initialization_status_map_, subgraphs_.<span class="built_in">size</span>());</span><br><span class="line">        subgraphs_.<span class="built_in">emplace_back</span>(subgraph);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p> è¿™é‡Œè®¾è®¡åˆ°äº†ä¸€ä¸ª<code>subgraphs_</code>çš„å˜é‡ï¼Œè¿™æ˜¯ä»€ä¹ˆå‘¢ï¼Œè¿™å…¶å®æ˜¯ä¸€ä¸ªå­å›¾çš„vectorå®¹å™¨ï¼Œåœ¨åˆ›å»ºInterpreteræ—¶ï¼Œå…¶æœ‰ä¸€ä¸ªç§æœ‰çš„æˆå‘˜å˜é‡ä¸º<code>subgraphs_</code>, å¹¶ä¸”åœ¨Interpreterçš„æ„é€ å‡½æ•°ä¸­ä¼šå°†indexä¸º0çš„å›¾åŠ å…¥è¿™ä¸ªvectorä¸­ï¼Œä¹Ÿå°±æ˜¯è¯´primary_subgraphå°±æ˜¯æœ€åˆå®Œæ•´çš„é‚£ä¸ªæ¨¡å‹å›¾ï¼Œåç»­ä¼šå¯¹è¿™ä¸ªå›¾è¿›è¡Œåˆ†è£‚æˆå„ä¸ªå­å›¾ã€‚è¿™ä¸€éƒ¨åˆ†åœ¨table subgraphä¸­å·²ç»è®²å¾—å¾ˆæ˜ç¡®äº†ã€‚	</p>
<p>â€‹	OKï¼Œ çŸ¥é“äº†å°±æ˜¯è·å–åˆ°ä»æ–‡ä»¶ä¸­è¯»å–åˆ°çš„æ¨¡å‹å›¾ï¼Œç„¶åå›æ¥<code>invoke</code>å‡½æ•°,åˆæ˜¯ä¸€å±‚çš®ï¼Œè¿˜è°ƒç”¨äº†<code>InvokeImpl</code>ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="comment">//tensorflow/tensorflow/lite/core/subgraph.cc</span></span><br><span class="line"><span class="function">TfLiteStatus <span class="title">Subgraph::Invoke</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> status = <span class="built_in">InvokeImpl</span>();</span><br><span class="line">  telemetry::<span class="built_in">TelemetryReportEvent</span>(&amp;context_, <span class="string">&quot;Invoke&quot;</span>, status);</span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function">TfLiteStatus <span class="title">Subgraph::InvokeImpl</span><span class="params">()</span> </span>&#123;</span><br><span class="line">  </span><br><span class="line">  <span class="comment">// ......</span></span><br><span class="line">  </span><br><span class="line">    <span class="built_in">EnsureTensorsVectorCapacity</span>();</span><br><span class="line">    tensor_resized_since_op_invoke_ = <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">auto</span> s = <span class="built_in">OpInvoke</span>(registration, &amp;node); s != kTfLiteOk) &#123;</span><br><span class="line">      <span class="keyword">auto</span> err = <span class="built_in">ReportOpError</span>(&amp;context_, node, registration, node_index,</span><br><span class="line">                               <span class="string">&quot;failed to invoke&quot;</span>);</span><br><span class="line">      <span class="keyword">return</span> s == kTfLiteCancelled ? s : err;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">   <span class="comment">//......</span></span><br><span class="line">  <span class="keyword">return</span> status;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥å‘ç°è°ƒç”¨äº†<code>OpInvoke</code>å‡½æ•°, ç„¶åä»–åˆè°ƒç”¨äº†Registrationçš„invokeå‡½æ•°ï¼Œè¿™å°±å’Œå‰é¢ç»“åˆèµ·æ¥äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">TfLiteStatus <span class="title">Subgraph::OpInvoke</span><span class="params">(<span class="type">const</span> TfLiteRegistration&amp; op_reg,</span></span></span><br><span class="line"><span class="params"><span class="function">                                TfLiteNode* node)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">if</span> (op_reg.registration_external &amp;&amp;</span><br><span class="line">      op_reg.registration_external-&gt;node_index != <span class="number">-1</span>) &#123;</span><br><span class="line">    TfLiteRegistration* referenced_registration =</span><br><span class="line">        &amp;nodes_and_registration_[op_reg.registration_external-&gt;node_index]</span><br><span class="line">             .second;</span><br><span class="line">    <span class="keyword">if</span> (referenced_registration-&gt;invoke == <span class="literal">nullptr</span>) <span class="keyword">return</span> kTfLiteError;</span><br><span class="line">    <span class="keyword">return</span> referenced_registration-&gt;<span class="built_in">invoke</span>(&amp;context_, node);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (op_reg.registration_external &amp;&amp; op_reg.registration_external-&gt;invoke) &#123;</span><br><span class="line">    <span class="keyword">return</span> op_reg.registration_external-&gt;<span class="built_in">invoke</span>(</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;TfLiteOpaqueContext*&gt;(&amp;context_),</span><br><span class="line">        <span class="built_in">reinterpret_cast</span>&lt;TfLiteOpaqueNode*&gt;(node));</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">if</span> (op_reg.invoke == <span class="literal">nullptr</span>) <span class="keyword">return</span> kTfLiteError;</span><br><span class="line">  <span class="keyword">return</span> op_reg.<span class="built_in">invoke</span>(&amp;context_, node);</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h2 id="å§”æ‰˜"><a href="#å§”æ‰˜" class="headerlink" title="å§”æ‰˜"></a>å§”æ‰˜</h2><p>åœ¨è¿è¡Œæ¨¡å‹é‚£éƒ¨åˆ†ä»£ç æœ€åå‡ºç°äº†ä¸€ä¸ªç»“æ„ä½“<code>TfLiteRegistrationExternal</code>, è¿™ä¸ªç±»éœ€è¦å’Œ<code>TfLiteRegistration</code> ä¸€èµ·åˆ†æã€‚</p>
<h2 id="å‚è€ƒé“¾æ¥"><a href="#å‚è€ƒé“¾æ¥" class="headerlink" title="å‚è€ƒé“¾æ¥"></a>å‚è€ƒé“¾æ¥</h2><p><a href="https://blog.actorsfit.com/a?ID=01000-9ed722be-d08c-4d27-a81e-157358f946e1">TensorFlow Lite æºä»£ç åˆ†æ-æ¨¡å‹åŠ è½½å’Œæ‰§è¡Œ - actorfit (actorsfit.com)</a></p>
<p><a href="https://www.bilibili.com/video/av24219725/">TensorFlow Lite æ·±åº¦è§£æ - è°·æ­Œä¸­å›½å·¥ç¨‹å¸ˆæ•™å­¦è§†é¢‘_å“”å“©å“”å“©_bilibili</a></p>
<p><a href="https://resources.linaro.org/en/resource/ZDqBmZ9TWNc3Yi5vQeiqWF">LVC21-113: TensorFlow Lite Delegates on Arm-based Devices | Linaro Resources Hub</a></p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>gpu</tag>
      </tags>
  </entry>
  <entry>
    <title>cudaå’ŒGPUçš„æ¢ç´¢(è½¬è‡ªå‘¨æ¨å¶)</title>
    <url>/2023/09/14/note/cuda_and_GPU/</url>
    <content><![CDATA[<h1 id="cudaå’ŒGPUçš„æ¢ç´¢"><a href="#cudaå’ŒGPUçš„æ¢ç´¢" class="headerlink" title="cudaå’ŒGPUçš„æ¢ç´¢"></a>cudaå’ŒGPUçš„æ¢ç´¢</h1><h2 id="ç®€å•çš„cudaç¨‹åºæ ·ä¾‹"><a href="#ç®€å•çš„cudaç¨‹åºæ ·ä¾‹" class="headerlink" title="ç®€å•çš„cudaç¨‹åºæ ·ä¾‹"></a>ç®€å•çš„cudaç¨‹åºæ ·ä¾‹</h2><figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cuda_runtime.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;cassert&gt;</span></span></span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">add_vector</span><span class="params">(<span class="type">int</span>* res,<span class="type">int</span>* a,<span class="type">int</span>* b,<span class="type">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> index=threadIdx.x+blockIdx.x*blockDim.x;</span><br><span class="line">    <span class="keyword">if</span>(index&lt;num)&#123;</span><br><span class="line">        res[index]=a[index]+b[index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">random_array</span><span class="params">(<span class="type">int</span>* a,<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;n;i++)&#123;</span><br><span class="line">        a[i]=<span class="built_in">rand</span>();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    <span class="type">int</span>* h_a;</span><br><span class="line">    <span class="type">int</span>* h_b;</span><br><span class="line">    <span class="type">int</span>* h_res;</span><br><span class="line">    <span class="type">int</span>* cuda_a;</span><br><span class="line">    <span class="type">int</span>* cuda_b;</span><br><span class="line">    <span class="type">int</span>* cuda_res;</span><br><span class="line"></span><br><span class="line">    <span class="type">int</span> num=<span class="number">2048</span>*<span class="number">2048</span>;</span><br><span class="line">    <span class="type">int</span> numbyte=num*<span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">    h_a=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line">    h_b=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line">    h_res=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line">    <span class="built_in">random_array</span>(h_a,num);</span><br><span class="line">    <span class="built_in">random_array</span>(h_b,num);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cudaMalloc</span>(&amp;cuda_a,numbyte);</span><br><span class="line">    <span class="built_in">cudaMalloc</span>(&amp;cuda_b,numbyte);</span><br><span class="line">    <span class="built_in">cudaMalloc</span>(&amp;cuda_res,numbyte);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(cuda_a,h_a,numbyte,cudaMemcpyHostToDevice);</span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(cuda_b,h_b,numbyte,cudaMemcpyHostToDevice);</span><br><span class="line">    add_vector&lt;&lt;&lt;num/<span class="number">512</span>,<span class="number">512</span>&gt;&gt;&gt;(cuda_res,cuda_a,cuda_b);</span><br><span class="line">    <span class="built_in">cudaMemcpy</span>(h_res,cuda_res,numbyte,cudaMemcpyDeviceToHost);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">for</span>(<span class="type">int</span> i=<span class="number">0</span>;i&lt;num;i++)&#123;</span><br><span class="line">        <span class="built_in">assert</span>(h_res==h_a+h_b);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">cudaFree</span>(cuda_a);</span><br><span class="line">    <span class="built_in">cudaFree</span>(cuda_b);</span><br><span class="line">    <span class="built_in">cudaFree</span>(cuda_res);</span><br><span class="line">    <span class="built_in">free</span>(h_a);</span><br><span class="line">    <span class="built_in">free</span>(h_b);</span><br><span class="line">    <span class="built_in">free</span>(h_res);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯ä¸€ä¸ªdemoå®ç°çš„æ˜¯ä½¿ç”¨GPUè¿›è¡Œå‘é‡åŠ æ³•çš„åŠ é€Ÿï¼Œæˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹è¿™ä¸ªç®€å•çš„ç¨‹åºã€‚</p>
<p>é¦–å…ˆæ˜¯æ— èŠçš„å‰æœŸå‡†å¤‡å·¥ä½œï¼Œç»™h_aã€h_bã€h_resä¸‰ä¸ªæ•°ç»„åˆ†é…numå¤§å°çš„æ•°ç»„ç©ºé—´ï¼Œç„¶åç”¨éšæœºæ•°åˆå§‹åŒ–h_aã€h_bæ•°ç»„ï¼Œç›®æ ‡æ˜¯è®¡ç®—h_aå’Œh_bæ±‚å’Œçš„ç»“æœï¼Œä¿å­˜åˆ°h_resä¸­</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> num=<span class="number">2048</span>*<span class="number">2048</span>;</span><br><span class="line"><span class="type">int</span> numbyte=num*<span class="built_in">sizeof</span>(<span class="type">int</span>);</span><br><span class="line">h_a=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line">h_b=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line">h_res=(<span class="type">int</span>*)<span class="built_in">malloc</span>(numbyte);</span><br><span class="line"><span class="built_in">random_array</span>(h_a,num);</span><br><span class="line"><span class="built_in">random_array</span>(h_b,num);</span><br></pre></td></tr></table></figure>
<p>ä¸ºäº†è®©GPUå¯ä»¥è®¡ç®—h_aå’Œh_bæ•°ç»„çš„å†…å®¹ï¼Œä½†æ˜¯GPUåªèƒ½ç›´æ¥è®¿é—®GPUè‡ªå·±çš„ä¸“å±ç°å­˜çš„æ•°æ®ï¼Œæ— æ³•ç›´æ¥è®¿é—®CPUä¸Šé¢çš„å†…å®¹ï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦é¦–å…ˆæŠŠéœ€è¦è®¡ç®—çš„æ•°æ®ä»hostè®¾å¤‡(CPUçš„å†…å­˜)ç§»åˆ°deviceè®¾å¤‡(GPUå†…å­˜)ä¸Šæ¥ã€‚</p>
<p>cudaMalloc(void** ptr,int num)å‡½æ•°ä¼ å…¥ä¸€ä¸ªæŒ‡é’ˆçš„åœ°å€ï¼Œç„¶åå®ƒä¼šå‘GPUç”³è¯·åˆ†é…ä¸€å—numå­—èŠ‚çš„æ˜¾å­˜ç©ºé—´ï¼Œæ˜¾å­˜ç©ºé—´çš„é¦–åœ°å€è¢«ä¿å­˜åˆ°ptræŒ‡å‘çš„æŒ‡é’ˆå½“ä¸­ã€‚äºæ˜¯æˆ‘ä»¬å‘GPUç”³è¯·äº†ä¸‰å—å¤§å°ä¸ºnumbyteçš„æ˜¾å­˜ç©ºé—´ï¼Œåœ°å€è¢«ä¿å­˜åˆ°cuda_aã€cuda_bã€cuda_resä¸‰ä¸ªå˜é‡å½“ä¸­ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cudaMalloc</span>(&amp;cuda_a,numbyte);</span><br><span class="line"><span class="built_in">cudaMalloc</span>(&amp;cuda_b,numbyte);</span><br><span class="line"><span class="built_in">cudaMalloc</span>(&amp;cuda_res,numbyte);</span><br></pre></td></tr></table></figure>
<p>éœ€è¦æ³¨æ„mallocç”³è¯·çš„æ˜¯Hostçš„è™šæ‹Ÿåœ°å€ï¼Œåªæœ‰åœ¨Hostä¸Šä½¿ç”¨æ˜¯æœ‰æ„ä¹‰çš„ï¼›cudaMallocç”³è¯·çš„æ˜¯Deviceçš„è™šæ‹Ÿåœ°å€ï¼Œåªæœ‰æŠŠè¿™ä¸ªåœ°å€çš„å€¼ä¼ é€ç»™Deviceï¼Œè®©Deviceä½¿ç”¨æ‰æ˜¯æœ‰æ„ä¹‰çš„ã€‚</p>
<p>ç„¶åæˆ‘ä»¬ä½¿ç”¨cudaMemcpyå‡½æ•°æŠŠHostçš„h_aå’Œh_bå‘é‡çš„æ•°æ®ä¼ é€’åˆ°Deviceçš„cuda_aã€cuda_bæ•°ç»„ä¸Šé¢ã€‚<code>cudaMemcpy(void* dst,void* src,int num,enum kind)</code>ä¸­kindæŒ‡ç¤ºäº†è½¬é€’çš„ç±»å‹ï¼Œå¦‚æœæ˜¯cudaMemcpyHostToDeviceé‚£ä¹ˆå°±æ˜¯ä»Hostçš„å†…å­˜ä¼ é€’æ•°æ®ç»™Deviceï¼Œdstéœ€è¦æ˜¯Deviceåœ°å€ï¼Œsrcéœ€è¦æ˜¯Hoståœ°å€ï¼›cudaMemcpyDeviceToHostå°±æ˜¯ä»Devieå†…å­˜ä¼ é€’æ•°æ®ç»™Hostï¼Œdstéœ€è¦æ—¶Hoståœ°å€ï¼Œsrcæ˜¯Deviceåœ°å€ã€‚æ‰€ä»¥ç°åœ¨GPUè·å¾—ä»–éœ€è¦çš„æ•°æ®äº†ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cudaMemcpy</span>(cuda_a,h_a,numbyte,cudaMemcpyHostToDevice);</span><br><span class="line"><span class="built_in">cudaMemcpy</span>(cuda_b,h_b,numbyte,cudaMemcpyHostToDevice);</span><br></pre></td></tr></table></figure>
<p>GPUçš„æ•°æ®å·²ç»å°±ä½äº†ï¼Œä¸‹ä¸€æ­¥å°±æ˜¯è¿è¡ŒGPUçš„ç¨‹åºï¼Œä¹Ÿå°±æ˜¯å¦‚ä¸‹ä»£ç ã€‚åœ¨cudaå½“ä¸­ç”¨__host__ä¿®é¥°çš„å°±æ˜¯CPUæ‰§è¡Œçš„ä»£ç ï¼Œå¯ä»¥çœç•¥ä¸å†™ï¼Œç”¨__global__ä¿®é¥°çš„å°±æ˜¯GPUæ‰§è¡Œçš„ä»£ç ï¼Œè¿™éƒ¨åˆ†å‡½æ•°ä¼šè¢«ç¼–è¯‘å¾—åˆ°GPUçš„å¯æ‰§è¡Œæ–‡ä»¶ï¼Œç„¶ååœ¨è¿è¡Œadd_Vectorçš„æ—¶å€™è¢«å‘é€ç»™GPUï¼ŒGPUå°±ä¼šè¿è¡Œè¿™éƒ¨åˆ†ä»£ç å®ç°æˆ‘ä»¬éœ€è¦çš„å‘é‡åŠ æ³•åŠŸèƒ½ã€‚</p>
<p><code>add_vector&lt;&lt;&lt;num/512,512&gt;&gt;&gt;(cuda_res,cuda_a,cuda_b);</code>è¿™æ˜¯cudaçš„GPUä»£ç ç‰¹æœ‰çš„è°ƒç”¨æ–¹å¼ï¼Œæˆ‘ä»¬åç»­å†è¿›è¡Œä»‹ç»ï¼Œæ€»ä¹‹å®ƒè°ƒç”¨äº†GPUåšadd_vectorï¼Œå®ç°äº†cuda_aå’Œcuda_bçš„å‘é‡ç›¸åŠ ï¼Œå¹¶ä¸”æŠŠç»“æœåŠ åˆ°äº†cuda_resä¸Šæ¥ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">    add_vector&lt;&lt;&lt;num/<span class="number">512</span>,<span class="number">512</span>&gt;&gt;&gt;(cuda_res,cuda_a,cuda_b);</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">add_vector</span><span class="params">(<span class="type">int</span>* res,<span class="type">int</span>* a,<span class="type">int</span>* b,<span class="type">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> index=threadIdx.x+blockIdx.x*blockDim.x;</span><br><span class="line">    <span class="keyword">if</span>(index&lt;num)&#123;</span><br><span class="line">        res[index]=a[index]+b[index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ä¹‹åæˆ‘ä»¬å†æ¬¡è°ƒç”¨cudaMemcpyå°†æ•°æ®ä»GPUçš„cuda_resä¼ é€’åˆ°CPUçš„h_resä¸Šå»ï¼Œå°±å¾—åˆ°äº†h_a+h_bçš„ç»“æœã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cudaMemcpy</span>(h_res,cuda_res,numbyte,cudaMemcpyDeviceToHost);</span><br></pre></td></tr></table></figure>
<p>æœ€ååšä¸€äº›å†…å­˜çš„å›æ”¶ï¼Œfreeå›æ”¶mallocåˆ†é…çš„Hostå†…å­˜ï¼ŒcudaFreeå›æ”¶cudaMallocåˆ†é…çš„Deviceå†…å­˜ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="built_in">cudaFree</span>(cuda_a);</span><br><span class="line"><span class="built_in">cudaFree</span>(cuda_b);</span><br><span class="line"><span class="built_in">cudaFree</span>(cuda_res);</span><br><span class="line"><span class="built_in">free</span>(h_a);</span><br><span class="line"><span class="built_in">free</span>(h_b);</span><br><span class="line"><span class="built_in">free</span>(h_res);</span><br></pre></td></tr></table></figure>

<h2 id="SIMTç¼–ç¨‹æ¨¡å¼"><a href="#SIMTç¼–ç¨‹æ¨¡å¼" class="headerlink" title="SIMTç¼–ç¨‹æ¨¡å¼"></a>SIMTç¼–ç¨‹æ¨¡å¼</h2><p>åœ¨ä»‹ç»<code>__global__ add_vector</code>çš„ä»£ç å’Œè°ƒç”¨ä¸ºä»€ä¹ˆé•¿å¾—è¿™ä¹ˆå¥‡ç‰¹ä¹‹å‰ï¼Œæˆ‘ä»¬å…ˆä»‹ç»ä¸€æ³¢GPUçš„ç»“æ„å’Œç¼–ç¨‹çš„å¯¹åº”å…³ç³»ï¼Œå…·ä½“çš„GPUçš„ä½“ç³»ç»“æ„å’Œå¾®æ¶æ„ä¹‹ç±»çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬ä¹‹åè¯¦è°ˆï¼Œå¦å¤–ç°åœ¨ä»‹ç»çš„GPUç»“æ„æ¨¡å‹æ˜¯ç®€åŒ–è¿‡ã€æŠ½è±¡è¿‡çš„ï¼Œåªæ˜¯ä¸ºäº†æ–¹ä¾¿å¤§å®¶å¿«é€Ÿç†è§£è½¯ä»¶çš„æ„é€ ï¼Œè‡³äºç¡¬ä»¶çœŸæ˜¯æ€ä¹ˆé€‚é…ï¼Œé‚£æ˜¯å¦ä¸€ä¸ªå¤æ‚çš„é—®é¢˜ã€‚</p>
<h3 id="threadä¸core"><a href="#threadä¸core" class="headerlink" title="threadä¸core"></a>threadä¸core</h3><p>å¯¹äºCPUï¼Œæˆ‘ä»¬å¯ä»¥å°†ä¸€ä¸ªprocessç¼–å†™ä¸€ä¸ªå¤šthreadç¨‹åºï¼Œç„¶åæˆ‘ä»¬æœ‰4ä¸ªcoreï¼Œæˆ‘ä»¬å°±å¯ä»¥æ¯æ¬¡è°ƒåº¦4ä¸ªthreadåˆ°4ä¸ªcoreä¸Šï¼Œç„¶åä¸€æ¬¡ç®—4ä¸ªthreadçš„å†…å®¹ã€‚è€Œå¯¹äºGPUæˆ‘ä»¬æœ‰ä¸Šåƒä¸ªcoreï¼Œç”šè‡³ä¸Šä¸‡ä¸ªcoreï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥ç¼–å†™ä¸€ä¸ªæœ‰æ•°ä¸‡threadçš„ç¨‹åºï¼Œç„¶åäº¤ç»™GPUçš„æ•°ä¸‡ä¸ªcoreè¿è¡Œã€‚é«˜åº¦å¹¶è¡Œçš„æ‰¹æ•°æ®å¤„ç†ç¨‹åºå¾ˆé€‚åˆç¼–å†™è¿™ç§å¤šthreadç¨‹åºï¼šæ¯”å¦‚å‘é‡åŠ æ³•ï¼Œæˆ‘ä»¬æŠŠä¸¤ä¸ª1wç»´çš„å‘é‡aå’Œ1wç»´çš„å‘é‡bç›¸åŠ ï¼Œæˆ‘ä»¬å¯ä»¥å†™ä¸€ä¸ª1ä¸‡ä¸ªthreadçš„ç¨‹åºï¼Œç¬¬iä¸ªç¨‹åºè´Ÿè´£æŠŠaçš„ç¬¬iä¸ªåˆ†é‡å’Œbçš„ç¬¬iä¸ªåˆ†é‡ç›¸åŠ ï¼Œè¿™æ ·æ‰€æœ‰çš„threadç®—å®Œï¼Œæˆ‘ä»¬çš„å‘é‡ç›¸åŠ çš„ä»»åŠ¡å°±ç»“æŸäº†ã€‚</p>
<p>æˆ‘ä»¬çœ‹ä¸€ä¸‹ä¸‹é¢çš„ç¨‹åºï¼Œåªæ˜¯ä¹‹å‰çš„ç®€åŒ–ç‰ˆæœ¬ã€‚æˆ‘ä»¬åœ¨add_vectoråé¢çš„&lt;&lt;&lt;&gt;&gt;&gt;å¡«å…¥512ï¼Œå°±è¯´æˆ‘ä»¬éœ€è¦512ä¸ªçº¿ç¨‹ï¼Œé‚£ä¹ˆGPUæ”¶åˆ°æˆ‘ä»¬çš„å‘½ä»¤ä¹‹åå°±ä¼šäº§ç”Ÿ512ä¸ªthreadï¼Œè¿™æœ¬èº«ä¹Ÿæ˜¯GPUå¼ºå¤§çš„åœ°æ–¹ï¼Œä»–å¯ä»¥å¿«é€Ÿåœ°åˆå§‹åŒ–å¤§é‡çš„çº¿ç¨‹ï¼Œè¿™å¯¹äºCPUæ˜¯æ— æ³•åšåˆ°çš„ã€‚ç„¶åè¿™äº›çº¿ç¨‹å°±ä¼šè¢«åˆ†é…åˆ°ç©ºé—²çš„coreä¸Šè¿è¡Œï¼Œæ¯”å¦‚æˆ‘ä»¬æœ‰128ä¸ªcoreï¼Œé‚£ä¹ˆè¿è¡Œ4æ‰¹å°±ç®—å®Œäº†ã€‚å¯¹äºæ‰€æœ‰çš„çº¿ç¨‹ä»–ä»¬éƒ½æ‰§è¡Œadd_vectorçš„ä»£ç ï¼ŒåŸºæœ¬åŒæ—¶å¼€å§‹å¹¶ä¸”åŒæ—¶ç»“æŸï¼Œthreadä¸­é—´å”¯ä¸€çš„åŒºåˆ«æ˜¯å®ƒä»¬çš„threadIdxå·ä¸ä¸€æ ·ï¼Œä¼šè¢«ä¸€æ¬¡æ ‡å·ä¸º0-511ï¼Œè¿™æ˜¯æ¯ä¸ªTCBçš„ä¸€éƒ¨åˆ†ï¼Œé™¤æ­¤ä¹‹å¤–æ²¡æœ‰ä»»ä½•çš„åŒºåˆ«ã€‚ç¨‹åºå‘˜ç¼–ç¨‹çš„æ—¶å€™å¯ä»¥æ ¹æ®è¿™ä¸ªthreadIdx.xä¸åŒæ¥è®¿é—®ä¸åŒçš„æ•°æ®ï¼Œæ¯”å¦‚ç¬¬iä¸ªthreadè®¿é—®ç¬¬iä¸ªå‘é‡åˆ†é‡ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">    add_vector&lt;&lt;&lt;<span class="number">1</span>,<span class="number">512</span>&gt;&gt;&gt;(cuda_res,cuda_a,cuda_b);</span><br><span class="line"></span><br><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">add_vector</span><span class="params">(<span class="type">int</span>* res,<span class="type">int</span>* a,<span class="type">int</span>* b,<span class="type">int</span> num)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> index=threadIdx.x;</span><br><span class="line">    <span class="keyword">if</span>(index&lt;num)&#123;</span><br><span class="line">        res[index]=a[index]+b[index];</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="blockä¸SM"><a href="#blockä¸SM" class="headerlink" title="blockä¸SM"></a>blockä¸SM</h3><p>å¯¹äºä¸€ä¸ªGPUæ¥è¯´ä»–å¯èƒ½æœ‰1024ä¸ªcoreï¼Œå¦‚æœä»–äº§ç”Ÿäº†1024ä¸ªthreadï¼Œç„¶åç”¨ä¸€ä¸ªä¸­å¤®çš„è°ƒåº¦å™¨æŠŠæ¯ä¸€ä¸ªthreadåˆ†é…åˆ°æ¯ä¸€ä¸ªcoreä¸Šé¢ï¼Œå¯¹äºè¿™ä¸ªè°ƒåº¦å™¨æ¥è¯´è¦æ±‚å¤ªå¤§äº†ï¼Œä»–å¿…é¡»åŒæ—¶å…·å¤‡åŒæ—¶å¤„ç†1024ä¸ªå•ç‹¬çº¿ç¨‹è°ƒåº¦çš„èƒ½åŠ›ã€‚åœ¨ç¡¬ä»¶å®ç°ä¸Šï¼Œå¦‚æœ1024ä¸ªcoreå®Œå…¨ç‹¬ç«‹çš„ä¸€çº§å±‚æ¬¡ï¼Œé‚£ä¹ˆå…¶ä»–çš„æ‰€æœ‰éƒ¨ä»¶éƒ½éœ€è¦åŒæ—¶é¢å¯¹1024ä¸ªcoreçš„è°ƒç”¨è¯·æ±‚ï¼Œè¿™ä¸ªä»²è£å‹åŠ›ä¹Ÿå¤ªå¤§äº†ã€‚æ‰€ä»¥å¯¹äºcoreæˆ‘ä»¬éœ€è¦ä¸€ä¸ªäºŒçº§ç»“æ„ç»„ç»‡èµ·æ¥ï¼Œè¿™ä¸ªå°±æ˜¯SM(stream multiprocess)ã€‚</p>
<p>æ¯ä¸ªSMæ¯”å¦‚è¯´åŒ…å«128ä¸ªcoreï¼Œç„¶åä¸€å…±æœ‰8ä¸ªSMï¼›å¯¹åº”çš„æˆ‘ä»¬çš„1024ä¸ªthreadä¹Ÿæ˜¯ï¼Œæˆ‘ä»¬æŠŠthreadç»„ç»‡æˆblockï¼Œæ¯ä¸ªblockåŒ…å«128ä¸ªthreadï¼Œä¸€å…±åªæœ‰8ä¸ªblockã€‚äºæ˜¯æˆ‘ä»¬çš„ä¸­å¤®è°ƒåº¦å™¨å…ˆæŠŠ8ä¸ªblockåˆ†é…åˆ°å¯¹åº”çš„8ä¸ªSMä¸Šå°±å¯ä»¥äº†ï¼Œé‚£ä»–çš„è°ƒåº¦å‹åŠ›å°±éå¸¸å°äº†ï¼Œåªéœ€è¦ç®¡ç†8ä¸ªéƒ¨ä»¶è€Œå·²ã€‚äºæ˜¯æˆ‘ä»¬çš„ç®¡ç†å±‚æ¬¡å°±æ˜¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">grid----block----thread</span><br><span class="line"> GPU----  SM ---- core</span><br></pre></td></tr></table></figure>

<h3 id="warpä¸coreç»„"><a href="#warpä¸coreç»„" class="headerlink" title="warpä¸coreç»„"></a>warpä¸coreç»„</h3><p>æ¯ä¸ªblockåŒ…å«ä»–çš„128ä¸ªthreadåˆ°è¾¾SMä¹‹åï¼ŒSMæœ‰ä¸€ä¸ªäºŒçº§è°ƒåº¦å™¨è´Ÿè´£è°ƒåº¦128ä¸ªthreadï¼Œå‹åŠ›è™½ç„¶ä¸æ˜¯1024é‚£ä¹ˆå¤§äº†ï¼Œä½†æ˜¯è¿˜æ˜¯å¾ˆå¤§ï¼Œæ‰€ä»¥è¿›ä¸€æ­¥åˆ’åˆ†å±‚æ¬¡ï¼Œæˆ‘ä»¬å°†32ä¸ªthreadå½“æˆä¸€ä¸ªæ•´ä½“è°ƒåº¦ï¼Œæˆä¸ºä¸€ä¸ªwarpï¼Œä»–ä»¬æ°¸è¿œåšä¸€æ ·çš„äº‹æƒ…è¢«è°ƒåº¦å™¨å½“ä½œä¸€ä¸ªæ•´ä½“ç®€å•å¤„ç†ã€‚è¿™æ ·çš„è¯æ¯ä¸ªSMå…¶å®åªéœ€è¦è°ƒåº¦4ä¸ªwarpï¼Œé‚£ä¹ˆå®ƒçš„è°ƒåº¦å‹åŠ›ä¹Ÿå˜å¾—å¾ˆå°äº†ï¼Œå¯ä»¥ç”¨ç®€å•çš„æ§åˆ¶é€»è¾‘è§£å†³æ‰ã€‚äºæ˜¯æˆ‘ä»¬çš„ç®¡ç†å±‚æ¬¡å°±å˜ä¸ºäº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">grid----block---- wrap----thread</span><br><span class="line"> GPU----  SM ----cores---- core</span><br></pre></td></tr></table></figure>
<h3 id="GPCä¸cluster"><a href="#GPCä¸cluster" class="headerlink" title="GPCä¸cluster"></a>GPCä¸cluster</h3><p>æ­¤å¤–å¯¹äºGPUæ¥è¯´ï¼Œ8ä¸ªSMç›´æ¥è°ƒåº¦ä¼¼ä¹è¿˜æ˜¯å¤ªå¤šäº†ï¼Œæ‰€ä»¥å°†æ¯”å¦‚4ä¸ªSMç»„ç»‡ä¸ºä¸€ä¸ªGPCï¼Œå°†blockç»„ç»‡ä¸ºclusterï¼Œè¿™æ ·é¡¶çº§è°ƒåº¦åªéœ€è¦å°†2ä¸ªclusterå‘ç»™2ä¸ªGPCï¼ŒGPCçš„è°ƒåº¦å™¨å†å°†4ä¸ªblockåˆ†é…ä¸ª4ä¸ªSMå³å¯ã€‚è¿™æ ·çš„åˆ†å±‚æ¨¡å¼å¯ä»¥ä½¿å¾—ï¼Œæ¯ä¸€çº§çš„å‹åŠ›éƒ½å¯ä»¥å¤§å¤§å‡å°ã€‚äºæ˜¯æˆ‘ä»¬çš„ç®¡ç†å±‚æ¬¡å˜ä¸ºäº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">grid----cluster----block---- wrap----thread</span><br><span class="line"> GPU----  GPC  ----  SM ----cores---- core</span><br></pre></td></tr></table></figure>
<h3 id="å›åˆ°cudaç¼–ç¨‹è¯­æ³•"><a href="#å›åˆ°cudaç¼–ç¨‹è¯­æ³•" class="headerlink" title="å›åˆ°cudaç¼–ç¨‹è¯­æ³•"></a>å›åˆ°cudaç¼–ç¨‹è¯­æ³•</h3><p>æ‰€ä»¥æˆ‘ä»¬ä½¿ç”¨add_vectorçš„æ—¶å€™ï¼Œ<code>&lt;&lt;&lt;&gt;&gt;&gt;</code>é‡Œé¢å°±éœ€è¦ä¼ å…¥ä¸¤ä¸ªé¢å¤–çš„å‚æ•°ä½œä¸ºblockçš„ä¸ªæ•°å’Œæ¯ä¸ªblockçš„threadçš„ä¸ªæ•°ï¼Œç„¶åGPUå°±ä¼šäº§ç”Ÿå¯¹åº”ä¸ªæ•°çš„blockå’Œthreadï¼Œç„¶åè‡ªåŠ¨åˆ†é…ç»™SMå’Œcoreã€‚æ¯”å¦‚<code>add_vector&lt;&lt;&lt;num/512,512&gt;&gt;&gt;(cuda_res,cuda_a,cuda_b)</code>å°±æ˜¯å®šä¹‰äº†æ¯ä¸ªblockåŒ…å«512ä¸ªthreadï¼Œæœ‰<code>num/512</code>ä¸ªblockï¼Œè¿™æ ·æ¯ä¸ªå‘é‡åˆ†é‡éƒ½æœ‰ä¸€ä¸ªå¯¹åº”çš„threadæ¥è¿›è¡Œè®¡ç®—ã€‚å½“ç„¶ä¹Ÿå¯ä»¥å°‘å®šä¹‰ä¸€äº›threadï¼Œæ¯ä¸ªthreadå¤šè®¡ç®—å‡ ä¸ªåˆ†é‡ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä¸è€ƒè™‘æ€§èƒ½çš„ä¼˜åŠ£ç­‰ç»†èŠ‚ï¼Œä»–ä»¬éƒ½æ˜¯å¯è¡Œçš„é€‰æ‹©ã€‚</p>
<p>æ­¤å¤–æˆ‘ä»¬çš„blockçš„ä¸ªæ•°å’Œthreadçš„ä¸ªæ•°å¹¶ä¸æ˜¯ä¸€ä¸ªä¸€ç»´çš„æ•°å­—ï¼Œå®é™…ä¸Šä»–ä»¬çš„æ•°æ®ç±»å‹ä¸º<code>dim3</code>ï¼Œæ˜¯ä¸€ä¸ªä¸‰ç»´çš„æ•°æ®ï¼Œæ¯”å¦‚ä¸€ä¸ªblockçš„512ä¸ªthreadå¯ä»¥é€‰æ‹©è®¾ç½®ç»´åº¦ä¸ºç®€å•çš„(512)ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸º(128,4)ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸º(32,4,4)éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä»–ä»¬éƒ½æ„å‘³ç€ä¸€ä¸ªblockæœ‰512ä¸ªthreadã€‚æˆ‘ä»¬ä¸€å¼€å§‹è¾“å…¥çš„512ä¼šè¢«ç¼–è¯‘å™¨è½¬æ¢ä¸º(512,1,1)ï¼Œè€Œ(128,4)ä¼šè¢«è½¬æ¢ä¸º(128,4,1)ï¼Œå› æ­¤å…¶å®éƒ½æ˜¯ä¸‰ç»´å‘é‡è¡¨ç¤ºthreadçš„åˆ†å¸ƒï¼Œå”¯ä¸€çš„åŒºåˆ«æ˜¯æ¯ä¸ªthreadçš„ç¼–å·threadIdx.xã€threadIdx.yå’ŒthreadIdx.zä¼šä¸ä¸€æ ·ã€‚</p>
<p>æ¯”å¦‚(4,1,1)å¾—åˆ°çš„å››ä¸ªthreadï¼Œå®ƒä»¬çš„threadIdxä¾æ¬¡æ˜¯(0,0,0)ã€(1,0,0)ã€(2,0,0)ã€(3,0,0)ï¼›è€Œå¯¹äº(2,2,1)å¾—åˆ°çš„ç¼–å·å°±æ˜¯(0,0,0)ã€(1,0,0)ã€(0,1,0)ã€(1,1,0)ã€‚ä½†æ˜¯åœ¨æ‰§è¡Œçš„æ—¶å€™è¿™ä¸¤ç§ç¼–å·å¾—åˆ°çš„çº¿ç¨‹ä¸ä¼šè¢«åŒºåˆ«å¯¹å¾…ï¼Œå¯èƒ½è¯´å¦‚æœä½ éœ€è¦ç”¨threadIdxä½œä¸ºäºŒç»´çŸ©é˜µç´¢å¼•çš„æ—¶å€™ï¼Œå®ƒå¯ä»¥ç›´æ¥æ‹¿æ¥ä½¿ç”¨ï¼Œè€Œç¬¬ä¸€ç§éœ€è¦æ¢ç®—ä¸€æ³¢ï¼ŒæŸç§æ„ä¹‰ä¸Šå¯ä»¥åŠ é€Ÿè®¡ç®—ï¼Œä½†ä¹Ÿä»…æ­¤è€Œå·²ã€‚å¦å¤–å¯¹äºä¸€ä¸ªblockçš„threadç»´åº¦è¢«ä¿å­˜åœ¨blockDimè¿™ä¸ªç‰¹æ®Šçš„dim3å˜é‡å½“ä¸­ï¼Œå¯ä»¥åœ¨cudaç¼–ç¨‹çš„æ—¶å€™è®¿é—®ã€‚</p>
<p>å¯¹äºblockä¹Ÿæ˜¯å¦‚æ­¤ï¼Œä»–ä¹Ÿæ˜¯ä¸€ä¸ªä¸‰ç»´çš„æ•°æ®ï¼Œé“ç†å’Œthreadä¸€æ ·ï¼Œä¸‰ç»´çš„ç¼–å·å¯ä»¥ç”¨ç¼–ç¨‹æ—¶å€™çš„åªè¯»å˜é‡blockIdxæ¥è®¿é—®ï¼Œblockçš„ç»´åº¦å¯ä»¥ç”¨åªè¯»å˜é‡gridDimæ¥è®¿é—®ã€‚</p>
<h3 id="SIMTéš¾ä»¥èƒœä»»çš„ä»»åŠ¡ç±»å‹"><a href="#SIMTéš¾ä»¥èƒœä»»çš„ä»»åŠ¡ç±»å‹" class="headerlink" title="SIMTéš¾ä»¥èƒœä»»çš„ä»»åŠ¡ç±»å‹"></a>SIMTéš¾ä»¥èƒœä»»çš„ä»»åŠ¡ç±»å‹</h3><h4 id="1-å¹¶è¡Œåº¦è¾ƒä½çš„ç¨‹åº"><a href="#1-å¹¶è¡Œåº¦è¾ƒä½çš„ç¨‹åº" class="headerlink" title="1.å¹¶è¡Œåº¦è¾ƒä½çš„ç¨‹åº"></a>1.å¹¶è¡Œåº¦è¾ƒä½çš„ç¨‹åº</h4><p>æˆ‘ä»¬ä¸€ç›´è¯´æ˜¾å¡å¯ä»¥åŠ é€Ÿå›¾å½¢è®¡ç®—ã€å¯ä»¥åŠ é€Ÿç¥ç»ç½‘ç»œè®­ç»ƒã€å¯ä»¥åŠ é€Ÿæ‰¹æ•°æ®å¤„ç†ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯æ‰€æœ‰ä»»åŠ¡éƒ½é€‚åˆGPUè¿›è¡Œçš„ã€‚GPUçš„æ—¶é’Ÿå‘¨æœŸæ¯”CPUæ…¢ä¸å°‘ï¼ŒåŒæ ·ä¸€ä¸ªä»£ç ï¼Œå¦‚æœCPUå’ŒGPUéƒ½æ˜¯ä¸€ä¸ªçº¿ç¨‹è¿è¡Œçš„è¯ï¼ŒCPUçš„æ—¶é’Ÿå‘¨æœŸæ¯”GPUå¿«å¾ˆå¤šï¼ŒGPUè·‘ä¸€æ¡æŒ‡ä»¤ï¼ŒCPUå¯ä»¥è·‘æ¯”å¦‚4æ¡ï¼›å¯¹äºæµæ°´çº¿å¸¸è§çš„å†²çªé—®é¢˜ï¼ŒGPUä¸€èˆ¬å°±æ˜¯æ­»ç­‰ï¼Œä½†æ˜¯CPUå¯ä»¥åˆ†æ”¯é¢„æµ‹ã€ä¹±åºæ‰§è¡Œã€å¤šå‘å°„ç­‰ç­‰æŠ€æœ¯ï¼Œæ¯”å¦‚åŒå‘å°„å››å‘å°„å°±ä¸€ä¸ªå‘¨æœŸå¤šè·‘äº†å¥½å‡ æ¡ï¼Œæœ‰stallåé¢çš„æŒ‡ä»¤åœ¨ä¹±åºå’Œé¢„æµ‹çš„æ”¯æŒä¸‹æå‰è¿è¡Œï¼›å¯¹äºå†…å­˜è®¿é—®ï¼ŒGPUçš„cacheè¿œå°‘äºCPUï¼Œcacheå‘½ä¸­ç‡ä½ï¼Œå†…å­˜è®¿é—®æ›´æ…¢ã€‚æ‰€ä»¥å•çº¿ç¨‹è€Œè¨€è¯´ä¸å®šCPUå¯ä»¥æ¯”GPUå¿«ä¸ª10å€ä¸æ­¢ã€‚ä½†æ˜¯å¯¹äºæ•°æ®æ‰¹å¤„ç†ä»»åŠ¡ï¼Œæ¯”å¦‚å‘é‡åŠ æ³•ï¼Œå†çƒ‚çš„GPUä¹Ÿå¯ä»¥åŒæ—¶è·‘æ¯”å¦‚1024ä¸ªthreadï¼Œä½†æ˜¯å¾ˆå¤šå…ˆè¿›çš„CPUæœ€å¤šè·‘32ä¸ªthreadä¹Ÿå¾ˆå¤¸å¼ äº†ï¼Œå“ªæ€•å•ä¸ªæ ¸å¿«10å€ä¹Ÿè¿˜æ˜¯æ…¢ã€‚æ‰€ä»¥GPUçš„è®¡ç®—èƒ½åŠ›é«˜åº¦ä¾èµ–äºå¹¶è¡Œï¼Œå¦‚æœæ˜¯æƒ³ç¼–è¯‘è¿™æ ·çš„é«˜åº¦çº¿æ€§ã€é«˜åº¦å¤æ‚æ§åˆ¶çš„ä»»åŠ¡ï¼ŒGPUè¿œå·®äºCPUï¼Œä¸å¦‚ç”¨CPUè·‘ã€‚</p>
<h4 id="2-åŒæ­¥è¦æ±‚é«˜çš„ç¨‹åº"><a href="#2-åŒæ­¥è¦æ±‚é«˜çš„ç¨‹åº" class="headerlink" title="2.åŒæ­¥è¦æ±‚é«˜çš„ç¨‹åº"></a>2.åŒæ­¥è¦æ±‚é«˜çš„ç¨‹åº</h4><p>CPUçš„threadä¹‹é—´å¯ä»¥ç”¨å¤šç§æ–¹å¼è¿›è¡Œä»»æ„çš„åŒæ­¥ï¼Œä½†æ˜¯GPUçš„threadåŒæ­¥å¾ˆå›°éš¾ï¼Œå®ƒåªæ”¯æŒwrapå†…éƒ¨çš„åŒæ­¥ã€ä¸€ä¸ªblockçš„æ‰€æœ‰threadçš„åŒæ­¥ã€ä¸€ä¸ªgridçš„æ‰€æœ‰blockçš„åŒæ­¥ç­‰ç²—ç²’åº¦çš„åŒæ­¥ï¼Œæ— æ³•å¤„ç†å¾ˆç²¾ç»†çš„åŒæ­¥æœºåˆ¶ï¼Œæˆ–è€…è¯´å¦‚æœæƒ³è¦å®ç°ä»£ä»·å¾ˆå¤§ã€‚åƒå‘é‡åŠ æ³•è¿™ç§threadä¹‹é—´å°±æ²¡æœ‰ä»»ä½•çš„äº¤æµï¼Œé‚£ä¹ˆGPUå°±å¯ä»¥å¾ˆæµç•…çš„æ‰§è¡Œã€‚è€Œä¸€æ—¦éœ€è¦åŠ é€ŸåŒæ­¥ç­‰ä»»åŠ¡ï¼ŒCPUå€’è¿˜å¥½ï¼ŒGPUæ“ä½œä¸å½“è¿˜å¾ˆå®¹æ˜“æ­»é”ã€‚</p>
<h4 id="3-æ•°æ®è§„æ¨¡å°çš„ç¨‹åº"><a href="#3-æ•°æ®è§„æ¨¡å°çš„ç¨‹åº" class="headerlink" title="3.æ•°æ®è§„æ¨¡å°çš„ç¨‹åº"></a>3.æ•°æ®è§„æ¨¡å°çš„ç¨‹åº</h4><p>GPUçš„è¿è¡Œå¼€é”€æ˜¯æ¯”è¾ƒå¤§çš„ï¼Œkernelçš„launchã€çº¿ç¨‹çš„åˆå§‹åŒ–ã€å†…å­˜çš„åˆ†é…ã€æ•°æ®çš„ä¼ è¾“å’Œä»»åŠ¡çš„é‡Šæ”¾éƒ½éœ€è¦ä¸€å®šçš„å¼€é”€ï¼Œå¦‚æœæ•°æ®é‡å¤ªå°ä¸è¶³ä»¥åˆ†æ‘Šè¿™éƒ¨åˆ†å¼€é”€ï¼Œé‚£ç›´æ¥CPUç°åœºè·‘æ‰ç®—äº†ï¼Œæ•°æ®ä»CPUè¿åˆ°GPUä¹ŸæŒºèŠ±æ—¶é—´çš„ã€‚</p>
<h2 id="å†…å­˜çš„åˆ†é…ä¸ç®¡ç†"><a href="#å†…å­˜çš„åˆ†é…ä¸ç®¡ç†" class="headerlink" title="å†…å­˜çš„åˆ†é…ä¸ç®¡ç†"></a>å†…å­˜çš„åˆ†é…ä¸ç®¡ç†</h2><h3 id="1-malloc"><a href="#1-malloc" class="headerlink" title="1.malloc"></a>1.malloc</h3><p><code>malloc</code>ä¸æ˜¯cudaçš„ä¸€éƒ¨åˆ†ï¼Œæ”¾åœ¨è¿™é‡Œå°±æ˜¯ä¸ºäº†å›¾ä¸ªå®Œæ•´ã€‚ä»–ä¼šä»Hostçš„heapä¸Šåˆ†é…ä¸€å—å†…å­˜ï¼Œä½†æ˜¯è¿™ä¸ªåœ°å€å¯¹äºDeviceæ˜¯æ²¡æœ‰æ„ä¹‰çš„ï¼ŒGPUæ— æ³•ç”¨ä»»ä½•æ­£å¸¸çš„æ–¹æ³•è®¿é—®è¿™ä¸ªå†…å­˜åŒºåŸŸï¼Œå¦‚æœæœ‰bugå¦è¯´ã€‚å¦‚æœæƒ³è¦çŸ¥é“ä¸€ä¸ªå†…å­˜åœ°å€çš„ç±»å‹ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨å¦‚ä¸‹çš„ä»£ç ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>* ptr=(<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>);</span><br><span class="line">cudaPointerAttributes attr;</span><br><span class="line"><span class="built_in">cudaPointerGetAttributes</span>(&amp;attr,ptr);</span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;type=%d,host=%p,device=%p\n&quot;</span>,attr.type,attr.hostPointer,attr.devicePointer);</span><br></pre></td></tr></table></figure>
<p><code>cudaPointerAttributes</code>æ˜¯ä¸€ä¸ªæè¿°æŒ‡é’ˆç±»å‹çš„ç»“æ„ï¼Œç„¶åç”¨<code>cudaPointerGetAttributes</code>å‡½æ•°å°±å¯ä»¥å°†ä¸€ä¸ªåœ°å€çš„æŒ‡é’ˆç±»å‹ç­‰ä¿¡æ¯å­˜åˆ°è¿™ä¸ªç»“æ„é‡Œé¢ã€‚<code>cudaPointerAttributes</code>çš„typeåˆ†é‡è¡¨ç¤ºæŒ‡é’ˆçš„ç±»å‹ï¼Œåˆ†ä¸º4ç§ï¼Œåˆ†åˆ«æ˜¯éåˆ†é…ã€Hostã€Deviceå’ŒManagedï¼ŒhostPointeræ˜¯Hostè®¿é—®è¿™å—å†…å­˜éœ€è¦çš„åœ°å€ï¼ŒdevicePointeræ˜¯Deviceè®¿é—®è¿™å—å†…å­˜éœ€è¦çš„åœ°å€ï¼Œå¦‚æœæ— æ³•è®¿é—®é‚£ä¹ˆåœ°å€å°±æ˜¯0ã€‚</p>
<p>å¯¹äºmallocåˆ†é…çš„å†…å­˜ï¼Œç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯Hostï¼ŒhostPointeråœ°å€æ˜¯heapçš„åœ°å€ï¼ŒdevicePointeræ˜¯nilæ— æ³•è®¿é—®ã€‚æ‰€ä»¥è¯´æ˜mallocæ˜¯å¾—åˆ°Hostä¸Šçš„ç‰©ç†åœ°å€ï¼ŒHostå¾—åˆ°heapçš„åœ°å€ï¼ŒDeviceæ— æ³•ç›´æ¥è®¿é—®è¿™å—å†…å­˜ã€‚</p>
<h3 id="2-cudaMalloc"><a href="#2-cudaMalloc" class="headerlink" title="2.cudaMalloc"></a>2.cudaMalloc</h3><p><code>cudaMalloc</code>çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>* cuda_ptr;</span><br><span class="line"><span class="built_in">cudaMalloc</span>((<span class="type">void</span>**)&amp;cuda_ptr,<span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯deviceï¼ŒhostPointeræ˜¯nilï¼ŒdevicePointeræ˜¯æœ‰æ•ˆåœ°å€æ•°æ®ï¼Œæ‰€ä»¥cudaMallocåˆ†é…å¾—åˆ°çš„å†…å­˜æ˜¯Deviceä¸Šé¢çš„æ˜¾å­˜ï¼Œåªèƒ½Deviceç”¨devicePointerçš„åœ°å€è®¿é—®ï¼ŒHostæ— æ³•ç›´æ¥è®¿é—®è¿™å—Deviceçš„å†…å­˜ã€‚</p>
<h3 id="3-cudaMallocHost"><a href="#3-cudaMallocHost" class="headerlink" title="3.cudaMallocHost"></a>3.cudaMallocHost</h3><p><code>cudaMallocHost</code>çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>* ptr;</span><br><span class="line"><span class="built_in">cudaMallocHost</span>((<span class="type">void</span>**)&amp;ptr,<span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>);</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯hostï¼Œè¯¥å‡½æ•°æ¥å£ä¼šåˆ†é…ä¸€ä¸ªhostä¸Šé¢çš„ç‰©ç†å†…å­˜ï¼Œä½†æ˜¯å¹¶ä¸åœ¨heapä¸Šï¼Œè€Œæ˜¯ç”¨memory mappingæ–°æ˜ å°„ä¸€ä¸ªå†…å­˜ç©ºé—´ï¼ŒåŒæ—¶è¿™ä¸ªhostçš„å†…å­˜åœ°å€ä¹Ÿä¼šè¢«deviceæ˜ å°„åˆ°ä»–çš„ä¹Ÿè¡¨ä¸Šã€‚æ¯”å¦‚æˆ‘ä»¬å¾—åˆ°çš„cudaMallocHostçš„åœ°å€æ˜¯0x3000000ï¼Œé‚£ä¹ˆå½“hostè®¿é—®0x3000000çš„æ—¶å€™å°±ä¼šç›´æ¥é€šè¿‡hostçš„é¡µè¡¨æ‰¾åˆ°å¯¹åº”çš„å†…å­˜è®¿é—®ï¼Œå’Œå…¶ä»–çš„hostå†…å­˜è®¿é—®æ²¡æœ‰ä»»ä½•åŒºåˆ«ï¼Œä»…ä»…æ˜¯åœ°å€åŒºåŸŸåœ¨é€»è¾‘ä¸Šä¸åœ¨heapæˆ–è€…stackä¸Šç½¢äº†ï¼›å½“deviceè®¿é—®0x3000000ï¼Œå®ƒä¼šé€šè¿‡é¡µè¡¨å¾—çŸ¥è¿™ä¸ªå†…å­˜æ˜¯hostçš„å†…å­˜ï¼Œç„¶åç”¨pcieå»è¯»å–hostçš„å†…å­˜ã€‚æ‰€ä»¥è™½ç„¶è¿™å—å†…å­˜åˆ†é…åœ¨hostä¸Šï¼Œä½†æ˜¯æ˜¯deviceå’Œhostéƒ½å¯è§çš„ï¼Œè€Œä¸”ç”¨åŒä¸€ä¸ªå†…å­˜åœ°å€è®¿é—®ã€‚æ‰€ä»¥ä½¿ç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯hostï¼ŒhostPointerå’ŒdevicePointeræ˜¯åŒä¸€ä¸ªå€¼ã€‚</p>
<p>æ­¤å¤–ï¼Œ<code>cudaMallocHost</code>åˆ†é…å¾—åˆ°çš„é¡µæ˜¯pinnedçš„é¡µï¼Œæ‰€ä»¥è¯´<code>cudaMallocHost</code>æœ€å¥½æ˜¯é¡µçš„æ•´æ•°å€ï¼Œä¸ç„¶æ˜¯ä¸€ä¸ªå¾ˆæµªè´¹çš„äº‹æƒ…ï¼Œå¥½åœ¨GPUä¸€èˆ¬ä¼ é€’çš„éƒ½æ˜¯å¤§å—çš„æ•°æ®ï¼Œæ‰€ä»¥é—®é¢˜ä¸å¤§ã€‚ä½¿ç”¨pinnedé¡µçš„å¥½å¤„åœ¨äºï¼Œpcieæ•°æ®ä¼ è¾“å¯ä»¥æ›´è¿…é€Ÿï¼Œå› ä¸ºå¦‚æœé¡µæ²¡æœ‰è¢«pinnedä½çš„è¯ï¼Œè¿™ä¸ªé¡µéšæ—¶éƒ½å¯èƒ½ä¼šè¢«swapå‡ºå†…å­˜ï¼Œå› æ­¤pcieä¼ è¾“çš„æ—¶å€™ï¼Œä¼šå…ˆæŠŠè¿™ä¸ªé¡µçš„æ•°æ®æ‹·è´åˆ°å¦ä¸€ä¸ªpinnedé¡µä¸Šï¼Œç„¶åå†è¿›è¡Œpcieçš„ä¼ è¾“ï¼Œåä¹‹äº¦ç„¶ï¼Œæ‰€ä»¥ç›´æ¥ä½¿ç”¨pinnedçš„å†…å­˜ï¼Œå¯ä»¥å‡å°‘ä¸€æ¬¡å†…å­˜çš„æ‹·è´ï¼ŒèŠ‚çº¦æ—¶é—´ã€‚</p>
<h3 id="4-cudaHostRegister"><a href="#4-cudaHostRegister" class="headerlink" title="4.cudaHostRegister"></a>4.cudaHostRegister</h3><p><code>cudaHostRegister</code>çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>* ptr;</span><br><span class="line"><span class="type">int</span>* cuda_ptr;</span><br><span class="line">ptr=(<span class="type">int</span>*)<span class="built_in">malloc</span>(<span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>);</span><br><span class="line"><span class="built_in">cudaHostRegister</span>(ptr, <span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>, cudaHostRegisterMapped);</span><br><span class="line"><span class="built_in">cudaHostGetDevicePointer</span>((<span class="type">void</span> **)&amp;cuda_ptr, ptr, <span class="number">0</span>);</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆæˆ‘ä»¬ç”¨<code>malloc</code>å¾—åˆ°äº†ä¸€ä¸ªHostçš„å†…å­˜ï¼Œè¿™ä¸ªæ—¶å€™è¿™ä¸ªå†…å­˜åœ°å€ä»…å¯¹Hostæœ‰æ„ä¹‰ï¼Œè¯¥å†…å­˜ä¹Ÿåªæœ‰Hostå¯ä»¥è®¿é—®ï¼Œç„¶åæˆ‘ä»¬ç”¨<code>cudaHostRegister</code>å°†è¿™ä¸ªHostçš„åœ°å€èŒƒå›´äº¤ç»™Deviceï¼Œå‘Deviceæ³¨å†Œè¿™ä¸ªHostçš„åœ°å€ï¼Œäºæ˜¯Deviceåˆ†å‡ºä¸€å—Deviceçš„é€»è¾‘åœ°å€ç©ºé—´æ¥æ˜ å°„è¿™ä¸ªHostçš„åœ°å€ç©ºé—´ï¼Œä¿®æ”¹è‡ªå·±çš„é¡µè¡¨ã€‚ä¹‹åæˆ‘ä»¬å¯ä»¥ç”¨<code>cudaHostGetDevicePointer</code>æ¥å¾—åˆ°Hoståœ°å€æ³¨å†Œåˆ°Deviceä¹‹åè¢«Deviceåˆ†é…å¾—åˆ°çš„åœ°å€ï¼Œä¹‹åçš„kernelæ‰§è¡Œçš„æ—¶å€™ï¼ŒDeviceå¯ä»¥ç”¨è¿™ä¸ªåœ°å€æ¥è®¿é—®Hostä¸Šå¯¹åº”çš„å†…å­˜ã€‚<code>cudaHostRegister</code>+<code>cudaHostGetDevicePointer</code>çš„ç»„åˆå’Œ<code>cudaMallocHost</code>å…¶å®åªæ˜¯åœ¨ä½¿ç”¨ä¸Šå­˜åœ¨ä¸€äº›åŒºåˆ«ï¼Œå®ç°ä¸ŠåŸºæœ¬ä¸€è‡´ï¼Œæœ€å¤§çš„åŒºåˆ«å¯èƒ½å°±æ˜¯<code>cudaMallocHost</code>å¯¹äºHostç‰©ç†å†…å­˜åˆ†é…çš„è™šæ‹Ÿåœ°å€æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯<code>cudaHostRegister</code>åˆ†é…çš„è™šæ‹Ÿåœ°å€æ˜¯äº’å¼‚çš„ã€‚</p>
<p>æ‰€ä»¥ä½¿ç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯hostï¼ŒhostPointeræ˜¯heapä¸Šçš„åœ°å€ï¼ŒdevicePointeræ˜¯å¦å¤–æ˜ å°„çš„åœ°å€ã€‚</p>
<h3 id="5-cudaMallocManaged"><a href="#5-cudaMallocManaged" class="headerlink" title="5.cudaMallocManaged"></a>5.cudaMallocManaged</h3><p><code>cudaMallocManaged</code>çš„ä½¿ç”¨æ–¹æ³•å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span>* ptr;</span><br><span class="line"><span class="built_in">cudaMallocManaged</span>(&amp;ptr,<span class="built_in">sizeof</span>(<span class="type">int</span>)*<span class="number">1024</span>,cudaMemAttachGlobal);</span><br></pre></td></tr></table></figure>
<p>ä½¿ç”¨<code>cudaPointerGetAttributes</code>å¾—åˆ°çš„typeæ˜¯managedï¼ŒhostPointerå’ŒdevicePointeræ˜¯ç›¸åŒçš„åœ°å€ï¼ŒHostå’ŒDeviceéƒ½å¯ä»¥ç”¨ç›¸åŒçš„è™šæ‹Ÿåœ°å€è®¿é—®è¿™ä¸ªå†…å­˜ï¼Œè¿™ç‚¹å’Œ<code>cudaMallocHost</code>æ˜¯éå¸¸ç›¸ä¼¼çš„ï¼Œæœ€å¤§çš„åŒºåˆ«å°±æ˜¯ç‰©ç†å†…å­˜å¹¶ä¸æ˜¯ä»…ä»…åœ¨Hostä¸Šçš„ã€‚</p>
<p>Managedçš„ç‰©ç†å†…å­˜å¹¶ä¸åˆ†é…ï¼Œå®ƒä»…ä»…æ˜¯åœ¨hostç«¯æ³¨å†Œäº†è¿™ä¸ªå†…å­˜èŒƒå›´ï¼Œæ¯”å¦‚vm_area_structæ³¨å†Œäº†è¿™ä¸ªå†…å­˜å—çš„ä¿¡æ¯ï¼Œå¯¹äºDeviceä¹Ÿæ˜¯ç±»ä¼¼çš„ï¼Œè™½ç„¶ä¸çŸ¥é“å…·ä½“æ³¨å†Œçš„å‡½æ•°æ¥å£ä¹‹ç±»çš„ï¼Œä½†æ˜¯ä¹Ÿæ˜¯ç±»ä¼¼çš„æœºåˆ¶ã€‚ç„¶åå½“Hostè®¿é—®å¯¹åº”çš„è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼Œå› ä¸ºpage faultæ‰åˆ†é…å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼ŒDeviceä¹Ÿæ˜¯å½“Deviceè®¿é—®å¯¹åº”çš„è™šæ‹Ÿåœ°å€çš„æ—¶å€™ï¼ŒDeviceæ‰åˆ†é…è‡ªå·±çš„æ˜¾å­˜ã€‚æ­¤å¤–å¦‚æœHostå†™äº†è‡ªå·±Managedçš„ç‰©ç†å†…å­˜ï¼Œå®ƒä»…ä»…æ˜¯åœ¨å®ƒHostçš„ç‰©ç†å†…å­˜ä¸Šå†™çš„ï¼Œæ¯”å¦‚Hoståˆ†é…äº†1MBçš„å†…å­˜ï¼Œç„¶åHostéƒ½å†™å…¥äº†1ï¼Œç„¶åDeviceæ²¡è¯»å†™è¿‡è¿™éƒ¨åˆ†å†…å­˜ï¼Œé‚£ä¹ˆDeviceå°±ä¸ä¼šåˆ†é…å¯¹åº”çš„æ˜¾å­˜ï¼Œä¹Ÿä¸éœ€è¦æŠŠHostçš„æ•°æ®ä¼ é€’åˆ°Deviceå½“ä¸­ï¼Œå¦‚æœDeviceè¯»å†™äº†å…¶ä¸­ä¸€éƒ¨åˆ†ï¼Œé‚£ä¹ˆåªæœ‰å¯¹åº”çš„é‚£ä¸€éƒ¨åˆ†æ•°æ®ä¼šè¢«Deviceåˆ†é…å†…å­˜ï¼Œç„¶åHostå’ŒDeviceä¼ é€’æ•°æ®åŒæ­¥è¿™éƒ¨åˆ†çš„æ•°æ®ã€‚</p>
<p>ä¹Ÿå°±æ˜¯è¯´ï¼ŒHostå’ŒDeviceè®¿é—®äº†å†…å­˜ï¼Œå¯¹åº”çš„é¡µæ‰ä¼šåœ¨Hostå’ŒDeviceä¸Šåˆ†é…ï¼ŒHostå’ŒDeviceéƒ½è¯»å†™äº†åŒä¸€ä¸ªå†…å­˜åœ°å€ï¼Œè¿™ä¸ªå†…å­˜æ‰€åœ¨çš„é¡µæ‰ä¼šåœ¨Hostå’ŒDeviceä¹‹é—´ä¼ é€’æ•°æ®è¿›è¡ŒåŒæ­¥ï¼Œæ²¡æœ‰è¢«è®¿é—®çš„å†…å­˜èŒƒå›´ä¸ä¼šåˆ†é…å®é™…çš„ç‰©ç†åœ°å€ï¼Œæ²¡æœ‰è¢«åŒæ–¹åŒæ—¶è®¿é—®çš„é¡µæ›´ä¸ä¼šç›¸äº’ä¼ é€’æ•°æ®ã€‚è¿™æ ·çš„å¥½å¤„ä¸€ä¸ªæ˜¯åŒä¸€åœ°å€è¿›è¡Œå†…å­˜ç®¡ç†ï¼Œå†…å­˜çš„ä½¿ç”¨éå¸¸æ–¹ä¾¿ï¼Œå½“ç„¶å¦‚æœæ„¿æ„å¤šæ•²å‡ è¡Œä»£ç ï¼Œè¿™ä¹Ÿä¸æ˜¯å·¨å¤§çš„ä¼˜ç‚¹ï¼›ç¬¬äºŒå°±æ˜¯å†…å­˜çš„æŒ‰éœ€åˆ†é…å’ŒæŒ‰éœ€ä¼ é€’ï¼Œå¯ä»¥èŠ‚çº¦ä¸å¿…è¦çš„å¼€æ”¯ï¼Œä¹Ÿæœ‰åˆ©äºå¤šè¿›ç¨‹åŒæ—¶è¿è¡Œæ—¶ï¼ŒæŒ‰éœ€åˆ†é…å†…å­˜ã€‚å½“ç„¶å¦‚æœåˆ†é…å†…å­˜çš„æ‰€æœ‰æ•°æ®éƒ½è¦è¢«Deviceå’ŒHostè®¿é—®ï¼Œè€Œä¸”è¦è¢«åå¤ä½¿ç”¨çš„è¯ï¼Œé¢å¤–çš„ç®¡ç†å¼€é”€å¯èƒ½ä¼šå¾ˆå·¨å¤§ï¼Œæ•ˆæœä¹Ÿè®¸ä¸å¦‚ç›´æ¥<code>cudaMalloc</code>ã€‚</p>
<h2 id="cudaç¨‹åºçš„ç¼–è¯‘å’Œç¼–è¯‘ç»“æœçš„ç»„æˆ"><a href="#cudaç¨‹åºçš„ç¼–è¯‘å’Œç¼–è¯‘ç»“æœçš„ç»„æˆ" class="headerlink" title="cudaç¨‹åºçš„ç¼–è¯‘å’Œç¼–è¯‘ç»“æœçš„ç»„æˆ"></a>cudaç¨‹åºçš„ç¼–è¯‘å’Œç¼–è¯‘ç»“æœçš„ç»„æˆ</h2><p>cudaç¨‹åºä½¿ç”¨nvccè¿›è¡Œç¼–è¯‘æœ€åå¾—åˆ°ä¸€ä¸ªCçš„elfæ–‡ä»¶ï¼Œé‚£ä¹ˆä»–æ˜¯æ€ä¹ˆæŠŠä¸€ä¸ªGPUè¿è¡Œçš„ç¨‹åºè½¬æ¢ä¸ºä¸€ä¸ªå¸¸è§çš„Cç¨‹åºï¼Œå¯¹äºGPUéœ€è¦è¿è¡Œçš„ä»£ç å®ƒåšäº†å“ªäº›çš„å¤„ç†ï¼Œå¯¹äºcudaçš„è¯­æ³•ç³–å®ƒåšäº†é‚£äº›çš„è½¬æ¢å‘¢ï¼Ÿ</p>
<h3 id="ä¸€äº›å·®å¼‚"><a href="#ä¸€äº›å·®å¼‚" class="headerlink" title="ä¸€äº›å·®å¼‚"></a>ä¸€äº›å·®å¼‚</h3><p>æˆ‘ä»¬ç”¨readelfæ¥è¾“å‡ºä¸€ä¸‹sample.cuæœ€åç¼–è¯‘å¾—åˆ°çš„sampleæ–‡ä»¶ï¼Œä¼šå‘ç°å®ƒå°±æ˜¯ä¸€ä¸ªå¾ˆæ­£å¸¸çš„elfæ–‡ä»¶ï¼Œä½†æ˜¯å®ƒçš„segmentationå¤šäº†ä¸€äº›ä¸œè¥¿ï¼Œä¸€ä¸ªæ˜¯åœ¨rodataéƒ¨åˆ†å¤šäº†ä¸€ä¸ªnv_fatbinæ®µå’Œä¸€ä¸ª__nv_module_idæ®µï¼Œåœ¨dataéƒ¨åˆ†å¤šäº†ä¸€ä¸ª.nvFatBinSegmentæ®µï¼Œè¿™å…¶ä¸­ä¸€å®šåŒ…å«äº†å’ŒGPUæ‰§è¡Œä»£ç ç´§å¯†ç®¡ç†çš„éƒ¨åˆ†ã€‚å› ä¸ºGPUæ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç ä¸€å¼€å§‹è‚¯å®šæ˜¯å­˜å‚¨åœ¨elfå½“ä¸­çš„ï¼Œå¹¶ä¸”å› ä¸ºè¿™éƒ¨åˆ†ä»£ç æ— æ³•è¢«CPUæ‰§è¡Œï¼Œæ‰€ä»¥ä»–ä»¬è‚¯å®šæ˜¯åœ¨æ•°æ®æ®µéƒ¨åˆ†ï¼Œè€ƒè™‘åˆ°å¯æ‰§è¡Œä»£ç ä¸€èˆ¬æ— æ³•è¢«ä¿®æ”¹ï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½å°±æ˜¯rodataéƒ¨åˆ†çš„nv_fatbinã€‚</p>
<p>__nv_module_idçš„å†…å®¹å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">Hex dump of section <span class="string">&#x27;__nv_module_id&#x27;</span>:</span><br><span class="line">  <span class="number">0x0008b9d0</span> <span class="number">5</span>f5f<span class="number">4e56</span> <span class="number">5</span>f4d4f44 <span class="number">554</span>c455f <span class="number">494400</span>   __NV_MODULE_ID.</span><br></pre></td></tr></table></figure>
<p>ä»–å°±æ˜¯ä¸€æ®µé­”æ•°è€Œå·²ï¼Œæ‰€ä»¥æ²¡ä»€ä¹ˆå€¼å¾—é‡ç‚¹è€ƒé‡çš„ï¼Œå› æ­¤æˆ‘ä»¬åæœŸæŠŠé‡å¿ƒæ”¾åœ¨.nv_fatbinå’Œ.nvFatBinSegmentä¸Šã€‚</p>
<p>ä¹‹åæˆ‘ä»¬è§‚å¯Ÿobjdumpå¾—åˆ°çš„ä»£ç ï¼Œ<code>cudaMalloc</code>ä¹‹ç±»çš„å‡½æ•°apiè°ƒç”¨éƒ½æ˜¯æ­£å¸¸çš„å‡½æ•°è°ƒç”¨çš„æ¨¡å¼ï¼Œä½†æ˜¯å¦‚<code>add&lt;&lt;&lt;grid,block&gt;&gt;&gt;(res,a,b,n)</code>å¾—åˆ°çš„æ±‡ç¼–å´æ¯”è¾ƒç‰¹æ®Šï¼Œaddå‡½æ•°è¿›å…¥ä¹‹åæ˜¯ä¸€ä¸ªstubå‡½æ•°ï¼Œç„¶åè¿›è¡Œä¸€ç³»åˆ—ç‰¹æ®Šçš„æ“ä½œï¼Œå› æ­¤å¯¹åº”CPUè°ƒç”¨GPUå¯¹åº”çš„å‡½æ•°éƒ¨åˆ†ä¼šè¿›è¡Œä¸€äº›ç‰¹æ®Šçš„å¤„ç†ï¼Œè¿™å…¶ä¸­åº”è¯¥ä¹Ÿæ‰¾åˆ°CPUå¦‚ä½•è°ƒç”¨GPUå·¥ä½œçš„çº¿ç´¢ã€‚ç„¶åasmæ–‡ä»¶ä¸­å¤„ç†æˆ‘ä»¬æ‰‹å†™çš„å‡½æ•°ï¼Œaddè¢«å¢åŠ çš„ä¸€å †å‡½æ•°è¿˜æœ‰å¾ˆå¤š<code>__cudart1-----__cudart3000</code>ä¹‹ç±»çš„å‡½æ•°ï¼Œä»–ä»¬ä¼°è®¡æ˜¯cudaçš„åº“å‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºå‡½æ•°åè¢«éšå»äº†ï¼Œå¤±å»äº†å¯è¯»æ€§ï¼Œéš¾ä»¥ç›´æ¥æ‰¾åˆ°æœ‰ç”¨çš„ä¿¡æ¯ã€‚</p>
<p>è¿™äº›å’Œå¸¸è§„Cä»£ç ç¼–è¯‘ç»“æœä¸åŒçš„åœ°æ–¹éšå«äº†cudaç¨‹åºè°ƒç”¨GPUå·¥ä½œçš„ä¸€äº›ç§˜å¯†ï¼Œå¯¹ä»–ä»¬å¦‚ä½•ç¼–è¯‘å¾—åˆ°ï¼Œå¦‚æœæ‰§è¡Œè¿›è¡Œç ”ç©¶ï¼Œä¹Ÿè®¸æœ‰åŠ©äºæˆ‘ä»¬æ¢ç´¢GPUå’ŒCPUå¦‚ä½•ååŒå·¥ä½œã€‚</p>
<h3 id="æ­£å¼å¼€å§‹"><a href="#æ­£å¼å¼€å§‹" class="headerlink" title="æ­£å¼å¼€å§‹"></a>æ­£å¼å¼€å§‹</h3><p>æˆ‘ä»¬å¯ä»¥ç”¨<code>nvcc sample.cu -o sample --dryrun</code>å‘½ä»¤è¾“å‡ºnvccç¼–è¯‘sample.cuæ—¶å€™çš„ä¸­é—´å‘½ä»¤ï¼Œæ­¤å¤–æˆ‘ä»¬å¯ä»¥ç”¨<code>nvcc sample.cu -o sample --keep</code>ä¿ç•™nvccç¼–è¯‘å¾—åˆ°çš„ä¸­é—´ç»“æœï¼Œæ‰€ä»¥ç»¼åˆè¿™ä¸¤éƒ¨åˆ†ï¼Œæˆ‘ä»¬å¯ä»¥å¾ˆæ–¹ä¾¿çš„è§‚å¯Ÿåˆ°sampleç¼–è¯‘å¾—å…¨è¿‡ç¨‹ã€‚</p>
<p>ä½¿ç”¨<code>nvcc sample.cu -o sample --dryrun</code>å¾—åˆ°çš„è¾“å‡ºå¦‚ä¸‹ï¼Œæˆ‘ä»¬åˆ å»äº†å…¶ä¸­å¤§é‡çš„å‚æ•°éƒ¨åˆ†ï¼Œä»…ä»…ç•™ä¸‹äº†ä¸­é—´æ–‡ä»¶ä¹‹é—´çš„å…³è”ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">gcc sample.cu -o sample.cpp<span class="number">1.</span>ii</span><br><span class="line"></span><br><span class="line">cicc --include_file_name sample.fatbin.c </span><br><span class="line">    --gen_module_id_file --module_id_file_name sample.module_id </span><br><span class="line">    --gen_c_file_name sample.cudafe<span class="number">1.</span>c </span><br><span class="line">    --stub_file_name sample.cudafe<span class="number">1.</span>stub.c </span><br><span class="line">    --gen_device_file_name sample.cudafe<span class="number">1.</span>gpu </span><br><span class="line">    sample.cpp<span class="number">1.</span>ii -o sample.ptx</span><br><span class="line"></span><br><span class="line">ptxas sample.ptx  -o sample.sm_<span class="number">52.</span>cubin</span><br><span class="line"></span><br><span class="line">fatbinary --image3=kind=elf,sm=<span class="number">52</span>,file=sample.sm_<span class="number">52.</span>cubin </span><br><span class="line">    --image3=kind=ptx,sm=<span class="number">52</span>,file=sample.ptx </span><br><span class="line">    --embedded-fatbin=sample.fatbin.c</span><br><span class="line"></span><br><span class="line">gcc sample.cu -o sample.cpp<span class="number">4.</span>ii</span><br><span class="line"></span><br><span class="line">cudafe++ --gen_c_file_name sample.cudafe<span class="number">1.</span>cpp </span><br><span class="line">    --stub_file_name sample.cudafe<span class="number">1.</span>stub.c </span><br><span class="line">    --module_id_file_name sample.module_id </span><br><span class="line">    sample.cpp<span class="number">4.</span>ii</span><br><span class="line"></span><br><span class="line">gcc sample.cudafe<span class="number">1.</span>cpp -o sample.o</span><br><span class="line"></span><br><span class="line">nvlink --<span class="keyword">register</span>-link-binaries=sample_dlink.reg.c </span><br><span class="line">    sample.o -o sample_dlink.sm_<span class="number">52.</span>cubin</span><br><span class="line"></span><br><span class="line">fatbinary -link </span><br><span class="line">    --image3=kind=elf,sm=<span class="number">52</span>,file=sample_dlink.sm_<span class="number">52.</span>cubin </span><br><span class="line">    --embedded-fatbin=sample_dlink.fatbin.c</span><br><span class="line"></span><br><span class="line">gcc -DFATBINFILE=sample_dlink.fatbin.c </span><br><span class="line">    -DREGISTERLINKBINARYFILE=sample_dlink.reg.c </span><br><span class="line">    -m64 /usr/lib/nvidia-cuda-toolkit/bin/crt/link.stub </span><br><span class="line">    -o sample_dlink.o</span><br></pre></td></tr></table></figure>

<p>ä½¿ç”¨<code>nvcc sample.cu -o sample --keep</code>ä¿ç•™çš„æ–‡ä»¶ç›®å½•å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">.</span><br><span class="line">â”œâ”€â”€ sample.cpp1.ii</span><br><span class="line">â”œâ”€â”€ sample.cpp4.ii</span><br><span class="line">â”œâ”€â”€ sample.cu</span><br><span class="line">â”œâ”€â”€ sample.cudafe1.c</span><br><span class="line">â”œâ”€â”€ sample.cudafe1.cpp</span><br><span class="line">â”œâ”€â”€ sample.cudafe1.gpu</span><br><span class="line">â”œâ”€â”€ sample.cudafe1.stub.c</span><br><span class="line">â”œâ”€â”€ sample_dlink.fatbin</span><br><span class="line">â”œâ”€â”€ sample_dlink.fatbin.c</span><br><span class="line">â”œâ”€â”€ sample_dlink.o</span><br><span class="line">â”œâ”€â”€ sample_dlink.reg.c</span><br><span class="line">â”œâ”€â”€ sample_dlink.sm_52.cubin</span><br><span class="line">â”œâ”€â”€ sample.fatbin</span><br><span class="line">â”œâ”€â”€ sample.fatbin.c</span><br><span class="line">â”œâ”€â”€ sample.module_id</span><br><span class="line">â”œâ”€â”€ sample.o</span><br><span class="line">â”œâ”€â”€ sample.ptx</span><br><span class="line">â””â”€â”€ sample.sm_52.cubin</span><br></pre></td></tr></table></figure>
<p>ç°åœ¨æˆ‘ä»¬ä¾æ¬¡åˆ†æä¸€ä¸‹æ¯ä¸€æ¡æŒ‡ä»¤éƒ½åšäº†ä»€ä¹ˆï¼Œäº§ç”Ÿäº†å“ªäº›æ–‡ä»¶ï¼Œæ¯ä¸ªæ–‡ä»¶çš„å˜åŒ–å’ŒåŠŸèƒ½ã€‚</p>
<h3 id="æ­¥éª¤ä¸€"><a href="#æ­¥éª¤ä¸€" class="headerlink" title="æ­¥éª¤ä¸€"></a>æ­¥éª¤ä¸€</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sample.cu -o sample.cpp1.ii</span><br></pre></td></tr></table></figure>
<p>sample.cuæœ¬èº«å…¶å®å°±æ˜¯ä¸€ä¸ªå¸¦äº†cudaè¯­æ³•æ‰©å±•çš„C++ç¨‹åºï¼Œæˆ–è€…è¯´å¸¦äº†cudaè¯­æ³•æ‰©å±•å’ŒC++è¯­æ³•æ‰©å±•çš„Cç¨‹åºï¼Œæ‰€ä»¥å¯ä»¥ç”¨gccè¿™ä¸ªCç¼–è¯‘å™¨è¿›è¡Œç¼–è¯‘é¢„å¤„ç†(ç¼–è¯‘é¢„å¤„ç†çš„è¯­æ³•æ˜¯ä¸€æ ·çš„)ï¼Œç„¶ågccä¼šå¤„ç†è¯¸å¦‚<code>#define</code>ã€<code>#include</code>ç­‰å‘½ä»¤ï¼Œç„¶åå¾—åˆ°ä¸€ä¸ªç¼–è¯‘é¢„å¤„ç†ç»“æŸçš„iiæ–‡ä»¶ã€‚è¿™ä¸ªæ–‡ä»¶éå¸¸åºå¤§ï¼Œè¿™ä¸»è¦æ˜¯å› ä¸ºå®ƒincludeçš„æ–‡ä»¶éå¸¸å¤šï¼Œå±•å¼€æ¥å°±æ˜¾å¾—å¾ˆåºå¤§ï¼Œä½†æ˜¯å®é™…ä¸Šåªæœ‰æœ€æœ«å°¾çš„ä¸€éƒ¨åˆ†ä»£ç æ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„sampleçš„éƒ¨åˆ†ã€‚</p>
<h3 id="æ­¥éª¤äºŒ"><a href="#æ­¥éª¤äºŒ" class="headerlink" title="æ­¥éª¤äºŒ"></a>æ­¥éª¤äºŒ</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cicc --include_file_name sample.fatbin.c </span><br><span class="line">    --gen_module_id_file --module_id_file_name sample.module_id </span><br><span class="line">    --gen_c_file_name sample.cudafe1.c </span><br><span class="line">    --stub_file_name sample.cudafe1.stub.c </span><br><span class="line">    --gen_device_file_name sample.cudafe1.gpu </span><br><span class="line">    sample.cpp1.ii -o sample.ptx</span><br></pre></td></tr></table></figure>
<p>å› ä¸ºæˆ‘ä»¬çš„cudaç¨‹åºæ˜¯CPUå’ŒGPUååŒè¿è¡Œçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ—¢éœ€è¦ç¼–è¯‘å¾—åˆ°å¸¸è§„CPUè¿è¡Œçš„Cä»£ç ï¼Œä¹Ÿéœ€è¦è¿è¡ŒGPUå¯ä»¥è¿è¡Œçš„GPUçš„äºŒè¿›åˆ¶ä»£ç ï¼›æ­¤å¤–æˆ‘ä»¬çš„CPUç¨‹åºæ¯”å¦‚å¯ä»¥ç”¨<code>add&lt;&lt;&lt;grid,dim&gt;&gt;&gt;(res,a,b,n)</code>æ¥è°ƒç”¨GPUç¨‹åºï¼Œä½†æ˜¯GPUç¨‹åºæ˜¯æ— æ³•ç›´æ¥è¢«è°ƒç”¨çš„ï¼Œæ‰€ä»¥è¿™é‡Œéœ€è¦ç”ŸæˆCPUé—´æ¥è°ƒç”¨GPUçš„ä»£ç ï¼›å¦å¤–å°±æ˜¯æˆ‘ä»¬æœ‰å¾ˆå¤šGPUä»£ç çš„ä¿¡æ¯ï¼Œæˆ‘ä»¬CPUéœ€è¦æ‰§è¡ŒGPUçš„ä»£ç å°±éœ€è¦ç®¡ç†è¿™éƒ¨åˆ†ä¿¡æ¯ï¼Œæ‰€ä»¥éœ€è¦ä¸€äº›ä»£ç æ¥æ³¨å†Œå’Œç®¡ç†GPUä»£ç çš„ä¿¡æ¯ã€‚è€Œè¿™äº›å¯¹åº”çš„ä»£ç çš„åˆå§‹å½¢æ€éƒ½æ˜¯åœ¨è¿™ä¸ªå‘½ä»¤ä¸­è¢«äº§ç”Ÿçš„ï¼ŒåŒ…æ‹¬GPUä»£ç ç®¡ç†çš„CPUä»£ç ã€GPUä»£ç è°ƒç”¨çš„CPUä»£ç ã€GPUå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç çš„ä¸­é—´å½¢æ€ç­‰ã€‚</p>
<h4 id="sample-module-id"><a href="#sample-module-id" class="headerlink" title="sample.module_id"></a>sample.module_id</h4><p>ä¼¼ä¹ä¸æ˜¯æ¯ä¸ªæ–‡ä»¶éƒ½ç”¨çš„ï¼Œæœ‰äº›æ–‡ä»¶ä¹‹åä¼¼ä¹æ²¡æœ‰è¢«ç”¨åˆ°ï¼Œæ¯”å¦‚sample.module_idï¼Œé‡Œé¢åªæœ‰ä¸€è¡Œ<code>_394179f1_9_sample_cu_e9c26b7d</code>åºå·ï¼Œä¼°è®¡åªæ˜¯cudaæ–‡ä»¶ç®¡ç†çš„æ—¶å€™æ´¾ä¸€ä¸‹ç”¨åœºå§ã€‚</p>
<h3 id="sample-cudafe1-c"><a href="#sample-cudafe1-c" class="headerlink" title="sample.cudafe1.c"></a>sample.cudafe1.c</h3><p>é‡Œé¢çš„å†…å®¹æ˜¯ä¸€å †å…¨å±€å˜é‡çš„å®šä¹‰ï¼Œä½†æ˜¯ä¼¼ä¹æ²¡æœ‰äººç”¨å®ƒï¼Œä¼°è®¡ä¸èµ·åˆ°å¤§çš„ä½œç”¨</p>
<h4 id="sample-cudafe1-gpu"><a href="#sample-cudafe1-gpu" class="headerlink" title="sample.cudafe1.gpu"></a>sample.cudafe1.gpu</h4><p>è¿™éƒ¨åˆ†ä¼šæŠŠsample.cpp1.iiå½“ä¸­GPUç›¸å…³çš„é‚£äº›ä»£ç ï¼Œæ¯”å¦‚ç”¨<code>__device__</code>ã€<code>__shared__</code>ï¼Œæˆ–è€…ç”¨<code>__global__</code>ä¿®é¥°çš„éƒ¨åˆ†æå–å‡ºæ¥ï¼Œå¾—åˆ°è¿™æ ·ä¸€ä¸ªæ–‡ä»¶ã€‚</p>
<p>æ–‡ä»¶å¼€å¤´æ˜¯å¤§é‡çš„enumã€typedefã€structçš„å®šä¹‰ï¼Œä¼°è®¡æ˜¯ç±»ä¼¼äºincludeçš„å±•å¼€ï¼Œç­‰å¾…è¢«åç»­å¼•ç”¨ï¼Œä¸è¿‡å¤§å¤šæ•°éƒ½ç”¨ä¸ä¸Šï¼›ç„¶åä¸­é—´éƒ¨åˆ†æ˜¯å‡½æ•°å£°æ˜ï¼Œæ‰€æœ‰æˆ‘ä»¬ä½¿ç”¨è¿‡çš„CPUå‡½æ•°éƒ½ä¼šè¢«ä»–è®¤ä¸ºæ˜¯ä¸€ä¸ª<code>extern __device__</code>çš„å‡½æ•°ï¼Œç­‰å¾…è¢«å¤–éƒ¨é“¾æ¥ï¼Œä¸è¿‡å®é™…ä¸Šè¿™äº›å¹¶ä¸æ˜¯GPUéœ€è¦çš„å‡½æ•°ï¼Œæ‰€ä»¥åç»­ä¹Ÿä¸ä¼šäº§ç”Ÿä»€ä¹ˆä½œç”¨ï¼Œæ— éœ€ç†ç¬ï¼›ç„¶åæ˜¯æˆ‘ä»¬è‡ªå·±ç¼–å†™çš„<code>__global__</code>å‡½æ•°çš„å‡½æ•°å£°æ˜ï¼Œè¯¸å¦‚<code>gpu_vector_add</code>å‡½æ•°ä¼šäº§ç”Ÿ<code>_Z14gpu_vector_addPiS_S_i</code>çš„å‡½æ•°å£°æ˜ï¼Œè¿™é‡Œçš„å‰ç¼€å’Œåç¼€åº”è¯¥æ˜¯æ ¹æ®å‡½æ•°çš„è°ƒç”¨å‚æ•°æ¥åŠ çš„ï¼Œå¦å¤–è¿˜æœ‰ä¸¤ä¸ªç‰¹åˆ«çš„å‡½æ•°å£°æ˜<code>_ZN4dim3C1Ejjj</code>å’Œ<code>_ZN4dim3C2Ejjj</code>æˆ‘ä»¬åç»­ä»‹ç»ï¼›ä¹‹åæ˜¯<code>__device__</code>æ¶‰åŠçš„ä¸€äº›å…¨å±€å˜é‡ã€‚</p>
<p>ä¹‹åå°±æ˜¯<code>__global__</code>å‡½æ•°å¯¹åº”çš„å‡½æ•°å®šä¹‰ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„<code>gpu_vector_add</code>å°±ä»ä¸€å¼€å§‹çš„</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">__global__ <span class="type">void</span> <span class="title">gpu_vector_add</span><span class="params">(<span class="type">int</span>* a,<span class="type">int</span>* b,<span class="type">int</span>* res,<span class="type">int</span> n)</span></span>&#123;</span><br><span class="line">    <span class="type">int</span> index=threadIdx.x+blockIdx.x*blockDim.x;</span><br><span class="line">    res[index]=a[index]+b[index];</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¢«ç¼–è¯‘ä¸ºäº†sample.cudafe1.gpuä¸­çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__global__ __var_used__ <span class="keyword">extern</span> <span class="type">void</span> _Z14gpu_vector_addPiS_S_i(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>);</span><br><span class="line">__global__ __var_used__ <span class="type">void</span> _Z14gpu_vector_addPiS_S_i(</span><br><span class="line"><span class="type">int</span> *a, </span><br><span class="line"><span class="type">int</span> *b, </span><br><span class="line"><span class="type">int</span> *res, </span><br><span class="line"><span class="type">int</span> n)&#123;</span><br><span class="line">&#123;</span><br><span class="line"> <span class="type">int</span> __cuda_local_var_54379_9_non_const_index;</span><br><span class="line">__cuda_local_var_54379_9_non_const_index = ((<span class="type">int</span>)((threadIdx.x) + ((blockIdx.x) * (blockDim.x))));</span><br><span class="line">(res[__cuda_local_var_54379_9_non_const_index]) = </span><br><span class="line">((a[__cuda_local_var_54379_9_non_const_index]) + (b[__cuda_local_var_54379_9_non_const_index])); </span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°ä¸¤è€…é™¤äº†å˜é‡åã€å‡½æ•°ååŠ äº†ä¸€å †å‰ç¼€ä¹‹å¤–æ²¡æœ‰ä»€ä¹ˆåŒºåˆ«ï¼Œè€ŒåŠ å‰ç¼€ä¼°è®¡ä¹Ÿåªæ˜¯ä¸ºäº†æ–¹ä¾¿ç¼–è¯‘é˜¶æ®µçš„å¤„ç†ã€‚æ‰€ä»¥åŸºæœ¬åªæ˜¯æŠŠæˆ‘ä»¬å®šä¹‰çš„<code>__global__</code>å‡½æ•°éƒ½æå–å‡ºæ¥äº†è€Œå·²ã€‚</p>
<p>æœ€åæˆ‘ä»¬ç¨å¾®è§£é‡Šä¸€ä¸‹æ¯”è¾ƒç‰¹åˆ«çš„<code>_ZN4dim3C1Ejjj</code>å’Œ<code>_ZN4dim3C2Ejjj</code>ï¼Œä»–ä»¬çš„å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">__asm__(<span class="string">&quot;.align 2&quot;</span>);</span><br><span class="line">___device__(<span class="type">static</span>  __no_sc__) __inline__ <span class="type">void</span> _ZN4dim3C1Ejjj( </span><br><span class="line">    <span class="keyword">struct</span> dim3 *<span class="type">const</span> <span class="keyword">this</span>, </span><br><span class="line">    <span class="type">unsigned</span> vx, </span><br><span class="line">    <span class="type">unsigned</span> vy, </span><br><span class="line">    <span class="type">unsigned</span> vz)&#123;</span><br><span class="line">    (<span class="keyword">this</span>-&gt;x) = vx;</span><br><span class="line">    (<span class="keyword">this</span>-&gt;y) = vy;</span><br><span class="line">    (<span class="keyword">this</span>-&gt;z) = vz; </span><br><span class="line">&#125;</span><br><span class="line">__asm__(<span class="string">&quot;.align 2&quot;</span>);</span><br><span class="line">___device__(<span class="type">static</span>  __no_sc__) __inline__ <span class="type">void</span> _ZN4dim3C2Ejjj( <span class="keyword">struct</span> dim3 *<span class="type">const</span> <span class="keyword">this</span>,  <span class="type">unsigned</span> __T2,  <span class="type">unsigned</span> __T3,  <span class="type">unsigned</span> __T4)&#123; </span><br><span class="line">    _ZN4dim3C1Ejjj(<span class="keyword">this</span>, __T2, __T3, __T4);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æ‰€ä»¥ä¸¤ä¸ªå‡½æ•°åšçš„æ˜¯ä¸€ä»¶äº‹æƒ…ï¼Œå°±æ˜¯åˆå§‹åŒ–dim3ç»“æ„ï¼Œæˆ‘ä»¬çš„<code>add&lt;&lt;&lt;grid,block&gt;&gt;&gt;()</code>æ¶‰åŠåˆ°çš„gridå’Œblockå°±æ˜¯ä¸¤ä¸ªdim3ï¼Œä»–ä»¬åœ¨åšèµ‹å€¼æ“ä½œçš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå‡½æ•°ï¼Œgridç”¨çš„æ˜¯ç¬¬ä¸€ä¸ª<code>_ZN4dim3C1Ejjj</code>ï¼Œè€Œblockç”¨çš„æ˜¯ç¬¬äºŒä¸ª<code>_ZN4dim3C2Ejjj</code>ã€‚</p>
<h4 id="sample-ptx"><a href="#sample-ptx" class="headerlink" title="sample.ptx"></a>sample.ptx</h4><p>GPUä¸Šè¿è¡Œçš„kernelå‡½æ•°ä¼šè¢«ç¼–è¯‘ç”Ÿæˆptxæ–‡ä»¶ï¼Œptxç±»ä¼¼äºcudaæ±‡ç¼–çš„irï¼Œå®é™…ä¸Šå®ƒçš„ssaé£æ ¼å°±æ˜¯å’ŒCçš„iré«˜åº¦ä¸€è‡´çš„ã€‚GPUç›´æ¥è¿è¡Œçš„æŒ‡ä»¤é›†è¢«ç§°ä¹‹ä¸ºSASSï¼Œä½†æ˜¯GPUçš„SASSæ¯ä¸€ä¸ªæ¶æ„éƒ½ä¼šæœ‰å¾ˆå¤§çš„å·®å¼‚ï¼Œæ‰€ä»¥å¦‚æœå…è®¸ç”¨æˆ·ç›´æ¥ç¼–å†™SASSçš„è¯ï¼Œnvidiaå…¬å¸å¿…é¡»ç»´æŠ¤SASSçš„å…¼å®¹èƒ½åŠ›ï¼Œå› æ­¤å®ƒæ²¡æœ‰æä¾›ç”¨æˆ·ç¼–å†™SASSçš„ç»“æ„ï¼Œè€Œæ˜¯æä¾›äº†SASSçš„ä¸Šå±‚irï¼Œç§°ä¹‹ä¸ºptx codeã€‚ç”¨æˆ·å¯ä»¥ç›´æ¥ç¼–å†™ptx codeï¼Œä¹Ÿå¯ä»¥åœ¨kernelä¸­å†…åµŒptx codeè¿›è¡Œç¼–ç¨‹ï¼Œç„¶åå†é€šè¿‡nvidiaæä¾›çš„ç¼–è¯‘å™¨å°†ptxç¼–è¯‘ä¸ºsassè¢«GPUæ‰§è¡Œã€‚æ‰€ä»¥è¯¥æ–‡ä»¶å°±æ˜¯GPUæœ€åçš„å¯æ‰§è¡Œä»£ç çš„åˆå§‹å½¢æ€ã€‚</p>
<p>æ¯”å¦‚è¯´æˆ‘ä»¬ç»å…¸çš„<code>gpu_vector_add</code>å¯¹åº”çš„kernelå°±è¢«ç¼–è¯‘ä¸ºäº†ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.visible .entry _Z14gpu_vector_addPiS_S_i(</span><br><span class="line">    .param .u64 _Z14gpu_vector_addPiS_S_i_param_0,</span><br><span class="line">    .param .u64 _Z14gpu_vector_addPiS_S_i_param_1,</span><br><span class="line">    .param .u64 _Z14gpu_vector_addPiS_S_i_param_2,</span><br><span class="line">    .param .u32 _Z14gpu_vector_addPiS_S_i_param_3</span><br><span class="line">    )</span><br><span class="line">&#123;</span><br><span class="line">    .reg .b32 %r&lt;8&gt;;</span><br><span class="line">    .reg .b64 %rd&lt;11&gt;;</span><br><span class="line"></span><br><span class="line">    ld.param.u64 %rd1, [_Z14gpu_vector_addPiS_S_i_param_0];</span><br><span class="line">    ld.param.u64 %rd2, [_Z14gpu_vector_addPiS_S_i_param_1];</span><br><span class="line">    ld.param.u64 %rd3, [_Z14gpu_vector_addPiS_S_i_param_2];</span><br><span class="line">    cvta.to.global.u64 %rd4, %rd3;</span><br><span class="line">    cvta.to.global.u64 %rd5, %rd2;</span><br><span class="line">    cvta.to.global.u64 %rd6, %rd1;</span><br><span class="line">    mov.u32 %r1, %tid.x;</span><br><span class="line">    mov.u32 %r2, %ctaid.x;</span><br><span class="line">    mov.u32 %r3, %ntid.x;</span><br><span class="line">    mad.lo.s32 %r4, %r2, %r3, %r1;</span><br><span class="line">    mul.wide.s32 %rd7, %r4, 4;</span><br><span class="line">    add.s64 %rd8, %rd6, %rd7;</span><br><span class="line">    ld.global.u32 %r5, [%rd8];</span><br><span class="line">    add.s64 %rd9, %rd5, %rd7;</span><br><span class="line">    ld.global.u32 %r6, [%rd9];</span><br><span class="line">    add.s32 %r7, %r6, %r5;</span><br><span class="line">    add.s64 %rd10, %rd4, %rd7;</span><br><span class="line">    st.global.u32 [%rd10], %r7;</span><br><span class="line">    ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯¹äºptxæˆ‘æ²¡æœ‰æ·±å…¥çš„ç ”ç©¶å®ƒçš„è¯­æ³•ï¼Œå’ŒptxæŒ‡ä»¤çš„è¯­ä¹‰ï¼Œå› ä¸ºè¿™ä¸»è¦å°±æ˜¯éµå¾ªæŸç§è§„èŒƒè€Œå·²ï¼Œæ¯”å¦‚loadæ“ä½œç”¨ldå®ç°ï¼Œæä¾›è‹¥å¹²ç§ldæ ¼å¼å’Œä¿®é¥°ï¼Œè¿™éƒ½æ˜¯æ¯”è¾ƒå¹³å‡¡çš„äº‹æƒ…ï¼Œåªéœ€è¦æœ‰ä¸€ä¸ªå®Œæ•´çš„å®˜æ–¹æ–‡æ¡£å¯ä»¥æŸ¥è¯¢å³å¯ã€‚</p>
<p>ç¨å¾®è®²ä¸€äº›ptxæ¯”è¾ƒæœ‰è¶£çš„ç°è±¡ï¼šä¸€å¼€å§‹å‡ºç°çš„æ˜¯å‡½æ•°çš„å£°æ˜ï¼Œæˆ‘ä»¬çš„4ä¸ªå‚æ•°è¢«ä¾æ¬¡ä¼ å…¥ï¼Œä½†æ˜¯å½“ptxä½¿ç”¨è¿™ä¸ªå››ä¸ªå‚æ•°çš„æ—¶å€™ä½¿ç”¨çš„æ˜¯ldæŒ‡ä»¤ï¼Œè€Œä¸æ˜¯ç›´æ¥ä½¿ç”¨ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.param .u64 _Z14gpu_vector_addPiS_S_i_param_0,</span><br><span class="line">.param .u64 _Z14gpu_vector_addPiS_S_i_param_1,</span><br><span class="line">.param .u64 _Z14gpu_vector_addPiS_S_i_param_2,</span><br><span class="line">.param .u32 _Z14gpu_vector_addPiS_S_i_param_3</span><br><span class="line"></span><br><span class="line">ld.param.u64 %rd1, [_Z14gpu_vector_addPiS_S_i_param_0];</span><br><span class="line">ld.param.u64 %rd2, [_Z14gpu_vector_addPiS_S_i_param_1];</span><br><span class="line">ld.param.u64 %rd3, [_Z14gpu_vector_addPiS_S_i_param_2];</span><br></pre></td></tr></table></figure>
<p>è¿™æ˜¯å› ä¸ºåœ¨Cå‡½æ•°è°ƒç”¨çš„æ—¶å€™ï¼Œæˆ‘ä»¬å¯èƒ½è¯´æŠŠå‚æ•°ä¼ é€’åˆ°å¯„å­˜å™¨a0-a7å½“ä¸­ï¼Œç„¶åä½¿ç”¨è¿™ä¸ªå‡ ä¸ªå¯„å­˜å™¨å°±å¯ä»¥ç›´æ¥ä½¿ç”¨ä¼ å…¥çš„å‚æ•°äº†ï¼Œä½†æ˜¯CPUæ²¡æœ‰åŠæ³•æŠŠå®ƒçš„å‚æ•°ç”¨å¯„å­˜å™¨ä¼ é€’ç»™GPUã€‚GPUæ˜¯åˆ†é…äº†ä¸€æ®µconstant memoryï¼Œå½“kenerlè¢«è¿è¡Œï¼Œå‚æ•°è¢«ä¼ é€’è¿‡æ¥ä¹‹åï¼Œä¼ é€’çš„å‚æ•°ä¼šè¢«ä¿å­˜åˆ°constant memoryå¯¹åº”çš„ä½ç½®ï¼Œç„¶åå½“æˆ‘ä»¬æ‰§è¡Œkernelçš„æ—¶å€™ï¼Œå†ä»constant memoryçš„æ–¹å¼è½½å…¥å¯¹åº”çš„å‚æ•°å³å¯ï¼Œåæ­£ä¼ å…¥çš„å‚æ•°åªæ˜¯å€¼ï¼Œæ²¡æœ‰å¯¹åº”çš„ç‰©ç†å†…å­˜ï¼Œä¸ä¼šè¢«æ”¹å˜ï¼Œå½“ä½œconstanté‡åˆæƒ…åˆç†ã€‚</p>
<p>å…¶æ¬¡ptx codeåœ¨è¿™é‡Œä½¿ç”¨çš„æ˜¯SSAçš„æ¨¡å¼ï¼Œä¹Ÿå°±æ˜¯æ¯ä¸€ä¸ªå¯„å­˜å™¨åªä¼šè¢«èµ‹å€¼ä¸€æ¬¡ï¼Œè¿™æ ·çš„æ–¹æ³•è™½ç„¶ä¼šå¯¼è‡´ptx codeå½“ä¸­ä½¿ç”¨çš„å¯„å­˜å™¨å¾ˆå¤šï¼Œä½†æ˜¯åç»­SSAåˆ†æè¿›è¡Œå¯„å­˜å™¨åˆ†é…ä¼šæ¯”è¾ƒå®¹æ˜“ï¼Œå¤šä½™çš„å¯„å­˜å™¨åç»­ä¹Ÿä¼šè¢«åˆå¹¶æ‰ï¼Œæ­¤å¤–è¿™é‡Œä½¿ç”¨äº†rå’Œrdä¸¤å¥—å¯„å­˜å™¨ï¼Œå°†åœ°å€å’Œæ•°æ®åˆ†å¼€æ¥å¤„ç†ï¼Œä¾¿äºåç»­çš„ç¼–è¯‘ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">.reg .b32 %r&lt;8&gt;;</span><br><span class="line">.reg .b64 %rd&lt;11&gt;;</span><br></pre></td></tr></table></figure>

<p>æœ€åå°±æ˜¯ç‰¹æ®Šæ•°æ®çš„è¯»å–ï¼Œæ¯”å¦‚threadIdxã€blockDimã€blockIdxçš„è¯»å–ï¼Œä»–ä»¬åœ¨ptx codeé˜¶æ®µè¢«è®¤ä¸ºä¿å­˜åœ¨ç‰¹æ®Šçš„å¯„å­˜å™¨tidã€ntidã€ctaidå½“ä¸­ï¼Œå½“ç„¶ç¼–è¯‘åˆ°SASSä¹‹ååˆä¼šæœ‰æ–°çš„åŒºåˆ«ï¼ŒthreadIdxã€blockIdxæ¯ä¸ªthreadå’Œblockæ˜¯ä¸ä¸€æ ·çš„ï¼Œå®ƒæ˜¯ç”±çœŸå®çš„å¯„å­˜å™¨ä¿å­˜çš„ï¼Œä½†æ˜¯blockDimå’ŒgridDimå°±æ˜¯ä¸€ä¸ªå¸¸æ•°ç½¢äº†ï¼Œæ‰€ä»¥ä¼šè¢«åˆ†é…åˆ°constant memoryï¼Œä¹‹åè¯»å–constant memoryå°±å¯ä»¥äº†ã€‚æ­¤å¤–ä¸ºä»€ä¹ˆblockIdxå¯¹åº”çš„ç‰¹æ®Šå¯„å­˜å™¨ä¸å«blockidè€Œæ˜¯å«ctaidå‘¢ï¼Œé‚£æ˜¯å› ä¸ºåœ¨ç¡¬ä»¶å±‚é¢ä¸Šè¿™ä¸ªblockçš„åˆ†é…åˆè¢«ç§°ä¹‹ä¸ºcooperative thread arrayï¼Œç®€ç§°CTAï¼Œå› è€Œå¾—åã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">mov.u32 %r1, %tid.x;</span><br><span class="line">mov.u32 %r2, %ctaid.x;</span><br><span class="line">mov.u32 %r3, %ntid.x;</span><br></pre></td></tr></table></figure>

<h4 id="sample-cudafe1-stub-c"><a href="#sample-cudafe1-stub-c" class="headerlink" title="sample.cudafe1.stub.c"></a>sample.cudafe1.stub.c</h4><p>æˆ‘ä»¬ä¹‹å‰æåˆ°ciccç¼–è¯‘å¾—åˆ°GPUä»£ç ç®¡ç†çš„CPUä»£ç ã€GPUä»£ç è°ƒç”¨çš„CPUä»£ç ã€GPUå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç çš„ä¸­é—´å½¢æ€ç­‰ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ï¼Œä¸Šå–å¼„çš„sample.ptxå°±æ˜¯GPUå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç çš„ä¸­é—´å½¢æ€ï¼Œè€Œsample.cudafe1.stub.cå°±æ˜¯å‰©ä¸‹çš„GPUä»£ç ç®¡ç†çš„CPUä»£ç ã€GPUä»£ç è°ƒç”¨çš„CPUä»£ç ã€‚</p>
<p>ç¼–è¯‘å‘½ä»¤å½“ä¸­çš„<code>--include_file_name sample.fatbin.c</code>å°±æ˜¯ä¸ºè¯¥æ–‡ä»¶å‡†å¤‡çš„ï¼Œè¿™ä¸ªæ–‡ä»¶ä¼šå¤šä¸€è¡Œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span> <span class="string">&quot;sample.fatbin.c&quot;</span></span></span><br></pre></td></tr></table></figure>
<p>è¿™ä¸ªæ–‡ä»¶æ˜¯ä»€ä¹ˆï¼Œæ´¾ä»€ä¹ˆç”¨åœºï¼Œæˆ‘ä»¬åç»­å†è§£é‡Š</p>
<p>å¯¹äºæ¯ä¸€ä¸ªkernelå‡½æ•°ï¼Œä»–éƒ½ä¼šè½¬å˜ä¸ºå¦‚ä¸‹çš„å‡½æ•°ï¼Œæˆ‘ä»¬ç»§ç»­ä»¥<code>gpu_vector_add</code>ä¸ºä¾‹å­ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">extern</span> <span class="type">void</span> __device_stub__Z14gpu_vector_addPiS_S_i(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>);</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">gpu_vector_add</span><span class="params">( <span class="type">int</span> *__cuda_0,<span class="type">int</span> *__cuda_1,<span class="type">int</span> *__cuda_2,<span class="type">int</span> __cuda_3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __device_stub__Z14gpu_vector_addPiS_S_i( __cuda_0,__cuda_1,__cuda_2,__cuda_3);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">void</span> __device_stub__Z14gpu_vector_addPiS_S_i(<span class="type">int</span> *__par0, <span class="type">int</span> *__par1, <span class="type">int</span> *__par2, <span class="type">int</span> __par3)&#123;</span><br><span class="line">    __cudaLaunchPrologue(<span class="number">4</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par0, <span class="number">0UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par1, <span class="number">8UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par2, <span class="number">16UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par3, <span class="number">24UL</span>);</span><br><span class="line">    __cudaLaunch(((<span class="type">char</span> *)((<span class="built_in">void</span> ( *)(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>))gpu_vector_add)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æˆ‘ä»¬çš„gpu_vector_addåªæ˜¯ä¸€ä¸ªç®€å•çš„å‡½æ•°è·³æ¿ï¼Œè°ƒç”¨gpu_vector_addå…¶å®æ˜¯è°ƒç”¨__device_stub__Z14gpu_vector_addPiS_S_iï¼Œç„¶åè¯¥å‡½æ•°ä½¿ç”¨__cudaLaunchPrologueå£°æ˜å‚æ•°çš„ä¸ªæ•°ï¼Œç”¨__cudaSetupArgSimpleä¼ é€’å‚æ•°ï¼Œæœ€åç”¨__cudaLaunchè°ƒç”¨å¯¹åº”çš„kernelå‡½æ•°ã€‚æ›´å…·ä½“çš„ç»†èŠ‚ï¼Œæˆ‘ä»¬åœ¨æ‰§è¡Œæµç¨‹åˆ†æçš„æ—¶å€™å†è¿›ä¸€æ­¥çš„å±•å¼€ã€‚</p>
<p>è¿™äº›å°±æ˜¯æ‰€è°“çš„CPUè°ƒç”¨GPUçš„å‡½æ•°ï¼Œä¸è¿‡è¿™é‡Œå…¶å®ä¹Ÿåªæ˜¯ä¸€éƒ¨åˆ†ï¼Œä»…ä»…æ˜¯è¢«è°ƒç”¨æ–¹çš„Cä»£ç ï¼Œè¢«è°ƒç”¨æ–¹è¿˜æœ‰å¦ä¸€éƒ¨åˆ†çš„Cä»£ç ï¼Œæˆ‘ä»¬åé¢é‡åˆ°äº†ç»§ç»­åˆ†æã€‚</p>
<p>ç„¶åå®ƒé¢å¤–äº§ç”Ÿäº†ä¸¤ä¸ªé‡è¦çš„å‡½æ•°ï¼Œè¿™ä¸¤ä¸ªå‡½æ•°è´Ÿè´£CPUå¯¹GPUkernelä»£ç çš„ç®¡ç†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __nv_cudaEntityRegisterCallback( <span class="type">void</span> **__T5) &#123;  </span><br><span class="line">    __nv_dummy_param_ref(__T5);</span><br><span class="line">    __nv_save_fatbinhandle_for_managed_rt(__T5);</span><br><span class="line">    __cudaRegisterEntry(__T5, ((<span class="built_in">void</span> ( *)(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>, <span class="type">int</span>, <span class="type">int</span>))gpu_matrix_mul), _Z14gpu_matrix_mulPiS_S_iii, (<span class="number">-1</span>));</span><br><span class="line">    __cudaRegisterEntry(__T5, ((<span class="built_in">void</span> ( *)(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *))gpu_matrix_add), _Z14gpu_matrix_addPiS_S_, (<span class="number">-1</span>));</span><br><span class="line">    __cudaRegisterEntry(__T5, ((<span class="built_in">void</span> ( *)(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>))gpu_vector_add), _Z14gpu_vector_addPiS_S_i, (<span class="number">-1</span>));</span><br><span class="line">&#125;</span><br><span class="line"><span class="type">static</span> <span class="type">void</span> __sti____cudaRegisterAll(<span class="type">void</span>) &#123;  </span><br><span class="line">    __cudaRegisterBinary(__nv_cudaEntityRegisterCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ª__sti____cudaRegisterAllå‡½æ•°è¿›è¡ŒGPUæ‰§è¡Œçš„binaryçš„ç¬¬ä¸€é˜¶æ®µæ³¨å†Œï¼Œç„¶åè°ƒç”¨__nv_cudaEntityRegisterCallbackæ³¨å†Œæ¯ä¸€ä¸ªkenerlå‡½æ•°çš„ä¿¡æ¯ã€‚æˆ‘ä»¬ç¨å¾®å±•å¼€ä¸€ä¸‹ï¼Œæˆ‘ä»¬æœ€åè‚¯å®šæ˜¯ä¼šæŠŠGPUçš„å¯æ‰§è¡Œä»£ç ç¼–è¯‘ä¸ºä¸€ä¸ªbinaryæ®µä¿å­˜åœ¨elfå½“ä¸­çš„ï¼Œç„¶å__cudaRegisterBinaryé¦–å…ˆå¯¹è¿™éƒ¨åˆ†çš„binaryåšä¸€ä¸ªç®¡ç†å’Œæ³¨å†Œï¼Œç„¶åè°ƒç”¨__nv_cudaEntityRegisterCallbackã€‚æ¯ä¸€ä¸ªkernelçš„Cä»£ç å…¥å£æ˜¯å”¯ä¸€çš„ï¼Œæˆ‘ä»¬å°†è¿™ä¸ªå”¯ä¸€çš„Cä»£ç å…¥å£åœ°å€å’Œbianryä¸­å¯¹åº”çš„kenerlç»‘å®šï¼Œç„¶åæˆ‘ä»¬å‰é¢è°ƒç”¨æ¯”å¦‚<code>__device_stub__Z14gpu_vector_addPiS_S_i</code>çš„æ—¶å€™ï¼Œå®ƒçš„<code>__cudaLaunch(gpu_vector_add)</code>å°±å¯ä»¥æ ¹æ®gpu_vector_addæ‰¾åˆ°å¯¹åº”çš„kernelç»“æ„ï¼Œç„¶åè°ƒç”¨è®©gpuè°ƒç”¨è¿™ä¸ªkernelã€‚</p>
<h3 id="æ­¥éª¤ä¸‰"><a href="#æ­¥éª¤ä¸‰" class="headerlink" title="æ­¥éª¤ä¸‰"></a>æ­¥éª¤ä¸‰</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">ptxas sample.ptx  -o sample.sm_52.cubin</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬æŠŠsample.ptxç¼–è¯‘ä¸ºsample.sm_52.cubinï¼Œè¿™ä¸ªcubinå°±æ˜¯æ‰€è°“çš„GPUè¿è¡Œçš„binaryï¼Œé‡Œé¢æœ‰textå¯¹åº”çš„SASSï¼Œè¿˜æœ‰å¯¹åº”çš„å…¶ä»–æ•°æ®ä¹‹ç±»çš„ä¿¡æ¯ï¼Œcubinä¹Ÿæ˜¯ä¸€ä¸ªelfæ ¼å¼ç»„ç»‡çš„æ–‡ä»¶ï¼Œåªä¸è¿‡é‡Œé¢çš„æ®µå’ŒCçš„ä¸ä¸€æ ·è€Œå·²ã€‚sm_52æ˜¯å› ä¸ºæ¯ä¸€ç§GPUçš„æ¶æ„æ˜¯ä¸ä¸€æ ·çš„ï¼Œæˆ‘ä»¬ç§°ä¹‹ä¸ºæƒèƒ½ï¼Œä¹Ÿå¯ä»¥ç†è§£ä¸ºGPUçš„æ¶æ„ç¼–å·ï¼Œsm_52å°±æ˜¯æƒèƒ½ä¸º5.2çš„GPUçš„å¯ä»¥ç›´æ¥æ‰§è¡Œçš„SASSï¼Œæ¢è¨€ä¹‹è¿™ä¸ªcubinåªæœ‰æ”¯æŒæƒèƒ½5.2çš„GPUæ‰å¯ä»¥è¿è¡Œã€‚5.2ç”±majorç‰ˆæœ¬å·5å’Œminorç‰ˆæœ¬å·2ç»„æˆï¼Œæ¯ä¸ªä¸åŒçš„nvidiaç³»åˆ—ä¸€èˆ¬æ˜¯ä¸€ä¸ªå…¨æ–°çš„majorï¼Œç³»åˆ—å†…éƒ¨çš„minoræœ‰å·®å¼‚ï¼Œå¯¹äºSASSæŒ‡ä»¤é›†å’Œå¾®æ¶æ„ï¼ŒåŒä¸€ä¸ªmajorå†…éƒ¨å·®ä¸å¤šï¼Œä½†æ˜¯majorä¹‹é—´ä¼šå¤§ç›¸å¾„åº­ã€‚</p>
<p>æˆ‘ä»¬å¯ä»¥ç”¨cuobjdumpè§‚å¯Ÿsample.cm_52.cubinå†…éƒ¨çš„ç»“æ„ï¼Œå†…éƒ¨çš„æ®µæ¯”å¦‚å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">64bit elf: type=2, abi=7, sm=52, toolkit=115, flags = 0x340534</span><br><span class="line">Sections:</span><br><span class="line">Index Offset   Size ES Align        Type        Flags Link     Info Name</span><br><span class="line">    1     40    1f5  0  1            STRTAB       0    0        0 .shstrtab</span><br><span class="line">    2    235    24b  0  1            STRTAB       0    0        0 .strtab</span><br><span class="line">    3    480    108 18  8            SYMTAB       0    2        8 .symtab</span><br><span class="line">    4    588     90  0  4         CUDA_INFO       0    3        0 .nv.info</span><br><span class="line">    5    618     a4  0  4         CUDA_INFO       0    3        c .nv.info._Z14gpu_matrix_mulPiS_S_iii</span><br><span class="line">    6    6bc     68  0  4         CUDA_INFO       0    3        d .nv.info._Z14gpu_matrix_addPiS_S_</span><br><span class="line">    7    724     74  0  4         CUDA_INFO       0    3        e .nv.info._Z14gpu_vector_addPiS_S_i</span><br><span class="line">    8    798     d8  8  8    CUDA_RELOCINFO       0    0        0 .nv.rel.action</span><br><span class="line">    9    870    164  0  4          PROGBITS       2    0        c .nv.constant0._Z14gpu_matrix_mulPiS_S_iii</span><br><span class="line">    a    9d4    158  0  4          PROGBITS       2    0        d .nv.constant0._Z14gpu_matrix_addPiS_S_</span><br><span class="line">    b    b2c    15c  0  4          PROGBITS       2    0        e .nv.constant0._Z14gpu_vector_addPiS_S_i</span><br><span class="line">    c    ca0    e40  0 20          PROGBITS       6    3 1c000008 .text._Z14gpu_matrix_mulPiS_S_iii</span><br><span class="line">    d   1ae0    140  0 20          PROGBITS       6    3  8000009 .text._Z14gpu_matrix_addPiS_S_</span><br><span class="line">    e   1c20    100  0 20          PROGBITS       6    3  800000a .text._Z14gpu_vector_addPiS_S_i</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°æ¯ä¸€ä¸ªkerneléƒ½æœ‰è‡ªå·±å¯¹åº”çš„.nv.constant0æ®µã€.textæ®µã€.nv.infoæ®µï¼Œconstantæ®µæ˜¯kerneléœ€è¦çš„constant memoryç©ºé—´çš„å†…å®¹ï¼Œä¸€èˆ¬éƒ½æ˜¯0ï¼Œéœ€è¦åæœŸè½½å…¥kernelçš„æ—¶å€™å†å¡«å……ï¼Œ.textæ®µå°±æ˜¯å¯¹åº”çš„SASSï¼Œ.nv.infoæ˜¯ä¸€äº›æ®µçš„ä¿¡æ¯ï¼Œæ¯”å¦‚ä¼ å…¥å‚æ•°çš„ä¿¡æ¯ã€å †æ ˆçš„ä¿¡æ¯ç­‰ï¼Œä¼°è®¡__sti____cudaRegisterAllä¼šå……åˆ†è§£é‡Šè¿™éƒ¨åˆ†çš„ä¿¡æ¯ï¼Œä¹‹åconstantçš„å¡«å……ã€å‚æ•°çš„ä¼ é€’ç­‰ä¹Ÿç¦»ä¸å¼€.nv.infoçš„æŒ‡å¯¼ã€‚</p>
<h3 id="æ­¥éª¤å››"><a href="#æ­¥éª¤å››" class="headerlink" title="æ­¥éª¤å››"></a>æ­¥éª¤å››</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">fatbinary --image3=kind=elf,sm=52,file=sample.sm_52.cubin </span><br><span class="line">    --image3=kind=ptx,sm=52,file=sample.ptx </span><br><span class="line">    --embedded-fatbin=sample.fatbin.c</span><br></pre></td></tr></table></figure>
<p>è¯¥æ“ä½œè´Ÿè´£å°†sample.ptxå’Œsample.sm_52.cubinæ‰“åŒ…ç”Ÿæˆä¸€ä¸ªsample.fatbin.cæ–‡ä»¶ï¼Œå¾—åˆ°çš„å†…å®¹åŸºæœ¬å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">#define __CUDAFATBINSECTION  &quot;.nvFatBinSegment&quot;</span><br><span class="line">#define __CUDAFATBINDATASECTION  &quot;.nv_fatbin&quot;</span><br><span class="line">asm(</span><br><span class="line">&quot;.section .nv_fatbin, \&quot;a\&quot;\n&quot;</span><br><span class="line">&quot;.align 8\n&quot;</span><br><span class="line">&quot;fatbinData:\n&quot;</span><br><span class="line">&quot;.quad 0x00100001ba55ed50,0x0000000000002770,0x0000004001010002,0x00000000000020e0\n&quot;</span><br><span class="line">&quot;.quad 0x0000000000000000,0x0000003400010007,0x0000000000000000,0x0000000000000011\n&quot;</span><br><span class="line">........</span><br><span class="line">&quot;.quad 0x381901e9381a0223,0x38d00115371701e9,0x0a0a3b7465720a3a,0x00000000000a0a7d\n&quot;</span><br><span class="line">&quot;.text\n&quot;);</span><br><span class="line">extern const unsigned long long fatbinData[1264];</span><br><span class="line">static const __fatBinC_Wrapper_t __fatDeviceText __attribute__ ((aligned (8))) __attribute__ ((section (__CUDAFATBINSECTION)))= &#123; 0x466243b1, 1, fatbinData, 0 &#125;;</span><br></pre></td></tr></table></figure>
<p>å…¶ä¸­å®šä¹‰äº†ä¸€ä¸ª.nv_fatbinæ®µï¼Œé‡Œé¢çš„å†…å®¹å°±æ˜¯åŸå°ä¸åŠ¨çš„cubinå’Œå‹ç¼©ä¹‹åçš„ptxï¼Œæ‰€ä»¥æˆ‘ä»¬çš„.nv_fatbinå°±æ˜¯æˆ‘ä»¬GPUçš„å¯æ‰§è¡Œç¨‹åºéƒ¨åˆ†ï¼Œè¿™ä¸ªæ®µç°åœ¨å¤§å°å°±æ˜¯<code>unsigned long long fatbinData[1264]</code>çš„å¤§å°ï¼Œæ‰€ä»¥è®¿é—®fatbinDatatå…¶å®å°±æ˜¯è®¿é—®è¿™ä¸ªæ®µã€‚é‚£ä¸ºä»€ä¹ˆè¦åŒ…å«SASSå’Œptxä¸¤éƒ¨åˆ†å‘¢ï¼Ÿä¸»è¦æ˜¯å› ä¸ºä¸åŒçš„æƒèƒ½çš„GPUï¼Œå®ƒä»¬çš„SASSä¸ä¸€æ ·ï¼Œå¦‚æœä»–ä»¬æ‰§è¡Œçš„æ—¶å€™å‘ç°SASSä¸ä¸€æ ·ï¼Œé‚£ä¹ˆå°±å¯ä»¥é¢å¤–çš„æ‰§è¡Œcudalibçš„jitåŠŸèƒ½ï¼Œå°†ptxé‡æ–°ç¼–è¯‘ä¸ºå¯¹åº”ç‰ˆæœ¬çš„SASSè¿è¡Œï¼Œä»è€Œæé«˜äº†ä»£ç çš„å¯ç§»æ¤æ€§å’Œå…¼å®¹æ€§ã€‚</p>
<p>ä¹‹åå®šä¹‰äº†.nvFatBinSegmentæ®µï¼Œè¿™ä¸ªæ®µçš„æ•°æ®ç»“æ„è¢«å®šä¹‰åœ¨â€fatbinary_section.hâ€å½“ä¸­ï¼Œ</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> &#123;</span><br><span class="line">  <span class="type">int</span> magic;</span><br><span class="line">  <span class="type">int</span> version;</span><br><span class="line">  <span class="type">const</span> <span class="type">unsigned</span> <span class="type">long</span> <span class="type">long</span>* data;</span><br><span class="line">  <span class="type">void</span> *filename_or_fatbins;  <span class="comment">/* version 1: offline filename,</span></span><br><span class="line"><span class="comment">                               * version 2: array of prelinked fatbins */</span></span><br><span class="line">&#125; __fatBinC_Wrapper_t;</span><br></pre></td></tr></table></figure>
<p>ç¬¬ä¸€ä¸ª4å­—èŠ‚çš„0x466243b1æ˜¯ä¸€ä¸ªé­”æ•°ï¼Œæ²¡ä»€ä¹ˆæ„ä¹‰ï¼›ç¬¬äºŒä¸ªè‡ªå·±æ˜¯ç‰ˆæœ¬ï¼ŒæŒ‡ç¤ºfilename_or_fatbinsçš„å†…å®¹ï¼Œç¬¬ä¸‰ä¸ªdataå°±æ˜¯fatbinDataæ•°ç»„çš„åœ°å€ï¼›æœ€åä¸€ä¸ªå°±æ˜¯filename_or_fatbinsçš„åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°å¯ä»¥æŒ‡å‘ä¸€ä¸ªæ–‡ä»¶åå­—ç¬¦ä¸²ï¼Œè¯´æ˜fatbinåœ¨è¿™ä¸ªæ–‡ä»¶ä¸­ï¼Œä¹Ÿå¯ä»¥æŒ‡å‘ä¸€ä¸ªprelinked fatbinsä¸­ï¼Œè¯´æ˜é‚£ä¸ªæ•°ç»„å½“ä¸­æœ‰ä¸€å †éœ€è¦é¢å¤–è¿è¡Œçš„fatbinã€‚</p>
<p>æ‰€ä»¥nvFatBinSegemntå°±æ˜¯å¯¹.nv_fatbinçš„æè¿°ï¼Œå¯¹äºè¿™ä¸ª.nv_fatbinæ®µï¼ŒnvFatBinSegmentæŒ‡å‡ºä»–çš„ä½ç½®ï¼Œä¸”æ²¡æœ‰é¢å¤–çš„fileæˆ–è€…prelinked fatbinsçš„ä¾èµ–ã€‚</p>
<p>æˆ‘ä»¬ä¹‹å‰è¯´äº†åœ¨sample.cudafe1.stub.cä¸­includeäº†sample.fatbin.cï¼Œæ‰€ä»¥æˆ‘ä»¬çš„sample.cudafe1.stub.cå°±åŒ…å«äº†è¿™ä¸¤ä¸ªæ®µï¼Œè‡³æ­¤åªè¦åç»­çš„ä»£ç includeäº†æˆ‘ä»¬çš„sample.cudafe1.stub.cï¼Œå°±åŒ…å«äº†GPUä»£ç ç®¡ç†çš„CPUä»£ç ã€GPUä»£ç è°ƒç”¨çš„CPUä»£ç ã€GPUå¯æ‰§è¡Œçš„äºŒè¿›åˆ¶ä»£ç è¿™GPUç›¸å…³çš„ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ã€‚</p>
<h3 id="æ­¥éª¤5"><a href="#æ­¥éª¤5" class="headerlink" title="æ­¥éª¤5"></a>æ­¥éª¤5</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sample.cu -o sample.cpp4.ii</span><br></pre></td></tr></table></figure>
<p>å’Œæ­¥éª¤1ä¸€æ ·å†æ¬¡äº§ç”Ÿä¸€ä¸ªé¢„ç¼–è¯‘å¤„ç†æ–‡ä»¶ï¼Œä¸åŒçš„åœ°æ–¹åœ¨äºç¼–è¯‘çš„é€‰é¡¹æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥æœ€åçš„ç»“æœæœ‰æ‰€å·®å¼‚ï¼Œä¼°è®¡å…³ç³»ä¸å¤§</p>
<h3 id="æ­¥éª¤6"><a href="#æ­¥éª¤6" class="headerlink" title="æ­¥éª¤6"></a>æ­¥éª¤6</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">cudafe++ --gen_c_file_name sample.cudafe1.cpp </span><br><span class="line">    --stub_file_name sample.cudafe1.stub.c </span><br><span class="line">    --module_id_file_name sample.module_id </span><br><span class="line">    sample.cpp4.ii</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆsample.cudafe1.cppæ–‡ä»¶ï¼Œè¯¥æ–‡ä»¶includeäº†ä¹‹å‰çš„sample.stub.cï¼Œå› æ­¤å·²ç»åŒ…å«äº†GPUéƒ¨åˆ†çš„ä»£ç ï¼Œä½™ä¸‹çš„cppæœ¬èº«çš„ä»£ç å°±æ˜¯åœ¨å¤„ç†CPUéƒ¨åˆ†çš„ä»£ç ï¼Œç”Ÿæˆçš„ä»£ç å°±æ˜¯é¢„å¤„ç†ä¹‹åå¤§é‡çš„å£°æ˜ã€å®šä¹‰ç­‰ç­‰ï¼Œæ¯”è¾ƒç‰¹åˆ«çš„æ˜¯ï¼Œæ‰€æœ‰GPUç›¸å…³çš„ä»£ç è¢«<code>#if 0 #endif</code>æ³¨é‡Šæ‰äº†ï¼Œç„¶åè¯¸å¦‚<code>add&lt;&lt;&lt;grid,block&gt;&gt;&gt;(res,a,b,n)</code>è¢«æ›¿æ¢ä¸ºäº†</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">(__cudaPushCallConfiguration(grid, block)) ? (<span class="type">void</span>)<span class="number">0</span> : <span class="built_in">add</span>(res,a,b,n); </span><br></pre></td></tr></table></figure>
<p>è‡³æ­¤æˆ‘ä»¬çš„cudaä»£ç å°±æ­£å¼å˜ä¸ºäº†ç®€å•çš„C++ä»£ç ï¼Œè¿™éƒ¨åˆ†çš„è¯­æ³•ç³–çš„ä¿®æ”¹å°±æ˜¯å®Œæˆäº†CPUè°ƒç”¨GPUå‡½æ•°çš„è°ƒç”¨æ–¹å¤„çš„ä»£ç æ“ä½œã€‚</p>
<h3 id="æ­¥éª¤7"><a href="#æ­¥éª¤7" class="headerlink" title="æ­¥éª¤7"></a>æ­¥éª¤7</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc sample.cudafe1.cpp -o sample.o</span><br></pre></td></tr></table></figure>
<p>ç¼–è¯‘å¾—åˆ°.oæ–‡ä»¶ï¼Œæˆ‘ä»¬ç¼–å†™çš„æ‰€æœ‰ä»£ç ï¼ŒåŒ…æ‹¬åŸºæœ¬çš„CPUä»£ç ï¼ŒCPUç®¡ç†fatbinçš„ä»£ç ï¼ŒCPUè°ƒç”¨GPUçš„ä»£ç ã€GPUæ‰§è¡Œçš„ä»£ç éƒ½åœ¨è¿™é‡Œäº†ã€‚</p>
<h3 id="æ­¥éª¤8"><a href="#æ­¥éª¤8" class="headerlink" title="æ­¥éª¤8"></a>æ­¥éª¤8</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">nvlink --register-link-binaries=sample_dlink.reg.c </span><br><span class="line">    sample.o -o sample_dlink.sm_52.cubin</span><br></pre></td></tr></table></figure>
<p>ç”Ÿæˆsample_dlink.reg.cï¼Œè²Œä¼¼æ²¡ä»€ä¹ˆç”¨ï¼›ç”Ÿæˆsample_dlink.sm_52.cubinï¼Œè¿™æ˜¯ä»åŸæ¥çš„sample.oä¸­æŠ½ç¦»å‡ºæ¥çš„ï¼Œè¿™éƒ¨åˆ†cubinåªåŒ…å«ç®€å•çš„SASSï¼Œè‡³äºä¸ºä»€ä¹ˆè¦å¤šæ­¤ä¸€ä¸¾ï¼Œå¹¶ä¸æ˜¯å¾ˆæ¸…æ¥šã€‚</p>
<h3 id="æ­¥éª¤9"><a href="#æ­¥éª¤9" class="headerlink" title="æ­¥éª¤9"></a>æ­¥éª¤9</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">fatbinary -link </span><br><span class="line">    --image3=kind=elf,sm=52,file=sample_dlink.sm_52.cubin </span><br><span class="line">    --embedded-fatbin=sample_dlink.fatbin.c</span><br></pre></td></tr></table></figure>
<p>å°†sample_dlink.sm_52.cubinç”Ÿæˆsample_dlink.fatbin.cï¼Œè¯¥æ–‡ä»¶å’Œä¹‹å‰çš„sample_dlink.fatbin.cå·®ä¸å¤šï¼Œä½†æ˜¯å®ƒåŠä¸åŒ…å«SASSï¼Œä¹Ÿä¸åŒ…å«ptxï¼Œæ‰€ä»¥fatbinDataæ›´å°ï¼Œè¿™éƒ¨åˆ†ä¹Ÿæ˜¯è¢«å®šä¹‰åœ¨.nv_fatbinä¸­ï¼Œå®ƒçš„nvFatBinSegmentæ®µåˆ™æ˜¯å¦‚ä¸‹çš„ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">static const __fatBinC_Wrapper_t __fatDeviceText __attribute__ ((aligned (8))) __attribute__ ((section (__CUDAFATBINSECTION)))= </span><br><span class="line">	&#123; 0x466243b1, 2, fatbinData, (void**)__cudaPrelinkedFatbins &#125;;</span><br></pre></td></tr></table></figure>
<p>å¯ä»¥çœ‹åˆ°è¿™ä¸ªæ®µå¹¶ä¸æ˜¯æˆ‘ä»¬è‡ªå·±çš„kernelçš„nv_fatbinï¼Œè€Œæ˜¯ç”¨æ¥è¡¨è¿°__cudaPrelinkedFatbinså½“ä¸­çš„fatbinçš„ï¼Œä¼°è®¡æ˜¯GPUè¿è¡Œéœ€è¦ä¸€äº›cudaå¦å¤–é¢„å…ˆç¼–è¯‘å¥½çš„SASSæ‰å¯ä»¥è¿è¡Œï¼Œæ‰€ä»¥éœ€è¦è¿™ä¸ªæ®µä½œä¸ºè·³æ¿æ¥é“¾æ¥è¿™äº›å†…å®¹ã€‚</p>
<p>æœ€åsample_dlink.fatbin.cå’Œsample.fatbin.cçš„å†…å®¹éƒ½ä¼šè¢«æ•´åˆåˆ°.nv_fatbinå’Œ.nvFatBinSegmentå½“ä¸­æ¥ã€‚æ¯”å¦‚.nvFatBinSegmentçš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">Hex dump of section &#x27;.nvFatBinSegment&#x27;:</span><br><span class="line">  0x000a9058 b1436246 02000000 f08e0800 00000000 .CbF............</span><br><span class="line">  0x000a9068 e0910a00 00000000 b1436246 01000000 .........CbF....</span><br><span class="line">  0x000a9078 50920800 00000000 00000000 00000000 P...............</span><br></pre></td></tr></table></figure>
<p>å‰é¢24ä¸ªå­—èŠ‚å°±æ˜¯sample_dlink.fatbin.cçš„nvFatBinSegmentçš„å†…å®¹ï¼Œåé¢24ä¸ªå­—èŠ‚å°±æ˜¯sample.fatbin.cçš„å†…å®¹ã€‚</p>
<h3 id="æ­¥éª¤10"><a href="#æ­¥éª¤10" class="headerlink" title="æ­¥éª¤10"></a>æ­¥éª¤10</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">gcc -DFATBINFILE=sample_dlink.fatbin.c </span><br><span class="line">    -DREGISTERLINKBINARYFILE=sample_dlink.reg.c </span><br><span class="line">    -m64 /usr/lib/nvidia-cuda-toolkit/bin/crt/link.stub </span><br><span class="line">    -o sample_dlink.o</span><br></pre></td></tr></table></figure>
<p>å°†sample_dlink.fatbin.cç¼–è¯‘ä¸ºsample_dlink.o</p>
<h3 id="æ­¥éª¤11"><a href="#æ­¥éª¤11" class="headerlink" title="æ­¥éª¤11"></a>æ­¥éª¤11</h3><figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">g++ sample_dlink.o sample.o -lcudart_static -o sample</span><br></pre></td></tr></table></figure>
<p>ç„¶åæŠŠ.oéƒ½é“¾æ¥å¾—åˆ°æœ€åçš„sampleï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦ä¸€ä¸ª-lcudart_staticï¼Œä»–ä¼šæŠŠæ‰€æœ‰çš„cudalibé™æ€é“¾æ¥åˆ°sampleå½“ä¸­ï¼Œåˆ™ä¼šä¹Ÿå°±æ˜¯sampleå½“ä¸­é‚£ä¹ˆå¤šçš„cudartçš„ç”±æ¥ï¼Œä½†æ˜¯è™½ç„¶æ±‡ç¼–éƒ½æ˜¯æœ‰çš„ï¼Œå´æ²¡æœ‰å…¶ä»–ä»»ä½•libä¿¡æ¯ï¼Œå¾ˆéš¾çœ‹æ‡‚ã€‚</p>
<h3 id="å°ç»“"><a href="#å°ç»“" class="headerlink" title="å°ç»“"></a>å°ç»“</h3><p>æ‰€ä»¥æˆ‘ä»¬å¯ä»¥å¾—åˆ°æœ€åç¼–è¯‘çš„æµç¨‹å¦‚ä¸‹ï¼š<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/compile.jpg" alt="ç¼–è¯‘æµç¨‹å›¾"><br>å³ä¾§åˆ†æ”¯çš„<code>.cu-&gt;.cpp1.ii-&gt;.ptx-&gt;.cubin-&gt;.fatbin.c-&gt;cudafe1.stub.c</code>äº§ç”ŸGPUçš„æ‰§è¡Œä»£ç ï¼Œå’ŒCPUç®¡ç†å’Œè°ƒç”¨GPUçš„ä»£ç ï¼›å·¦ä¾§åˆ†æ”¯çš„<code>.cu-&gt;.cpp4.ii-&gt;.cudafe1.cpp-&gt;.o</code>å¾—åˆ°CPUè‡ªèº«æ‰§è¡Œçš„ä»£ç ï¼Œå¹¶åŒ…å«GPUæ‰§è¡Œçš„éƒ¨åˆ†ï¼›ä¸‹æ–¹çš„<code>.o-&gt;_dlink.cubin-&gt;_dlink.fatbin.c-&gt;.o</code>å¾—åˆ°prelink_fatbinç›¸å…³çš„GPUä»£ç ï¼›æœ€åæ‰€æœ‰çš„.oé“¾æ¥å¾—åˆ°æœ€åçš„.exeæ–‡ä»¶ã€‚</p>
<h2 id="cudaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹"><a href="#cudaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹" class="headerlink" title="cudaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹"></a>cudaç¨‹åºçš„æ‰§è¡Œè¿‡ç¨‹</h2><p>cudaã€nvidiaæœ¬èº«çš„èµ„æ–™éå¸¸æœ‰é™ï¼Œæ‰€ä»¥ä¸‹é¢çš„åˆ†æåŸºäºä¸€äº›é›¶ç¢çš„èµ„æ–™+cudaçš„ä»£ç å’Œä¸ªäººçš„æ¨æµ‹ï¼ŒåŒæ—¶å› ä¸ºamdçš„ä»£ç å’Œcudaçš„æœ‰é«˜åº¦çš„å¯¹ç§°æ€§ï¼Œä¹Ÿä»é‚£é‡Œè·å¾—äº†ä¸€äº›çµæ„Ÿï¼Œæ‰€ä»¥ä»…ä»…æ”¾åœ¨è¿™é‡Œä¸ºå…¶ä»–ç ”ç©¶cudaçš„æœ‹å‹æä¾›å‚è€ƒã€‚</p>
<h3 id="åˆå§‹åŒ–éƒ¨åˆ†"><a href="#åˆå§‹åŒ–éƒ¨åˆ†" class="headerlink" title="åˆå§‹åŒ–éƒ¨åˆ†"></a>åˆå§‹åŒ–éƒ¨åˆ†</h3><p>é¦–å…ˆelfè¿è¡Œçš„æ—¶å€™å…ˆæ˜¯å¸¸è§„çš„å¯åŠ¨è¿‡ç¨‹ï¼Œç„¶åè¿›å…¥<code>dl_init</code>å‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šéå†elfå½“ä¸­<code>.init_array</code>æ•°ç»„å½“ä¸­çš„æ¯ä¸€ä¸ªinitå‡½æ•°ï¼Œæ¥åˆå§‹åŒ–æˆ‘ä»¬çš„ç¨‹åºã€‚cudaçš„<code>.init_array</code>è‡³å°‘åŒ…å«5ä¸ªåˆå§‹åŒ–å‡½æ•°ã€‚</p>
<h4 id="cudart412"><a href="#cudart412" class="headerlink" title="__cudart412"></a>__cudart412</h4><p><code>__cudart412-&gt;__cudart1594-&gt;pthread_once</code><br>è¿™æ˜¯ç¬¬ä¸€ä¸ªåˆå§‹åŒ–å‡½æ•°çš„æ‰§è¡Œæµç¨‹ï¼Œå› ä¸ºæ˜¯cudaçš„user runtimeæ˜¯é—­æºçš„ï¼Œæ‰€ä»¥æ²¡æœ‰åŠæ³•ç›´æ¥æŸ¥åˆ°å¯¹åº”çš„èµ„æ–™ï¼Œä½†ä»–ä¸€å®šæ˜¯åœ¨åšcudaç›¸å…³çš„åˆå§‹åŒ–æ“ä½œã€‚</p>
<p>å½“ä¸€ä¸ªcudaçš„processåœ¨è¿è¡Œçš„æ—¶å€™ï¼ŒGPU driverä¼šä¸ºè¿™ä¸ªè¿›ç¨‹äº§ç”Ÿä¸€ä¸ªå¯¹åº”çš„contextï¼Œæ­¤å¤–å› ä¸ºCPUå’ŒGPUæ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œå½“æœ‰ä¸€ä¸ªçº¿ç¨‹åœ¨è¿è¡ŒCPUçš„æ—¶å€™è¿˜éœ€è¦å¦ä¸€ä¸ªçº¿ç¨‹è¿è¡ŒGPUï¼Œæ‰€ä»¥å¾ˆæœ‰å¯èƒ½è¿™ä¸ªå‡½æ•°è¿›è¡Œäº†contextçš„åˆå§‹åŒ–ï¼Œå¹¶ä¸”è¿›è¡Œäº†é¢å‘GPU driverçº¿ç¨‹çš„åˆ›å»ºã€‚è¿™é‡Œä»…åšçŒœæµ‹ã€‚</p>
<h4 id="frame-dummy"><a href="#frame-dummy" class="headerlink" title="frame_dummy"></a>frame_dummy</h4><p>è¿™ä¸ªæ˜¯Cæœ¬èº«å°±ä¼šè‡ªå¸¦çš„å”¯ä¸€ä¸€ä¸ª<code>init_array</code>çš„å‡½æ•°ï¼ŒåŸºæœ¬ä¸Šä»€ä¹ˆéƒ½ä¸åšã€‚</p>
<h4 id="sti-cudaRegisterAllv"><a href="#sti-cudaRegisterAllv" class="headerlink" title="__sti____cudaRegisterAllv"></a>__sti____cudaRegisterAllv</h4><p>è¿™ä¸ªå°±æ˜¯æˆ‘ä»¬ä¹‹å‰åœ¨sample.cudafe1.stub.cå½“ä¸­äº§ç”Ÿçš„å‡½æ•°ï¼Œè´Ÿè´£nv_fatbinçš„ä¿¡æ¯ç®¡ç†å’Œkernelå‡½æ•°CPUè°ƒç”¨çš„ç®¡ç†ï¼Œè¿™éƒ¨åˆ†AMDæœ‰å……åˆ†çš„æºä»£ç ï¼Œæˆ‘ä»¬ç¬¼ç»Ÿçš„çœ‹ä¸€ä¸‹ã€‚</p>
<p>å¯¹äº<code>__sti____cudaRegisterAllv</code>å…¶ä¸­çš„å†…å®¹å¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __sti____cudaRegisterAll(<span class="type">void</span>) &#123;  </span><br><span class="line">    __cudaRegisterBinary(__nv_cudaEntityRegisterCallback);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>å…¶å®è¿™äº›éƒ½æ˜¯è¢«å®šä¹‰åœ¨crt&#x2F;host_runtime.hä¸­çš„å®ï¼Œæˆ‘ä»¬æŠŠå®å±•å¼€ï¼Œæœ€åå¾—åˆ°çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __sti____cudaRegisterAll(<span class="type">void</span>) &#123;</span><br><span class="line">    __cudaFatCubinHandle = __cudaRegisterFatBinary  ((<span class="type">void</span>*)&amp;__fatDeviceText);</span><br><span class="line">    <span class="built_in">void</span> (*callback_fp)(<span class="type">void</span> **) =  (<span class="built_in">void</span> (*)(<span class="type">void</span> **))(__nv_cudaEntityRegisterCallback); </span><br><span class="line">    (*callback_fp)(__cudaFatCubinHandle);</span><br><span class="line">    __cudaRegisterFatBinaryEnd(__cudaFatCubinHandle);</span><br><span class="line">    <span class="built_in">atexit</span>(__cudaUnregisterBinaryUtil);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè°ƒç”¨__cudaRegisterFatBinaryå‡½æ•°ï¼Œè¯¥å‡½æ•°ä¼šå¯¹nv_fatbinè¿›è¡Œå¤„ç†ï¼Œå°†é‡Œé¢çš„ä¿¡æ¯ä¿å­˜åˆ°ç‰¹å®šçš„æ•°æ®ç»“æ„å½“ä¸­ï¼Œç„¶åè¿”å›æ•°æ®ç»“æ„çš„handlerã€‚ä¹‹åè°ƒç”¨__nv_cudaEntityRegisterCallbackï¼Œå¯¹handlerç»§ç»­åšåç»­çš„æ³¨å†Œç®¡ç†å·¥ä½œã€‚ç»“æŸä¹‹åè°ƒç”¨__cudaRegisterFatBinaryEndåšä¸‹ä¸€é˜¶æ®µçš„æ”¶å°¾å¤„ç†ã€‚æœ€åå› ä¸ºç¨‹åºé€€å‡ºä¹‹åéœ€è¦å¯¹bianryå†åšä¸€äº›æ“ä½œï¼Œæ‰€ä»¥æŠŠå¤„ç†å‡½æ•°__cudaUnregisterBinaryUtilå‡½æ•°æ³¨å†Œåˆ°atexitä¸­ï¼Œæ¥åšregisterçš„é€†æ“ä½œunregisterã€‚</p>
<p>å¯¹äº<code>__nv_cudaEntityRegisterCallback</code>ï¼Œä»–ä¹Ÿæ˜¯æœ‰ä¸€ç³»åˆ—çš„å®ç»„æˆçš„ï¼Œæˆ‘ä»¬æŠŠå®å±•å¼€å¾—åˆ°å¦‚ä¸‹çš„å†…å®¹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> __nv_cudaEntityRegisterCallback( <span class="type">void</span> **handle)&#123;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">static</span> <span class="type">void</span> **__ref __attribute__((unused));</span><br><span class="line">    __ref = (<span class="keyword">volatile</span> <span class="type">void</span> **)handle;</span><br><span class="line">    __nv_save_fatbinhandle_for_managed_rt(handle);</span><br><span class="line">    __cudaRegisterFunction(handle, (<span class="type">const</span> <span class="type">char</span>*)funptr, <span class="meta">#func, #fun, -1, (uint3*)0, (uint3*)0, (dim3*)0, (dim3*)0, (int*)0);</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯¥å‡½æ•°é¦–å…ˆæŠŠhandleè¯»åˆ°ä¸€ä¸ªå˜é‡é‡Œé¢ï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦è¿™ä¹ˆåšã€‚ç„¶åè°ƒç”¨__nv_save_fatbinhandle_for_managed_rtå¤„ç†handlerã€‚ä¹‹åå¯¹äºæ¯ä¸€ä¸ªkernelå‡½æ•°çš„CPUè°ƒç”¨å…¥å£ï¼Œæˆ‘ä»¬ç”¨__cudaRegisterFunctionæ³¨å†Œè¿™ä¸ªè°ƒç”¨å…¥å£åœ°å€å’Œå¯¹åº”çš„GPUçš„SASSçš„å…³ç³»ã€‚</p>
<h4 id="GLOBAL-sub-I-Zn7Compute11rand-memoryFPii"><a href="#GLOBAL-sub-I-Zn7Compute11rand-memoryFPii" class="headerlink" title="__GLOBAL_sub_I_Zn7Compute11rand_memoryFPii"></a>__GLOBAL_sub_I_Zn7Compute11rand_memoryFPii</h4><p>è¯¥å‡½æ•°è°ƒç”¨<code>static_initialization_and_destruction</code>è¿›è¡Œå…¨å±€å˜é‡çš„æ„é€ å‡½æ•°ï¼Œå¹¶æ³¨å†Œå¯¹åº”çš„ææ„å‡½æ•°ï¼Œæ‰€ä»¥å’Œcudaæ²¡å…³ç³»ï¼Œæ˜¯C++æœ¬èº«è‡ªå¸¦çš„å‡½æ•°ã€‚</p>
<h4 id="cudart424"><a href="#cudart424" class="headerlink" title="__cudart424"></a>__cudart424</h4><p>ä»…ä½œçº¯ç²¹çš„ALUè®¡ç®—ï¼Œä¼¼ä¹æ²¡ä»€ä¹ˆç”¨</p>
<h4 id="å°ç»“-1"><a href="#å°ç»“-1" class="headerlink" title="å°ç»“"></a>å°ç»“</h4><p>åˆå§‹åŒ–å‡½æ•°éƒ½è¿è¡Œå®Œä¹‹åï¼Œç¨‹åºå°±ç»§ç»­è¿”å›dl_mainï¼Œç„¶åè¿›è¡ŒåŠ¨æ€è¿æ¥å’Œè¿›å…¥mainå‡½æ•°ï¼Œå°±å’Œæ­£å¸¸çš„Cç¨‹åºä¸€æ ·ã€‚æ‰€ä»¥åˆå§‹åŒ–éƒ¨åˆ†ï¼Œcudaåº”è¯¥å®Œæˆäº†contextçš„å»ºç«‹ã€é¢å‘GPU driverçš„çº¿ç¨‹çš„å»ºç«‹ã€nv_fatbinä¿¡æ¯çš„ç®¡ç†ã€CPUåˆ°GPUçš„ç¬¦å·æ³¨å†Œç­‰ã€‚</p>
<h3 id="cuda-APIçš„è°ƒç”¨"><a href="#cuda-APIçš„è°ƒç”¨" class="headerlink" title="cuda APIçš„è°ƒç”¨"></a>cuda APIçš„è°ƒç”¨</h3><p>cuda APIçš„è°ƒç”¨éƒ½æ˜¯ç›´æ¥callå‡½æ•°å³å¯ï¼Œå› ä¸ºcudaåšçš„äº‹é™æ€é“¾æ¥ï¼Œæ‰€ä»¥ç›´æ¥è·³åˆ°æŸä¸€ä¸ª__cudartxxxxå‡½æ•°å½“ä¸­ï¼Œç„¶ååå¤è°ƒç”¨å„ç§__cudartxxxxã€‚è™½ç„¶cudaçš„runtimeåšäº†é™æ€é“¾æ¥ï¼Œä½†æ˜¯å¹¶ä¸æ˜¯å…¨éƒ¨çš„runtimeä»£ç éƒ½åœ¨è¿™é‡Œäº†ï¼Œå®é™…ä¸Šè¿™éƒ¨åˆ†runtimeæœ‰å¯èƒ½è°ƒç”¨å¤–éƒ¨cudalib.soçš„å†…å®¹ï¼Œå“ªæ€•elfæ²¡æœ‰å¯¹è¿™ä¸ªæ–‡ä»¶æœ‰åŠ¨æ€è¿æ¥çš„æŒ‡ç¤ºã€‚</p>
<p>æ­¤å¤–åœ¨ç¬¬ä¸€æ¬¡è°ƒç”¨ä¾‹å¦‚cudaMallocå‡½æ•°çš„æ—¶å€™ä¼šå‘ç°è¿™ä¸ªå‡½æ•°æ‰§è¡Œçš„æ—¶é—´ä¼šæ¯”ä»¥åè°ƒç”¨è¯¥å‡½æ•°çš„å‡½æ•°é•¿å¾ˆå¤šï¼Œè€Œä¸”å½“ä¸”ä»…å½“è¿™ä¸€æ¬¡ï¼Œç¨‹åºä¼šè®¿é—®fatbinæ®µã€‚å½“ç„¶ä¸æ’é™¤åˆ«çš„åœ°æ–¹æˆ‘æ²¡æ³¨æ„åˆ°ã€‚ä¹‹åé˜…è¯»è®ºæ–‡çš„æ—¶å€™å‘ç°ï¼Œç¨‹åºåœ¨ä¸€å¼€å§‹ä¼šè¿›è¡Œä¸€æ¬¡æ•°æ®ä¼ è¾“ï¼ŒæŠŠcudaçš„GPUä»£ç ä»¥æ•°æ®çš„å½¢å¼ä¼ è¾“åˆ°GPUä¸Šï¼Œä¹‹åå¦‚æœè¦æ‰§è¡Œè¿™ä¸ªGPUä»£ç ï¼Œä»…ä»…åªéœ€è¦å‘GPUå‘é€å‚æ•°å’Œå‘½ä»¤å³å¯ï¼Œæ— éœ€å†æ¬¡ä¼ è¾“GPUçš„textæ®µç­‰ä¿¡æ¯ã€‚æ‰€ä»¥è¿™ä¸€æ¬¡mallocéå¸¸æ…¢åº”è¯¥æ˜¯å› ä¸ºå†…éƒ¨æ‰§è¡Œçš„æ—¶å€™ï¼Œç¬¬ä¸€æ¬¡æ‰§è¡Œcuda APIï¼Œæ£€æŸ¥æŸäº›cudaç¯å¢ƒçš„æ—¶å€™è§¦å‘äº†å¯¹åº”çš„æœºåˆ¶ï¼Œäºæ˜¯è¢«ä¼ è¾“è¿‡å»äº†ã€‚ä¾‹å¦‚è¯´cudaMallocéœ€è¦ä¿®æ”¹é¡µè¡¨ï¼Œä½†æ˜¯å› ä¸ºnvfatbinè¿˜æ²¡æœ‰ä¼ è¿‡å»ï¼Œå¯¹é¢çš„GPUæ²¡æœ‰ä¸ºè¿™ä¸ªcontextåˆ†é…é¡µè¡¨ï¼Œäºæ˜¯æŠ¥é”™è¯´é¡µè¡¨ä¸å­˜åœ¨ä»€ä¹ˆçš„ï¼Œç„¶åè¿™é‡Œå°±çŸ¥é“nvfatbinè¿˜æ²¡ä¼ è¿‡å»ï¼Œå°±ä¼ è¿‡å»äº†ã€‚</p>
<h3 id="kenerlè°ƒç”¨"><a href="#kenerlè°ƒç”¨" class="headerlink" title="kenerlè°ƒç”¨"></a>kenerlè°ƒç”¨</h3><p>è®©æˆ‘ä»¬çœ‹çœ‹è°ƒç”¨ç®€å•çš„<code>gpu_vector_add</code>ä¼šå‘ç”Ÿä»€ä¹ˆã€‚</p>
<p>åœ¨ä¸€å¼€å§‹çš„sample.cuä¸­ï¼Œkernelå‡½æ•°çš„è°ƒç”¨è¯­æ³•æ˜¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">gpu&lt;&lt;&lt;grid,block,sharedmem,stream&gt;&gt;&gt;(res,a,b,n);</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œçš„sharedmemå’Œstreamä¹‹å‰ä¸€ç›´éƒ½æ˜¯ç¼ºçœçš„ï¼Œé‚£ä¹ˆåç»­å°±ä¼šé»˜è®¤è¿™ä¸¤ä¸ªå‚æ•°çš„å€¼æ˜¯0ï¼Œå°±å¥½åƒgridå’Œblockå¦‚æœè¾“å…¥çš„ä¸æ˜¯dim3çš„ç»“æ„è€Œæ˜¯ç®€å•çš„intæ•°æ®çš„è¯ï¼Œå°±ä¼šè‡ªåŠ¨è½¬æ¢ä¸ºdim3ï¼Œåªä¸è¿‡xã€yã€zä¸­å‰©ä¸‹çš„ä¸¤ä¸ªå‚æ•°çš„å€¼æ˜¯1ç½¢äº†ã€‚</p>
<p>ç„¶åç»è¿‡äº†ç¼–è¯‘æ—¶æœŸçš„æ­¥éª¤6ï¼Œåœ¨sample.cudafe1.cppå½“ä¸­è¿™å¥è¯­æ³•ç³–è¢«è½¬æ¢ä¸ºäº†ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line">(__cudaPushCallConfiguration(grid, block, sharedmem, stream)) ? (<span class="type">void</span>)<span class="number">0</span> : <span class="built_in">gpu_vector_add</span>(res,a,b,n); </span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆè¿è¡Œ__cudaPushCallConfigurationå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°å°†4ä¸ªå‚æ•°ä¼ é€’åˆ°kernelå‡½æ•°è°ƒç”¨çš„configurationå †æ ˆå½“ä¸­ï¼Œå¦‚æœè¿™ä¸ªæ“ä½œæŠ¥é”™äº†ï¼Œé‚£ä¹ˆå°±ä¸ä¼šè¿›è¡Œåç»­çš„æ“ä½œï¼Œä¸ç„¶çš„è¯å°±ä¼šè°ƒç”¨gpu_vector_addå‡½æ•°å¼€å§‹æ‰§è¡Œã€‚è¿™é‡Œä¼šç”¨åˆ°æˆ‘ä»¬åœ¨sample.gpuä¸­æåˆ°çš„<code>_ZN4dim3C1Ejjj</code>å’Œ<code>_ZN4dim3C2Ejjj</code>ï¼Œè¿™é‡Œçš„4ä¸ªå‚æ•°æ˜¯é¦–å…ˆå‹å…¥å †æ ˆï¼Œç„¶åæ‰è°ƒç”¨__cudaPushCallConfigurationå‡½æ•°çš„ï¼Œè€Œgridå’Œblockå¤åˆ¶åˆ°å †æ ˆçš„ä¼ å‚åŒºåŸŸå°±æ˜¯ç”¨è¿™ä¸¤ä¸ªå‡½æ•°å¤åˆ¶è¿‡å»çš„ã€‚</p>
<p>ç„¶åæ‰§è¡Œgpu_vector_addå‡½æ•°ï¼Œè¯¥å‡½æ•°åœ¨ä¹‹å‰çš„sample.cudafe1.stub.cå½“ä¸­å®šä¹‰ï¼Œå®ƒçš„å†…å®¹æ˜¯ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function"><span class="type">void</span> <span class="title">gpu_vector_add</span><span class="params">( <span class="type">int</span> *__cuda_0,<span class="type">int</span> *__cuda_1,<span class="type">int</span> *__cuda_2,<span class="type">int</span> __cuda_3)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    __device_stub__Z14gpu_vector_addPiS_S_i( __cuda_0,__cuda_1,__cuda_2,__cuda_3);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>äºæ˜¯ä½¿ç”¨è¿™ä¸ªå‡½æ•°ä¸ºè·³æ¿è°ƒç”¨äº†__device_stub__Z14gpu_vector_addPiS_S_iå‡½æ•°ï¼Œå¦‚ä¸‹ã€‚</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __device_stub__Z14gpu_vector_addPiS_S_i(<span class="type">int</span> *__par0, <span class="type">int</span> *__par1, <span class="type">int</span> *__par2, <span class="type">int</span> __par3)&#123;</span><br><span class="line">    __cudaLaunchPrologue(<span class="number">4</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par0, <span class="number">0UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par1, <span class="number">8UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par2, <span class="number">16UL</span>);</span><br><span class="line">    __cudaSetupArgSimple(__par3, <span class="number">24UL</span>);</span><br><span class="line">    __cudaLaunch(((<span class="type">char</span> *)((<span class="built_in">void</span> ( *)(<span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span> *, <span class="type">int</span>))gpu_vector_add)));</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™é‡Œé¢çš„å‡½æ•°å…¨éƒ¨éƒ½æ˜¯å®ï¼Œä¹Ÿå…¨éƒ¨éƒ½å®šä¹‰åœ¨é‚£ä¸ªcrt&#x2F;host_runtime.hä¸­ï¼Œå±•å¼€æ¥çš„ç»“æœå¦‚ä¸‹ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> __device_stub__Z14gpu_vector_addPiS_S_i(<span class="type">int</span> *__par0, <span class="type">int</span> *__par1, <span class="type">int</span> *__par2, <span class="type">int</span> __par3)&#123;</span><br><span class="line">    <span class="type">void</span> * __args_arr[<span class="number">3</span>];</span><br><span class="line">    <span class="type">int</span> __args_idx = <span class="number">0</span>;</span><br><span class="line">    __args_arr[__args_idx] = (<span class="type">void</span> *)(<span class="type">char</span> *)&amp;par0;++__args_idx;</span><br><span class="line">    __args_arr[__args_idx] = (<span class="type">void</span> *)(<span class="type">char</span> *)&amp;par1;++__args_idx;</span><br><span class="line">    __args_arr[__args_idx] = (<span class="type">void</span> *)(<span class="type">char</span> *)&amp;par2;++__args_idx;</span><br><span class="line">    __args_arr[__args_idx] = (<span class="type">void</span> *)(<span class="type">char</span> *)&amp;par3;++__args_idx;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">static</span> <span class="type">char</span> *__f __NV_ATTR_UNUSED_FOR_LAUNCH;</span><br><span class="line">    __f = fun;</span><br><span class="line">    dim3 __gridDim, __blockDim;</span><br><span class="line">    <span class="type">size_t</span> __sharedMem;</span><br><span class="line">    cudaStream_t __stream;</span><br><span class="line">    <span class="keyword">if</span>(__cudaPopCallConfiguration(&amp;__gridDim, &amp;__blockDim, &amp;__sharedMem, &amp;__stream) != cudaSuccess)</span><br><span class="line">        <span class="keyword">return</span>;</span><br><span class="line">    <span class="keyword">if</span> (__args_idx == <span class="number">0</span>) &#123;</span><br><span class="line">        (<span class="type">void</span>)<span class="built_in">cudaLaunchKernel</span>(fun, __gridDim, __blockDim, &amp;__args_arr[__args_idx], __sharedMem, __stream);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        (<span class="type">void</span>)<span class="built_in">cudaLaunchKernel</span>(fun, __gridDim, __blockDim, &amp;__args_arr[<span class="number">0</span>], __sharedMem, __stream);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>é¦–å…ˆå®šä¹‰ä¸€ä¸ªå‚æ•°æŒ‡é’ˆæ•°ç»„ï¼Œç„¶åæŠŠæ¯ä¸€ä¸ªå‚æ•°çš„åœ°å€ä¿å­˜åˆ°è¿™ä¸ªargæ•°ç»„å½“ä¸­ï¼Œç„¶åç”¨__cudaPopCallConfigurationå°†ä¹‹å‰pushçš„4ä¸ªå‚æ•°ä¿å­˜åˆ°gridã€blockã€sharedmemã€streamå››ä¸ªå‚æ•°ä¸­ã€‚å¦‚æœpopæ­£ç¡®å¯ä»¥ç»§ç»­æ‰§è¡Œï¼Œç„¶åè°ƒç”¨cudaLaunchKernelæ­£å¼æ‰§è¡Œè¿™ä¸ªkernelï¼Œè¿™é‡Œçš„å‚æ•°å°±æ˜¯CPUè°ƒç”¨åœ°å€funã€4ä¸ªkernelé…ç½®å‚æ•°å’Œargæ•°ç»„ã€‚</p>
<p>æ‰€ä»¥å¤æ‚çš„kernelå‡½æ•°è°ƒç”¨å¦‚æœæˆ‘ä»¬ä¸å»è€ƒè™‘é‚£ä¸ª<code>&lt;&lt;&lt;&gt;&gt;&gt;</code>çš„è¯­æ³•ç³–çš„è¯ï¼Œç›´æ¥ä½¿ç”¨C++çš„apiæ‰§è¡Œå°±æ˜¯å¦‚ä¸‹çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> *args_arr[<span class="number">3</span>]=&#123;&amp;arg0,&amp;arg1,&amp;arg2,&amp;arg3&#125;;</span><br><span class="line"><span class="built_in">cudaLaunchKernel</span>(gpu_vector_add,gridDim,blockDim,&amp;args_arr[<span class="number">3</span>],sharedMem,stream);</span><br></pre></td></tr></table></figure>
<p>å˜å¾—å¦‚æ­¤ç®€çŸ­ã€‚ç°ä¸ºæˆ‘ä»¬ä¹‹å‰initæ³¨å†Œçš„æ—¶å€™ï¼Œå°†gpu_vector_addå‡½æ•°æŒ‡é’ˆå’Œå­—ç¬¦ä¸²â€__device_stub__Z14gpu_vector_addPiS_S_iâ€ä¸€èµ·ä¼ å…¥äº†__cudaFunctionRegisterï¼Œå› ä¸ºåœ¨nvfatbinä¸­å¯ä»¥ç”¨å­—ç¬¦ä¸²â€__device_stub__Z14gpu_vector_addPiS_S_iâ€æ‰¾åˆ°å¯¹åº”çš„kernelçš„æ®µï¼Œæ‰€ä»¥è¿™äº›æ®µçš„ä¿¡æ¯å¯ä»¥å’Œå‡½æ•°æŒ‡é’ˆgpu_vector_addç»‘å®šï¼Œå› æ­¤è°ƒç”¨cudaKernelLaunchçš„æ—¶å€™å°±å¯ä»¥æ ¹æ®å‡½æ•°æŒ‡é’ˆæ‰¾åˆ°å¯¹åº”çš„.nv.infoï¼Œç„¶åkernelçš„é…ç½®å‚æ•°ä¹Ÿæœ‰äº†ï¼Œå‡½æ•°çš„å‚æ•°ä¹Ÿæœ‰äº†ï¼Œåç»­çš„è¿è¡Œå°±å¯ä»¥é½å…¨äº†ã€‚cudaLaunchKernelä¼šå‘GPUå‘é€éœ€è¦æ‰§è¡Œçš„kernelçš„åœ°å€ã€å‚æ•°ã€é…ç½®ç­‰å‘½ä»¤åŒ…ï¼Œç„¶åGPUå°±ä¼šæŠŠæ˜¾å­˜ä¸­å¯¹åº”çš„kernelè½½å…¥ï¼Œè®¾ç½®çº¿ç¨‹ï¼Œå¼€å§‹è¿è¡Œï¼Œè¿è¡Œå®Œæ¯•åè¿”å›è¿è¡Œç»“æœç­‰ã€‚</p>
<h4 id="streamå’Œgraph"><a href="#streamå’Œgraph" class="headerlink" title="streamå’Œgraph"></a>streamå’Œgraph</h4><p>æˆ‘ä»¬è¿›ä¸€æ­¥è€ƒé‡cudaKernelLaunchæ˜¯å¦‚ä½•å·¥ä½œçš„ï¼Œè¿™éƒ¨åˆ†nvidiaæ²¡æœ‰å¼€æºï¼Œç½‘ä¸Šä¹Ÿæ²¡æœ‰èµ„æ–™ï¼Œæ‰€ä»¥å‚è€ƒçš„æ˜¯AMDçš„æºä»£ç ï¼Œä½†æ˜¯æˆ‘è®¤ä¸ºèƒŒåçš„è‚Œç†å¯èƒ½éå¸¸ç›¸ä¼¼ã€‚é¦–å…ˆå¼•å…¥ä¸¤ä¸ªæ¦‚å¿µstreamå’Œgraphã€‚æ¯ä¸ªprocesså¯ä»¥æœ‰å¤šä¸ªstreamï¼Œåœ¨è¿è¡Œkernelçš„æ—¶å€™å¯ä»¥æŒ‡å®šæ‰§è¡Œè¿™ä¸ªkernelçš„streamï¼Œç„¶åè¿™ä¸ªkernelå°±ä¼šåˆ°å¯¹åº”streamå½“ä¸­å»æ’é˜Ÿç­‰å¾…æ‰§è¡Œã€‚streamç¡®ä¿åŒä¸€ä¸ªstreamä¸­çš„æµé¡ºåºæ‰§è¡Œï¼Œå¦‚æœç”¨æˆ·è®¤ä¸ºè‡ªå·±çš„ä¸¤ä¸ªkernelæ²¡æœ‰æ•°æ®ä¾èµ–ï¼Œå¯ä»¥åŒæ—¶æ‰§è¡Œï¼Œé‚£ä¹ˆå¯ä»¥ç”¨ä¸¤ä¸ªstreamåˆ†åˆ«æ‰§è¡Œä¸¤ä¸ªkernelï¼Œå°±å¯èƒ½ä¼šè¢«GPU driveråŒæ—¶æ‰§è¡Œã€‚è€ŒåŒä¸€ä¸ªstreamçš„kernelé™¤éæ˜¾ç¤ºå£°æ˜ï¼Œä¸ç„¶æ˜¯ä¾æ¬¡æ‰§è¡Œçš„ï¼Œæ‰€ä»¥å¯¹äºæœ‰æ•°æ®ä¾èµ–çš„ç¨‹åºï¼Œæ¯”å¦‚A kernelçš„è¾“å‡ºæ˜¯B kernelå¾—è¾“å…¥ï¼Œé‚£ä¸å¦‚ä¸€ä¸ªstreamæ‰§è¡Œã€‚ä¸€èˆ¬è°ƒç”¨kernelçš„æ—¶å€™å¦‚æœä¸æŒ‡å®šstreamï¼Œé‚£å°±æ˜¯ç”¨é»˜è®¤çš„0å·streamæ‰§è¡Œã€‚</p>
<p>å¯¹äºåŒä¸€ä¸ªstreamä¸­çš„kernelä¹Ÿæ˜¯å¯ä»¥æ˜¾å¼å£°æ˜å¹¶è¡Œçš„ï¼Œæ¯”å¦‚åœ¨kenerl1ä¸­æ’å…¥<code>cudaTriggerProgrammaticLaunchCompletion();</code>é‚£ä¹ˆå½“æ‰€æœ‰çš„kernel1æ‰§è¡Œå®Œè¿™ä¸ªå‡½æ•°ä¹‹åï¼Œç¬¬äºŒä¸ªkernel2å°±ä¼šå¼€å§‹è¿è¡Œï¼Œè¿™æ ·å¦‚æœkernel1çš„å‰åŠéƒ¨åˆ†å’Œkernel2æœ‰ä¾èµ–ï¼Œå°±å¯ä»¥ç”¨è¯¥å‡½æ•°æ¥è®©kernel1çš„ååŠéƒ¨åˆ†å’Œkernel2å¹¶è¡Œã€‚æ­¤å¤–å¦‚æœkernel2çš„ååŠéƒ¨åˆ†ä¼šå’Œkernel1å‘ç”Ÿå†²çªï¼Œé‚£ä¹ˆå¯ä»¥åœ¨kernel2ä¸­æ’å…¥<code>cudaGridDependencySynchronize();</code>è¿™æ ·çš„è¯ï¼Œkernel2çš„æ‰€æœ‰çº¿ç¨‹è¿è¡Œåˆ°è¿™ä¸ªå‡½æ•°å°±ä¼šåœé¡¿ç›´åˆ°kernel1è¿è¡Œå®Œæ¯•ä¸ºæ­¢ã€‚æ‰€ä»¥å¯¹äºä¸‹é¢çš„kernelï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="function">__global__ <span class="title">kernel1</span><span class="params">()</span></span>&#123;</span><br><span class="line">    partA;</span><br><span class="line">    <span class="built_in">cudaTriggerProgrammaticLaunchCompletion</span>();</span><br><span class="line">    partB;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function">__global__ <span class="title">kernel2</span><span class="params">()</span></span>&#123;</span><br><span class="line">    partC;</span><br><span class="line">    <span class="built_in">cudaGridDependencySynchronize</span>();</span><br><span class="line">    partD;</span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="type">int</span> <span class="title">main</span><span class="params">()</span></span>&#123;</span><br><span class="line">    kernel1&lt;&lt;&lt;grid,block,<span class="number">0</span>,stream&gt;&gt;&gt;();</span><br><span class="line">    kernel2&lt;&lt;&lt;grid,block,<span class="number">0</span>,stream&gt;&gt;&gt;();</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¿™æ ·çš„è¯partAå…ˆæ‰§è¡Œï¼Œç„¶åè§¦å‘<code>cudaTriggerProgrammaticLaunchCompletion</code>ï¼ŒpartBå’ŒpartCå¼€å§‹æ‰§è¡Œï¼Œç„¶åè§¦å‘<code>cudaGridDependencySynchronize</code>ï¼Œåœ¨partBå’ŒpartCéƒ½æ‰§è¡Œå®Œä¹‹åpartDå¼€å§‹æ‰§è¡Œã€‚</p>
<p>ä¸è¿‡å°½ç®¡å¦‚æ­¤ï¼Œè¿™ç§å¹¶è¡Œè¯­æ³•è¿˜æ˜¯å¾ˆå¼±çš„ï¼Œå®ƒåªèƒ½ä½¿ç¬¬ä¸€ä¸ªå’Œç¬¬äºŒä¸ªé¡ºåºçš„kernelæŒ‡å®šå¯ä»¥é‡å è¿è¡Œçš„æœ‰ä¸”ä»…æœ‰ä¸€ä¸ªéƒ¨åˆ†ï¼Œå¦‚æœæœ‰å¤šä¸ªå­éƒ¨åˆ†å¯ä»¥é‡å è¿è¡Œï¼Œé‚£ä¹ˆå°±ä¼šå¾ˆå›°éš¾ï¼Œå¿…é¡»è¦æŠŠå¤§kernelæ‹†æˆä¸€å¯¹å°çš„ï¼Œæˆ–è€…ä¾é æ¯”å¦‚global memoryåšåŒæ­¥ä¹‹ç±»çš„æ“ä½œï¼Œåæ­£å¾ˆä¸æ–¹ä¾¿ã€‚å½“ç„¶ä»‹äºè¿™ç§æƒ…å†µåœ¨æµå¤„ç†ä»»åŠ¡ä¸­ä¸å¤šè§ï¼Œæ‰€ä»¥ä¸éœ€è¦å°†å¤ªå¤šç²¾åŠ›æ”¾åœ¨è¿™ä¸Šé¢ã€‚</p>
<p>å¯¹äºå¤æ‚çš„ä¾èµ–æ€§ä»»åŠ¡ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨graphçš„å½¢å¼è¡¨ç¤ºã€‚å¯¹äºæ¯ä¸€ä¸ªkernelä»»åŠ¡æˆ–è€…å†…å­˜memcpyä»»åŠ¡ï¼Œæˆ‘ä»¬ä¸ºä»–ä»¬æ„é€ å¯¹åº”çš„graphnodeï¼Œä¼ å…¥å¯¹åº”çš„å‚æ•°ï¼Œç„¶åå°†æœ‰ä¾èµ–çš„ä»»åŠ¡ç»˜åˆ¶ä¸€ä¸‹æœ‰å‘è¾¹ï¼Œç„¶åæˆ‘ä»¬è®©streamå»æ‰§è¡Œè¿™ä¸ªgraphï¼Œstreamå°±ä¼šæ ¹æ®æ‹“æ‰‘æ’åºçš„é¡ºåºæ‰§è¡Œè¿™ä¸ªgraphï¼Œè®©æ²¡æœ‰ä»¥æ¥çš„ä»»åŠ¡è¢«å……åˆ†å¹¶è¡Œèµ·æ¥ã€‚ç›¸å¯¹äºstreamç®€å•çš„ä¸²è¡Œæˆ–è€…å‰åä¸¤ä¸ªkenrelé‡å ï¼Œè¿™ç§graphç»“æ„è¡¨è¾¾èƒ½åŠ›æ›´å¼ºï¼Œç†è§£èµ·æ¥ä¹Ÿå¾ˆç›´è§‚ã€‚</p>
<p>å¥½äº†æˆ‘ä»¬å›è¿‡å¤´æ¥ç»§ç»­èŠcudaLaunchKernelä¹‹åå‘ç”Ÿäº†ä»€ä¹ˆã€‚è¿™é‡Œæˆ‘ä»¬å‚è€ƒçš„æ˜¯hipLaucnhKernelçš„ä»£ç ï¼Œè¯¥å‡½æ•°ä¼šè°ƒç”¨capturehipLaunchKernelå‡½æ•°ï¼Œè¿™ä¸ªå‡½æ•°ä¼šæ£€æŸ¥å‚æ•°æ˜¯å¦æ­£ç¡®ï¼Œç„¶åç»™è‡ªå·±çš„streamåŠ ä¸€ä¸ªé”ï¼Œç„¶åæ„é€ ä¸€ä¸ªgraphnodeï¼Œå°†å‡½æ•°åã€é…ç½®å‚æ•°ã€è¾“å…¥å‚æ•°å­˜å‚¨åˆ°graphnodeå½“ä¸­ã€‚æ‰€ä»¥å¯¹äºä¸€ä¸ªstreamè€Œè¨€ï¼Œå®ƒè¿è¡Œçš„æ‰€æœ‰kernelæœ€åéƒ½ä¼šå˜ä¸ºä¸€ä¸ªgraphnodeï¼Œç„¶åå¯¹äºå‰é¢è¿è¡Œçš„kernelçš„æ¯ä¸€ä¸ªgraphnodeéƒ½å’Œæ–°çš„graphnodeåŠ ä¸€æ¡ä¾èµ–è¾¹ï¼Œè¿™æ ·å½¢æˆæ–°çš„graphï¼Œé™¤éå‰é¢çš„kerneléƒ½æ‰§è¡Œå®Œæ¯•ï¼Œä¸ç„¶åé¢çš„kernelä¸ä¼šæ‰§è¡Œã€‚æ‰€ä»¥streamçš„åº•å±‚è¿˜æ˜¯ä¸€å¼ graphï¼Œæ„é€ å›¾å®Œæ¯•åå»æ‰ä¹‹å‰çš„é”ã€‚ç„¶åå‡½æ•°è¿”å›ã€‚</p>
<p>kernelåœ¨GPUçš„æ‰§è¡Œå’ŒCPUæ˜¯å¼‚æ­¥çš„ï¼Œæ¯ä¸€æ¬¡kernelè°ƒç”¨CPUåªæ˜¯æŠŠæ–°çš„graphnodeåŠ å…¥streamçš„nodeå½“ä¸­ï¼Œæ‰€ä»¥å¦å¤–å­˜åœ¨ä¸€ä¸ªçº¿ç¨‹ä¼šåœ¨GPUå¯ä»¥æ¥å—æ–°çš„kernelçš„æ—¶å€™ä»graphä¸­æ‹¿å‡ºä¸€ä¸ªæ–°çš„èŠ‚ç‚¹ï¼Œç„¶åäº¤ç»™GPUæ‰§è¡Œï¼Œè¿™ä¹Ÿå°±æ˜¯ä¸ºä»€ä¹ˆä¹‹å‰çŒœæµ‹ä¼šæ„é€ æ–°çš„çº¿ç¨‹çš„åŸå› äº†ï¼Œä½†æ˜¯è°ƒè¯•æŒ‡å‡ºï¼Œè¿™é‡Œçš„çº¿ç¨‹ä¸æ­¢ä¸€ä¸ªï¼Œæœ‰6-8ä¸ªï¼Œå¯èƒ½å„è‡ªæœ‰å„è‡ªçš„ç”¨å¤„ã€‚</p>
<p>å› æ­¤kernelçš„æ‰§è¡Œå’ŒCPUçš„æ‰§è¡Œæ˜¯å¼‚æ­¥çš„ï¼Œæ‰€ä»¥å½“kernelè¿˜æ²¡è¿è¡Œå®Œçš„æ—¶å€™è®¿é—®GPUå…³è”çš„å†…å­˜å…¶å®æ˜¯ä¸å®‰å…¨çš„ã€‚æœ‰ä»¥ä¸‹å‡ ç§æƒ…å†µï¼Œæ¯”å¦‚æˆ‘ç”¨cudaMemcpyæ‹·è´kernelæ­£åœ¨ä½¿ç”¨çš„GPUå†…å­˜ï¼Œè¿™æ˜¯å®‰å…¨çš„ï¼Œå› ä¸ºcudaMemcpyä¼šè‡ªåŠ¨ç­‰å…³è”çš„kernelç»“æŸå·¥ä½œæ‰å¼€å§‹ä¼ è¾“ï¼›å¦‚æœGPUå…³è”çš„æ˜¯cudaMallocHostçš„CPUçš„å†…å­˜ï¼Œé‚£ä¹ˆè¿™ä¸ªæ—¶å€™å¦‚æœkernelæ²¡æœ‰è¿è¡Œç»“æŸä¼šå‘ç”Ÿæ®µé”™è¯¯ï¼Œæ‰€ä»¥éœ€è¦åœ¨è®¿é—®ä»¥å‰æ‰§è¡Œä¸€æ¡æ¯”å¦‚cudaDeviceSynchroneçš„åŒæ­¥æŒ‡ä»¤ï¼Œç­‰å¾…kernelè¿è¡Œå®Œæ¯•æ‰å¯ä»¥ã€‚</p>
<p>è‡³æ­¤è½¯ä»¶éƒ¨åˆ†å‘Šä¸€æ®µè½äº†ã€‚</p>
<h2 id="GPUçš„ç¡¬ä»¶æ‰§è¡Œ"><a href="#GPUçš„ç¡¬ä»¶æ‰§è¡Œ" class="headerlink" title="GPUçš„ç¡¬ä»¶æ‰§è¡Œ"></a>GPUçš„ç¡¬ä»¶æ‰§è¡Œ</h2><p>GPUæ˜¯ä¸€ä¸ªpcieè®¾å¤‡ï¼Œsocç”¨MMIOçš„æ–¹å¼æ˜ å°„GPUçš„å†…å­˜ç©ºé—´ã€‚socå¯¹äºGPUçš„å†…å­˜ç©ºé—´æ˜ å°„åˆ†ä¸ºä¸¤å—ï¼Œç¬¬ä¸€å—æ˜¯GPUçš„å¯„å­˜å™¨ç»„ï¼Œç¬¬äºŒå—æ˜¯GPUçš„æ˜¾å­˜ï¼Œå¯ä»¥çœ‹åˆ°å‰è€…ä¸»è¦è´Ÿè´£æ§åˆ¶ä¿¡å·çš„ä¼ é€’ï¼Œåè€…ä¸»è¦è´Ÿè´£æ•°æ®çš„ä¼ é€’ã€‚æ­¤å¤–GPUä¸Šæ˜¯æœ‰ä¸€ä¸ªå°å‹çš„æ“ä½œç³»ç»Ÿåœ¨è¿è¡Œçš„ï¼Œç±»ä¼¼äºCPUçš„æ“ä½œç³»ç»Ÿé‚£ç§ï¼Œå¯ä»¥å¤„ç†ä¸€äº›è°ƒåº¦ã€é€šä¿¡ã€å†…å­˜ç®¡ç†ä¹‹ç±»çš„ä¸œè¥¿ï¼Œæ¯•ç«Ÿé GPUçš„æµå¤„ç†å™¨åšè¿™äº›äº‹æ•ˆç‡å¾ˆä½ï¼Œè€Œä¸”æ— æ³•å¹¶è¡Œï¼Œä¸è¿‡nvidiaçš„å®˜æ–¹æ–‡æ¡£æ²¡æœ‰è¯´ä»–å«ä»€ä¹ˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸å¦¨æš‚æ—¶ç§°ä»–ä¸ºGPUoså§ã€‚èµ„æ–™å¾ˆä¸å…¨é¢ï¼Œæˆ‘å°½é‡çŒœæµ‹å¯¹åº”çš„ç»†èŠ‚ï¼Œå…¶ä»–è·¨åº¦è¾ƒå¤§çš„é˜¶æ®µåªèƒ½å‹‰å¼ºçœ‹çœ‹äº†ï¼›æ­¤å¤–åœ¨è¿™é‡Œæˆ‘å¹¶ä¸ä¼šäº‹å…ˆä»‹ç»æ‰€æœ‰çš„ç¡¬ä»¶ï¼Œæˆ‘åªåœ¨å¿…é¡»ä»‹ç»ä»–ä»¬çš„æ—¶å€™å¼•å…¥ï¼Œä»¥å…åœ¨ä¸€å¼€å§‹å°±è€ƒè™‘è¿‡å¤šçš„å¯ä»¥è¢«è®¤ä¸ºæ˜¯é€æ˜çš„ç¡¬ä»¶ç»†èŠ‚ã€‚</p>
<h3 id="contextåˆ›å»ºå’Œtaskè¿è¡Œ"><a href="#contextåˆ›å»ºå’Œtaskè¿è¡Œ" class="headerlink" title="contextåˆ›å»ºå’Œtaskè¿è¡Œ"></a>contextåˆ›å»ºå’Œtaskè¿è¡Œ</h3><p>æ¯å½“æœ‰ä¸€ä¸ªCPU processåœ¨GPUä¸Šå·¥ä½œçš„æ—¶å€™ï¼ŒGPU oså°±ä¼šäº§ç”Ÿå¯¹åº”çš„ä¸€ä¸ªcontextä¸ä¹‹ç›¸å¯¹åº”ï¼Œç”¨æ¥ç®¡ç†CPU processåœ¨GPUä¸Šçš„ä»»åŠ¡ï¼Œè¿™ä¸ªcontextä¹ŸåŒ…å«äº†è‡ªå·±çš„é¡µè¡¨ï¼Œç”¨æ¥ç®¡ç†è‡ªå·±çš„è™šæ‹Ÿåœ°å€ç©ºé—´ã€‚æ¯ä¸€ä¸ªGPU contextéƒ½æœ‰è‡ªå·±å¯¹åº”çš„é¡µè¡¨å’Œè™šæ‹Ÿåœ°å€ç©ºé—´ï¼Œç›¸äº’ä¹‹é—´éš”ç¦»å¼€æ¥ã€‚æ­¤å¤–GPU osä¹Ÿç»™æ¯ä¸€ä¸ªcontextçš„taskæä¾›äº†æ—¶é—´ç‰‡ï¼Œè¿™æ ·å¤šä¸ªcontextçš„taskåŒæ—¶è¿è¡Œçš„æ—¶å€™å°±å¯ä»¥æ ¹æ®æ—¶é—´ç‰‡è¿›è¡Œä»»åŠ¡çš„åˆ‡æ¢ï¼Œè¿›è€Œè¿›è¡ŒGPUçš„multi-taskã€‚contextçš„TCBå’Œpage tableæœ‰å¯èƒ½æ˜¯ç›´æ¥åˆ†é…åœ¨global memoryä¸Šçš„ï¼Œå½“CPUç”¨å„ç§å‡½æ•°å‘GPUè¯·æ±‚å†…å­˜å’Œæ³¨å†Œå†…å­˜çš„æ—¶å€™ï¼Œé¡µè¡¨éƒ½è¦è¿›è¡Œå¯¹åº”çš„ä¿®æ”¹ï¼Œæœ‰çš„é¡µè¡¨æ˜ å°„åˆ°GPUçš„ç‰©ç†å†…å­˜ä¸Šï¼Œæœ‰çš„æ˜ å°„åˆ°CPUçš„ç‰©ç†å†…å­˜ä¸Šï¼›GPUçš„æ“ä½œç³»ç»Ÿæœ‰è‡ªå·±çš„è¿›ç¨‹è°ƒåº¦æœºåˆ¶ã€è‡ªå·±çš„å†…å­˜ç®¡ç†æœºåˆ¶ã€è‡ªå·±çš„ç¼ºé¡µå¼‚å¸¸å¤„ç†æœºåˆ¶ç­‰ä¸€äº›åˆ—å’ŒCPUå¯¹æ ‡çš„ä»»åŠ¡ï¼Œè¿™äº›ä»»åŠ¡å¾ˆå¤šæ—¶å€™æ˜¯ä¸éœ€è¦GPUé«˜å¹¶è¡Œåº¦æµå¼å¤„ç†çš„ç‰¹æ€§çš„ï¼Œæ‰€ä»¥ç”¨ç®€å•çš„ç±»ä¼¼CPUçš„å¤„ç†å™¨å°±å¯ä»¥äº†ï¼ŒGPUæ¯ä¸ªtaskçš„threadæœ‰å‡ ä¸‡ä¸ªç”šè‡³å‡ åä¸‡ä¸ªï¼Œä½†æ˜¯GPUçš„taskæ˜¯æ¯”è¾ƒå°‘çš„ï¼Œè°ƒåº¦å‹åŠ›è¿œå°äºHostçš„CPUã€‚</p>
<p>å½“CPUçš„ä¸€ä¸ªcudaç¨‹åºå¼€å§‹æ‰§è¡Œçš„æ—¶å€™ï¼Œä»–é¦–å…ˆå‘GPUå‘é€ä¸€ä¸ªæ•°æ®åŒ…ï¼Œæ˜¯GPUæ‰€æœ‰çš„nv_fatbinæ•°æ®ï¼Œè¿™äº›æ•°æ®å¯èƒ½åŒ…å«äº†å¾ˆå¤šçš„kernelï¼Œå¹¶ä¸ºè¿™äº›kernelå‡†å¤‡åˆé€‚çš„é¡µè¡¨ã€‚å¦‚æœç”¨cuda APIåˆ†é…å†…å­˜ã€æ³¨å†Œå†…å­˜ã€é‡Šæ”¾å†…å­˜ï¼Œå°±å¡«å†™å¯¹åº”çš„é¡µè¡¨è¿›è¡Œé…ç½®ã€‚ç„¶åä¹‹åCPUè°ƒç”¨æŸä¸€ä¸ªkernelçš„æ—¶å€™ï¼Œå†å‘é€ä¸€ä¸ªå‘½ä»¤åŒ…ï¼ŒåŒ…å«è¦æ‰§è¡Œçš„kernelçš„åœ°å€ã€å‚æ•°ç­‰ä¿¡æ¯ï¼Œç„¶åGPUæ‰ä»nvfatbinä¸­launchè¿™ä¸ªkernelï¼Œå°†textè½½å…¥å¯¹åº”çš„åœ°å€ã€constantè½½å…¥å¯¹åº”çš„constant memoryã€é…ç½®å¥½å¯¹åº”çš„é¡µè¡¨ï¼Œç„¶ååˆå§‹åŒ–å¿…è¦çš„blockå’Œthreadï¼Œç„¶åå¼€å§‹å°†blockè°ƒåº¦åˆ°å¯¹åº”çš„SMä¸Šå»ã€‚è¿™éƒ¨åˆ†æœ‰ç–‘é—®å¯ä»¥å‚çœ‹å‰é¢SIMTç« èŠ‚ã€‚</p>
<p>å¦‚æœè¿™äº›å€¼éƒ½æ˜¯ä¾æ¬¡åˆå§‹åŒ–çš„é‚£ä¹ˆå…¶å®å¯¹äºæ¯”è¾ƒå°çš„ä»»åŠ¡ï¼Œåˆå§‹åŒ–çš„ä»£ä»·å°±ä¼šéå¸¸å·¨å¤§ï¼Œæ¯”å¦‚å‘é‡åŠ æ³•ï¼Œå®ƒçš„ä»£ä»·ç”šè‡³æ¯”åˆå§‹åŒ–å†™å…­ä¸ªå¯„å­˜å™¨è¿˜è¦å°ï¼Œé‚£ä¹ˆå°±ä¸å€¼å¾—äº†ï¼Œæ‰€ä»¥tidåº”è¯¥æœ‰æ–¹æ³•æ¯”è¾ƒå¿«é€Ÿçš„æ‰¹åˆå§‹åŒ–æ‰å¯¹ã€‚ä½†æ˜¯blockå¯ä»¥æ¯”è¾ƒæ˜ç¡®çš„è‚¯å®šä»–å°±æ˜¯çº¿æ€§åˆå§‹åŒ–å’Œçº¿æ€§è°ƒåº¦çš„ï¼Œä¸è¿‡ä¾æ¬¡ä¹‹é—´çš„é—´éš”åªæœ‰åå‡ ä¸ªåˆ°å‡ åä¸ªæ—¶é’Ÿå‘¨æœŸçš„å·®è·ï¼Œè¿™ä¸ªå·®è·å¹¶ä¸å¤§ã€‚æ‰€ä»¥tidè‚¯å®šæ˜¯å¿«é€Ÿåˆå§‹åŒ–çš„ï¼Œä¸å¯èƒ½çº¿æ€§è¿›è¡Œï¼Œä¸ç„¶æ— æ³•å†10ä¸ªå‘¨æœŸå†…å®Œæˆã€‚å¯èƒ½çš„æ–¹æ³•æ˜¯ä¸€å¼€å§‹å°±æŠŠä¸€ä¸ªblockçš„æ‰€æœ‰tidéƒ½äº§ç”Ÿå¥½ï¼Œç„¶åå¤§å®¶æ‰¹é‡å¤ç”¨ä¸€ä¸‹ã€‚</p>
<h3 id="blockçš„è°ƒåº¦"><a href="#blockçš„è°ƒåº¦" class="headerlink" title="blockçš„è°ƒåº¦"></a>blockçš„è°ƒåº¦</h3><p>blockå’Œthreadçš„åˆå§‹åŒ–å’Œblockçš„åˆ†é…è°ƒåº¦ç”±ç¡¬ä»¶gigaThread engineæ‰§è¡Œã€‚æ¯ä¸ªblockå’Œthreadçš„åˆå§‹åŒ–ä¸»è¦éœ€è¦åˆå§‹åŒ–çš„æœ‰PCå’Œtidã€ctaidå¯„å­˜å™¨ï¼Œå…¶ä¸­PCå¤§å®¶éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯tidå’Œctaidæ˜¯å„ä¸ç›¸åŒçš„ï¼Œéœ€è¦ä¾æ¬¡åˆå§‹åŒ–ä¸ºä¸ä¸€æ ·çš„å€¼ã€‚</p>
<h4 id="blcokçš„åˆå§‹åŒ–å’Œåˆ†é…"><a href="#blcokçš„åˆå§‹åŒ–å’Œåˆ†é…" class="headerlink" title="blcokçš„åˆå§‹åŒ–å’Œåˆ†é…"></a>blcokçš„åˆå§‹åŒ–å’Œåˆ†é…</h4><p>blockçš„åˆå§‹åŒ–å’Œåˆ†é…æ˜¯çº¿æ€§è¿›è¡Œçš„ï¼Œè¿™é‡Œå‚è€ƒçš„æ˜¯<a href="https://www.cs.rochester.edu/~sree/fermi-tbs/fermi-tbs.html#sec-7-1">è¯¥æ–‡ç« </a>å¾—åˆ°çš„ç»“è®ºã€‚blockè¢«ä¾æ¬¡åˆå§‹åŒ–å¯¹åº”çš„ctaidå’Œå…¶ä»–å†…å®¹ï¼Œç„¶åä¾æ¬¡è½®è¯¢æ¯ä¸€ä¸ªSMçœ‹æ˜¯å¦å¯ä»¥æ”¾å…¥è¿™ä¸ªblockï¼Œå¦‚æœå¯ä»¥çš„è¯å°±å°†è¯¥blockæ”¾å…¥è¯¥SMå½“ä¸­ï¼Œæ¯ä¸ªblockçš„åˆå§‹åŒ–åˆ°è°ƒåº¦å¤§çº¦éœ€è¦10-20ä¸ªSMå‘¨æœŸçš„æ—¶é—´ï¼Œå½“ç„¶å¦‚æœè®©åˆå§‹åŒ–å’Œåˆ†é…æˆä¸ºå¤šä¸ªæµæ°´çº§ï¼Œè¿™ä¸ªæ—¶é—´å¯ä»¥æ›´ä¹…ã€‚å¯¹äºä¸€ç»´çš„gridï¼Œblockæ˜¯æ ¹æ®blockIdx.xä¾æ¬¡ä»å°åˆ°å¤§è°ƒåº¦çš„ï¼Œè€Œå¯¹äºäºŒç»´çš„gridï¼Œblockåˆ™æ˜¯æ ¹æ®ä¸€ç§è›‡å½¢çš„èµ°ä½æ–¹å¼è¿›è¡Œè°ƒåº¦çš„ï¼Œå¦‚ä¸‹å›¾ã€‚æ­£æ˜¯<a href="https://www.cs.rochester.edu/~sree/fermi-tbs/fermi-tbs.html#sec-7-1">å‚è€ƒæ–‡çŒ®</a>ä¸­SMåˆ†é…çš„è½®è¯¢å’ŒäºŒç»´gridä¸­çš„ç‰¹æ®Šéå†æ–¹å¼æš—ç¤ºäº†blockåˆ†é…çš„çº¿æ€§è¿›è¡Œã€‚<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/5x5x2-pattern.png" alt="äºŒç»´blockçŸ©é˜µçš„åˆ†é…é¡ºåº"></p>
<h4 id="threadçš„åˆå§‹åŒ–"><a href="#threadçš„åˆå§‹åŒ–" class="headerlink" title="threadçš„åˆå§‹åŒ–"></a>threadçš„åˆå§‹åŒ–</h4><p>threadçš„åˆå§‹åŒ–å’Œåˆ†é…ä¸å¯ä»¥æ˜¯çº¿æ€§çš„ï¼Œå®ƒå¿…é¡»æ˜¯å¸¸æ•°æ—¶é—´å†…å®Œæˆã€‚å¦‚æœNä¸ªthreadéœ€è¦O(N)çš„æ—¶é—´æ‰å¯ä»¥å®Œæˆï¼Œé‚£ä¹ˆå¯¹äºç®€å•çš„å‘é‡åŠ æ³•CPUä¹Ÿåªéœ€è¦O(N)çš„æ—¶é—´å°±å®Œæˆï¼Œåšä¸€æ¬¡åŠ æ³•ä¹Ÿè®¸ä¸æ¯”ç®€å•çš„tidèµ‹å€¼æ¥çš„æ…¢ï¼Œé‚£ä¹ˆGPUä¸èƒ½å¾—åˆ°åŠ é€Ÿï¼Œä½•å†µblockçš„è°ƒåº¦åªéœ€è¦10-20ä¸ªå‘¨æœŸï¼Œè¿™ä¸å¯èƒ½å®Œæˆ512ä¸ªthreadçš„çº¿æ€§åˆå§‹åŒ–ï¼Œé‚£ä¹ˆé™¤é50ä¸ªthreadä¸€ä¸ªå‘¨æœŸã€‚æ¯”è¾ƒå¯èƒ½çš„å®ç°æ˜¯ä¸€å¼€å§‹å°±ä¸ºæ‰€æœ‰çš„threadéƒ½æä¾›å¥½å¯¹åº”çš„tidåˆå§‹åŒ–ç»“æ„ï¼Œåæ­£æ¯ä¸ªblockè¦åˆå§‹åŒ–çš„æ‰€æœ‰tidçš„ç»“æ„æ˜¯ä¸€æ ·çš„ï¼Œç„¶åæ¯æ¬¡ç›´æ¥ç”¨è¿™ä¸ªç»“æ„æ‰¹é‡åˆå§‹åŒ–æ‰€æœ‰çš„threadå³å¯ã€‚</p>
<h4 id="blockçš„SMå…±äº«"><a href="#blockçš„SMå…±äº«" class="headerlink" title="blockçš„SMå…±äº«"></a>blockçš„SMå…±äº«</h4><p>å¯¹äºä¸€ä¸ªblockï¼Œå®ƒéœ€è¦çš„èµ„æºæ•°é‡å¿…é¡»ä¿è¯å®ƒå¯ä»¥è¢«ä¸€ä¸ªSMæ¥å—ã€‚æ¯”å¦‚ä¸€ä¸ªSMæœ€å¤šåªèƒ½è¿è¡Œ1024ä¸ªthreadï¼Œä½†æ˜¯blockå®šä¹‰äº†2048ä¸ªthreadï¼Œé‚£ä¹ˆåœ¨ç¼–è¯‘é˜¶æ®µå°±ä¼šæŠ¥é”™ï¼›ä¸€ä¸ªSMæœ€å¤šåªèƒ½æä¾›æ¯”å¦‚65536ä¸ªå¯„å­˜å™¨ï¼Œä½†æ˜¯blockçš„1024ä¸ªthreadåˆ†åˆ«éœ€è¦ä½¿ç”¨1024ä¸ªï¼Œé‚£ä¹ˆä¹Ÿä¼šæŠ¥é”™ï¼›ä¸€ä¸ªSMæœ€å¤šæä¾›æ¯”å¦‚48KBçš„shared memoryï¼Œä½†æ˜¯ä¸€ä¸ªblockéœ€è¦64KBä¹Ÿä¼šæŠ¥é”™ã€‚æ€»ä¹‹ç¼–è¯‘æœŸé—´ä¸€å®šä¼šæ£€æŸ¥ä½ çš„blockæ˜¯ä¸æ˜¯æ»¡è¶³èµ„æºï¼Œå¦‚æœä¸æ»¡è¶³å°±ä¼šæŠ¥é”™ã€‚å³ä½¿ç¼–è¯‘æœŸé—´æ²¡æœ‰æŠ¥é”™ï¼Œæ‰§è¡Œçš„æ—¶å€™å‡½æ•°ä¹Ÿä¼šæ£€æŸ¥å‚æ•°å¯¹åº”çš„èµ„æºéœ€æ±‚æ˜¯ä¸æ˜¯å¤ªå¤§äº†ï¼Œå¦‚æœæ˜¯çš„è¯kernelå°±ä¸ä¼šè¢«launchæ‰§è¡Œã€‚æ‰€ä»¥æ”¾å¿ƒå§ï¼Œä¸€ä¸ªSMå®Œå…¨å¯ä»¥ç»™ä¸€ä¸ªblockæä¾›å……è¶³çš„èµ„æºï¼Œä¸€ä¸ªblockå®Œå…¨å¯ä»¥åœ¨ä¸€ä¸ªSMä¸Šè¢«æ‰§è¡Œï¼Œä¸å­˜åœ¨ä¸€ä¸ªblockéœ€è¦å¤šä¸ªSMæ‰å¯ä»¥è¿è¡Œçš„æƒ…å†µã€‚å¦‚æœä¸€ä¸ªSMçš„èµ„æºå¯ä»¥æ”¾ä¸‹å¤šä¸ªblockï¼Œå¯èƒ½æ˜¯ä¸åŒgridçš„blockï¼Œä¹Ÿå¯èƒ½æ˜¯åŒä¸€ä¸ªï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥å…±äº«è¿™ä¸ªSMè¿è¡Œã€‚å¯¹äºæ›´é«˜çº§çš„nvidiaçš„GPUï¼Œå¦‚æœä¸€ä¸ªblockçš„éƒ¨åˆ†wrapå…ˆè¿è¡Œå®Œæ¯•ï¼Œè¿™äº›wrapå¯ä»¥å…ˆè¡Œé‡Šæ”¾èµ„æºï¼Œé‚£ä¹ˆå¯ä»¥ä¸€ä¸ªSMåªè¿è¡Œ0.xä¸ªblockï¼Œå…¶ä»–blockä½¿ç”¨é‡Šæ”¾çš„èµ„æºä¹Ÿæ˜¯å¯ä»¥çš„ã€‚</p>
<h4 id="blockçš„åˆ‡æ¢"><a href="#blockçš„åˆ‡æ¢" class="headerlink" title="blockçš„åˆ‡æ¢"></a>blockçš„åˆ‡æ¢</h4><p>blocké™¤äº†å¯ä»¥åˆ†é…SMã€å…±ç”¨SMã€é‡Šæ”¾SMè¿˜å¯ä»¥åœ¨SMä¸Šåˆ‡æ¢ã€‚å› ä¸ºä¸Šé¢æŒ‡å‡ºcontextçš„taskæ˜¯æœ‰æ—¶é—´ç‰‡çš„ï¼Œå¯ä»¥å¤šä»»åŠ¡ï¼Œæ‰€ä»¥å¦‚æœä¸€äº›taskå¤ªé•¿äº†ä¼šåˆ‡æ¢å‡ºæ¥ï¼Œäº¤ç»™ä¸‹ä¸€ä¸ªtaskã€‚è¿™ä¸ªåˆ‡æ¢çš„ä»£ä»·æ˜¯å·¨å¤§çš„ï¼Œæ¯ä¸ªSMçš„registerã€shared memoryéƒ½éœ€è¦è¢«ä¿å­˜èµ·æ¥ï¼Œæ¯ä¸ªblockéƒ½éœ€è¦è‡ªå·±çš„åˆ‡æ¢ç©ºé—´ï¼Œè€Œä¸”æ–°å¯åŠ¨çš„æ—¶å€™éœ€è¦è½½å…¥åŸæ¥çš„å†…å®¹ã€‚ä½†æ˜¯å®éªŒè¡¨æ˜è¿™å°±æ˜¯ä¼šå‘ç”Ÿçš„ï¼Œç”šè‡³åŒä¸€ä¸ªtaskçš„blockä¹Ÿä¼šå‘ç”Ÿä¸€ä¸ªSMçš„åˆ‡æ¢ã€‚å¦‚æœæ˜¯å¤šä¸ªblockåœ¨ä¸€ä¸ªSMä¸Šè¿è¡Œçš„åˆ‡æ¢ï¼Œé—´éš”ä»…ä»…ä½¿å¦ä¸€ä¸ªå¯ä»¥è¿ç»­è¿è¡Œçš„æ—¶é—´ï¼Œä½†æ˜¯å¦‚æœæ˜¯blockç›´æ¥åˆ‡æ¢çš„è¯ï¼Œä»£ä»·å°±ä¼šæ¯”è¾ƒå¤§äº†ã€‚</p>
<h3 id="wrapçš„æ‰§è¡Œå’Œè°ƒåº¦"><a href="#wrapçš„æ‰§è¡Œå’Œè°ƒåº¦" class="headerlink" title="wrapçš„æ‰§è¡Œå’Œè°ƒåº¦"></a>wrapçš„æ‰§è¡Œå’Œè°ƒåº¦</h3><p>ç°åœ¨æˆ‘ä»¬çš„ä¸€ä¸ªblockï¼Œæ¯”å¦‚è¯´ä»–æ˜¯1024ä¸ªthreadè¢«è°ƒåº¦åˆ°äº†ä¸€ä¸ªSMä¸Šé¢ï¼Œç°åœ¨å°±å¯ä»¥åœ¨SMå¼€å§‹è¿è¡Œäº†ã€‚1024ä¸ªthreadå½“ä¸­æ¯32ä¸ªthreadè¢«ç»„ç»‡ä¸ºä¸€ä¸ªwrapï¼Œä¸€ä¸ªwrapçš„32ä¸ªthreadæ°¸è¿œæ‰§è¡Œä¸€æ ·çš„æŒ‡ä»¤ï¼Œä»–ä»¬æ°¸è¿œä¸€èµ·è¡ŒåŠ¨ã€ä¸€èµ·ç­‰å¾…ï¼Œå¦‚æœ32ä¸ªthreadåœ¨æ‰§è¡ŒæŒ‡ä»¤çš„æ—¶å€™æœ‰ä¸€ä¸ªthreadæ²¡æœ‰å°±ä½ï¼Œæ‰€æœ‰çš„threadç­‰å¾…ä»–å°±ä½ä¸ºæ­¢ã€‚è¿™ä½çŸ¥ä¹å¤§ä½¬çš„<a href="https://www.zhihu.com/people/xiaoguiren/posts">æ–‡ç« </a>ä¸­ç»™å‡ºäº†ä¸€ä¸ªç”ŸåŠ¨çš„æ¯”å–»ï¼Œthreadè‹±æ–‡å«ä¹‰æ˜¯çº¿ï¼Œwrapå°±æ˜¯ä¸€æŸçº¿ï¼Œwrapæ‰§è¡Œä¸€æ¡æŒ‡ä»¤å°±å¥½æ¯”æ¢­å­çººè¿‡çº±æœºçš„32æ ¹çº¿ï¼Œæ¯ä¸€æ ¹çº¿éƒ½ä¼šè¢«ç æ–°çš„ä¸€å±‚ä¸çº¿ã€‚å§‘ä¸”æˆ‘ä»¬å°±è¿™ä¹ˆçœ‹å¾…wrapå§ã€‚</p>
<h4 id="GPRä»‹ç»"><a href="#GPRä»‹ç»" class="headerlink" title="GPRä»‹ç»"></a>GPRä»‹ç»</h4><p>å¯¹äºæ¯ä¸ªthreadè€Œè¨€ï¼Œå®ƒéƒ½æœ‰å¯¹åº”çš„å¯„å­˜å™¨ç»„å’ŒPCï¼Œè€ƒè™‘åˆ°wrapæ˜¯ä¸€ä¸ªæ•´ä½“ï¼Œæ‰€ä»¥åªéœ€è¦æ¯ä¸ªwrapæä¾›ä¸€ä¸ªPCå¯„å­˜å™¨å°±å¯ä»¥äº†ï¼Œä½†æ˜¯å¯„å­˜å™¨ç»„è¿˜æ˜¯æ¯ä¸ªthreadéƒ½éœ€è¦çš„ã€‚æ‰€ä»¥æˆ‘ä»¬æ˜¯æä¾›äº†æœ€å¤š1024ä¸ªå¯„å­˜å™¨ç»„å—ï¼Ÿå¹¶ä¸æ˜¯ï¼Œå®é™…ä¸Šæ›´åŠ çš„çµæ´»ï¼ŒSMæ˜¯æä¾›äº†ä¸€ä¸ªå¤§å—çš„generation purpose registerå—ï¼Œä¸€å…±åŒ…å«äº†è‹¥å¹²ä¸ªbankå’Œæ€»è®¡65536ä¸ªGPRã€‚ç„¶åthreadæ ¹æ®è‡ªå·±çš„éœ€è¦åˆ†é…å¯¹åº”æ•°ç›®çš„GPRï¼Œæ¯”å¦‚åªæœ‰256ä¸ªthreadï¼Œæ¯ä¸ªthreadéœ€è¦10ä¸ªGPRï¼Œé‚£ä¹ˆå°±åˆ†æ‘Šèµ°2560ä¸ªGPRã€‚ä¸è¿‡æ¯ä¸ªthreadçš„é€»è¾‘GPRæ˜¯æ€ä¹ˆæ˜ å°„åˆ°GPRå—çš„ç‰©ç†GPRçš„ä¹Ÿæ˜¯ä¸€ä¸ªå­˜ç–‘çš„é—®é¢˜ï¼Œä½†æ˜¯GPUçš„GPRä¸å­˜åœ¨å¯„å­˜å™¨é‡å‘½åçš„æ“ä½œï¼Œå› æ­¤ä¸éœ€è¦å¯„å­˜å™¨ä¸­å‘½åçš„ç¡¬ä»¶æ”¯æŒï¼Œä¸€æ—¦ä¸€å¼€å§‹ç¡®å®šäº†æ˜ å°„ï¼Œé‚£ä¹ˆåç»­ä¹Ÿå°±ä¸ä¼šæ›´æ”¹æ˜ å°„å…³ç³»äº†ã€‚ä¸ªäººè§‰å¾—å¯èƒ½æ˜¯æ¯ä¸€ä¸ªthreadçš„GPRåœ¨è®¿é—®ä¹‹å‰éœ€è¦åŠ ä¸€ä¸ªåç§»é‡ï¼Œæ¯”å¦‚thread1çš„16ä¸ªGPRä»0å¼€å§‹åˆ°15ï¼Œè€Œthread2çš„16ä¸ªGPRåˆ™16å¼€å§‹ï¼Œ16+0-16+15ï¼Œä»¥æ­¤ç±»æ¨ã€‚GPRè¿˜æœ‰ä¸€ä¸ªç‰¹ç‚¹å°±æ˜¯ï¼Œè™½ç„¶å®ƒæœ‰65536ä¸ªï¼Œä½†æ˜¯ä»–ä»¬ä¸èƒ½è¢«åŒæ—¶è®¿é—®ï¼Œè¿™äº›GPRåˆ†ä¸ºäº†å¤šä¸ªbankï¼Œå¦‚æœä¸¤ä¸ªthreadæ­£å¥½è®¿é—®åŒä¸€ä¸ªbankå°±å¿…é¡»ç­‰å¾…ï¼Œæˆ–è€…ä¸€ä¸ªthreadçš„å¤šä¸ªå¯„å­˜å™¨åœ¨åŒä¸€ä¸ªbankä¹Ÿéœ€è¦ç­‰å¾…ã€‚</p>
<p>GPRæ¯ä¸ªçš„å¤§å°éƒ½æ˜¯4ä¸ªå­—èŠ‚ã€‚å¦‚æœæ•°æ®çš„å¤§å°æ­£å¥½å°±æ˜¯4å­—èŠ‚ï¼Œé‚£ä¹ˆå­˜åœ¨è¿™ä¸ªGPRé‡Œæ˜¯åˆšåˆšå¥½çš„ï¼Œå¦‚æœæ•°æ®å°äº4å­—èŠ‚ï¼Œé‚£ä¹ˆåœ¨ä¸è€ƒè™‘ç‰¹æ®Šæ“ä½œçš„æƒ…å†µä¸‹ä¹Ÿæ˜¯å ç”¨ä¸€ä¸ªGPRï¼Œä¼šæŸå¤±ä¸€äº›ç©ºé—´ï¼›ä½†æ˜¯å¯ä»¥ç”¨ä¸€äº›ç‰¹æ®ŠæŒ‡ä»¤æˆ–è€…trackæŠŠæ¯”å¦‚ä¸¤ä¸ª16ä½çš„æ•°æ®å­˜åˆ°ä¸€ä¸ª32ä½çš„GPRé‡Œï¼Œè¿™æ ·åç»­å¯ä»¥ç”¨ä¸€äº›ç‰¹æ®ŠæŒ‡ä»¤å¯¹ä¸¤ä¸ªåŠå­—åŒæ—¶è¿›è¡ŒåŠ æ³•è¿ç®—ç­‰æ“ä½œï¼›å¦‚æœæ˜¯64ä½çš„æ•°æ®æ¯”å¦‚doubleï¼Œé‚£ä¹ˆå°±éœ€è¦ä¸€æ¬¡ä½¿ç”¨ä¸¤ä¸ªè¿ç»­çš„GPRæ‰å¯ä»¥ï¼Œè¿™ä¸ªæ—¶å€™æŒ‡ä»¤ä¼šéšå¼çš„æŒ‡å‡ºè¿™ä¸ªGPRæ˜¯å¤šä¸ªGPRç»„æˆçš„ï¼Œä½†æ˜¯å†™æ±‡ç¼–çš„æ—¶å€™åªè¦å†™å‡ ä¸ªGPRä¸­æœ€å°çš„é‚£ä¸ªå°±å¯ä»¥äº†ï¼Œè€Œä¸”ä¸€å®šæ˜¯å¯¹é½çš„ã€‚SASSæŒ‡ä»¤ç»™GPRå¯»å€çš„åŸŸæ˜¯8ä½ï¼Œæ‰€ä»¥ä¸€ä¸ªthreadæœ€å¤šå¯ä»¥è®¿é—®512ä¸ªGPRï¼Œæ›´å¤šçš„GPRçš„ä½¿ç”¨ä¼šå¯¼è‡´å¯„å­˜å™¨æº¢å‡ºç­‰æ“ä½œæ¥é¢å¤–å¤„ç†ï¼ŒGPRçš„255æ˜¯ä¸€ä¸ªç‰¹æ®Šçš„å¯„å­˜å™¨ï¼Œä»–è¢«è®¤ä¸ºè®¿é—®äº†0å¯„å­˜å™¨ã€‚</p>
<h4 id="schedulerå’Œdispatch-port"><a href="#schedulerå’Œdispatch-port" class="headerlink" title="schedulerå’Œdispatch port"></a>schedulerå’Œdispatch port</h4><p>GPRå’Œå…¶ä»–çš„å¯„å­˜å™¨è§£å†³äº†è¡¨ç¤ºwrapå’ŒthreadçŠ¶æ€çš„æ•°æ®çš„å­˜å‚¨é—®é¢˜(å°±æ˜¯PCã€GPRå’Œå…¶ä»–çš„ç‰¹æƒå¯„å­˜å™¨ç­‰)ï¼Œåªè¦è¿™ä¸ªblockè¿˜åœ¨è¿™ä¸ªSMä¸Šï¼Œè¿™äº›threadå°±é™é™çš„èººåœ¨å¯¹åº”çš„GPRå’ŒPCå¯„å­˜å™¨ä¸­ï¼Œç›´åˆ°schedulerè°ƒåº¦äº†å®ƒä»¬å¯¹åº”çš„wrapï¼Œdispatch portå‘å°„äº†å¯¹åº”çš„æŒ‡ä»¤ï¼Œå†™å›çš„ç»“æœä¿®æ”¹äº†å¯¹åº”çš„mmeoryå’Œregisterç­‰ã€‚</p>
<p>ä¸€ä¸ªSMå¯èƒ½æœ‰4ä¸ªschedulerã€8ä¸ªdispatch portã€128ä¸ªcoreã€128ä¸ªFPã€64ä¸ªSFUã€65536ä¸ªGPRï¼Œä¸Šé¢æœ‰1ä¸ªblockçš„1024ä¸ªthreadã€‚æ¯”å¦‚ä¸‹å›¾ï¼š<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/SM.jpg" alt="SMå†…éƒ¨ç»“æ„å›¾"><br>é‚£ä¹ˆè¿™ä¸ªæ—¶å€™è¿™äº›èµ„æºå¯èƒ½æ˜¯å‡åŒ€åˆ†æˆ4åˆ†æ¥è¿›è¡Œè°ƒåº¦ç®¡ç†çš„ï¼Œæ¯”å¦‚æ¯ä¸ªschedulerç®¡ç†è‡ªå·±å¯¹åº”çš„2ä¸ªdispatch portã€32ä¸ªcoreã€32ä¸ªFPã€16ä¸ªSFUã€è°ƒåº¦8ä¸ªwrapï¼Œå¯ä»¥çœ‹åˆ°æ•°å­—å˜å°äº†ä»¥åï¼Œç¡¬ä»¶è®¾è®¡çš„å‹åŠ›ç¬é—´å˜å°äº†ã€‚ç„¶åschedulerå°±è°ƒåº¦è¿™8ä¸ªwrapçœ‹çœ‹è°æ˜¯å¯ä»¥å‡†å¤‡å‘å°„æ²¡æœ‰stallçš„ï¼Œå°±å°†å®ƒçš„æŒ‡ä»¤å–å‡ºæ¥æ”¾åˆ°dispatch portå½“ä¸­ç­‰å¾…å‘å°„ï¼Œå¯èƒ½æ˜¯2ä¸ªwrapä¸€ä¸ªæä¾›ä¸€ä¸ªinstï¼Œä¹Ÿå¯èƒ½æ˜¯1ä¸ªwrapæä¾›2ä¸ªinstï¼Œå½“ç„¶ä¹Ÿå¯èƒ½åªèƒ½å‡‘å‡ºä¸€ä¸ªinstï¼Œç”šè‡³ä¸€ä¸ªéƒ½æ²¡æœ‰ã€‚è¿™é‡Œå‘å°„çš„æŒ‡ä»¤ç»å¯¹ä¸åšä¹±åºï¼Œæ²¡æœ‰ä»€ä¹ˆè·³è½¬é¢„æµ‹ã€æ²¡æœ‰ä¹±åºæ‰§è¡Œã€æ²¡æœ‰ä¿ç•™ç«™ã€æ²¡æœ‰å†²çªæ£€æµ‹ï¼Œä»€ä¹ˆéƒ½æ²¡æœ‰ï¼Œåªæ˜¯çº¯ç²¹çš„é¡ºåºæ‰§è¡Œï¼Œæœ€å¤šåŒå‘å°„ã€‚SMçš„è¿…é€Ÿä¾èµ–äºwrapçš„32ä¸ªthreadåŒæ—¶è¿è¡Œï¼Œä»¥åŠä¸€ä¸ªwrapåœé¡¿ä¹‹åï¼Œä¸‹ä¸€ä¸ªwrapé©¬ä¸Šé¡¶ä¸Šã€‚</p>
<p>è¿™ç§é…ç½®ä¸‹çš„dispatch portå¯ä»¥è·‘ä¸¤æ¡ä¸åŒç±»å‹çš„æŒ‡ä»¤ï¼Œç®—æœ¯æ•´å‹æŒ‡ä»¤æ˜¯äº¤ç»™coreã€æµ®ç‚¹æŒ‡ä»¤äº¤ç»™fpã€ç‰¹æ®ŠæŒ‡ä»¤äº¤ç»™sfuã€è®¿å­˜æŒ‡ä»¤äº¤ç»™è®¿å­˜å•å…ƒã€è·³è½¬æŒ‡ä»¤äº¤ç»™å…¶ä»–éƒ¨åˆ†ï¼Œæ‰€ä»¥å¾€å¾€å¯ä»¥åŒæ—¶å‘å°„ä¸€æ¡ç®—æœ¯æŒ‡ä»¤å’Œä¸€æ¡å…¶ä»–æŒ‡ä»¤ã€‚å¦‚æœæ˜¯ç®—æœ¯æŒ‡ä»¤32ä¸ªcoreæ­£å¥½å¯ä»¥è·‘ä¸€ç»„ï¼Œå¯¹äºSFUåªæœ‰16ä¸ªçš„å¯èƒ½å°±è¦è·‘ä¸¤æ¬¡ã€‚</p>
<p>æ‰€ä»¥blockåœ¨SMçš„æ‰§è¡Œå°±æ˜¯æ¯ä¸ªthreadåœ¨GPRä¸Šåˆ†é…è‡ªå·±çš„GPRåŒºé—´ï¼Œç„¶åæ¯ä¸ªschedulerä»æ‰€æœ‰çš„wrapä¸­æ‰¾åˆ°å¯ä»¥è¿è¡Œçš„wrapå°†ä»–ä»¬å¯ä»¥å‘å°„çš„instè½½å…¥åˆ°dispatch portä¸­å‘å°„ï¼Œå‘å°„çš„æŒ‡ä»¤å¦‚æœæ˜¯ç®—æœ¯æŒ‡ä»¤çš„è¯å°±ä»GPRä¸­è¯»å–å¯¹åº”çš„å¯„å­˜å™¨çš„å€¼ï¼Œå¦‚æœGPRå†²çªäº†è¿˜éœ€è¦é¢å¤–çš„ç­‰å¾…ï¼Œç„¶åè¿›å…¥å¯¹åº”çš„è®¡ç®—å•å…ƒè®¡ç®—ï¼Œæœ€åå†™å›GPRã€‚è¿™ä¸ªè¿‡ç¨‹ä¹Ÿæ˜¯æœ‰ç®€å•çš„æµæ°´åŒ–æ“ä½œçš„ï¼Œè™½ç„¶æŒ‡ä»¤åŠ¨ä¸åŠ¨å°±ä¼šstallä¸€åˆ°ä¸¤æ‹ï¼Œä½†æ˜¯å¤šå°‘å¯ä»¥å¹¶è¡Œä¸€äº›ã€‚</p>
<h4 id="æŒ‡ä»¤è·å–"><a href="#æŒ‡ä»¤è·å–" class="headerlink" title="æŒ‡ä»¤è·å–"></a>æŒ‡ä»¤è·å–</h4><p>æŒ‡ä»¤æ˜¯æœ‰æŒ‡ä»¤cacheçš„ï¼Œæ¯æ¬¡è·å–æŒ‡ä»¤éƒ½æ˜¯ä»æŒ‡ä»¤cacheä¸­è·å¾—çš„ï¼Œåº”è¯¥ä¹Ÿä¼šæœ‰æŒ‡ä»¤çš„é¢„å–æ¨¡å—ã€‚</p>
<h3 id="æŒ‡ä»¤æ‰§è¡Œ"><a href="#æŒ‡ä»¤æ‰§è¡Œ" class="headerlink" title="æŒ‡ä»¤æ‰§è¡Œ"></a>æŒ‡ä»¤æ‰§è¡Œ</h3><h4 id="ç®—æœ¯æŒ‡ä»¤"><a href="#ç®—æœ¯æŒ‡ä»¤" class="headerlink" title="ç®—æœ¯æŒ‡ä»¤"></a>ç®—æœ¯æŒ‡ä»¤</h4><h5 id="æ•´æ•°æŒ‡ä»¤å’Œcore"><a href="#æ•´æ•°æŒ‡ä»¤å’Œcore" class="headerlink" title="æ•´æ•°æŒ‡ä»¤å’Œcore"></a>æ•´æ•°æŒ‡ä»¤å’Œcore</h5><p>æ•´æ•°æŒ‡ä»¤åŒ…æ‹¬åŠ æ³•æŒ‡ä»¤ã€å‡æ³•æŒ‡ä»¤ã€ç§»ä½æŒ‡ä»¤ã€ä¸æˆ–éé€»è¾‘æŒ‡ä»¤ç­‰å¸¸è§çš„æŒ‡ä»¤ã€‚ç§»ä½æŒ‡ä»¤æä¾›äº†ä¸€ç§ç‰¹æ®Šçš„æŒ‡ä»¤ï¼Œå¯ä»¥å°†2ä¸ª32ä½æŒ‡ä»¤å½“ä½œä¸€ä¸ªæ•´ä½“è¿›è¡Œç§»ä½æ“ä½œï¼Œä»è€Œå®ç°å¤§æ•´æ•°çš„ç§»ä½ç­‰æ“ä½œã€‚</p>
<p>æ­¤å¤–è¿˜æœ‰æ•´æ•°ä¹˜æ³•æŒ‡ä»¤ç­‰ï¼Œä½†æ˜¯æ²¡æœ‰æ•´æ•°é™¤æ³•æŒ‡ä»¤ï¼Œè‡ªç„¶ä¹Ÿæ²¡æœ‰å–ä½™æŒ‡ä»¤ï¼Œè¿™ä¸¤ç±»æŒ‡ä»¤éœ€è¦ç”¨å…¶ä»–æ•´æ•°æŒ‡ä»¤ç”¨å†…åµŒå‡½æ•°çš„æ–¹å¼å®ç°ï¼Œæ•ˆç‡å¾ˆæ…¢ï¼Œéœ€è¦é¿å…ã€‚å¦‚æœæ˜¯å¸¸æ•°çš„ä¹˜æ³•å¾€å¾€ä¼šåšä¸€äº›ä¼˜åŒ–ï¼Œæ¯”å¦‚2çš„å¹‚æ¬¡çš„å¸¸æ•°è½¬æ¢ä¸ºç§»ä½æ“ä½œï¼Œç®€å•å¸¸æ•°çš„ä¹˜æ³•å¯ä»¥è½¬æ¢ä¸ºå¤šä¸ªç§»ä½è¿ç®—çš„ç»„åˆç­‰ç­‰ã€‚</p>
<p>æ•´æ•°è¿ç®—çš„æ“ä½œæ•°å¯ä»¥æ˜¯GPRå¯„å­˜å™¨ã€ç«‹å³æ•°ã€predicateå¯„å­˜å™¨ã€uniformå¯„å­˜å™¨ã€constant memory numberç­‰æ•°æ®ï¼Œè¿™é‡Œæ“ä½œæ•°å¦‚æœæ˜¯å†…å­˜åªèƒ½æ˜¯constant memoryï¼ŒåŸå› æˆ‘ä»¬åœ¨ä»‹ç»è®¿å­˜çš„æ—¶å€™å†ä»‹ç»ï¼Œå…¶ä»–å‡ ç±»å¯„å­˜å™¨ä¹Ÿåœ¨ç›¸å…³æŒ‡ä»¤ä»‹ç»çš„æ—¶å€™å†è¯¦è°ˆã€‚æ•´æ•°æŒ‡ä»¤äº¤ç”±coreè¿è¡Œï¼Œç®€å•çš„æ•´æ•°æŒ‡ä»¤å¯èƒ½åªéœ€è¦ä¸€ä¸ªå‘¨æœŸï¼Œå¤æ‚çš„å¯èƒ½è¦å¤šä¸ªå‘¨æœŸï¼Œå¯¹äºstallçš„æ§åˆ¶å¹¶ä¸æ˜¯ä½¿ç”¨åŠ¨æ€ç›‘æµ‹ï¼Œæˆ‘ä»¬åé¢è¯¦ç»†ä»‹ç»ã€‚</p>
<p>å¸¸è§çš„æŒ‡ä»¤æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>IADD</td>
<td>æ•´æ•°åŠ æ³•</td>
</tr>
<tr>
<td>ICMP</td>
<td>æ•´æ•°æ¯”è¾ƒ</td>
</tr>
<tr>
<td>IMAD</td>
<td>ä¸¤ä¸ªæ•´æ•°ç›¸ä¹˜ï¼Œåœ¨å’Œç¬¬ä¸‰ä¸ªæ•´æ•°ç›¸åŠ ï¼Œå¸¸ç”¨äºçŸ©é˜µè¿ç®—ç­‰</td>
</tr>
<tr>
<td>IMNMX</td>
<td>è®¡ç®—ä¸¤ä¸ªæ•´æ•°è¾ƒå¤§çš„æ•°ï¼Œæˆ–è€…è¾ƒå°çš„æ•°</td>
</tr>
<tr>
<td>IMUL</td>
<td>æ•´æ•°ä¹˜æ³•</td>
</tr>
<tr>
<td>ISAD</td>
<td>æ•´æ•°æ±‚å·®çš„ç»å¯¹å€¼</td>
</tr>
<tr>
<td>LOP</td>
<td>æ•´æ•°é€»è¾‘è¿ç®—ï¼Œå¦‚ä¸ã€æˆ–ã€å¼‚æˆ–</td>
</tr>
<tr>
<td>SHF</td>
<td>é€šé“ä½ç§»ï¼Œå°±æ˜¯ä¸¤ä¸ª32ä½æ•´æ•°å½“ä½œæ•´ä½“ä½ç§»</td>
</tr>
<tr>
<td>SHL</td>
<td>æ•´æ•°å·¦ç§»</td>
</tr>
<tr>
<td>SHR</td>
<td>æ•´æ•°å³ç§»</td>
</tr>
<tr>
<td>FLO</td>
<td>å¯»æ‰¾æ•´æ•°ç¬¬ä¸€ä¸ªå‰å¯¼1çš„ä½ç½®</td>
</tr>
<tr>
<td>POPC</td>
<td>è®¡ç®—æ•´æ•°ä¸­1çš„ä¸ªæ•°</td>
</tr>
<tr>
<td>I2I</td>
<td>æ•´æ•°ä¸åŒç±»å‹çš„è½¬æ¢</td>
</tr>
<tr>
<td>å…¶ä»–çš„ä¸ç½—åˆ—äº†ï¼Œæ›´å¤šå†…å®¹å‚è§è¿™ç¯‡<a href="https://www.informit.com/articles/article.aspx?p=2103809&seqNum=7">æ–‡ç« </a></td>
<td></td>
</tr>
</tbody></table>
<p>å¯¹äºIADDã€IMULã€SHLã€SHRç­‰æŒ‡ä»¤ï¼Œæˆ‘ä»¬åœ¨cudaç¼–ç¨‹çš„æ—¶å€™å¯ä»¥ç”¨Cçš„+ã€*ã€&lt;&lt;ã€&gt;&gt;ç­‰ç®—å­è¡¨ç¤ºï¼Œç„¶åç¼–è¯‘å™¨å¯ä»¥è‡ªåŠ¨ç”Ÿæˆï¼Œä½†æ˜¯å¾ˆå¤šçš„æŒ‡ä»¤çš„åŠŸèƒ½å¯èƒ½Cæœ‰é™çš„è¿ç®—ç¬¦æ— æ³•è¡¨ç¤ºï¼Œè¿™ä¸ªæ—¶å€™æœ‰ä¸‰ç§æ–¹æ³•å¯ä»¥ä½¿ç”¨è¿™äº›ç‰¹æ®Šçš„æŒ‡ä»¤ã€‚ç¬¬ä¸€æ˜¯ä¾é ç¼–è¯‘å™¨è‡ªåŠ¨çš„ä¼˜åŒ–ï¼Œä½†æ˜¯å¾ˆå¤šæ—¶å€™å¯èƒ½ä¼šä¸å°½äººæ„ï¼Œæˆ–è€…ä¸å¦‚ç›´æ¥æŒ‡ä»¤ç‰¹æ®ŠæŒ‡ä»¤æ¥çš„æ•ˆæœå¥½ï¼›ç¬¬äºŒæ˜¯ç”¨å†…è”æ±‡ç¼–çš„æ–¹å¼æ¥è¿›è¡Œï¼Œä¸è¿‡å†…è”æ±‡ç¼–å¯èƒ½å’ŒCè¯­æ³•ä¸æ˜¯å¾ˆæ­ï¼Œè€Œä¸”è¿™é‡Œæ¶‰åŠåˆ°äº†ptxè¯­æ³•æ˜¯å¦å…¼å®¹ç­‰é—®é¢˜ï¼›æœ€åå°±æ˜¯æ¯ä¸ªæŒ‡ä»¤å¯èƒ½æä¾›äº†é…å¥—çš„instrincå‡½æ•°ï¼Œåªè¦ä½¿ç”¨è¿™ä¸ªå‡½æ•°å°±å¯ä»¥äº§ç”Ÿå¯¹åº”çš„ä¸€æ¡æŒ‡ä»¤ï¼Œå…·ä½“å‡½æ•°çš„åå­—å¯ä»¥æŸ¥ä¸€ä¸‹æ–‡æ¡£ã€‚æ¯”å¦‚POPCæŒ‡ä»¤å¯¹åº”çš„__popcï¼ŒSHFæŒ‡ä»¤å¯¹åº”çš„__funnelshift_xç³»åˆ—ç­‰ã€‚å…·ä½“çš„å¯¹åº”å…³ç³»å¯ä»¥çœ‹è¿™ä¸€ç³»åˆ—<a href="https://www.informit.com/articles/article.aspx?p=2103809&seqNum=2">æ–‡ç« </a></p>
<h5 id="æµ®ç‚¹æ•°æŒ‡ä»¤å’ŒFPU"><a href="#æµ®ç‚¹æ•°æŒ‡ä»¤å’ŒFPU" class="headerlink" title="æµ®ç‚¹æ•°æŒ‡ä»¤å’ŒFPU"></a>æµ®ç‚¹æ•°æŒ‡ä»¤å’ŒFPU</h5><p>æµ®ç‚¹æ•°æŒ‡ä»¤åŒ…æ‹¬æµ®ç‚¹åŠ æ³•ã€å‡æ³•ã€ä¹˜æ³•ç­‰ï¼Œæµ®ç‚¹çš„æ“ä½œæ•°é™¤äº†å¯ä»¥æ˜¯32ä½çš„GPRä½œä¸ºä¸€ä¸ª32ä½çš„æµ®ç‚¹æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯2ä¸ªGPRä½œä¸ºä¸€ä¸ª64ä½çš„æµ®ç‚¹æ•°ï¼Œä¹Ÿå¯ä»¥æ˜¯1ä¸ªGPRä½œä¸º2ä¸ª16ä½çš„æµ®ç‚¹æ•°ï¼Œè¯¸å¦‚æ­¤ç±»ã€‚è¿™äº›è¿ç®—éƒ½æ˜¯å’ŒCPUçš„FPUç±»ä¼¼çš„è¿ç®—éƒ¨ä»¶ï¼Œéƒ½æ˜¯å¸¸è§„çš„é«˜ç²¾åº¦è®¡ç®—éƒ¨ä»¶ã€‚</p>
<p>æµ®ç‚¹æ•°æŒ‡ä»¤äº¤ç»™FUå•å…ƒè¿›è¡Œè¿ç®—ã€‚å¸¸è§çš„æµ®ç‚¹æŒ‡ä»¤æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>DADD</td>
<td>åŒç²¾åº¦åŠ æ³•</td>
</tr>
<tr>
<td>FADD</td>
<td>å•ç²¾åº¦åŠ æ³•</td>
</tr>
<tr>
<td>DFMA</td>
<td>åŒç²¾åº¦ä¹˜æ³•å†åšåŠ æ³•</td>
</tr>
<tr>
<td>FFMA</td>
<td>å•ç²¾åº¦ä¹˜æ³•å†åšåŠ æ³•</td>
</tr>
<tr>
<td>DMAX</td>
<td>åŒç²¾åº¦æ±‚æœ€å¤§å€¼</td>
</tr>
<tr>
<td>FMAX</td>
<td>å•ç²¾åº¦æ±‚æœ€å¤§å€¼</td>
</tr>
<tr>
<td>DMIN</td>
<td>åŒç²¾åº¦æ±‚æœ€å°å€¼</td>
</tr>
<tr>
<td>FMIN</td>
<td>å•ç²¾åº¦æ±‚æœ€å°å€¼</td>
</tr>
<tr>
<td>DMUL</td>
<td>åŒç²¾åº¦ä¹˜æ³•</td>
</tr>
<tr>
<td>FMUL</td>
<td>å•ç²¾åº¦ä¹˜æ³•</td>
</tr>
<tr>
<td>F2F</td>
<td>æµ®ç‚¹æ•°ä¸åŒç²¾åº¦ä¹‹é—´çš„è½¬æ¢</td>
</tr>
<tr>
<td>I2F</td>
<td>ä¸åŒç±»å‹çš„æ•´æ•°è½¬æ¢åˆ°ä¸åŒç²¾åº¦çš„æµ®ç‚¹æ•°</td>
</tr>
<tr>
<td>F2I</td>
<td>ä¸åŒç²¾åº¦çš„æµ®ç‚¹æ•°è½¬æ¢ä¸ºä¸åŒç±»å‹çš„æ•´æ•°</td>
</tr>
</tbody></table>
<h5 id="ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤å’ŒSFU"><a href="#ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤å’ŒSFU" class="headerlink" title="ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤å’ŒSFU"></a>ç‰¹æ®ŠåŠŸèƒ½æŒ‡ä»¤å’ŒSFU</h5><p>SFUå•å…ƒæ˜¯special function unitï¼Œå¯ä»¥å¤„ç†ç‰¹æ®Šçš„ç®—æ•°è¿ç®—ã€‚ä¸Šé¢çš„FPå•å…ƒæ²¡æœ‰æä¾›æµ®ç‚¹çš„é™¤æ³•æˆ–è€…å¼€æ–¹æŒ‡ä»¤ï¼Œå› ä¸ºæµ®ç‚¹æ•°çš„é™¤æ³•å®ç°èµ·æ¥æ¯”ä¹˜æ³•è¦æ…¢å¾ˆå¤šï¼Œç›¸åSFUå®ç°äº†æµ®ç‚¹æ•°çš„å€’æ•°æŒ‡ä»¤ï¼Œå¯ä»¥æ±‚$f(x)&#x3D;1&#x2F;x$ï¼Œè¿˜æœ‰æ±‚$f(x)&#x3D;1&#x2F;\sqrt{x}$çš„æŒ‡ä»¤ã€‚åœ¨è®¡ç®—å¾—åˆ°$1&#x2F;x$å’Œ$1&#x2F;\sqrt{x}$ä¹‹åï¼Œå°†ä»–ä»¬å’Œyã€xç›¸ä¹˜å°±å¯ä»¥å¾—åˆ°$y&#x2F;x$å’Œ$\sqrt{x}$ï¼Œä»è€Œç”¨ä¸¤æ¡æŒ‡ä»¤å®ç°é™¤æ³•å’Œå¼€æ–¹çš„ç›®çš„ã€‚</p>
<p>è¿™é‡Œçš„å€’æ•°è¿ç®—é‡‡ç”¨çš„æ˜¯ç‰›é¡¿è¿­ä»£æ³•çš„æ•°å€¼è®¡ç®—æ–¹å¼ï¼Œè¦æ±‚$y&#x3D;1&#x2F;a$ï¼Œåˆ™æœ‰</p>
<p>$$<br>\begin{aligned}<br>&amp;\because y&#x3D;1&#x2F;a \\<br>&amp;\therefore f(y)&#x3D;1&#x2F;y-a&#x3D;0 \\<br>&amp;\therefore y_{n}&#x3D;y_{n-1}-f(y_{n-1})&#x2F;fâ€™{y_{n-1}} \\<br>&amp;\therefore y_{n}&#x3D;y_{n-1}-\frac{y_{n-1}^{-1}-a}{-y_{n-1}^{-2}} \\<br>&amp;\therefore y_{n}&#x3D;2y_{n-1}-ay_{n-1}^2<br>&amp;\end{aligned}<br>$$<br>è¿™é‡Œçš„å€’æ•°è¿ç®—é‡‡ç”¨çš„æ˜¯ç‰›é¡¿è¿­ä»£æ³•çš„æ•°å€¼è®¡ç®—æ–¹å¼ï¼Œè¦æ±‚$y&#x3D;1&#x2F;\sqrt{a}$ï¼Œåˆ™æœ‰</p>
<p>$$<br>\begin{aligned}<br>&amp;\because y&#x3D;1&#x2F;\sqrt{a} \\<br>&amp;\therefore f(y)&#x3D;1&#x2F;y^2-a&#x3D;0 \\<br>&amp;\therefore y_{n}&#x3D;y_{n-1}-f(y_{n-1})&#x2F;fâ€™{y_{n-1}} \\<br>&amp;\therefore y_n&#x3D;y_{n-1}-\frac{y^{-2}-a}{-2y^{-3}} \\<br>&amp;\therefore y_n&#x3D;\frac{3y_{n-1}-ay^3}{2}<br>\end{aligned}<br>$$<br>è¿™æ ·å°±å¯ä»¥ç”¨è¾ƒå¿«é€Ÿçš„ä¹˜æ³•ã€åŠ æ³•å–ä»£é™¤æ³•å’Œå¼€æ–¹è¿ç®—ï¼Œä½†æ˜¯ä»£ä»·å°±æ˜¯ç²¾åº¦ä¼šæœ‰æ‰€æŸå¤±ï¼Œæ‰€ä»¥å¾ˆå¤šæ—¶å€™åœ¨å®é™…ä½¿ç”¨æ—¶è¿˜æ˜¯éœ€è¦ç”¨ä¸€äº›æ•°å€¼æ–¹æ³•ï¼Œå°†å¤šä¸ªé™¤æ³•è¿›è¡Œé…åˆè¿›è¡Œä½¿ç”¨ï¼Œæ¥æé«˜ç²¾åº¦ã€‚</p>
<p>æ­¤å¤–è¿˜æä¾›äº†log2ã€exp2ã€cosã€sinç­‰è¿ç®—å•å…ƒï¼Œéƒ½æ˜¯é‡‡ç”¨ä¸€äº›è¿‘ä¼¼æˆ–è€…æ•°å€¼çš„è®¡ç®—æ–¹æ³•ã€‚å¯¹äºcoså’Œsinæä¾›äº†rroæ“ä½œå¯ä»¥å°†ä»»æ„å¤§å°çš„æµ®ç‚¹æ•°è½¬æ¢åˆ°$-\pi~\pi$ä¹‹é—´ï¼Œç„¶ååœ¨è¿›è¡Œcosã€sinçš„è®¡ç®—ï¼Œè¿™æ ·å¯ä»¥å¤§å¤§æé«˜ç²¾åº¦ã€‚ä½†æ˜¯è¿™äº›ç®—æ³•ç²¾åº¦éƒ½æ²¡æœ‰éå¸¸é«˜ï¼Œé«˜ç²¾åº¦åœºæ™¯ä¸‹è¿˜æ˜¯éœ€è¦é¢å¤–çš„æ“ä½œæ¥çŸ«æ­£ã€‚</p>
<p>ç‰¹æ®ŠåŠŸèƒ½çš„æ•°å­¦è¿ç®—æŒ‡ä»¤äº¤ç»™SFUæ¥è¿›è¡Œï¼Œæä¾›çš„å¸¸è§æŒ‡ä»¤å¦‚ä¸‹ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>LG2</td>
<td>log2è¿ç®—</td>
</tr>
<tr>
<td>EX2</td>
<td>exp2è¿ç®—</td>
</tr>
<tr>
<td>RCP</td>
<td>è®¡ç®—å€’æ•°</td>
</tr>
<tr>
<td>RSQ</td>
<td>è®¡ç®—å¼€æ”¾æ ¹çš„å€’æ•°</td>
</tr>
<tr>
<td>RRO</td>
<td>åœ¨sinã€cosä¹‹å‰ä½¿ç”¨ï¼Œå°†æ•°æ®èŒƒå›´ç¼©å‡åˆ°2$\pi$èŒƒå›´</td>
</tr>
<tr>
<td>COS</td>
<td>cosè¿ç®—</td>
</tr>
<tr>
<td>SIN</td>
<td>sinè¿ç®—</td>
</tr>
</tbody></table>
<h6 id="åŠŸèƒ½å•å…ƒçš„collector"><a href="#åŠŸèƒ½å•å…ƒçš„collector" class="headerlink" title="åŠŸèƒ½å•å…ƒçš„collector"></a>åŠŸèƒ½å•å…ƒçš„collector</h6><p>coreã€FPUã€SFUéƒ½æœ‰ä¸€ä¸ªcollectorçš„å¯„å­˜å™¨ç»„ï¼Œè¿™äº›å¯„å­˜å™¨ç»„ç”¨æ¥å­˜æ”¾ä¹‹åè®¡ç®—å•å…ƒéœ€è¦çš„æ•°æ®çš„å€¼ï¼Œæ¯”å¦‚GPRçš„å€¼ã€immçš„å€¼ç­‰ç­‰ï¼Œå½“ä¸€æ¡æŒ‡ä»¤ä»dispatch portå‘å°„åˆ°è®¡ç®—å•å…ƒå¼€å§‹è¿ç®—ä¹‹å‰éœ€è¦é¦–å…ˆå–å€¼ï¼Œå¹¶å°†æ•°å€¼å­˜æ”¾åˆ°å¯¹åº”çš„è®¡ç®—å•å…ƒçš„collectorå½“ä¸­å»ï¼Œæµæ°´çº¿çš„ä¸­é—´å¯„å­˜å™¨å¾ˆå¤šæ—¶å€™å°±èµ·åˆ°äº†è¿™ä¸ªä½œç”¨ã€‚å¦‚æœæ“ä½œæ•°çš„å€¼éœ€è¦å–å‡ ä¸ªå‘¨æœŸï¼Œæ¯”å¦‚GPRçš„bankå†²çªäº†ï¼Œæˆ–è€…è®¿å­˜åœ¨ç­‰å¾…ï¼Œé‚£ä¹ˆcollectorå°±è¦å‡ ä¸ªå‘¨æœŸç­‰æ•°æ®æ”¶é›†é½å…¨ä¹‹åæ‰å¯ä»¥å¼€å§‹åç»­çš„è®¡ç®—ã€‚</p>
<h4 id="è®¿å­˜æŒ‡ä»¤"><a href="#è®¿å­˜æŒ‡ä»¤" class="headerlink" title="è®¿å­˜æŒ‡ä»¤"></a>è®¿å­˜æŒ‡ä»¤</h4><p>è®¿å­˜å•å…ƒæ˜¯LD&#x2F;STå•å…ƒï¼Œç”¨æ¥å¤„ç†è®¿å­˜äº‹åŠ¡ï¼Œå…·ä½“è®¿å­˜çš„ç¡¬ä»¶ç»†èŠ‚è‡ªç„¶æ˜¯æŸ¥ä¸åˆ°çš„ï¼Œæ‰€ä»¥è¿™é‡Œä¸»è¦æ˜¯ä»‹ç»ä¸€äº›GPUçš„å­˜å‚¨æ¶æ„ç­‰å†…å®¹ã€‚LD&#x2F;STå•å…ƒå†è¿›è¡Œè®¿é—®ä¹‹å‰ä¼šè¿›è¡Œé¡µè¡¨çš„ç¿»è¯‘å·¥ä½œï¼Œæ‰€æœ‰çš„LD&#x2F;STå…±ç”¨ä¸€ä¸ªé¡µè¡¨è½¬æ¢å•å…ƒï¼Œè¿™ä¸ªé¡µè¡¨è½¬æ¢å•å…ƒä¹Ÿæ˜¯æœ‰è‡ªå·±çš„TLBè¿›è¡Œç¼“å­˜ï¼Œä¸ºäº†å¯ä»¥é«˜æ•ˆåœ°è¿›è¡Œåœ°å€è½¬æ¢ï¼Œè¿™ä¸ªTLBä¼šæ¯”è¾ƒå¤§ã€‚</p>
<h5 id="LDS-STSä¸shared-memoryä¸L1-cache"><a href="#LDS-STSä¸shared-memoryä¸L1-cache" class="headerlink" title="LDS&#x2F;STSä¸shared memoryä¸L1 cache"></a>LDS&#x2F;STSä¸shared memoryä¸L1 cache</h5><p>ä¸€ä¸ªSMåšåœ¨ä¸€ä¸ªç´§å‡‘çš„ç‰‡ä¸ŠåŒºåŸŸï¼Œå†…éƒ¨çš„æ•°æ®ä¼ è¾“å’Œè¿ç®—æ˜¯éå¸¸é«˜æ•ˆå’Œç¨³å®šã€‚ç±»ä¼¼äºCPUæœ‰è‡ªå·±çš„ç‰‡ä¸ŠL1 cacheå’ŒL2 cacheç­‰ï¼ŒGPUçš„SMä¹Ÿæœ‰è‡ªå·±çš„ç‰‡ä¸Šå­˜å‚¨å™¨ï¼Œæ¥æ–¹ä¾¿å¿«é€Ÿçš„å†…å­˜æ•°æ®è®¿é—®ã€‚è¿™å—ç‰‡ä¸Šå†…å­˜çš„å¤§å°ä¸€èˆ¬æ˜¯64KBï¼Œç„¶åè¢«è¿›ä¸€æ­¥åˆ†æˆå¤§å°ä¸º16KBå’Œ48KBçš„ä¸¤éƒ¨åˆ†ï¼Œä¸€éƒ¨åˆ†æ˜¯ç‰‡ä¸Šçš„L1 cacheï¼Œå°±å’ŒCPUçš„L1 cacheå·®ä¸å¤šï¼Œä¸€ä¸ªæ˜¯shared memoryã€‚æœ‰çš„GPUå¯ä»¥é…ç½®16KBå’Œ48KBå“ªéƒ¨åˆ†ç”¨æ¥å……å½“L1 cacheï¼Œå“ªéƒ¨åˆ†ç”¨æ¥å……å½“shared memoryï¼›æœ‰çš„GPUå¯èƒ½å°±æ˜¯L1 caheå¤§å°ä¸º16KBï¼Œè€Œshared memoryå¤§å°ä¸º48KBã€‚å› ä¸ºæ˜¯ç‰‡ä¸Šçš„å­˜å‚¨ï¼Œæ‰€ä»¥è®¿é—®é€Ÿåº¦éå¸¸çš„å¿«ï¼Œä¸€èˆ¬åªè¦1-2ä¸ªå‘¨æœŸå°±å¯ä»¥è®¿é—®å¾—åˆ°å¯¹åº”çš„å€¼ã€‚</p>
<p>L1 cacheå¤§è‡´å°±æ˜¯å’ŒCPUçš„L1 cacheå·®ä¸å¤šï¼Œä¸è¿‡å› ä¸ºSMåˆ†ä¸ºå¤šä¸ªthreadã€å¤–éƒ¨çš„å†…å­˜ä¹Ÿåˆ†äº†å¤šç§å†…å­˜ï¼Œæ‰€ä»¥L1 cacheçš„tagé™¤äº†virtual addressç­‰ä¿¡æ¯ä¹‹å¤–ï¼Œå¯èƒ½è¿˜æœ‰threadIdxã€memory kindç­‰ä¿¡æ¯ã€‚å½“ä½¿ç”¨LD&#x2F;STè®¿é—®ç‰‡å¤–çš„å­˜å‚¨ï¼Œæ¯”å¦‚global memoryä¹‹ç±»çš„æ—¶å€™åœ¨LD&#x2F;STä¸­è®¾ç½®å¯¹åº”çš„æ“ä½œä½æ¥é€‰æ‹©è¦ä¸è¦æŠŠæ•°æ®ç¼“å­˜åˆ°cacheå½“ä¸­ï¼Œå½“æ•°æ®è¦è¢«åå¤è¯»å–çš„æ—¶å€™è½½å…¥cacheå¯ä»¥æé«˜åç»­çš„æ”¶ç›Šï¼Œä½†æ˜¯å¦‚æœåªä¼šè¢«è®¿é—®ä¸€ä¸¤æ¬¡ï¼Œé‚£ç”¨GPRæš‚å­˜å°±å¥½äº†ï¼Œæ²¡æœ‰å¿…è¦å­˜å…¥L1 cacheã€‚</p>
<p>shared memoryæ˜¯SMçš„æ‰€æœ‰threadå…¬ç”¨çš„å†…å­˜ï¼Œä»–ä»¬å…±äº«shared memoryçš„åœ°å€ç©ºé—´ã€‚å› ä¸ºä¸€ä¸ªSMä¸€æ¬¡åªè·‘ä¸€ä¸ªblockï¼Œè€ŒSMçš„shared memoryåªä¼šè¢«è¿™ä¸ªblockå…±äº«ï¼Œæ‰€ä»¥å®ƒä¸éœ€è¦è™šæ‹Ÿåœ°å€ï¼Œæ˜¯ç›´æ¥ä½¿ç”¨å®åœ°å€è®¿é—®çš„ã€‚è€Œä¸”æ‰€æœ‰çš„shared memoryçš„åœ°å€åœ¨è¿™ä¸ªblockçš„æ‰€æœ‰çš„threadçœ¼ä¸­æ˜¯ä¸€è‡´çš„ã€‚ä¸è¿‡ä¹Ÿä¸ç»å¯¹ï¼Œç°åœ¨ä¸€ä¸ªSMå¯ä»¥è·‘å¤šä¸ªblockï¼Œé‚£ä¹ˆshared memoryå°±ä¼šè¢«è¿™äº›blockå…±äº«ï¼Œä½†æ˜¯ä»–ä»¬çš„shared memoryåœ°å€æ˜¯ç›¸äº’éš”ç¦»çš„ï¼›å†åŠ ä¸Šå¾ˆå¤šèµ„æ–™æŒ‡å‡ºç°åœ¨çš„cudaç¨‹åºæ˜¯ç»Ÿä¸€å†…å­˜ç®¡ç†ï¼Œå°±æ˜¯shared memoryã€global memoryã€constant memoryç­‰å…±äº«ä¸€ä¸ªè™šæ‹Ÿåœ°å€èŒƒå›´ï¼›æ‰€ä»¥å¯èƒ½shared memoryè¿˜æ˜¯éœ€è¦è™šæ‹Ÿå†…å­˜çš„è½¬è¯‘çš„ã€‚</p>
<p>shared memoryå¯ä»¥ä½¿ç”¨ST&#x2F;LDæŒ‡ä»¤è®¿é—®çš„ï¼Œå½“ä½¿ç”¨LDè®¿é—®çš„æ—¶å€™ï¼Œå› ä¸ºæ˜¯ä¸€ä¸ªwrapçš„æ‰€æœ‰threadåŒæ—¶è®¿é—®ï¼Œç”šè‡³å¤šä¸ªwrapåŒæ—¶è®¿é—®ï¼Œå¯èƒ½ä¼šå­˜åœ¨è®¿é—®å¤šä¸ªåœ°å€çš„æƒ…å†µã€‚shared memoryè®¿é—®å¤šä¸ªbankï¼Œå¦‚æœè®¿é—®çš„æ˜¯ä¸åŒçš„bankçš„åœ°å€ï¼Œç›¸äº’ä¹‹é—´æ˜¯ä¸ä¼šå‘ç”Ÿå†²çªçš„ï¼Œå¦‚æœè®¿é—®çš„æ˜¯åŒä¸€ä¸ªbankçš„åŒä¸€ä¸ªaddressï¼Œé‚£ä¹ˆä¹Ÿä¸ä¼šå‘ç”Ÿå†²çªï¼Œæœ€åå¾—åˆ°çš„æ•°æ®ä¼šå¹¿æ’­åˆ°æ‰€æœ‰çš„LDå•å…ƒæ¥æå–æ»¡è¶³è¦æ±‚çš„addresså¯¹åº”çš„æ•°æ®ã€‚å¦‚æœæ˜¯STçš„è¯ï¼Œå³ä½¿è®¿é—®çš„æ˜¯åŒä¸€ä¸ªbankçš„åŒä¸€ä¸ªaddressï¼Œé‚£ä¹ˆå†™å…¥çš„æ•°æ®è¿˜æ˜¯è¦è¢«æ’é˜Ÿï¼Œç„¶åä¸€ä¸ªä¸€ä¸ªçš„å†™è¿›å»ï¼Œå³ä½¿åšçš„ä¸æ˜¯åŸå­è®¿é—®æ“ä½œã€‚å¯ä»¥è€ƒè™‘åˆ°è¿™æ ·çš„å¸ƒçº¿ä¼šå¤šä¹ˆçš„ææ€–ï¼Œæ‰€ä»¥å®é™…ä¸ŠGPUçš„å†…å­˜ç®¡ç†ã€å†²çªå¤„ç†ç­‰æ˜¯éå¸¸çš„å¤æ‚çš„ï¼Œä¸ªäººè§‰å¾—å¯èƒ½æ˜¯GPUæœ€å¤æ‚çš„åœ°æ–¹ï¼Œå¥½åœ¨å¿½ç•¥å…·ä½“å®ç°å°±å˜å¾—ä¸éš¾äº†ã€‚</p>
<p>å½“cudaç¼–ç¨‹çš„æ—¶å€™ï¼Œå¦‚æœæ•°æ®ç»“æ„å‰é¢å£°æ˜äº†<code>__shared__</code>ï¼Œé‚£ä¹ˆå°±ä¼šè¢«è®¾ç½®ä¸ºshared memoryçš„æ•°æ®ï¼Œç„¶åå†è®¿å­˜çš„æ—¶å€™å°±ä¼šè‡ªåŠ¨ä½¿ç”¨STSå’ŒLDSæŒ‡ä»¤ï¼Œä¸éœ€è¦æ‹…å¿ƒshared memoryæä¾›çš„æ•°æ®ä¸€ä¸ªblockä½¿ç”¨ï¼Œå› ä¸ºå¦‚æœè¿™æ ·è¿è¡Œæ—¶ä¼šå‘ç°é”™è¯¯ä¸æ‰§è¡Œæˆ–è€…ç¼–è¯‘æ—¶ç›´æ¥æŠ¥é”™çš„ã€‚</p>
<h5 id="LDL-STLå’Œlocal-memory"><a href="#LDL-STLå’Œlocal-memory" class="headerlink" title="LDL&#x2F;STLå’Œlocal memory"></a>LDL&#x2F;STLå’Œlocal memory</h5><p>æ¯ä¸ªthreadå¯èƒ½ä¼šæœ‰è‡ªå·±çš„local memoryã€‚æ¯”å¦‚è¯´æˆ‘ä»¬åˆ†é…äº†ä¸€ä¸ªæ•°ç»„å˜é‡<code>a[100]</code>ï¼Œå¦‚æœæ˜¯ç®€å•çš„è¿ç®—å¯èƒ½å®ƒä¼šè¢«ä¼˜åŒ–ä¸ºGPRï¼Œç„¶æ˜¯å¦‚æœå®åœ¨æ²¡æ³•ä¼˜åŒ–å®ƒå°±ä¼šè¢«ä¼˜åŒ–ä¸ºæ•°ç»„ã€‚å¦‚æœæ˜¯Cç¨‹åºçš„è¯å°±æ˜¯ä¸€ä¸ªstackä¸Šçš„å†…å­˜ï¼Œä½†æ˜¯threadæ˜¯æ²¡æœ‰stackçš„ï¼Œæ‰€ä»¥å°±ä¼šè¢«åˆ†é…ä¸€æ®µlocal memoryã€‚</p>
<p>è¿™æ®µlocal memoryå®é™…ä¸Šæ˜¯åœ¨glocal memoryä¸Šåˆ†é…å‡ºæ¥çš„ï¼Œä½†æ˜¯å¯ä»¥æƒ³è§åœ¨æ¯ä¸ªthreadçœ¼ä¸­å®ƒä»¬çš„è™šæ‹Ÿåœ°å€éƒ½æ˜¯ä¸€æ ·çš„ï¼Œä½†æ˜¯å®é™…ä¸Šä»–çš„ç‰©ç†åœ°å€éƒ½æ˜¯ä¸ä¸€æ ·çš„ï¼Œé‚£ä¹ˆä½¿ç”¨LDL&#x2F;STLå¯»å€çš„æ—¶å€™å¯èƒ½è¿˜è¦æ ¹æ®tidå’Œctaidçš„ä¸åŒåšä¸€äº›åç§»é‡çš„è½¬æ¢ï¼Œæ¥è¿›ä¸€æ­¥åŒºåˆ†å¯¹åº”çš„åœ°å€èŒƒå›´ã€‚æ¯”å¦‚è¯´æˆ‘ä»¬çš„æ‰€æœ‰local memoryæ˜¯åœ¨è™šæ‹Ÿåœ°å€å½“ä¸­çš„ä¸€ä¸ªå¤§æ•°ç»„ï¼Œä¾‹å¦‚ä¸€å…±32ä¸ªthreadï¼Œæ¯äºº32ä¸ªå­—ï¼Œé‚£ä¹ˆå°±æ˜¯<code>int lcoal[32][32]</code>ï¼Œäºæ˜¯ä¹å¯»å€å°±æ˜¯<code>base+threadIdx*scale+offset</code>ï¼Œå¯èƒ½æ˜¯è¿™æ ·ï¼Œç„¶åbaseã€scaleã€tidã€ctaidçš„å€¼éœ€è¦é¢å¤–çš„å¯„å­˜å™¨ä¾èµ–ã€‚å¦‚æœä¸è€ƒè™‘å¯»å€ä¸Šçš„å·®å¼‚ï¼Œè¿™ä¸ªlocal memoryçš„è®¿é—®æ“ä½œå’Œglobal memoryçš„è®¿é—®æ“ä½œæ˜¯ä¸€æ ·çš„ã€‚</p>
<h5 id="LDG-STGå’Œglobal-memory"><a href="#LDG-STGå’Œglobal-memory" class="headerlink" title="LDG&#x2F;STGå’Œglobal memory"></a>LDG&#x2F;STGå’Œglobal memory</h5><p>æ‰€æœ‰çš„blockå…±äº«global memoryï¼Œå½“ç„¶æ˜¯æŒ‡contextçš„page tableæŒ‡ç¤ºçš„é¡µè¡¨è™šæ‹Ÿåœ°å€ç©ºé—´å’Œè¢«å®é™…æ˜ å°„åˆ°çš„ç‰©ç†å†…å­˜ã€‚global memoryçš„æ•°æ®æ¯æ¬¡è¯»å–æ˜¯è¯»å–128ä¸ªå­—èŠ‚çš„ï¼Œå½“wrapä½¿ç”¨LDG&#x2F;STGè®¿å­˜global memoryçš„æ—¶å€™ï¼Œæ ¹æ®éœ€è¦çš„åœ°å€èŒƒå›´è¢«é‡æ–°æ’åˆ—ç»„ç»‡ä¸º128å­—èŠ‚ã€128å­—èŠ‚çš„ä»»åŠ¡ç³»åˆ—ï¼Œç„¶åä¾æ¬¡è®¿é—®ï¼Œæ¯æ¬¡è®¿é—®å¾€å¾€è¦32-64ä¸ªæ—¶é’Ÿå‘¨æœŸä»¥ä¸Šã€‚æ‰€ä»¥global memoryçš„æ•°æ®æœ€å¥½æ˜¯128å­—èŠ‚å¯¹é½çš„ï¼Œå¦‚æœä¸€ä¸ªLDGè¦è¯»å–çš„æ•°æ®åœ¨ä¸¤ä¸ª128å­—èŠ‚çš„åˆ—ä¸Šï¼Œé‚£ä¹ˆå°±ä¼šè¢«è®¾ç½®ä¸ºä¸¤ä¸ªè¯»å–äº‹åŠ¡ï¼Œè¯»çš„å°±ä¼šæ¯”è¾ƒæ…¢ã€‚</p>
<p>å¦‚æœLDG&#x2F;STGæŸ¥è¯¢é¡µè¡¨å‘ç°éœ€è¦è¯»å†™çš„æ•°æ®æ˜¯managedï¼Œè€Œä¸”æ²¡æœ‰åˆ†é…å°±éœ€è¦å¼•å‘page faultï¼Œç„¶åé‡æ–°åˆ†é…é¡µï¼›å¦‚æœæ•°æ®æ˜¯hostçš„ï¼Œé‚£ä¹ˆå°±éœ€è¦ä»CPUé‚£é‡ŒæŠŠæ•°æ®ç”¨pcieæ€»çº¿åè®®ä¼ é€’è¿‡æ¥ï¼›å¦‚æœæ•°æ®æ˜¯nilçš„å°±ä¼šè¯»å†™å¤±è´¥ï¼Œä½†æ˜¯å¹¶ä¸ä¼šæŠ¥é”™ï¼Œå‰©ä¸‹çš„è¯¥æ‰§è¡Œçš„è¿˜æ˜¯ä¼šæ‰§è¡Œçš„ï¼Œè™½ç„¶æœ€åå¾—åˆ°çš„æ•°æ®ä¹Ÿè®¸æ˜¯é”™è¯¯çš„ã€‚</p>
<p>æ‰€ä»¥LDGå’ŒSTGéœ€è¦çš„æ—¶é—´æ˜¯æ— æ³•å®ç°ç¡®å®šçš„ï¼Œéœ€è¦ä¸€äº›ç‰¹æ®Šçš„å¤„ç†æ‰‹æ®µã€‚æˆ‘ä»¬åœ¨åé¢ä»‹ç»å¦‚ä½•å¤„ç†æ•°æ®ç«äº‰çš„æ—¶å€™è®²è§£è¿™ä¸ªé—®é¢˜ã€‚</p>
<h5 id="LDCå’Œconstant-memory"><a href="#LDCå’Œconstant-memory" class="headerlink" title="LDCå’Œconstant memory"></a>LDCå’Œconstant memory</h5><p>constant memoryå’Œglobal memoryä¸æ˜¯åŒä¸€å—memoryï¼Œè¿™ä¸ªmemoryæ¯”è¾ƒç‰¹æ®Šï¼Œå®ƒå¯ä»¥å­˜å‚¨æ¥è‡ªcpuè®¾ç½®çš„æ•°æ®ï¼Œæ¯”å¦‚åç»­GPUç¨‹åºéœ€è¦ä½¿ç”¨çš„å¸¸é‡ï¼Œä½†æ˜¯æ— æ³•ä½¿ç”¨GPUè¿›è¡Œå†™ï¼Œå› ä¸ºGPUç¨‹åºçœ¼ä¸­è¿™é‡Œçš„æ•°æ®æ˜¯ç”¨æ¥è¯»çš„ï¼Œä¸å¯ä»¥å†™ã€‚è¯»context memoryçš„åœºæ™¯æœ‰å¾ˆå¤šç§ï¼Œå¯ä»¥ç”¨LDCæŒ‡ä»¤ç›´æ¥è¯»constant memoryçš„å€¼ï¼Œä¹Ÿå¯ä»¥åœ¨ç®—æœ¯æŒ‡ä»¤ä¸­æ“ä½œæ•°ç›´æ¥æŒ‡å®šconstant memoryçš„åœ°å€ã€‚è¿™æ˜¯å› ä¸ºå¯¹äºæ‰€æœ‰çš„threadè€Œè¨€ï¼Œå®ƒä»¬çš„åŒä¸€æ¡æŒ‡ä»¤å¾€å¾€æ˜¯è¯»åŒä¸€ä¸ªconstantåœ°å€çš„ï¼Œæ‰€ä»¥å…¶å®å¯¹äºconstantä¸€æ¬¡åªéœ€è¦è¯»å‡ºä¸€ä¸ªå­—å°±å¯ä»¥äº†ï¼Œç„¶åå¹¿æ’­ç»™æ‰€æœ‰çš„çº¿ç¨‹ï¼Œå½“ç„¶å¦‚æœæ˜¯ä¸åŒåœ°å€åŒä¸€bankï¼Œé‚£åªèƒ½ç­‰å¾…å†²çªè§£å†³ã€‚</p>
<p>constantåœ¨cudaç¼–ç¨‹çš„æ—¶å€™å¯ä»¥æ‰‹åŠ¨å£°æ˜ï¼Œæ¯”å¦‚<code>__const__</code>å®šä¹‰çš„æ•°æ®å°±ä¼šåœ¨ä¸€å¼€å§‹è¢«å®‰æ’åœ¨constantå†…å­˜ï¼Œåæ­£å¯¹äºæ‰€æœ‰çº¿ç¨‹å€¼éƒ½æ˜¯ä¸€æ ·çš„ã€‚é‚£ä¹ˆå¯¹äºconstç±»å‹çš„å˜é‡ï¼Œå¦‚æœä¸é€‚ç”¨å¸¸é‡åˆå§‹åŒ–çš„å¯èƒ½å°±ä¼šè¢«åˆ†é…åˆ°GPRæˆ–è€…local memoryï¼Œç„¶åä»…ä»…ç¼–è¯‘å™¨ç¡®ä¿ç¼–è¯‘æœŸé—´ä¸ä¼šè¢«è®¿é—®è€Œå·²ï¼Œä½†æ˜¯å¯èƒ½ä¼šè¢«ä¸€äº›æ¶æ„æ”»å‡»åœ¨è¿è¡Œæ—¶å†™å…¥ã€‚å…¶ä»–çš„ä¸€äº›å¸¸é‡ä¹Ÿå¯èƒ½ä¼šè¢«å†™å…¥constant memoryï¼Œæ¯”å¦‚å‡½æ•°çš„ä¼ å…¥å‚æ•°ã€gridDimã€blockDimç­‰å¸¸é‡å°±ä¼šè¢«ç”Ÿæˆåˆ°constant memoryå½“ä¸­å»ã€‚</p>
<p>constantåœ¨SASSä¸­å¾€å¾€æ˜¯ä»¥<code>c[0][0x100]</code>ï¼Œä¹Ÿå°±æ˜¯ç¬¬0bankçš„ç¬¬0x100ä¸ªå­—èŠ‚ä¹‹ç±»çš„ï¼Œä½†æ˜¯å¯ä»¥æƒ³åˆ°æ¯ä¸ªkerneléƒ½å¯èƒ½ä¼šä½¿ç”¨è¿™ä¸ª<code>c[0][0x100]</code>ï¼Œæ‰€ä»¥å®é™…çš„constant memoryä¹Ÿæ˜¯ç”¨è™šæ‹Ÿåœ°å€éœ€è¦è½¬æ¢è¿‡çš„ã€‚</p>
<h5 id="L2-cache"><a href="#L2-cache" class="headerlink" title="L2 cache"></a>L2 cache</h5><p>åœ¨æ‰€æœ‰çš„SMä¹‹å¤–ï¼Œglobal memoryä¹‹ä¸Šæœ‰ä¸€å—L2 cacheï¼Œå°±æ˜¯ç‰‡å¤–cacheã€‚å½“è®¿é—®global memoryçš„æ—¶å€™å¯ä»¥å…ˆè®¿é—®L2 cacheæ¥è·å¾—æ•°æ®ï¼Œè¿™ä¸ªè¿‡ç¨‹æ˜¯è‡ªåŠ¨çš„ï¼Œä¸æƒ³L1 cacheéœ€è¦æ‰‹åŠ¨ç®¡ç†ã€‚ä½†æ˜¯æ–°çš„GPUæä¾›äº†é…ç½®æ–¹æ³•ï¼Œå¯ä»¥æŒ‡å®šæŸäº›å†…å­˜èŒƒå›´è¢«L2ç¼“å­˜çš„æ¦‚ç‡ç­‰å› ç´ ï¼Œæ¥é˜²æ­¢å¤šä¸ªæ•°æ®è¢«åŒæ—¶è®¿é—®çš„æ—¶å€™å‘ç”Ÿcacheçš„æŠ¢å ï¼Œæœ€åå‘ç”Ÿcacheæ•°æ®çš„æ‰°åŠ¨ï¼Œä½¿å¾—æ•ˆç‡å¤§å¤§é™ä½ã€‚</p>
<h5 id="surface-memoryå’Œtexture-memory"><a href="#surface-memoryå’Œtexture-memory" class="headerlink" title="surface memoryå’Œtexture memory"></a>surface memoryå’Œtexture memory</h5><p>GPUå¯¹äºçº¹ç†æ˜ å°„ç­‰æ“ä½œæä¾›äº†ä¸“é—¨çš„texture memoryã€surface memoryå’Œæ•°æ®ç»“æ„æ¥è¿›è¡ŒåŠ é€Ÿï¼Œä¸è¿‡æœ¬äººä¸æ¸…æ¥šçº¹ç†æ˜ å°„æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œä¹Ÿä¸æ¸…æ¥štexture memoryå’Œsurface memoryæœ‰å•¥ç‰¹åˆ«ä¹‹å¤„ï¼Œæ‰€ä»¥å°±ä¸åœ¨è¿™é‡Œå±•å¼€äº†ã€‚å¯ä»¥ç”¨TEXæŒ‡ä»¤è¯»å–texture memoryï¼Œè¿™ä¸ªä»»åŠ¡ç”±texture fetchæ¨¡å—æ‰§è¡Œï¼Œsurface memoryä¹Ÿæœ‰å¯¹åº”çš„æŒ‡ä»¤å’Œå•å…ƒï¼Œå¯ä»¥ç”¨LDSU&#x2F;STSUè¿›è¡Œè¯»å†™ã€‚texture memoryåªè¯»ï¼Œä½†æ˜¯surface memoryå¯ä»¥å†™ã€‚</p>
<p>è®¿å­˜ç›¸å…³çš„éƒ¨åˆ†æŒ‡ä»¤ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>LD&#x2F;LDG</td>
<td>global memoryè½½å…¥</td>
</tr>
<tr>
<td>ST&#x2F;STG</td>
<td>gloabl memoryå­˜å‚¨</td>
</tr>
<tr>
<td>LDC</td>
<td>constant memoryè½½å…¥</td>
</tr>
<tr>
<td>LDL</td>
<td>local memoryè½½å…¥</td>
</tr>
<tr>
<td>STL</td>
<td>local memoryå­˜å‚¨</td>
</tr>
<tr>
<td>LDS</td>
<td>shared memoryè½½å…¥</td>
</tr>
<tr>
<td>STS</td>
<td>shared memoryå­˜å‚¨</td>
</tr>
<tr>
<td>TEX</td>
<td>texture memoryè®¿å­˜</td>
</tr>
<tr>
<td>LDSU</td>
<td>surface memoryè½½å…¥</td>
</tr>
<tr>
<td>STSU</td>
<td>surface memoryå­˜å‚¨</td>
</tr>
<tr>
<td>ATOM</td>
<td>åŸå­å†…å­˜æ“ä½œï¼Œæœ‰è¿”å›å€¼</td>
</tr>
<tr>
<td>RED</td>
<td>åŸå­å†…å­˜æ“ä½œï¼Œæ²¡æœ‰è¿”å›å€¼</td>
</tr>
</tbody></table>
<p>â€‹	ç¨å¾®è§£é‡Šä¸€ä¸‹REDå’ŒATOMçš„åŒºåˆ«ã€‚ATOMå°±æ˜¯åŸå­å†…å­˜æ“ä½œï¼Œå¯ä»¥åšåŸå­å†™ã€åŠ ã€äº¤æ¢ç­‰æ“ä½œï¼Œç„¶åå¯ä»¥è¿”å›ä¸€ä¸ªè¿”å›å€¼ï¼Œæ¯”å¦‚åŸå­åŠ çš„ç»“æœï¼ŒåŸå­äº¤æ¢çš„ç»“æœï¼Œä½†æ˜¯æœ‰æ—¶å€™æˆ‘ä»¬å¯èƒ½ä¸éœ€è¦è¿”å›å€¼ï¼Œè¿™ä¸ªæ—¶å€™å°±å¯ä»¥ç”¨REDï¼Œè¿™è¢«ç§°ä¸ºreduceæ“ä½œï¼Œä»–åœ¨å’Œå†…å­˜äº¤äº’å®Œä¹‹åä¸è¿”å›ç»“æœï¼Œæ¯”å¦‚åŠ ä¸€ä¸ªæ•°ä¹‹åä¸è¿”å›å’Œï¼Œè¿™æ ·å°±æ¯”ATOMåšçš„äº‹æƒ…æ›´å°‘ï¼Œé‚£ä¹ˆæ•ˆç‡æ›´é«˜ï¼Œä¹Ÿä¸å®¹æ˜“å‘ç”Ÿä»€ä¹ˆè¯»å†™å†²çªã€‚</p>
<p>æˆ‘ä»¬æ€»ç»“ä¸€ä¸‹må„ä¸ªmemoryçš„ç‰¹æ€§ï¼š</p>
<table>
<thead>
<tr>
<th>å­˜å‚¨å•å…ƒ</th>
<th>ä½ç½®</th>
<th>æ˜¯å¦cache</th>
<th>è®¿å­˜é€Ÿåº¦</th>
<th>æ˜¯å¦å¯å†™</th>
<th>å…±äº«èŒƒå›´</th>
</tr>
</thead>
<tbody><tr>
<td>GPR</td>
<td>on chip</td>
<td>NA</td>
<td>å¿«</td>
<td>yes</td>
<td>thread</td>
</tr>
<tr>
<td>shared memory</td>
<td>on chip</td>
<td>NA</td>
<td>è¾ƒå¿«</td>
<td>yes</td>
<td>block</td>
</tr>
<tr>
<td>local memory</td>
<td>off chip</td>
<td>no</td>
<td>æ…¢</td>
<td>yes</td>
<td>thread</td>
</tr>
<tr>
<td>global memory</td>
<td>off chip</td>
<td>yes</td>
<td>æ…¢</td>
<td>yes</td>
<td>grid</td>
</tr>
<tr>
<td>constant memory</td>
<td>off chip</td>
<td>yes</td>
<td>ä¸­</td>
<td>no</td>
<td>grid</td>
</tr>
<tr>
<td>texture memory</td>
<td>off chip</td>
<td>yes</td>
<td>ä¸­</td>
<td>no</td>
<td>grid</td>
</tr>
</tbody></table>
<p>â€‹	ä¸‹å›¾ä¸ºmemoryçš„å±‚æ¬¡ç»“æ„å›¾ï¼š<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/memory.jpg" alt="å±‚æ¬¡ç»“æ„å›¾"></p>
<h4 id="æ§åˆ¶æµæŒ‡ä»¤"><a href="#æ§åˆ¶æµæŒ‡ä»¤" class="headerlink" title="æ§åˆ¶æµæŒ‡ä»¤"></a>æ§åˆ¶æµæŒ‡ä»¤</h4><p>æˆ‘ä»¬ä¹‹å‰æåˆ°ï¼Œwrapçš„32ä¸ªthreadæ¯æ¬¡è¿è¡Œçš„æ˜¯åŒä¸€æ¡æŒ‡ä»¤çš„ï¼Œé‚£ä¹ˆå¦‚æœæˆ‘ä»¬é‡åˆ°äº†if-elseè¿™æ ·çš„æ“ä½œï¼Œæˆ‘ä»¬æœ‰çš„threadå¯ä»¥æ»¡è¶³æ¡ä»¶éœ€è¦è¿è¡Œï¼Œæœ‰çš„threadä¸æ»¡è¶³æ¡ä»¶ä¸èƒ½è¿è¡Œï¼Œé‚£æˆ‘ä»¬è¦æ€ä¹ˆè®©æœ‰çš„threadè¿è¡Œï¼Œæœ‰çš„threadä¸è¿è¡Œå‘¢ï¼Ÿæˆ‘ä»¬ä»‹ç»ä¸‰ç§æ–¹æ³•ï¼Œä¸è¿‡å¯èƒ½æœ‰äº›é€€å‡ºå†å²èˆå°äº†ã€‚</p>
<h5 id="predicateå¯„å­˜å™¨å’ŒpredicateæŒ‡ä»¤"><a href="#predicateå¯„å­˜å™¨å’ŒpredicateæŒ‡ä»¤" class="headerlink" title="predicateå¯„å­˜å™¨å’ŒpredicateæŒ‡ä»¤"></a>predicateå¯„å­˜å™¨å’ŒpredicateæŒ‡ä»¤</h5><p>GPUæä¾›äº†ä¸€ç»„ä¸€ä½çš„è°“è¯å¯„å­˜å™¨ç»„ï¼Œç§°ä¹‹ä¸ºpredicate registerï¼Œä¸€å…±æä¾›äº†8ä¸ªç¼–å·ï¼Œå‰é¢çš„p0-p6æ˜¯æ­£å¸¸çš„å¯„å­˜å™¨ï¼Œp7æ—¶pTå°±æ˜¯æ’ç­‰äºtrueã€‚å¯ä»¥ä½¿ç”¨ä¸€äº›é€»è¾‘æŒ‡ä»¤æˆ–è€…åˆ«çš„æŒ‡ä»¤è®¾ç½®p0-p6å¯„å­˜å™¨çš„å€¼ï¼Œè®¡ç®—å¯ä»¥ä½¿ç”¨GPRã€predicateã€immã€constantç­‰ã€‚æ­¤å¤–predicateè¿˜å¯ä»¥ç”¨äºæ•´æ•°çš„è®¡ç®—ï¼Œæ¯”å¦‚predicateå……å½“è¿›ä½ï¼Œç„¶åå¯ä»¥é…åˆaddå®ç°x86çš„adcçš„åŠŸèƒ½ã€‚å¸¸è§çš„æŒ‡ä»¤æœ‰</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>SETP.EQ</td>
<td>è¿›è¡Œç­‰äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.NE</td>
<td>è¿›è¡Œä¸ç­‰äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.LT</td>
<td>è¿›è¡Œå°äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.LE</td>
<td>è¿›è¡Œå°äºç­‰äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.GT</td>
<td>è¿›è¡Œå¤§äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.GE</td>
<td>è¿›è¡Œå¤§äºç­‰äºè®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.AND</td>
<td>è¿›è¡Œä¸è®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>SETP.OR</td>
<td>è¿›è¡Œæˆ–è®¡ç®—ï¼Œç„¶åè®¾ç½®predicateå€¼</td>
</tr>
<tr>
<td>R2P</td>
<td>å°†GPRå€¼èµ‹å€¼predicate</td>
</tr>
<tr>
<td>P2R</td>
<td>å°†predicateå€¼èµ‹å€¼GPR</td>
</tr>
</tbody></table>
<p>è¿™äº›æŒ‡ä»¤éƒ½æ˜¯å¾ˆå®¹æ˜“ç†è§£çš„ï¼Œå’ŒCPUçš„æ¯”è¾ƒå•å…ƒæ²¡ä»€ä¹ˆæœ¬è´¨çš„åŒºåˆ«ï¼Œå…³é”®æ˜¯å®ƒçš„ä½¿ç”¨ã€‚å¯¹äºæ¯ä¸€æ¡æŒ‡ä»¤ï¼Œæˆ‘ä»¬å¯ä»¥ç”¨ä¸€ä¸ª@Pxçš„ä¿®é¥°ç¬¦æ¥æŒ‡å®šï¼Œè¯¥æŒ‡ä»¤åªæœ‰åœ¨Pxä¸ºçœŸçš„æƒ…å†µä¸‹æ‰ä¼šè¿è¡Œï¼Œ@!Pxåˆ™æ˜¯ä¸ºå‡æ‰è¿è¡Œã€‚æ‰€ä»¥å¯¹äºå¦‚ä¸‹çš„if-elseè¯­å¥ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(R0==R1)&#123;</span><br><span class="line">    R0+=<span class="number">1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    R1+=<span class="number">1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°SASSæ±‡ç¼–ä¸º</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SETP.EQ P0,R0,R1</span><br><span class="line">@P0 IADD R0,R0,1</span><br><span class="line">@!P0 IADD R1,R1,1</span><br></pre></td></tr></table></figure>
<p>å¦‚æœåªæ˜¯ç®€å•çš„if-elseç­‰æŒ‡ä»¤å°±å¯ä»¥ä½¿ç”¨è¿™æ ·çš„æ–¹å¼è¿›è¡Œï¼Œä¸€ä¸ªwrapä¸­çš„32ä¸ªthreadæ»¡è¶³æ¡ä»¶çš„å°±ä¼šåœ¨P0çš„æ§åˆ¶ä¸‹è¿è¡Œï¼Œä¸æ»¡è¶³æ¡ä»¶çš„å°±ä¸è¿è¡Œã€‚è¿™å°±ç±»ä¼¼äºARMçš„æ¡ä»¶æ‰§è¡ŒæŒ‡ä»¤ï¼Œå’Œx86çš„æ¡ä»¶æ‰§è¡ŒæŒ‡ä»¤ã€‚predicateçš„æ§åˆ¶æ–¹æ³•å…¶å®åªæ˜¯æŠŠæ“ä½œçš„å†™å›æ“ä½œåˆ é™¤æ‰ï¼Œå³ä½¿è¿™ä¸ªæ“ä½œçš„threadæ˜¯Px&#x3D;&#x3D;falseçš„ï¼Œå®ƒå¯¹åº”çš„coreè¿˜æ˜¯ä¼šæ‰§è¡Œè¿ç®—ï¼Œåªæ˜¯è¿ç®—çš„ç»“æœä¸ä¼šå†™å›è€Œå·²ï¼Œè¿˜æ˜¯è¦æ¶ˆè€—èƒ½æºçš„ã€‚ä½†æ˜¯å¦‚æœif-elseèƒŒåçš„æŒ‡ä»¤çŸ­å°ç²¾æ‚ï¼Œé‚£ä¹ˆç”¨è¿™ä¸ª@P0çš„æ–¹æ³•è¿˜æ˜¯å¾ˆå¥½çš„ï¼Œåœ¨x86ç­‰æ“ä½œä¸­å¯¹äºif-elseç”¨æ¡ä»¶æ‰§è¡Œç®€å•æŒ‡ä»¤ç»„åˆä»£æ›¿è·³è½¬ï¼Œä¹Ÿæ˜¯å¸¸è§çš„æŠµæ¶ˆåˆ†æ”¯é¢„æµ‹ä»£ä»·çš„æ“ä½œï¼Œæ›´ä¸è¦è¯´GPUä¸€æ—¦åˆ†æ”¯è·³è½¬æ¸…ç©ºæµæ°´çº¿çš„ä»£ä»·ä¼šæ›´å¤§ã€‚</p>
<p>7ä¸ªpredicateæ˜¯å¯ä»¥æ»¡è¶³æ‰€æœ‰çš„åˆ†æ”¯çš„å¤æ‚æƒ…å†µçš„ã€‚ä¸€ä¸ªpredicateå¯ä»¥è¡¨ç¤ºä¸¤ç§çŠ¶æ€ï¼Œ6ä¸ªpredicateå°±è¶³ä»¥è¡¨ç¤º32ä¸ªçŠ¶æ€ï¼Œæˆ‘ä»¬çš„if-elseæ— è®ºå¤šä¹ˆçš„å¤æ‚ï¼Œæœ€å¤šä¹Ÿå°±32ç§åˆ†æ”¯ï¼Œé‚£ä¹ˆä¹Ÿè¶³å¤Ÿåˆ†æ•£è¡¨ç¤ºæ¯ä¸ªçš„æ‰§è¡Œæµäº†ï¼Œæä¾›ä¸€ç§ç®€å•çš„æ–¹æ³•ï¼šä¸€å¼€å§‹æ‰€æœ‰çš„å¯„å­˜å™¨éƒ½æ˜¯0ï¼Œåœ¨ç¬¬ä¸€æ¬¡åˆ†æµçš„æ—¶å€™æ»¡è¶³æ¡ä»¶çš„å¯„å­˜å™¨è®¾ç½®ä¸º1ï¼›ç¬¬Næ¬¡åˆ†æµçš„æ—¶å€™ï¼Œæ»¡è¶³æ¡ä»¶çš„å¯„å­˜å™¨ä½¿ç”¨<code>SETP.COND.AND PN,R0,R1,R{N-1}</code>æŒ‡ä»¤å°±å¯ä»¥è¿›ä¸€æ­¥åˆ†æµï¼ŒPNåªæ˜¯äº†å½“å‰æ»¡è¶³æ¡ä»¶çš„threadã€‚å½“è¿›å…¥ä¸‹ä¸€ä¸ªåˆ†æ”¯çš„æ—¶å€™å°±å¯ä»¥ä½¿ç”¨<code>SETP.NE.AND PN,PN,PT,R{N-1}</code>æ¥ä½¿èƒ½ç¬¬Næ¬¡åˆ†æµçš„ä¸‹ä¸€ä¸ªåˆ†æ”¯ã€‚ä»¥æ­¤ç±»æ¨ã€‚ä¸è¿‡å¦‚æœåªå‰©ä¸‹ä¸€ä¸ªæµçš„æ—¶å€™å°±è¦åŠ ä»¥åˆ†è¾¨é€‰æ‹©ç›´æ¥è·³è¿‡ï¼Œä¸ç„¶çš„è¯å°±è¦è¿è¡Œæ²¡æœ‰ä¸€ä¸ªæµçš„ä»£ç ï¼Œè™½ç„¶ä¹Ÿä¸æ˜¯ä¸å¯ä»¥ã€‚</p>
<p>å¯¹äºpredicateæœ‰ä¸€ç§ä½¿ç”¨æŠ€å·§ï¼Œæ¯”å¦‚æˆ‘ä»¬çš„ä¼ªCä»£ç æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight c++"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span>(R0==R1)&#123;</span><br><span class="line">    mem[R1]=mem[R1]<span class="number">+1</span>;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    mem[R0]=mem[R0]<span class="number">+1</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>ç›´æ¥å†™æˆpredicateçš„æ–¹æ³•å°±æ˜¯è¿™æ ·çš„ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SETP.EQ P0,R0,R1</span><br><span class="line">@P0 LDG R3,[R1]</span><br><span class="line">@P0 IADD R3,R3,1</span><br><span class="line">@P0 STD R3,[R1]</span><br><span class="line">@!P0 LDG R4,[R0]</span><br><span class="line">@!P0 IADD R4,R4,1</span><br><span class="line">@!P0 STG R4,[R0]</span><br></pre></td></tr></table></figure>
<p>ä½†æˆ‘ä»¬å¯ä»¥æ”¹æˆè¿™æ ·</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SETP.EQ P0,R0,R1</span><br><span class="line">@P0 LDG R3,[R1]</span><br><span class="line">@!P0 LDG R4,[R0]</span><br><span class="line">@P0 IADD R3,R3,1</span><br><span class="line">@!P0 IADD R4,R4,1</span><br><span class="line">@P0 STD R3,[R1]</span><br><span class="line">@!P0 STG R4,[R0]</span><br></pre></td></tr></table></figure>
<p>åˆ†æ”¯1çš„LDGåœ¨è¿›è¡Œè®¿å­˜çš„æ—¶å€™ï¼Œéœ€è¦ç­‰å¾…ï¼Œä¹Ÿè®¸åˆ†æ”¯2çš„éƒ¨åˆ†æŒ‡ä»¤å¯ä»¥å…ˆè¡Œä¸€æ­¥å¼€å§‹å¹¶è¡Œï¼Œé‚£ä¹ˆåœ¨åˆ†æ”¯1ç­‰å¾…çš„æ—¶å€™ï¼Œå°±å¯ä»¥å…ˆä¸€æ­¥è¿è¡Œåˆ†æ”¯2çš„æŒ‡ä»¤ï¼Œå¦‚æ­¤äº¤æ›¿æ‰§è¡Œå°±å¯ä»¥æ¯”è¾ƒå¥½çš„åˆ©ç”¨ä¸åŒåˆ†æ”¯ä¸ç›¸å†²çªçš„æŒ‡ä»¤è®©ä»–ä»¬å……åˆ†å¹¶è¡Œèµ·æ¥ï¼Œç›¸å¯¹äºæ‰€è°“çš„é®ç›–æ—¶å»¶ï¼Œæˆ‘æ›´æ„¿æ„ä½¿ç”¨å……åˆ†å¹¶è¡Œè¿™ä¸ªè¯æ¥æŒ‡ä»£è¿™ä¸ªæ€æƒ³ã€‚</p>
<h5 id="branch-synchronization-stack"><a href="#branch-synchronization-stack" class="headerlink" title="branch synchronization stack"></a>branch synchronization stack</h5><p>ç›¸å¯¹äºåˆ†æ”¯ä¸€å¤æ‚ï¼Œpredicateè¦äººå·¥æ„é€ å±‚æ¬¡ï¼Œbranch synchronization stackå°±å¯ä»¥äººå·¥æ„é€ å±‚æ¬¡ã€‚å½“è¦ç¬¬ä¸€æ¬¡if-elseåˆ†æµçš„æ—¶å€™ï¼Œè®¡ç®—å¯¹åº”çš„P0ï¼Œç„¶åä½¿ç”¨pushä¿®é¥°ç¬¦å°±å¯ä»¥æŠŠè¿™ä¸€ç»„çš„P0ä¿å­˜åˆ°branch synchronization stackå½“ä¸­ï¼Œè¿™ä¸ªstackå½±å“çš„å°±ä¸æ˜¯å†™å›çš„wenä¿¡å·äº†ï¼Œè€Œæ˜¯ç›´æ¥å½±å“threadçš„activeä¿¡å·ï¼Œè¿™æ ·åªæœ‰çœŸæ­£è¦è¿è¡Œçš„threadæ‰ä¼šçœŸæ­£è®©coreå·¥ä½œï¼Œæ¯”è¾ƒèŠ‚çº¦èƒ½æºã€‚ä¹‹åå†ä¸€æ¬¡éœ€è¦åˆ†æµçš„æ—¶å€™ï¼Œé‚£ä¹ˆåœ¨è®¾ç½®ä¸€æ¬¡P0ï¼Œå†æ¬¡pushå³å¯ã€‚ç­‰è¿™ä¸ªåˆ†æ”¯è¿è¡Œå®Œï¼Œéœ€è¦è¿è¡Œä¸‹ä¸€ä¸ªåˆ†æ”¯çš„æ—¶å€™ï¼Œä¿®é¥°ç¬¦æ‰§è¡Œcomplementï¼Œstackçš„activeå–åï¼Œé‚£ä¹ˆå¦å¤–ä¸€åŠçš„çº¿ç¨‹å¼€å§‹å·¥ä½œï¼›ç­‰åˆ†æ”¯åˆæµçš„æ—¶å€™å°±ä¿®é¥°ç¬¦æ‰§è¡Œpopï¼Œé‚£ä¹ˆæ‰€æœ‰çº¿ç¨‹è¿”å›ä¸Šä¸€ä¸ªåˆ†æµçš„é›†åˆç»§ç»­å·¥ä½œã€‚ç›¸å¯¹äºpredicateçš„æ‰‹åŠ¨ç®¡ç†ï¼Œstackæä¾›äº†å¦ä¸€ç»„ç¡¬ä»¶ï¼Œå¯ä»¥è‡ªåŠ¨ç®¡ç†ï¼Œè€Œä¸”ä¸å ç”¨predicateçš„èµ„æºï¼Œæ¯”predicateä¼šé«˜æ•ˆä¸€äº›ã€‚å› ä¸ºä¸€ä¸ªwrapåªæœ‰32ä¸ªthreadï¼Œæ‰€ä»¥å¯ä»¥å‹å…¥6ä¸ªstackå°±è¶³å¤Ÿäº†ï¼Œæ­¤å¤–stackéœ€è¦å¯ä»¥åˆ†è¾¨æ˜¯ä¸æ˜¯åªæœ‰0ä¸ªthreadäº†ï¼Œå¦‚æœæ˜¯çš„è¯è¦å¯ä»¥æ˜æ™ºçš„é€‰æ‹©è·³è¿‡ã€‚ä½†æ˜¯branch synchronization stackæœ¬è´¨ä¸Šå¹¶ä¸æ¯”predicateæ›´å…ˆè¿›ï¼Œå› ä¸ºä»–è¿˜æ˜¯ä¸€éƒ¨åˆ†ç­‰å¾…ï¼Œå¦ä¸€éƒ¨åˆ†ç»§ç»­æ‰§è¡Œã€‚branch synchronization stackä¹Ÿå¯ä»¥æƒ³predicateé‚£æ ·äº¤é”™æ‰§è¡Œä¸¤ä¸ªåˆ†æ”¯ï¼Œåªè¦ä»–è¿”å›complement stack topå°±å¯ä»¥äº†ã€‚<br>ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SETP.EQ P0,R0,R1</span><br><span class="line">*PUSH</span><br><span class="line">LDG R3,[R1]</span><br><span class="line">IADD R3,R3,1</span><br><span class="line">STD R3,[R1]</span><br><span class="line">*COMPLEMENT</span><br><span class="line">LDG R4,[R0]</span><br><span class="line">IADD R4,R4,1</span><br><span class="line">STG R4,[R0]</span><br><span class="line">*POP</span><br></pre></td></tr></table></figure>

<h5 id="SSY-SYNCæœºåˆ¶"><a href="#SSY-SYNCæœºåˆ¶" class="headerlink" title="SSY+SYNCæœºåˆ¶"></a>SSY+SYNCæœºåˆ¶</h5><p>åœ¨GPUç§wrapçš„åˆ†æµå’Œåˆæµæ“ä½œè‹±æ–‡ç§°ä¹‹ä¸ºDivergence and Convergenceã€‚ç›¸å¯¹äºå‰é¢çš„å…ˆå·¦ä¾§æˆ–è€…å…ˆå³ä¾§ï¼Œä»–æ¯”è¾ƒç‰¹åˆ«ï¼Œæˆ‘ä¸å¤ªæ¸…æ¥šä»–çš„ç¡¬ä»¶å»ºæ¨¡æ˜¯ä»€ä¹ˆæ ·å­çš„ï¼Œä½†æ˜¯å¯ä»¥ç›´æ¥è®²ä¸€ä¸‹å®ƒçš„æ„æ€ã€‚é¦–å…ˆæˆ‘ä»¬çŸ¥é“ä»£ç åœ¨0x100ä¹‹åè¦åˆ†æµï¼Œä¼šåœ¨ç¬¬0x200çš„åœ°æ–¹åˆæµï¼Œæ‰€ä»¥æˆ‘ä»¬åœ¨0x100ä¹‹å‰çš„æŸä¸ªä½ç½®æ¯”å¦‚0x80åŠ å…¥ä¸€æ¡<code>SSY 0x200</code>ï¼ŒæŒ‡ç¤ºåœ¨0x200çš„åœ°æ–¹ä¼šåˆæµï¼Œç„¶ååœ¨0x200çš„åœ°æ–¹åŠ å…¥ä¸€æ¡SYNCã€‚ç„¶åwrapåˆ†æµä¹‹åå°±ä¼šè‡ªåŠ¨å°†ä¸¤ä¸ªåˆ†æµéƒ¨åˆ†å½“ä½œä¸¤ä¸ªwrapé‚£æ ·è¿›è¡Œäº¤é”™è°ƒåº¦æ‰§è¡Œï¼Œç›´åˆ°ä¸€æ–¹æ‰§è¡Œåˆ°0x200çš„SYNCçš„æ—¶å€™å°±ä¼šè‡ªåŠ¨æš‚åœç­‰å¾…ï¼Œç­‰æ‰€æœ‰çš„æŒ‡ä»¤éƒ½åˆ°äº†0x200çš„æ—¶å€™ï¼Œå°±å¯ä»¥ç»§ç»­æ‰§è¡Œäº†ã€‚ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">0x80  SSY 0x200</span><br><span class="line">....</span><br><span class="line">0x100 @P0 BRA 0x150</span><br><span class="line">0x108 ADD R0,R0,1</span><br><span class="line">....</span><br><span class="line">0x148 BRA 0x200</span><br><span class="line">0x150 ADD R0,R0,1</span><br><span class="line">....</span><br><span class="line">0x200 SYNC</span><br></pre></td></tr></table></figure>

<p>æ‰§è¡Œçš„å›¾å°±ä»åŸæ¥çš„if-elseæ¨¡å¼å˜ä¸ºäº†ä¸‹å›¾çš„ssy-syncæ¨¡å¼ï¼š<br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/if-else.webp" alt="if-else"><br><img src="https://zhuzhuzaiimgbed.oss-cn-hangzhou.aliyuncs.com/img/ssy-sync.jpg" alt="ssy-sync"></p>
<p>å¸¸è§çš„æ§åˆ¶æµæŒ‡ä»¤æœ‰ï¼š</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>BRA</td>
<td>ç›¸å¯¹åç§»åœ°å€è·³è½¬ï¼Œç±»ä¼¼branch</td>
</tr>
<tr>
<td>BRK</td>
<td>breakè·³å‡ºå¾ªç¯</td>
</tr>
<tr>
<td>BRX</td>
<td>è·³åˆ°ç›¸å¯¹ç´¢å¼•åœ°å€ï¼Œswitché‚£ç§è·³</td>
</tr>
<tr>
<td>CAL</td>
<td>callå‡½æ•°è°ƒç”¨ï¼Œç›¸å¯¹åœ°å€</td>
</tr>
<tr>
<td>JCAL</td>
<td>callå‡½æ•°è°ƒç”¨ï¼Œç»å¯¹åœ°å€</td>
</tr>
<tr>
<td>RET</td>
<td>returnè¿”å›å‡½æ•°è°ƒç”¨</td>
</tr>
<tr>
<td>JMP</td>
<td>è·³åˆ°ç»å¯¹åœ°å€</td>
</tr>
<tr>
<td>CONT</td>
<td>continue</td>
</tr>
<tr>
<td>EXIT</td>
<td>ç»“æŸç¨‹åº</td>
</tr>
<tr>
<td>SSY</td>
<td>è®¾ç½®åˆ†æµçš„åŒæ­¥ç‚¹</td>
</tr>
<tr>
<td>BPT</td>
<td>æ‰“æ–­ç‚¹</td>
</tr>
</tbody></table>
<p>å…·ä½“çš„ç¡¬ä»¶å®ç°ç»†èŠ‚å…¶å®éš¾ä»¥è€ƒå¯Ÿï¼Œè™½ç„¶è¯´ç¼–å†™__global__ç¨‹åºçš„æ—¶å€™å¯ä»¥è°ƒç”¨__device__çš„ç¨‹åºï¼Œä½†æ˜¯ä¸€èˆ¬æ¥è¯´__device__çš„ç¨‹åºéƒ½æ˜¯ç›´æ¥inlineåˆ°__global__ç¨‹åºå½“ä¸­å»çš„ï¼Œæ‰€ä»¥æ²¡æœ‰é‡åˆ°è¿‡ï¼›å¯¹äºé€’å½’è°ƒç”¨æ˜¯ä¼šè¢«è½¬æ¢ä¸ºå¾ªç¯çš„æ¨¡å¼çš„ï¼Œåæ­£å¯ä»¥ç”¨å †æ ˆè§£å†³è¿™ä¸ªé—®é¢˜ï¼Œä½†æ˜¯å¼€é”€å¾ˆå¤§ï¼Œä¸æå€¡ä½¿ç”¨ï¼›å¯¹äºCALLå’ŒRETé‚£ä¹ˆä¼šä¸ä¼šæœ‰å¯¹åº”çš„stackï¼Œæ˜¯ä½¿ç”¨local memoryå—ï¼Ÿ</p>
<p>å¯¹äºå‡½æ•°è°ƒç”¨æ˜¯å¯ä»¥è°ƒç”¨Cçš„å‡½æ•°çš„ï¼Œä»–ä¼šæŠŠä»»åŠ¡å‘è¿˜ç»™CPUï¼Œç­‰CPUè¿è¡Œå®Œåœ¨æŠŠç»“æœè¿”å›å›å»ï¼Œå…¶ä¸­çš„ç»†èŠ‚ä¹Ÿæœ‰å¾…æ·±ç©¶ï¼Œæ¯”å¦‚å¯ä»¥æ‰§è¡Œprintfï¼›BRXè¿™ç§æ¯ä¸ªthreadè·³è½¬åˆ°ä¸åŒåœ°å€çš„æƒ…å†µå°±å¾ˆå¤æ‚ï¼Œä¸çŸ¥é“æ€ä¹ˆå¤„ç†åˆ†æµï¼Œè€ƒè™‘åˆ°ç°åœ¨æ¯ä¸€ä¸ªthreadéƒ½æœ‰è‡ªå·±çš„PCäº†ï¼Œéš¾é“çœŸçš„å¯ä»¥ä»¥threadä¸ºå•ä½è¿›è¡Œè°ƒåº¦ï¼Ÿç¼–ç¨‹å¾—åˆ°çš„SASSå°±æ˜¯SSY+SYNCï¼Œéš¾é“åªè¦SSYä¹‹åï¼Œæ‰€æœ‰çš„threadå°±éƒ½è‡ªç”±äº†ï¼Œå¯ä»¥è‡ªç”±è°ƒåº¦äº†å—ï¼Ÿ</p>
<p>BRKå’ŒCONTæ˜¯ä¸ä¼šåé¢è·Ÿéšåœ°å€çš„ï¼Œæ‰€ä»¥åœ°å€å­˜åœ¨å“ªé‡Œï¼Œéš¾é“æ˜¯branch synchronization stackå—ï¼Ÿä»–å¯ä»¥ç¡®å®šBRKçš„åœ°å€ï¼Œä½†æ˜¯å¯¹äºCONTæ˜¯æ€ä¹ˆåšåˆ°çš„å‘¢ï¼Ÿ</p>
<p>è¿™äº›é—®é¢˜éƒ½æ˜¯å­˜ç–‘çš„ã€‚</p>
<h4 id="uniformæŒ‡ä»¤"><a href="#uniformæŒ‡ä»¤" class="headerlink" title="uniformæŒ‡ä»¤"></a>uniformæŒ‡ä»¤</h4><p>ä¸€ä¸ªwrapè™½ç„¶æœ‰32ä¸ªthreadï¼Œä»–ä»¬å¯èƒ½æœ‰ä¸€éƒ¨åˆ†æŒ‡ä»¤æ¯æ¬¡è®¡ç®—çš„å†…å®¹éƒ½æ˜¯ä¸€æ ·çš„ï¼Œæ¯”å¦‚è¯»å–ä¸€ä¸ªconstant memoryçš„å€¼ï¼Œç„¶åå¯¹ä»–åšä¸€äº›åŠ å‡ä¹˜é™¤ï¼Œå¯¹äºè¿™32ä¸ªthreadè€Œè¨€ï¼Œè¿™ä»–ä»¬è®¡ç®—çš„æ•°æ®æµã€ç›¸å…³çš„æ§åˆ¶æµéƒ½æ˜¯å®Œå…¨ä¸€æ ·çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬æ˜¯ä¸æ˜¯å¯ä»¥è¿™æ ·ï¼šè¿™éƒ¨åˆ†æŒ‡ä»¤åªè¦æœ‰ä¸€ä¸ªçº¿ç¨‹è®¡ç®—å°±å¯ä»¥äº†ï¼Œå…¶ä»–çš„çº¿ç¨‹æ‹¿ä¸€ä¸‹å¯¹åº”çš„ç»“æœå°±å¯ä»¥äº†ã€‚äºæ˜¯uniformå¤„ç†å•å…ƒå’ŒuniformæŒ‡ä»¤é›†å°±åº”è¿è€Œç”Ÿäº†ã€‚</p>
<p>cudaç¼–ç¨‹çš„æ—¶å€™æ²¡æ³•æŒ‡å®šé‚£äº›éƒ¨åˆ†ä½¿ç”¨uniformæŒ‡ä»¤ï¼Œé™¤éå†…è”æ±‡ç¼–ï¼Œä½†æ˜¯cudaçš„ç¼–è¯‘å™¨ä¼šæ£€æµ‹å“ªäº›éƒ¨åˆ†æ˜¯æ‰€æœ‰çš„threadå…±æœ‰çš„ï¼Œç„¶åæŠŠå®ƒè½¬åŒ–ä¸ºuniformæŒ‡ä»¤ï¼Œå¦‚æœæ•°æ®æµå’Œæ§åˆ¶æµæ˜¯æ¯ä¸ªthreadäº’å¼‚çš„ï¼Œé‚£ä¹ˆå°±ç»§ç»­ä¿æŒåŸæ¥çš„æŒ‡ä»¤ã€‚å¯¹åº”çš„æˆ‘ä»¬çš„ç¡¬ä»¶ä¹Ÿæä¾›äº†ä¸€å¥—uniformä¸“ç”¨çš„registerã€predicate regisyerã€coreç­‰ï¼Œç°åœ¨æˆ‘ä»¬æ¢ä¸€ä¸ªè§†è§’ï¼Œæˆ‘ä»¬çš„SMåŒ…å«å¤§å—GPR+32ä¸ªcoreçš„ä¸€å¥—å¹¶è¡Œç”µè·¯å’Œå°å‹çš„registerç»„+1ä¸ªcoreçš„å°å‹uniformç”µè·¯ï¼Œç„¶åä¸€ä¸ªwrapå¼€å§‹æ‰§è¡Œï¼Œæ‰€æœ‰threadå…±ç”¨çš„æŒ‡ä»¤äº¤ç»™uniformæ‰§è¡Œï¼Œä¸å…¬ç”¨çš„éƒ¨åˆ†äº¤ç»™æ­£å¸¸çš„coreæ‰§è¡Œï¼Œå¦‚æ˜¯è€Œå·²ã€‚</p>
<p>æ­¤å¤–è¿˜éœ€è¦æœ‰æŒ‡ä»¤å¯ä»¥è¯»å–uniformçš„å¯„å­˜å™¨åˆ°GPRä¸­ï¼Œæˆ–è€…GPRè®¡ç®—çš„æ—¶å€™ç›´æ¥ä½¿ç”¨uniformçš„å¯„å­˜å™¨ï¼Œè¿™ä¸ªæ“ä½œå¾ˆç®€å•ï¼Œåªè¦å‘é€ä¸€æ¡æŒ‡ä»¤ï¼Œç„¶åuniformå¯¹åº”å¯„å­˜å™¨çš„å€¼å¹¿æ’­åˆ°æ¯ä¸ªthreadçš„å¯„å­˜å™¨ç»„æˆ–è€…coreå³å¯ï¼Œé‚£ä¹ˆè‡ªç„¶æ²¡æœ‰åŠæ³•ä»GPRä¼ é€’æ•°æ®åˆ°uniformï¼Œå› ä¸º32ä¸ªthreadçš„32ä¸ªæ•°ä¼ åˆ°uniformçš„ä¸€ä¸ªå¯„å­˜å™¨æ˜¯åšä¸åˆ°çš„ï¼Œä¹Ÿæ˜¯æ²¡æ„ä¹‰çš„ã€‚</p>
<h4 id="åŒæ­¥å’Œé€šä¿¡"><a href="#åŒæ­¥å’Œé€šä¿¡" class="headerlink" title="åŒæ­¥å’Œé€šä¿¡"></a>åŒæ­¥å’Œé€šä¿¡</h4><p>å¯¹äºwrapé—´çš„æŒ‡ä»¤ï¼Œæˆ‘ä»¬ä½¿ç”¨SYNCè¿›è¡Œwrapå†…éƒ¨çš„åŒæ­¥ï¼Œå¦‚æœå¤§å®¶å› ä¸ºæŸäº›åŸå› åˆ†æµäº†ï¼Œå°±å¯ä»¥ä½¿ç”¨SYNCåŒæ­¥åˆ°ä¸€èµ·ï¼Œç„¶åç»§ç»­ä¸€èµ·æµæ·Œã€‚è¿™ä¸ªç»†èŠ‚å‰é¢è®²è¿‡äº†ï¼Œå°±ä¸å†å¤šé‡å¤äº†ï¼Œå¯ä»¥ç”¨instrincå‡½æ•°__synchrone_wrapæ’å…¥è¯¥æŒ‡ä»¤ã€‚</p>
<p>å¯¹äºwrapå†…éƒ¨çš„32ä¸ªthreadï¼Œæœ‰æ—¶å€™æˆ‘ä»¬çš„ä¸‹ä¸€é˜¶æ®µçš„è¡ŒåŠ¨æ—¶éœ€è¦32ä¸ªthreadä¸€èµ·å†³å®šçš„ï¼Œæ¯”å¦‚å¦‚æœ32ä¸ªçº¿ç¨‹è¯»å†…å­˜å¾—åˆ°çš„ç»“æœéƒ½æ˜¯0ï¼Œé‚£ä¹ˆå°±é€€å‡ºï¼Œä¸ç„¶å°±ç»§ç»­æ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™éœ€è¦æ£€æŸ¥32ä¸ªå†…å­˜æ˜¯ä¸æ˜¯éƒ½æ»¡è¶³éƒ½æ»¡è¶³éƒ½å†™æ¡ä»¶ï¼Œæˆ–è€…éƒ¨åˆ†æ»¡è¶³æŸäº›æ¡ä»¶ä»€ä¹ˆçš„ã€‚ä¸ºæ­¤æä¾›äº†æŠ•ç¥¨æŒ‡ä»¤VOTEï¼Œä»–ä¼šæ£€æŸ¥32ä¸ªthreadçš„predicateæ˜¯ä¸æ˜¯éƒ½æ˜¯0æˆ–è€…1ï¼Œæˆ–è€…éƒ¨åˆ†æ˜¯0æˆ–è€…1ï¼Œå¦‚æ­¤å¤šç§æ¨¡å¼ï¼Œè¿›è€Œæ ¹æ®32ä¸ªthreadçš„æƒ…å†µååŒä¹‹åçš„æ“ä½œã€‚</p>
<p>wrapä¹‹é—´çš„threadæœ‰çš„æ—¶å€™éœ€è¦é€šä¿¡ï¼Œæ¯”å¦‚è¯´ç¬¬1ä¸ªçº¿ç¨‹éœ€è¦ç¬¬7ä¸ªçº¿ç¨‹çš„æŸä¸ªå˜é‡çš„å€¼ï¼Œæ‰€ä»¥æä¾›äº†shuffleæŒ‡ä»¤å¯ä»¥è¿›è¡Œwrapçš„çº¿ç¨‹ä¹‹é—´çš„æ•°æ®ä¼ é€’ã€‚shuffleåˆ†ä¸º4ç§ï¼Œé¦–å…ˆæœ‰ä¸€ä¸ªä½å®½å‚æ•°æŒ‡å®šäº¤æµçš„èŒƒå›´ï¼Œå¦‚æœæ˜¯32é‚£ä¹ˆå°±æ˜¯32ä¸ªthreadå½“ä½œä¸€ä¸ªæ•´ä½“åšäº¤æµï¼Œå¦‚æœæ˜¯16å°±æ˜¯æŠŠthreadåˆ†ä¸ºä¸¤ç»„åœ¨å†…éƒ¨è¿›è¡Œäº¤æµï¼Œå¦‚æœæ˜¯8å°±æ˜¯4ç»„ï¼Œå¦‚æ­¤ç±»æ¨ã€‚ä¹‹åç¬¬ä¸€ç§shuffleæ˜¯æŒ‡å®šä¸€ä¸ªIDï¼Œç„¶åæ¯ä¸€ç»„çš„ç¬¬IDä¸ªthreadå°±æŠŠä»–çš„æŸä¸ªå€¼å‘é€ç»™å…¶ä»–çš„threadï¼›ç¬¬äºŒç§æ˜¯æŒ‡å®šä¸€ä¸ªoffsetï¼Œç„¶åæ¯ä¸€ç»„çš„threadå¾—åˆ°è‡ªå·±çš„ID+offsetçš„é‚£ä¸ªthreadçš„å€¼ï¼›ç¬¬ä¸‰ç§æ˜¯ID-offsetçš„å€¼ï¼›ç¬¬å››ç§æ˜¯æŒ‡å®šä¸€ä¸ªmaskï¼Œç„¶åID^maskçš„å€¼ã€‚</p>
<p>å¦‚æœæ˜¯å—å†…çš„éœ€è¦åšåŒæ­¥å¯ä»¥ç”¨__synchroneæ¥åŒæ­¥ï¼Œä¹Ÿå¯ä»¥ç”¨shared memoryæ¥åšå—å†…çš„é€šä¿¡ã€‚å¦‚æœæ˜¯gridå†…éƒ¨ï¼Œæ²¡æœ‰åŠæ³•åŒæ­¥æ‰€æœ‰çš„blockï¼Œå¯ä»¥ç”¨global memoryæ¥é€šä¿¡ã€‚æ‰€ä»¥é€šä¿¡å’ŒåŒæ­¥å¯¹äºGPUè¿˜æ˜¯å¾ˆéš¾å¾—ï¼Œèƒ½ä¸ç”¨æœ€å¥½ä¸ç”¨ã€‚</p>
<p>æ€»ç»“ä¸€ä¸‹æŒ‡ä»¤ï¼šã€</p>
<table>
<thead>
<tr>
<th>æŒ‡ä»¤</th>
<th>åŠŸèƒ½</th>
</tr>
</thead>
<tbody><tr>
<td>SYNC</td>
<td>åŒæ­¥æŒ‡ä»¤</td>
</tr>
<tr>
<td>VOTE</td>
<td>æŠ•ç¥¨æŒ‡ä»¤</td>
</tr>
<tr>
<td>SHUF</td>
<td>shuffleæŒ‡ä»¤</td>
</tr>
</tbody></table>
<h4 id="ç‰¹æ®Šå¯„å­˜å™¨è®¿é—®"><a href="#ç‰¹æ®Šå¯„å­˜å™¨è®¿é—®" class="headerlink" title="ç‰¹æ®Šå¯„å­˜å™¨è®¿é—®"></a>ç‰¹æ®Šå¯„å­˜å™¨è®¿é—®</h4><p>ç‰¹æ®Šå¯„å­˜å™¨åŸºæœ¬éƒ½æ˜¯åªè¯»çš„ï¼Œæ‰€ä»¥SASSåªæœ‰S2Rçš„ç‰¹æ®Šå¯„å­˜å™¨è¯»å–æŒ‡ä»¤ï¼Œæ²¡æœ‰ç‰¹æ®Šå¯„å­˜å™¨å†™å…¥æŒ‡ä»¤ã€‚è¦è¯»ä»€ä¹ˆç‰¹æƒå¯„å­˜å™¨ï¼Œç”¨S2Rå°±å¯ä»¥äº†ï¼Œç½—åˆ—ä¸€äº›ç‰¹æ®Šå¯„å­˜å™¨ã€‚æ¯”å¦‚tid.xã€tid.yã€tid.zå’Œctaid.xã€ctaid.yã€ctaid.zè¿™å…­ä¸ªå¯„å­˜å™¨åˆ†åˆ«å¯¹åº”threadIdx.xã€threadIdx.yã€threadIdx.zå’ŒblockIdx.xã€blockIdx.yã€blcokIdx.zï¼Œç”¨æ¥è¡¨ç¤ºthreadå’Œblockçš„ç¼–å·ã€‚æ­¤å¤–è¿˜æœ‰clockå’Œclock64ï¼Œå¯ä»¥åœ¨cudaä¸­ç”¨clock()å’Œclock64()æ¥å¾—åˆ°ï¼Œä¸€ä¸ªæ˜¯SMçš„clockå¯„å­˜å™¨ï¼Œä¸€ä¸ªæ˜¯GPUå…¨å±€çš„clockå¯„å­˜å™¨ï¼Œæ¯ä¸€ä¸ªæ—¶é’Ÿå‘¨æœŸå°±ä¼šåŠ 1ï¼Œå¯ä»¥ç”¨äºè®¡æ—¶ï¼Œä¸ç²¾ç¡®çš„æŒ‡ä»¤æµ‹é€Ÿå¯ä»¥ä½¿ç”¨è¿™ä¸¤ä¸ªå¯„å­˜å™¨çš„å€¼ã€‚</p>
<h4 id="æ§åˆ¶ç å’Œç«äº‰å¤„ç†"><a href="#æ§åˆ¶ç å’Œç«äº‰å¤„ç†" class="headerlink" title="æ§åˆ¶ç å’Œç«äº‰å¤„ç†"></a>æ§åˆ¶ç å’Œç«äº‰å¤„ç†</h4><p>å¯¹äºç»“æ„ç«äº‰å’Œæ§åˆ¶ç«äº‰ï¼ŒGPUæ˜¯æ£€æµ‹åˆ°äº†ä¹‹åå¼€å§‹ç­‰å¾…ã€‚é‚£ä¹ˆå¯¹äºæ•°æ®ç«äº‰æ˜¯æ€ä¹ˆåšçš„ï¼Ÿæ¯”å¦‚ç¬¬ä¸€æ¡æŒ‡ä»¤å†™äº†R1ï¼Œç¬¬äºŒæ¡æŒ‡ä»¤è¦è¯»R1ï¼Œä»–æ˜¯æ€ä¹ˆè°ƒåº¦æ¥å¤„ç†RAWã€WARã€WAWçš„å‘¢ï¼Ÿé¦–å…ˆcudaçš„ç¼–è¯‘å™¨æ˜¯å¾ˆå¼ºå¤§çš„ï¼Œä»–ä¼šåšç®—æ³•çš„ä¼˜åŒ–ã€æŒ‡ä»¤çš„é‡æ’å’Œè°ƒåº¦ï¼Œè®©æŒ‡ä»¤ä¹‹é—´çš„å†²çªå°½å¯èƒ½çš„å°‘ï¼Œç›¸é‚»æœ€å¥½ä¸å ç”¨åŒä¸€ä¸ªå‘å°„é€šé“ã€ä¼ªæ•°æ®ç›¸å…³çš„WARå’ŒWAWå› ä¸ºGPUä¸ä¼šåšå¯„å­˜å™¨é‡åå¯ä»¥äº‹å…ˆåˆ†å¼€ç­‰ç­‰ã€‚è€Œå¯¹äºä¹‹åè¿˜ç•™ä¸‹æ¥çš„æ•°æ®ç«äº‰åˆ™æ˜¯stallçš„æ–¹æ³•æ¥è§£å†³çš„ï¼Œstallç­‰å¾…æ²¡æœ‰ç«äº‰ä¸ºæ­¢ï¼Œè€Œå¯¹äºstallä»–ä¹Ÿä¸æ˜¯åŠ¨æ€å¯¹ä¹‹å‰çš„å‡ æ¡æŒ‡ä»¤æ£€æµ‹çš„ï¼Œè€Œæ˜¯å®ç°ç”¨ç¼–è¯‘å™¨é™æ€åˆ†æå¥½ï¼Œé¢„å…ˆè®¡ç®—å‡ºæ¯æ¡æŒ‡ä»¤æ€ä¹ˆç­‰å¾…ã€ç­‰å¾…å¤šä¹…ï¼Œç„¶åè®°å½•åˆ°control codeçš„ç¼–ç ä¹‹ä¸­ä¿å­˜åˆ°æŒ‡ä»¤ä¸­ï¼Œç„¶åæ‰§è¡ŒæŒ‡ä»¤çš„æ—¶å€™æ ¹æ®control codeçš„å€¼è¿›è¡ŒæŒ‡ä»¤å‘å°„çš„stallã€‚å¯¹äºcontrol codeå¯ä»¥å‚çœ‹è¿™ç¯‡<a href="https://zhuanlan.zhihu.com/p/166180054">æ–‡ç« </a>å’Œè¿™ç¯‡<a href="https://github.com/NervanaSystems/maxas/wiki/Control-Codes">æ–‡ç« </a></p>
<p>control codeç”±å¦‚ä¸‹å‡ ä¸ªåŸŸç»„æˆ</p>
<figure class="highlight shell"><table><tr><td class="code"><pre><span class="line">| reuse | wait barry |read barry|write barry| yield |  stall |</span><br><span class="line">|  4bit |    6bit    |   3bit   |    3bit   |  1bit |  4bit  |</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬ä¾æ¬¡ä»‹ç»æ¯ä¸ªåŸŸè®¾ç½®çš„åŸå› å’Œèµ·åˆ°çš„ä½œç”¨ï¼Œæœ‰çš„æ—¶å€™ä¸ªäººè§‰å¾—åŸå› æ¯”ä½œç”¨æ›´é‡è¦ã€‚ç›¸æ¯”äºæˆ‘ä»¬æœ‰ä¸€ä¸ªä»€ä¹ˆæ–¹æ³•ï¼Œè¿™ä¸ªæ–¹æ³•æ˜¯ä»€ä¹ˆï¼Œä»–å¯ä»¥è¾¾åˆ°ä»€ä¹ˆæ•ˆæœï¼›æˆ‘ä»¬é‡åˆ°ä»€ä¹ˆé—®é¢˜ï¼Œå¦‚ä½•è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬æ˜¯ç”¨äº†ä»€ä¹ˆæ–¹æ³•æ˜¯æ›´å¥½çš„ä»‹ç»æ–¹å¼ã€‚</p>
<h5 id="reuse"><a href="#reuse" class="headerlink" title="reuse"></a>reuse</h5><p>æˆ‘ä»¬ä¹‹å‰æåˆ°æ¯ä¸€ä¸ªè®¡ç®—å•å…ƒcoreã€FPUå’ŒSFUéƒ½æœ‰è‡ªå·±çš„collectorç”¨æ¥æ”¶é›†éœ€è¦ä½¿ç”¨çš„æ•°æ®ï¼Œæ¯”å¦‚GPRå¯„å­˜å™¨çš„å€¼ã€ç‰¹æ®Šå¯„å­˜å™¨çš„å€¼ã€predicateå¯„å­˜å™¨çš„å€¼ç­‰ç­‰ï¼Œä½†æ˜¯è¿™äº›å€¼æœ‰çš„æ—¶å€™è·å¾—æ˜¯éœ€è¦ä¸€åˆ°ä¸¤ä¸ªå‘¨æœŸçš„ï¼Œæ¯”å¦‚GPRçš„è¯»å–æœ‰æ—¶å€™å¯èƒ½å› ä¸ºbankå†²çªå°±éœ€è¦å¤šè¯»å‡ ä¸ªå‘¨æœŸï¼Œé‚£ä¹ˆæœ‰æ²¡æœ‰åŠæ³•åŠ åŠ é€Ÿå‘¢ï¼Ÿ</p>
<p>ç°åœ¨æˆ‘ä»¬æœ‰ä¸¤æ¡æŒ‡ä»¤</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">ADD R0,R2,R3</span><br><span class="line">ADD R1,R2,R4</span><br></pre></td></tr></table></figure>
<p>é‚£ä¹ˆæ‰§è¡Œå®Œç¬¬ä¸€æ¡æŒ‡ä»¤ä¹‹åï¼ŒR2ã€R3çš„å€¼å·²ç»ä¿å­˜åˆ°äº†coreçš„collectorçš„ç¬¬ä¸€ä¸ªå¯„å­˜å™¨å’Œç¬¬äºŒä¸ªå¯„å­˜å™¨é‡Œé¢äº†ï¼Œé‚£ä¹ˆæ‰§è¡Œç¬¬äºŒæ¡æŒ‡ä»¤çš„æ—¶å€™æˆ‘ä»¬å‘ç°collectorç¬¬ä¸€ä¸ªå¯„å­˜å™¨éœ€è¦è½½å…¥çš„R2å·²ç»åœ¨collectoré‡Œäº†ï¼Œæ‰€ä»¥å…¶å®å°±ä¸éœ€è¦å†è¯»ä¸€æ¬¡GPRçš„äº†ï¼Œè€Œç¬¬äºŒä¸ªå¯„å­˜å™¨éœ€è¦R4ä½†æ˜¯é‡Œé¢çš„æ˜¯R3é‚£è¿˜æ˜¯éœ€è¦å†è¯»ä¸€æ¬¡GPRã€‚å› æ­¤æˆ‘ä»¬å¯ä»¥åœ¨control codeé‡Œé¢ä¸ºæ¯ä¸€ä¸ªcollectorçš„æ§½è®¾ç½®ä¸€ä¸ªreuse bitï¼Œå¦‚æœè¿™ä¸ªæŒ‡ä»¤çš„ç¬¬xä¸ªå¯„å­˜å™¨çš„å€¼å’Œä¸‹ä¸€ä¸ªæŒ‡ä»¤çš„ç¬¬xå¯„å­˜å™¨çš„å€¼æ˜¯ä¸€æ ·çš„ï¼Œé‚£ä¹ˆå°±å¯ä»¥æŠŠreuseçš„ç¬¬xbitè®¾ç½®ä¸º1ï¼Œé‚£ä¹ˆä¸‹ä¸€æ¡æŒ‡ä»¤å°±å¯ä»¥çœå»collectorç¬¬xæ§½è¯»æ•°çš„æ“ä½œäº†ã€‚å¯¹äºè®¡ç®—æŒ‡ä»¤ä¸€èˆ¬æ¥è¯´æœ‰è‡³å°‘3ä¸ªæ“ä½œæ•°ï¼Œæ¯”å¦‚ä¹˜æ³•æŒ‡ä»¤ï¼Œæ‰€ä»¥éœ€è¦è‡³å°‘ä¸‰ä¸ªreuse bitï¼Œä½†æ˜¯GPUçš„control codeæä¾›äº†4ä¸ªï¼Œå¯èƒ½æ˜¯å› ä¸ºå­˜åœ¨4æ“ä½œæ•°æŒ‡ä»¤æˆ–è€…ä¸ºå°†æ¥çš„æ‰©å±•åšé¢„ç•™å§ã€‚</p>
<p>å¦å¤–å¯¹äºä¸‹é¢è¿™ä¸ªä¾‹å­ï¼Œè¿™æ˜¯<a href="https://zhuanlan.zhihu.com/p/166180054">æ–‡ç« </a>ä½œè€…ç–‘æƒ‘çš„åœ°æ–¹ï¼Œä½†æ˜¯æˆ‘ä»¬å¯ä»¥ç»™å‡ºè§£é‡Šï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">1: [R---:B------:R-:W-:-:S02]     FSETP.GT.AND P1, PT, R9.reuse, c[0x0][0x18c], PT ;</span><br><span class="line">2: [----:B------:R-:W-:-:S02]     LEA.HI.X.SX32 R4, R4, c[0x0][0x164], 0x1, P3 ;    </span><br><span class="line">3: [R---:B------:R-:W-:-:S02]     LEA R5, P3, R0.reuse, R5, 0x2 ;                   </span><br><span class="line">4: [----:B------:R-:W-:-:S02]     FSEL R9, R9, c[0x0][0x18c], !P1 ;                 </span><br><span class="line">5: [----:B------:R-:W-:-:S02]     LEA.HI.X R4, R0, R4, R3, 0x2, P3 ;</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ç¬¬1æ¡å’Œç¬¬4æ¡çš„R9æ˜¯ç›¸åŒçš„ï¼Œç¬¬3æ¡å’Œç¬¬5æ¡çš„R0æ˜¯ç›¸åŒçš„ï¼Œæ‰€ä»¥ä½œè€…åœ¨ç–‘æƒ‘æ˜¯ä¸æ˜¯åº”è¯¥æŠŠç¬¬1æ¡å’Œç¬¬4æ¡æ”¾åœ¨ä¸€èµ·ï¼Œç¬¬3æ¡å’Œç¬¬5æ¡æ”¾åœ¨ä¸€èµ·ï¼Ÿå…¶å®æ²¡æœ‰å¿…è¦ï¼Œå› ä¸ºreuseä¸æ˜¯å’ŒæŒ‡ä»¤çš„é¡ºåºç›¸å…³è”çš„ï¼Œè€Œæ˜¯å’ŒæŒ‡ä»¤çš„æ‰§è¡Œä¸è§å¾—collectorç›¸å…³è”çš„ï¼Œæˆ‘ä»¬çš„ç¬¬ä¸€æ¡æŒ‡ä»¤åœ¨FPUæ‰§è¡Œï¼Œç¬¬2ã€3æ¡å»coreæ‰§è¡Œï¼Œç¬¬4æ¡ä¹‹åå»äº†FPUæ‰§è¡Œï¼Œè¿™ä¸ªæ—¶å€™ä»–æ£€æŸ¥çš„collectorå°±æ˜¯è¢«ç¬¬1æ¡æŒ‡ä»¤å½±å“çš„ï¼Œæ‰€ä»¥å®ƒçš„R9å¯ä»¥å’Œç¬¬1æ¡çš„R9åŒ¹é…ï¼Œå¯ä»¥ç”¨reuseä¿ç•™collectorå¯¹åº”æ§½å¯„å­˜å™¨çš„å€¼ï¼Œç¬¬äº”æ¡æŒ‡ä»¤è¿›å…¥coreçš„æ—¶å€™æ£€æŸ¥collectoræ˜¯è¢«ç¬¬3æ¡æŒ‡ä»¤å½±å“çš„ï¼Œæ‰€ä»¥å®ƒçš„R0å’Œç¬¬3æ¡çš„R0åŒ¹é…ï¼Œå¯ä»¥reuseã€‚å¦å¤–coreæŒ‡ä»¤å’ŒFPUæŒ‡ä»¤äº¤é”™æœ‰å®ƒçš„å¥½å¤„ï¼Œå¯ä»¥åœ¨å‘å°„çš„æ—¶å€™dispatchåŒæ—¶å‘å°„ä¸€æ¡coreæŒ‡ä»¤å’Œä¸€æ¡fpuæŒ‡ä»¤ï¼Œä»è€Œæé«˜å‘å°„çš„é€Ÿåº¦ã€‚</p>
<p>è¿™é‡Œä¹Ÿæš—ç¤ºwrapçš„è°ƒåº¦å¯èƒ½ä¸æ˜¯ç®€å•çš„è½®è¯¢ï¼Œå¦‚æœæ˜¯å¤šä¸ªwrapè½®è¯¢å‘å°„ï¼Œé‚£ä¹ˆcoreçš„collectorçš„å¯„å­˜å™¨çš„å€¼å¯¹å…¶ä»–çš„wrapæ¯«æ— æ„ä¹‰ï¼Œé‚£ä¹ˆreuseä¹Ÿä¼šå˜å¾—æ²¡æœ‰æ„ä¹‰ï¼Œæ‰€ä»¥å¤§æ¦‚ç‡æ˜¯å¦‚æœwrapè¿˜å¯ä»¥å‘å°„ï¼Œåº”è¯¥æœ‰å…ˆè®©ä»–ç»§ç»­å‘å°„ï¼Œåé¢çš„yieldåº”è¯¥ä¹Ÿä½“ç°äº†è¿™ä¸€ç‚¹ã€‚</p>
<h5 id="stall"><a href="#stall" class="headerlink" title="stall"></a>stall</h5><p>stallæ˜¯å¥½ç†è§£çš„ï¼Œæ¯”å¦‚æˆ‘çš„æŒ‡ä»¤1åœ¨FPUè¿è¡Œéœ€è¦3æ‹æ‰å¯ä»¥æ‰§è¡Œå®Œï¼Œè¿™ä¸ªå› ä¸ºæˆ‘äº†è§£ç¡¬ä»¶æ˜¯å¯ä»¥äº‹å…ˆçŸ¥é“çš„ï¼Œè€Œæˆ‘çš„æŒ‡ä»¤2ä¹Ÿè¦åœ¨FPUè¿è¡Œï¼Œå› æ­¤ä»–è¦ç­‰å¾…3æ‹æ‰å¯ä»¥è¢«å‘å°„å‡ºå»ã€‚é‚£ä¹ˆæˆ‘å°±å¯ä»¥åœ¨control codeçš„stallä¸ºä¸Šå†™3ï¼Œé‚£ä¹ˆè¿™æ¡æŒ‡ä»¤å‘å°„ä¹‹åç­‰3æ‹åœ¨å‘å°„ä¸‹ä¸€æ¡æŒ‡ä»¤ï¼Œé‚£ä¹ˆä»–å°±å¯ä»¥æ­£å¸¸è¿è¡Œäº†ã€‚</p>
<p>å¯¹äºcoreã€SPUã€FPUè¿™äº›å°é—­æ€§å¾ˆå¼ºçš„æŒ‡ä»¤ï¼Œä»–ä»¬æ¯æ¡æŒ‡ä»¤æ‰§è¡Œçš„æ—¶é—´æ˜¯äº‹å…ˆéƒ½å¯ä»¥çŸ¥é“çš„ï¼Œå› æ­¤æˆ‘ä»¬åœ¨ç¼–è¯‘çš„æ—¶å€™å°±å¯ä»¥è®¡ç®—å‡ºè¿™äº›ç®€å•æŒ‡ä»¤å æ®è¿ç®—å•å…ƒçš„æ—¶é—´ï¼Œç„¶ååç»­å‘å°„çš„æŒ‡ä»¤å¦‚æœè¦æ²¡æœ‰ç»“æ„ç«äº‰æˆ–è€…æ²¡æœ‰æ•°æ®ç«äº‰éœ€è¦stallçš„æ—¶é—´ï¼ŒæŠŠè¿™ä¸ªstallè®°å½•åˆ°control codeå³å¯ã€‚å› ä¸ºç¼–è¯‘å™¨äº‹å…ˆè§£å†³äº†è¿™ä¸ªå†²çªstallæ—¶é—´çš„é—®é¢˜ï¼Œæ‰€ä»¥ç¡¬ä»¶å°±å¯ä»¥æŠŠè¿™äº›å†²çªstallæ£€æŸ¥çš„é€»è¾‘å…¨éƒ¨åˆ å»ï¼Œå°±å¯ä»¥å¤§å¤§èŠ‚çœè¿è¡Œèƒ½è€—å’Œç¡¬ä»¶çš„å¼€é”€ã€‚</p>
<p>stallä¸€å…±æ˜¯4ä½ï¼Œæ‰€ä»¥æœ€å¤šå¯ä»¥ç­‰å¾…15ä¸ªå‘¨æœŸã€‚</p>
<h5 id="barry"><a href="#barry" class="headerlink" title="barry"></a>barry</h5><p>wait barryã€read barryå’Œwrite barryæ˜¯ç»“åˆèµ·æ¥å·¥ä½œçš„ã€‚å¦‚æœæˆ‘ä»¬åªæœ‰ç®—æ•°æŒ‡ä»¤å’Œæ§åˆ¶æŒ‡ä»¤ï¼Œæ¯ä¸ªæŒ‡ä»¤çš„è¿ç®—éƒ¨ä»¶éƒ½æ˜¯è‡ªå·±ç§æœ‰çš„ï¼Œä»–ä»¬çš„è¿ç®—æ—¶é—´éƒ½æ˜¯äº‹å…ˆå¯ä»¥çŸ¥é“çš„ï¼Œæ‰€ä»¥æˆ‘ä»¬å¯ä»¥æ˜¯å…ˆè®¡ç®—å‡ºç¡®åˆ‡çš„stallï¼Œç„¶åè®©ä»–ç­‰å¾…æ—¢å¯ä»¥äº†ï¼Œä½†æ˜¯å¯¹äºstoreã€loadæŒ‡ä»¤ï¼Œè®¿å­˜çš„é€»è¾‘æ˜¯å¤æ‚çš„ï¼Œä»–çš„æ‰§è¡Œæ—¶é—´å—åˆ°å…¶ä»–çš„blockå’Œè®¿é—®çš„addressç­‰å¤§é‡æ•°æ®çš„å½±å“ï¼Œæ‰€ä»¥æ˜¯æ— æ³•é¢„å…ˆè®¡ç®—å‡ºå¯¹åº”çš„è®¿å­˜æ—¶é—´ã€‚é‚£æ€ä¹ˆåŠå‘¢ï¼Ÿä¸èƒ½é™æ€æ£€æµ‹å°±åªèƒ½åŠ¨æ€ç›‘æµ‹äº†ï¼Œé‚£ä¹ˆå°±æ˜¯ç”¨scoreboardå‘—ã€‚</p>
<p>GPUä¸ºwrapæä¾›äº†6ä¸ªbarryå¯„å­˜å™¨ï¼Œæ¥å……å½“scoreboardã€‚å¯¹äºå¦‚ä¸‹çš„æŒ‡ä»¤ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">LDG R0,[R1]</span><br><span class="line">ADD R2,R0,1</span><br></pre></td></tr></table></figure>
<p>æˆ‘ä»¬çš„ADDæŒ‡ä»¤çš„R0æ˜¯ä¾èµ–äºLDGè¿™æ¡æŒ‡ä»¤çš„ï¼Œæ‰€ä»¥å¿…é¡»è¦ç­‰å¾…LDGæŒ‡ä»¤è¿è¡Œå®Œæ¯•æ‰å¯ä»¥ç»§ç»­è¿è¡Œã€‚å› æ­¤LDGåœ¨æ‰§è¡Œçš„æ—¶å€™å°±éœ€è¦æŠŠå¯¹åº”çš„barryå¯„å­˜å™¨è®¾ç½®ä¸º1ï¼Œç„¶åç­‰æ‰§è¡Œå®Œæ¯•ä¹‹åå°±ä¼šè®¾ç½®ä¸º0ã€‚è€ŒADDæŒ‡ä»¤åˆ™é€‰æ‹©ç­‰å¾…å¯¹åº”çš„barryç›´åˆ°å®ƒçš„å€¼å˜ä¸º0ç„¶åæ‰å¯ä»¥å‘å°„å‡ºå»æ‰§è¡Œã€‚</p>
<p>å¯¹äº6ä¸ªbarryï¼Œå¦‚æœè¦è®¾ç½®barryï¼Œè¯»æŒ‡ä»¤åœ¨control codeçš„3ä½read barryå¤„é€‰æ‹©è¦è®¾ç½®çš„barryçš„ç¼–å·ï¼Œç„¶åå°±å¯ä»¥åœ¨å‘å°„ä¹‹åå°†å¯¹åº”çš„barryç½®ä½ã€‚æˆ‘ä»¬çš„read barryåŸŸè™½ç„¶æœ‰3ä½å¯ä»¥ç´¢å¼•0-7ï¼Œä½†æ˜¯å¾ˆå¯æƒœbarryåªæœ‰6ä¸ªï¼Œ000è¡¨ç¤ºä¸è®¾ç½®barryï¼Œ001-110è¡¨ç¤ºè®¾ç½®0-5å·barryï¼Œ111æ²¡æœ‰æ„ä¹‰ä¹Ÿä¸ä¼šå‡ºç°ã€‚barryåœ¨32ä¸ªloadå¼€å§‹è¿è¡Œçš„æ—¶å€™ï¼Œæ¯å¼€å§‹è¿è¡Œä¸€ä¸ªloadï¼Œbarryçš„å€¼åŠ 1ï¼Œç„¶åæ¯å®Œæˆä¸€ä¸ªloadï¼Œbarryçš„å€¼å‡1ï¼Œç›´åˆ°æœ€åloadæ‰§è¡Œå®Œæ¯•ï¼Œbarryçš„å€¼å‡ä¸º1ã€‚å¦‚æœæ˜¯å†™çš„storeæŒ‡ä»¤ï¼Œé‚£ä¹ˆå°±è®¾ç½®write barryä¸º6ä¸ªbarryçš„åºå·ã€‚ç¼–è¯‘å™¨é€‰æ‹©è¦ä½¿ç”¨çš„barryåºå·ï¼Œç¡®ä¿åœ¨ä¸€ä¸ªbarryæ²¡æœ‰é‡Šæ”¾ä¹‹å‰ä¸ä¼šè¢«å†æ¬¡ä½¿ç”¨ã€‚</p>
<p>è€Œç­‰å¾…barryçš„ä¸€æ–¹åˆ™åœ¨wait barryå“ªé‡Œè®¾ç½®è¦ç­‰å¾…çš„barryåºå·ï¼Œå¦‚æœè¦ç­‰å¾…0-5å·barryå°±æŠŠwait barryçš„0-5ä½è®¾ç½®ä¸º1å³å¯ã€‚ä¸åŒäºè®¾ç½®æ–¹ä¸€æ¬¡åªèƒ½è®¾ç½®ä¸€ä¸ªbarryï¼Œç­‰å¾…æ–¹å¯èƒ½æœ‰å¤šä¸ªæ“ä½œæ•°éƒ½è¦ç­‰å¾…å…¶ä»–æŒ‡ä»¤çš„barryï¼Œæ‰€ä»¥6ä¸ªbarryéƒ½è¦å¯ä»¥ç®¡ç†åˆ°ï¼Œå› æ­¤é‡‡ç”¨äº†one-hotç¼–ç çš„æ–¹å¼ã€‚</p>
<h5 id="yield"><a href="#yield" class="headerlink" title="yield"></a>yield</h5><p>æ²¡æœ‰ç¡®åˆ‡çš„æ–‡çŒ®æŒ‡å‡ºä»–å®é”¤æ˜¯å¹²ä»€ä¹ˆçš„ï¼Œå¯ä»¥çŸ¥é“çš„æ˜¯yieldæ˜¯å’Œstallæ­é…å·¥ä½œçš„ï¼Œç„¶åyield&#x3D;1å¯èƒ½æ˜¯åœ¨å‘Šè¯‰schedulerè¿™ä¸ªwrapå¯ä»¥è¢«è°ƒåº¦å‡ºå»ï¼Œè®©å…¶ä»–çš„wrapæœ‰å…ˆè¿è¡Œï¼Œå› ä¸ºstallçš„æ—¶é—´å¯èƒ½ä¼šå¾ˆä¹…ã€‚å…·ä½“ä¸æ¸…æ¥šã€‚è¿™ä¹Ÿè¯´æ˜äº†æˆ‘ä»¬çš„wrapè°ƒåº¦å¤§æ¦‚ç‡ä¸æ˜¯è½®è¯¢çš„ï¼Œè€Œæ˜¯å¯èƒ½ä¸€ä¸ªwrapå¯ä»¥æ‰§è¡Œå°±å°½é‡è®©ä»–å…ˆè¢«æ»¡è¶³ï¼Œå‡å°‘è°ƒåº¦åˆ‡æ¢çš„æˆæœ¬ï¼Œè¿™ä¼°è®¡ä¹Ÿæ˜¯reuseå’Œyieldå¯ä»¥å‘æŒ¥ä½œç”¨çš„åŸå› ã€‚</p>
<h5 id="å…¶ä»–"><a href="#å…¶ä»–" class="headerlink" title="å…¶ä»–"></a>å…¶ä»–</h5><p>å¯ä»¥çœ‹åˆ°ä¸€æ¡æŒ‡ä»¤çš„é•¿åº¦æ˜¯64ä½ï¼Œå¯¹åº”çš„control codeéœ€è¦21ä½ï¼Œæ‰€ä»¥ä»–ä»¬é€‰æ‹©å°†3æ¡æŒ‡ä»¤çš„control codeæ€»è®¡63ä½æ‰“åŒ…ï¼Œç„¶ååŠ ä¸Šä¸€ä¸ªæ— æ•ˆä½å°±æ˜¯64ä½ï¼Œç„¶å3æ¡æŒ‡ä»¤+1æ¡control codeä½œä¸ºä¸€ä¸ªæ•´ä½“æ’ä¸åœ¨textæ®µå½“ä¸­ã€‚æ—©æœŸçš„GPUä½“ç³»æ¶æ„å› ä¸ºcontrol codeæ¯”è¾ƒçŸ­ï¼Œæ‰€ä»¥æ˜¯7æ¡æŒ‡ä»¤+1æ¡control codeï¼Œä¹‹åå°±æ˜¯3æ¡æŒ‡ä»¤+1æ¡control codeï¼Œæ‰€ä»¥å¯ä»¥æƒ³è±¡åˆ°æˆ‘ä»¬çš„instruction fetchå•å…ƒæ¯æ¬¡å–æŒ‡ä»¤ä¸€å®šæ˜¯8æ¡æˆ–è€…4æ¡ä¸€ä¸ªæ•´ä½“fetchå‡ºæ¥çš„ï¼Œç„¶åå†é‡æ–°æŠŠæŒ‡ä»¤å’Œå¯¹åº”çš„control codeç»„åˆèµ·æ¥ã€‚åˆ°åé¢control codeè¿›ä¸€æ­¥å¢åŠ ï¼Œç°åœ¨å·²ç»å˜ä¸ºäº†1æ¡inst+1æ¡control codeï¼Œæ‰€ä»¥å¹²è„†control codeå°±ç›´æ¥æ˜¯instçš„ä¸€éƒ¨åˆ†å°±å¯ä»¥äº†ï¼Œæ‰€ä»¥ç°åœ¨çš„SASSä¸€ä¸ªæŒ‡ä»¤æ˜¯128ä½ï¼Œä¹Ÿæ²¡å¿…è¦æ‰“åŒ…è§£åŒ…äº†ã€‚</p>
<h2 id="AIæ¨¡å‹å¦‚ä½•åœ¨GPUä¸Šè¿è¡Œ"><a href="#AIæ¨¡å‹å¦‚ä½•åœ¨GPUä¸Šè¿è¡Œ" class="headerlink" title="AIæ¨¡å‹å¦‚ä½•åœ¨GPUä¸Šè¿è¡Œ"></a>AIæ¨¡å‹å¦‚ä½•åœ¨GPUä¸Šè¿è¡Œ</h2><p>å› ä¸ºç»„ä¼šé¢å¤–è®¨è®ºäº†è¿™éƒ¨åˆ†ï¼Œæ‰€ä»¥æˆ‘åœ¨è¿™é‡Œæ’å…¥å™è¿°ä¸€ä¸‹AIæ¨¡å‹åœ¨GPUä¸Šè¿è¡Œçš„åŸºæœ¬æµç¨‹ï¼Œå½“ç„¶è½å®åˆ°ç»†èŠ‚è¯´ä¸å®šå°±æ˜¯å¦ä¸€ä¸ªæ ·å­äº†ã€‚</p>
<p>æˆ‘ä»¬ä»¥æ™®é€šçš„å›¾åƒåˆ†ç±»ç¥ç»ç½‘ç»œä¸ºä¾‹ï¼Œä»–å¯èƒ½æ˜¯14ä¸ªå·ç§¯å±‚+reluå±‚çš„ç»„åˆä¸€æ¬¡è¿æ¥ï¼Œæœ€ååŠ ä¸Šä¸€ä¸ªå…¨è¿æ¥å±‚+reluå±‚çš„ç»„åˆã€‚AIæ¨¡å‹åœ¨è¿è¡Œçš„æ—¶å€™å›¾åƒä¾æ¬¡ç»è¿‡å·ç§¯å±‚+reluå±‚çš„è®¡ç®—ï¼Œå¾—åˆ°ä¸€ä¸ªæ–°çš„äºŒç»´ç»“æœï¼Œç„¶åå±•å¼€ä¸º1ç»´å‘é‡åœ¨ç»è¿‡å…¨è¿æ¥å±‚+reluå±‚çš„è®¡ç®—å¾—åˆ°æœ€åçš„ç»“æœã€‚ç°åœ¨æˆ‘ä»¬æŠŠä»–ä»¬ç¼–è¯‘ä¸ºcudaç¨‹åºå¯¹åº”çš„binaryä¼šæ˜¯ä»€ä¹ˆæ ·å­çš„ï¼ŸAIæ¨¡å‹æ¯ä¸ªå±‚çš„å‚æ•°ä¼šè¢«ä¿å­˜åˆ°å…¶ä»–çš„æ–‡ä»¶å½“ä¸­ï¼Œæ¯ä¸ªå±‚çš„å‚æ•°ä¼šä¿å­˜åˆ°codeæ®µæˆ–è€…dataæ®µæˆ–è€…å¤–éƒ¨æ–‡ä»¶ä¸­ï¼Œç„¶åæ¯ä¸ªå±‚æœ€åå°±æ˜¯ä¸€ä¸ªå•çº¯çš„cudnn.libçš„kernelå‡½æ•°ï¼Œæ¯”å¦‚å·ç§¯å±‚å°±æ˜¯æ¯”å¦‚å«convè¿™æ ·çš„kernelï¼Œreluå°±æ˜¯å«reluçš„kernelï¼Œå…¨è¿æ¥å±‚å°±æ˜¯æ¯”å¦‚å«matrix_mulè¿™æ ·çš„kernelï¼Œå…¶å®æˆ‘ä»¬ä¹Ÿå¯ä»¥è‡ªå·±æ‰‹æ“ï¼Œæœ€å¤šæ¯”è¾ƒæ…¢è€Œå·²ï¼Œç„¶åè¿™äº›kernelå¯èƒ½å°±è¢«æ‰“åŒ…åˆ°äº†nv_fatbinè¿™æ ·çš„æ®µé‡Œã€‚</p>
<p>ç­‰æ¨¡å‹å¼€å§‹è¿è¡Œçš„æ—¶å€™ï¼Œæˆ‘ä»¬æŠŠç¥ç»ç½‘ç»œéœ€è¦çš„ç½‘ç»œå±‚å¯¹åº”çš„kernelä»¬å‘é€ç»™GPUï¼ŒGPUæŠŠä»–ä»¬æš‚å­˜èµ·æ¥ã€‚ç„¶åå¯¹äºæ¯ä¸€ä¸ªå±‚éƒ½æœ‰ä¸€å †çš„æ¨¡å‹å‚æ•°ï¼Œäºæ˜¯CPUå‘GPUè¯·æ±‚ç©ºé—´ï¼Œç„¶åæŠŠå‚æ•°ä»æ–‡ä»¶é‡Œè¯»å‡ºæ¥ä¼ é€’è¿‡å»ã€‚å¦‚æœå¤§å®¶è¿è¡Œè¿‡tensorflowæ¡†æ¶çš„è¯ï¼Œtensorflowè¿è¡Œä¸€å¼€å§‹è¾“å‡ºå¾—logå°±æ˜¯ä¸€å †å±‚çš„memoryçš„ç”³è¯·ï¼Œå¦‚æœæ˜¾å­˜ä¸å¤Ÿå¤§memoryç”³è¯·å¤±è´¥ï¼Œtensorflowè¿˜ä¼šç»™å‡ºwarningï¼Œå› ä¸ºGç¥ç»ç½‘ç»œçš„å‚æ•°åªèƒ½å¯„å­˜åˆ°CPUçš„memoryç§ï¼ŒGPUè¿è¡ŒAIæ¨¡å‹é€Ÿåº¦ä¼šæ¯”è¾ƒæ…¢ã€‚</p>
<p>ä¹‹åæˆ‘ä»¬æ¯”å¦‚è¦æ¨ç†ä¸€å¼ å›¾åƒï¼Œæˆ‘ä»¬è½½å…¥è¿™å¼ å›¾åƒï¼Œåœ¨GPUä¸­åˆ†é…å†…å­˜ï¼ŒæŠŠå›¾åƒå­˜å…¥GPUï¼Œç„¶åå¼€å§‹æ¨ç†ã€‚ç¬¬ä¸€ä¸ªå±‚æ˜¯æ¯”å¦‚3*3çš„å·ç§¯å±‚ï¼Œæˆ‘ä»¬CPUå‘GPUå‘é€å‘½ä»¤ï¼Œè¦launchå·ç§¯å±‚çš„kernelï¼Œkernelä¸­çš„dataã€const dataå°±è¢«å­˜å…¥å¯¹åº”çš„åœ°æ–¹ï¼›ä¼ é€’å‚æ•°æ¯”å¦‚å·ç§¯æ ¸çš„å¤§å°ã€å·ç§¯æ ¸å­˜æ”¾çš„GPUåœ°å€ã€å›¾åƒçš„å¤§å°ã€å›¾åƒå­˜æ”¾çš„åœ°å€ï¼Œè¿™äº›å€¼ä¼šè¢«å†™å…¥const dataã€‚ç„¶åGPUå¼€å§‹è¿è¡Œcodeï¼Œè¿è¡Œå®Œæ¯•ä¹‹åå¾—åˆ°æ–°çš„ç»“æœå†™å…¥æŸä¸ªmemoryï¼Œè¿™æ ·ç¬¬ä¸€ä¸ªconvå±‚å°±è¿ç®—å®Œæ¯•äº†ï¼Œä¹‹åä¾æ­¤ç±»æ¨å³å¯ã€‚</p>
<h2 id="ç»“æŸè¯­"><a href="#ç»“æŸè¯­" class="headerlink" title="ç»“æŸè¯­"></a>ç»“æŸè¯­</h2><p>è‡³æ­¤å‰æ®µæ—¶é—´å¯¹äºnvidia GPUçš„ç ”ç©¶å°±å‘Šä¸€æ®µè½äº†ï¼Œå¯èƒ½å¾ˆé•¿ä¸€æ®µæ—¶é—´éƒ½ä¸ä¼šåœ¨æ¥è§¦è¿™ä¸ªé¢†åŸŸï¼Œæ‰€ä»¥åœ¨æˆ‘å¿˜è®°ä¹‹å‰æŠŠè®°å¾—çš„éƒ½å†™ä¸‹æ¥ï¼Œå¸Œæœ›å¯ä»¥å¸®åŠ©æœ‹å‹ä»¬å’Œæœªæ¥çš„è‡ªå·±ã€‚å¥½äº†ï¼Œå‘ç€ARMçš„mali GPUè¿›å‘ã€‚</p>
<h2 id="å‚è€ƒèµ„æ–™"><a href="#å‚è€ƒèµ„æ–™" class="headerlink" title="å‚è€ƒèµ„æ–™"></a>å‚è€ƒèµ„æ–™</h2><p><a href="https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#cluster-group-cg">https://docs.nvidia.com/cuda/cuda-c-programming-guide/index.html#cluster-group-cg</a><br><a href="https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#release-notes">https://docs.nvidia.com/cuda/parallel-thread-execution/index.html#release-notes</a><br><a href="https://zhuanlan.zhihu.com/p/75720006">https://zhuanlan.zhihu.com/p/75720006</a><br><a href="https://github.com/NervanaSystems/maxas/wiki/Control-Codes">https://github.com/NervanaSystems/maxas/wiki/Control-Codes</a><br><a href="https://www.informit.com/articles/article.aspx?p=2103809&seqNum=7">https://www.informit.com/articles/article.aspx?p=2103809&amp;seqNum=7</a><br><a href="http://link.zhihu.com/?target=https://github.com/nintyconservation9619/nintyconservation9619.github.io/tree/master/Switch%2520SDK/Docs-JAP/Documents/Package/contents/SASS">http://link.zhihu.com/?target=https%3A//github.com/nintyconservation9619/nintyconservation9619.github.io/tree/master/Switch%2520SDK/Docs-JAP/Documents/Package/contents/SASS</a><br><a href="https://zhuanlan.zhihu.com/p/413145211">https://zhuanlan.zhihu.com/p/413145211</a><br><a href="https://www.cnblogs.com/timlly/p/11471507.html#321-nvidia-tesla%E6%9E%B6%E6%9E%84">https://www.cnblogs.com/timlly/p/11471507.html#321-nvidia-tesla%E6%9E%B6%E6%9E%84</a><br><a href="https://www.cs.rochester.edu/~sree/fermi-tbs/fermi-tbs.html#sec-7-1">https://www.cs.rochester.edu/~sree/fermi-tbs/fermi-tbs.html#sec-7-1</a></p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>gpu</tag>
      </tags>
  </entry>
  <entry>
    <title>Securing DMA through Virtualization</title>
    <url>/2022/05/08/paper_reading/DMA/Securing%20DMA%20through%20Virtualization/</url>
    <content><![CDATA[<h1 id="Securing-DMA-through-Virtualization"><a href="#Securing-DMA-through-Virtualization" class="headerlink" title="Securing DMA through Virtualization"></a>Securing DMA through Virtualization</h1><h2 id="problems"><a href="#problems" class="headerlink" title="problems:"></a>problems:</h2><p>è¿™ç¯‡paperå‘äº2012å¹´ï¼Œå½“æ—¶å¾ˆå¤šåµŒå…¥å¼è®¾å¤‡å¹¶æ²¡æœ‰æ”¯æŒIOMMUï¼Œä¸”ARMæ¶æ„çš„ç‰ˆæœ¬è¾ƒè€ï¼Œæ²¡æœ‰æ”¯æŒç¡¬ä»¶è™šæ‹ŸåŒ–ï¼Œè€Œå¾ˆå¤šDMAç›¸å…³çš„workå¹¶æ²¡æœ‰å…³æ³¨äºDMAæ”»å‡»ï¼Œäºæ˜¯æœ¬æ–‡åˆ©ç”¨DMAè™šæ‹ŸåŒ–æ–¹å¼æ¥ä¿è¯éš”ç¦»ï¼Œé˜²æ­¢DMA attackã€‚</p>
<h2 id="contribution"><a href="#contribution" class="headerlink" title="contribution:"></a>contribution:</h2><ul>
<li>æè¿°äº†å¦‚ä½•ä½¿ç”¨è™šæ‹ŸåŒ–åœ¨ARMv5ä¸Šæ¥ä¿æŠ¤DMA</li>
<li>å±•ç¤ºäº†ä¸éœ€è¦é¢å¤–ç¡¬ä»¶æ”¯æŒçš„DMAè™šæ‹ŸåŒ–</li>
<li>å¯¹æ–¹æ¡ˆè¿›è¡Œå®‰å…¨æ€§å’Œæ€§èƒ½åˆ†æ</li>
<li>å½¢å¼åŒ–éªŒè¯*</li>
</ul>
<h2 id="Related-workï¼š"><a href="#Related-workï¼š" class="headerlink" title="Related workï¼š"></a>Related workï¼š</h2><p>è¿‡å»çš„å·¥ä½œéƒ½æ˜¯åœ¨åµŒå…¥å¼ç³»ç»Ÿä¸­ä½¿ç”¨è™šæ‹ŸåŒ–ï¼Œå¹¶å…³æ³¨äºç§»æ¤è™šæ‹ŸåŒ–å±‚é¢å’Œæ€§èƒ½åˆ†æå±‚é¢ã€‚<br>æœ‰äººæå‡ºäº†åœ¨æ²¡æœ‰IOMMUæ—¶å€™ç›‘æ§å­˜åœ¨çš„æ¶æ„è®¾å¤‡é©±åŠ¨ç¨‹åºï¼Œä½†æ˜¯æ²¡æœ‰æ”¯æŒå¤šguestï¼Œä¹Ÿæ²¡æœ‰è°ƒåº¦ç›¸å…³åŠŸèƒ½ã€‚</p>
<h2 id="Assumptionsï¼š"><a href="#Assumptionsï¼š" class="headerlink" title="Assumptionsï¼š"></a>Assumptionsï¼š</h2><ul>
<li>DMACæ˜¯ä¸€ä¸ªé€šç”¨çš„DMACï¼Œå¹¶ä¸”éœ€è¦CPUå¯¹å…¶è¿›è¡Œç¼–ç¨‹ï¼Œä¸”DMACæ¥å£æš´éœ²ç»™hypervisorã€‚</li>
<li>MMUæ”¯æŒå¯¹ARM domainsçš„ç®¡ç†ã€‚å¤–è®¾æ˜¯å†…å­˜æ˜ å°„çš„ï¼Œé€šè¿‡MMUå¯ä»¥æ§åˆ¶å¯¹å®ƒä»¬çš„è®¿é—®ã€‚</li>
<li>MMUå’ŒDMACç­‰ç¡¬ä»¶éƒ½æ˜¯æ­£å¸¸å·¥ä½œçš„ï¼Œæ²¡æœ‰æ¶æ„ã€‚</li>
<li>Hypervisorå’Œboot loader&#x2F;BIOSéƒ½æ˜¯å¯ä¿¡çš„ã€‚</li>
</ul>
<h2 id="Threat-model"><a href="#Threat-model" class="headerlink" title="Threat model"></a>Threat model</h2><p>æ”»å‡»è€…å‡è®¾æ‹¥æœ‰Guestå®Œå…¨çš„æ§åˆ¶æƒï¼ŒåŒ…æ‹¬è¿è¡Œä»£ç å’Œè·å–æ­£å¸¸æƒé™çš„æ•°æ®ï¼ŒGuestç›®çš„æ˜¯æ”»å‡»å…¶ä»–guestï¼Œä¿®æ”¹æˆ–è€…è¯»å–codeå’Œdataï¼Œæˆ–è€…é˜»æ­¢å…¶è¿è¡Œcodeã€‚å‡è®¾å…¶æ— æ³•å†³å®šDMAæ˜¯å¦è¢«å…¶ä»–éƒ¨åˆ†ä½¿ç”¨ï¼Œï¼ˆå³æ— æ³•é€šè¿‡æµ‹ä¿¡é“æ”»å‡»é€šè¿‡å»¶è¿Ÿæ—¶é—´åˆ¤æ–­ã€‚ï¼‰</p>
<h2 id="Requirements"><a href="#Requirements" class="headerlink" title="Requirements"></a>Requirements</h2><ul>
<li>æ¯æ¬¡è®¿é—®DMACéƒ½ä¼šé™·å…¥hypervisorã€‚</li>
<li>DMACåªæ‰§è¡Œç¬¦åˆè®¿é—®ç­–ç•¥çš„æ“ä½œã€‚å³MMUæ”¯æŒæƒé™çš„è¯»å†™ã€‚</li>
<li>guestä¸èƒ½ä»£è¡¨å…¶ä»–guestå‘é€DMAè¯·æ±‚ã€‚</li>
<li>è°ƒåº¦ä¸ä¼šå½±å“å®‰å…¨æ€§ã€‚</li>
<li>hypervisorä¸èƒ½è¢«guestä¿®æ”¹ã€‚</li>
<li>DMACä»»åŠ¡è¦ä¹ˆç”±DMACå¤„ç†ï¼Œè¦ä¹ˆè¿›å…¥é˜Ÿåˆ—ã€‚</li>
<li>æ¯ä¸ªDMAè¯·æ±‚éƒ½ä¼šè¢«å¤„ç†ï¼Œå¤„ç†äº†ä¹‹åä»DMACåˆ é™¤ã€‚</li>
</ul>
<p>1-5ä¿è¯äº†éš”ç¦»æ€§ï¼Œ6-7ä¿è¯äº†å¯ç”¨æ€§ï¼ˆAvailabilityï¼‰ã€‚</p>
<h2 id="Designï¼š"><a href="#Designï¼š" class="headerlink" title="Designï¼š"></a>Designï¼š</h2><p>è®¾å¤‡è¢«æ˜ å°„è¿›å†…å­˜ï¼Œäºæ˜¯å—MMUæ§åˆ¶ï¼Œäºæ˜¯å¯ä»¥æ§åˆ¶æ‹¦æˆªä¸DMACç›¸å…³çš„æ“ä½œã€‚<br>DMACæ˜¯OVPæ¨¡æ‹Ÿçš„ï¼Œhypervisoræ˜¯ä¸€ä¸ªåˆ«äººå®ç°è½»é‡çº§çš„ã€‚æ ¸å¿ƒå°±æ˜¯DMAè™šæ‹ŸåŒ–ï¼Œå³æ¨¡æ‹ŸDMACï¼Œå°±æ˜¯åœ¨ä½¿ç”¨çœŸæ˜¯DMACä¹‹å‰ï¼Œä¼šé™·å…¥hypervisorï¼Œåœ¨æ¨¡æ‹ŸDMACå¤„è¿›è¡Œç®¡ç†è½¬å‘ã€‚</p>
<ul>
<li>Shadow Copies and Schedulingï¼šä¸ºæ¯ä¸ªå®¢æˆ·æ¨¡å¼è®¾ç½®ä¸€ä¸ªDMACå‰¯æœ¬ï¼Œä»è€Œé˜²æ­¢DMACè®¾ç½®æœŸé—´çš„å¹²æ‰°ï¼Œå½“guestéœ€è¦å†™å…¥DMACå¯„å­˜å™¨æ—¶ï¼Œè¢«hypervisoræ‹¦æˆªï¼Œç„¶åå°†å…¶å†™å…¥shadow DMACï¼Œç‰©ç†DMACåªæ¥å—hypervisorå‘é€è¿‡æ¥çš„æ•°æ®ã€‚ç„¶åç”¨ä¸€ä¸ªé˜Ÿåˆ—å»è°ƒåº¦æ‰€æœ‰çš„DMA tasksï¼Œç›¸åº”çš„shadow DMACä¸­çš„ä»»åŠ¡è¢«è®¾ç½®ä¸ºwaitingçŠ¶æ€å’ŒactiveçŠ¶æ€ã€‚</li>
<li>Trapping with the Data Abort Handlerï¼šé™·å…¥hypervisoråï¼Œdata abort handlerä¼šå¯¹è™šæ‹Ÿçš„DMAè¯·æ±‚è¿›è¡Œç¿»è¯‘ï¼Œè½½å…¥çœŸå®çš„ç‰©ç†DMACã€‚</li>
<li>Trapping with the Data Abort Handlerï¼šï¼Ÿï¼Ÿç›´æ¥ç”¨MMUç›¸å…³çš„æƒé™ã€‚</li>
<li>Handling DMA Interruptsï¼šç”¨ä»¥é€šçŸ¥DMAå·²ç»å®Œæˆï¼Œhypervisorä¼šæ”¶åˆ°è¿™äº›interruptsï¼Œç„¶åå‘é€ç»™guestã€‚</li>
</ul>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>DMA</tag>
      </tags>
  </entry>
  <entry>
    <title>HyperFuzzerï¼šAn Efficient Hybrid Fuzzer for Virtual CPUs</title>
    <url>/2022/05/08/paper_reading/Fuzz/HyperFuzzer/</url>
    <content><![CDATA[<h1 id="HyperFuzzer-An-Efficient-Hybrid-Fuzzer-for-Virtual-CPUs"><a href="#HyperFuzzer-An-Efficient-Hybrid-Fuzzer-for-Virtual-CPUs" class="headerlink" title="HyperFuzzer: An Efficient Hybrid Fuzzer for Virtual CPUs"></a>HyperFuzzer: An Efficient Hybrid Fuzzer for Virtual CPUs</h1><h2 id="contribution"><a href="#contribution" class="headerlink" title="contribution"></a>contribution</h2><ul>
<li>The first efficient hybrid fuzzer for virtual CPUs without using a slow hardware emulator. </li>
<li>The Nimble Symbolic Execution technique that enables whitebox fuzzing for virtual CPUs with only a control-flow trace recorded by the commodity hardware. </li>
<li>An effective prototype of HyperFuzzer that has found 11 previously unknown virtual CPU bugs in the Hyper-V hypervisor.</li>
</ul>
<h2 id="motivation"><a href="#motivation" class="headerlink" title="motivation"></a>motivation</h2><p>â€‹	è¿™ç¯‡paperä»¥ä¸€ä¸ªhyperfuzzeræ‰¾åˆ°çš„bugæ¥è§£é‡ŠåŠ¨æœºã€‚è¿™ä¸ªbugå‘ç”Ÿåœ¨16bit ä¿æŠ¤æ¨¡å¼ä¸‹çš„æƒ…å†µï¼Œå¹¶ä¸”æ²¡æœ‰é¡µé¢ä¿æŠ¤çš„æ—¶å€™ï¼ŒVMè¯•å›¾æ‰§è¡Œä¸€ä¸ªAPICçš„MMIOåŒºåŸŸçš„æŒ‡ä»¤ï¼Œè¯¥æŒ‡ä»¤è¢«mapåœ¨ç‰©ç†åœ°å€0xFEE00000ä½ç½®ï¼Œéšåä¼štrapè¿›å…¥hypervisoræ¨¡æ‹Ÿè¯¥æŒ‡ä»¤ï¼Œåœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œhypervisorå‘ç°VMå¤„äº16bitæƒ…å†µä¸‹ï¼Œäºæ˜¯ä¼šæŠŠå‰é¢çš„ç‰©ç†åœ°å€è½¬ä¸ºä½16ä½ï¼Œå³0x0000ï¼Œä»è€Œå‘ç”Ÿbugã€‚è¿™ä¸»è¦æ˜¯ç”±äºhypervisoræ— æ³•ç†è§£åœ¨x86ä¸Š16bitå®æ¨¡å¼å’Œ16bitä¿æŠ¤æ¨¡å¼çš„åŒºåˆ«ã€‚16bitå®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼çš„æœ‰æ•ˆæ•°æ®åœ°å€éƒ½æ˜¯16bitï¼Œç„¶åæŒ‡ä»¤æŒ‡é’ˆåœ¨å®æ¨¡å¼ä¸‹æ˜¯16bitï¼Œåœ¨ä¿æŠ¤æ¨¡å¼ä¸‹æ˜¯32bitã€‚ï¼ˆè¿™ç§å·®å¼‚åœ¨æ‰‹å†Œä¸­ä¹Ÿæ²¡æœ‰è¯¦ç»†è¯´æ˜ï¼‰ã€‚</p>
<p>â€‹	ä¸ºäº†æ‰¾å¯»è¿™ç§bugï¼Œä»è€Œå¼€å‘äº†hyperfuzzerï¼Œå¹¶ä¸”æå‡ºäº†ä¸¤ä¸ªrequirementsï¼š</p>
<ul>
<li>å¿…é¡»mutateä¸€ä¸ªVM entire stateï¼Œè€Œä¸æ˜¯ä»…ä»…æ˜¯å®ƒè¿è¡Œçš„æŒ‡ä»¤ã€‚è¿™æ˜¯ç”±äºæœ‰äº›çŠ¶æ€å®šä¹‰äº†vmçš„æ¨¡å¼çŠ¶æ€ï¼Œå°±æ¯”å¦‚ä¸Šé¢bugæ‰€è¯´çš„16bitä¿æŠ¤æ¨¡å¼ï¼Œè¿™äº›çŠ¶æ€æ˜¯è¢«GDTä¸­çš„ä¸¤ä¸ªbitä½æ§åˆ¶çš„ã€‚</li>
<li>HyperFuzzerå¿…é¡»æ”¯æŒåŸºäºåŠ¨æ€ç¬¦å·æ‰§è¡Œçš„ç²¾ç¡®è¾“å…¥ç”Ÿæˆã€‚ä¸ºäº†åœ¨16ä½ä¿æŠ¤æ¨¡å¼ä¸‹ç”Ÿæˆæ–°çš„è™šæ‹ŸæœºçŠ¶æ€ï¼ŒHyperFuzzeréœ€è¦å¯¹guest GDTä¸­çš„2ä½è¿›è¡Œåç½®ã€‚è¿™è¦æ±‚å®ƒç²¾ç¡®åœ°è·Ÿè¸ªè™šæ‹Ÿæœºç®¡ç†ç¨‹åºæ£€æŸ¥guest VMæ¨¡å¼æ—¶çš„è·¯å¾„çº¦æŸã€‚</li>
</ul>
<h2 id="overview"><a href="#overview" class="headerlink" title="overview"></a>overview</h2><h3 id="thread-model"><a href="#thread-model" class="headerlink" title="thread model"></a>thread model</h3><p>â€‹	å‡è®¾æ”»å‡»è€…èƒ½å¤Ÿå®Œå…¨æ§åˆ¶guest VMï¼Œå¹¶ä¸”èƒ½å¤Ÿæ§åˆ¶è™šæ‹Ÿç¡¬ç›˜ï¼Œç”±æ­¤å¯ä»¥æ§åˆ¶bootçš„ä»£ç ä»¥åŠguestOSã€‚</p>
<h3 id="hyperfuzzerâ€™s-design"><a href="#hyperfuzzerâ€™s-design" class="headerlink" title="hyperfuzzerâ€™s design"></a>hyperfuzzerâ€™s design</h3><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211209131632848.png" alt="image-20211209131632848"></p>
<p>Inputså°±æ˜¯ä¸€ä¸ªå®Œæ•´çš„VM stateï¼Œå³ä¸€äº›å¯„å­˜å™¨çŠ¶æ€ï¼Œä¸€äº›å³å°†è¿è¡Œçš„æŒ‡ä»¤ä»¥åŠè¿™äº›æŒ‡ä»¤è¿è¡Œçš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</p>
<p>æ¯ä¸ªinput loopä¼šåœ¨hyper-Vçš„ä¸€ä¸ªVMä¸­è¿è¡Œï¼Œè¿™äº›VMä¼šè§¦å‘VCPUçš„æ‰§è¡Œï¼Œç„¶åå¯èƒ½ä¼šæš‚åœVM è§¦å‘ä¸€ä¸ªé™·å…¥åˆ°hypervisorã€‚åœ¨è¿™ä¸ªè¿‡ç¨‹ä¸­ï¼Œhyperfuzzeråˆ©ç”¨Intel PTç­‰ç¡¬ä»¶ç‰¹æ€§å»è®°å½•æ§åˆ¶æµã€‚</p>
<h2 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h2><h3 id="fuzzing-setup"><a href="#fuzzing-setup" class="headerlink" title="fuzzing setup"></a>fuzzing setup</h3><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211209132958700.png" alt="image-20211209132958700"></p>
<h3 id="è¾“å…¥æ¨¡å‹ï¼šå°†-VM-å®Œæ•´çŠ¶æ€ä½œä¸º-fuzzing-input"><a href="#è¾“å…¥æ¨¡å‹ï¼šå°†-VM-å®Œæ•´çŠ¶æ€ä½œä¸º-fuzzing-input" class="headerlink" title="è¾“å…¥æ¨¡å‹ï¼šå°† VM å®Œæ•´çŠ¶æ€ä½œä¸º fuzzing input"></a>è¾“å…¥æ¨¡å‹ï¼šå°† VM å®Œæ•´çŠ¶æ€ä½œä¸º fuzzing input</h3><ul>
<li>ä¼ ç»Ÿçš„ fuzzing é€šå¸¸æŠŠâ€œæŒ‡ä»¤â€ã€â€œå‚æ•°â€æˆ–â€œç³»ç»Ÿè°ƒç”¨â€ä½œä¸ºè¾“å…¥æ¥å˜å¼‚ã€‚HyperFuzzer çš„ insight æ˜¯ï¼š<strong>è™šæ‹Ÿ CPU çš„è¡Œä¸ºä¸»è¦ç”±è™šæ‹ŸæœºçŠ¶æ€ï¼ˆVM stateï¼ŒåŒ…æ‹¬å¯„å­˜å™¨ã€å†…å­˜ã€æ§åˆ¶ç»“æ„ç­‰ï¼‰å†³å®š</strong>ã€‚</li>
<li>å› æ­¤æ¯ä¸ª fuzzing æ ·æœ¬æ˜¯ä¸€ä¸ª VM çš„å®Œæ•´çŠ¶æ€å¿«ç…§ï¼ˆæˆ–è€…è¯´è¶³å¤Ÿå®Œæ•´ä»¥ä½¿å¾— hypervisor åœ¨ç¬¬ä¸€æ¬¡ VM é€€å‡ºæ—¶å¯ä»¥æ‰§è¡Œï¼‰ã€‚é€šè¿‡å˜å¼‚è¯¥çŠ¶æ€ï¼Œæ—¢å¯ä»¥å˜å¼‚è¦æ‰§è¡Œçš„æŒ‡ä»¤ï¼Œä¹Ÿå¯ä»¥å˜å¼‚å‘¨å›´çš„æ¶æ„ç¯å¢ƒï¼ˆä¾‹å¦‚æ®µå¯„å­˜å™¨ã€é¡µè¡¨ã€æ§åˆ¶å¯„å­˜å™¨ç­‰ï¼‰ã€‚</li>
<li>ä¸ºäº†æ•ˆç‡ï¼ŒHyperFuzzer å¹¶ä¸è¦æ±‚ snapshot åŒ…å«å†—ä½™æ— ç”¨çŠ¶æ€ï¼Œè€Œæ˜¯ç²¾ç®€åˆ°â€œæ¶æ„ä¸Šå¿…é¡»çš„é‚£éƒ¨åˆ†â€ï¼ˆä¾‹å¦‚é¡µè¡¨åªæœ‰åœ¨å¿…è¦æ—¶å€™æ‰åŒ…å«ç­‰ï¼‰ã€‚è¿™æ ·è¾“å…¥ä½“ç§¯å¯ä»¥å‹å¾—å¾ˆå°ï¼ˆå‡ ç™¾å­—èŠ‚çº§åˆ«ï¼‰ï¼Œä¾¿äºå¿«é€Ÿå˜å¼‚ä¸æ¢å¤ã€‚</li>
</ul>
<h3 id="Fuzzing-è¿è¡Œæ–¹å¼ï¼šåªè§¦å‘ç¬¬ä¸€ä¸ª-VM-trap"><a href="#Fuzzing-è¿è¡Œæ–¹å¼ï¼šåªè§¦å‘ç¬¬ä¸€ä¸ª-VM-trap" class="headerlink" title="Fuzzing è¿è¡Œæ–¹å¼ï¼šåªè§¦å‘ç¬¬ä¸€ä¸ª VM trap"></a>Fuzzing è¿è¡Œæ–¹å¼ï¼šåªè§¦å‘ç¬¬ä¸€ä¸ª VM trap</h3><ul>
<li>ä¸ºäº†ç®€åŒ–åˆ†æï¼ŒHyperFuzzer è®¾è®¡è®© VM åœ¨æ¢å¤å <strong>ç«‹å³è§¦å‘ä¸€æ¬¡ VM é€€å‡ºï¼ˆVMEXITï¼‰</strong>ï¼Œå³ guest æ‰§è¡Œä¸€æ¡ç‰¹æ®ŠæŒ‡ä»¤æˆ–è€…é€šè¿‡å•æ­¥å¼ºåˆ¶é€€å‡ºï¼Œä»¥ä¾¿ hypervisor ä»‹å…¥ã€‚ç„¶åæŠ“å–è¿™æ¬¡é€€å‡ºè¿›å…¥ hypervisor çš„æ§åˆ¶æµæ‰§è¡Œï¼Œå¤„ç†å®Œè¿™æ¬¡é€€å‡ºä¹‹åå°±åœæ­¢è¯¥æ‰§è¡Œã€‚å³åª fuzz â€œå•æ¬¡ trap è¿›å…¥ hypervisor çš„è¿™æ¡è·¯å¾„â€ã€‚</li>
<li>è¿™æ ·åšçš„å¥½å¤„æ˜¯ï¼š<ol>
<li>é¿å…åœ¨ guest ä¸­åšå¤§é‡æ‰§è¡Œä¸ç¬¦å·è¿½è¸ªï¼ˆå‡å°‘å¤æ‚æ€§ï¼‰<ol start="2">
<li>æ¯æ¬¡æµ‹è¯•çš„è·¯å¾„è¾ƒçŸ­ï¼Œä½¿å¾—ç¬¦å·æ‰§è¡Œã€çº¦æŸæ±‚è§£æ›´åŠ å¯æ§</li>
</ol>
</li>
</ol>
</li>
<li>è™½ç„¶çœ‹ä¼¼åªèƒ½è¦†ç›–ä¸€æ¬¡ VMEXIT çš„ä»£ç è·¯å¾„ï¼Œä½†è®ºæ–‡è®¤ä¸ºï¼šå› ä¸ºä½ å¯ä»¥å¯¹ VM çŠ¶æ€åšå˜å¼‚ï¼Œä¸åŒçš„çŠ¶æ€å°±å¯èƒ½è§¦å‘ hypervisor å†…ä¸åŒçš„åˆ†æ”¯ï¼é€€å‡ºè¡Œä¸ºï¼Œä»è€Œæ•´ä½“å¯ä»¥æ¢ç´¢è¾ƒä¸ºå…¨é¢çš„ vCPU å®ç°ã€‚</li>
</ul>
<h3 id="Nimble-Symbolic-Executionï¼ˆNSEï¼‰ï¼šç”¨ä½å¼€é”€æ§åˆ¶æµ-é‡æ„è¿‘ä¼¼æ‰§è¡Œè½¨è¿¹"><a href="#Nimble-Symbolic-Executionï¼ˆNSEï¼‰ï¼šç”¨ä½å¼€é”€æ§åˆ¶æµ-é‡æ„è¿‘ä¼¼æ‰§è¡Œè½¨è¿¹" class="headerlink" title="Nimble Symbolic Executionï¼ˆNSEï¼‰ï¼šç”¨ä½å¼€é”€æ§åˆ¶æµ + é‡æ„è¿‘ä¼¼æ‰§è¡Œè½¨è¿¹"></a>Nimble Symbolic Executionï¼ˆNSEï¼‰ï¼šç”¨ä½å¼€é”€æ§åˆ¶æµ + é‡æ„è¿‘ä¼¼æ‰§è¡Œè½¨è¿¹</h3><ul>
<li>ä¼ ç»Ÿçš„ç¬¦å·æ‰§è¡Œï¼ˆç™½ç›’åˆ†æï¼‰éœ€è¦è¯¦å°½çš„æ‰§è¡Œè½¨è¿¹ï¼ˆcontrol flow + data flowï¼‰è®°å½•ã€‚ä½†è¿™æ ·ä¼šå¸¦å·¨å¤§çš„å¼€é”€ï¼Œå°¤å…¶æ˜¯åœ¨ hypervisor çº§åˆ«ã€‚HyperFuzzer ä¸è®°å½•å®Œæ•´æ•°æ®æµï¼Œä»…å€ŸåŠ©<strong>ç¡¬ä»¶è·Ÿè¸ªæœºåˆ¶</strong>ï¼ˆå¦‚ Intel Processor Trace, PTï¼‰æ¥è®°å½• <strong>æ§åˆ¶æµ</strong>ï¼Œå³æŒ‡ä»¤&#x2F;åˆ†æ”¯èµ°å‘ï¼ˆä¸è®°å½•å¯„å­˜å™¨æˆ–å†…å­˜å…·ä½“å€¼ï¼‰</li>
<li>ç„¶åï¼Œé€šè¿‡å·²çŸ¥çš„ fuzzing inputï¼ˆå³ VM çŠ¶æ€ï¼‰+ æ§åˆ¶æµè®°å½•ï¼Œ<strong>åœ¨ç”¨æˆ·æ€é‡æ„ä¸€ä¸ªâ€œè¿‘ä¼¼â€çš„æ‰§è¡Œè½¨è¿¹</strong>ï¼Œåœ¨è¿™ä¸ªè½¨è¿¹ä¸Šåšç¬¦å·æ‰§è¡Œã€è·¯å¾„çº¦æŸå¤„ç†ï¼Œç”Ÿæˆæ–°çš„è¾“å…¥ã€‚è¿™ä¸ªè¿‡ç¨‹å°±æ˜¯è®ºæ–‡ç§°çš„ <strong>Nimble Symbolic Execution (NSE)</strong>ã€‚</li>
<li>åœ¨é‡æ„è¿‡ç¨‹ä¸­é¢ä¸´ä¸¤å¤§æŒ‘æˆ˜ï¼š<br>  \1. <strong>ç¼ºå¤±å†…éƒ¨æœªçŸ¥çŠ¶æ€</strong>ï¼šhypervisor å†…éƒ¨å¯èƒ½æœ‰ä¸€äº›çŠ¶æ€åœ¨æ§åˆ¶æµè®°å½•é‡Œä¸å¯è§ï¼ˆä¾‹å¦‚è¶…å†…æ ¸å†…éƒ¨çŠ¶æ€ã€ç¼“å­˜ã€å†…éƒ¨æŒ‡é’ˆï¼‰ï¼Œè¿™äº›çŠ¶æ€è‹¥è¢«ç”¨åˆ°è·¯å¾„çº¦æŸæˆ–å†³å®š memory åœ°å€ï¼Œä¼šå½±å“ç¬¦å·æ‰§è¡Œã€‚è®ºæ–‡é€šè¿‡â€œå ä½èµ‹å€¼â€ï¼ˆç»™æœªçŸ¥å†…å­˜&#x2F;å¯„å­˜å™¨èµ‹ä¸€ä¸ªä»»æ„åˆæ³•å…·ä½“å€¼ï¼‰åœ¨å¤šæ•°æƒ…å†µä¸‹è§„é¿é—®é¢˜ï¼›å¹¶æŒ‡å‡ºåœ¨ CPU è™šæ‹ŸåŒ–åœºæ™¯ä¸‹çº¦ 98% çš„è·¯å¾„åˆ¤æ–­ä¸ä¾èµ–è¿™äº›æœªçŸ¥å†…éƒ¨çŠ¶æ€ã€‚<br>  \2. <strong>éšè—ç¡¬ä»¶æ£€æŸ¥ (hidden hardware constraints)</strong>ï¼šç¡¬ä»¶åœ¨åš VMEXIT å‰ä¼šå¯¹ VM çŠ¶æ€åšä¸€äº›éªŒè¯ã€æ£€æŸ¥ï¼ˆè¿™äº›åœ¨ hypervisor ä»£ç é‡Œä¸å¯è§ï¼‰ï¼Œè¿™äº›æ£€æŸ¥ä¸åœ¨æ§åˆ¶æµé‡Œä¹Ÿä¸ä¼šè¢«ç¬¦å·æ‰§è¡Œæ•è·ã€‚è‹¥ç”Ÿæˆçš„æ–°è¾“å…¥è¿åè¿™äº›ç¡¬ä»¶æ£€æŸ¥ï¼Œåˆ™ç¡¬ä»¶å¯èƒ½æ‹’ç»è¿›å…¥ hypervisorã€‚è®ºæ–‡ä¸ºæ­¤åšäº†ä¸¤æ–¹é¢ç¼“è§£ï¼š<br> â€‚- å¯¹ç¬¦å·å˜é‡åš<strong>æŒ‰ä½å»ºæ¨¡</strong>ï¼Œé˜²æ­¢åœ¨æ±‚è§£æ–°è¾“å…¥æ—¶æ— æ„é—´ç ´åé‚£äº›ç¡¬ä»¶å·²æœ‰çš„çº¦æŸï¼ˆæ¯”å¦‚æŸä¸ª bit ä¸€å®šè¦ä¸º 1ï¼‰<br> â€‚- åº”ç”¨ â€œæ— å…³çº¦æŸæ¶ˆé™¤â€ï¼ˆunrelated constraint eliminationï¼‰æŠ€å·§ï¼šåœ¨æ„é€  path constraint æ—¶ï¼Œç§»é™¤ä¸æ¬²ç¿»æµç¨‹åˆ†æ”¯æ— å…³çš„ç¬¦å·å˜é‡æˆ–çº¦æŸï¼Œä»¥å‡å°‘å¯èƒ½å¼•å…¥ä¸ç¡¬ä»¶æ£€æŸ¥å†²çªçš„æ”¹åŠ¨ã€‚</li>
</ul>
<h3 id="æ··åˆæœºåˆ¶ï¼šè¦†ç›–å¯¼å‘-ç¬¦å·æŒ‡å¯¼ç»“åˆ"><a href="#æ··åˆæœºåˆ¶ï¼šè¦†ç›–å¯¼å‘-ç¬¦å·æŒ‡å¯¼ç»“åˆ" class="headerlink" title="æ··åˆæœºåˆ¶ï¼šè¦†ç›–å¯¼å‘ + ç¬¦å·æŒ‡å¯¼ç»“åˆ"></a>æ··åˆæœºåˆ¶ï¼šè¦†ç›–å¯¼å‘ + ç¬¦å·æŒ‡å¯¼ç»“åˆ</h3><ul>
<li>HyperFuzzer çš„ fuzzing å¾ªç¯èåˆäº†ç°ç›’å˜å¼‚ (coverage-guided mutation, å¦‚ AFL) å’Œ ç™½ç›’è¾“å…¥ç”Ÿæˆ (é€šè¿‡ NSE) ä¸¤éƒ¨åˆ†ã€‚å¯¹äºè¿›å…¥æ–° coverage çš„æ ·æœ¬ï¼Œä¼šäº¤ç»™ NSE å»ç”Ÿæˆæ–°çš„è¾“å…¥ï¼›æ–°è¾“å…¥å†æ‰§è¡Œã€åˆ¤æ–­æ˜¯å¦æ‰©å±• coverageã€‚</li>
<li>ä¸ºäº†æ•ˆç‡ï¼Œåªæœ‰ä¸€éƒ¨åˆ†æ ·æœ¬ï¼ˆâ€œinteresting inputsâ€ï¼‰æ‰ä¼šè¢«é€å» NSE ç¬¦å·å¤„ç†ï¼Œè€Œéæ‰€æœ‰æ ·æœ¬éƒ½åšç¬¦å·æ‰§è¡Œï¼Œä»è€ŒèŠ‚çœèµ„æºã€‚</li>
</ul>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>Fuzz</tag>
      </tags>
  </entry>
  <entry>
    <title>ä¸­æ–­</title>
    <url>/2022/04/27/note/%E4%B8%AD%E6%96%AD/</url>
    <content><![CDATA[<h1 id="ä¸­æ–­"><a href="#ä¸­æ–­" class="headerlink" title="ä¸­æ–­"></a>ä¸­æ–­</h1><p>â€‹	è¯´åˆ°ä¸­æ–­ç¦»ä¸å¼€å¤„ç†å™¨æ¶æ„ï¼Œåœ¨x86æ¶æ„ä¸‹åŒæ­¥çš„ç§°ä¸ºå¼‚å¸¸ï¼Œå¼‚æ­¥çš„ç§°ä¸ºä¸­æ–­ï¼Œå…¶åŒºåˆ«ä¸ºï¼š</p>
<ul>
<li>ä¸­æ–­ï¼šä¸­æ–­åˆ†ä¸ºå¯å±è”½ä¸­æ–­å’Œä¸å¯å±è”½ä¸­æ–­ï¼Œå…¶å¯ä»¥å‘ç”Ÿåœ¨æŒ‡ä»¤æ‰§è¡Œçš„ä»»ä½•æ—¶é—´ï¼Œå…¶ä¸­å¯å±è”½ä¸­æ–­æ˜¯ç”±å¤–éƒ¨è®¾å¤‡å‘å‡ºçš„ä¸­æ–­ï¼Œä¸å¯å±è”½ä¸­æ–­é€šè¿‡NMIå¼•è„šæ¥å…¥CPUã€‚</li>
<li>å¼‚å¸¸ï¼šæŒ‡çš„æ˜¯CPUæ‰§è¡ŒæŒ‡ä»¤çš„åŒæ—¶å‘ç°æ‰§è¡Œè¯¥æŒ‡ä»¤å‡ºé”™ï¼Œå¯ä»¥åˆ†ä¸ºå¤„ç†å™¨æ£€æµ‹å¼‚å¸¸å’Œç¼–ç¨‹å¼‚å¸¸ï¼Œå…¶ä¸­å¤„ç†å™¨æ£€æµ‹å¼‚å¸¸åŒ…æ‹¬æ•…éšœï¼Œé™·é˜±ï¼Œç»ˆæ­¢ï¼›ç¼–ç¨‹å¼‚å¸¸åŒ…æ‹¬ç¨‹åºè°ƒç”¨intç­‰æŒ‡ä»¤æ—¶å‘å‡ºçš„å¼‚å¸¸ï¼ˆè¿™ç§å¼‚å¸¸æœ‰æ—¶å€™ä¹Ÿè¢«æˆä¸ºè½¯ä¸­æ–­ï¼Œå‘½åé—®é¢˜ï¼Œæœ¬æ–‡ç§°å…¶ä¸ºå¼‚å¸¸ï¼‰</li>
</ul>
<h2 id="misc"><a href="#misc" class="headerlink" title="misc"></a>misc</h2><p>æœ¬æ–‡åŸºäºLinux-5.15ã€‚ä¸»è¦æ¶‰åŠä¸­æ–­å¤„ç†ï¼Œå¼‚å¸¸å¤„ç†ï¼Œç³»ç»Ÿè°ƒç”¨ä¸‰ä¸ªæ–¹é¢çš„å‡½æ•°è°ƒç”¨ä»¥åŠLinuxå¤„ç†é€»è¾‘ï¼Œé˜²æ­¢æ··æ·†ã€‚ç¡¬ä»¶ä¸Šçš„å†…å®¹å°±ä¸è¯´äº†ï¼Œéƒ½è€³ç†Ÿèƒ½è¯¦äº†ã€‚</p>
<p>åœ¨<code>arch/x86/include/asm/irq_vectors.h</code>ä¸­åˆ—äº†ä¸€äº›å®ï¼Œç”¨ä»¥è¡¨ç¤º<code>IDT</code>è¡¨çš„ä¸€äº›å¸ƒå±€æƒ…å†µï¼Œå…¶ä¸­å¯ä»¥çŸ¥é“</p>
<ul>
<li>Vectors   0 â€¦  31 	: system traps and exceptions - hardcoded events</li>
<li>Vectors  32 â€¦ 127   : device interrupts</li>
<li>Vector  128              : legacy int80 syscall interface</li>
<li>Vectors 129 â€¦ LOCAL_TIMER_VECTOR-1</li>
<li>Vectors LOCAL_TIMER_VECTOR â€¦ 255 : special interrupts</li>
</ul>
<p>å…¶ä¸­0 ~ 31å·ä¸ºCPUä¿ç•™çš„å¼‚å¸¸ï¼Œ32 ~ 127å·ä¸ºå¤–éƒ¨è®¾å¤‡ä¸­æ–­ï¼Œ128å·ä¸ºç³»ç»Ÿè°ƒç”¨ã€‚</p>
<h2 id="å¼‚å¸¸å¤„ç†"><a href="#å¼‚å¸¸å¤„ç†" class="headerlink" title="å¼‚å¸¸å¤„ç†"></a>å¼‚å¸¸å¤„ç†</h2><p>å…ˆä»å¼‚å¸¸å¤„ç†å¼€å§‹å§ï¼Œå› ä¸ºå¼‚å¸¸æ˜¯åœ¨è¡¨ä¸­æ˜¯0~31å·å‘é‡ã€‚</p>
<p>åœ¨æ–‡ä»¶<code>arch/x86/include/asm/trapnr.h</code>ä¸­ä¿å­˜äº†å¼‚å¸¸å‘é‡çš„å®šä¹‰ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_DE		 0	<span class="comment">/* Divide-by-zero */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_DB		 1	<span class="comment">/* Debug */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_NMI		 2	<span class="comment">/* Non-maskable Interrupt */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_BP		 3	<span class="comment">/* Breakpoint */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_OF		 4	<span class="comment">/* Overflow */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_BR		 5	<span class="comment">/* Bound Range Exceeded */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_UD		 6	<span class="comment">/* Invalid Opcode */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_NM		 7	<span class="comment">/* Device Not Available */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_DF		 8	<span class="comment">/* Double Fault */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_OLD_MF		 9	<span class="comment">/* Coprocessor Segment Overrun */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_TS		10	<span class="comment">/* Invalid TSS */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_NP		11	<span class="comment">/* Segment Not Present */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_SS		12	<span class="comment">/* Stack Segment Fault */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_GP		13	<span class="comment">/* General Protection Fault */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_PF		14	<span class="comment">/* Page Fault */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_SPURIOUS	15	<span class="comment">/* Spurious Interrupt */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_MF		16	<span class="comment">/* x87 Floating-Point Exception */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_AC		17	<span class="comment">/* Alignment Check */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_MC		18	<span class="comment">/* Machine Check */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_XF		19	<span class="comment">/* SIMD Floating-Point Exception */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_VE		20	<span class="comment">/* Virtualization Exception */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_CP		21	<span class="comment">/* Control Protection Exception */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_VC		29	<span class="comment">/* VMM Communication Exception */</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> X86_TRAP_IRET		32	<span class="comment">/* IRET Exception */</span></span></span><br></pre></td></tr></table></figure>



<h3 id="å¼‚å¸¸å‘é‡åˆå§‹åŒ–"><a href="#å¼‚å¸¸å‘é‡åˆå§‹åŒ–" class="headerlink" title="å¼‚å¸¸å‘é‡åˆå§‹åŒ–"></a>å¼‚å¸¸å‘é‡åˆå§‹åŒ–</h3><p>é¦–å…ˆå¯åŠ¨å†…æ ¸æ—¶å€™ï¼Œéœ€è¦åˆå§‹åŒ–å¼‚å¸¸å‘é‡è¡¨ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">start_kernel()  <span class="comment">//init/main.c</span></span><br><span class="line"> -&gt;trap_init() 	<span class="comment">//arch/x86/kernel/traps.c</span></span><br><span class="line">  -&gt;idt_setup_traps()	<span class="comment">//arch/x86/kernel/idt.c</span></span><br><span class="line">   -&gt;idt_setup_from_table(idt_table, def_idts, ARRAY_SIZE(def_idts), <span class="literal">true</span>);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢æœ€åè°ƒç”¨åœ¨å‡½æ•°<code>idt_setup_from_table</code>ä¸­ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°çš„å‡ ä¸ªå‚æ•°å®šä¹‰ã€‚åœ¨<code>arch/x86/kernel/idt.c</code>ä¸­å®šä¹‰äº†idtè¡¨å’Œæè¿°ç¬¦ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> gate_desc idt_table[IDT_ENTRIES] __page_aligned_bss;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="class"><span class="keyword">struct</span> <span class="title">desc_ptr</span> <span class="title">idt_descr</span> __<span class="title">ro_after_init</span> =</span> &#123;</span><br><span class="line">	.size		= IDT_TABLE_SIZE - <span class="number">1</span>,</span><br><span class="line">	.address	= (<span class="type">unsigned</span> <span class="type">long</span>) idt_table,</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">const</span> __initconst <span class="class"><span class="keyword">struct</span> <span class="title">idt_data</span> <span class="title">def_idts</span>[] =</span> &#123;</span><br><span class="line">	INTG(X86_TRAP_DE,		asm_exc_divide_error),</span><br><span class="line">	ISTG(X86_TRAP_NMI,		asm_exc_nmi, IST_INDEX_NMI),</span><br><span class="line">	INTG(X86_TRAP_BR,		asm_exc_bounds),</span><br><span class="line">	INTG(X86_TRAP_UD,		asm_exc_invalid_op),</span><br><span class="line">	INTG(X86_TRAP_NM,		asm_exc_device_not_available),</span><br><span class="line">	INTG(X86_TRAP_OLD_MF,		asm_exc_coproc_segment_overrun),</span><br><span class="line">	INTG(X86_TRAP_TS,		asm_exc_invalid_tss),</span><br><span class="line">	INTG(X86_TRAP_NP,		asm_exc_segment_not_present),</span><br><span class="line">	INTG(X86_TRAP_SS,		asm_exc_stack_segment),</span><br><span class="line">	INTG(X86_TRAP_GP,		asm_exc_general_protection),</span><br><span class="line">	INTG(X86_TRAP_SPURIOUS,		asm_exc_spurious_interrupt_bug),</span><br><span class="line">	INTG(X86_TRAP_MF,		asm_exc_coprocessor_error),</span><br><span class="line">	INTG(X86_TRAP_AC,		asm_exc_alignment_check),</span><br><span class="line">	INTG(X86_TRAP_XF,		asm_exc_simd_coprocessor_error),</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_32</span></span><br><span class="line">	TSKG(X86_TRAP_DF,		GDT_ENTRY_DOUBLEFAULT_TSS),</span><br><span class="line"><span class="meta">#<span class="keyword">else</span></span></span><br><span class="line">	ISTG(X86_TRAP_DF,		asm_exc_double_fault, IST_INDEX_DF),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">	ISTG(X86_TRAP_DB,		asm_exc_debug, IST_INDEX_DB),</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_MCE</span></span><br><span class="line">	ISTG(X86_TRAP_MC,		asm_exc_machine_check, IST_INDEX_MCE),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_AMD_MEM_ENCRYPT</span></span><br><span class="line">	ISTG(X86_TRAP_VC,		asm_exc_vmm_communication, IST_INDEX_VC),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line">	SYSG(X86_TRAP_OF,		asm_exc_overflow),</span><br><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IA32_EMULATION)</span></span><br><span class="line">	SYSG(IA32_SYSCALL_VECTOR,	entry_INT80_compat),</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_X86_32)</span></span><br><span class="line">	SYSG(IA32_SYSCALL_VECTOR,	entry_INT80_32),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br><span class="line"></span><br></pre></td></tr></table></figure>



<p><code>idt_setup_from_table</code>å‡½æ•°æœ¬è´¨å°±æ˜¯å°†<code>def_idts</code>å†…å®¹èµ‹ç»™<code>idt_table</code>ã€‚</p>
<p>æˆ‘ä»¬ä¸€ä¸ªä¸ªåˆ†æï¼Œåœ¨åˆ†æ<code>def_idts</code>ä¹‹å‰é¦–å…ˆå¾—çœ‹å‡ ä¸ªå®ï¼Œå¦‚ä¸‹æ‰€ç¤ºã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> G(_vector, _addr, _ist, _type, _dpl, _segment)	\</span></span><br><span class="line"><span class="meta">	&#123;						\</span></span><br><span class="line"><span class="meta">		.vector		= _vector,		\</span></span><br><span class="line"><span class="meta">		.bits.ist	= _ist,			\</span></span><br><span class="line"><span class="meta">		.bits.type	= _type,		\</span></span><br><span class="line"><span class="meta">		.bits.dpl	= _dpl,			\</span></span><br><span class="line"><span class="meta">		.bits.p		= 1,			\</span></span><br><span class="line"><span class="meta">		.addr		= _addr,		\</span></span><br><span class="line"><span class="meta">		.segment	= _segment,		\</span></span><br><span class="line"><span class="meta">	&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">/* Interrupt gate */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> INTG(_vector, _addr)				\</span></span><br><span class="line"><span class="meta">	G(_vector, _addr, DEFAULT_STACK, GATE_INTERRUPT, DPL0, __KERNEL_CS)</span></span><br><span class="line"><span class="comment">/* System interrupt gate */</span></span><br><span class="line"><span class="meta">#<span class="keyword">define</span> SYSG(_vector, _addr)				\</span></span><br><span class="line"><span class="meta">	G(_vector, _addr, DEFAULT_STACK, GATE_INTERRUPT, DPL3, __KERNEL_CS)</span></span><br></pre></td></tr></table></figure>

<p>äºæ˜¯ä¾¿å¯çŸ¥é“å…¶å†…å®¹ä¸ºx86æ¶æ„ä¸‹ä¸­æ–­é—¨æè¿°ç¬¦ï¼Œå…¶æ ¼å¼å¦‚ä¸‹ï¼Œå…¶å®IDTï¼ˆINTERRUPT DESCRIPTOR TABLEï¼‰è¡¨ä¸­çš„è¡¨é¡¹ï¼Œè¯¥è¡¨ç”±IDTRå¯„å­˜å™¨æŒ‡å‘ï¼Œå…¶æ ¼å¼å¦‚ä¸‹å›¾æ‰€ç¤ºã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/imgimage-20220426205810991.png" alt="image-20220426205810991"></p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/imgx86%20%E4%B8%AD%E6%96%AD%E9%97%A8%E6%8F%8F%E8%BF%B0%E7%AC%A6.png" alt="image-20220426171754324"></p>
<p>æœ€åå†æ¥çœ‹æ‰‹å†Œé‡Œä¸€å¼ å›¾ï¼Œè¿™å¼ å›¾å¤§æœ‰é—¨é“ï¼Œé¦–å…ˆå¯ä»¥çœ‹åˆ°Linuxä¸­ç”¨<code>__KERNEL_CS</code>ä½œä¸ºå…¶æ®µæè¿°ç¬¦ï¼Œä¹Ÿå°±æ˜¯å›¾ä¸­çš„GDTè¡¨ä¸­çš„ç´¢å¼•ï¼Œè€Œæˆ‘ä»¬çŸ¥é“Linuxä½¿ç”¨çš„æ˜¯å¹³å¦å†…å­˜æ¨¡å‹ï¼Œæ‰€ä»¥æ®µåŸºå€ä¸º0ï¼Œä¹Ÿå°±å¯¼è‡´offsetå°±æ˜¯å¼‚å¸¸å¤„ç†å‡½æ•°çš„åœ°å€ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/imgx86-interrupt%20call.png" alt="image-20220426173926048"></p>
<p>â€‹	ä¸Šè¿°è¿‡ç¨‹å°†IDTè¡¨è®¾ç½®å¥½ä¹‹åï¼Œåœ¨åé¢ä¼šé€šè¿‡è°ƒç”¨<code>load_idt(&amp;idt_descr);</code>å°†æè¿°ç¬¦å†™å…¥IDTRå¯„å­˜å™¨ï¼Œè‡³æ­¤å°±å®Œæˆäº†IDTçš„åˆå§‹åŒ–ã€‚</p>
<h3 id="å¼‚å¸¸å‘é‡å¤„ç†å‡½æ•°"><a href="#å¼‚å¸¸å‘é‡å¤„ç†å‡½æ•°" class="headerlink" title="å¼‚å¸¸å‘é‡å¤„ç†å‡½æ•°"></a>å¼‚å¸¸å‘é‡å¤„ç†å‡½æ•°</h3><p>å‰é¢æˆ‘ä»¬è¯´åˆ°æŠŠIDTçš„å†…å®¹å¡«å……å®Œï¼Œä½¿å¾—CPUç¡¬ä»¶èƒ½å¤Ÿæ‰¾åˆ°å¼‚å¸¸å‘é‡å¤„ç†å‡½æ•°çš„å…¥å£åœ°å€ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹è¿™äº›å‡½æ•°å†…éƒ¨æ˜¯å¦‚ä½•å¤„ç†çš„ã€‚</p>
<p>åœ¨æ–‡ä»¶<code>arch/x86/kernel/traps.c</code>ä¸­æœ‰ç±»ä¼¼å¦‚ä¸‹çš„å®šä¹‰ï¼Œå¯ä»¥çœ‹åˆ°è¿™äº›å®šä¹‰å¤§éƒ¨åˆ†æœ€åéƒ½ä¼šè°ƒç”¨çš„<code>do_error_trap</code>æ¥è¿›è¡Œå¤„ç†ã€‚ä¹Ÿæœ‰ä¸€éƒ¨åˆ†æ˜¯è‡ªå·±å®ç°çš„å‡½æ•°ï¼Œè‡ªå·±è°ƒç”¨ã€‚åªä¸è¿‡è¿™éƒ¨åˆ†çš„Cä»£ç å®šä¹‰æœ‰ç‚¹éš¾çœ‹æ‡‚ï¼ŒçŸ¥é“å¼‚å¸¸å¤„ç†åé¢åˆ°è¿™æ¥äº†å°±è¡Œã€‚(è€çš„kernelç‰ˆæœ¬æ˜¯é€šè¿‡æ±‡ç¼–ä¸­å®šä¹‰çš„DO_ERRORå‡½æ•°æ¥ä½œä¸ºç»Ÿä¸€çš„å…¥å£ï¼Œæ–°çš„kernelç°åœ¨æ”¹äº†ï¼Œä¸‹ä¸€èŠ‚æˆ‘ä»¬ä¼šè®²ã€‚è¿™ä¹Ÿæ˜¯å› æ­¤ç½‘ä¸Šå’Œå¾ˆå¤šä¹¦ä¸Šéƒ½è®²è§£çš„æ˜¯DO_ERRORå’Œdo_symé‚£ä¸€å¥—)ã€‚å®é™…ä¸Šä¸‹é¢çš„ä»£ç æ˜¾ç¤ºçš„codeå¹¶ä¸æ˜¯åœ¨IDTè¡¨ä¸­å¡«å……çš„åœ°å€ï¼Œç¡¬ä»¶ä¸Šè™½ç„¶è®¾è®¡äº†å¯ä»¥è®©è¿›ç¨‹åœ¨è§¦å‘å¼‚å¸¸æ—¶è·³è½¬åˆ°å¼‚å¸¸å¤„ç†å‡½æ•°çš„ç¡¬ä»¶é€»è¾‘ï¼Œä½†æ˜¯Linuxä¸æ˜¯é‚£ä¹ˆåšçš„ï¼ŒLinuxå°†æ‰€æœ‰IDTè¡¨é¡¹ä¸­callçš„å¼‚å¸¸å¤„ç†å‡½æ•°åœ°å€æ˜¯ä¸€ä¸ªç»Ÿä¸€çš„å…¥å£ï¼Œè¯¥å…¥å£ä¼šåœ¨ä¸‹ä¸€èŠ‚è®²è§£ã€‚ </p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> DEFINE_IDTENTRY(func)						\</span></span><br><span class="line"><span class="meta">static __always_inline void __##func(struct pt_regs *regs);		\</span></span><br><span class="line"><span class="meta"></span></span><br><span class="line">DEFINE_IDTENTRY(exc_divide_error)</span><br><span class="line">&#123;</span><br><span class="line">	do_error_trap(regs, <span class="number">0</span>, <span class="string">&quot;divide error&quot;</span>, X86_TRAP_DE, SIGFPE,</span><br><span class="line">		      FPE_INTDIV, error_get_trap_addr(regs));</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DEFINE_IDTENTRY(exc_overflow)</span><br><span class="line">&#123;</span><br><span class="line">	do_error_trap(regs, <span class="number">0</span>, <span class="string">&quot;overflow&quot;</span>, X86_TRAP_OF, SIGSEGV, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line">DEFINE_IDTENTRY_ERRORCODE(exc_invalid_tss)</span><br><span class="line">&#123;</span><br><span class="line">	do_error_trap(regs, error_code, <span class="string">&quot;invalid TSS&quot;</span>, X86_TRAP_TS, SIGSEGV,</span><br><span class="line">		      <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DEFINE_IDTENTRY_ERRORCODE(exc_segment_not_present)</span><br><span class="line">&#123;</span><br><span class="line">	do_error_trap(regs, error_code, <span class="string">&quot;segment not present&quot;</span>, X86_TRAP_NP,</span><br><span class="line">		      SIGBUS, <span class="number">0</span>, <span class="literal">NULL</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>OKï¼Œæ€»ä¹‹å¼‚å¸¸å¤„ç†æˆ‘ä»¬ç°åœ¨çŸ¥é“æœ€åèµ°åˆ°äº†<code>do_error_trap</code>ï¼Œæˆ‘ä»¬çœ‹çœ‹è¿™ä¸ªå‡½æ•°é‡Œé¢æ˜¯ä»€ä¹ˆä¸œè¥¿ï¼ŒåŒæ ·æ˜¯traps.cæ–‡ä»¶ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">do_error_trap</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs, <span class="type">long</span> error_code, <span class="type">char</span> *str,</span></span><br><span class="line"><span class="params">	<span class="type">unsigned</span> <span class="type">long</span> trapnr, <span class="type">int</span> signr, <span class="type">int</span> sicode, <span class="type">void</span> __user *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	RCU_LOCKDEP_WARN(!rcu_is_watching(), <span class="string">&quot;entry code didn&#x27;t wake RCU&quot;</span>);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (notify_die(DIE_TRAP, str, regs, error_code, trapnr, signr) !=</span><br><span class="line">			NOTIFY_STOP) &#123;</span><br><span class="line">		cond_local_irq_enable(regs);</span><br><span class="line">		do_trap(trapnr, signr, str, regs, error_code, sicode, addr);</span><br><span class="line">		cond_local_irq_disable(regs);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span></span><br><span class="line"><span class="title function_">do_trap</span><span class="params">(<span class="type">int</span> trapnr, <span class="type">int</span> signr, <span class="type">char</span> *str, <span class="keyword">struct</span> pt_regs *regs,</span></span><br><span class="line"><span class="params">	<span class="type">long</span> error_code, <span class="type">int</span> sicode, <span class="type">void</span> __user *addr)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">task_struct</span> *<span class="title">tsk</span> =</span> current;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!do_trap_no_signal(tsk, trapnr, str, regs, error_code))</span><br><span class="line">		<span class="keyword">return</span>;</span><br><span class="line"></span><br><span class="line">	show_signal(tsk, signr, <span class="string">&quot;trap &quot;</span>, str, regs, error_code);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (!sicode)</span><br><span class="line">		force_sig(signr);</span><br><span class="line">	<span class="keyword">else</span></span><br><span class="line">		force_sig_fault(signr, sicode, addr);</span><br><span class="line">&#125;</span><br><span class="line">NOKPROBE_SYMBOL(do_trap);</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°ï¼Œå¾ˆå¤šå¤„ç†è¿‡ç¨‹æœ€åéƒ½èµ°åˆ°äº†<code>do_trap</code>å‡½æ•°é‡Œï¼Œä¸”è¯¥å‡½æ•°é‡Œé€šè¿‡å‘é€ä¸€äº›ä¿¡å·ç»™è¿›ç¨‹æ¥è¿›è¡Œå¤„ç†å¼‚å¸¸ï¼Œè€Œè¿›ç¨‹æ”¶åˆ°ä¿¡å·ä¹‹åä¼šæ‰§è¡Œä¿¡å·å¤„ç†å‡½æ•°ã€‚</p>
<h3 id="çœŸæ­£çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„ä»£ç "><a href="#çœŸæ­£çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„ä»£ç " class="headerlink" title="çœŸæ­£çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„ä»£ç "></a>çœŸæ­£çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„ä»£ç </h3><p>â€‹	å¾ˆå¤šç»†å¿ƒçš„äººåº”è¯¥å‘ç°ï¼Œè°ƒç”¨å¼‚å¸¸å¤„ç†å‡½æ•°çš„æ—¶å€™ä¼šæœ‰ä¸€ä¸ªå‚æ•°pt_regs, ä¹Ÿå°±æ˜¯è¯´æ˜è¿™ä¸ªå‡½æ•°å…¶å®ä¸æ˜¯çœŸæ­£å¡«åˆ°ä¸­æ–­å‘é‡è¡¨é‡Œè·³è½¬çš„å‡½æ•°ï¼Œè€Œæ˜¯åé¢åˆ†å‘çš„å‡½æ•°ï¼Œé‚£ä¹ˆé—®é¢˜å°±æ¥äº†ï¼Œpt_regså‚æ•°æ˜¯ä»€ä¹ˆï¼Œæ˜¯åœ¨ä»€ä¹ˆæ—¶å€™æ„é€ çš„ï¼Ÿæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥è®²è§£çœŸæ­£çš„ä»ç”¨æˆ·æ€é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„ä»£ç é€»è¾‘ã€‚å‰æ–¹åŒ…å«å¤§é‡å¤æ‚çš„æ±‡ç¼–å’Œå®ï¼Œå¾ˆæ™¦æ¶©éš¾æ‡‚ã€‚</p>
<p>â€‹	é¦–å…ˆLinux-kernelåœ¨<code>arch/x86/entry/entry.S</code>ä¸­å®šä¹‰äº†æ‰€æœ‰å†…æ ¸çš„å…¥å£å‡½æ•°ï¼Œå…¶ä¸­idtentryï¼ˆidt entryï¼Œè¿™æ ·å°±æ˜ç™½äº†ï¼‰å‡½æ•°å°±æ˜¯çœŸæ­£å†™åœ¨IDTè¡¨ä¸­çš„åœ°å€ï¼Œå…¶ä»£ç å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * idtentry - Macro to generate entry stubs for simple IDT entries</span><br><span class="line"> * @vector:		Vector number</span><br><span class="line"> * @asmsym:		ASM symbol for the entry point</span><br><span class="line"> * @cfunc:		C function to be called</span><br><span class="line"> * @has_error_code:	Hardware pushed error code on stack</span><br><span class="line"> *</span><br><span class="line"> * The macro emits code to set up the kernel context for straight forward</span><br><span class="line"> * and simple IDT entries. No IST stack, no paranoid entry checks.</span><br><span class="line"> */</span><br><span class="line">.macro idtentry vector asmsym cfunc has_error_code:req</span><br><span class="line">SYM_CODE_START(\asmsym)</span><br><span class="line">	UNWIND_HINT_IRET_REGS offset=\has_error_code*8</span><br><span class="line">	ASM_CLAC</span><br><span class="line"></span><br><span class="line">	.if \has_error_code == 0</span><br><span class="line">		pushq	$-1			/* ORIG_RAX: no syscall to restart */</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	.if \vector == X86_TRAP_BP</span><br><span class="line">		/*</span><br><span class="line">		 * If coming from kernel space, create a 6-word gap to allow the</span><br><span class="line">		 * int3 handler to emulate a call instruction.</span><br><span class="line">		 */</span><br><span class="line">		testb	$3, CS-ORIG_RAX(%rsp)</span><br><span class="line">		jnz	.Lfrom_usermode_no_gap_\@</span><br><span class="line">		.rept	6</span><br><span class="line">		pushq	5*8(%rsp)</span><br><span class="line">		.endr</span><br><span class="line">		UNWIND_HINT_IRET_REGS offset=8</span><br><span class="line">.Lfrom_usermode_no_gap_\@:</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	idtentry_body \cfunc \has_error_code</span><br><span class="line"></span><br><span class="line">_ASM_NOKPROBE(\asmsym)</span><br><span class="line">SYM_CODE_END(\asmsym)</span><br><span class="line">.endm</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>ç¨å¾®åˆ†æä¸€ä¸‹ï¼Œidtentryæ˜¯ä¸€ä¸ªç”ŸæˆIDT entriesçš„å®ï¼Œå…¶ä¼šç”Ÿæˆä¸€ä¸ªå‡½æ•°ï¼Œè¯¥å‡½æ•°æ¥æ”¶ä¸€ä¸ªvecterå‚æ•°ï¼Œä¸€ä¸ªasmsymå‚æ•°ï¼Œä¸€ä¸ªcfuncå‚æ•°ï¼Œä¸€ä¸ªhas_error_codeå‚æ•°ï¼Œå…¶å‚æ•°è¯´æ˜éƒ½åœ¨æ³¨é‡Šé‡Œã€‚</p>
<p>ä½†æ˜¯åœ¨æ‰§è¡Œè¿™ä¸ªå‡½æ•°ä¹‹å‰ï¼Œä¹Ÿå°±æ˜¯åœ¨CPUè‡ªåŠ¨è·³è½¬åˆ°å¼‚å¸¸å¤„ç†å‡½æ•°çš„åŒæ—¶ï¼Œcpuç¡¬ä»¶ä¸Šä¼šåšä¸€äº›äº‹æƒ…ï¼Œé¦–å…ˆä»–ä¼šåˆ°TSSä¸­(trå¯„å­˜å™¨æŒ‡å‘çš„ä¸€ä¸ªç¡¬ä»¶ä¸Šä¸‹æ–‡è¡¨åœ¨GDTä¸­çš„ç´¢å¼•ï¼Œè¯¥è¡¨åœ¨CPUè®¾è®¡çš„æœ¬æ„æ˜¯ç”¨äºç¡¬ä»¶ä¸Šä¸‹æ–‡çš„ä¿å­˜ï¼Œä½†æ˜¯Linuxå¹¶ä¸é‚£ä¹ˆåšï¼ŒLinuxç”¨è½¯ä»¶è¿›è¡Œä¿å­˜ï¼Œè€Œåœ¨å…¶ä¸­å­˜äº†kernel stackçš„åœ°å€ï¼Œtssç»“æ„åœ¨linuxä¸­å®šä¹‰å¦‚ä¸‹)æ‰¾åˆ°kernel stackï¼Œå…¶ä¸­<code>sp0</code>å­—æ®µå­˜å‚¨äº†å†…æ ¸æ ˆçš„åœ°å€ï¼ˆ64ä½å’Œ32ä½çš„å®šä¹‰æœ‰æ‰€ä¸åŒï¼Œä¸è¿‡è¿™æ˜¯æ¶æ„ç›¸å…³å†…å®¹ï¼Œå¾—çœ‹æ‰‹å†Œï¼Œå¤ªç»†çš„ä¸œè¥¿å°±æ²¡å¿…è¦çŸ¥é“é‚£ä¹ˆæ¸…æ¥šäº†ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">x86_hw_tss</span> &#123;</span></span><br><span class="line">	u32			reserved1;</span><br><span class="line">	u64			sp0;</span><br><span class="line">	u64			sp1;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Since Linux does not use ring 2, the &#x27;sp2&#x27; slot is unused by</span></span><br><span class="line"><span class="comment">	 * hardware.  entry_SYSCALL_64 uses it as scratch space to stash</span></span><br><span class="line"><span class="comment">	 * the user RSP value.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	u64			sp2;</span><br><span class="line"></span><br><span class="line">	u64			reserved2;</span><br><span class="line">	u64			ist[<span class="number">7</span>];</span><br><span class="line">	u32			reserved3;</span><br><span class="line">	u32			reserved4;</span><br><span class="line">	u16			reserved5;</span><br><span class="line">	u16			io_bitmap_base;</span><br><span class="line"></span><br><span class="line">&#125; __attribute__((packed));</span><br></pre></td></tr></table></figure>

<p>åˆ‡æ¢åˆ°å†…æ ¸æ ˆä¹‹åï¼ŒCPUè¿˜ä¼šè‡ªåŠ¨å°†å¯„å­˜å™¨å‹æ ˆï¼Œå‹æ ˆé¡ºåºå¦‚ä¸‹å›¾(error codeç”±è½¯ä»¶å‹)ï¼Œå·¦è¾¹æ˜¯32ä½ï¼Œå³è¾¹æ˜¯64ä½ï¼Œæœ€å…ˆå…¥æ ˆæ˜¯SSï¼Œç„¶åæ˜¯RSPï¼Œå› ä¸ºå†…æ ¸æ ˆæ˜¯ä»ä¸Šå¾€ä¸‹å¢é•¿çš„ã€‚å…¶ä¸­çš„error codeå­—æ®µæœ‰äº›å¼‚å¸¸å¤„ç†ä¼šæœ‰ï¼Œæœ‰äº›æ²¡æœ‰ï¼Œæ‰€ä»¥åœ¨<code>idtentry()</code>å®ä¸­13~18è¡Œä¼šè¿›è¡Œåˆ¤æ–­æ˜¯å¦æœ‰error codeï¼Œå¦‚æœæœ‰ä¼šå¼€è¾Ÿerror codeçš„ç©ºé—´å¹¶å‹æ ˆã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/imgimage-20220426212350991.png" alt="image-20220426212350991"></p>
<p>æ¥ç€å‡½æ•°å°±è¿è¡Œ<code>idtentry_body \cfunc \has_error_code</code>åˆ°äº†idtentry_bodyå‡½æ•°å¤„ï¼Œè¯¥å‡½æ•°å®šä¹‰å¦‚ä¸‹ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/**</span><br><span class="line"> * idtentry_body - Macro to emit code calling the C function</span><br><span class="line"> * @cfunc:		C function to be called</span><br><span class="line"> * @has_error_code:	Hardware pushed error code on stack</span><br><span class="line"> */</span><br><span class="line">.macro idtentry_body cfunc has_error_code:req</span><br><span class="line"></span><br><span class="line">	call	error_entry</span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line"></span><br><span class="line">	movq	%rsp, %rdi			/* pt_regs pointer into 1st argument*/</span><br><span class="line"></span><br><span class="line">	.if \has_error_code == 1</span><br><span class="line">		movq	ORIG_RAX(%rsp), %rsi	/* get error code into 2nd argument*/</span><br><span class="line">		movq	$-1, ORIG_RAX(%rsp)	/* no syscall to restart */</span><br><span class="line">	.endif</span><br><span class="line"></span><br><span class="line">	call	\cfunc</span><br><span class="line"></span><br><span class="line">	jmp	error_return</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<p>è¯¥å‡½æ•°åœ¨error_entryå‡½æ•°ä¸­æ„é€ pt_regç»“æ„ä½“ï¼Œå³æŠŠç”¨æˆ·æ€çš„æ—§å¯„å­˜å™¨å‹æ ˆï¼Œç„¶åå°†æ ˆé¡¶æŒ‡é’ˆ(rspæŒ‡å‘pt_regç»“æ„ä½“ï¼Œè¯¥ç»“æ„ä½“æ˜¯æ ˆä¸Šç©ºé—´æ„é€ çš„)ä¼ é€’ç»™rdiï¼Œæˆ‘ä»¬éƒ½çŸ¥é“rdiæ˜¯x64å‡½æ•°è°ƒç”¨çš„ç¬¬ä¸€ä¸ªå‚æ•°ï¼Œä¹Ÿå°±ç»ˆäºå›åˆ°äº†å‰é¢æ‰€æçš„å‚æ•°æ˜¯pt_regsçš„é—®é¢˜äº†ï¼Œæ‰€ä»¥è¿™é‡Œcall \cfuncæ‰æ˜¯å‰é¢<code>DEFINE_IDTENTRY</code>å®šä¹‰çš„çœŸæ­£å‡½æ•°ï¼Œè€Œè¯¥å‚æ•°ä¹Ÿæ˜¯ä»idtentryä¸­ä¸€ç›´ä¼ é€’ä¸‹æ¥çš„ï¼Œç›¸å½“äº:</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">IDTè¡¨æŒ‡å‘</span><br><span class="line">-&gt;idtentry(<span class="built_in">vector</span>, asmsym, cfunc, has_error_code)</span><br><span class="line">	-&gt;idtentry_body(cfun, has_error_code)</span><br><span class="line">		-&gt;cfunc(pt_regs)</span><br></pre></td></tr></table></figure>

<p>ç»ˆäºæ¸…æ¥šäº†æ‰€æœ‰çš„é€»è¾‘ï¼Œæˆ‘ä»¬æœ€åçœ‹çœ‹error_entryä¸­æ€ä¹ˆåšçš„æŠŠã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">/*</span><br><span class="line"> * Save all registers in pt_regs, and switch GS if needed.</span><br><span class="line"> */</span><br><span class="line">SYM_CODE_START_LOCAL(error_entry)</span><br><span class="line">	UNWIND_HINT_FUNC</span><br><span class="line">	cld</span><br><span class="line">	PUSH_AND_CLEAR_REGS save_ret=1</span><br><span class="line">	ENCODE_FRAME_POINTER 8</span><br><span class="line">	testb	$3, CS+8(%rsp)</span><br><span class="line">	jz	.Lerror_kernelspace</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We entered from user mode or we&#x27;re pretending to have entered</span><br><span class="line">	 * from user mode due to an IRET fault.</span><br><span class="line">	 */</span><br><span class="line">	SWAPGS</span><br><span class="line">	FENCE_SWAPGS_USER_ENTRY</span><br><span class="line">	/* We have user CR3.  Change to kernel CR3. */</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rax</span><br><span class="line"></span><br><span class="line">.Lerror_entry_from_usermode_after_swapgs:</span><br><span class="line">	/* Put us onto the real thread stack. */</span><br><span class="line">	popq	%r12				/* save return addr in %12 */</span><br><span class="line">	movq	%rsp, %rdi			/* arg0 = pt_regs pointer */</span><br><span class="line">	call	sync_regs</span><br><span class="line">	movq	%rax, %rsp			/* switch stack */</span><br><span class="line">	ENCODE_FRAME_POINTER</span><br><span class="line">	pushq	%r12</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">.Lerror_entry_done_lfence:</span><br><span class="line">	FENCE_SWAPGS_KERNEL_ENTRY</span><br><span class="line">.Lerror_entry_done:</span><br><span class="line">	ret</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * There are two places in the kernel that can potentially fault with</span><br><span class="line">	 * usergs. Handle them here.  B stepping K8s sometimes report a</span><br><span class="line">	 * truncated RIP for IRET exceptions returning to compat mode. Check</span><br><span class="line">	 * for these here too.</span><br><span class="line">	 */</span><br><span class="line">.Lerror_kernelspace:</span><br><span class="line">	leaq	native_irq_return_iret(%rip), %rcx</span><br><span class="line">	cmpq	%rcx, RIP+8(%rsp)</span><br><span class="line">	je	.Lerror_bad_iret</span><br><span class="line">	movl	%ecx, %eax			/* zero extend */</span><br><span class="line">	cmpq	%rax, RIP+8(%rsp)</span><br><span class="line">	je	.Lbstep_iret</span><br><span class="line">	cmpq	$.Lgs_change, RIP+8(%rsp)</span><br><span class="line">	jne	.Lerror_entry_done_lfence</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * hack: .Lgs_change can fail with user gsbase.  If this happens, fix up</span><br><span class="line">	 * gsbase and proceed.  We&#x27;ll fix up the exception and land in</span><br><span class="line">	 * .Lgs_change&#x27;s error handler with kernel gsbase.</span><br><span class="line">	 */</span><br><span class="line">	SWAPGS</span><br><span class="line">	FENCE_SWAPGS_USER_ENTRY</span><br><span class="line">	jmp .Lerror_entry_done</span><br><span class="line"></span><br><span class="line">.Lbstep_iret:</span><br><span class="line">	/* Fix truncated RIP */</span><br><span class="line">	movq	%rcx, RIP+8(%rsp)</span><br><span class="line">	/* fall through */</span><br><span class="line"></span><br><span class="line">.Lerror_bad_iret:</span><br><span class="line">	/*</span><br><span class="line">	 * We came from an IRET to user mode, so we have user</span><br><span class="line">	 * gsbase and CR3.  Switch to kernel gsbase and CR3:</span><br><span class="line">	 */</span><br><span class="line">	SWAPGS</span><br><span class="line">	FENCE_SWAPGS_USER_ENTRY</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rax</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Pretend that the exception came from user mode: set up pt_regs</span><br><span class="line">	 * as if we faulted immediately after IRET.</span><br><span class="line">	 */</span><br><span class="line">	mov	%rsp, %rdi</span><br><span class="line">	call	fixup_bad_iret</span><br><span class="line">	mov	%rax, %rsp</span><br><span class="line">	jmp	.Lerror_entry_from_usermode_after_swapgs</span><br><span class="line">SYM_CODE_END(error_entry)</span><br></pre></td></tr></table></figure>

<p>å…¶é€šè¿‡è°ƒç”¨<code>PUSH_AND_CLEAR_REGS</code>æ„é€ pt_regsç»“æ„ä½“ï¼Œå°†ç›¸åº”çš„é€šç”¨å¯„å­˜å™¨å…¥æ ˆã€‚</p>
<figure class="highlight cos"><table><tr><td class="code"><pre><span class="line">.macro PUSH_AND_CLEAR_REGS rdx=<span class="built_in">%rdx</span> rax=<span class="built_in">%rax</span> save_ret=<span class="number">0</span></span><br><span class="line">	PUSH_REGS rdx=\rdx, rax=\rax, save_ret=\save_ret</span><br><span class="line">	CLEAR_REGS</span><br><span class="line">.endm</span><br><span class="line"></span><br><span class="line">.macro PUSH_REGS rdx=<span class="built_in">%rdx</span> rax=<span class="built_in">%rax</span> save_ret=<span class="number">0</span></span><br><span class="line">	.<span class="keyword">if</span> \save_ret</span><br><span class="line">	pushq	<span class="built_in">%rsi</span>		<span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">	movq	<span class="number">8</span>(<span class="built_in">%rsp</span>), <span class="built_in">%rsi</span>	<span class="comment">/* temporarily store the return address in %rsi */</span></span><br><span class="line">	movq	<span class="built_in">%rdi</span>, <span class="number">8</span>(<span class="built_in">%rsp</span>)	<span class="comment">/* pt_regs-&gt;di (overwriting original return address) */</span></span><br><span class="line">	.<span class="keyword">else</span></span><br><span class="line">	pushq   <span class="built_in">%rdi</span>		<span class="comment">/* pt_regs-&gt;di */</span></span><br><span class="line">	pushq   <span class="built_in">%rsi</span>		<span class="comment">/* pt_regs-&gt;si */</span></span><br><span class="line">	.endif</span><br><span class="line">	pushq	\rdx		<span class="comment">/* pt_regs-&gt;dx */</span></span><br><span class="line">	pushq   <span class="built_in">%rcx</span>		<span class="comment">/* pt_regs-&gt;cx */</span></span><br><span class="line">	pushq   \rax		<span class="comment">/* pt_regs-&gt;ax */</span></span><br><span class="line">	pushq   <span class="built_in">%r</span>8		<span class="comment">/* pt_regs-&gt;r8 */</span></span><br><span class="line">	pushq   <span class="built_in">%r</span>9		<span class="comment">/* pt_regs-&gt;r9 */</span></span><br><span class="line">	pushq   <span class="built_in">%r</span>10		<span class="comment">/* pt_regs-&gt;r10 */</span></span><br><span class="line">	pushq   <span class="built_in">%r</span>11		<span class="comment">/* pt_regs-&gt;r11 */</span></span><br><span class="line">	pushq	<span class="built_in">%rbx</span>		<span class="comment">/* pt_regs-&gt;rbx */</span></span><br><span class="line">	pushq	<span class="built_in">%rbp</span>		<span class="comment">/* pt_regs-&gt;rbp */</span></span><br><span class="line">	pushq	<span class="built_in">%r</span>12		<span class="comment">/* pt_regs-&gt;r12 */</span></span><br><span class="line">	pushq	<span class="built_in">%r</span>13		<span class="comment">/* pt_regs-&gt;r13 */</span></span><br><span class="line">	pushq	<span class="built_in">%r</span>14		<span class="comment">/* pt_regs-&gt;r14 */</span></span><br><span class="line">	pushq	<span class="built_in">%r</span>15		<span class="comment">/* pt_regs-&gt;r15 */</span></span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line"></span><br><span class="line">	.<span class="keyword">if</span> \save_ret</span><br><span class="line">	pushq	<span class="built_in">%rsi</span>		<span class="comment">/* return address on top of stack */</span></span><br><span class="line">	.endif</span><br><span class="line">.endm</span><br></pre></td></tr></table></figure>

<p>æ¥ç€åé¢å°±ä¸ç»†è®²äº†ï¼Œå…¶ä¸­16è¡Œæœ‰ä¸€ä¸ªSWAPGSæŒ‡ä»¤ï¼Œå…¶ä¼šäº¤æ¢kernelçš„CR3å’Œuserçš„CR3ï¼ŒCR3æ˜¯é¡µè¡¨åŸºå€ï¼Œå¾ˆå¤šäººä¼šé—®åœ°å€ç©ºé—´kernelå’Œuserä¸æ˜¯ä¸€èµ·çš„å—ï¼Œå…¶å®è¿™é‡Œæ˜¯ç”±äºKPTIçš„ç¼˜æ•…ï¼Œå› ä¸ºç†”æ–­meltdownå’Œå¹½çµspecterçš„ç¡¬ä»¶ç¼ºé™·å¯¼è‡´çš„æ¼æ´ï¼Œå†…æ ¸é‡‡ç”¨äº†KPTIï¼Œå°†ç”¨æˆ·é¡µè¡¨å’Œå†…æ ¸é¡µè¡¨éš”ç¦»æ¥é˜²æ­¢ç”¨æˆ·é€šè¿‡ä¾§ä¿¡é“æ”»å‡»è·å–å†…æ ¸æ•°æ®ï¼Œè¿™é‡Œä¾¿æ˜¯KPTIçš„ä½“ç°ï¼Œå…·ä½“è‡ªå·±å»æŸ¥èµ„æ–™ã€‚</p>
<p>æœ€åè´´ä¸€ä¸ªpt_regsç»“æ„ä½“å®šä¹‰ï¼Œçœçš„è¯»è€…å»æ‰¾ï¼Œçœ‹äº†ä¹‹åæ˜¯ä¸æ˜¯çªç„¶å°±æ˜äº†äº†æ ˆä¸Šçš„å¯„å­˜å™¨å­˜å‚¨çš„é¡ºåºï¼ˆ64ä½çš„ï¼‰ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> &#123;</span></span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * C ABI says these regs are callee-preserved. They aren&#x27;t saved on kernel entry</span></span><br><span class="line"><span class="comment"> * unless syscall needs a complete, fully filled &quot;struct pt_regs&quot;.</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r15;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r14;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r13;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r12;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> bx;</span><br><span class="line"><span class="comment">/* These regs are callee-clobbered. Always saved on kernel entry. */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r11;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r10;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r9;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> r8;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ax;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> dx;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> si;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> di;</span><br><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment"> * On syscall entry, this is syscall#. On CPU exception, this is error code.</span></span><br><span class="line"><span class="comment"> * On hw interrupt, it&#x27;s IRQ number:</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> orig_ax;</span><br><span class="line"><span class="comment">/* Return frame for iretq */</span></span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ip;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> cs;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> flags;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> sp;</span><br><span class="line">	<span class="type">unsigned</span> <span class="type">long</span> ss;</span><br><span class="line"><span class="comment">/* top of stack page */</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="æœ‰å§‹æœ‰ç»ˆ"><a href="#æœ‰å§‹æœ‰ç»ˆ" class="headerlink" title="æœ‰å§‹æœ‰ç»ˆ"></a>æœ‰å§‹æœ‰ç»ˆ</h3><p>æ‰§è¡Œå®Œäº†å¼‚å¸¸å¤„ç†å‡½æ•°ï¼Œæ€»å¾—è¿”å›ç”¨æˆ·æ€æŠŠï¼Œå†æ¥çœ‹çœ‹è¿”å›æ—¶å€™çš„é€»è¾‘ã€‚åœ¨idtentry_bodyå‡½æ•°ä¸­æœ€åä¼š<code>jmp error_return</code>è¿”å›ï¼Œå…¶ä¼šåˆ¤æ–­ä¿å­˜çš„csæ˜¯kernelçš„è¿˜æ˜¯userçš„ï¼Œå¦‚æœæ˜¯useråˆ™è¿”å›userï¼Œå¦‚æœæ˜¯kernelè¿”å›kernelã€‚æ¯•ç«Ÿæ‰§è¡Œkernelä»£ç ä¹Ÿå¯èƒ½å‡ºç°å¼‚å¸¸ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_CODE_START_LOCAL(error_return)</span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line">	DEBUG_ENTRY_ASSERT_IRQS_OFF</span><br><span class="line">	testb	$3, CS(%rsp)</span><br><span class="line">	jz	restore_regs_and_return_to_kernel</span><br><span class="line">	jmp	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line">SYM_CODE_END(error_return)</span><br></pre></td></tr></table></figure>

<p>ç„¶åæˆªå–å‡ æ®µæ¯”è¾ƒé‡è¦çš„ï¼Œå’Œå¼¹å‡ºå¯„å­˜å™¨ç›¸å…³çš„ä»£ç ï¼Œå…¶ä¸­POP_REGSå¼¹å‡ºç›¸å…³å¯„å­˜å™¨ï¼Œç„¶åé€šè¿‡iretqæŒ‡ä»¤ä¼šå¼¹å‡ºæœ€åçš„SS:RSP,å¾—åˆ°å­˜å‚¨çš„ç”¨æˆ·&#x2F;å†…æ ¸æ ˆè¿›è¡Œè¿”å›ã€‚è¿™é‡ŒåµŒå¥—äº†å¾ˆå¤šè·³è½¬çš„åœ°æ–¹ï¼Œæ€»è€Œè¨€ä¹‹æœ€åéƒ½ä¼šåˆ°iretqçš„æŒ‡ä»¤ï¼Œä¸­é—´ç»†èŠ‚å°±ä¸ç»†è®²äº†ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_CODE_START_LOCAL(common_interrupt_return)</span><br><span class="line">SYM_INNER_LABEL(swapgs_restore_regs_and_return_to_usermode, SYM_L_GLOBAL)</span><br><span class="line">	POP_REGS pop_rdi=0</span><br><span class="line">	addq	$8, %rsp	/* skip regs-&gt;orig_ax */</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">	popq	%rdi</span><br><span class="line">	SWAPGS</span><br><span class="line">	INTERRUPT_RETURN	/*#define INTERRUPT_RETURN	jmp native_iret*/</span><br><span class="line">SYM_INNER_LABEL(restore_regs_and_return_to_kernel, SYM_L_GLOBAL)</span><br><span class="line">	POP_REGS</span><br><span class="line">	addq	$8, %rsp	/* skip regs-&gt;orig_ax */</span><br><span class="line">	/*</span><br><span class="line">	 * ARCH_HAS_MEMBARRIER_SYNC_CORE rely on IRET core serialization</span><br><span class="line">	 * when returning from IPI handler.</span><br><span class="line">	 */</span><br><span class="line">	INTERRUPT_RETURN  /*#define INTERRUPT_RETURN	jmp native_iret*/</span><br><span class="line">SYM_INNER_LABEL_ALIGN(native_iret, SYM_L_GLOBAL)</span><br><span class="line">	UNWIND_HINT_IRET_REGS</span><br><span class="line">	</span><br><span class="line">	......</span><br><span class="line"></span><br><span class="line">SYM_INNER_LABEL(native_irq_return_iret, SYM_L_GLOBAL)	</span><br><span class="line">	iretq</span><br><span class="line">SYM_CODE_END(common_interrupt_return)</span><br><span class="line">_ASM_NOKPROBE(common_interrupt_return)</span><br></pre></td></tr></table></figure>



<h2 id="ä¸­æ–­å¤„ç†"><a href="#ä¸­æ–­å¤„ç†" class="headerlink" title="ä¸­æ–­å¤„ç†"></a>ä¸­æ–­å¤„ç†</h2><p>è®²å®Œäº†å¼‚å¸¸å†æ¥è®²ä¸­æ–­ã€‚è¿˜æ˜¯ä¸€æ ·çš„è¿‡ç¨‹ï¼Œå…ˆæ˜¯åˆå§‹åŒ–ï¼Œç„¶åæ˜¯å‘ç”Ÿä¸­æ–­æ—¶å€™çš„é€»è¾‘ï¼Œæœ€åæ˜¯é€€å‡ºä¸­æ–­çš„é€»è¾‘ã€‚</p>
<h3 id="ä¸­æ–­å‘é‡åˆå§‹åŒ–"><a href="#ä¸­æ–­å‘é‡åˆå§‹åŒ–" class="headerlink" title="ä¸­æ–­å‘é‡åˆå§‹åŒ–"></a>ä¸­æ–­å‘é‡åˆå§‹åŒ–</h3><p>ä¸­æ–­å‘é‡åˆå§‹åŒ–çš„å‡½æ•°è°ƒç”¨é€»è¾‘å¦‚ä¸‹</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">start_kernel()</span><br><span class="line">    -&gt;init_IRQ()</span><br><span class="line">        -&gt;native_init_IRQ()</span><br><span class="line">            -&gt;idt_setup_apic_and_irq_gates()</span><br><span class="line">                -&gt;idt_setup_from_table(idt_table, apic_idts, ARRAY_SIZE(apic_idts), <span class="literal">true</span>);</span><br><span class="line">			for_each_clear_bit_from(i, system_vectors, FIRST_SYSTEM_VECTOR) &#123;</span><br><span class="line">				entry = irq_entries_start + <span class="number">8</span> * (i - FIRST_EXTERNAL_VECTOR);</span><br><span class="line">				set_intr_gate(i, entry);</span><br><span class="line">			&#125;</span><br><span class="line">                -&gt;load_idt(&amp;idt_descr);</span><br></pre></td></tr></table></figure>

<p>åˆæ˜¯ç†Ÿæ‚‰çš„æ“ä½œå‘—ï¼Œ<code>idt_setup_from_table</code>å‡½æ•°æŠŠ<code>apic_idts</code>çš„å†…å®¹æ‹·è´åˆ°<code>idt_table</code>,ä¸Šé¢è®²è¿‡<code>idt_table</code>æ˜¯ä»€ä¹ˆï¼Œè¿™é‡Œæˆ‘ä»¬å°±çœ‹çœ‹<code>apic_idts</code>å®šä¹‰,å“ˆå“ˆæ˜äº†äº†ï¼Œåˆæ˜¯ä¸€æ ·çš„ä¸œè¥¿ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">const</span> __initconst <span class="class"><span class="keyword">struct</span> <span class="title">idt_data</span> <span class="title">apic_idts</span>[] =</span> &#123;</span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">	INTG(RESCHEDULE_VECTOR,			asm_sysvec_reschedule_ipi),</span><br><span class="line">	INTG(CALL_FUNCTION_VECTOR,		asm_sysvec_call_function),</span><br><span class="line">	INTG(CALL_FUNCTION_SINGLE_VECTOR,	asm_sysvec_call_function_single),</span><br><span class="line">	INTG(IRQ_MOVE_CLEANUP_VECTOR,		asm_sysvec_irq_move_cleanup),</span><br><span class="line">	INTG(REBOOT_VECTOR,			asm_sysvec_reboot),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_THERMAL_VECTOR</span></span><br><span class="line">	INTG(THERMAL_APIC_VECTOR,		asm_sysvec_thermal),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_MCE_THRESHOLD</span></span><br><span class="line">	INTG(THRESHOLD_APIC_VECTOR,		asm_sysvec_threshold),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_MCE_AMD</span></span><br><span class="line">	INTG(DEFERRED_ERROR_VECTOR,		asm_sysvec_deferred_error),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_LOCAL_APIC</span></span><br><span class="line">	INTG(LOCAL_TIMER_VECTOR,		asm_sysvec_apic_timer_interrupt),</span><br><span class="line">	INTG(X86_PLATFORM_IPI_VECTOR,		asm_sysvec_x86_platform_ipi),</span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_HAVE_KVM</span></span><br><span class="line">	INTG(POSTED_INTR_VECTOR,		asm_sysvec_kvm_posted_intr_ipi),</span><br><span class="line">	INTG(POSTED_INTR_WAKEUP_VECTOR,		asm_sysvec_kvm_posted_intr_wakeup_ipi),</span><br><span class="line">	INTG(POSTED_INTR_NESTED_VECTOR,		asm_sysvec_kvm_posted_intr_nested_ipi),</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line"><span class="meta"># <span class="keyword">ifdef</span> CONFIG_IRQ_WORK</span></span><br><span class="line">	INTG(IRQ_WORK_VECTOR,			asm_sysvec_irq_work),</span><br><span class="line"><span class="meta"># <span class="keyword">endif</span></span></span><br><span class="line">	INTG(SPURIOUS_APIC_VECTOR,		asm_sysvec_spurious_apic_interrupt),</span><br><span class="line">	INTG(ERROR_APIC_VECTOR,			asm_sysvec_error_interrupt),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="ä¸­æ–­å¤„ç†å‡½æ•°"><a href="#ä¸­æ–­å¤„ç†å‡½æ•°" class="headerlink" title="ä¸­æ–­å¤„ç†å‡½æ•°"></a>ä¸­æ–­å¤„ç†å‡½æ•°</h3><p>â€‹	è¿˜æ˜¯åŒæ ·çš„ï¼Œç…ç…ä¸­æ–­å¤„ç†å‡½æ•°çš„å®šä¹‰å§ï¼Œè¿™é‡Œæˆªå–äº†ä¸€å°éƒ¨åˆ†ï¼Œç†Ÿæ‚‰çš„DECLARE_IDTENTRYå®ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/* System vector entry points */</span></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_X86_LOCAL_APIC</span></span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(ERROR_APIC_VECTOR,		sysvec_error_interrupt);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(SPURIOUS_APIC_VECTOR,		sysvec_spurious_apic_interrupt);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(LOCAL_TIMER_VECTOR,		sysvec_apic_timer_interrupt);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(X86_PLATFORM_IPI_VECTOR,	sysvec_x86_platform_ipi);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_SMP</span></span><br><span class="line">DECLARE_IDTENTRY(RESCHEDULE_VECTOR,			sysvec_reschedule_ipi);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(IRQ_MOVE_CLEANUP_VECTOR,	sysvec_irq_move_cleanup);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(REBOOT_VECTOR,			sysvec_reboot);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(CALL_FUNCTION_SINGLE_VECTOR,	sysvec_call_function_single);</span><br><span class="line">DECLARE_IDTENTRY_SYSVEC(CALL_FUNCTION_VECTOR,		sysvec_call_function);</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>â€‹	å½“ç„¶å‡½æ•°å†…å®¹ä¹Ÿæˆªå–ä¸€å°éƒ¨åˆ†ï¼Œå°±æ˜¯çœŸæ­£å¤„ç†ä¸­æ–­çš„åœ°æ–¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DEFINE_IDTENTRY_SYSVEC_SIMPLE(sysvec_reschedule_ipi)</span><br><span class="line">&#123;</span><br><span class="line">	ack_APIC_irq();</span><br><span class="line">	trace_reschedule_entry(RESCHEDULE_VECTOR);</span><br><span class="line">	inc_irq_stat(irq_resched_count);</span><br><span class="line">	scheduler_ipi();</span><br><span class="line">	trace_reschedule_exit(RESCHEDULE_VECTOR);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">DEFINE_IDTENTRY_SYSVEC(sysvec_apic_timer_interrupt)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> *<span class="title">old_regs</span> =</span> set_irq_regs(regs);</span><br><span class="line"></span><br><span class="line">	ack_APIC_irq();</span><br><span class="line">	trace_local_timer_entry(LOCAL_TIMER_VECTOR);</span><br><span class="line">	local_apic_timer_interrupt();</span><br><span class="line">	trace_local_timer_exit(LOCAL_TIMER_VECTOR);</span><br><span class="line"></span><br><span class="line">	set_irq_regs(old_regs);</span><br><span class="line">&#125;</span><br><span class="line">......</span><br></pre></td></tr></table></figure>

<p>å½“ç„¶ä¸Šé¢åˆ—å‡ºçš„æ˜¯æœ‰ä¸­æ–­å¤„ç†å‡½æ•°å®šä¹‰çš„åœ°æ–¹ï¼Œä½†æ˜¯ä¸æ˜¯æ‰€æœ‰çš„32~127å·ä¸­æ–­å‘é‡éƒ½è¢«å®šä¹‰äº†çš„ï¼Œè‚¯å®šä¼šæœ‰ä¸€äº›ç©ºç¼ºï¼Œç©ºç¼ºçš„åœ°æ–¹æ€ä¹ˆå¡«å‘¢ï¼Œå›å¿†ä¸€ä¸‹ä¸­æ–­å‘é‡åˆå§‹åŒ–çš„å‡½æ•°è°ƒç”¨é€»è¾‘ï¼Œå¯ä»¥çœ‹åˆ°åœ¨å‡½æ•°<code>idt_setup_apic_and_irq_gates</code>æœ‰é‚£ä¹ˆä¸€éƒ¨åˆ†ä»£ç ï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼Œå…¶å°†IDTä¸­ç©ºç¼ºçš„ä½ç½®ç”¨irq_entries_startåŠ ä¸Šäº†ä¸€ä¸ªåç§»å¡«å……ï¼Œä¹Ÿå°±æ˜¯è·³è½¬åˆ°äº†irq_entries_startæ•°ç»„ä¸­æŸä¸ªindexçš„åœ°æ–¹ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">for_each_clear_bit_from(i, system_vectors, FIRST_SYSTEM_VECTOR) &#123;</span><br><span class="line">	entry = irq_entries_start + <span class="number">8</span> * (i - FIRST_EXTERNAL_VECTOR);</span><br><span class="line">	set_intr_gate(i, entry);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OKæˆ‘ä»¬æ¥çœ‹çœ‹irq_entries_starté‡Œé¢æ˜¯ä»€ä¹ˆï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">	.align 8</span><br><span class="line">SYM_CODE_START(irq_entries_start)</span><br><span class="line">    vector=FIRST_EXTERNAL_VECTOR</span><br><span class="line">    .rept NR_EXTERNAL_VECTORS</span><br><span class="line">	UNWIND_HINT_IRET_REGS</span><br><span class="line">0 :</span><br><span class="line">	.byte	0x6a, vector</span><br><span class="line">	jmp	asm_common_interrupt</span><br><span class="line">	nop</span><br><span class="line">	/* Ensure that the above is 8 bytes max */</span><br><span class="line">	. = 0b + 8</span><br><span class="line">	vector = vector+1</span><br><span class="line">    .endr</span><br><span class="line">SYM_CODE_END(irq_entries_start)</span><br></pre></td></tr></table></figure>

<p>çœ‹ä¸æ‡‚æ²¡å…³ç³»ï¼Œå…¶å®è¿™ä¸ªæ•°ç»„ä¸­å¡«å……äº†8å­—èŠ‚çš„æ±‡ç¼–æŒ‡ä»¤ï¼Œæ¯8å­—èŠ‚éƒ½æ˜¯å¦‚ä¸‹çš„å½¢å¼ã€‚</p>
<figure class="highlight scss"><table><tr><td class="code"><pre><span class="line"><span class="number">0</span><span class="built_in">x6a</span>(push) xxx </span><br><span class="line"><span class="number">0</span><span class="built_in">xe9</span>(jmp) asm_common_interrupt</span><br><span class="line"><span class="number">0</span><span class="built_in">x90</span>(nop)</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå°±æ˜¯å¾€æ ˆä¸Špushäº†ä¸€ä¸ªå‘é‡å·ï¼Œç„¶åè·³è½¬åˆ°<code>asm_common_interrupt</code>å¤„ã€‚</p>
<h3 id="çœŸæ­£é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„åœ°æ–¹"><a href="#çœŸæ­£é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„åœ°æ–¹" class="headerlink" title="çœŸæ­£é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„åœ°æ–¹"></a>çœŸæ­£é™·å…¥å†…æ ¸æ€æ‰§è¡Œçš„åœ°æ–¹</h3><p>ä¸Šå›ä¹¦æˆ‘ä»¬è¯´åˆ°<code>asm_common_interrupt</code>çš„åœ°æ–¹ï¼Œè¿™è¾¹æ˜¯ä¸­æ–­å¤„ç†çš„çœŸæ­£å‡½æ•°å…¥å£ç‚¹ã€‚å…¶å®šä¹‰å¦‚ä¸‹ï¼Œä¹Ÿç”¨åˆ°äº†DECLARE_IDTENTRY_IRQã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//å®šä¹‰</span></span><br><span class="line">DECLARE_IDTENTRY_IRQ(X86_TRAP_OTHER,	common_interrupt);</span><br></pre></td></tr></table></figure>

<p>é‚£å°±è·Ÿä¹‹å‰ä¸€æ ·äº†ï¼Œè·Ÿå¼‚å¸¸é‚£å—ä¸²èµ·æ¥äº†ï¼Œä¹Ÿæ˜¯è·³åˆ°idtentryçš„æ±‡ç¼–ä»£ç å¤„ï¼Œç„¶åï¼Œç¡¬ä»¶æŠŠä¸€äº›å¯„å­˜å™¨å‹æ ˆï¼Œè½¯ä»¶ä¸Šä¼šæ„é€ pt_regsï¼Œç­‰ç­‰ï¼Œéƒ½æ˜¯å¼‚å¸¸å¤„ç†éƒ¨åˆ†è®²è¿‡çš„å†…å®¹ï¼Œæœ€åä¼šè°ƒç”¨<code>common_interrupt</code>å‡½æ•°ã€‚æˆ‘ä»¬æ¥çœ‹çœ‹<code>common_interrupt</code>åšäº†ä»€ä¹ˆ</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">DEFINE_IDTENTRY_IRQ(common_interrupt)</span><br><span class="line">&#123;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">pt_regs</span> *<span class="title">old_regs</span> =</span> set_irq_regs(regs);</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">irq_desc</span> *<span class="title">desc</span>;</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* entry code tells RCU that we&#x27;re not quiescent.  Check it. */</span></span><br><span class="line">	RCU_LOCKDEP_WARN(!rcu_is_watching(), <span class="string">&quot;IRQ failed to wake up RCU&quot;</span>);</span><br><span class="line"></span><br><span class="line">	desc = __this_cpu_read(vector_irq[<span class="built_in">vector</span>]);</span><br><span class="line">	<span class="keyword">if</span> (likely(!IS_ERR_OR_NULL(desc))) &#123;</span><br><span class="line">		handle_irq(desc, regs);</span><br><span class="line">	&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">		ack_APIC_irq();</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> (desc == VECTOR_UNUSED) &#123;</span><br><span class="line">			pr_emerg_ratelimited(<span class="string">&quot;%s: %d.%u No irq handler for vector\n&quot;</span>,</span><br><span class="line">					     __func__, smp_processor_id(),</span><br><span class="line">					     <span class="built_in">vector</span>);</span><br><span class="line">		&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">			__this_cpu_write(vector_irq[<span class="built_in">vector</span>], VECTOR_UNUSED);</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	set_irq_regs(old_regs);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>OKï¼Œæ€»ä¹‹å°±æ˜¯å¯¹ä¸­æ–­è¿›è¡Œä¸€äº›å¤„ç†ï¼Œå¦‚æœæè¿°è¡¨ä¸­æ²¡æœ‰ä¼šæŠ¥<code>No irq handler for vector</code>ç­‰ç­‰ï¼Œç„¶ååˆæ˜¯ä¸­æ–­è¿”å›é‚£ä¸€å¥—ï¼Œå…·ä½“çœ‹å¼‚å¸¸å¤„ç†ä¸­æœ‰å§‹æœ‰ç»ˆç« èŠ‚å³å¯ã€‚</p>
<h2 id="ç³»ç»Ÿè°ƒç”¨"><a href="#ç³»ç»Ÿè°ƒç”¨" class="headerlink" title="ç³»ç»Ÿè°ƒç”¨"></a>ç³»ç»Ÿè°ƒç”¨</h2><p>ç³»ç»Ÿè°ƒç”¨ä¹Ÿç»è¿‡è¿‡æ—¶ä»£çš„å˜è¿ï¼Œé¦–å…ˆæ—©æœŸçš„ç³»ç»Ÿæ‰§è¡Œç³»ç»Ÿè°ƒç”¨æ—¶å€™ï¼Œå³é€šè¿‡INTæŒ‡ä»¤è°ƒç”¨ï¼ŒINTæŒ‡ä»¤çš„ä½œç”¨æ˜¯è§¦å‘ä¸€ä¸ªä¸­æ–­å‘é‡ï¼Œå…¶å‚æ•°ä½œä¸ºä¸­æ–­å‘é‡å·ï¼Œè€Œå¤„ç†å™¨æ‰§è¡Œ<code>INT 0x80</code>ä¾¿æ˜¯ç³»ç»Ÿè°ƒç”¨çš„ä¸­æ–­å‘é‡å·(0x80,128)ã€‚ä½†æ˜¯ç°åœ¨å¤„ç†å™¨æœ‰äº†æ–°çš„æŒ‡ä»¤SYSCALLæŒ‡ä»¤ï¼Œå…¶ä¹Ÿæ˜¯x86_64å†…æ ¸é»˜è®¤ä½¿ç”¨çš„æ–¹æ³•ï¼Œ64ä½çš„defconfigæ²¡æœ‰ä¸‹é¢ä¸¤ä¸ªconfigé€‰é¡¹äº†ã€‚æ‰€ä»¥è¿™é‡Œæˆ‘ä»¬å°†ä¸¤ç§æ–¹å¼éƒ½è¿›è¡Œè®²è§£ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">if</span> defined(CONFIG_IA32_EMULATION)</span></span><br><span class="line">	SYSG(IA32_SYSCALL_VECTOR,	entry_INT80_compat),</span><br><span class="line"><span class="meta">#<span class="keyword">elif</span> defined(CONFIG_X86_32)</span></span><br><span class="line">	SYSG(IA32_SYSCALL_VECTOR,	entry_INT80_32),</span><br><span class="line"><span class="meta">#<span class="keyword">endif</span></span></span><br></pre></td></tr></table></figure>

<h3 id="int-0x80"><a href="#int-0x80" class="headerlink" title="int 0x80"></a>int 0x80</h3><p>é¦–å…ˆæ˜¯è€å¼çš„åŠæ³•ï¼Œé€šè¿‡æŒ‡ä»¤è§¦å‘ä¸­æ–­ï¼Œæ‰§è¡ŒINTæŒ‡ä»¤ï¼Œç„¶åè§¦å‘0x80ä¸­æ–­å‘é‡è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¤„ç†ï¼Œå¦‚æœåœ¨64ä½å†…æ ¸ä¸Šè¦å¼ºåˆ¶ä½¿ç”¨éœ€è¦æ‰“å¼€ä¸Šè¿°configï¼Œéšåä¾¿å’Œå‰è¿°é€»è¾‘ä¸­çš„å¤„ç†æ–¹å¼ä¸€æ ·ï¼Œè¿›å…¥<code>entry_INT80_compat</code>çš„æ±‡ç¼–ä»£ç å…¥å£å¤„ï¼Œè€Œ32ä½ä½¿ç”¨çš„å…¥å£æ˜¯<code>entry_INT80_32</code>ï¼Œè¿™é‡Œæˆ‘ä»¬å°±çœ‹çœ‹64ä½çš„å§ï¼š</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_CODE_START(entry_INT80_compat)</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line">	/*</span><br><span class="line">	 * Interrupts are off on entry.</span><br><span class="line">	 */</span><br><span class="line">	ASM_CLAC			/* Do this early to minimize exposure */</span><br><span class="line">	SWAPGS</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * User tracing code (ptrace or signal handlers) might assume that</span><br><span class="line">	 * the saved RAX contains a 32-bit number when we&#x27;re invoking a 32-bit</span><br><span class="line">	 * syscall.  Just in case the high bits are nonzero, zero-extend</span><br><span class="line">	 * the syscall number.  (This could almost certainly be deleted</span><br><span class="line">	 * with no ill effects.)</span><br><span class="line">	 */</span><br><span class="line">	movl	%eax, %eax</span><br><span class="line"></span><br><span class="line">	/* switch to thread stack expects orig_ax and rdi to be pushed */</span><br><span class="line">	pushq	%rax			/* pt_regs-&gt;orig_ax */</span><br><span class="line">	pushq	%rdi			/* pt_regs-&gt;di */</span><br><span class="line"></span><br><span class="line">	/* Need to switch before accessing the thread stack. */</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	/* In the Xen PV case we already run on the thread stack. */</span><br><span class="line">	ALTERNATIVE &quot;&quot;, &quot;jmp .Lint80_keep_stack&quot;, X86_FEATURE_XENPV</span><br><span class="line"></span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	movq	PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">	pushq	6*8(%rdi)		/* regs-&gt;ss */</span><br><span class="line">	pushq	5*8(%rdi)		/* regs-&gt;rsp */</span><br><span class="line">	pushq	4*8(%rdi)		/* regs-&gt;eflags */</span><br><span class="line">	pushq	3*8(%rdi)		/* regs-&gt;cs */</span><br><span class="line">	pushq	2*8(%rdi)		/* regs-&gt;ip */</span><br><span class="line">	pushq	1*8(%rdi)		/* regs-&gt;orig_ax */</span><br><span class="line">	pushq	(%rdi)			/* pt_regs-&gt;di */</span><br><span class="line">.Lint80_keep_stack:</span><br><span class="line"></span><br><span class="line">	pushq	%rsi			/* pt_regs-&gt;si */</span><br><span class="line">	xorl	%esi, %esi		/* nospec   si */</span><br><span class="line">	pushq	%rdx			/* pt_regs-&gt;dx */</span><br><span class="line">	xorl	%edx, %edx		/* nospec   dx */</span><br><span class="line">	pushq	%rcx			/* pt_regs-&gt;cx */</span><br><span class="line">	xorl	%ecx, %ecx		/* nospec   cx */</span><br><span class="line">	pushq	$-ENOSYS		/* pt_regs-&gt;ax */</span><br><span class="line">	pushq   %r8			/* pt_regs-&gt;r8 */</span><br><span class="line">	xorl	%r8d, %r8d		/* nospec   r8 */</span><br><span class="line">	pushq   %r9			/* pt_regs-&gt;r9 */</span><br><span class="line">	xorl	%r9d, %r9d		/* nospec   r9 */</span><br><span class="line">	pushq   %r10			/* pt_regs-&gt;r10*/</span><br><span class="line">	xorl	%r10d, %r10d		/* nospec   r10 */</span><br><span class="line">	pushq   %r11			/* pt_regs-&gt;r11 */</span><br><span class="line">	xorl	%r11d, %r11d		/* nospec   r11 */</span><br><span class="line">	pushq   %rbx                    /* pt_regs-&gt;rbx */</span><br><span class="line">	xorl	%ebx, %ebx		/* nospec   rbx */</span><br><span class="line">	pushq   %rbp                    /* pt_regs-&gt;rbp */</span><br><span class="line">	xorl	%ebp, %ebp		/* nospec   rbp */</span><br><span class="line">	pushq   %r12                    /* pt_regs-&gt;r12 */</span><br><span class="line">	xorl	%r12d, %r12d		/* nospec   r12 */</span><br><span class="line">	pushq   %r13                    /* pt_regs-&gt;r13 */</span><br><span class="line">	xorl	%r13d, %r13d		/* nospec   r13 */</span><br><span class="line">	pushq   %r14                    /* pt_regs-&gt;r14 */</span><br><span class="line">	xorl	%r14d, %r14d		/* nospec   r14 */</span><br><span class="line">	pushq   %r15                    /* pt_regs-&gt;r15 */</span><br><span class="line">	xorl	%r15d, %r15d		/* nospec   r15 */</span><br><span class="line"></span><br><span class="line">	UNWIND_HINT_REGS</span><br><span class="line"></span><br><span class="line">	cld</span><br><span class="line"></span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	call	do_int80_syscall_32</span><br><span class="line">	jmp	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line">SYM_CODE_END(entry_INT80_compat)</span><br></pre></td></tr></table></figure>

<p>ç²—ç•¥è®²ä¸€ä¸‹ï¼š2-29è¡Œå¤§æ¦‚å°±æ˜¯ä¸€äº›å…³ä¸­æ–­ï¼Œç„¶åå¤„ç†KPTIç­‰ç­‰çš„ä¸€äº›å¤„ç†è¿‡ç¨‹ï¼Œéšåæ˜¯è¿›è¡Œpt_regsæ„å»ºå‹æ ˆï¼Œæœ€åè°ƒç”¨ï¼ˆcallï¼‰<code>do_int80_syscall_32</code>å‡½æ•°ï¼Œå…¶ä¼šä»pt_regsä¸­è¯»å–ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åè¿›è¡Œç›¸åº”çš„å¤„ç†ï¼Œå°±ä¸è¿‡å¤šå™è¿°äº†ã€‚æœ€åå°±æ˜¯<code>swapgs_restore_regs_and_return_to_usermode</code>ï¼Œå°±æ˜¯å¤„ç†KPTIï¼Œå°†å¯„å­˜å™¨å¼¹å‡ºï¼Œç„¶åè¿”å›ç”¨æˆ·æ€balabalaä¸€å¤§å †ã€‚</p>
<h3 id="SYSCALL-SYSENTERæŒ‡ä»¤æ–¹å¼"><a href="#SYSCALL-SYSENTERæŒ‡ä»¤æ–¹å¼" class="headerlink" title="SYSCALL&#x2F;SYSENTERæŒ‡ä»¤æ–¹å¼"></a>SYSCALL&#x2F;SYSENTERæŒ‡ä»¤æ–¹å¼</h3><p>è¯¥æŒ‡ä»¤ä¼šä»<code>IA32_LSTAR_MSR</code>å¯„å­˜å™¨ä¸­å–å‡ºç³»ç»Ÿè°ƒç”¨å…¥å£åˆ°RIPå¯„å­˜å™¨ï¼Œç„¶åæ‰§è¡Œç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨ç»Ÿä¸€å…¥å£å‡½æ•°ï¼Œå…¶æ–¹å¼æ¯”ä¸Šè¿°æ–¹å¼å¿«ã€‚é‚£ä¹ˆLinuxå†…æ ¸ä¸­æ€ä¹ˆåšçš„å‘¢ï¼Œä¸‹é¢ä¸€ä¸€é“æ¥ï¼š</p>
<h4 id="å¯„å­˜å™¨åˆå§‹åŒ–"><a href="#å¯„å­˜å™¨åˆå§‹åŒ–" class="headerlink" title="å¯„å­˜å™¨åˆå§‹åŒ–"></a>å¯„å­˜å™¨åˆå§‹åŒ–</h4><p>åœ¨<code>arch/x86/kernel/cpu/common.c</code>æ–‡ä»¶ä¸­çš„syscall_initå‡½æ•°å¯¹å¯„å­˜å™¨è¿›è¡Œåˆå§‹åŒ–ï¼Œå…¶é€šè¿‡wrmsrå°†<code>entry_SYSCALL_64</code>çš„ç³»ç»Ÿè°ƒç”¨å…¥å£å†™å…¥<code>MSR_LSTAR</code>å¯„å­˜å™¨(Linuxå®šä¹‰çš„å¯„å­˜å™¨åå­—)ï¼Œä¹Ÿå°±æ˜¯ä¸Šé¢æ‰€è¯´çš„<code>IA32_LSTAR_MSR</code>ï¼ˆIntelå®šä¹‰çš„å¯„å­˜å™¨åå­—ï¼‰ã€‚ä¸‹é¢ä»£ç ä¹Ÿå¯ä»¥çœ‹åˆ°å¦‚æœå¼€å¯äº†32ä½ç­‰é€‰é¡¹ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨SYSCALLæŒ‡ä»¤è¿›è¡Œè·³è½¬åˆ°<code>entry_SYSCALL_compat</code>å¤„ï¼Œè¯¥å‡½æ•°å‰é¢ä¸€èŠ‚å·²ç»åˆ†æäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">void</span> <span class="title function_">syscall_init</span><span class="params">(<span class="type">void</span>)</span></span><br><span class="line">&#123;</span><br><span class="line">	wrmsr(MSR_STAR, <span class="number">0</span>, (__USER32_CS &lt;&lt; <span class="number">16</span>) | __KERNEL_CS);</span><br><span class="line">	wrmsrl(MSR_LSTAR, (<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_64);</span><br><span class="line"></span><br><span class="line"><span class="meta">#<span class="keyword">ifdef</span> CONFIG_IA32_EMULATION</span></span><br><span class="line">	wrmsrl(MSR_CSTAR, (<span class="type">unsigned</span> <span class="type">long</span>)entry_SYSCALL_compat);</span><br><span class="line">	.....</span><br></pre></td></tr></table></figure>

<h4 id="è°ƒç”¨SYSCALLæŒ‡ä»¤å‰å"><a href="#è°ƒç”¨SYSCALLæŒ‡ä»¤å‰å" class="headerlink" title="è°ƒç”¨SYSCALLæŒ‡ä»¤å‰å"></a>è°ƒç”¨SYSCALLæŒ‡ä»¤å‰å</h4><p>OKæˆ‘ä»¬æ¥çœ‹çœ‹<code>entry_SYSCALL_64</code>é‡Œé¢åšäº†ä»€ä¹ˆï¼Œé¦–å…ˆçŒœä¸€ä¸‹åº”è¯¥å°±æ˜¯ç¡¬ä»¶å¯„å­˜å™¨å‹æ ˆï¼Œè½¯ä»¶æŠŠå¯„å­˜å™¨å‹æ ˆï¼Œè·³è½¬ç³»ç»Ÿè°ƒç”¨å‡½æ•°ï¼Œå¤„ç†å®Œæˆè¿”å›é‚£ä¸€å¥—å‘—ã€‚å°±æŠŠä»£ç éƒ½è´´ä¸Šäº†ï¼Œç²—ç•¥çœ‹ä¸€ä¸‹æœç„¶å°±æ˜¯é‚£ä¹ˆåšçš„ã€‚</p>
<figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">SYM_CODE_START(entry_SYSCALL_64)</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	swapgs</span><br><span class="line">	/* tss.sp2 is scratch space. */</span><br><span class="line">	movq	%rsp, PER_CPU_VAR(cpu_tss_rw + TSS_sp2)</span><br><span class="line">	SWITCH_TO_KERNEL_CR3 scratch_reg=%rsp</span><br><span class="line">	movq	PER_CPU_VAR(cpu_current_top_of_stack), %rsp</span><br><span class="line"></span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_safe_stack, SYM_L_GLOBAL)</span><br><span class="line"></span><br><span class="line">	/* Construct struct pt_regs on stack */</span><br><span class="line">	pushq	$__USER_DS				/* pt_regs-&gt;ss */</span><br><span class="line">	pushq	PER_CPU_VAR(cpu_tss_rw + TSS_sp2)	/* pt_regs-&gt;sp */</span><br><span class="line">	pushq	%r11					/* pt_regs-&gt;flags */</span><br><span class="line">	pushq	$__USER_CS				/* pt_regs-&gt;cs */</span><br><span class="line">	pushq	%rcx					/* pt_regs-&gt;ip */</span><br><span class="line">SYM_INNER_LABEL(entry_SYSCALL_64_after_hwframe, SYM_L_GLOBAL)</span><br><span class="line">	pushq	%rax					/* pt_regs-&gt;orig_ax */</span><br><span class="line"></span><br><span class="line">	PUSH_AND_CLEAR_REGS rax=$-ENOSYS</span><br><span class="line"></span><br><span class="line">	/* IRQs are off. */</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	/* Sign extend the lower 32bit as syscall numbers are treated as int */</span><br><span class="line">	movslq	%eax, %rsi</span><br><span class="line">	call	do_syscall_64		/* returns with IRQs disabled */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Try to use SYSRET instead of IRET if we&#x27;re returning to</span><br><span class="line">	 * a completely clean 64-bit userspace context.  If we&#x27;re not,</span><br><span class="line">	 * go to the slow exit path.</span><br><span class="line">	 * In the Xen PV case we must use iret anyway.</span><br><span class="line">	 */</span><br><span class="line"></span><br><span class="line">	ALTERNATIVE &quot;&quot;, &quot;jmp	swapgs_restore_regs_and_return_to_usermode&quot;, \</span><br><span class="line">		X86_FEATURE_XENPV</span><br><span class="line"></span><br><span class="line">	movq	RCX(%rsp), %rcx</span><br><span class="line">	movq	RIP(%rsp), %r11</span><br><span class="line"></span><br><span class="line">	cmpq	%rcx, %r11	/* SYSRET requires RCX == RIP */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * On Intel CPUs, SYSRET with non-canonical RCX/RIP will #GP</span><br><span class="line">	 * in kernel space.  This essentially lets the user take over</span><br><span class="line">	 * the kernel, since userspace controls RSP.</span><br><span class="line">	 *</span><br><span class="line">	 * If width of &quot;canonical tail&quot; ever becomes variable, this will need</span><br><span class="line">	 * to be updated to remain correct on both old and new CPUs.</span><br><span class="line">	 *</span><br><span class="line">	 * Change top bits to match most significant bit (47th or 56th bit</span><br><span class="line">	 * depending on paging mode) in the address.</span><br><span class="line">	 */</span><br><span class="line">#ifdef CONFIG_X86_5LEVEL</span><br><span class="line">	ALTERNATIVE &quot;shl $(64 - 48), %rcx; sar $(64 - 48), %rcx&quot;, \</span><br><span class="line">		&quot;shl $(64 - 57), %rcx; sar $(64 - 57), %rcx&quot;, X86_FEATURE_LA57</span><br><span class="line">#else</span><br><span class="line">	shl	$(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><br><span class="line">	sar	$(64 - (__VIRTUAL_MASK_SHIFT+1)), %rcx</span><br><span class="line">#endif</span><br><span class="line"></span><br><span class="line">	/* If this changed %rcx, it was not canonical */</span><br><span class="line">	cmpq	%rcx, %r11</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_CS, CS(%rsp)		/* CS must match SYSRET */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	movq	R11(%rsp), %r11</span><br><span class="line">	cmpq	%r11, EFLAGS(%rsp)		/* R11 == RFLAGS */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * SYSCALL clears RF when it saves RFLAGS in R11 and SYSRET cannot</span><br><span class="line">	 * restore RF properly. If the slowpath sets it for whatever reason, we</span><br><span class="line">	 * need to restore it correctly.</span><br><span class="line">	 *</span><br><span class="line">	 * SYSRET can restore TF, but unlike IRET, restoring TF results in a</span><br><span class="line">	 * trap from userspace immediately after SYSRET.  This would cause an</span><br><span class="line">	 * infinite loop whenever #DB happens with register state that satisfies</span><br><span class="line">	 * the opportunistic SYSRET conditions.  For example, single-stepping</span><br><span class="line">	 * this user code:</span><br><span class="line">	 *</span><br><span class="line">	 *           movq	$stuck_here, %rcx</span><br><span class="line">	 *           pushfq</span><br><span class="line">	 *           popq %r11</span><br><span class="line">	 *   stuck_here:</span><br><span class="line">	 *</span><br><span class="line">	 * would never get past &#x27;stuck_here&#x27;.</span><br><span class="line">	 */</span><br><span class="line">	testq	$(X86_EFLAGS_RF|X86_EFLAGS_TF), %r11</span><br><span class="line">	jnz	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	/* nothing to check for RSP */</span><br><span class="line"></span><br><span class="line">	cmpq	$__USER_DS, SS(%rsp)		/* SS must match SYSRET */</span><br><span class="line">	jne	swapgs_restore_regs_and_return_to_usermode</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We win! This label is here just for ease of understanding</span><br><span class="line">	 * perf profiles. Nothing jumps here.</span><br><span class="line">	 */</span><br><span class="line">syscall_return_via_sysret:</span><br><span class="line">	/* rcx and r11 are already restored (see code above) */</span><br><span class="line">	POP_REGS pop_rdi=0 skip_r11rcx=1</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * Now all regs are restored except RSP and RDI.</span><br><span class="line">	 * Save old stack pointer and switch to trampoline stack.</span><br><span class="line">	 */</span><br><span class="line">	movq	%rsp, %rdi</span><br><span class="line">	movq	PER_CPU_VAR(cpu_tss_rw + TSS_sp0), %rsp</span><br><span class="line">	UNWIND_HINT_EMPTY</span><br><span class="line"></span><br><span class="line">	pushq	RSP-RDI(%rdi)	/* RSP */</span><br><span class="line">	pushq	(%rdi)		/* RDI */</span><br><span class="line"></span><br><span class="line">	/*</span><br><span class="line">	 * We are on the trampoline stack.  All regs except RDI are live.</span><br><span class="line">	 * We can do future final exit work right here.</span><br><span class="line">	 */</span><br><span class="line">	STACKLEAK_ERASE_NOCLOBBER</span><br><span class="line"></span><br><span class="line">	SWITCH_TO_USER_CR3_STACK scratch_reg=%rdi</span><br><span class="line"></span><br><span class="line">	popq	%rdi</span><br><span class="line">	popq	%rsp</span><br><span class="line">	swapgs</span><br><span class="line">	sysretq</span><br><span class="line">SYM_CODE_END(entry_SYSCALL_64)</span><br></pre></td></tr></table></figure>

<p>é¦–å…ˆ2-9è¡Œç”±äºSYSCALLæŒ‡ä»¤æ²¡æœ‰IDTè¡¨é‚£ä¸€å—ç¡¬ä»¶é€»è¾‘ï¼Œç¡¬ä»¶ä¸ä¼šè‡ªåŠ¨åŠ è½½TSSä¸­çš„å†…æ ¸æ ˆä½ç½®ç»™å¯„å­˜å™¨ï¼Œæ‰€ä»¥éœ€è¦æ‰‹åŠ¨ç”¨è½¯ä»¶çš„æ–¹å¼è¿›è¡ŒåŠ è½½å†…æ ¸æ ˆåœ°å€ï¼Œä¹Ÿæ˜¯ä»tssç»“æ„ä½“ä¸­åŠ è½½ã€‚ç„¶åçœ‹æ³¨é‡Šå°±çŸ¥é“ï¼Œå°±æ„å»ºpt_regsç»“æ„ä½“ï¼Œä¹‹å27è¡Œcalläº†<code>do_syscall_64</code>ï¼Œè¿›è¡ŒçœŸæ­£çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†ï¼Œç„¶åæœ€åéƒ½ä¼šåˆ°<code>swapgs_restore_regs_and_return_to_usermode</code>è¿›è¡Œè¿”å›ï¼Œå¤§å·®ä¸å·®ã€‚</p>
<h4 id="do-syscall-64è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¤„ç†"><a href="#do-syscall-64è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¤„ç†" class="headerlink" title="do_syscall_64è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¤„ç†"></a>do_syscall_64è¿›è¡Œç³»ç»Ÿè°ƒç”¨å¤„ç†</h4><p>è¡Œå§ï¼Œå…·ä½“é€»è¾‘å°±ä¸è¯´äº†ï¼Œè´´ä¸ªä»£ç çœ‹çœ‹å°±è¡Œäº†ï¼Œå¤§æ¦‚å°±æ˜¯è¯»ä¸€ä¸‹ç³»ç»Ÿè°ƒç”¨å·ï¼Œç„¶åè·³è½¬åˆ°ç›¸åº”çš„ç³»ç»Ÿè°ƒç”¨å¤„ç†å‡½æ•°è¿›è¡Œæ‰§è¡Œï¼Œç„¶åè¿”å›å°±å®Œäº†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line">__visible noinstr <span class="type">void</span> <span class="title function_">do_syscall_64</span><span class="params">(<span class="keyword">struct</span> pt_regs *regs, <span class="type">int</span> nr)</span></span><br><span class="line">&#123;</span><br><span class="line">	add_random_kstack_offset();	<span class="comment">//ASLRï¼Œå®‰å…¨é—®é¢˜ï¼Œå°±ç»™æ ˆåŠ äº†ä¸ªåç§»</span></span><br><span class="line">	nr = syscall_enter_from_user_mode(regs, nr); <span class="comment">//ä¸€äº›åˆå§‹åŒ–çš„å¤„ç†ï¼Œæ£€æŸ¥ç­‰æ“ä½œ</span></span><br><span class="line"></span><br><span class="line">	instrumentation_begin();<span class="comment">//KMSANç›¸å…³æ“ä½œï¼Œå¦‚æœæ²¡å¼€é€‰é¡¹åˆ™ä¸ºç©º</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//do_syscall_x64å¤„ç†64ä½ç³»ç»Ÿè°ƒç”¨ï¼Œé‡Œé¢ä¼šè°ƒç”¨ç³»ç»Ÿè°ƒç”¨è¡¨ä¸­çš„å‡½æ•°ï¼Œx32å°±æ˜¯32ä½çš„ï¼Œä¸è¿‡æ˜¯è¿è¡Œåœ¨64ä½kernelä¸Šçš„32ä½ç¨‹åºä½¿ç”¨çš„</span></span><br><span class="line">	<span class="keyword">if</span> (!do_syscall_x64(regs, nr) &amp;&amp; !do_syscall_x32(regs, nr) &amp;&amp; nr != <span class="number">-1</span>) &#123;</span><br><span class="line">		<span class="comment">/* Invalid system call, but still a system call. */</span></span><br><span class="line">		regs-&gt;ax = __x64_sys_ni_syscall(regs);</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	instrumentation_end();<span class="comment">//åŒå‰</span></span><br><span class="line">	syscall_exit_to_user_mode(regs);<span class="comment">//é€€å‡ºä¹‹å‰çš„æœ€åå¤„ç†ï¼Œä»€ä¹ˆå¼€å…³ä¸­æ–­å•Šä»€ä¹ˆçš„ã€‚</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h2 id="Reference"><a href="#Reference" class="headerlink" title="Reference"></a>Reference</h2><p>Linux-kernel source code 5.15</p>
<p>Intel spec</p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>å†…å­˜ç®¡ç†1</title>
    <url>/2022/04/19/note/%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%861/</url>
    <content><![CDATA[<h1 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h1><p>â€‹	å†…å­˜ç®¡ç†çš„ä¸»è¦åŠŸèƒ½æœ‰</p>
<ul>
<li>å†…å­˜ç©ºé—´çš„åˆ†é…ä¸å›æ”¶</li>
<li>åœ°å€è½¬æ¢</li>
<li>å†…å­˜ç©ºé—´çš„æ‰©å……</li>
<li>å†…å­˜å…±äº«</li>
<li>å­˜å‚¨ä¿æŠ¤</li>
</ul>
<h2 id="ç¨‹åºçš„é“¾æ¥ä¸è£…å…¥"><a href="#ç¨‹åºçš„é“¾æ¥ä¸è£…å…¥" class="headerlink" title="ç¨‹åºçš„é“¾æ¥ä¸è£…å…¥"></a>ç¨‹åºçš„é“¾æ¥ä¸è£…å…¥</h2><p>ç”¨æˆ·ç¨‹åºåœ¨ç£ç›˜ä¸Šå­˜å‚¨å½¢å¼ä¸ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå½“æ‰§è¡Œç¨‹åºæ—¶ï¼Œå…¶ä¼šè¢«è°ƒå…¥å†…å­˜ï¼Œå¹¶ç»„ç»‡æˆè¿›ç¨‹çš„å½¢å¼ã€‚é€šå¸¸è¿™ä¸€è¿‡ç¨‹éœ€è¦ä»¥ä¸‹å‡ ä¸ªæ­¥éª¤ï¼š</p>
<ul>
<li><p>é¢„å¤„ç†ï¼šå°†ç”¨æˆ·æºä»£ç ä¸­çš„å¤´æ–‡ä»¶å’Œå®ç­‰è¿›è¡Œæ›¿ä»£ï¼Œåˆ é™¤æ‰€æœ‰æ³¨é‡Šç­‰ç­‰ä¸€ç³»åˆ—æ“ä½œ</p>
</li>
<li><p>ç¼–è¯‘ï¼šç”±ç¼–è¯‘å™¨å°†ç”¨æˆ·æºä»£ç ç¼–è¯‘æˆæ±‡ç¼–æ–‡ä»¶ï¼Œå¹¶æ±‡æ€»æ‰€æœ‰ç¬¦å·ã€‚main.c-&gt;main.S</p>
</li>
<li><p>æ±‡ç¼–ï¼šå°†æ±‡ç¼–æ–‡ä»¶(.Sæ–‡ä»¶)æ ¹æ®ç‰¹å®šå¹³å°ç­‰ç”ŸæˆäºŒè¿›åˆ¶æ–‡ä»¶ï¼Œå³å°†æŒ‡ä»¤ç¿»è¯‘æˆäºŒè¿›åˆ¶å½¢å¼ï¼Œå¹¶åˆå¹¶ç¬¦å·è¡¨ç­‰ã€‚main.S-&gt;main.oï¼Œå…¶ä¸­.oæ–‡ä»¶ç§°ä¸ºç›®æ ‡å¯¹è±¡æ¨¡å—ã€‚</p>
</li>
<li><p>é“¾æ¥ï¼šç”±é“¾æ¥å™¨å°†ç›®æ ‡å¯¹è±¡æ¨¡å—å’Œè‹¥å¹²åº“å‡½æ•°é“¾æ¥åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„åŠ è½½æ¨¡å—ï¼Œç”Ÿæˆå¯æ‰§è¡Œæ–‡ä»¶ã€‚éœ€è¦è¿›è¡Œç¬¦å·è§£æå’Œåœ°å€é‡å®šä½ã€‚é“¾æ¥æœ‰ä¸‰ç§æ–¹å¼ï¼š</p>
</li>
<li><p>è£…å…¥ï¼šå°†å¯æ‰§è¡Œæ–‡ä»¶è½½å…¥å†…å­˜è¿è¡Œã€‚</p>
</li>
</ul>
<p>è€Œç¨‹åºçš„ç¬¦å·åœ°å€ç»‘å®šå¯ä»¥åˆ†ä¸ºä¸‰éƒ¨åˆ†ç¡®å®šï¼š</p>
<ul>
<li>åœ¨ç¼–è¯‘æ—¶ç¡®å®šï¼šå¦‚æœç¼–è¯‘æ—¶å€™å°±çŸ¥é“è¿›ç¨‹å°†åœ¨å†…å­˜é©»ç•™çš„åœ°å€ï¼Œé‚£ä¹ˆå°±å¯ä»¥ç”Ÿæˆç»å¯¹åœ°å€ï¼Œåœ¨MS-DOSç³»ç»Ÿä¸Šçš„.COMæ ¼å¼æ–‡ä»¶å°±æ˜¯å¦‚æ­¤ã€‚</li>
<li>åœ¨åŠ è½½æ—¶ç¡®å®šï¼šå¦‚æœç¼–è¯‘æ—¶å€™ä¸çŸ¥é“ï¼Œåˆ™ç¼–è¯‘å™¨ä¼šäº§ç”Ÿå¯é‡å®šä½ä»£ç ï¼Œå…¶åœ°å€ç»‘å®šä¼šå»¶è¿Ÿåˆ°åŠ è½½æ—¶å€™è¿›è¡Œã€‚</li>
<li>åœ¨æ‰§è¡Œæ—¶ç¡®å®šï¼šè¿›ç¨‹æ‰§è¡Œæ—¶å€™å¯ä»¥ä»ä¸€ä¸ªå†…å­˜æ®µè½¬ç§»åˆ°å¦ä¸€ä¸ªå†…å­˜æ®µï¼Œæ­¤æ—¶åœ°å€ç»‘å®šéœ€è¦æ‰§è¡Œæ—¶å€™æ‰èƒ½ç¡®å®šï¼Œå¤§å¤šæ•°æ“ä½œç³»ç»Ÿé‡‡ç”¨è¿™ç§åŠæ³•ã€‚</li>
</ul>
<h3 id="ç¨‹åºé“¾æ¥çš„ä¸‰ç§å½¢å¼"><a href="#ç¨‹åºé“¾æ¥çš„ä¸‰ç§å½¢å¼" class="headerlink" title="ç¨‹åºé“¾æ¥çš„ä¸‰ç§å½¢å¼"></a>ç¨‹åºé“¾æ¥çš„ä¸‰ç§å½¢å¼</h3><p>ç¨‹åºçš„é“¾æ¥ä¹Ÿæœ‰ä¸‰ç§å½¢å¼ï¼š</p>
<ul>
<li><p>é™æ€é“¾æ¥ï¼šåœ¨ç¨‹åºè¿è¡Œå‰éœ€è¦å°†å„ä¸ªæ¨¡å—å’Œåº“å‡½æ•°ç»„è£…åœ¨ä¸€èµ·ï¼Œå½¢æˆä¸€ä¸ªå®Œæ•´çš„æ¨¡å—ï¼Œè€Œæ¯ä¸ªæ¨¡å—å†…éƒ¨çš„ç¬¦å·éƒ½æ˜¯ä»0å¼€å§‹çš„ç›¸å¯¹åœ°å€ï¼Œè£…æˆä¸€ä¸ªå¤§æ¨¡å—æ—¶éœ€è¦å¯¹å…¶è¿›è¡Œä¿®æ”¹ï¼›åŒæ—¶ä¸€äº›æ¨¡å—ä¼šå‘å¤–éƒ¨æä¾›è°ƒç”¨æ¥å£ï¼Œä¹Ÿéœ€è¦å°†å¤–éƒ¨è°ƒç”¨ç¬¦å·è½¬å˜ä¸ºç›¸åº”çš„ç›¸å¯¹åœ°å€ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E9%9D%99%E6%80%81%E9%93%BE%E6%8E%A5.png" alt="image-20220417172720338"></p>
</li>
<li><p>è£…å…¥æ—¶åŠ¨æ€é“¾æ¥ï¼šå°†ç”¨æˆ·æºç¨‹åºç¼–è¯‘åå¾—åˆ°ä¸€ç»„ç›®æ ‡æ¨¡å—ï¼Œåœ¨è£…å…¥å†…å­˜æ—¶å€™é‡‡ç”¨è¾¹è£…å…¥è¾¹é“¾æ¥çš„æ–¹å¼ï¼Œå³åœ¨è£…å…¥æ—¶è‹¥å‘ç”Ÿä¸€ä¸ªå¤–éƒ¨æ¨¡å—è°ƒç”¨,å°†å¼•èµ·è£…å…¥ç¨‹åºå»æ‰¾å‡ºç›¸åº”çš„å¤–éƒ¨ç›®æ ‡æ¨¡å—,å¹¶å°†å®ƒè£…å…¥å†…å­˜,è¿˜è¦ä¿®æ”¹ç›®æ ‡æ¨¡å—ä¸­çš„ç›¸å¯¹åœ°å€ã€‚å…¶ä¼˜ç‚¹æ˜¯ä¾¿äºä¿®æ”¹å’Œæ›´æ–°ï¼Œä¾¿äºå®ç°å¯¹ç›®æ ‡æ¨¡å—çš„å…±äº«ã€‚</p>
<p>è™½ç„¶å‰é¢æ‰€ä»‹ç»çš„åŠ¨æ€è£…å…¥æ–¹å¼ï¼Œå¯å°†ä¸€ä¸ªè£…å…¥æ¨¡å—è£…å…¥åˆ°å†…å­˜çš„ä»»ä½•åœ°æ–¹ï¼Œä½†è£…å…¥æ¨¡å—çš„ç»“æ„æ˜¯é™æ€çš„ï¼Œå®ƒä¸»è¦è¡¨ç°åœ¨ä¸¤ä¸ªæ–¹é¢ï¼šä¸€æ˜¯åœ¨è¿›ç¨‹çš„æ•´ä¸ªæ‰§è¡ŒæœŸé—´ï¼Œè£…å…¥æ¨¡å—ä¸æ”¹å˜ï¼›å†è€…æ˜¯æ¯æ¬¡è¿è¡Œæ—¶çš„è£…å…¥æ¨¡å—éƒ½æ˜¯ç›¸åŒçš„ã€‚å®é™…ä¸Šï¼Œåœ¨è®¸å¤šæƒ…å†µä¸‹ï¼Œæ¯æ¬¡è¦è¿è¡Œçš„æ¨¡å—å¯èƒ½æ˜¯ä¸ç›¸åŒçš„ï¼Œä½†ç”±äºäº‹å…ˆæ— æ³•çŸ¥é“æœ¬æ¬¡è¦è¿è¡Œå“ªäº›æ¨¡å—ï¼Œæ•…åªèƒ½æ˜¯å°†æ‰€æœ‰å¯èƒ½è¦è¿è¡Œåˆ°çš„æ¨¡å—ï¼Œåœ¨è£…å…¥æ—¶å…¨éƒ¨é“¾æ¥åœ¨ä¸€èµ·ï¼Œæ˜¯æ¯æ¬¡æ‰§è¡Œæ—¶çš„è£…å…¥æ¨¡å—æ˜¯ç›¸åŒçš„ã€‚æ˜¾ç„¶è¿™æ˜¯ä½æ•ˆçš„ã€‚å› ä¸ºè¿™æ ·ï¼Œåœ¨è£…å…¥æ¨¡å—çš„è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå¾€å¾€ä¼šæœ‰æŸäº›ç›®æ ‡æ¨¡å—æ ¹æœ¬å°±ä¸è¿è¡Œã€‚æ¯”è¾ƒå…¸å‹çš„ä¾‹å­æ˜¯é”™è¯¯å¤„ç†æ¨¡å—ï¼Œå¦‚æœç¨‹åºåœ¨æ•´ä¸ªè¿è¡Œè¿‡ç¨‹ä¸­ï¼Œéƒ½ä¸å‡ºç°é”™è¯¯ï¼Œä¾¿ä¸ä¼šç”¨åˆ°è¯¥æ¨¡å—ã€‚å¯¹æŸäº›ç›®æ ‡æ¨¡å—çš„é“¾æ¥ï¼Œæ˜¯åœ¨ç¨‹åºæ‰§è¡Œä¸­éœ€è¦è¯¥æ¨¡å—æ‰è¿›è¡Œçš„ï¼Œå‡¡åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­éœ€è¦çš„æ¨¡å—ä¼šè¢«è°ƒå…¥å†…å­˜ï¼Œé“¾æ¥åˆ°è£…å…¥æ¨¡å—ä¸Šï¼Œå…¶èƒ½èŠ‚çœå¤§é‡å†…å­˜ç©ºé—´ï¼Œå› ä¸ºä¸éœ€è¦çš„éƒ¨åˆ†éƒ½ä¸ä¼šè¢«åŠ è½½å…¥å†…å­˜ã€‚</p>
</li>
<li><p>æ‰§è¡Œæ—¶åŠ¨æ€é“¾æ¥ï¼šå¯å°†æŸäº›ç›®æ ‡æ¨¡å—çš„é“¾æ¥ï¼Œæ¨è¿Ÿåˆ°æ‰§è¡Œæ—¶æ‰è¿›è¡Œã€‚å³åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œè‹¥å‘ç°ä¸€ä¸ªè¢«è°ƒç”¨æ¨¡å—å°šæœªè£…å…¥å†…å­˜æ—¶ç”±OSå»æ‰¾åˆ°è¯¥æ¨¡å—ï¼Œå°†å®ƒè£…å…¥å†…å­˜ï¼Œå¹¶æŠŠå®ƒè¿æ¥åˆ°è°ƒç”¨è€…æ¨¡å—ä¸Šã€‚</p>
</li>
</ul>
<p>åšä¸ªæ¯”å–»å°±æ˜¯ï¼Œé™æ€é“¾æ¥å°±å¥½åƒæœºå…³æªï¼ŒæŠŠæ‰€æœ‰å­å¼¹éƒ½è£…å¥½ï¼Œç„¶åçªçªçªï¼Œä½†æ˜¯æ‰€è€—è´¹å¾ˆå¤§ç©ºé—´ï¼Œå¾ˆç¬¨é‡ã€‚è€Œè£…å…¥æ—¶åŠ¨æ€é“¾æ¥å°±å¥½åƒå­å¼¹å…ˆè£…å…¥å¼¹å¤¹ä¸­ï¼Œè£…å…¥ä½¿ç”¨çš„æ—¶å€™æŠŠå¼¹å¤¹è£…ä¸Šæªï¼Œç„¶åå¼€å§‹æ‰§è¡Œï¼Œè™½ç„¶å°å·§äº†å¾ˆå¤šï¼Œä½†æ˜¯å¾ˆå¤šé”™è¯¯å¤„ç†çš„ä»£ç ç­‰ç­‰è¿˜æ˜¯ä¼šè¢«åŠ è½½å…¥å†…å­˜ã€‚æ‰§è¡Œæ—¶åŠ¨æ€é“¾æ¥å°±å¥½åƒä¸€æŠŠè€å¼kar98ï¼Œæ¯æ¬¡è¦ç‹™äººå¼€æªçš„æ—¶å€™ï¼Œè£…å…¥ä¸€é¢—å­å¼¹ï¼ŒèŠ‚çº¦äº†å¾ˆå¤šç©ºé—´ã€‚</p>
<h3 id="ç¨‹åºè£…å…¥çš„ä¸‰ç§æ–¹å¼"><a href="#ç¨‹åºè£…å…¥çš„ä¸‰ç§æ–¹å¼" class="headerlink" title="ç¨‹åºè£…å…¥çš„ä¸‰ç§æ–¹å¼"></a>ç¨‹åºè£…å…¥çš„ä¸‰ç§æ–¹å¼</h3><p>åœ¨å°†ç¨‹åºè£…å…¥å†…å­˜æ—¶ä¹Ÿæœ‰ä¸‰ç§å½¢å¼ï¼š</p>
<ul>
<li>ç»å¯¹è£…å…¥ï¼šåªé€‚ç”¨äº<strong>å•é“ç¨‹åºç¯å¢ƒ</strong>ï¼Œåœ¨ç¼–è¯‘æ—¶å°±çŸ¥é“ç¨‹åºæ‰€åœ¨çš„å†…å­˜ä½ç½®ï¼Œäºæ˜¯ç”Ÿæˆçš„æ˜¯ç»å¯¹åœ°å€çš„ç›®æ ‡ä»£ç ï¼Œå…¶ç¨‹åºä¸­çš„é€»è¾‘åœ°å€ä¸çœŸå®çš„ç‰©ç†åœ°å€ç›¸åŒã€‚</li>
<li>å¯é‡å®šä½è£…å…¥ï¼šåœ¨<strong>å¤šé“ç¨‹åºç¯å¢ƒä¸‹</strong>ï¼Œå¤šä¸ªç›®æ ‡æ¨¡å—çš„èµ·å§‹åœ°å€é€šå¸¸ä»0å¼€å§‹ï¼Œç¨‹åºä¸­çš„å…¶ä»–åœ°å€éƒ½æ˜¯ç›¸å¯¹äºèµ·å§‹åœ°å€çš„ã€‚åœ¨è£…å…¥æ—¶å¯¹ç›®æ ‡ç¨‹åºä¸­æŒ‡ä»¤å’Œæ•°æ®åœ°å€çš„ä¿®æ”¹è¿‡ç¨‹ç§°ä¸º<strong>é‡å®šä½</strong>ã€‚</li>
<li>åŠ¨æ€è¿è¡Œæ—¶è£…å…¥ï¼šç¨‹åºå¦‚æœå‘ç”Ÿç§»åŠ¨ï¼Œåˆ™éœ€è¦åŠ¨æ€è£…å…¥æ–¹å¼ï¼Œè£…å…¥ç¨‹åºæŠŠè£…å…¥æ¨¡å—æ”¾å…¥å†…å­˜åå¹¶ä¸ç«‹å³æŠŠè£…å…¥æ¨¡å—çš„åœ°å€è½¬åŒ–æˆç»å¯¹åœ°å€ï¼Œè€Œæ˜¯åœ¨ç¨‹åºçœŸæ­£è¦æ‰§è¡Œæ—¶å€™æ‰çœŸæ­£è½¬åŒ–ï¼Œè¯¥ç§æ–¹å¼éœ€è¦ç¡¬ä»¶ä¸Šæœ‰é‡å®šä½å¯„å­˜å™¨æ”¯æŒã€‚ä¼˜ç‚¹æ˜¯å¯ä»¥å°†ç¨‹åºåˆ†é…åˆ°ä¸è¿ç»­çš„å­˜å‚¨åŒºï¼Œåœ¨ç¨‹åºè¿è¡Œä¹‹å‰å¯ä»¥åªè£…å…¥éƒ¨åˆ†ä»£ç å³å¯è¿è¡Œï¼Œç„¶ååœ¨ç¨‹åºæ‰§è¡ŒæœŸé—´ï¼Œæ ¹æ®éœ€è¦åŠ¨æ€ç”³è¯·å†…å­˜ï¼Œä¹Ÿä¾¿äºç¨‹åºæ®µå…±äº«ã€‚</li>
</ul>
<h2 id="è¿›ç¨‹çš„å†…å­˜å¸ƒå±€"><a href="#è¿›ç¨‹çš„å†…å­˜å¸ƒå±€" class="headerlink" title="è¿›ç¨‹çš„å†…å­˜å¸ƒå±€"></a>è¿›ç¨‹çš„å†…å­˜å¸ƒå±€</h2><p>â€‹	å¦‚å›¾æ‰€ç¤ºæ˜¯ä¸€ä¸ªè¿›ç¨‹åœ¨å†…å­˜ä¸­çš„æ˜ åƒï¼Œ64ä½å’Œ32ä½æœ‰æ‰€ä¸åŒï¼Œä½†æ˜¯å¤§å·®ä¸å·®ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E8%BF%9B%E7%A8%8B%E7%9A%84%E5%86%85%E5%AD%98%E5%B8%83%E5%B1%80" alt="è¿›ç¨‹çš„å­˜å¸ƒå±€"></p>
<h3 id="miscellaneousï¼ˆæ‚é¡¹ï¼‰"><a href="#miscellaneousï¼ˆæ‚é¡¹ï¼‰" class="headerlink" title="miscellaneousï¼ˆæ‚é¡¹ï¼‰"></a>miscellaneousï¼ˆæ‚é¡¹ï¼‰</h3><p>å…¶ä¸­æ¯”è¾ƒå…³é”®çš„æ˜¯ç”±ä¸Šå›¾å¯ä»¥çœ‹åˆ°ç³»ç»Ÿä¼šæŠŠè¿›ç¨‹çš„ELFæ–‡ä»¶(ELFæ–‡ä»¶é•¿å•¥æ ·å°±è°·æ­Œæœï¼Œä¸€å¤§å †å›¾)å»æ‰<code>header</code>ä¹‹åè£…å…¥äº†åœ°å€ä¸º<code>0x40000000</code>çš„ä½ç½®å¤„ï¼Œè‚¯å®šæœ‰äººä¼šé—®ä¸ºä»€ä¹ˆæ˜¯è¿™ä¸ªåœ°å€ã€‚emmmå¾ˆå¤šç½‘ä¸Šèµ„æ–™éƒ½æ²¡è®²æ¸…æ¥šã€‚</p>
<p>â€‹	é¦–å…ˆï¼Œä¸ºä»€ä¹ˆå‰é¢è¦æœ‰ä¸€æ®µç©ºæ´ï¼Œä¸è®ºæ˜¯32ä½è¿˜æ˜¯64ä½ï¼Œä¸»è¦æ˜¯ä¸ºäº†é˜²æ­¢<code>NULL POINTER</code>è¢«è®¿é—®çš„é—®é¢˜ï¼Œè¿™æ ·åš0åœ°å€å°±æ˜¯ä¸€ä¸ªéæ³•åœ°å€ï¼Œè®¿é—®æ—¶èƒ½è¢«æ“ä½œç³»ç»Ÿæ•è·ã€‚ä½†æ˜¯æœ‰äººè‚¯å®šä¼šé—®ï¼Œä¸ºä»€ä¹ˆä¸èƒ½è£…è½½åœ¨è™šæ‹Ÿåœ°å€ä¸º1å¤„ï¼Ÿå…¶å®ä¹Ÿæ˜¯å¯ä»¥çš„ï¼Œä½†æ˜¯æ“ä½œç³»ç»Ÿä¸€èˆ¬ä¼šä¸ºäº†åˆ†é¡µæ–¹ä¾¿ï¼Œå°±å‰é¢ç©ºå‡ºä¸€éƒ¨åˆ†ç©ºé—´ï¼Œè¿™ä¸ªç©ºå‡ºçš„å¤šå¤§ç©ºé—´ä¸æ˜¯å›ºå®šçš„ï¼Œè‡³å°‘æˆ‘æµ‹äº†ä¸‰ç§ç¯å¢ƒä¸‹ï¼ˆ<code>QEMUè·‘çš„64ä½linux</code>ï¼Œ<code>è…¾è®¯äº‘æœåŠ¡å™¨</code>ï¼Œ<code>åŒç³»ç»Ÿçš„ç‰©ç†ä¸»æœºä¸Šçš„linux</code>ï¼‰éƒ½æ˜¯ä¸ä¸€æ ·çš„ã€‚å…¶ä¸­ä¸€éƒ¨åˆ†åŸå› æ˜¯å¼€å¯äº†<code>ASLR</code>çš„ç¼˜æ•…ï¼Œä½†æ˜¯æˆ‘å…³äº†ä¹‹åè¿˜æ˜¯ä¸ä¸€æ ·çš„ã€‚ï¼ˆç½‘ä¸Šæœ‰äººæ˜¯<code>0x400000</code>ï¼Œæ¢ç®—ä¸‹æ¥æ˜¯4Mï¼Œè¯´æ˜¯å› ä¸ºLinuxåˆ†é¡µæœºåˆ¶ï¼Œæœ‰äº›é¡µé¢æ˜¯å¤§é¡µï¼Œä¸æ˜¯4Kå¤§å°ï¼Œæ‰€ä»¥å°±å¼€å¾—å¤§ç‚¹ï¼Œä¿è¯ä¸€é¡µè£…ä¸ä¸‹ã€‚è¿™ç§è¯´æ³•æˆ‘ä¸ç¡®å®šæ˜¯å¦æ­£ç¡®ï¼‰ã€‚</p>
<p>â€‹	ç½‘ä¸Šå¾ˆå¤šå›¾é’ˆå¯¹äº32ä½çš„åœ°å€ç©ºé—´ä¼šè¯´å‰é¢128Mæ˜¯ç©ºæ´ï¼ˆæˆ‘æ‰‹ä¸Šæ²¡æœ‰32ä½æœºå™¨ï¼Œæ²¡æ³•å»éªŒè¯ï¼Œè‡³å°‘64ä½æˆ‘éªŒè¯äº†ã€‚å…¶æ¬¡æˆ‘ä¹Ÿä¸æ˜ç™½ä¸ºä»€ä¹ˆ32ä½è¦å¼€128Mé‚£ä¹ˆå¤§ï¼Œåƒ64ä½è¿™æ ·å¼€å°ç‚¹ä¸è¡Œå—ï¼Ÿï¼‰</p>
<p>â€‹	è¿˜è¦è¯´çš„ä¸€ç‚¹æ˜¯linuxæ˜¯é€šè¿‡mmapå°†elfæ–‡ä»¶è½½å…¥å†…å­˜çš„ï¼Œè€ŒLinuxå¯¹mmapå¯æ˜ å°„çš„åœ°å€èŒƒå›´åšäº†é™åˆ¶ï¼Œç”±å˜é‡MMAP_MIN_ADDR(è¯¥å€¼ä¸€èˆ¬ä¸º65532ï¼Œå¯ä»¥é€šè¿‡å‘½ä»¤<code>cat /proc/sys/vm/mmap_min_addr</code>æŸ¥çœ‹)é™åˆ¶ï¼Œä¹Ÿå°±æ˜¯è¯´è£…è½½çš„åœ°å€é¦–å…ˆè¦æ±‚ä¸èƒ½å°äºè¿™ä¸ªå€¼ï¼Œå¦åˆ™æ— æ³•mmapã€‚å…¶æ¬¡è¿™ä¸ªæ˜ å°„çš„åŸºè´¨æ˜¯ç”±é“¾æ¥å™¨ä¸­çš„ä¸€ä¸ªå˜é‡å®šä¹‰çš„ï¼ˆç½‘ä¸Šä¸€ç¯‡blogè¯´çš„ï¼Œæˆ‘ä¹Ÿä¸çŸ¥é“æ­£ç¡®ä¸æ­£ç¡®ï¼Œæˆ‘è®°å¾—ä»–è¯´åœ¨ä¸€ä¸ªæ–‡ä»¶åä¸ºelf_x86_64xxxçš„æ–‡ä»¶é‡Œï¼‰ã€‚</p>
<h3 id="å†…å­˜å„ä¸ªéƒ¨åˆ†å«ä¹‰"><a href="#å†…å­˜å„ä¸ªéƒ¨åˆ†å«ä¹‰" class="headerlink" title="å†…å­˜å„ä¸ªéƒ¨åˆ†å«ä¹‰"></a>å†…å­˜å„ä¸ªéƒ¨åˆ†å«ä¹‰</h3><ul>
<li>.textï¼šå…¶ä¸­<code>.text</code>æ®µä¸ºä»£ç æ®µï¼Œç”¨ä»¥å­˜å‚¨åŒ…æ‹¬<code>_init</code>ç­‰åˆå§‹åŒ–å‡½æ•°åœ¨å†…çš„ç¨‹åºç‰‡æ®µã€‚</li>
<li>.rodataï¼šç”¨ä»¥å­˜å‚¨åªè¯»æ•°æ®ï¼ŒåŒ…æ‹¬ä¸€äº›å­—ç¬¦ä¸²ä»€ä¹ˆã€‚è€Œä¸”åŒæ ·çš„å­—ç¬¦ä¸²åªä¼šåœ¨å…¶ä¸­ä¿å­˜æœ‰ä¸€ä¸ªå‰¯æœ¬ï¼Œæ‰€ä»¥å½“åˆ›å»ºä¸¤ä¸ªæŒ‡é’ˆæŒ‡å‘ä¸¤ä¸ªä¸€æ ·çš„å­—ç¬¦ä¸²æ—¶å€™ï¼Œè¿™ä¸¤ä¸ªæŒ‡é’ˆçš„å€¼æ˜¯ä¸€æ ·çš„ã€‚</li>
<li>.dataï¼šç”¨ä»¥å­˜å‚¨è¯»å†™æ•°æ®ï¼ŒåŒ…æ‹¬å·²åˆå§‹åŒ–ä¸ä¸º0çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚</li>
<li>.bssï¼šç”¨ä»¥å­˜å‚¨åˆå§‹åŒ–ä¸º0çš„å…¨å±€å˜é‡å’Œé™æ€å˜é‡ã€‚</li>
</ul>
<h2 id="å†…å­˜åˆ†é…æ–¹å¼"><a href="#å†…å­˜åˆ†é…æ–¹å¼" class="headerlink" title="å†…å­˜åˆ†é…æ–¹å¼"></a>å†…å­˜åˆ†é…æ–¹å¼</h2><p>â€‹	å†…å­˜åˆ†é…æ–¹å¼æœ‰å¾ˆå¤šç§ï¼ŒåŒ…æ‹¬è¿ç»­å†…å­˜åˆ†é…ï¼Œåˆ†æ®µï¼Œåˆ†é¡µï¼Œæ®µé¡µå¼ç­‰ç­‰ã€‚</p>
<h3 id="è¿ç»­å†…å­˜åˆ†é…"><a href="#è¿ç»­å†…å­˜åˆ†é…" class="headerlink" title="è¿ç»­å†…å­˜åˆ†é…"></a>è¿ç»­å†…å­˜åˆ†é…</h3><h4 id="å†…å­˜ä¿æŠ¤"><a href="#å†…å­˜ä¿æŠ¤" class="headerlink" title="å†…å­˜ä¿æŠ¤"></a>å†…å­˜ä¿æŠ¤</h4><p>ä¸ºäº†é˜²æ­¢è¿›ç¨‹è®¿é—®ä¸å±äºè‡ªå·±çš„ç©ºé—´ï¼Œå¯ä»¥é‡‡å–ä¸¤ç§æ–¹å¼è¿›è¡Œå†…å­˜ä¿æŠ¤ï¼š</p>
<ul>
<li>åœ¨CPUä¸­è®¾ç½®ä¸Šä¸‹é™å¯„å­˜å™¨ï¼Œç”¨ä»¥å­˜å‚¨å­˜æ”¾ç”¨æˆ·è¿›ç¨‹åœ¨ä¸»å­˜ä¸­çš„ä¸Šç•Œå’Œä¸‹ç•Œï¼Œä»è€Œé˜²æ­¢å†…å­˜è¯»å–è¶Šç•Œã€‚</li>
<li>åœ¨CPUä¸­è®¾ç½®é‡å®šä½å¯„å­˜å™¨å’Œç•Œé™å¯„å­˜å™¨ï¼Œå½“CPUè®¿é—®åœ°å€çš„æ—¶å€™å’Œç•Œé™å¯„å­˜å™¨è¿›è¡Œæ¯”è¾ƒï¼Œåˆ¤æ–­æ˜¯å¦åœ¨å¯è®¿é—®èŒƒå›´å†…ã€‚å…¶ä¸­é‡å®šä½å¯„å­˜å™¨å­˜å‚¨æœ€å°çš„ç‰©ç†åœ°å€ï¼Œç•Œé™å¯„å­˜å™¨å­˜å‚¨æœ€å¤§çš„é€»è¾‘åœ°å€ã€‚</li>
</ul>
<h4 id="å†…å­˜åˆ†é…"><a href="#å†…å­˜åˆ†é…" class="headerlink" title="å†…å­˜åˆ†é…"></a>å†…å­˜åˆ†é…</h4><p>â€‹	æœ€ç®€å•çš„åˆ†é…æ–¹å¼ä¸º<strong>å¤šåˆ†åŒºæ–¹æ³•</strong>ï¼šå°†å†…å­˜åˆ†ä¸ºå¤šä¸ªå›ºå®šå¤§å°çš„åˆ†åŒºï¼Œæ¯ä¸ªåˆ†åŒºåŒ…å«ä¸€ä¸ªè¿›ç¨‹ã€‚è¯¥ç§æ–¹æ³•ç°åœ¨å·²ç»ä¸å†ä½¿ç”¨ã€‚</p>
<p>â€‹	éšåè¡ç”Ÿå‡ºçš„æ˜¯<strong>å¯å˜åˆ†åŒºæ³•</strong>ï¼šæ“ä½œç³»ç»Ÿä¸­æœ‰ä¸€ä¸ªè¡¨è®°å½•å“ªäº›å†…å­˜å¯ç”¨ï¼Œå“ªäº›å†…å­˜ä¸å¯ç”¨ã€‚æœ€å¼€å§‹å†…å­˜ä¸ºä¸€æ•´å—ç©ºé—²ï¼Œå½“ä¸€ä¸ªç”¨æˆ·è¿›ç¨‹æ¥ä¹‹åï¼Œæ“ä½œç³»ç»Ÿæ ¹æ®å†…å­˜éœ€æ±‚å’Œç°æœ‰å†…å­˜ä½¿ç”¨æƒ…å†µè¿›è¡Œåˆ†é…ï¼Œå†³å®šå“ªäº›è¿›ç¨‹å¯ä»¥è¢«åˆ†é…å†…å­˜ç©ºé—´ï¼Œç„¶åè¿™äº›è¿›ç¨‹è¿›å…¥å†…å­˜å¼€å§‹ç«äº‰CPUï¼Œè¿™äº›è¿›ç¨‹è¿è¡Œç»“æŸåé‡Šæ”¾å†…å­˜ç©ºé—´ï¼Œæ“ä½œç³»ç»Ÿå›æ”¶è¿™éƒ¨åˆ†å†…å­˜ã€‚ è¿™ç§æ–¹æ³•ä¼šå¯¼è‡´å†…å­˜ä¸­å­˜åœ¨å¾ˆå¤šç©ºæ´å’Œç¢ç‰‡ã€‚</p>
<h4 id="åŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜åŠç®—æ³•"><a href="#åŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜åŠç®—æ³•" class="headerlink" title="åŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜åŠç®—æ³•"></a>åŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜åŠç®—æ³•</h4><p>â€‹	æ ¹æ®ä¸€ç»„ç©ºé—²å­”æ¥åˆ†é…å¤§å°ä¸ºnçš„è¯·æ±‚é—®é¢˜ä¸ºåŠ¨æ€å­˜å‚¨åˆ†é…é—®é¢˜ï¼Œä¸€èˆ¬å¯ä»¥é€šè¿‡é¦–æ¬¡é€‚åº”ï¼Œæœ€ä¼˜é€‚åº”å’Œæœ€å·®é€‚åº”çš„æ–¹æ³•åˆ†é…ã€‚</p>
<ul>
<li>é¦–æ¬¡é€‚åº”ï¼šåˆ†é…é¦–ä¸ªè¶³å¤Ÿå¤§çš„å­”ã€‚</li>
<li>é‚»è¿‘é€‚åº”ï¼šä¹Ÿæ˜¯åˆ†é…é¦–ä¸ªè¶³å¤Ÿå¤§çš„å­”ï¼Œä¸è¿‡å’Œé¦–æ¬¡é€‚åº”çš„åŒºåˆ«åœ¨äºé¦–æ¬¡é€‚åº”æ˜¯æ¯æ¬¡ä»é“¾è¡¨å¤´å¼€å§‹æŸ¥æ‰¾ï¼Œè€Œé‚»è¿‘é€‚åº”æ¯æ¬¡ä»ä¸Šæ¬¡æŸ¥æ‰¾ç»“æŸçš„ä½ç½®å¼€å§‹æŸ¥æ‰¾ã€‚</li>
<li>æœ€ä¼˜é€‚åº”ï¼šåˆ†é…æœ€å°è¶³å¤Ÿå¤§çš„å­”ã€‚</li>
<li>æœ€å·®é€‚åº”ï¼šåˆ†é…æœ€å¤§çš„å­”ã€‚</li>
</ul>
<h3 id="åˆ†æ®µ"><a href="#åˆ†æ®µ" class="headerlink" title="åˆ†æ®µ"></a>åˆ†æ®µ</h3><p>â€‹	åˆ†æ®µç®¡ç†æ–¹å¼æå‡ºè€ƒè™‘äº†ç¨‹åºå‘˜å’Œç¼–ç¨‹è§†è§’ï¼Œç”±äºç”¨æˆ·çš„å†…å­˜è§†å›¾å’Œå®é™…ç‰©ç†å†…å­˜ä¸ä¸€æ ·ï¼Œä½†æ˜¯åˆ†æ®µæä¾›äº†ä¸€ç§æ–¹å¼ï¼Œå°†ç¨‹åºå‘˜çš„è§†è§’æ˜ å°„åˆ°å®é™…çš„ç‰©ç†å†…å­˜ï¼Œè¿™æ ·ç³»ç»Ÿå¯ä»¥æ›´è‡ªç”±åœ°ç®¡ç†å†…å­˜ï¼Œç¨‹åºå‘˜ä¹Ÿæœ‰ä¸€ä¸ªæ›´è‡ªç„¶çš„ç¼–ç¨‹ç¯å¢ƒã€‚</p>
<p>â€‹	ç¨‹åºå‘˜ä¸å†è®¤ä¸ºå†…å­˜æ˜¯ä¸€ä¸ªå­—èŠ‚çš„çº¿æ€§æ•°ç»„ï¼Œè€Œæ˜¯çœ‹åšä¸åŒé•¿åº¦çš„æ®µã€‚å› ä¸ºç¨‹åºå‘˜æ›´å…³å¿ƒå †æ ˆï¼Œæ•°å­¦åº“ï¼Œä¸»ç¨‹åºç­‰åè¯ï¼Œè€Œä¸å…³å¿ƒè¿™äº›å…ƒç´ æ‰€åœ¨çš„ä½ç½®ï¼Œä»–ä¹Ÿå¹¶ä¸å…³å¿ƒå †æ ˆæ”¾åœ¨ä¸»ç¨‹åºä¹‹å‰è¿˜æ˜¯ä¹‹åã€‚ç”±æ­¤é€»è¾‘åœ°å€ç©ºé—´ä¾¿æ˜¯ç”±ä¸€ç»„æ®µç»„æˆçš„ï¼Œæ¯ä¸ªæ®µæœ‰è‡ªå·±çš„åç§°å’Œé•¿åº¦ï¼Œé€»è¾‘åœ°å€æ˜¯æ®µçš„åç§°å’Œæ®µå†…åç§»ç»„åˆã€‚</p>
<p>â€‹	å›¾ä¸ºåˆ†æ®µæœºåˆ¶çš„ç¨‹åºå‘˜è§†è§’ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E6%AE%B5%E7%A8%8B%E5%BA%8F%E5%91%98%E8%A7%86%E8%A7%92.png" alt="image-20220417232909018"></p>
<h4 id="åˆ†æ®µçš„ç¡¬ä»¶æ”¯æŒ"><a href="#åˆ†æ®µçš„ç¡¬ä»¶æ”¯æŒ" class="headerlink" title="åˆ†æ®µçš„ç¡¬ä»¶æ”¯æŒ"></a>åˆ†æ®µçš„ç¡¬ä»¶æ”¯æŒ</h4><h5 id="16ä½"><a href="#16ä½" class="headerlink" title="16ä½"></a>16ä½</h5><p>â€‹	ç¡¬ä»¶ä¸Š<code>x86</code>åœ¨å®æ¨¡å¼å’Œä¿æŠ¤æ¨¡å¼ä¸­æœ‰æ‰€ä¸åŒã€‚åœ¨å®æ¨¡å¼ä¸­å¯„å­˜å™¨éƒ½æ˜¯16ä½çš„ï¼Œè€ŒCPUæä¾›å››ä¸ªæ®µå¯„å­˜å™¨CS,DS,SS,ESï¼Œäºæ˜¯å¯»å€æ–¹å¼ä¸ºï¼Œå¯ä»¥æœ€å¤šè®¿é—®2^20^å¤§å°å†…å­˜ï¼š</p>
<figure class="highlight armasm"><table><tr><td class="code"><pre><span class="line">ç‰©ç†åœ°å€ = ï¼ˆæ®µå¯„å­˜å™¨ &lt;&lt; <span class="number">4</span>ï¼‰ + ï¼ˆ<span class="built_in">ip</span>å¯„å­˜å™¨(åç§»é‡ï¼‰ï¼‰</span><br></pre></td></tr></table></figure>

<h5 id="32ä½"><a href="#32ä½" class="headerlink" title="32ä½"></a>32ä½</h5><p>â€‹	ä½†æ˜¯åˆ°äº†32ä½ä¿æŠ¤æ¨¡å¼ï¼ŒCPUå˜æˆäº†32ä½ï¼ŒåŒæ—¶å˜æˆäº†6ä¸ªæ®µå¯„å­˜å™¨ï¼Œå¤šäº†FSå’ŒGSï¼Œå¯æ˜¯ä¸ºäº†å…¼å®¹16ä½ç¨‹åºï¼Œå…¶å¯„å­˜å™¨å¤§å°è¿˜æ˜¯16ä½ï¼Œäºæ˜¯ä¹‹å‰çš„æ¨¡å¼æ— æ³•æ»¡è¶³32ä½çš„å¯»å€äº†ã€‚äºæ˜¯Intelå¢åŠ äº†ä¸¤ä¸ªå¯„å­˜å™¨ï¼šGDTRï¼ˆå…¨å±€æè¿°ç¬¦è¡¨ï¼‰ï¼ŒLDTRï¼ˆå±€éƒ¨æè¿°ç¬¦è¡¨ï¼‰å¯„å­˜å™¨ï¼Œæ–°å¢çš„å¯„å­˜å™¨ä¸º32ä½ï¼Œè®°å½•äº†è¡¨çš„åŸºå€ã€‚è¡¨ä¸­æ¯ä¸ªè¡¨é¡¹å 8ä¸ªå­—èŠ‚ï¼ˆå¯„å­˜å™¨åªæœ‰2ä¸ªå­—èŠ‚ï¼Œæ‰€ä»¥åªèƒ½å°†è¡¨æ”¾åœ¨å†…å­˜ä¸­ï¼‰ï¼Œå…¶ä¸­è®°å½•äº†æ®µçš„åŸºå€å’Œæ®µç•Œé™ï¼Œè€Œç›¸åº”çš„CS,DS,SS,ESä¸­å­˜æ”¾çš„æ˜¯æ®µæè¿°ç¬¦çš„ç´¢å¼•å€¼ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E6%AE%B5%E6%9C%BA%E5%88%B6.png" alt="image-20220417232229951"></p>
<blockquote>
<p>è¯´åˆ°gdtrå¯„å­˜å™¨å’Œldtrå¯„å­˜å™¨ï¼Œå°±æ¥è¯´è¯´å…¨å±€æè¿°ç¬¦å’Œå±€éƒ¨æè¿°ç¬¦çš„åŒºåˆ«å§ï¼Œä¸€èˆ¬æ¥è¯´å…¨å±€æè¿°ç¬¦æ•´ä¸ªç³»ç»Ÿä¸­åªæœ‰ä¸€ä¸ªï¼Œå…¶ä¸­ä¹Ÿå­˜äº†å¾ˆå¤šldtæè¿°ç¬¦è¡¨çš„åŸºå€ä½œä¸ºè¡¨é¡¹ï¼ˆå› ä¸ºç†è®ºä¸Šæ¥è¯´ldtè¡¨ä¹Ÿæ˜¯ä¸€æ®µå†…å­˜ï¼Œä¹Ÿå¯ä»¥è®¤ä¸ºæ˜¯ä¸€ä¸ªæ®µï¼‰ï¼Œè€Œç»™æ¯ä¸ªä»»åŠ¡åˆ†é…ä¸€ä¸ªldtè¡¨ï¼Œä»»åŠ¡åˆ‡æ¢çš„æ—¶å€™åˆ‡æ¢ldtrå¯„å­˜å™¨ï¼Œgdtrå¯„å­˜å™¨ä¸å˜ï¼Œç”±æ­¤æ¯ä¸ªä»»åŠ¡å¯ä»¥ç”±è‡ªå·±çš„ä»£ç æ®µå †æ ˆæ®µç­‰ï¼Œè€Œå…¨å±€æè¿°ç¬¦è¡¨ä¸­é™¤äº†å­˜å‚¨å†…æ ¸çš„å †æ ˆæ®µç­‰æ®µï¼Œè¿˜è¦å­˜å‚¨æ‰€æœ‰ä»»åŠ¡çš„å±€éƒ¨æè¿°ç¬¦è¡¨æ®µã€‚</p>
</blockquote>
<p>â€‹	ç”¨ç½‘ä¸Šçš„å›¾å§ï¼Œè¯¥å›¾å§æè¿°ç¬¦çš„æ ¼å¼å’Œæ®µå¯„å­˜å™¨çš„æ ¼å¼ä¹Ÿæ ‡æ˜äº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E6%AE%B5%E6%9C%BA%E5%88%B6%E7%BD%91%E5%9B%BE.png" alt="image-20220417232357149"></p>
<p>è€Œlinuxç³»ç»Ÿåœ¨æ®µæè¿°ç¬¦è¡¨ä¸­æŠŠæ‰€æœ‰çš„æ®µåŸºå€éƒ½è®¾ä¸ºäº†<code>0x0</code>,å³å¹³å¦å†…å­˜æ¨¡å‹ï¼Œlinuxä¸­åªæœ‰ä¸€ä¸ªæ®µã€‚</p>
<h5 id="64ä½"><a href="#64ä½" class="headerlink" title="64ä½"></a>64ä½</h5><p>â€‹	åœ¨64ä½æ¨¡å¼ä¸‹ï¼šå¤„ç†å™¨æŠŠCS&#x2F;DS&#x2F;ES&#x2F;SSçš„æ®µåŸºéƒ½å½“ä½œ0ï¼Œå¿½ç•¥ä¸ä¹‹å…³è”çš„æ®µæè¿°ç¬¦ä¸­çš„æ®µåŸºåœ°å€ã€‚å› ä¸ºåœ¨64ä½æ¨¡å¼ä¸­ï¼ŒCPUå¯ä»¥è®¿é—®æ‰€æœ‰å¯å¯»å€çš„å†…å­˜ç©ºé—´ã€‚ä»Šå¤©å¤§å¤šæ•°çš„64ä½CPUåªéœ€è¦è®¿é—®40ä½åˆ°48ä½çš„ç‰©ç†å†…å­˜ï¼Œå› æ­¤ä¸å†éœ€è¦æ®µå¯„å­˜å™¨å»æ‰©å±•ã€‚</p>
<h3 id="åˆ†é¡µ"><a href="#åˆ†é¡µ" class="headerlink" title="åˆ†é¡µ"></a>åˆ†é¡µ</h3><p>åˆ†æ®µå…è®¸è¿›ç¨‹çš„ç‰©ç†åœ°å€ç©ºé—´éè¿ç»­ï¼Œè€Œåˆ†é¡µæ˜¯å¦ä¸€ç§æä¾›è¿™ç§ä¼˜åŠ¿çš„æ–¹æ¡ˆã€‚ä¸”åˆ†é¡µèƒ½å¤Ÿé¿å…å¤–éƒ¨ç¢ç‰‡å’Œç´§ç¼©ï¼Œåˆ†æ®µä¸å¯ä»¥ã€‚é™¤æ­¤ä¹‹å¤–åˆ†é¡µæ›´æœ‰åˆ©äºå†…å­˜å—äº¤æ¢åˆ°äº¤æ¢ç©ºé—´ã€‚</p>
<h4 id="ç¡¬ä»¶æ”¯æŒ"><a href="#ç¡¬ä»¶æ”¯æŒ" class="headerlink" title="ç¡¬ä»¶æ”¯æŒ"></a>ç¡¬ä»¶æ”¯æŒ</h4><p>éƒ½è€³ç†Ÿèƒ½è¯¦äº†ï¼ŒCR3ï¼ŒMMUé‚£ä¸€å¥—å‘—è´´å‡ å¼ å›¾æŠŠã€‚</p>
<h5 id="32ä½-1"><a href="#32ä½-1" class="headerlink" title="32ä½"></a>32ä½</h5><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%8632%E4%BD%8D%E5%88%86%E9%A1%B5%E6%9C%BA%E5%88%B6.png" alt="image-20220418000133826"></p>
<h5 id="64ä½-1"><a href="#64ä½-1" class="headerlink" title="64ä½"></a>64ä½</h5><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E5%88%86%E9%A1%B5%E6%9C%BA%E5%88%B664%E4%BD%8D.png" alt="image-20220418000207908"></p>
<h3 id="æ®µé¡µå¼å†…å­˜ç®¡ç†"><a href="#æ®µé¡µå¼å†…å­˜ç®¡ç†" class="headerlink" title="æ®µé¡µå¼å†…å­˜ç®¡ç†"></a>æ®µé¡µå¼å†…å­˜ç®¡ç†</h3><p>â€‹	å°†åˆ†æ®µå’Œåˆ†é¡µç»“åˆçš„æ–¹å¼ï¼Œä¹Ÿè€³ç†Ÿèƒ½è¯¦äº†å§ï¼Œä¹Ÿè´´ä¸€å¼ å›¾å°±å®Œäº†ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86-%E6%AE%B5%E9%A1%B5%E5%BC%8F%E5%86%85%E5%AD%98%E7%AE%A1%E7%90%86.png" alt="image-20220418000509846"></p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>å­˜å‚¨ç®¡ç†</title>
    <url>/2022/04/19/note/%E5%AD%98%E5%82%A8%E7%AE%A1%E7%90%86/</url>
    <content><![CDATA[<h1 id="å­˜å‚¨ç®¡ç†"><a href="#å­˜å‚¨ç®¡ç†" class="headerlink" title="å­˜å‚¨ç®¡ç†"></a>å­˜å‚¨ç®¡ç†</h1><h2 id="å­˜å‚¨ä»‹è´¨"><a href="#å­˜å‚¨ä»‹è´¨" class="headerlink" title="å­˜å‚¨ä»‹è´¨"></a>å­˜å‚¨ä»‹è´¨</h2><p>â€‹	å­˜å‚¨ä»‹è´¨å¯ä»¥åˆ†ä¸ºç£ç›˜(hard disk)ã€å›ºæ€ç£ç›˜(Solid-State Disk)ã€ç£å¸¦(magnetic tape)ã€‚</p>
<h2 id="ç£ç›˜è°ƒåº¦"><a href="#ç£ç›˜è°ƒåº¦" class="headerlink" title="ç£ç›˜è°ƒåº¦"></a>ç£ç›˜è°ƒåº¦</h2><ul>
<li>å¯»é“æ—¶é—´ï¼šç£è‡‚ç§»åŠ¨ç£å¤´åˆ°åŒ…å«ç›®æ ‡æ‰‡åŒºçš„æŸ±é¢çš„æ—¶é—´ã€‚</li>
<li>æ—‹è½¬å»¶è¿Ÿæ—¶é—´ï¼šç£ç›˜æ—‹è½¬ç›®æ ‡æ‰‡åŒºåˆ°ç£å¤´ä¸‹çš„æ—¶é—´ã€‚</li>
<li>ç£ç›˜å¸¦å®½ï¼šä¼ è¾“å­—èŠ‚çš„æ€»æ•°é™¤ä»¥æœåŠ¡æ—¶é—´ã€‚</li>
</ul>
<h3 id="å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ï¼ˆFirst-come-first-servedï¼ŒFCFSï¼‰"><a href="#å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ï¼ˆFirst-come-first-servedï¼ŒFCFSï¼‰" class="headerlink" title="å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ï¼ˆFirst come first servedï¼ŒFCFSï¼‰"></a>å…ˆæ¥å…ˆæœåŠ¡è°ƒåº¦ï¼ˆFirst come first servedï¼ŒFCFSï¼‰</h3><p>â€‹	é¡¾åæ€ä¹‰</p>
<h3 id="æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼ˆshortest-seek-time-firstï¼ŒSSTFï¼‰"><a href="#æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼ˆshortest-seek-time-firstï¼ŒSSTFï¼‰" class="headerlink" title="æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼ˆshortest seek time firstï¼ŒSSTFï¼‰"></a>æœ€çŸ­å¯»é“æ—¶é—´ä¼˜å…ˆï¼ˆshortest seek time firstï¼ŒSSTFï¼‰</h3><p>â€‹	ä¼˜å…ˆé€‰æ‹©ç¦»å½“å‰ç£å¤´è¿‘çš„è¯·æ±‚ï¼Œæœ¬è´¨ä¸Šæ˜¯ä¸€ç§æœ€çŸ­ä½œä¸šä¼˜å…ˆè°ƒåº¦ï¼Œä¼šå¯¼è‡´è¯·æ±‚é¥¥é¥¿ã€‚</p>
<h3 id="æ‰«æç®—æ³•ï¼ˆSCAN-algorithmï¼‰"><a href="#æ‰«æç®—æ³•ï¼ˆSCAN-algorithmï¼‰" class="headerlink" title="æ‰«æç®—æ³•ï¼ˆSCAN algorithmï¼‰"></a>æ‰«æç®—æ³•ï¼ˆSCAN algorithmï¼‰</h3><p>â€‹	ç£è‡‚ä»ç£ç›˜çš„ä¸€ç«¯å¼€å§‹å‘å¦ä¸€ç«¯ç§»åŠ¨ï¼Œåˆ°è¾¾ä¸€ç«¯åç£å¤´åè½¬ã€‚æœ‰æ—¶å€™ä¹Ÿè¢«ç§°ä¸º<strong>ç”µæ¢¯ç®—æ³•ï¼ˆelevator algorithmï¼‰</strong></p>
<h3 id="å¾ªç¯æ‰«æç®—æ³•ï¼ˆcircular-SCANï¼Œ-C-SCANï¼‰"><a href="#å¾ªç¯æ‰«æç®—æ³•ï¼ˆcircular-SCANï¼Œ-C-SCANï¼‰" class="headerlink" title="å¾ªç¯æ‰«æç®—æ³•ï¼ˆcircular SCANï¼Œ C-SCANï¼‰"></a>å¾ªç¯æ‰«æç®—æ³•ï¼ˆcircular SCANï¼Œ C-SCANï¼‰</h3><p>â€‹	å¦‚æœè¯·æ±‚æ˜¯å‡åŒ€çš„ï¼ŒSCANåœ¨æ‰«æçš„æ—¶å€™ï¼Œå½“å‰æ‰€åœ¨ä½ç½®çš„å¤„ç†å› ä¸ºåˆšæ‰«è¿‡ï¼Œæ‰€ä»¥é™„è¿‘çš„è¯·æ±‚æ•°è¾ƒå°‘ï¼Œè€Œç›¸åå¦ä¸€ç«¯è¯·æ±‚æ•°è‚¯å®šè¾ƒå¤šã€‚äºæ˜¯å°±è¡ç”Ÿå‡ºäº†C-SCANã€‚å³æ‰«åˆ°ä¸€ç«¯åç«‹å³è¿”å›ï¼Œä½†æ˜¯ä¸å¤„ç†ä»»ä½•è¯·æ±‚ï¼Œç„¶ååˆé‡æ–°å¼€å§‹æ‰«ã€‚</p>
<h3 id="LOOKè°ƒåº¦ä¸C-LOOKè°ƒåº¦"><a href="#LOOKè°ƒåº¦ä¸C-LOOKè°ƒåº¦" class="headerlink" title="LOOKè°ƒåº¦ä¸C-LOOKè°ƒåº¦"></a>LOOKè°ƒåº¦ä¸C-LOOKè°ƒåº¦</h3><p>â€‹	ç±»ä¼¼äºSCANå’ŒC-SCANï¼Œä½†æ˜¯å®ƒä¸ç§»åŠ¨æ•´ä¸ªç£ç›˜å®½åº¦ï¼Œè€Œæ˜¯ç§»åŠ¨åˆ°æœ€è¿œçš„ä¸€ä¸ªè¯·æ±‚ä¸ºæ­¢ã€‚</p>
<h2 id="ç£ç›˜ç®¡ç†"><a href="#ç£ç›˜ç®¡ç†" class="headerlink" title="ç£ç›˜ç®¡ç†"></a>ç£ç›˜ç®¡ç†</h2><h3 id="ç£ç›˜æ ¼å¼åŒ–"><a href="#ç£ç›˜æ ¼å¼åŒ–" class="headerlink" title="ç£ç›˜æ ¼å¼åŒ–"></a>ç£ç›˜æ ¼å¼åŒ–</h3><ul>
<li>ä½çº§æ ¼å¼åŒ–&#x2F;ç‰©ç†æ ¼å¼åŒ–ï¼šå°†ç©ºç™½ç£ç›˜åˆ†æˆæ‰‡åŒºï¼Œå¹¶ä½¿ç”¨ç‰¹æ®Šæ•°æ®ç»“æ„å¡«å……ï¼ˆå…¶ä¸­åŒ…æ‹¬ECCï¼ˆçº é”™ç ï¼‰ï¼Œç”¨ä»¥æ ¡å¯¹å’Œä¿®å¤é”™è¯¯å­—èŠ‚ï¼‰</li>
<li>åˆ†åŒºï¼šå°†ç£ç›˜åˆ†ä¸ºç”±æŸ±é¢ç»„æˆçš„åˆ†åŒºï¼Œä¸åŒåˆ†åŒºä¸Šå¯ä»¥è£…ä¸åŒçš„æ“ä½œç³»ç»Ÿã€‚</li>
<li>é€»è¾‘æ ¼å¼åŒ–ï¼šå³åˆ›å»ºæ–‡ä»¶ç³»ç»Ÿã€‚</li>
</ul>
<h3 id="å¼•å¯¼å—"><a href="#å¼•å¯¼å—" class="headerlink" title="å¼•å¯¼å—"></a>å¼•å¯¼å—</h3><p>â€‹	bootstrapç¨‹åºï¼ˆå¤„äºROMä¸­ï¼‰æ‰¾åˆ°ç£ç›˜ä¸Šçš„å¼•å¯¼å—ï¼Œå°†å…¶åŠ è½½å…¥å†…å­˜ï¼Œç„¶åè¯¥å¼•å¯¼å—çš„ä»£ç æ‰¾åˆ°æ“ä½œç³»ç»Ÿæ‰€åœ¨åˆ†åŒºï¼Œå¹¶å°†æ“ä½œç³»ç»ŸåŠ è½½å…¥å†…å­˜ã€‚</p>
<h3 id="åå—"><a href="#åå—" class="headerlink" title="åå—"></a>åå—</h3><p>â€‹	ç£ç›˜ä¸Šä¸€èˆ¬æœ‰å¤‡ç”¨å—ä½œä¸ºåå—çš„å¤‡ä»½ï¼Œå½“æŸäº›å—æŸåæ—¶å€™ï¼Œç£ç›˜å¯ä»¥åˆ©ç”¨è¿™äº›å¤‡ç”¨å—è¿›è¡Œè¡¥å……ã€‚</p>
<h2 id="äº¤æ¢ç©ºé—´ç®¡ç†"><a href="#äº¤æ¢ç©ºé—´ç®¡ç†" class="headerlink" title="äº¤æ¢ç©ºé—´ç®¡ç†"></a>äº¤æ¢ç©ºé—´ç®¡ç†</h2><p>äº¤æ¢ç©ºé—´å¯åˆ†ä¸ºæ–‡ä»¶æˆ–è€…äº¤æ¢åˆ†åŒºã€‚</p>
<ul>
<li>æ–‡ä»¶ï¼šä½äºæ™®é€šæ–‡ä»¶ç³»ç»Ÿä¹‹ä¸Šï¼Œä½†æ˜¯æ•ˆç‡ä½ï¼Œå› ä¸ºéœ€è¦è®¿é—®ç£ç›˜ç›®å½•ç­‰ç»“æ„ï¼Œéœ€è¦é¢å¤–çš„æ—¶é—´ï¼ŒåŒæ—¶å¯èƒ½éœ€è¦éå†æ–‡ä»¶ç³»ç»Ÿã€‚</li>
<li>äº¤æ¢åˆ†åŒºï¼šåœ¨å•ç‹¬çš„åŸå§‹åˆ†åŒºä¸Šåˆ›å»ºäº¤æ¢ç©ºé—´ï¼Œä¸å­˜åœ¨æ–‡ä»¶ç³»ç»Ÿï¼Œä½†æ˜¯å¯èƒ½ä¼šå¢åŠ å†…éƒ¨ç¢ç‰‡ã€‚</li>
</ul>
<p>Linux çš„äº¤æ¢ç©ºé—´ä»…ç”¨äºåŒ¿åå†…å­˜ï¼ˆå³å †ï¼Œæ ˆï¼Œè¿›ç¨‹æœªåˆå§‹åŒ–æ•°æ®ç­‰åŒºåŸŸï¼‰ï¼Œè€Œä»£ç ç­‰æœ¬æ¥æ˜¯ä»ç£ç›˜ä¸Šè¯»çš„ï¼Œå¯ä»¥ç›´æ¥ä¸¢å¼ƒã€‚è€Œåˆ«çš„éƒ¨åˆ†é€šè¿‡äº¤æ¢æ˜ å°„è¿›è¡Œäº¤æ¢ã€‚äº¤æ¢æ˜ å°„ä¸ºä¸€ä¸ªæ•°ç»„ï¼Œæ•°ç»„ä¸­å†…å®¹è¡¨ç¤ºè¯¥å¯¹åº”çš„äº¤æ¢é¡µç”±å¤šå°‘è¿›ç¨‹ä½¿ç”¨ï¼ˆå¯èƒ½æœ‰å…±äº«å†…å­˜ï¼Œå¯¼è‡´æ•°ç»„å€¼å¤§äº1ï¼Œä¸º0åˆ™è¡¨æ˜ç©ºé—²ï¼‰</p>
<h2 id="ç£ç›˜å†—ä½™é˜µåˆ—ï¼ˆRedundant-Arrays-of-Independent-Diskï¼ŒRAIDï¼‰"><a href="#ç£ç›˜å†—ä½™é˜µåˆ—ï¼ˆRedundant-Arrays-of-Independent-Diskï¼ŒRAIDï¼‰" class="headerlink" title="ç£ç›˜å†—ä½™é˜µåˆ—ï¼ˆRedundant Arrays of Independent Diskï¼ŒRAIDï¼‰"></a>ç£ç›˜å†—ä½™é˜µåˆ—ï¼ˆRedundant Arrays of Independent Diskï¼ŒRAIDï¼‰</h2><p>ç£ç›˜çš„å¹¶è¡Œå¯ä»¥åŠ é€Ÿæ–‡ä»¶çš„è¯»å–ï¼Œæ¯”å¦‚åŒæ—¶æœ‰8ä¸ªç›˜ï¼Œå¯ä»¥åŒæ—¶è¯»å–ï¼Œæ¯ä¸ªç›˜ä¸Šè¯»å–ä¸€ä½åˆ™å½¢æˆäº†ä¸€ä¸ªå­—ã€‚</p>
<ul>
<li>RAID0ï¼šæœ‰å¤šä¸ªç£ç›˜ï¼Œä½†æ˜¯æ²¡æœ‰å†—ä½™æ•°æ®ã€‚</li>
<li>RAID1ï¼šé•œåƒç£ç›˜ï¼Œå³æ¯ä¸ªç£ç›˜æœ‰ä¸€ä¸ªä¸€æ¨¡ä¸€æ ·çš„é•œåƒç£ç›˜ï¼Œéœ€è¦ä¸¤å€å¤§å°å­˜å‚¨ç©ºé—´ã€‚</li>
<li>RAID2ï¼šå†…å­˜æ–¹å¼çš„å·®é”™çº æ­£ç»„ç»‡ã€‚ç”¨å¤šä¸ªé¢å¤–çš„ä½ç”¨äºå¥‡å¶æ ¡éªŒä½ï¼Œå½“å¥‡å¶æ ¡éªŒä½å‡ºé”™æ—¶å€™ï¼Œå¯ä»¥ç”±å†…å­˜ç³»ç»Ÿæ£€æµ‹ã€‚ç”±æ­¤åœ¨ä¸€å®šç¨‹åº¦ä¸Šå¯ä»¥ä¿®å¤å•ä¸ªä½å‡ºé”™ï¼ˆå¥‡å˜å¶ï¼Œå¶å˜å¥‡ï¼‰ã€‚å¦‚ç¬¬ä¸€ä¸ªç£ç›˜å­˜å‚¨ç¬¬ä¸€ä¸ªå­—èŠ‚ï¼Œç¬¬äºŒä¸ªç£ç›˜å­˜å‚¨ç¬¬äºŒä¸ªå­—èŠ‚ã€‚ã€‚ã€‚ç„¶åå‰©ä¸‹å‡ ä¸ªç£ç›˜å­˜å‚¨å¥‡å¶æ ¡éªŒä½ã€‚æ¯”RAID1ç¨å¾®èŠ‚çº¦äº†ç©ºé—´ã€‚</li>
<li>RAID3ï¼šä½äº¤é”™å¥‡å¶æ ¡éªŒä½ç»“æ„ã€‚åªæœ‰ä¸€ä¸ªé¢å¤–çš„ç£ç›˜ä½œä¸ºæ ¡éªŒä½ï¼Œç±»ä¼¼äºRAID2ï¼Œä½†æ˜¯ç£ç›˜æ§åˆ¶å™¨æ¥æ£€æµ‹æ‰‡åŒºè¯»å–æ˜¯å¦æ­£ç¡®ã€‚</li>
<li>RAID4ï¼šå—äº¤é”™å¥‡å¶æ ¡éªŒä½ç»“æ„ã€‚</li>
<li>RAID5ï¼šå—äº¤é”™åˆ†å¸ƒå¥‡å¶æ ¡éªŒç»“æ„ã€‚å°†æ•°æ®å’Œå¥‡å¶æ ¡éªŒåˆ†æ•£åœ¨æ¯ä¸€ä¸ªç£ç›˜ä¸Šï¼Œè€ŒRAID4å’Œ3æ˜¯ç”¨ä¸€ä¸ªå•ç‹¬çš„ç£ç›˜å­˜å‚¨å¥‡å¶æ ¡éªŒã€‚ï¼ˆæœ€ä¸ºå¸¸è§ï¼‰</li>
<li>RAID6ï¼šP+Qå†—ä½™æ–¹æ¡ˆã€‚ç±»ä¼¼RAID5ï¼Œä½†æ˜¯ä¿å­˜äº†é¢å¤–çš„å†—ä½™ä¿¡æ¯ï¼Œå¯ä»¥å®¹å¿ä¸¤ä¸ªç£ç›˜æ•…éšœã€‚</li>
<li>RAID0+1ï¼š0å’Œ1ç»„åˆï¼Œå…ˆåˆ†æ¡ï¼Œå†é•œåƒã€‚</li>
<li>RAID1+0ï¼šå…ˆé•œåƒï¼Œå†åˆ†æ¡ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>æ­»é”</title>
    <url>/2022/04/19/note/%E6%AD%BB%E9%94%81/</url>
    <content><![CDATA[<h1 id="æ­»é”"><a href="#æ­»é”" class="headerlink" title="æ­»é”"></a>æ­»é”</h1><h2 id="æ­»é”çš„åŸå› "><a href="#æ­»é”çš„åŸå› " class="headerlink" title="æ­»é”çš„åŸå› "></a>æ­»é”çš„åŸå› </h2><ul>
<li>ç³»ç»Ÿèµ„æºçš„ç«äº‰</li>
<li>è¿›ç¨‹æ¨è¿›é¡ºåºçš„éæ³•</li>
</ul>
<h2 id="æ­»é”çš„å¿…è¦æ¡ä»¶"><a href="#æ­»é”çš„å¿…è¦æ¡ä»¶" class="headerlink" title="æ­»é”çš„å¿…è¦æ¡ä»¶"></a>æ­»é”çš„å¿…è¦æ¡ä»¶</h2><ul>
<li>äº’æ–¥(mutual exclusion):è‡³å°‘å­˜åœ¨ä¸€ä¸ªèµ„æºä½¿å¾—ä¸¤ä¸ªè¿›ç¨‹éœ€è¦äº’æ–¥ä½¿ç”¨ï¼Œå³ä¸€ä¸ªè¿›ç¨‹åœ¨ä½¿ç”¨æ—¶ï¼Œå¦ä¸€ä¸ªè¿›ç¨‹å¿…é¡»ç­‰å¾…ã€‚</li>
<li>å æœ‰å¹¶ç­‰å¾…(hold and wait):ä¸€ä¸ªè¿›ç¨‹å æœ‰äº†æŸä¸ªèµ„æºåç­‰å¾…å¦ä¸€ä¸ªèµ„æºï¼Œä½†æ˜¯å¦ä¸€ä¸ªèµ„æºè¢«å¦å¤–ä¸€ä¸ªè¿›ç¨‹æ‰€å æœ‰ã€‚</li>
<li>éæŠ¢å (no preemption):èµ„æºä¸èƒ½è¢«æŠ¢å ï¼Œåªèƒ½è¢«å æœ‰çš„èµ„æºèµ„æºé‡Šæ”¾ã€‚</li>
<li>å¾ªç¯ç­‰å¾…(circular wait):ä¸€ç»„èµ„æºï¼ŒAç­‰å¾…BæŠ¢å çš„èµ„æºï¼ŒBç­‰å¾…CæŠ¢å çš„èµ„æºâ€¦â€¦.æœ€åNç­‰å¾…AæŠ¢å çš„èµ„æºï¼Œä»è€Œå½¢æˆç¯ã€‚</li>
</ul>
<p>å››ä¸ªæ¡ä»¶åŒæ—¶æˆç«‹ä¾¿ä¼šå‡ºç°æ­»é”ï¼Œä¸”å››ä¸ªæ¡ä»¶å¹¶ä¸å®Œå…¨ç‹¬ç«‹(å¦‚å¾ªç¯ç­‰å¾…å¯èƒ½éœ€è¦å æœ‰å¹¶ç­‰å¾…çš„æ¡ä»¶æ‰èƒ½æ»¡è¶³)ã€‚</p>
<h2 id="èµ„æºåˆ†é…å›¾"><a href="#èµ„æºåˆ†é…å›¾" class="headerlink" title="èµ„æºåˆ†é…å›¾"></a>èµ„æºåˆ†é…å›¾</h2><p>å¦‚å›¾æ‰€ç¤ºå³èµ„æºåˆ†é…å›¾ï¼Œå…¶ä¸­åœ†å½¢è¡¨ç¤ºè¿›ç¨‹ï¼ŒçŸ©å½¢è¡¨ç¤ºèµ„æºï¼ŒP-&gt;Rè¡¨ç¤ºä¸€æ¡ç”³è¯·è¾¹ï¼ŒR-&gt;Pè¡¨ç¤ºåˆ†é…è¾¹ã€‚</p>
<p>å¯ä»¥è¯æ˜å¦‚æœåˆ†é…å›¾ä¸­æ²¡æœ‰ç¯ï¼Œåˆ™ç³»ç»Ÿä¸­æ²¡æœ‰æ­»é”è¿›ç¨‹ï¼Œå¦‚æœæœ‰ç¯åˆ™<strong>å¯èƒ½</strong>å­˜åœ¨æ­»é”ã€‚è€Œåˆšå¥½æ¯ç§èµ„æºåªæœ‰ä¸€ä¸ªæ—¶å€™ï¼Œå­˜åœ¨ç¯åˆ™è¯´æ˜æœ‰æ­»é”æƒ…å†µå‘ç”Ÿã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E6%AD%BB%E9%94%81-%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E5%9B%BE.png" alt="image-20220416203128743"></p>
<h2 id="æ­»é”å¤„ç†æ–¹æ³•"><a href="#æ­»é”å¤„ç†æ–¹æ³•" class="headerlink" title="æ­»é”å¤„ç†æ–¹æ³•"></a>æ­»é”å¤„ç†æ–¹æ³•</h2><ul>
<li>æ­»é”é¢„é˜²ï¼šé™åˆ¶æ­»é”çš„å››ä¸ªæ¡ä»¶ï¼Œç ´åå…¶ä¸­ä¸€ä¸ªæˆ–å‡ ä¸ªæ¡ä»¶ã€‚</li>
<li>æ­»é”é¿å…ï¼šèµ„æºåˆ†é…è¿‡ç¨‹ä¸­ï¼Œé˜²æ­¢ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ã€‚</li>
<li>æ­»é”æ£€æµ‹åŠè§£é™¤ï¼šä¸é‡‡å–ä»»ä½•æªæ–½ï¼Œä½†æ˜¯åœ¨ç³»ç»Ÿè¿è¡Œä¸­åŠæ—¶æ£€æµ‹æ­»é”çš„å­˜åœ¨ï¼Œç„¶åè§£é™¤ä»–ä»¬ã€‚</li>
</ul>
<h3 id="æ­»é”é¢„é˜²"><a href="#æ­»é”é¢„é˜²" class="headerlink" title="æ­»é”é¢„é˜²"></a>æ­»é”é¢„é˜²</h3><h4 id="äº’æ–¥"><a href="#äº’æ–¥" class="headerlink" title="äº’æ–¥"></a>äº’æ–¥</h4><p>â€‹	äº’æ–¥æ¡ä»¶å¿…é¡»æˆç«‹ã€‚</p>
<h4 id="æŒæœ‰ä¸”ç­‰å¾…"><a href="#æŒæœ‰ä¸”ç­‰å¾…" class="headerlink" title="æŒæœ‰ä¸”ç­‰å¾…"></a>æŒæœ‰ä¸”ç­‰å¾…</h4><p>â€‹	åœ¨ç”³è¯·ä¸€ä¸ªèµ„æºæ—¶å€™ä¸èƒ½å æœ‰å…¶ä»–èµ„æº(å³ç”³è¯·èµ„æºçš„ç³»ç»Ÿè°ƒç”¨åœ¨å…¶ä»–ç³»ç»Ÿè°ƒç”¨ä¹‹å‰è¿›è¡Œï¼Œæˆ–è€…ç”³è¯·æ—¶å€™é‡Šæ”¾å·²åˆ†é…çš„èµ„æºï¼Œæˆ–è€…åœ¨è¿›ç¨‹è¿è¡Œå‰ä¸€æ¬¡æ€§åˆ†é…æ‰€æœ‰çš„èµ„æº)ï¼Œè¿™æ ·åšç¼ºç‚¹å°±æ˜¯èµ„æºåˆ©ç”¨ç‡ä½ï¼Œä¸”å¯èƒ½å‘ç”Ÿé¥¥é¥¿ã€‚</p>
<h4 id="éæŠ¢å "><a href="#éæŠ¢å " class="headerlink" title="éæŠ¢å "></a>éæŠ¢å </h4><p>â€‹	åœ¨ç”³è¯·èµ„æºæ—¶å€™ï¼Œç°æœ‰çš„èµ„æºéƒ½å¯è¢«æŠ¢å æˆ–è€…é‡Šæ”¾ã€‚ä¼šå¢åŠ ç³»ç»Ÿçš„å¼€é”€ï¼Œé™ä½ç³»ç»Ÿçš„ååç‡ï¼Œé€‚åˆäºCPUå¯„å­˜å™¨å’Œå†…å­˜ã€‚</p>
<h4 id="å¾ªç¯ç­‰å¾…"><a href="#å¾ªç¯ç­‰å¾…" class="headerlink" title="å¾ªç¯ç­‰å¾…"></a>å¾ªç¯ç­‰å¾…</h4><p>â€‹	å¯¹æ‰€æœ‰èµ„æºè¿›è¡Œæ’åºï¼Œèµ„æºç”³è¯·å¿…é¡»æŒ‰ç…§ç»™å®šçš„é¡ºåºè¿›è¡Œç”³è¯·ã€‚éœ€è¦ç¨‹åºå‘˜è‡ªè§‰éµå®ˆé¡ºåºï¼Œä¸”å¦‚æœå¢åŠ äº†æ–°ç±»å‹çš„è®¾å¤‡ï¼Œä¼šæ”¹å˜æ—¢å®šçš„åˆ†é…é¡ºåºï¼Œåˆ™ç¼–ç¨‹ä»£ç éƒ½éœ€è¦æ”¹å˜ã€‚</p>
<h3 id="æ­»é”é¿å…"><a href="#æ­»é”é¿å…" class="headerlink" title="æ­»é”é¿å…"></a>æ­»é”é¿å…</h3><p>é¿å…æ­»é”éœ€è¦é¢å¤–çš„ä¿¡æ¯ï¼Œå³å¦‚ä½•ç”³è¯·èµ„æºï¼Œè·çŸ¥æ¯ä¸ªè¿›ç¨‹çš„èµ„æºè¯·æ±‚å’Œé‡Šæ”¾é¡ºåºä¹‹åï¼Œç³»ç»Ÿå¯ä»¥å†³å®šåœ¨è¿›ç¨‹è¯·æ±‚èµ„æºæ—¶å€™é¿å…æœªæ¥å¯èƒ½çš„æ­»é”ã€‚è€Œä¿æŒç³»ç»Ÿä¸€ç›´å¤„äº<strong>å®‰å…¨çŠ¶æ€</strong>å³å¯é¿å…æ­»é”ã€‚ä½†æ˜¯å¹¶éæ‰€æœ‰çš„ä¸å®‰å…¨çŠ¶æ€éƒ½æ˜¯æ­»é”çŠ¶æ€ï¼Œä½†å½“ç³»ç»Ÿè¿›å…¥ä¸å®‰å…¨çŠ¶æ€ä¹‹åï¼Œä¾¿å¯èƒ½è¿›å…¥æ­»é”çŠ¶æ€ã€‚</p>
<h4 id="èµ„æºåˆ†é…å›¾ç®—æ³•"><a href="#èµ„æºåˆ†é…å›¾ç®—æ³•" class="headerlink" title="èµ„æºåˆ†é…å›¾ç®—æ³•"></a>èµ„æºåˆ†é…å›¾ç®—æ³•</h4><p>â€‹	åœ¨å‰è¿°èµ„æºåˆ†é…å›¾ä¸­å¢åŠ éœ€æ±‚è¾¹ã€‚è¿™ç§è¾¹ä¸ç”³è¯·è¾¹(P-&gt;R)ä¸€æ ·ï¼Œä½†æ˜¯æ˜¯è™šçº¿ã€‚</p>
<p>â€‹	å½“è¿›ç¨‹ç”³è¯·èµ„æºæ—¶å€™åˆ™æŠŠå…¶å˜ä¸ºP-&gt;Rçš„ç”³è¯·è¾¹ï¼Œå½“ç”³è¯·åˆ°èµ„æºä¹‹ååˆ™å˜æˆR-&gt;Pçš„åˆ†é…è¾¹ï¼Œèµ„æºé‡Šæ”¾ä¹‹åR-&gt;çš„åˆ†é…è¾¹å˜ä¸ºP-&gt;Rçš„è™šçº¿éœ€æ±‚è¾¹ã€‚</p>
<p>â€‹	èµ„æºåˆ†é…å›¾ç®—æ³•è¦æ±‚ï¼Œåœ¨è¿›ç¨‹ç”³è¯·èµ„æºæ—¶ï¼Œåªæœ‰å°†å…¶ç”³è¯·è¾¹å˜ä¸ºåˆ†é…è¾¹æ—¶ï¼Œä¸ä¼šå¯¼è‡´èµ„æºåˆ†é…å›¾å½¢æˆç¯ã€‚å¦‚å›¾æ‰€ç¤ºå›¾ä¸€å¦‚æœå˜æˆå›¾äºŒï¼Œåˆ™ä¼šå½¢æˆç¯ï¼Œäºæ˜¯å›¾äºŒè¢«è®¤ä¸ºæ˜¯ä¸å®‰å…¨çŠ¶æ€ï¼Œä¸äºˆåˆ†é…èµ„æºã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E6%AD%BB%E9%94%81-%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E5%9B%BE%E7%AE%97%E6%B3%95.png" alt="image-20220416210119664"></p>
<h4 id="é“¶è¡Œå®¶ç®—æ³•"><a href="#é“¶è¡Œå®¶ç®—æ³•" class="headerlink" title="é“¶è¡Œå®¶ç®—æ³•"></a>é“¶è¡Œå®¶ç®—æ³•</h4><p>ä¸€å¥è¯æ¥è¯´å°±æ˜¯å‡è®¾åˆ†é…ç»™ä¸€ä¸ªè¿›ç¨‹èµ„æºä¹‹åï¼Œç³»ç»Ÿæ˜¯å¦å¤„äºä¸å®‰å…¨çŠ¶æ€ï¼Œå¦‚æœæ˜¯ä¸å®‰å…¨çŠ¶æ€åˆ™ä¸ç»™è¯¥æ¬¡åˆ†é…ã€‚</p>
<p>å…·ä½“è¿‡ç¨‹å°±æ˜¯æ ¹æ®è¿™å¥è¯ï¼Œç„¶åæŠŠä¸‰ä¸ªçŸ©é˜µå˜æ¥å˜å»ï¼Œæ‡’å¾—è®²äº†ï¼Œç›´æ¥çœ‹ä¹¦æ¯”è¾ƒå®åœ¨(ä¹¦ä¸Šbalabalaè®²äº†ä¸€å †ä¼°è®¡ä¹Ÿæ‡’å¾—çœ‹ï¼Œåæ­£è®°ä½è¿™å¥è¯å°±è¡Œäº†)</p>
<h3 id="æ­»é”æ£€æµ‹"><a href="#æ­»é”æ£€æµ‹" class="headerlink" title="æ­»é”æ£€æµ‹"></a>æ­»é”æ£€æµ‹</h3><h4 id="æ­»é”å®šç†åŠèµ„æºåˆ†é…å›¾ç®€åŒ–ç®—æ³•"><a href="#æ­»é”å®šç†åŠèµ„æºåˆ†é…å›¾ç®€åŒ–ç®—æ³•" class="headerlink" title="æ­»é”å®šç†åŠèµ„æºåˆ†é…å›¾ç®€åŒ–ç®—æ³•"></a>æ­»é”å®šç†åŠèµ„æºåˆ†é…å›¾ç®€åŒ–ç®—æ³•</h4><p>è¿˜æ˜¯è¿™å¼ å›¾ï¼Œç®€åŒ–ç®—æ³•å¦‚ä¸‹ï¼š</p>
<ul>
<li>åœ¨èµ„æºåˆ†é…å›¾ä¸­æ‰¾åˆ°æ—¢ä¸é˜»å¡ï¼Œä¹Ÿä¸å­¤ç‚¹çš„è¿›ç¨‹P<del>i</del>ï¼Œå¹¶æ¶ˆé™¤å…¶æ‰€æœ‰è¯·æ±‚è¾¹å’Œåˆ†é…è¾¹ã€‚å³æ‰¾åˆ°ä¸€æ¡æœ‰å‘ç”³è¯·è¾¹ï¼Œå…¶å°¾éƒ¨å¯¹åº”è¯¥è¿›ç¨‹P<del>i</del>ï¼Œå…¶è¾¹ç®­å¤´æ‰€æŒ‡çš„èµ„æºç”³è¯·æ•°é‡å°äºç­‰äºç³»ç»Ÿä¸­ç©ºé—²èµ„æºæ•°é‡ã€‚(å¦‚å›¾ä¸­èµ„æºR<del>2</del>èµ„æºæœ‰ä¸¤ä¸ªï¼Œå…¶ä¸­åˆ†é…å‡ºå»ç»™P<del>2</del>ä¸€ä¸ªï¼Œæ‰€ä»¥ç©ºé—²çš„æ˜¯ä¸€ä¸ªï¼Œè€ŒP<del>1</del>è¿›ç¨‹ç”³è¯·è¾¹è¯·æ±‚ä¸€ä¸ªï¼Œæ»¡è¶³å°äºç­‰äºï¼Œä¹Ÿå°±è¯´æ˜P<del>1</del>å¯ä»¥æ­£å¸¸ç”³è¯·ä¸”è¿è¡Œï¼Œç„¶åå°†å…¶æ‰€æœ‰çš„åˆ†é…è¾¹å’Œç”³è¯·è¾¹å…¨åˆ é™¤ï¼Œè¡¨æ˜è¿›ç¨‹è¿è¡Œå®Œæˆèµ„æºé‡Šæ”¾ã€‚)</li>
<li>ä¸æ–­åˆ å»æ‰€æœ‰è¿™æ ·çš„è¿›ç¨‹ï¼Œæœ€åèƒ½å¤Ÿåˆ é™¤æ‰€æœ‰çš„è¾¹ï¼Œåˆ™è¡¨æ˜æ­¤èµ„æºåˆ†é…å›¾å¯ç®€åŒ–ã€‚</li>
</ul>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E6%AD%BB%E9%94%81-%E8%B5%84%E6%BA%90%E5%88%86%E9%85%8D%E5%9B%BE.png" alt="image-20220416203128743"></p>
<p>â€‹	<strong>æ­»é”å®šç†</strong>è¡¨æ˜ï¼ŒSä¸ºæ­»é”çš„æ¡ä»¶æ˜¯å½“ä¸”ä»…å½“SçŠ¶æ€çš„èµ„æºåˆ†é…å›¾æ˜¯ä¸å¯å®Œå…¨ç®€åŒ–çš„ã€‚</p>
<h4 id="ç­‰å¾…å›¾"><a href="#ç­‰å¾…å›¾" class="headerlink" title="ç­‰å¾…å›¾"></a>ç­‰å¾…å›¾</h4><p>â€‹	å¦‚æœæ‰€æœ‰èµ„æºåªæœ‰å•ä¸ªå®ä¾‹ï¼Œåˆ™å¯ä»¥ä½¿ç”¨ç­‰å¾…å›¾çš„æ–¹å¼ã€‚ç­‰å¾…å›¾å³ä»èµ„æºåˆ†é…å›¾ä¸­åˆ é™¤æ‰€æœ‰èµ„æºç±»å‹çš„èŠ‚ç‚¹ï¼Œå¹¶åˆå¹¶é€‚å½“çš„è¾¹å³å¯ã€‚å³å¦‚æœèµ„æºåˆ†é…å›¾ä¸­å­˜åœ¨P<del>i</del> -&gt;R<del>q</del>å’ŒR<del>q</del>-&gt;P<del>j</del>çš„ä¸¤æ¡è¾¹ï¼Œåˆ™ç­‰å¾…å›¾ä¸­å­˜åœ¨ä¸€æ¡P<del>i</del>-&gt;P<del>j</del>çš„ä¸€æ¡è¾¹ã€‚å¦‚å›¾aä¸ºèµ„æºåˆ†é…å›¾ï¼Œbä¸ºå¯¹åº”çš„ç­‰å¾…å›¾ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img%E6%AD%BB%E9%94%81-%E7%AD%89%E5%BE%85%E5%9B%BE.png" alt="image-20220416214133325"></p>
<p>â€‹	å½“ç­‰å¾…å›¾ä¸­æœ‰ä¸€ä¸ªç¯åˆ™ç³»ç»Ÿæ­»é”ã€‚</p>
<h3 id="æ­»é”æ¢å¤-è§£é™¤"><a href="#æ­»é”æ¢å¤-è§£é™¤" class="headerlink" title="æ­»é”æ¢å¤&#x2F;è§£é™¤"></a>æ­»é”æ¢å¤&#x2F;è§£é™¤</h3><p>å½“æ£€æµ‹ç®—æ³•ç¡®å®šå½“å‰ç³»ç»ŸçŠ¶æ€å­˜åœ¨æ­»é”ï¼Œäºæ˜¯éœ€è¦é‡‡å–ä¸€å®šæªæ–½æ¥è§£é™¤æ­»é”ã€‚</p>
<ul>
<li>ä¸­æ­¢éƒ¨åˆ†&#x2F;å…¨éƒ¨æ­»é”è¿›ç¨‹ï¼šå¯ä»¥ä¸€æ¬¡æ€§ä¸­æ­¢æ‰€æœ‰è¿›ç¨‹ï¼Œåˆæˆ–è€…ä¸€æ¬¡ä¸­æ­¢ä¸€ä¸ªè¿›ç¨‹ï¼Œç›´åˆ°æ¶ˆé™¤æ­»é”å¾ªç¯ã€‚</li>
<li>èµ„æºæŠ¢å ï¼šæŒ‚èµ·æ­»é”è¿›ç¨‹ï¼Œå¹¶æŠ¢å å…¶æ‰€æœ‰èµ„æºç»™å…¶ä»–è¿›ç¨‹ä½¿ç”¨ï¼Œä¸”è¢«å¼ºå èµ„æºçš„è¿›ç¨‹éœ€è¦å›æ»šï¼ŒåŒæ—¶è¦ç¡®ä¿è¿›ç¨‹ä¸èƒ½å‘ç”Ÿé¥¥é¥¿æƒ…å†µã€‚</li>
<li>è¿›ç¨‹å›é€€ï¼šè®©ä¸€ä¸ª&#x2F;å¤šä¸ªè¿›ç¨‹å›é€€åˆ°æŸä¸ªçŠ¶æ€ï¼Œä½¿å¾—ç³»ç»ŸçŠ¶æ€åˆ°è¾¾æ²¡æœ‰æ­»é”çš„çŠ¶æ€ã€‚éœ€è¦ä¿å­˜å†å²ä¿¡æ¯ï¼Œå¹¶è®¾ç½®è¿˜åŸç‚¹ã€‚</li>
</ul>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>os</tag>
      </tags>
  </entry>
  <entry>
    <title>True IOMMU Protection from DMA Attacksï¼šWhen Copy is Faster than Zero Copy</title>
    <url>/2022/04/19/paper_reading/DMA/ASPLOS%20%E2%80%9916True%20IOMMU%20Protection%20from%20DMA%20Attacks%20When%20Copy%20is%20Faster%20than%20Zero%20Copy/</url>
    <content><![CDATA[<p>some paper of DMA:</p>
<p>ISCAâ€™10 IOMMU: Strategies for Mitigating the IOTLB Bottleneck</p>
<p>ATCâ€™11 vIOMMU: Efficient IOMMU Emulation</p>
<p>ATCâ€™15 Utilizing the IOMMU Scalably</p>
<p>ASPLOSâ€™15 rIOMMU: Efficient IOMMU for I&#x2F;O Devices that Employ Ring Buffers</p>
<p>ASPLOSâ€™16 True IOMMU Protection from DMA Attacks: When Copy is Faster than Zero Copy</p>
<p>ASPLOSâ€™18 DAMN: Overhead-free IOMMU Protection for Networking</p>
<p>ATCâ€™20 coIOMMU: A Virtual IOMMU with Cooperative DMA Buffer Tracking for Efficient Memory Management in Direct I&#x2F;O</p>
<p>Securityâ€™21 Static Detection of Unsafe DMA Accesses in Device Drivers</p>
<p>EuroSysâ€™21 Characterizing, exploiting, and detecting DMA code injection vulnerabilities in the presence of an IOMMU</p>
<p><a href="https://zhuanlan.zhihu.com/p/20393380">https://zhuanlan.zhihu.com/p/20393380</a></p>
<p><a href="https://zhuanlan.zhihu.com/p/20383904">https://zhuanlan.zhihu.com/p/20383904</a></p>
<p><a href="https://hardenedlinux.github.io/system-security/2020/01/18/peripheral-based_attack_memory.html">https://hardenedlinux.github.io/system-security/2020/01/18/peripheral-based_attack_memory.html</a></p>
<h1 id="ASPLOS-â€™16-True-IOMMU-Protection-from-DMA-Attacks-When-Copy-is-Faster-than-Zero-Copy"><a href="#ASPLOS-â€™16-True-IOMMU-Protection-from-DMA-Attacks-When-Copy-is-Faster-than-Zero-Copy" class="headerlink" title="ASPLOS â€™16:True IOMMU Protection from DMA Attacks: When Copy is Faster than Zero Copy"></a>ASPLOS â€™16:True IOMMU Protection from DMA Attacks: When Copy is Faster than Zero Copy</h1><h2 id="problems"><a href="#problems" class="headerlink" title="problems:"></a>problems:</h2><ul>
<li>(1) it provides protection at page granularity only, whereas DMA buffers can reside on the same page as other data: maps other data in an iommu-mapped page.</li>
<li>(2) it delays DMA buffer unmaps due to performance considerations, creating a vulnerability window in which devices can access in-use memory: because of IOTLB, unmapping is expensive. For the sake of performance, OSes implement deferred protection.</li>
</ul>
<h2 id="contribution"><a href="#contribution" class="headerlink" title="contribution:"></a>contribution:</h2><ul>
<li>(1) observing that copying DMA buffers is preferable to IOTLB invalidation; </li>
<li>(2) providing a truly secure, fast, and scalable intra-OS protection scheme with strict sub-page safety; </li>
<li>(3) implementing the new scheme in Linux and evaluating it with networking workloads at 40 Gb&#x2F;s.</li>
</ul>
<h2 id="Assumptions"><a href="#Assumptions" class="headerlink" title="Assumptions:"></a>Assumptions:</h2><p>1.protecting the OS from unauthorized DMAs to targets not mapped with the DMA API;</p>
<p>2.IOMMU trustworthyï¼Œsecure boot-stage.</p>
<p>3.only focus on no-mapping DMA accesses.</p>
<h2 id="Attacker-Model"><a href="#Attacker-Model" class="headerlink" title="Attacker Model:"></a>Attacker Model:</h2><p>The attacker controls a set of DMA-capable hardware devices but cannot otherwise access the OS.<br>However, shadow copy design can support untrusted drivers.</p>
<h2 id="Intra-OS-Protection-via-DMA-Shadowing-Key-design"><a href="#Intra-OS-Protection-via-DMA-Shadowing-Key-design" class="headerlink" title="Intra-OS Protection via DMA Shadowing(Key design)"></a>Intra-OS Protection via DMA Shadowing(Key design)</h2><p>The basic idea is simple: we restrict a deviceâ€™s DMAs to a set of shadow DMA buffers that are permanently mapped in the IOMMU, and copy data to (or from) these buffers from (or to) the OS-allocated DMA buffers.</p>
<h2 id="Goals"><a href="#Goals" class="headerlink" title="Goals"></a>Goals</h2><p>1.Transparency: without modifying DMA API, it can intergrate into any OSes. describe in $5.2, extend in $5.4.</p>
<p>2.Scalability: to reduce overhead, it must minimize synchronization. (locks that are for multiple cores is global)describe in $5.3</p>
<p>3.Generality:support all workloads, including huge DMA buffers. describe in $5.5</p>
<h2 id="5-2-DMA-Shadowing-Implementation-of-the-DMA-API"><a href="#5-2-DMA-Shadowing-Implementation-of-the-DMA-API" class="headerlink" title="$5.2 DMA Shadowing Implementation of the DMA API"></a>$5.2 DMA Shadowing Implementation of the DMA API</h2><h3 id="primitive-DMA-API"><a href="#primitive-DMA-API" class="headerlink" title="primitive DMA API:"></a>primitive DMA API:</h3><ul>
<li>dma_map: <ul>
<li>input: buf addr, size, device rights.</li>
<li>functionality:alloc a IOVA region from deviceâ€™s IOVA space. create IOMMU page table.</li>
<li>return value: starting of IOVA region.</li>
<li>misc: after do this, devices can access this region while OS&#x2F;driver cannot.</li>
</ul>
</li>
<li>dma_unmap:<ul>
<li>input:IOVA</li>
<li>functonality: remove the mapping in IOMMU, delete the deviceâ€™s IOMMU page table.</li>
<li>return value: </li>
<li>misc: after do this, devices cannot access this region while OS&#x2F;driver can again.</li>
</ul>
</li>
<li>dma_alloc_coherent of shared buffer:<ul>
<li>input:</li>
<li>functonality:</li>
<li>return value: </li>
<li>misc: alloc a region that drivers and devices can access it simultaneously. In page grained. use dma free coherent to free.</li>
</ul>
</li>
</ul>
<h3 id="shadowing-Implementation-DMA-API"><a href="#shadowing-Implementation-DMA-API" class="headerlink" title="shadowing Implementation DMA API:"></a>shadowing Implementation DMA API:</h3><ul>
<li>dma_map: acquires a shadow buffer of the appropriate size<br>and access rights from the pool, then associated it with mapped OS buffer. return shadow bufferâ€™s IOVA.</li>
<li>dma_unmap: finds the shadow buffer associated with the OS<br>buffer. copy the contents of shadow buffer into OS buffer, then releases the shadow buffer and return.</li>
<li>dma_alloc_coherent and dma_free_coherent: infrequent operations, implement equally with the primitive DMA API.</li>
</ul>
<h3 id="security"><a href="#security" class="headerlink" title="security:"></a>security:</h3><p>although the devices could always access all the shadow buffers, the OS only read value from OS buffer on the time of invoking dma_map and write at dma_unmap time.</p>
<h2 id="5-3-Shadow-Buffer-Pool"><a href="#5-3-Shadow-Buffer-Pool" class="headerlink" title="$5.3 Shadow Buffer Pool"></a>$5.3 Shadow Buffer Pool</h2><ul>
<li>Each device is associated with a unique shadow buffer pool.</li>
<li>API of shadow buffer pool:<ul>
<li>iova t acquire_shadow(buf, size, rights): Acquires a shadow buffer and associates it with the OS buffer buf.</li>
<li>void* find_shadow(iova):Looks up the shadow buffer whose IOVA is iova and returns the OS buffer associated with it.</li>
<li>void release_shadow(shbuf):Releases the shadow buffer shbuf back to the pool, disassociating it from its OS buffer.</li>
</ul>
</li>
</ul>
<h3 id="pool-design"><a href="#pool-design" class="headerlink" title="pool design"></a>pool design</h3><p>A pool maintains a unique set of free lists. Each list holds free shadow buffers of a particular size and device access rights. </p>
<p>each size &#x3D; 3 lisss: read, write, both. </p>
<p>each core &#x3D; own free lists -&gt; concurrent operations,</p>
<p>inter-numa-node access -&gt; quickly access</p>
<p>free page to the list where it was allocated -&gt; never change its rights of mapping -&gt; no flush IOTLB</p>
<h3 id="shadow-buffer-metadata"><a href="#shadow-buffer-metadata" class="headerlink" title="shadow buffer metadata:"></a>shadow buffer metadata:</h3><p>each numa domain &#x3D; a array of Shadow buffer metadata structures for each size class.</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/![]().png"></p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>DMA</tag>
      </tags>
  </entry>
  <entry>
    <title>SEIMIï¼šEfficient and Secure SMAP-Enabled Intra-process Memory Isolation</title>
    <url>/2021/09/08/paper_reading/memory%20security/SEIMI/</url>
    <content><![CDATA[<h1 id="æ ‡é¢˜å’Œæ¥æº"><a href="#æ ‡é¢˜å’Œæ¥æº" class="headerlink" title="æ ‡é¢˜å’Œæ¥æº"></a>æ ‡é¢˜å’Œæ¥æº</h1><p><a href="https://www-users.cse.umn.edu/~kjlu/papers/seimi.pdf">2020S&amp;P:SEIMI: Efficient and Secure SMAP-Enabled Intra-process Memory Isolation</a></p>
<h1 id="contribute"><a href="#contribute" class="headerlink" title="contribute"></a>contribute</h1><ul>
<li>æä¾›äº†ä¸€ç§æ–°å¥‡çš„domain-basedçš„éš”ç¦»æœºåˆ¶ï¼šåˆ©ç”¨SMAPçš„æœºåˆ¶æå‡ºäº†ä¸€ç§æœ‰æ•ˆé˜²å¾¡å†…å­˜è…è´¥æ”»å‡»ã€‚</li>
<li>ä¸€ç§éš”ç¦»user ä»£ç çš„æ–°æ–¹æ³•ï¼šå®šä¹‰äº†ä¸€ç§æ–°çš„å®‰å…¨å¨èƒï¼Œåœ¨ringè¿è¡Œä¸ä¿¡ä»»çš„user codeï¼Œç„¶åæå‡ºäº†å¯¹äºè¿™ç§å¨èƒçš„éš”ç¦»æ–¹æ³•ã€‚è¡¨æ˜äº†è¿è¡Œuser codeåœ¨privileged mode æ˜¯å¯è¡Œçš„ã€‚</li>
<li>New insights from implementation and evaluationï¼šï¼ˆemmmmï¼Œè¿™ä¹Ÿç®—è´¡çŒ®å—ï¼Œè®²é“ç†ï¼Œä½†æ˜¯æ¯•ç«Ÿä¸­ç§‘é™¢çš„è®ºæ–‡ï¼Œè¯´æ˜¯è´¡çŒ®å°±æ˜¯å§ï¼Œæ¯•ç«Ÿå’±èœï¼‰</li>
</ul>
<h1 id="background"><a href="#background" class="headerlink" title="background"></a>background</h1><ul>
<li>Aï¼šInformation Hidingï¼ˆIHï¼‰techniqueï¼šå³åˆ©ç”¨éšæœºåŒ–çš„æ–¹å¼å°†å†…å­˜æ”¾åœ¨ä¸€ä¸ªéšæœºä½ç½®ã€‚</li>
<li>Bï¼šIntra-process Memory Isolationï¼šè¿›ç¨‹å†…éƒ¨çš„å†…å­˜éš”ç¦»æ¯”IHçš„æ–¹æ³•æ›´å®‰å…¨ä¸€ç‚¹ã€‚è¿™é‡ŒæŒ‡æŠŠsensitive dataä¿æŠ¤èµ·æ¥ã€‚å…¶ä¸­sensitive dataåˆ†ä¸ºä¸‰ç±»ï¼š1ï¼‰Confidentiality only. 2ï¼‰Integrity only 3ï¼‰Both confidentiality and integrityã€‚åŒæ—¶ç°æœ‰çš„memory-isolationæœºåˆ¶åˆ†ä¸ºä¸¤ç±»ï¼šä¸€ç±»æ˜¯address-basedï¼Œä¸€ç±»æ˜¯domain-basedã€‚å‰è€…åˆ©ç”¨è¾¹ç•Œæ£€æŸ¥ç­‰æ–¹å¼è¿›è¡Œéš”ç¦»ï¼ˆMPXï¼‰ï¼Œåè€…åˆ©ç”¨RWæƒé™æ¥è¿›è¡Œéš”ç¦»ï¼ˆMPKï¼‰ã€‚</li>
</ul>
<p>PSï¼šå‰é¢é‚£ä¸‰ç±»sensitive dataï¼Œç¬¬ä¸€ç±»å’Œç¬¬ä¸‰ç±»è²Œä¼¼æœ‰ç‚¹éš¾ä»¥åŒºåˆ†ï¼Œç¬¬äºŒç±»æŒ‡çš„æ˜¯å’Œå®Œæ•´æ€§ç›¸å…³ä½†æ˜¯ä¸ç”¨åŠ å¯†çš„ï¼Œæ¯”å¦‚è¿”å›åœ°å€å•Šï¼ŒPIDè¿™ç±»çš„æ•°æ®ï¼Œç¬¬ä¸€ç±»å’Œç¬¬ä¸‰ç±»æ¯”å¦‚ç§˜é’¥å•Šï¼Œéšæœºæ•°å•Šè¿™äº›çš„ä¸œè¥¿ã€‚</p>
<ul>
<li>Cï¼šIntel VTæŠ€æœ¯</li>
<li>SMAPå’ŒsmepæŠ€æœ¯ï¼šé˜²æ­¢kernelè¿è¡Œuserspaceçš„codeï¼ˆsmepï¼‰ï¼Œé˜²æ­¢kernelè·å–userspaceçš„æ•°æ®ï¼ˆsmapï¼‰ï¼Œç±»ä¼¼çš„æœ‰ARMä¸­çš„PANå’ŒRISC-Vä¸­çš„SUMã€‚åŒæ—¶RFLAGSå¯„å­˜å™¨çš„ACï¼ˆaccess controlï¼‰flagç”¨äºæ§åˆ¶æ˜¯å¦å…è®¸Supervisor-modeè®¿é—®User-pageã€‚</li>
</ul>
<h1 id="Threat-model"><a href="#Threat-model" class="headerlink" title="Threat model"></a>Threat model</h1><ul>
<li>seimiçš„ç›®çš„æ˜¯ä¸ºäº†æä¾›è¿›ç¨‹å†…éƒ¨çš„éš”ç¦»ï¼Œå³æä¾›ä¸€å—å®‰å…¨çš„å†…å­˜åŒºåŸŸï¼Œé˜²å¾¡è¢«å†…å­˜è…è´¥æ”»å‡»ã€‚å¹¶ä¸”å‡è®¾ç›®æ ‡ç¨‹åºå¯èƒ½å…·æœ‰èƒ½å¤Ÿè¢«æ”»å‡»çš„æ¼æ´ï¼Œä½¿å¾—æ”»å‡»è€…è·å¾—äºŒè¿›åˆ¶è¯»å†™èƒ½åŠ›ã€‚ä½†æ˜¯seimiè®¤ä¸ºç¨‹åºç¼–å†™è€…ä¸æ˜¯æ¶æ„çš„ï¼Œå³æ¶æ„è½¯ä»¶ä¸ç®—åœ¨ä¿æŠ¤çš„èŒƒç•´ã€‚</li>
<li>åŒæ—¶å‡è®¾å†…å­˜è…è´¥é˜²å¾¡æ˜¯å®‰å…¨çš„ï¼Œä¹Ÿå°±æ˜¯è¯´æ‰“ç ´seimiçš„å†…å­˜éš”ç¦»æ˜¯æŸåå†…å­˜é˜²å¾¡çš„å‰ææ¡ä»¶ã€‚</li>
<li>å½“seimiæœ‰æ•ˆçš„æ—¶å€™ï¼Œæ”»å‡»è€…ä¸èƒ½æ‰§è¡Œcodeæ³¨å…¥æ”»å‡»å’Œcode-reuseæ”»å‡»ï¼Œå³ä¸èƒ½æ¶æ„åœ°ä¿®æ”¹SMAP flagã€‚</li>
<li>åŒæ—¶è®¤ä¸ºOSæ˜¯ä¿¡ä»»çš„å¹¶ä¸”å®‰å…¨çš„ã€‚</li>
</ul>
<h1 id="Design"><a href="#Design" class="headerlink" title="Design"></a>Design</h1><h2 id="high-level"><a href="#high-level" class="headerlink" title="high-level"></a>high-level</h2><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210902153800618.png" alt="image-20210902153800618"></p>
<p>éš”ç¦»çš„domainè¢«è®¤ä¸ºæ˜¯user-pageï¼Œå…¶ä½™çš„å†…å­˜éƒ½è¢«è®¾å®šä¸ºS-pageï¼Œå¦‚å›¾æ‰€ç¤ºã€‚å½“å—ä¿¡ä»»çš„codeè¦è®¿é—®isolate memoryæ—¶å€™ï¼Œæ‰§è¡ŒSTACå»disbale smapï¼Œå½“å®Œæˆè®¿é—®åæ‰§è¡ŒCLACå»enable sampã€‚å¹¶ä¸”smapæ˜¯çº¿ç¨‹å®‰å…¨çš„ï¼Œå³ä¸€ä¸ªçº¿ç¨‹æ‰€åœ¨çš„CPUæ ¸disableäº†smapï¼Œåˆ«çš„CPUæ ¸ä»ç„¶æ˜¯ä¸å…è®¸è®¿é—®çš„ï¼ˆè¿™æ˜¯ç”±äºsmapæ˜¯ç”±RFLAGSå¯„å­˜å™¨æ§åˆ¶çš„ï¼Œçº¿ç¨‹å®‰å…¨çš„ï¼‰ï¼Œå¹¶ä¸”STAC&#x2F;CLACæŒ‡ä»¤æ¯”switching MPKæ›´å¿«ã€‚	</p>
<p>åŒæ—¶ç”±äºåœ¨ring-0ï¼ˆS-modeï¼‰è¿è¡Œuntrustçš„ç¨‹åºå¯èƒ½ä¼šæ”»å‡»å†…æ ¸ï¼Œæ‰€ä»¥seimiæŠŠkernelæ”¾åœ¨ring -1è¿è¡Œï¼Œå³ç”¨VT-xæŠ€æœ¯å°†åº”ç”¨ç¨‹åºå’Œkernelåˆ†ç¦»ï¼Œå°†åº”ç”¨ç¨‹åºæ”¾åœ¨VMX non-root modeï¼ˆguestï¼‰ï¼Œkernelæ”¾åœ¨root modeï¼ˆhostï¼‰ã€‚</p>
<h2 id="challenge-and-approaches"><a href="#challenge-and-approaches" class="headerlink" title="challenge and approaches"></a>challenge and approaches</h2><ul>
<li>éœ€è¦åŒºåˆ†SMAPçš„Readå’Œwriteæƒé™ï¼šé€šè¿‡åˆ†é…ä¸¤ä¸ªè™šæ‹Ÿåœ°å€æŒ‡å‘åŒä¸€ä¸ªç‰©ç†åœ°å€æ¥åŒºåˆ†ï¼Œå…¶ä¸­ä¸€ä¸ªæ˜ å°„è®¾ç½®ä¸ºU-pageï¼Œå¯ä»¥ç”¨äºreadå’Œwriteï¼Œå¦ä¸€ä¸ªæ˜ å°„è®¾ç½®ä¸ºS-pageï¼Œå¹¶ä¸”åªå…è®¸è¯»ã€‚</li>
<li>é˜²æ­¢æ³„éœ²ä¸€äº›å…³é”®çš„ç‰¹æƒçº§æ•°æ®ç»“æ„æ¯”å¦‚IDTï¼ŒPGTableï¼ŒSDTç­‰ï¼šæŠŠç‰¹æƒæ•°æ®ç»“æ„ä»¥åŠä»–ä»¬çš„æ“ä½œæ”¾åœ¨äº†VMX root modeä¸‹ã€‚é€šå¸¸å½“å†…æ ¸è®¿é—®è¿™äº›æ•°æ®ç»“æ„çš„æ—¶å€™éƒ½æ˜¯é€šè¿‡ç³»ç»Ÿè°ƒç”¨ï¼Œä¸­æ–­å’Œå¼‚å¸¸æ¥æ“ä½œçš„ï¼Œæ‰€ä»¥åˆ©ç”¨VT-xæŠ€æœ¯å»æ‹¦æˆªè¿™äº›æ“ä½œï¼Œå¯¼è‡´VMExitã€‚</li>
<li>å¯èƒ½ä¼šåœ¨ç‰¹æƒçº§ä¸‹æ»¥ç”¨ç¡¬ä»¶çš„ç‰¹æ€§ï¼Œæ¯”å¦‚ä½¿ç”¨mov æŒ‡ä»¤ä¿®æ”¹pagetableçš„WPbitæ¥ä¿®æ”¹æƒé™ç­‰ï¼š1ï¼‰è§¦å‘VMexitï¼Œå¹¶æš‚åœæ‰§è¡Œã€‚2ï¼‰ä½¿è¿è¡Œç»“æœå¤±æ•ˆã€‚3ï¼‰å¼•å‘å¤„ç†å™¨å¼‚å¸¸å¹¶ç¦ç”¨æ‰§è¡Œã€‚</li>
</ul>
<h1 id="architecture"><a href="#architecture" class="headerlink" title="architecture"></a>architecture</h1><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210908115842290.png" alt="image-20210908115842290"></p>
<p>å¦‚ä¸Šå›¾ç¤ºSEIMIçš„æ•´ä½“æ¶æ„ï¼Œå®ƒå°†kernelæ”¾åœ¨VMX root mode ä¸‹ï¼Œè¿›ç¨‹è¿è¡Œåœ¨vmx non-rootæ¨¡å¼ä¸‹çš„ring0å’Œring3ï¼Œå…¶ä¸­ring3éƒ¨åˆ†ç”¨ä»¥isolationï¼Œåˆ«çš„processè¿è¡Œåœ¨vmx root æ¨¡å¼ä¸‹çš„ring3.</p>
<p>SEIMIåŒ…å«äº†ä¸‰ä¸ªç»„ä»¶ï¼ŒåŒ…æ‹¬</p>
<ul>
<li>å†…å­˜ç®¡ç†ï¼šç”¨ä»¥ç›®æ ‡processçš„ç®¡ç†å’Œé…ç½®regular&#x2F;isolated çš„å†…å­˜åŒºåŸŸ</li>
<li>ç‰¹æƒçº§æŒ‡ä»¤çš„é¢„é˜²ï¼šé¢„é˜²ç‰¹æƒæŒ‡ä»¤è¢«æ”»å‡»è€…æ»¥ç”¨</li>
<li>eventçš„é‡å®šå‘ã€‚ï¼šé…ç½®å’Œæˆªæ–­vmexitï¼Œå½“åº”ç”¨ä½¿ç”¨syscallï¼Œä¸­æ–­å’Œå¼‚å¸¸æ—¶å€™ï¼Œè§¦å‘vmexitã€‚</li>
</ul>
<h2 id="å†…å­˜ç®¡ç†"><a href="#å†…å­˜ç®¡ç†" class="headerlink" title="å†…å­˜ç®¡ç†"></a>å†…å­˜ç®¡ç†</h2><p>å› ä¸ºnon-root modeæ²¡æœ‰ kernelï¼Œæ‰€ä»¥page tableè¦åœ¨hostçš„kernelä¸­è¿›è¡Œç®¡ç†ï¼Œç„¶åå°†hostçš„pagetable æ‹·è´åˆ°guestä½œä¸ºguestçš„pagetableï¼Œå¹¶ä¸”ä¿®æ”¹ç›¸åº”çš„S-pageå’ŒU-pageå³å¯ã€‚å¹¶ä¸”è¿™æ ·å¸¦æ¥ä¸€ä¸ªå¥½å¤„æ˜¯guestå¹¶ä¸èƒ½è·å–page tableï¼Œå› ä¸ºé‚£æ˜¯host kernel memory åˆ†é…çš„ï¼Œguestä¸èƒ½è®¿é—®åˆ°hostã€‚åŒæ—¶ä¸ºäº†å‡è½»å¼€é”€ï¼Œå¤åˆ¶å…¨éƒ¨çš„page tableæ¯”è¾ƒè€—æ—¶ï¼Œæ‰€ä»¥åªå¤åˆ¶ç¬¬ä¸€å±‚çš„page tableã€‚ç”±æ­¤æå‡ºäº†ä¸€ä¸ªshadow mechanismã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210908124656272.png" alt="image-20210908124656272"></p>
<h3 id="A-shadow-mechanism-for-only-page-table-root"><a href="#A-shadow-mechanism-for-only-page-table-root" class="headerlink" title="A shadow mechanism for (only) page-table root."></a>A shadow mechanism for (only) page-table root.</h3><p>å¦‚å›¾aæ‰€ç¤ºï¼Œå°†hostçš„PML4çš„å‰é¢256ä¸ªentryè®¾ä¸ºu-pageï¼Œåé¢256è®¾ä¸ºS-pageã€‚ç„¶åæŠŠè¿™ä¸€é¡µcopyç»™processï¼ˆå›¾ç‰‡ä¸­ç§°ä¸ºPML4â€™ pageï¼‰ï¼Œå®ƒå°†åé¢256ä¸ªkernelçš„entryæ¸…é™¤ï¼ˆå› ä¸ºguestä¸èƒ½è®¿é—®kernelçš„é¡µï¼‰ï¼Œå…¶ä½™çš„256ä¸ªuserçš„pageæ˜¯ä¸€æ ·çš„ã€‚</p>
<h3 id="Configuring-the-U-page-and-S-page"><a href="#Configuring-the-U-page-and-S-page" class="headerlink" title="Configuring the U-page and S-page."></a>Configuring the U-page and S-page.</h3><p>åœ¨page tableä¸­ï¼Œå¦‚æœæ‰€æœ‰çº§åˆ«çš„é¡µè¡¨çš„U&#x2F;S bitéƒ½æ˜¯1ï¼Œåˆ™å®ƒå°†æ˜¯u-pageï¼Œå¦åˆ™ä»»ä½•ä¸€ä¸ªçº§åˆ«çš„æ˜¯0ï¼Œåˆ™å®ƒæ˜¯S-pageã€‚è€Œåœ¨guestä¸­ï¼Œ0-254entryè¢«è®¾ç½®æˆS-pageï¼Œ255è®¾ç½®æˆU-pageã€‚ä»è€Œå½¢æˆäºŒè€…çš„éš”ç¦»ã€‚</p>
<h3 id="Supporting-the-read-only-isolated-S-page-region"><a href="#Supporting-the-read-only-isolated-S-page-region" class="headerlink" title="Supporting the read-only isolated S-page region."></a>Supporting the read-only isolated S-page region.</h3><p>SEIMIå°†#254 entryè®¾ç½®æˆR&#x2F;Wä¸º0ï¼Œè€Œ#255 entryè®¾ç½®æˆR&#x2F;Wä¸º1ï¼Œä»è€Œåœ¨user modeä¸‹æ˜¯å¯è¯»å¯å†™ï¼Œ supervisor modeä¸‹åªèƒ½è¯»ã€‚</p>
<h2 id="ç‰¹æƒçº§æŒ‡ä»¤çš„é¢„é˜²ï¼ˆè¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šä¸”ç»†èŠ‚ï¼Œè¯¦ç»†å†…å®¹çœ‹paperï¼Œè®²å¾ˆæ¸…æ¥šï¼‰"><a href="#ç‰¹æƒçº§æŒ‡ä»¤çš„é¢„é˜²ï¼ˆè¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šä¸”ç»†èŠ‚ï¼Œè¯¦ç»†å†…å®¹çœ‹paperï¼Œè®²å¾ˆæ¸…æ¥šï¼‰" class="headerlink" title="ç‰¹æƒçº§æŒ‡ä»¤çš„é¢„é˜²ï¼ˆè¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šä¸”ç»†èŠ‚ï¼Œè¯¦ç»†å†…å®¹çœ‹paperï¼Œè®²å¾ˆæ¸…æ¥šï¼‰"></a>ç‰¹æƒçº§æŒ‡ä»¤çš„é¢„é˜²ï¼ˆè¿™éƒ¨åˆ†å†…å®¹æ¯”è¾ƒå¤šä¸”ç»†èŠ‚ï¼Œè¯¦ç»†å†…å®¹çœ‹paperï¼Œè®²å¾ˆæ¸…æ¥šï¼‰</h2><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210908130214527.png" alt="image-20210908130214527"></p>
<p>ä¸Šè¡¨åˆ—å‡ºäº†æ‰€æœ‰é¢„é˜²çš„ç‰¹æƒæŒ‡ä»¤ï¼Œ</p>
<p>æ–‡ä¸­ç»†è®²äº†exp typeä¸­çš„éƒ¨åˆ†æŒ‡ä»¤ï¼š</p>
<p>#UD VMCSä¸­é…ç½®äº†è¿è¡Œè¿™äº›ä¼šè§¦å‘</p>
<p>#GP:å¦‚ä½•åˆ©ç”¨æ®µæè¿°ç¬¦å’Œsegment cacheæ¥é˜»æ­¢åˆ‡æ¢segmentç­‰ç­‰ã€‚</p>
<p>#PFï¼špage fault</p>
<p>INVï¼šä¸è®©è¿è¡Œ</p>
<h2 id="é‡å®šå‘event"><a href="#é‡å®šå‘event" class="headerlink" title="é‡å®šå‘event"></a>é‡å®šå‘event</h2><h3 id="system-call-handling"><a href="#system-call-handling" class="headerlink" title="system call handling"></a>system call handling</h3><p>ç”±äºsyscallæŒ‡ä»¤ä¸èƒ½å°†æ§åˆ¶æƒä»non-root modeåˆ‡æ¢æˆroot-modeï¼Œç”±æ­¤å¯ä»¥ç”¨vmcallä»£æ›¿syscallã€‚å…¶ä¸­åˆ©ç”¨è®¾ç½®IA32_LSTAR MSRå¯„å­˜å™¨ï¼Œå½“syscallå‘ç”Ÿæ—¶å€™ï¼Œæ§åˆ¶æµè½¬è€Œè¿è¡ŒvmcallæŒ‡ä»¤ï¼Œç„¶åä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ä¼šè¢«å­˜å‚¨åœ¨RCXå¯„å­˜å™¨ä¸­ï¼Œç„¶åseimié€šè¿‡åœ¨rootmodeä¸­é‡å®šå‘åˆ°ç›¸åº”çš„syscallï¼Œç„¶åå†é€šè¿‡vmresumeæŒ‡ä»¤è¿”å›ï¼Œå¹¶jmp %rcxè¿è¡Œã€‚</p>
<h3 id="Hardening-system-calls-against-confused-deputy"><a href="#Hardening-system-calls-against-confused-deputy" class="headerlink" title="Hardening system calls against confused deputy"></a>Hardening system calls against confused deputy</h3><p>ä¸€äº›ç³»ç»Ÿè°ƒç”¨æ¯”å¦‚readå’Œwriteä¼šä»¥åœ°å€å’Œcountä½œä¸ºå‚æ•°ï¼Œé€šè¿‡å¯¹è¿™äº›ç³»ç»Ÿè°ƒç”¨è¿›è¡Œæ ¡éªŒï¼Œé˜²æ­¢è®¿é—®åˆ°éš”ç¦»çš„åŒºåŸŸï¼ˆå³non-root modeä¸‹çš„ring0 æƒ³å»è®¿é—®ring3.ï¼‰</p>
<h3 id="Interrupts-and-exceptions-handling"><a href="#Interrupts-and-exceptions-handling" class="headerlink" title="Interrupts and exceptions handling"></a>Interrupts and exceptions handling</h3><p>æ‰€æœ‰çš„å¼‚å¸¸å’Œä¸­æ–­éƒ½ä¼šè§¦å‘vmexitï¼Œä»è€Œè¿›å…¥åˆ°seimiä¸­ï¼Œç„¶åseimiæ ¹æ®ä¸­æ–­å‘é‡è¡¨ï¼Œè¿›è¡Œæ£€æŸ¥åcall handlerã€‚</p>
<h3 id="Linux-signal-handling"><a href="#Linux-signal-handling" class="headerlink" title="Linux signal handling"></a>Linux signal handling</h3><p>å…·ä½“çœ‹paperã€‚</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>isolation</tag>
      </tags>
  </entry>
  <entry>
    <title>Practical Protection of Kernel Integrity for Commodity OS from Untrusted Extensions</title>
    <url>/2021/09/08/paper_reading/memory%20security/overall/</url>
    <content><![CDATA[<h1 id="challenge"><a href="#challenge" class="headerlink" title="challenge"></a>challenge</h1><ul>
<li><p>é’ˆå¯¹äºå•ä¸€æ–¹é¢çš„æ”»å‡»å’Œé˜²å¾¡èƒ½å¤Ÿéå¸¸æœ‰æ•ˆï¼Œæ¯”å¦‚é’ˆå¯¹äºcodeå®Œæ•´æ€§ï¼Œæ•°æ®å®Œæ•´æ€§å’Œæ§åˆ¶æµå®Œæ•´æ€§ã€‚ä½†æ˜¯æ²¡æœ‰é’ˆå¯¹äºå¤šæ–¹é¢çš„å…±åŒä¿æŠ¤ã€‚</p>
</li>
<li><p>å¦‚ä½•ä½¿å¾—ä¿æŠ¤å˜å¾—é€šç”¨å’Œå®ç”¨ã€‚æ¯”å¦‚ä¸€äº›æœ‰é—®é¢˜çš„driverä¸­ï¼ŒæŸäº›å‡½æ•°å¯èƒ½æ˜¯è‰¯æ€§çš„ï¼Œæœ‰äº›å‡½æ•°æ˜¯æ¶æ„çš„ã€‚å¾ˆå¤šæ–¹æ³•è™½ç„¶ä¿è¯äº†æ§åˆ¶æµå®Œæ•´æ€§ï¼Œä½†æ˜¯åŒæ—¶ä¹Ÿç¦æ­¢äº†è‰¯æ€§å‡½æ•°çš„è¿è¡Œã€‚éœ€è¦è¾¾åˆ°æ›´ç»†ç²’åº¦çš„ä¿æŠ¤ã€‚</p>
</li>
<li><p>ç°æœ‰å¯ä»¥ç”¨VMMåœ¨OSkernelä¸Šå†åŠ ä¸€å±‚çš„ä¿æŠ¤ï¼Œè¿™ç§æ–¹æ³•è™½ç„¶æœ‰æ•ˆï¼Œä½†æ˜¯åªèƒ½ä¿æŠ¤å¾ˆå°ä¸€éƒ¨åˆ†çš„objectï¼Œå¹¶ä¸”ä¼šæœ‰å¾ˆå¤§çš„å¼€é”€é—®é¢˜ã€‚</p>
</li>
</ul>
<h1 id="target"><a href="#target" class="headerlink" title="target"></a>target</h1><ul>
<li>kernel code&#x2F;dataä¸èƒ½è¢«ä¸å¯ä¿¡çš„extenstionä¿®æ”¹</li>
<li>å¯„å­˜å™¨ï¼ˆæ§åˆ¶å¯„å­˜å™¨ï¼Œæ ‡å¿—ä½å¯„å­˜å™¨ï¼‰ç­‰ç¡¬ä»¶ç»“æ„ç¯å¢ƒä¸èƒ½è¢«ä¸å¯ä¿¡çš„extenstionä¿®æ”¹</li>
<li>æ§åˆ¶æµä¸èƒ½è¢«ä¸å¯ä¿¡çš„extenstionä¿®æ”¹ï¼Œå‡½æ•°è°ƒç”¨ä¸€è‡´æ€§ï¼ˆcall-return consistencyï¼‰å¿…é¡»è¢«ä¸¥æ ¼éµå®ˆ</li>
<li>æ ˆå®Œæ•´æ€§ä¿è¯ï¼Œæ¶æ„ä»£ç ä¸èƒ½è¢«æ³¨å…¥kernelæ ˆï¼›ä¸å¯ä¿¡æ‰©å±•ä¸èƒ½é€šè¿‡è‡ªå·±æ ˆä¸Šçš„ç•ªè–¯æŒ‡é’ˆå’Œè¿”å›åœ°å€æ¨ç¿»æ§åˆ¶æµï¼›åœ¨æ ˆä¸Šå±äºkernelçš„non-control dataä¸èƒ½è¢«ä¸å¯ä¿¡æ‰©å±•è…è´¥ã€‚</li>
</ul>
<h2 id="HUKO"><a href="#HUKO" class="headerlink" title="HUKO"></a>HUKO</h2><ul>
<li>æä¾›äº†å››ç§çŠ¶æ€ï¼Œuser,oskernel,untrusted extensions,trusted extensions.</li>
<li>é’ˆå¯¹äºä¸åŒçš„çŠ¶æ€ç”¨ä¸ç”¨çš„HAPï¼ˆç¡¬ä»¶è¾…åŠ©é¡µè¡¨ï¼Œå³EPTç­‰ï¼‰æ¥æ ‡è¯†ä¸åŒæƒé™ï¼Œé’ˆå¯¹TLBåšä¼˜åŒ–</li>
<li>å¯¹äºkernelçš„ä¸åŒobjectï¼ˆtask_structç­‰å…³é”®æ•°æ®ï¼‰åšäº†labelï¼ˆå…·ä½“æ¥è¯´åº”è¯¥æ˜¯ç»™å«æœ‰objectçš„ç‰©ç†é¡µæ‰“äº†æ ‡ç­¾ï¼‰ï¼Œè¿™äº›æ ‡ç­¾ç”¨äº†é¡µè¡¨ä¸­reserveçš„bitï¼Œæœ€å¤šæ”¯æŒ32ç§ç±»å‹çš„æ ‡ç­¾ã€‚</li>
<li>å¹¶å®ç°äº†ä¸€ä¸ªtrusted driverï¼Œç”¨æ¥å…³æ³¨hypervisorçš„åˆ†é…å’Œå›æ”¶é¡µé¢ï¼Œå¹¶ä¸”å…³æ³¨guestå¯¹äºé¡µé¢çš„ä½¿ç”¨æƒ…å†µï¼Œè®²æƒ…å†µæŠ¥å‘Šç»™hypervisorã€‚</li>
<li>æŠŠæ‰€æœ‰kernel symbol tableä»¥åŠä¸€äº›ç®¡ç†å‘˜è®¤å®šçš„labelæˆtrustã€‚æ‰€æœ‰æ–°loadçš„éƒ½æ˜¯untrustã€‚ç®¡ç†å‘˜å¯ä»¥è®¤è¯å…¶ä¸ºtrustã€‚å¦‚æœuntruståšäº†ä¸€äº›è¿è§„æ“ä½œå°±æ˜¯æŠ¥é”™ã€‚æ‰€æœ‰untrustçš„è¡Œä¸ºä¼šè¢«è·Ÿè¸ªã€‚</li>
</ul>
<h2 id="å®ç°ç»†èŠ‚"><a href="#å®ç°ç»†èŠ‚" class="headerlink" title="å®ç°ç»†èŠ‚"></a>å®ç°ç»†èŠ‚</h2><ul>
<li>å¯¹äºä¸€äº›å¤§é¡µï¼Œå¯èƒ½æ··åˆäº†dataå’Œcodeï¼Œå°±æŠŠ2Mçš„pageç»†åˆ†æˆ512ä¸ª4KBçš„pageï¼Œå¯¹äº4KBpageæ‰“æ··åˆæ ‡ç­¾ï¼Œæ‰€æœ‰çš„è®¿é—®éƒ½ä¼šå¼•èµ·hypervisorçš„å…³æ³¨ã€‚</li>
<li>å®ç°äº†ä¸€ä¸ªlabeling helperçš„extensionï¼Œç”¨ä»¥å¸®åŠ©trace åŠ¨æ€çš„objectï¼ˆé™æ€çš„åƒkernel code è¿™äº›éƒ½åœ¨systemmapä¸ŠçŸ¥é“åœ°å€ï¼‰ï¼Œå‘ŠçŸ¥hypervisoråˆ†é…é¡µé¢çš„æ—¶å€™ä»€ä¹ˆé¡µé¢ä¸Šçš„objectæ˜¯ä»€ä¹ˆï¼ˆç”¨hypercallæ¥å£å‘ŠçŸ¥ï¼‰ã€‚</li>
</ul>
<h2 id="ä¸€äº›å¥‡æ€ªçš„ç‚¹"><a href="#ä¸€äº›å¥‡æ€ªçš„ç‚¹" class="headerlink" title="ä¸€äº›å¥‡æ€ªçš„ç‚¹"></a>ä¸€äº›å¥‡æ€ªçš„ç‚¹</h2><p>ä»–claimè‡ªå·±ä½overheadï¼Œå®é™…ä¸Šæ˜¯å’Œshadow page  table å’ŒEPTæ¯”è¾ƒï¼Œå½“ç„¶overheadä½å•Šã€‚</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>isolation</tag>
      </tags>
  </entry>
  <entry>
    <title>SoKï¼šEternal War in Memory</title>
    <url>/2021/08/26/paper_reading/memory%20security/SoK%EF%BC%9AEternal%20War%20in%20Memory/</url>
    <content><![CDATA[<h1 id="è®ºæ–‡æ¥æº"><a href="#è®ºæ–‡æ¥æº" class="headerlink" title="è®ºæ–‡æ¥æº"></a>è®ºæ–‡æ¥æº</h1><p><a href="https://nebelwelt.net/publications/files/13Oakland.pdf">IEEE Security&amp;Privacyâ€™13ï¼šSoK: Eternal War in Memory</a></p>
<h1 id="æ‘˜è¦"><a href="#æ‘˜è¦" class="headerlink" title="æ‘˜è¦"></a>æ‘˜è¦</h1><ul>
<li>æè¿°äº†ä¸€äº›å½“ä»Šç³»ç»Ÿçš„æ”»å‡»æ–¹å¼ï¼›</li>
<li>å¹¶ä»‹ç»äº†é˜²å¾¡çš„ä¸€äº›ç­–ç•¥ï¼›</li>
<li>åŒæ—¶åˆ†æäº†ä¸ºä»€ä¹ˆæ²¡æœ‰éƒ¨ç½²æ›´ä¸¥æ ¼çš„é˜²å¾¡ç­–ç•¥çš„åŸå› ï¼›</li>
<li>åœ¨ä¸åŒçš„ç­–ç•¥ä¹‹é—´è¿›è¡Œæ¯”è¾ƒï¼Œä¸ºäº†æ‰¾åˆ°å®‰å…¨å’Œæ•ˆç‡ä¹‹é—´çš„å¹³è¡¡ã€‚</li>
<li>æä¾›äº†ä¸€äº›å½“ä»Šçš„ç ”ç©¶é—®é¢˜ï¼Œå¹¶ç»™äº†ä¸€äº›å»ºè®®ã€‚</li>
</ul>
<h1 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h1><p>â€‹	å¦‚ä»Šçš„é˜²å¾¡æªæ–½æœ‰å‡ ä¸ªæ–¹é¢çš„åŸå› å¯¼è‡´ä¸èƒ½å¤§é¢ç§¯éƒ¨ç½²ï¼š</p>
<ul>
<li>performanceä¸å¤Ÿå¥½ï¼Œoverheadå¤ªå¤§ï¼›</li>
<li>æ–¹æ³•å’Œè¿‡å»çš„ä»£ç æˆ–è€…featureä¸å…¼å®¹ï¼›</li>
<li>æ–¹æ³•ä¸å¤Ÿå¥å£®ï¼Œæä¾›çš„ä¿æŠ¤ä¹Ÿä¸æ˜¯å¾ˆå®Œæ•´ï¼›</li>
<li>æœ‰äº›ä¿æŠ¤ä¾èµ–äºä¿®æ”¹å·¥å…·é“¾å’Œç¼–è¯‘å™¨ï¼Œä½†æ˜¯å¾ˆå¤šå·¥å…·é“¾ä¹Ÿå¹¶ä¸æ˜¯å¼€æºçš„ã€‚</li>
</ul>
<h2 id="contribution"><a href="#contribution" class="headerlink" title="contribution"></a>contribution</h2><ul>
<li>æ€»ç»“å†…å­˜æŸåæ”»å‡»çš„é€šç”¨æ¨¡å‹ï¼Œå¹¶æ ¹æ®æ¨¡å‹ç¡®å®šä¸åŒçš„å¯æ‰§è¡Œå®‰å…¨ç­–ç•¥;</li>
<li>é€šè¿‡å°†æ”»å‡»æ‰‹æ®µçš„æ‰§è¡Œé˜¶æ®µä¸åˆ©ç”¨é˜¶æ®µåšåŒ¹é…ï¼Œæ€»ç»“å“ªäº›æ”»å‡»ç›®å‰è¿˜æ²¡è¢«ä¿æŠ¤çš„ï¼Œæˆ–è€…è¿‡å»æå‡ºçš„æ–¹æ³•ä¸é€‚ç”¨çš„;</li>
<li>è¯„ä¼°å’Œæ¯”è¾ƒæå‡ºçš„æ–¹æ³•çš„performanceï¼Œå…¼å®¹æ€§å’Œé²æ£’æ€§ã€‚</li>
<li>è®¨è®ºäº†ä¸ºä»€ä¹ˆå¾ˆå¤šé˜²å¾¡æªæ–½æ²¡æœ‰è¢«å¤§èŒƒå›´æ¥å—ï¼Œç„¶åæ–°çš„æªæ–½çš„æ ‡å‡†æ˜¯ä»€ä¹ˆã€‚</li>
</ul>
<h1 id="attack"><a href="#attack" class="headerlink" title="attack"></a>attack</h1><p>ä¸€å¼ å„ä¸ªé˜¶æ®µçš„æ”»å‡»æ€»ç»“ï¼š</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210826141804129.png" alt="image-20210826141804129"></p>
<h2 id="ä¸€äº›è¯çš„è§£é‡Š"><a href="#ä¸€äº›è¯çš„è§£é‡Š" class="headerlink" title="ä¸€äº›è¯çš„è§£é‡Š"></a>ä¸€äº›è¯çš„è§£é‡Š</h2><p><code>dangling pointer</code>ï¼šç©ºæ‚¬æŒ‡é’ˆï¼ŒæŒ‡é’ˆæŒ‡å‘çš„å†…å­˜å·²ç»é‡Šæ”¾ã€‚</p>
<p><code>spatial error</code>ï¼šè®¿é—®è¶Šç•Œçš„æŒ‡é’ˆé”™è¯¯</p>
<p><code>temporal error</code>ï¼šè§£å¼•ç”¨ä¸€ä¸ªdanglingæŒ‡é’ˆå¼•èµ·çš„é”™è¯¯</p>
<p><code>Return Oriented Programming (ROP)</code>ï¼šè¿”å›ç°æœ‰ä»£ç çš„æ”»å‡»ï¼Œç»„åˆç°æœ‰ä»£ç å®Œæˆä¸€äº›æ“ä½œã€‚</p>
<p><code>Jump Oriented Programming (JOP)</code>ï¼šé¢å‘è·³è½¬ç¼–ç¨‹ï¼Œå³ç”¨ç›´æ¥è·³è½¬å®Œæˆç±»ä¼¼ROPçš„æ•ˆæœ</p>
<h2 id="å†…å­˜corruptionï¼ˆä¸‹é¢çš„åºå·å¯¹åº”å›¾ä¸­æœ€å·¦è¾¹åœ†å½¢çš„åºå·ï¼‰"><a href="#å†…å­˜corruptionï¼ˆä¸‹é¢çš„åºå·å¯¹åº”å›¾ä¸­æœ€å·¦è¾¹åœ†å½¢çš„åºå·ï¼‰" class="headerlink" title="å†…å­˜corruptionï¼ˆä¸‹é¢çš„åºå·å¯¹åº”å›¾ä¸­æœ€å·¦è¾¹åœ†å½¢çš„åºå·ï¼‰"></a>å†…å­˜corruptionï¼ˆä¸‹é¢çš„åºå·å¯¹åº”å›¾ä¸­æœ€å·¦è¾¹åœ†å½¢çš„åºå·ï¼‰</h2><h3 id="æŒ‡é’ˆ"><a href="#æŒ‡é’ˆ" class="headerlink" title="æŒ‡é’ˆ"></a>æŒ‡é’ˆ</h3><p>1.æŒ‡é’ˆé”™è¯¯ç±»å‹ï¼š</p>
<ul>
<li>é€šè¿‡æŒ‡é’ˆè¶Šç•Œæˆ–è€…è®¿é—®é‡Šæ”¾äº†çš„å†…å­˜æ¥ä½¿å¾—æŒ‡é’ˆå¤±æ•ˆï¼Œä¸»è¦æœ‰<code>buffer overflow/underflow</code>ã€‚</li>
<li>é€šè¿‡è¾¹ç•Œæ£€æŸ¥é”™è¯¯é€ æˆçš„è¶Šç•Œæˆ–è€…æ•´æ•°æº¢å‡ºï¼Œä¸»è¦æœ‰<code>integer overflow</code>ï¼Œæˆªæ–­ï¼Œç¬¦å·é”™è¯¯ï¼ŒæŒ‡é’ˆè½¬æ¢é”™è¯¯ã€‚</li>
<li>ä¹Ÿå¯èƒ½é€šè¿‡å†…å­˜è…è´¥ï¼Œä¿®æ”¹äº†æŒ‡é’ˆæ•°æ®è€Œé€ æˆæŒ‡é’ˆerrorã€‚</li>
</ul>
<p>2.è·å–è¿™æ ·çš„æŒ‡é’ˆï¼š</p>
<ul>
<li>é€šè¿‡ä¸æ­£ç¡®çš„å¼‚å¸¸å¤„ç†bugï¼Œæ¯”å¦‚æœ‰äº›ç¨‹åºé‡Šæ”¾äº†ä¸€ä¸ªå¯¹è±¡ä¹‹åæ²¡æœ‰æŠŠæŒ‡å‘è¯¥å¯¹è±¡çš„æŒ‡é’ˆåˆå§‹åŒ–ã€‚è¿™ç§è¢«å«åš<code>use-after-free</code>ã€‚å¯ä»¥åœ¨å †åˆ†é…å’Œé‡Šæ”¾çš„æ—¶å€™åšä¸€äº›æ‰‹è„šã€‚</li>
<li>ä¸€äº›å±€éƒ¨å˜é‡æŒ‡é’ˆè¢«å…¨å±€æŒ‡é’ˆèµ‹å€¼æ—¶å€™ä¹Ÿå¯èƒ½ä¼šå¯¼è‡´é—®é¢˜ï¼Œå› ä¸ºè¿™æ ·çš„æŒ‡é’ˆåœ¨å‡½æ•°è¿”å›æ—¶å€™é‡Šæ”¾äº†å±€éƒ¨çš„å˜é‡ï¼Œä½†æ˜¯å…¨å±€çš„éƒ¨åˆ†ç§°ä¸ºäº†æ‚¬æŒ‚æŒ‡é’ˆã€‚</li>
</ul>
<p>3.æœ‰äº†è¿™æ ·çš„æŒ‡é’ˆä¹‹åå¦‚ä½•åˆ©ç”¨ï¼š</p>
<p>â€‹	åˆ©ç”¨ä¹‹å‰è·å¾—çš„æŒ‡é’ˆè¿›è¡Œè¯»æˆ–è€…å†™çš„æ—¶å€™ï¼Œå°±å¯ä»¥æ³„éœ²ä¸€äº›å†…éƒ¨çš„æ•°æ®ã€‚</p>
<ul>
<li><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ¯”å¦‚å¦‚ä¸‹è¿™ç§æƒ…å†µï¼Œä¸‹ä¸€æ¬¡çš„æ§åˆ¶æµè·³è½¬æ˜¯è·³è½¬åˆ°æ‰§è¡Œè¡¨ä¸­çš„æŸä¸ªå‡½æ•°ï¼Œä½†æ˜¯å› ä¸ºindexæ˜¯ç”¨æˆ·æ§åˆ¶çš„ï¼Œå°±å¯èƒ½äº§ç”Ÿä»»æ„åœ°å€çš„è·³è½¬,</span></span><br><span class="line"><span class="comment">//æ”»å‡»è€…å¯ä»¥è®©jump_tableæŒ‡å‘æ”»å‡»è€…å¯ä»¥æ§åˆ¶çš„åœ°æ–¹</span></span><br><span class="line">func_ptr jump_table[<span class="number">3</span>] = &#123;fn_0, fn_1, fn_2&#125;;</span><br><span class="line">jump_table[user_input]();</span><br></pre></td></tr></table></figure>
</li>
<li><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//printf format string bug,åˆ©ç”¨ç±»ä¼¼çš„bugæ”»å‡»è€…å¯ä»¥è¯»ä»»æ„åœ°å€å†…å­˜</span></span><br><span class="line"><span class="built_in">printf</span>(user_input); <span class="comment">// input &quot;%3$x&quot; prints the</span></span><br><span class="line"><span class="comment">// 3rd integer on the stack</span></span><br></pre></td></tr></table></figure>
</li>
<li><p>å¦‚æœæ”»å‡»è€…æ§åˆ¶çš„æ˜¯å†™æŒ‡é’ˆï¼Œé‚£ä¹ˆä»»ä½•æŒ‡é’ˆéƒ½å¯èƒ½è¢«è¦†ç›–å†™ï¼Œç”šè‡³ä»»ä½•æ•°æ®éƒ½å¯èƒ½è¢«è¦†ç›–å†™ã€‚<br>æ¯”å¦‚<code>buffer overflow/underflow</code>å’Œä¸‹æ ‡é”™è¯¯ï¼Œå¯ä»¥å†™è¦†ç›–å†™æ•æ„Ÿé”™è¯¯çš„æ•°æ®æ¯”å¦‚è¿”å›åœ°å€æˆ–è€…è™šè¡¨æŒ‡é’ˆã€‚å…¶ä¸­é‡å†™è™šè¡¨æŒ‡é’ˆå°±é€ æˆäº†å›¾ä¸­3-&gt;1çš„åå‘å¾ªç¯ã€‚ç¬¬ä¸€è½®å¾ªç¯é€šè¿‡å‰è¿°æ–¹å¼ä¿®æ”¹è™šè¡¨æŒ‡é’ˆï¼Œç„¶åç¬¬äºŒè½®å¾ªç¯ç”±äºåˆ«çš„codeè§£å¼•ç”¨äº†è¿™ä¸ªè™šè¡¨æŒ‡é’ˆï¼Œä»è€Œé€ æˆæ§åˆ¶æµçš„åŠ«æŒã€‚ä»æ­¤å¾ªç¯åå¤ï¼Œè¶Šæ¥è¶Šå¤šçš„æŒ‡é’ˆå°±èƒ½è¢«åˆ©ç”¨ã€‚</p>
</li>
<li><p>æ”»å‡»è€…åˆ©ç”¨corruptingçš„æŒ‡é’ˆè°ƒç”¨free()ä¹Ÿèƒ½é€ æˆå†…å­˜ç ´åã€‚[jp, â€œAdvanced Doug Leaâ€™s malloc exploits,â€ Phrack, vol. 11, no. 61, Aug 2003.]</p>
</li>
<li><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">//æ‰“å°æ—¶å€™è§£å¼•ç”¨çš„æŒ‡é’ˆä¹Ÿä¼šé€ æˆä¿¡æ¯çš„æ³„éœ²ï¼Œæ§åˆ¶err_msgæŒ‡é’ˆçš„æŒ‡å‘å¯ä»¥è¿›è¡Œä»»æ„åœ°å€çš„è¯»</span></span><br><span class="line"><span class="built_in">printf</span>(<span class="string">&quot;%s\n&quot;</span>, err_msg);</span><br></pre></td></tr></table></figure>

<p>ä¸‹é¢æ˜¯é’ˆå¯¹temporal errorçš„åˆ©ç”¨</p>
</li>
<li><p>å½“è§£å¼•ç”¨æ‚¬æŒ‚æŒ‡é’ˆçš„æ—¶å€™ï¼ŒæŒ‡å‘çš„å†…å­˜å¯èƒ½è¢«å†…å­˜åˆ†é…å™¨æ¯”å¦‚å †åˆ†é…å™¨åˆ†é…ç»™äº†åˆ«çš„objectï¼Œå°±å¯ä»¥åˆ©ç”¨æ‚¬æŒ‚æŒ‡é’ˆå¯¹åˆ«çš„objectè¿›è¡Œæ§åˆ¶è¯»å†™ï¼Œç”šè‡³double-freeä¹Ÿèƒ½é€ æˆä»»æ„è¯»å†™ï¼Œå³æ–°çš„objectä¹Ÿè¢«é”™è¯¯åœ°é‡Šæ”¾äº†ã€‚</p>
</li>
</ul>
<h3 id="Code-corruption-æ”»å‡»"><a href="#Code-corruption-æ”»å‡»" class="headerlink" title="Code corruption æ”»å‡»"></a>Code corruption æ”»å‡»</h3><p>â€‹	åˆ©ç”¨ä¸Šè¿°bugå»é‡å†™ç¨‹åºåœ¨å†…å­˜ä¸­çš„codeï¼Œä½†æ˜¯æŠŠcodeè®¾ç½®æˆread-onlyã€‚</p>
<p>â€‹	ä½†æ˜¯ä»–ä¸æ”¯æŒâ€œç¨‹åºè‡ªå·±ä¿®æ”¹ä»£ç â€å’Œâ€œJust-In-Timeï¼ˆJITï¼‰å³æ—¶ç¼–è¯‘â€ã€‚å¦‚ä»Šå¤§éƒ¨åˆ†æµè§ˆå™¨ç”¨çš„éƒ½æ˜¯JITç”¨ä»¥è§£æFlashå’ŒJSè„šæœ¬ï¼Œè¿™ä¼šç»™ä»£ç éƒ¨åˆ†ä¸€ä¸ªå¯å†™çš„çª—å£æœŸã€‚</p>
<h3 id="æ§åˆ¶æµæŒŸæŒæ”»å‡»"><a href="#æ§åˆ¶æµæŒŸæŒæ”»å‡»" class="headerlink" title="æ§åˆ¶æµæŒŸæŒæ”»å‡»"></a>æ§åˆ¶æµæŒŸæŒæ”»å‡»</h3><p>4.é€šè¿‡å‰è¿°æŒ‡é’ˆçš„errorï¼Œå¯ä»¥ä¿®æ”¹return addressæ¥è·³è½¬åˆ°æ”»å‡»è€…å¯æ§çš„åœ°å€ç©ºé—´ã€‚è¿™å¯è¢«åœ°å€ç©ºé—´éšæœºåŒ–ç¼“è§£ï¼ˆä¸èƒ½æ ¹é™¤ï¼‰</p>
<p>5.é€šè¿‡ç›´æ¥callæˆ–è€…é—´æ¥è·³è½¬æˆ–è€…å‡½æ•°è¿”å›æŒ‡ä»¤retæ¥é€ æˆCFIï¼ˆControl-flow Integrityï¼‰çš„ç ´åã€‚</p>
<p>6.ç¬¬å…­æ­¥å°±æ˜¯è¿è¡Œæ¶æ„ä»£ç ï¼Œæ¯”å¦‚shellcodeã€‚è¿™æ ·å¯ä»¥è¢«æ•°æ®é¡µé¢ä¸å¯æ‰§è¡Œç¼“è§£ï¼Œå³WâŠ•X (Write XOR Execute) ç­–ç•¥ï¼Œå³é¡µé¢è¦ä¹ˆå¯å†™ï¼Œè¦ä¹ˆå¯æ‰§è¡Œï¼Œä½†æ˜¯ä¸èƒ½åŒæ—¶å¯å†™å¯æ‰§è¡Œã€‚åŒæ ·JITå’Œself-modifying codeçš„æƒ…å†µä¸é€‚ç”¨ã€‚äºæ˜¯æå‡ºäº†ï¼ˆInstruction Set Randomizationï¼‰ï¼Œå³åŠ å¯†ä»£ç ï¼Œä½†æ˜¯performanceå¤ªå·®äº†ï¼Œæ…¢æ…¢è¢«æ·˜æ±°ã€‚åŒæ—¶æ”»å‡»è€…ä¸ºäº†ç»•è¿‡æƒé™ï¼Œè®¾è®¡äº†é‡ç”¨ç°æœ‰ä»£ç ï¼Œå®ç°ROPæ”»å‡»æ¯”å¦‚return-to-libcæ”»å‡»æˆ–è€…é€šè¿‡gadgetså°ç»„ä»¶æ¥æ‰§è¡Œæ¶æ„æ“ä½œï¼Œè¿˜æœ‰JOPçš„æ”»å‡»ã€‚ç›®å‰è¿™ç§ç±»å‹åªèƒ½ç¼“è§£ï¼Œä¸èƒ½æ ¹é™¤ã€‚æ¯”å¦‚é¢å‘ç¼–è¯‘å™¨çš„ä¸€äº›ç¼“è§£æ–¹å¼ï¼ŒäºŒè¿›åˆ¶é‡å†™ä»¥åŠæ¶ˆé™¤å¤§å—ã€‚ï¼ˆä¸ªäººçŸ¥è¯†ï¼Œpaperé‡Œæ²¡å†™ï¼šç›®å‰Intelå’ŒARMå„è‡ªæœ‰ç¡¬ä»¶ä¸Šçš„ç¼“è§£æªæ–½ï¼Œæ¯”å¦‚CETï¼Œå½¢æˆç¬¬äºŒä¸ªshadow stackè®°å½•è·³è½¬åœ°å€ã€‚ï¼‰</p>
<h3 id="data-onlyæ”»å‡»"><a href="#data-onlyæ”»å‡»" class="headerlink" title="data-onlyæ”»å‡»"></a>data-onlyæ”»å‡»</h3><p>3.æ€»çš„æ¥è¯´æ”»å‡»è€…ç›®æ ‡å°±æ˜¯æ¶æ„ä¿®æ”¹ç¨‹åºé€»è¾‘ï¼Œè·å¾—æ›´å¤šçš„æ§åˆ¶æƒé™ï¼Œç”šè‡³ä¿®æ”¹ç‰¹æƒçº§ä»¥åŠæ³„éœ²ä¿¡æ¯ï¼Œè¿™ä¸ªç›®æ ‡å¯ä»¥é€šè¿‡ä¸ä¿®æ”¹æ˜¾å¼æ§åˆ¶æµç›¸å…³æ•°æ®æ¯”å¦‚è¿”å›åœ°å€ï¼Œè·³è½¬åœ°å€è¿™ç§æ¥å®Œæˆï¼Œå¯ä»¥é€šè¿‡ä¿®æ”¹å˜é‡æ¥æ”¹å˜ç¨‹åºæ‰§è¡Œé€»è¾‘ã€‚æ¯”å¦‚å¦‚ä¸‹ä»£ç ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">bool</span> isAdmin = <span class="literal">false</span>;</span><br><span class="line">...</span><br><span class="line"><span class="keyword">if</span> (isAdmin) <span class="comment">// do privileged operations</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥é€šè¿‡æ•°æ®ç©ºé—´éšæœºåŒ–ä»¥åŠå¢åŠ æ•°æ®ç†µçš„æ–¹å¼ç¼“è§£ã€‚</p>
<h3 id="ä¿¡æ¯æ³„éœ²"><a href="#ä¿¡æ¯æ³„éœ²" class="headerlink" title="ä¿¡æ¯æ³„éœ²"></a>ä¿¡æ¯æ³„éœ²</h3><p>ä»»ä½•å†…å­˜é”™è¯¯éƒ½å¯èƒ½é€ æˆä¿¡æ¯æ³„éœ²ï¼Œè€Œåˆ©ç”¨ä¿¡æ¯æ³„éœ²å¯ä»¥ç»•è¿‡ASLRï¼Œè§£å†³çš„åŠæ³•æ˜¯æ•°æ®ç©ºé—´éšæœºåŒ–ã€‚</p>
<h2 id="real-worldçš„ä¿æŠ¤å’Œåˆ©ç”¨"><a href="#real-worldçš„ä¿æŠ¤å’Œåˆ©ç”¨" class="headerlink" title="real-worldçš„ä¿æŠ¤å’Œåˆ©ç”¨"></a>real-worldçš„ä¿æŠ¤å’Œåˆ©ç”¨</h2><p>ç”¨çš„æœ€å¤šçš„æ˜¯stack smashing  protectionï¼ŒDEP&#x2F;WâŠ•X å’Œ ASLRã€‚windowsè¿˜ç”¨SafeSEH å’Œ SEHOPä¿æŠ¤å †å…ƒæ•°æ®å’Œå¼‚å¸¸å¤„ç†ï¼Œä½†æ˜¯è¿™æ ·çš„ä¿æŠ¤å¾ˆæœ‰é™ï¼Œä»…ä»…æ˜¯åœ¨è·³è½¬æ—¶å€™checkä¸€ä¸‹ï¼Œä¹Ÿä»…ä»…æ˜¯æ£€æŸ¥äº†è¿”å›åœ°å€å’Œå¼‚å¸¸å¤„ç†å‡½æ•°ç­‰æ–¹é¢ï¼Œæ²¡æœ‰è¦†ç›–åˆ°å…¨éƒ¨ï¼Œå¹¶ä¸”è¿™ç§å¯ä»¥è¢«ç»•è¿‡ï¼Œæ¯”å¦‚åˆ©ç”¨ç´¢å¼•æ¥æ”»å‡»ï¼Œè€Œä¸æ˜¯è¦†ç›–ã€‚</p>
<ul>
<li>stack smashing  protectionï¼šåœ¨æ ˆä¸Šè¿”å›åœ°å€å’Œbufferä¹‹é—´æ”¾ä¸€ä¸ªéšæœºå€¼ï¼ˆcookieæˆ–è€…canaryï¼‰ï¼Œç„¶ååœ¨è¿”å›ä¹‹å‰check</li>
<li>SafeSEH and SEHOPï¼šåœ¨ä½¿ç”¨å¼‚å¸¸å¤„ç†æŒ‡é’ˆæ—¶å€™å…ˆç”¨cookieéªŒè¯ä¸€ä¸‹ã€‚</li>
</ul>
<p>DEP&#x2F;WâŠ•Xå¯ä»¥ä¿æŠ¤codeæ³¨å…¥çš„æ”»å‡»ï¼Œä½†æ˜¯ä¸èƒ½ä¿æŠ¤ROPè¿™ç§code reuseæ”»å‡»ï¼Œè¿™ç§æ”»å‡»å¯ä»¥ç”¨ASLRç¨å¾®é˜²æŠ¤ä¸€ä¸‹ï¼Œä½†æ˜¯å¯ä»¥è¢«å»éšæœºåŒ–å’Œä¿¡æ¯æ³„éœ²ç­‰æ–¹å¼ç ´è§£ASLRã€‚</p>
<p>ç°åœ¨PDF viewers, åŠå…¬åº”ç”¨ï¼Œwebæµè§ˆå™¨ç­‰è¿è¡Œuserå¯æ§çš„è„šæœ¬ï¼Œå¯ä»¥ç”¨æ¥åŠ¨æ€æ„å»ºpayloadï¼Œå¹¶ä½¿ç›®æ ‡æœºå™¨è¿è¡Œã€‚</p>
<h1 id="æ–¹æ³•å’Œè¯„ä»·æ ‡å‡†"><a href="#æ–¹æ³•å’Œè¯„ä»·æ ‡å‡†" class="headerlink" title="æ–¹æ³•å’Œè¯„ä»·æ ‡å‡†"></a>æ–¹æ³•å’Œè¯„ä»·æ ‡å‡†</h1><ul>
<li><p>ä¸»è¦åˆ†ä¸ºä¸¤å¤§ç±»ï¼šæ¦‚ç‡æ€§ä¿æŠ¤ï¼ˆprobabilisticï¼‰å’Œç¡®å®šæ€§ä¿æŠ¤ï¼ˆdeterministicï¼‰</p>
<p>æ¦‚ç‡æ€§ä¸»è¦æ˜¯éšæœºåŒ–ï¼šInstruction Set Randomization, Address Space Randomization, or Data Space Randomization, build on randomization or encryption</p>
<p>å…¶ä»–çš„éƒ½æ˜¯ç¡®å®šæ€§çš„ä¿æŠ¤ã€‚</p>
</li>
</ul>
<h2 id="memory-safety"><a href="#memory-safety" class="headerlink" title="memory safety"></a>memory safety</h2><p>æŒ‡é’ˆè¾¹ç•Œæ£€æŸ¥ï¼š</p>
<ul>
<li>èƒ–æŒ‡é’ˆï¼šè¦ä¿®æ”¹æŒ‡é’ˆç»“æ„å’Œä»£ç ç»“æ„ï¼Œè®©ä¸€ä¸ªæŒ‡é’ˆç»“æ„ä½“è®°å½•é¢å¤–çš„ä¿¡æ¯</li>
<li>SoftBoundï¼šå°†å…ƒæ•°æ®å’ŒæŒ‡é’ˆåˆ†ç¦»å¼€æ¥ï¼Œç”¨ä¸€ä¸ªç†µæ¥è®°å½•ï¼Œæ•°æ®éƒ½å­˜åœ¨ä¸€ä¸ªç‰¹å®šçš„åŒºåŸŸï¼Œç±»ä¼¼å“ˆå¸Œçš„æ–¹å¼ï¼ˆè¿™é‡Œä¸ºäº†é˜²æ­¢åˆ«äººç ´è§£ç”¨çš„åŠ å¯†æ–¹å¼ï¼‰ï¼Œåœ¨æŒ‡é’ˆè§£å¼•ç”¨çš„æ—¶å€™å»ç‰¹å®šåŒºåŸŸå–æ•°æ®ã€‚</li>
</ul>
<p>åŸºäºå¯¹è±¡çš„æŒ‡é’ˆæ£€æŸ¥ï¼šç”±äºæˆ‘ä»¬ä¸çŸ¥é“æŒ‡é’ˆæ˜¯ä¸æ˜¯æŒ‡å‘æ­£ç¡®çš„å¯¹è±¡ï¼Œå°½ç®¡æœ‰è¾¹ç•Œæ£€æŸ¥ï¼Œå¯¹è±¡æŒ‡é”™äº†ä¹Ÿä¸è¡Œã€‚åŸºäºå¯¹è±¡çš„æŒ‡é’ˆå…³æ³¨äºæŒ‡é’ˆè¿ç®—ï¼Œè€Œéè§£å¼•ç”¨ã€‚ä½†æ˜¯è¿™æ ·çš„è¿‡ç¨‹åªå…³æ³¨äºå¯¹è±¡åˆ›å»ºå’Œé‡Šæ”¾çš„æ—¶å€™ï¼Œåœ¨å¯¹è±¡è¢«ä¿®æ”¹çš„æ—¶å€™æ˜¯æ³¨æ„ä¸åˆ°çš„ã€‚</p>
<h2 id="Temporal-safety"><a href="#Temporal-safety" class="headerlink" title="Temporal safety"></a>Temporal safety</h2><p>ç‰¹æ®Šçš„åˆ†é…å™¨ï¼šä¸å†ä½¿ç”¨ç›¸åŒçš„è™šæ‹Ÿåœ°å€ã€‚æˆ–è€…åœ°å€åªèƒ½è¢«ç›¸åŒç±»å‹çš„å¯¹è±¡ä½¿ç”¨ã€‚æˆ–è€…éšæœºåˆ†é…ä½ç½®çš„åˆ†é…å™¨</p>
<p>æ ¹æ®å¯¹è±¡çš„æ–¹æ³•ï¼š</p>
<p>æ ¹æ®æŒ‡é’ˆçš„æ–¹æ³•ï¼šä¸ä»…è¦ç»´æŠ¤è¾¹ç•Œï¼Œè¿˜è¦ç»´æŠ¤åˆ†é…ä¿¡æ¯ä¿è¯å®‰å…¨ã€‚</p>
<h1 id="åˆ«çš„èµ„æ–™"><a href="#åˆ«çš„èµ„æ–™" class="headerlink" title="åˆ«çš„èµ„æ–™"></a>åˆ«çš„èµ„æ–™</h1><p><a href="http://www.pl-enthusiast.net/2014/07/21/memory-safety/">What is memory safety</a></p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>security</tag>
      </tags>
  </entry>
  <entry>
    <title>SPP(Sub-page protection)</title>
    <url>/2021/08/17/paper_reading/spp/spp/</url>
    <content><![CDATA[<h1 id="SPP-Sub-page-protection"><a href="#SPP-Sub-page-protection" class="headerlink" title="SPP(Sub-page protection)"></a>SPP(Sub-page protection)</h1><h2 id="1-SPP-in-manualï¼ˆ28-2-4-ç¿»è¯‘ï¼‰"><a href="#1-SPP-in-manualï¼ˆ28-2-4-ç¿»è¯‘ï¼‰" class="headerlink" title="1. SPP in manualï¼ˆ28.2.4 ç¿»è¯‘ï¼‰"></a>1. SPP in manualï¼ˆ28.2.4 ç¿»è¯‘ï¼‰</h2><ul>
<li>åœ¨Intelä¸­ç”¨ <strong>Sub-Page Write Permissions</strong> æ¥å½¢å®¹<strong>SPP</strong>ã€‚ å®ƒå…è®¸äº†å¯¹äºGPAä¸Šæ›´ç»†ç²’åº¦çš„åˆ’åˆ†ï¼Œåˆ’åˆ†æˆ128å­—èŠ‚å¯¹é½çš„å­é¡µã€‚</li>
</ul>
<span id="more"></span>

<ul>
<li><p>ä¸€äº›ä¸é€‚ç”¨çš„æƒ…å†µï¼š</p>
<p>* </p>
</li>
<li><p>å…·ä½“è¿‡ç¨‹ï¼š</p>
<ul>
<li><p>GPAçš„[11:7] bit å†³å®šäº†å­é¡µçš„idxï¼Œç”¨ä»¥æ ‡è¯†å­é¡µé¢</p>
</li>
<li><p>å¯¹äºæ¯ä¸€ä¸ªenableäº†SPPçš„GPAé¡µé¢ï¼Œéƒ½æœ‰ä¸€ä¸ª64bitçš„SPP vectoræ¥æ§åˆ¶æ¯ä¸ªå­é¡µçš„æƒé™ï¼Œå‡è®¾é¡µé¢idxä¸ºSï¼ˆGPA[11:7]ï¼‰ï¼Œå¦‚æœSPP vectorä¸­2Så¤„çš„bitä½ä¸º1æ—¶ï¼Œæ‰èƒ½å¾€è¯¥å­é¡µå†™ï¼Œï¼ˆ2S+1ï¼‰å¤„è¿˜æ²¡ä½¿ç”¨ï¼Œå¿…é¡»ä¸º0.</p>
</li>
<li><p>SPP vectorå¤„äºå†…å­˜ä¸­ï¼Œè·å–SPP vectorè¿‡ç¨‹å¦‚ä¸‹ï¼ˆSPPTP - root SPP table - SPPL3 table - SPPL2 table - SPPL1 table - æŸ¥çœ‹å¯¹åº”é¡µ(GPA[20:12]) æŒ‡å‘åç§»ï¼ŒæŸ¥çœ‹è¯¥ 64 ä½å‘é‡çš„åç§»(å­é¡µå· GPA[11:7])ï¼‰ï¼š</p>
<ul>
<li>SPPTP(å­é¡µé¢æƒé™è¡¨æŒ‡é’ˆ) VM-execution control åŒ…å« 4KB å¤§å°çš„ root SPP tableï¼ŒGPA[47:39] æ ‡è¯†äº†è¯¥è¡¨ä¸­çš„ä¸€ä¸ª 64 ä½é¡¹ï¼Œç§°ä¸º SPPL4Eã€‚</li>
<li>4KB çš„ SPPL3 table ä½äº SPPL4E æ‰€ä¿å­˜çš„ç‰©ç†åœ°å€ä¸­ã€‚GPA[38:30] æ ‡è¯†äº†è¯¥è¡¨ä¸­çš„ä¸€ä¸ª 64 ä½é¡¹ï¼Œç§°ä¸º SPPL3Eã€‚</li>
<li>4KB çš„ SPPL2 table ä½äº SPPL3E æ‰€ä¿å­˜çš„ç‰©ç†åœ°å€ä¸­ã€‚GPA[29:21]æ ‡è¯†è¯¥è¡¨ä¸­çš„ä¸€ä¸ª 64 ä½é¡¹ï¼Œç§°ä¸º SPPL2Eã€‚</li>
<li>SPPL2E ä¿å­˜äº† 4KB å¤§å°çš„ SPPL1 table çš„ç‰©ç†åœ°å€ã€‚GPA[20:12] æ ‡è¯†äº†è¯¥åœ°å€çš„ 64 ä½ SPP å‘é‡ã€‚å­é¡µè®¸å¯å‘é‡çš„ä½ 2S å†³å®šäº†åœ°å€æ˜¯å¦å¯ä»¥è¢«å†™å…¥ï¼Œå…¶ä¸­ S æ˜¯åœ°å€ä½ 11:7 çš„å€¼ã€‚</li>
</ul>
<p>ï¼ˆç”¨äºè®¿é—®è¿™äº›è¡¨çš„å†…å­˜ç±»å‹åœ¨ IA32_VMX_BASIC MSR çš„ä½ 53:50 ä¸­æŒ‡å‡ºï¼ŒAppendix A.1ï¼‰</p>
</li>
<li><p>ä»…å½“é¡µé¢çš„ SPP å‘é‡ä¸­çš„æŒ‡ç¤ºä½é’ˆå¯¹æ¯ä¸ªå­é¡µé¢æ—¶ï¼Œæ‰å…è®¸å¯¹å•ä¸ª 4KB é¡µé¢ä¸Šçš„å¤šä¸ª 128B å­é¡µé¢è¿›è¡Œå†™è®¿é—®ã€‚ä»¥ä¸‹é¡¹ç›®é€‚ç”¨äºè®¿é—®å†™å…¥ä¸¤ä¸ª 4KB é¡µé¢çš„æƒ…å†µï¼š</p>
<ul>
<li>å¦‚æœæ ¹æ® Section 28.2.3.2ï¼Œä¸å…è®¸å¯¹ä»»ä½•ä¸€é¡µé¢è¿›è¡Œå†™å…¥ï¼Œåˆ™å³ä½¿è¯¥é¡µé¢çš„ GPA ç¬¦åˆå­é¡µé¢å†™å…¥æƒé™ï¼Œä¹Ÿå¯èƒ½ä¸å…è®¸è®¿é—®ã€‚</li>
<li>åªæœ‰åœ¨ä»¥ä¸‹æƒ…å†µä¸‹æ‰å…è®¸è®¿é—®ï¼šè¦ä¹ˆå¯¹äºæ¯ä¸€é¡µï¼ŒSection 28.2.3.2 å…è®¸å¯¹è¯¥é¡µå†™å…¥ï¼›è¦ä¹ˆ GPA æœ‰èµ„æ ¼è·å¾—å­é¡µé¢å†™è®¸å¯å¹¶ä¸”é¡µé¢çš„å­é¡µé¢å‘é‡å…è®¸å†™å…¥ã€‚</li>
</ul>
</li>
<li><p>æ¯ä¸ªé¡¹ï¼ˆSPPL4Eã€SPPL3Eã€SPPL2Eï¼‰çš„ä½ 0 ä¸ºè¯¥é¡¹çš„æœ‰æ•ˆä½ã€‚å¦‚æœåœ¨æ˜ å°„è¿‡ç¨‹ä¸­ï¼Œå‘ç°ä½ 0 ä¸º 0ï¼Œé‚£ä¹ˆæ˜ å°„è¿‡ç¨‹ç»ˆæ­¢ï¼Œé€»è¾‘å¤„ç†å™¨å‘ç”Ÿ SPP æœªå‘½ä¸­ï¼ˆ<strong>SPP miss</strong>ï¼‰ã€‚</p>
</li>
<li><p>æ¯ä¸ªé¡¹ï¼ˆSPPL4Eã€SPPL3Eã€SPPL2Eï¼‰ä¸­ï¼Œä¿ç•™ä½ 11:1ï¼Œä»¥åŠ 63:Nï¼Œå…¶ä¸­ N æ˜¯å¤„ç†å™¨çš„ç‰©ç†åœ°å€å®½åº¦ã€‚å¦‚æœå¯¹ä¿ç•™ä½ç½®ä½ï¼Œåˆ™æ˜ å°„è¿‡ç¨‹ç»ˆæ­¢ï¼Œå¹¶ä¸”é€»è¾‘å¤„ç†å™¨è§¦å‘ SPP misconfigurationã€‚</p>
</li>
<li><p>å¥‡æ•°ä½ç½®çš„ SPP å‘é‡ä¸­çš„ä½ä¹Ÿè¢«ä¿ç•™ï¼›SPP misconfiguration ä¹Ÿä¼šå‘ç”Ÿåœ¨å½“è¿™äº›å‘é‡ä¸­çš„ä¿ç•™ä½è¢«ç½®ä½æ—¶ã€‚</p>
</li>
<li><p>SPP misses å’Œ SPP misconfigurations è¢«ç§°ä¸º SPP-related eventsï¼ŒäºŒè€…å‡ä¼šå¯¼è‡´ VM exitsã€‚</p>
</li>
</ul>
</li>
</ul>
<h2 id="2-overview"><a href="#2-overview" class="headerlink" title="2. overview"></a>2. overview</h2><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210714170006047.png" alt="image-20210714170006047"></p>
<h2 id="3-KVM-support"><a href="#3-KVM-support" class="headerlink" title="3.KVM  support"></a>3.KVM  support</h2><p><a href="https://lwn.net/ml/linux-kernel/cover.1543481993.git.yi.z.zhang@linux.intel.com/">https://lwn.net/ml/linux-kernel/cover.1543481993.git.yi.z.zhang@linux.intel.com/</a></p>
]]></content>
      <categories>
        <category>note</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>KVM é€ƒé€¸æ¼æ´ From Project Zero</title>
    <url>/2021/08/17/paper_reading/%E8%99%9A%E6%8B%9F%E5%8C%96/KVM%20escape/</url>
    <content><![CDATA[<h1 id="Overview"><a href="#Overview" class="headerlink" title="Overview"></a>Overview</h1><p>ä¸»è¦å‚è€ƒ<a href="https://googleprojectzero.blogspot.com/2021/06/an-epyc-escape-case-study-of-kvm.html">é“¾æ¥</a>ã€‚</p>
<h2 id="åˆè¡·"><a href="#åˆè¡·" class="headerlink" title="åˆè¡·"></a>åˆè¡·</h2><p>ç”±äºè¿‡å»KVMé€ƒé€¸çš„æ¼æ´å¤§å¤šæ˜¯å› ä¸ºuseræ€ä¸‹çš„qemuçš„é—®é¢˜é€ æˆçš„ï¼Œå¾ˆå°‘æœ‰KVMè‡ªèº«çš„ä»£ç æœ‰æ¼æ´ã€‚</p>
<h1 id="å‰ç½®çŸ¥è¯†"><a href="#å‰ç½®çŸ¥è¯†" class="headerlink" title="å‰ç½®çŸ¥è¯†"></a>å‰ç½®çŸ¥è¯†</h1><ul>
<li>AMDçš„è™šæ‹ŸåŒ–æ‰©å±•æˆä¸º<a href="https://www.amd.com/system/files/TechDocs/24593.pdf">SVM</a>ï¼Œå…¶ä¸­é‡è¦çš„ä¸€ä¸ªæŒ‡ä»¤æ˜¯VMRUNï¼Œè¯¥æŒ‡ä»¤æœ‰ä¸€ä¸ªéšå¼çš„å‚æ•°ï¼šè¿è¡Œè¯¥æŒ‡ä»¤æ—¶RAXå¯„å­˜å™¨æŒ‡å‘äº†é¡µå¯¹é½çš„VMCBçš„ç‰©ç†åœ°å€ï¼ˆåœ¨intelä¸­å«VMCSï¼‰ã€‚</li>
<li>è™šæ‹ŸåŒ–å’ŒåµŒå¥—è™šæ‹ŸåŒ–çš„çŸ¥è¯†åœ¨åˆ«çš„æ–‡ç« é‡Œæœ‰è®²ã€‚</li>
<li>å¤§éƒ¨åˆ†çš„åµŒå¥—è™šæ‹ŸåŒ–çš„ä»£ç éƒ½åœ¨ <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/nested.c?h=v5.11">arch&#x2F;x86&#x2F;kvm&#x2F;svm&#x2F;nested.c</a>ä¸­ï¼ŒKVMæ‹¦æˆªVMRUNæŒ‡ä»¤çš„å®ç°åœ¨å‡½æ•°<font color=blue>nested_svm_vmrun</font>:</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">nested_svm_vmrun</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm)</span> <span class="comment">//struct vcpu_svmæ˜¯vcpuçš„ç»“æ„ä½“</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">vmcb12</span>;</span><span class="comment">//vmcb12æŒ‡çš„æ˜¯guest hypervisoråˆ›å»ºçš„çš„ç»“æ„ä½“ï¼ŒL1ä¸ºäº†è¿è¡ŒL2ç”¨çš„</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">hsave</span> =</span> svm-&gt;nested.hsave;<span class="comment">//vmcb12çš„hsaveï¼Œå³L1çš„çŠ¶æ€</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">vmcb</span> =</span> svm-&gt;vmcb;<span class="comment">//ä¸å½“å‰è¿è¡Œçš„vcpuç»‘å®šçš„vmcbç»“æ„ä½“ vmcb01</span></span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kvm_host_map</span> <span class="title">map</span>;</span> <span class="comment">//è´Ÿè´£å°†GPAè½¬æ¢æˆHPAçš„map</span></span><br><span class="line">        u64 vmcb12_gpa;</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">        vmcb12_gpa = svm-&gt;vmcb-&gt;save.rax; ** <span class="number">1</span> ** <span class="comment">//L1ä¸­çš„GPAï¼Œè¯¥GPAç”¨äºå­˜æ”¾vmcb12ç»“æ„ä½“ã€‚</span></span><br><span class="line">        ret = kvm_vcpu_map(&amp;svm-&gt;vcpu, gpa_to_gfn(vmcb12_gpa), &amp;<span class="built_in">map</span>); ** <span class="number">2</span> **<span class="comment">//åˆ©ç”¨ä¹‹å‰çš„mapå®Œæˆåœ°å€è½¬æ¢</span></span><br><span class="line">        â€¦</span><br><span class="line">        ret = kvm_skip_emulated_instruction(&amp;svm-&gt;vcpu);</span><br><span class="line"></span><br><span class="line">        vmcb12 = <span class="built_in">map</span>.hva;<span class="comment">//å¹¶æŠŠHPAæ˜ å°„åˆ°HVAä¸Šï¼Œä¿è¯KVMèƒ½å¤Ÿç›´æ¥è®¿é—®</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!nested_vmcb_checks(svm, vmcb12)) &#123; ** <span class="number">3</span> **			<span class="comment">//ä¸€æ—¦æ˜ å°„å®Œæˆå°±å¼€å§‹æ£€æŸ¥vmcb12çš„å†…å®¹</span></span><br><span class="line">                vmcb12-&gt;control.exit_code    = SVM_EXIT_ERR;</span><br><span class="line">                vmcb12-&gt;control.exit_code_hi = <span class="number">0</span>;</span><br><span class="line">                vmcb12-&gt;control.exit_info_1  = <span class="number">0</span>;</span><br><span class="line">                vmcb12-&gt;control.exit_info_2  = <span class="number">0</span>;</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        ...</span><br><span class="line"></span><br><span class="line">        <span class="comment">/*</span></span><br><span class="line"><span class="comment">         * Save the old vmcb, so we don&#x27;t need to pick what we save, but can</span></span><br><span class="line"><span class="comment">         * restore everything when a VMEXIT occurs</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="comment">//æŠŠvmcb01çš„guest stateå­˜å…¥vmcb12çš„host</span></span><br><span class="line">        hsave-&gt;save.es     = vmcb-&gt;save.es;</span><br><span class="line">        hsave-&gt;save.cs     = vmcb-&gt;save.cs;</span><br><span class="line">        hsave-&gt;save.ss     = vmcb-&gt;save.ss;</span><br><span class="line">        hsave-&gt;save.ds     = vmcb-&gt;save.ds;</span><br><span class="line">        hsave-&gt;save.gdtr   = vmcb-&gt;save.gdtr;</span><br><span class="line">        hsave-&gt;save.idtr   = vmcb-&gt;save.idtr;</span><br><span class="line">        hsave-&gt;save.efer   = svm-&gt;vcpu.arch.efer;</span><br><span class="line">        hsave-&gt;save.cr0    = kvm_read_cr0(&amp;svm-&gt;vcpu);</span><br><span class="line">        hsave-&gt;save.cr4    = svm-&gt;vcpu.arch.cr4;</span><br><span class="line">        hsave-&gt;save.rflags = kvm_get_rflags(&amp;svm-&gt;vcpu);</span><br><span class="line">        hsave-&gt;save.rip    = kvm_rip_read(&amp;svm-&gt;vcpu);</span><br><span class="line">        hsave-&gt;save.rsp    = vmcb-&gt;save.rsp;</span><br><span class="line">        hsave-&gt;save.rax    = vmcb-&gt;save.rax;</span><br><span class="line">        <span class="keyword">if</span> (npt_enabled)</span><br><span class="line">                hsave-&gt;save.cr3    = vmcb-&gt;save.cr3;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">                hsave-&gt;save.cr3    = kvm_read_cr3(&amp;svm-&gt;vcpu);</span><br><span class="line">        copy_vmcb_control_area(&amp;hsave-&gt;control, &amp;vmcb-&gt;control);</span><br><span class="line">        svm-&gt;nested.nested_run_pending = <span class="number">1</span>;</span><br><span class="line">    	<span class="comment">//è¿›å…¥L2çš„å‡½æ•°ï¼Œ</span></span><br><span class="line">        <span class="keyword">if</span> (enter_svm_guest_mode(svm, vmcb12_gpa, vmcb12)) ** <span class="number">4</span> **</span><br><span class="line">                <span class="keyword">goto</span> out_exit_err;</span><br><span class="line">        <span class="keyword">if</span> (nested_svm_vmrun_msrpm(svm))</span><br><span class="line">                <span class="keyword">goto</span> out;</span><br><span class="line">out_exit_err:</span><br><span class="line">        svm-&gt;nested.nested_run_pending = <span class="number">0</span>;</span><br><span class="line">        svm-&gt;vmcb-&gt;control.exit_code    = SVM_EXIT_ERR;</span><br><span class="line">        svm-&gt;vmcb-&gt;control.exit_code_hi = <span class="number">0</span>;</span><br><span class="line">        svm-&gt;vmcb-&gt;control.exit_info_1  = <span class="number">0</span>;</span><br><span class="line">        svm-&gt;vmcb-&gt;control.exit_info_2  = <span class="number">0</span>;</span><br><span class="line">        nested_svm_vmexit(svm);</span><br><span class="line">out:</span><br><span class="line">        kvm_vcpu_unmap(&amp;svm-&gt;vcpu, &amp;<span class="built_in">map</span>, <span class="literal">true</span>);</span><br><span class="line">        <span class="keyword">return</span> ret;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿›å…¥ä»L0è¿›å…¥L1çš„å‡½æ•°æ˜¯enter_svm_guest_modeï¼Œè¿™é‡Œè¿˜æ˜¯L0çš„ä¸Šä¸‹æ–‡</li>
</ul>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">enter_svm_guest_mode</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm, u64 vmcb12_gpa,</span></span><br><span class="line"><span class="params">                         <span class="keyword">struct</span> vmcb *vmcb12)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> ret;</span><br><span class="line">        svm-&gt;nested.vmcb12_gpa = vmcb12_gpa; <span class="comment">//æŠŠvmcb12_gpa(è¿™é‡Œæ˜¯ä»L0è§†è§’æ¥çœ‹çš„vmcb12)èµ‹å€¼ç»™svmä¸­ç›¸åº”çš„ç»“æ„</span></span><br><span class="line">    </span><br><span class="line">		<span class="comment">//è¿™é‡ŒæŠŠvmcb12çš„control areaç›´æ¥èµ‹å€¼ç»™svm-&gt;nest.ctlï¼Œï¼ˆè¿™é‡Œçš„SVMæ˜¯vmcb02ï¼‰ä½†æ˜¯è¿™é‡Œæœ‰ä¸ªé—®é¢˜ï¼Œå‰é¢æ˜¯checkè¿‡çš„ï¼Œä½†æ˜¯è¿™é‡Œä½¿ç”¨å¹¶æ²¡æœ‰check(åšå®¢é‡Œæ˜¯è¿™ä¹ˆè¯´çš„)</span></span><br><span class="line">        load_nested_vmcb_control(svm, &amp;vmcb12-&gt;control);<span class="comment">//è²Œä¼¼5.11çš„æºç è¿˜æ²¡è¿™ä¸€è¡Œï¼Œä¸çŸ¥é“ä¸ºä»€ä¹ˆåšå®¢é‡Œç»™äº†è¿™ä¸€è¡Œ</span></span><br><span class="line">        nested_prepare_vmcb_save(svm, vmcb12);<span class="comment">//5.11æºç é‡Œè¿™é‡Œå°†vmcb12èµ‹å€¼ç»™svm-&gt;vmcb-&gt;save.*</span></span><br><span class="line">        nested_prepare_vmcb_control(svm);<span class="comment">//5.11æºç é‡Œå°†svm-&gt;nested.ctlèµ‹å€¼ç»™svm-&gt;vmcb-&gt;controlã€‚ã€‚å¹¶æŠŠVCPUè¿›å…¥guestæ¨¡å¼ï¼Œå‡†å¤‡è¿›å…¥L2ã€‚</span></span><br><span class="line"></span><br><span class="line">        ret = nested_svm_load_cr3(&amp;svm-&gt;vcpu, vmcb12-&gt;save.cr3,</span><br><span class="line">                                  nested_npt_enabled(svm));</span><br><span class="line">        <span class="keyword">if</span> (ret)</span><br><span class="line">                <span class="keyword">return</span> ret;</span><br><span class="line"></span><br><span class="line">        svm_set_gif(svm, <span class="literal">true</span>);<span class="comment">//global interrupt flag</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> <span class="title function_">load_nested_vmcb_control</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm,</span></span><br><span class="line"><span class="params">                                     <span class="keyword">struct</span> vmcb_control_area *control)</span></span><br><span class="line">&#123;</span><br><span class="line">        copy_vmcb_control_area(&amp;svm-&gt;nested.ctl, control);</span><br><span class="line">        ...</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h1 id="BUG"><a href="#BUG" class="headerlink" title="BUG"></a>BUG</h1><p>ä¸Šé¢è¯´æ˜äº†åœ¨å‡½æ•°<font color=blue>enter_svm_guest_mode</font>ä¸­ï¼Œå› ä¸ºåœ¨èµ‹å€¼æ—¶å€™æ²¡æœ‰double checkï¼Œå¯¼è‡´çš„bugï¼Œé‚£ä¹ˆå¦‚ä½•åˆ©ç”¨è¿™ä¸ªbugå‘¢ï¼Œé¦–å…ˆæˆ‘ä»¬å…ˆçœ‹çœ‹å‡½æ•°<font color=blue>nested_vmcb_check_controls</font>åšäº†å“ªäº›æ£€æŸ¥ï¼š</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">static</span> <span class="type">bool</span> <span class="title function_">nested_vmcb_check_controls</span><span class="params">(<span class="keyword">struct</span> vmcb_control_area *control)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> ((vmcb_is_intercept(control, INTERCEPT_VMRUN)) == <span class="number">0</span>)</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (control-&gt;asid == <span class="number">0</span>)<span class="comment">//asidç”¨äºåŒºåˆ†ä¸åŒè™šæ‹Ÿæœºçš„åœ°å€ç©ºé—´</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">		<span class="keyword">if</span> ((control-&gt;nested_ctl &amp; SVM_NESTED_CTL_NP_ENABLE) &amp;&amp;</span><br><span class="line">            !npt_enabled)<span class="comment">//åµŒå¥—è™šæ‹ŸåŒ–æ§åˆ¶</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç¬¬ä¸€æ¬¡æ£€æŸ¥ä¸­ï¼Œæ£€æŸ¥VMRUNæŒ‡ä»¤æ˜¯å¦å¯ä»¥è¢«æˆªæ–­ï¼Œä½†æ˜¯SVMçš„VMCBä¸­åŒ…å«äº†ä¸€ä¸ªbitç”¨æ¥æ§åˆ¶guestä¸­è¿è¡ŒVMRUNæ˜¯å¦å¯ä»¥è¢«æˆªæ–­ï¼Œå¹¶ä¸”æ¸…é™¤è¿™ä¸ªä½ä¼šå¯¼è‡´VMExitçš„å‘ç”Ÿï¼ˆå› ä¸ºä»–ä¸è¢«ç¡¬ä»¶æ”¯æŒï¼‰ã€‚æ‰€ä»¥æˆ‘ä»¬å¯ä»¥é€šè¿‡ç«äº‰çš„æ–¹å¼ï¼Œåœ¨å¤šæ ¸ç³»ç»Ÿä¸Šä¸æ–­åå¤ç¿»è½¬è¿™ä¸ªbitï¼Œå°±å¯èƒ½ä¼šå¯¼è‡´é—®é¢˜çš„äº§ç”Ÿã€‚</p>
<p>æ—¢ç„¶è®¾ç½®è¿™ä¸ªbitä¼šå¯¼è‡´VMexitï¼Œé‚£æˆ‘ä»¬å…ˆæ¥çœ‹çœ‹KVMä¸­VMexitçš„å¤„ç†å‡½æ•°ï¼š<font color=blue>handle_exit</font> in <a href="https://git.kernel.org/pub/scm/linux/kernel/git/torvalds/linux.git/tree/arch/x86/kvm/svm/svm.c?h=v5.11">arch&#x2F;x86&#x2F;kvm&#x2F;svm.c</a>,æ¯æ¬¡é€€å‡ºæ—¶å€™éƒ½è¦åˆ¤æ–­è¯¥é€€å‡ºåŸå› æ˜¯ç”±L0å¤„ç†è¿˜æ˜¯L1çš„hypervisorå¤„ç†ã€‚</p>
<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"> <span class="type">static</span> <span class="type">int</span> <span class="title function_">handle_exit</span><span class="params">(<span class="keyword">struct</span> kvm_vcpu *vcpu, <span class="type">fastpath_t</span> exit_fastpath)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">vcpu_svm</span> *<span class="title">svm</span> =</span> to_svm(vcpu);</span><br><span class="line">        <span class="class"><span class="keyword">struct</span> <span class="title">kvm_run</span> *<span class="title">kvm_run</span> =</span> vcpu-&gt;run;</span><br><span class="line">        u32 exit_code = svm-&gt;vmcb-&gt;control.exit_code;</span><br><span class="line"></span><br><span class="line">        â€¦ </span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (is_guest_mode(vcpu)) &#123;<span class="comment">//åˆ¤æ–­æ˜¯L1çš„vcpuå‘ç”Ÿexitè¿˜æ˜¯L0çš„vcpuå‘ç”Ÿexitï¼Œå³æ˜¯ä»L2é€€å‡ºåˆ°L0è¿˜æ˜¯ä»L1é€€å‡ºåˆ°L0ã€‚å¦‚æœä¸ºçœŸåˆ™æ˜¯L2é€€å‡ºã€‚</span></span><br><span class="line">                <span class="type">int</span> vmexit;</span><br><span class="line"></span><br><span class="line">                trace_kvm_nested_vmexit(exit_code, vcpu, KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">                vmexit = nested_svm_exit_special(svm);<span class="comment">//å¦‚æœé€€å‡ºåŸå› æ˜¯ä¸­æ–­æˆ–è€…åˆ«çš„ç‰¹æ®ŠåŸå› ï¼ˆINTR,NMI,NPFï¼‰ï¼Œå°±å…ˆL0å¤„ç†ï¼Œç„¶åreturn NESTED_EXIT_HOSTï¼Œå¦åˆ™return NESTED_EXIT_CONTINUEï¼Œç”±L1æ¥ç€å¤„ç†ã€‚</span></span><br><span class="line">            </span><br><span class="line">			   <span class="comment">//L1çš„hypervisorå¤„ç†</span></span><br><span class="line">                <span class="keyword">if</span> (vmexit == NESTED_EXIT_CONTINUE)</span><br><span class="line">                        vmexit = nested_svm_exit_handled(svm); <span class="comment">//è¿›å…¥å¤„ç†L0è¦å¹²çš„ä¸€äº›äº‹æƒ…ï¼Œå¦‚æœè¦æ³¨å…¥</span></span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (vmexit == NESTED_EXIT_DONE)<span class="comment">//ç”¨äºå¤„ç†nested_svm_exit_specialä¸­å¤„ç†è¿‡äº†çš„vmexitï¼Œå› ä¸ºåœ¨nested_svm_exit_handledä¸­å¤„ç†çš„åœ¨è¯¥å‡½æ•°ä¸­è‡ªå·±å·²ç»è¿”å›guestè¿è¡Œäº†</span></span><br><span class="line">                        <span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">int</span> <span class="title function_">nested_svm_exit_handled</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="type">int</span> vmexit;</span><br><span class="line"></span><br><span class="line">        vmexit = nested_svm_intercept(svm); <span class="comment">//è°ƒç”¨nested_svm_interceptæŸ¥çœ‹exitæ˜¯å¦éœ€è¦å¤„ç†ï¼Œå¦‚æœè¦L1å¤„ç†åˆ™è¿”å›NESTED_EXIT_DONEï¼Œå¦åˆ™è¿”å›NESTED_EXIT_HOSTã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (vmexit == NESTED_EXIT_DONE)</span><br><span class="line">                nested_svm_vmexit(svm); <span class="comment">//å°†ç›¸åº”çš„å†…å®¹å†™å…¥vmcb12ä¸­ï¼Œç„¶åæ¢å¤guestè¿è¡Œï¼Œé€šè¿‡enter_svm_guest_modeå‡½æ•°æ¢å¤è¿è¡Œã€‚</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> vmexit;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="type">static</span> <span class="type">int</span> <span class="title function_">nested_svm_intercept</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm)</span></span><br><span class="line">&#123;</span><br><span class="line">        <span class="comment">// exit_code==INTERCEPT_VMRUN when the L2 guest executes vmrun</span></span><br><span class="line">        u32 exit_code = svm-&gt;vmcb-&gt;control.exit_code;</span><br><span class="line">        <span class="type">int</span> vmexit = NESTED_EXIT_HOST;</span><br><span class="line">        <span class="keyword">switch</span> (exit_code) &#123;</span><br><span class="line">        <span class="keyword">case</span> SVM_EXIT_MSR:</span><br><span class="line">                vmexit = nested_svm_exit_handled_msr(svm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> SVM_EXIT_IOIO:</span><br><span class="line">                vmexit = nested_svm_intercept_ioio(svm);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        â€¦ </span><br><span class="line">        <span class="keyword">default</span>: &#123;</span><br><span class="line">                <span class="keyword">if</span> (vmcb_is_intercept(&amp;svm-&gt;nested.ctl, exit_code)) </span><br><span class="line">		<span class="comment">//åˆ¤æ–­svm-&gt;nested.ctlæ˜¯å¦ä¸º1.è€Œä¸”è¿™æ˜¯defaultçš„æƒ…å†µï¼Œé€šå¸¸æƒ…å†µä¸‹éƒ½ä¼šä¸º1ï¼Œå¹¶ä¸”è¿”å›NESTED_EXIT_DONE.</span></span><br><span class="line">                        vmexit = NESTED_EXIT_DONE;</span><br><span class="line">        	&#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> vmexit;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">int</span> <span class="title function_">nested_svm_vmexit</span><span class="params">(<span class="keyword">struct</span> vcpu_svm *svm)</span></span><br><span class="line">&#123;</span><br><span class="line">	<span class="type">int</span> rc;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">vmcb12</span>;</span></span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">hsave</span> =</span> svm-&gt;nested.hsave;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">vmcb</span> *<span class="title">vmcb</span> =</span> svm-&gt;vmcb;</span><br><span class="line">	<span class="class"><span class="keyword">struct</span> <span class="title">kvm_host_map</span> <span class="title">map</span>;</span></span><br><span class="line"></span><br><span class="line">	rc = kvm_vcpu_map(&amp;svm-&gt;vcpu, gpa_to_gfn(svm-&gt;nested.vmcb12_gpa), &amp;<span class="built_in">map</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc) &#123;</span><br><span class="line">		<span class="keyword">if</span> (rc == -EINVAL)</span><br><span class="line">			kvm_inject_gp(&amp;svm-&gt;vcpu, <span class="number">0</span>);</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	vmcb12 = <span class="built_in">map</span>.hva;<span class="comment">//å°†VMCB12æ˜ å°„åˆ°L0ï¼Œä½¿å¾—L0èƒ½å¤Ÿç›´æ¥è®¿é—®</span></span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Exit Guest-Mode */</span></span><br><span class="line">	leave_guest_mode(&amp;svm-&gt;vcpu);</span><br><span class="line">	svm-&gt;nested.vmcb12_gpa = <span class="number">0</span>;</span><br><span class="line">	WARN_ON_ONCE(svm-&gt;nested.nested_run_pending);</span><br><span class="line"></span><br><span class="line">	kvm_clear_request(KVM_REQ_GET_NESTED_STATE_PAGES, &amp;svm-&gt;vcpu);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* in case we halted in L2 */</span></span><br><span class="line">	svm-&gt;vcpu.arch.mp_state = KVM_MP_STATE_RUNNABLE;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Give the current vmcb to the guest */</span></span><br><span class="line"></span><br><span class="line">	vmcb12-&gt;save.es     = vmcb-&gt;save.es;</span><br><span class="line">	vmcb12-&gt;save.cs     = vmcb-&gt;save.cs;</span><br><span class="line">	vmcb12-&gt;save.ss     = vmcb-&gt;save.ss;</span><br><span class="line">	vmcb12-&gt;save.ds     = vmcb-&gt;save.ds;</span><br><span class="line">	vmcb12-&gt;save.gdtr   = vmcb-&gt;save.gdtr;</span><br><span class="line">	vmcb12-&gt;save.idtr   = vmcb-&gt;save.idtr;</span><br><span class="line">	vmcb12-&gt;save.efer   = svm-&gt;vcpu.arch.efer;</span><br><span class="line">	vmcb12-&gt;save.cr0    = kvm_read_cr0(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.cr3    = kvm_read_cr3(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.cr2    = vmcb-&gt;save.cr2;</span><br><span class="line">	vmcb12-&gt;save.cr4    = svm-&gt;vcpu.arch.cr4;</span><br><span class="line">	vmcb12-&gt;save.rflags = kvm_get_rflags(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.rip    = kvm_rip_read(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.rsp    = kvm_rsp_read(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.rax    = kvm_rax_read(&amp;svm-&gt;vcpu);</span><br><span class="line">	vmcb12-&gt;save.dr7    = vmcb-&gt;save.dr7;</span><br><span class="line">	vmcb12-&gt;save.dr6    = svm-&gt;vcpu.arch.dr6;</span><br><span class="line">	vmcb12-&gt;save.cpl    = vmcb-&gt;save.cpl;</span><br><span class="line"></span><br><span class="line">	vmcb12-&gt;control.int_state         = vmcb-&gt;control.int_state;</span><br><span class="line">	vmcb12-&gt;control.exit_code         = vmcb-&gt;control.exit_code;</span><br><span class="line">	vmcb12-&gt;control.exit_code_hi      = vmcb-&gt;control.exit_code_hi;</span><br><span class="line">	vmcb12-&gt;control.exit_info_1       = vmcb-&gt;control.exit_info_1;</span><br><span class="line">	vmcb12-&gt;control.exit_info_2       = vmcb-&gt;control.exit_info_2;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (vmcb12-&gt;control.exit_code != SVM_EXIT_ERR)</span><br><span class="line">		nested_vmcb_save_pending_event(svm, vmcb12);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (svm-&gt;nrips_enabled)</span><br><span class="line">		vmcb12-&gt;control.next_rip  = vmcb-&gt;control.next_rip;</span><br><span class="line"></span><br><span class="line">	vmcb12-&gt;control.int_ctl           = svm-&gt;nested.ctl.int_ctl;</span><br><span class="line">	vmcb12-&gt;control.tlb_ctl           = svm-&gt;nested.ctl.tlb_ctl;</span><br><span class="line">	vmcb12-&gt;control.event_inj         = svm-&gt;nested.ctl.event_inj;</span><br><span class="line">	vmcb12-&gt;control.event_inj_err     = svm-&gt;nested.ctl.event_inj_err;</span><br><span class="line"></span><br><span class="line">	vmcb12-&gt;control.pause_filter_count =</span><br><span class="line">		svm-&gt;vmcb-&gt;control.pause_filter_count;</span><br><span class="line">	vmcb12-&gt;control.pause_filter_thresh =</span><br><span class="line">		svm-&gt;vmcb-&gt;control.pause_filter_thresh;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Restore the original control entries */</span></span><br><span class="line">	copy_vmcb_control_area(&amp;vmcb-&gt;control, &amp;hsave-&gt;control);</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* On vmexit the  GIF is set to false */</span></span><br><span class="line">	svm_set_gif(svm, <span class="literal">false</span>);</span><br><span class="line"></span><br><span class="line">	svm-&gt;vmcb-&gt;control.tsc_offset = svm-&gt;vcpu.arch.tsc_offset =</span><br><span class="line">		svm-&gt;vcpu.arch.l1_tsc_offset;</span><br><span class="line"></span><br><span class="line">	svm-&gt;nested.ctl.nested_cr3 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/* Restore selected save entries */</span></span><br><span class="line">	svm-&gt;vmcb-&gt;save.es = hsave-&gt;save.es;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.cs = hsave-&gt;save.cs;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.ss = hsave-&gt;save.ss;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.ds = hsave-&gt;save.ds;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.gdtr = hsave-&gt;save.gdtr;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.idtr = hsave-&gt;save.idtr;</span><br><span class="line">	kvm_set_rflags(&amp;svm-&gt;vcpu, hsave-&gt;save.rflags);</span><br><span class="line">	svm_set_efer(&amp;svm-&gt;vcpu, hsave-&gt;save.efer);</span><br><span class="line">	svm_set_cr0(&amp;svm-&gt;vcpu, hsave-&gt;save.cr0 | X86_CR0_PE);</span><br><span class="line">	svm_set_cr4(&amp;svm-&gt;vcpu, hsave-&gt;save.cr4);</span><br><span class="line">	kvm_rax_write(&amp;svm-&gt;vcpu, hsave-&gt;save.rax);</span><br><span class="line">	kvm_rsp_write(&amp;svm-&gt;vcpu, hsave-&gt;save.rsp);</span><br><span class="line">	kvm_rip_write(&amp;svm-&gt;vcpu, hsave-&gt;save.rip);</span><br><span class="line">	svm-&gt;vmcb-&gt;save.dr7 = <span class="number">0</span>;</span><br><span class="line">	svm-&gt;vmcb-&gt;save.cpl = <span class="number">0</span>;</span><br><span class="line">	svm-&gt;vmcb-&gt;control.exit_int_info = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">	vmcb_mark_all_dirty(svm-&gt;vmcb);</span><br><span class="line"></span><br><span class="line">	trace_kvm_nested_vmexit_inject(vmcb12-&gt;control.exit_code,</span><br><span class="line">				       vmcb12-&gt;control.exit_info_1,</span><br><span class="line">				       vmcb12-&gt;control.exit_info_2,</span><br><span class="line">				       vmcb12-&gt;control.exit_int_info,</span><br><span class="line">				       vmcb12-&gt;control.exit_int_info_err,</span><br><span class="line">				       KVM_ISA_SVM);</span><br><span class="line"></span><br><span class="line">	kvm_vcpu_unmap(&amp;svm-&gt;vcpu, &amp;<span class="built_in">map</span>, <span class="literal">true</span>);</span><br><span class="line"></span><br><span class="line">	nested_svm_uninit_mmu_context(&amp;svm-&gt;vcpu);</span><br><span class="line"></span><br><span class="line">	rc = nested_svm_load_cr3(&amp;svm-&gt;vcpu, hsave-&gt;save.cr3, <span class="literal">false</span>);</span><br><span class="line">	<span class="keyword">if</span> (rc)</span><br><span class="line">		<span class="keyword">return</span> <span class="number">1</span>;</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> (npt_enabled)</span><br><span class="line">		svm-&gt;vmcb-&gt;save.cr3 = hsave-&gt;save.cr3;</span><br><span class="line"></span><br><span class="line">	<span class="comment">/*</span></span><br><span class="line"><span class="comment">	 * Drop what we picked up for L2 via svm_complete_interrupts() so it</span></span><br><span class="line"><span class="comment">	 * doesn&#x27;t end up in L1.</span></span><br><span class="line"><span class="comment">	 */</span></span><br><span class="line">	svm-&gt;vcpu.arch.nmi_injected = <span class="literal">false</span>;</span><br><span class="line">	kvm_clear_exception_queue(&amp;svm-&gt;vcpu);</span><br><span class="line">	kvm_clear_interrupt_queue(&amp;svm-&gt;vcpu);</span><br><span class="line"></span><br><span class="line">	<span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>However, if the L1 guest exploited the race condition described above svm-&gt;nested.ctl wonâ€™t have the INTERCEPT_VMRUN bit set and the VM exit will be handled by KVM itself. This results in a second call to nested_svm_vmrun while still running inside the L2 guest context. nested_svm_vmrun isnâ€™t written to handle this situation and will blindly overwrite the L1 context stored in svm-&gt;nested.hsave with data from the currently active svm-&gt;vmcb which contains data for the L2 guest:</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>Nested virtualization</title>
    <url>/2021/08/17/paper_reading/%E8%99%9A%E6%8B%9F%E5%8C%96/%E5%B5%8C%E5%A5%97%E8%99%9A%E6%8B%9F%E5%8C%96%20nest%20virtualization/</url>
    <content><![CDATA[<h1 id="Nested-Virtualization"><a href="#Nested-Virtualization" class="headerlink" title="Nested Virtualization"></a>Nested Virtualization</h1><p>åœ¨<code>Intel processor</code>å·²ç»æ”¯æŒæ¥äº†<code>VMX</code> ç‰¹æ€§ï¼Œç”¨ä»¥è¿è¡Œè™šæ‹Ÿæœºã€‚ä½†æ˜¯åœ¨guestä¸­å¦‚æœæƒ³åµŒå¥—åœ°å†è¿è¡Œä¸€å±‚<code>hypervisor</code> æ˜¯ä¸è¢«å…è®¸çš„ï¼Œå› ä¸º<code>VMRun</code>ï¼Œ<code>VMResume</code> æ˜¯ä¸¤ä¸ªç‰¹æƒæŒ‡ä»¤ï¼Œä¸èƒ½åœ¨<code>guest mode</code>ä¸‹è¢«è¿è¡Œï¼Œç”±æ­¤æå‡ºäº†åµŒå¥—è™šæ‹ŸåŒ–æŠ€æœ¯ã€‚</p>
<span id="more"></span>

<h2 id="CPU-perspective"><a href="#CPU-perspective" class="headerlink" title="CPU perspective"></a>CPU perspective</h2><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210812100834355.png" alt="image-20210812100834355"></p>
<h2 id="define"><a href="#define" class="headerlink" title="define"></a>define</h2><ul>
<li>å¦‚å›¾æ‰€ç¤ºï¼Œå½“åªæœ‰ä¸¤å±‚çš„æ—¶å€™ï¼Œä¸ºäº†è¯´æ˜æ–¹ä¾¿ï¼ŒæŠŠç¡¬ä»¶ä¹‹ä¸Šçš„hypervisorå®šä¹‰ä¸ºL0ï¼ŒæŠŠL0è¿è¡Œçš„è™šæ‹Ÿæœºå®šä¹‰ä¸ºL1ï¼ŒæŠŠL1guestå¥—å¨ƒè¿è¡Œçš„è™šæ‹Ÿæœºæˆä¸ºL2ã€‚åŒæ—¶ç›¸åº”çš„ï¼Œåœ¨x86æ¶æ„ä¸‹ï¼ˆ<code>Intel AMD</code>ï¼‰ï¼Œä»L0åˆ°L1æœ‰VMCS<sub>0-&gt;1</sub> ,ä»L1åˆ°L2æœ‰VMCS<sub>1-&gt;2</sub> ã€‚ä½†æ˜¯ä¸ºäº†æ›´å¥½åœ°ç®¡ç†L1ä¸L2,L0çš„hypervisorä¸­è¿˜æœ‰VMCS<sub>0-&gt;2</sub> .</li>
</ul>
<h2 id="exception-trap-and-emulate"><a href="#exception-trap-and-emulate" class="headerlink" title="exception, trap and emulate"></a>exception, trap and emulate</h2><ul>
<li><p>CPUåœ¨æ­£å¸¸æƒ…å†µä¼šç”±äºè¿è¡Œç‰¹æƒæŒ‡ä»¤æˆ–è€…å¼‚å¸¸æŒ‡ä»¤è€Œå¯¼è‡´exceptionå’Œtrapã€‚</p>
</li>
<li><p>ç›¸åº”çš„ï¼Œåœ¨VMXç¡¬ä»¶æ‰©å±•ä¸‹ï¼ŒCPUæ”¯æŒrootå’Œnon-rootä¸¤ç§æ¨¡å¼ã€‚å½“CPUåœ¨non-rootæ¨¡å¼ä¸‹æ‰§è¡Œä¸€äº›rootæ¨¡å¼çš„æŒ‡ä»¤ï¼ˆVMRun,VMResumeï¼‰ç­‰ç­‰ï¼Œå°±ä¼šå‘ç”Ÿä¸€æ¬¡VMexitä»non-rootæ¨¡å¼é€€å‡ºåˆ°rootæ¨¡å¼è¿è¡Œã€‚è€Œä»è½¯ä»¶è§†è§’æ¥çœ‹å°±æ˜¯å½“è™šæ‹Ÿæœºæ­£åœ¨è·‘è‡ªå·±çš„ä»£ç çš„æ—¶å€™ï¼ˆæŒ‡ä»¤ï¼‰ï¼Œçªç„¶è¿è¡Œäº†ä¸€æ¡å¼‚å¸¸æˆ–è€…ç‰¹æƒæŒ‡ä»¤å°±éœ€è¦åˆ‡æ¢åˆ°rootæ¨¡å¼å»æ‰§è¡Œï¼Œè€Œguestè¿è¡Œæ—¶å€™çš„çŠ¶æ€éƒ½ä¼šè¢«ä¿å­˜çš„VMCSç»“æ„ä¸­ã€‚ç„¶ååŠ è½½VMCSç»“æ„ä¸­çš„hostçŠ¶æ€ï¼Œä»è€Œå‘ç”Ÿä¸€æ¬¡åˆ‡æ¢ï¼Œè®©CPUè¿è¡Œhostçš„hypervisorå¤„ç†å¼‚å¸¸ã€‚</p>
</li>
</ul>
<h2 id="åµŒå¥—æƒ…å†µä¸‹çš„CPUè™šæ‹ŸåŒ–"><a href="#åµŒå¥—æƒ…å†µä¸‹çš„CPUè™šæ‹ŸåŒ–" class="headerlink" title="åµŒå¥—æƒ…å†µä¸‹çš„CPUè™šæ‹ŸåŒ–"></a>åµŒå¥—æƒ…å†µä¸‹çš„CPUè™šæ‹ŸåŒ–</h2><ul>
<li>L<sub>0</sub>ä¸ºäº†è¿è¡ŒL<sub>1</sub>éœ€è¦ä¸ºL<sub>1</sub>å‡†å¤‡VMCS<sub>0-&gt;1</sub>ç»“æ„ï¼Œä»ç¡¬ä»¶è§’åº¦æ¥è¯´è¿è¡ŒL<sub>0</sub>æ—¶CPUå¤„äºroot-modeï¼Œè¿è¡ŒL<sub>1</sub>æ—¶ï¼ŒCPUå¤„äºnon-root-modeï¼ŒL<sub>1</sub>å¹¶ä¸èƒ½æ„ŸçŸ¥è‡ªå·±å¤„äºguest-modeã€‚</li>
<li>åœ¨L<sub>1</sub>ä¸­ä¸ºäº†è¿è¡ŒL<sub>2</sub>ï¼Œéœ€è¦ä¸ºL<sub>2</sub>å‡†å¤‡VMCS<sub>1-&gt;2</sub> ,è¯¥ç»“æ„ä»L<sub>1</sub>çš„è§†è§’ä¿å­˜äº†L<sub>2</sub>çš„ä¸Šä¸‹æ–‡ç¯å¢ƒã€‚</li>
<li>è€ŒVMCS<sub>0-&gt;1</sub>å’ŒVMCS<sub>1-&gt;2</sub> ç»“åˆæˆVMCS<sub>0-&gt;2</sub>ï¼Œå…·ä½“ç»“åˆè§„åˆ™å¦‚ä¸‹ï¼š<ul>
<li>host stateåŒºåŸŸï¼šVMCS<sub>0-&gt;2</sub>çš„host region&#x3D;VMCS<sub>0-&gt;1</sub>çš„host regionï¼ŒVMCS<sub>1-&gt;2</sub>çš„host region&#x3D;VMCS<sub>0-&gt;1</sub> çš„guest region</li>
<li>guest stateåŒºåŸŸï¼šVMCS<sub>0-&gt;2</sub>çš„guest region&#x3D;VMCS<sub>1-&gt;2</sub>çš„guest regionï¼ŒVMCS<sub>0-&gt;1</sub>çš„guest region&#x3D;VMCS<sub>1-&gt;2</sub> çš„host region</li>
<li>control dataåŒºåŸŸï¼šåˆ†å‡ ç§æƒ…å†µï¼Œå…·ä½“æ€ä¹ˆåˆå¹¶çš„çœ‹æºç ã€‚ï¼ˆæƒ…å†µ2è¿˜æ²¡ä»”ç»†å»çœ‹æºç ï¼‰<ul>
<li>1ï¼šVMCS<sub>1-&gt;2</sub>ä¼šé€€å‡ºè€ŒVMCS<sub>0-&gt;1</sub>ä¸ä¼šé€€å‡ºï¼Œå³L<sub>1</sub>å®šä¹‰äº†æŸä¸ªç‰¹å®šäº‹ä»¶ä¼šå‘ç”ŸVMexitï¼Œä½†æ˜¯L<sub>0</sub>å®šä¹‰è¯¥äº‹ä»¶ä¸ä¼šé€€å‡ºã€‚ç”±äºä¸è®ºæ˜¯L<sub>1</sub>è¿˜æ˜¯L<sub>2</sub>å‘ç”ŸVMexitéƒ½æ˜¯åˆ°L<sub>0</sub>ï¼Œæ‰€ä»¥è¿™ç§æƒ…å†µä¸‹ï¼ŒL<sub>2</sub>å› ä¸ºæ‰§è¡Œäº†ç‰¹æ®Šä»£ç ï¼Œå¿…é¡»è¦å¯¼è‡´é€€å‡ºï¼Œæ‰€ä»¥åœ¨VMCS<sub>0-&gt;2</sub>çš„control dataä¸­å¿…é¡»è®°å½•æ‰€æœ‰è¿™ç§æƒ…å†µçš„äº‹ä»¶ã€‚</li>
<li>2ï¼šVMCS<sub>1-&gt;2</sub>ä¸ä¼šé€€å‡ºè€ŒVMCS<sub>0-&gt;1</sub>ä¼šé€€å‡ºã€‚ï¼ˆçŒœæµ‹å°±ä¸é€€å‡ºäº†å‘—ï¼Œåæ­£1-&gt;2ä¸é€€å‡ºï¼Œé‚£æ¥ç€è¿è¡Œä¸å°±å¥½äº†ï¼Œè¿è¡Œçš„æ¯•ç«Ÿæ˜¯L2çš„ä»£ç ï¼Œç®¡L1å•¥äº‹ï¼‰</li>
<li>3ï¼šéƒ½ä¼šé€€å‡ºçš„æƒ…å†µã€‚ï¼ˆå‚è€ƒ1ï¼‰</li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="åµŒå¥—æƒ…å†µä¸‹çš„VMExit"><a href="#åµŒå¥—æƒ…å†µä¸‹çš„VMExit" class="headerlink" title="åµŒå¥—æƒ…å†µä¸‹çš„VMExit"></a>åµŒå¥—æƒ…å†µä¸‹çš„VMExit</h3><p>å› ä¸ºVMrunï¼ŒVMresumeæ˜¯ç‰¹æƒæŒ‡ä»¤ï¼Œæ‰€ä»¥åœ¨åµŒå¥—è™šæ‹ŸåŒ–çš„æƒ…å†µä¸‹ï¼ŒL1å’ŒL2è¿è¡Œè¿™äº›æŒ‡ä»¤éƒ½ä¼šå¯¼è‡´VMexitåˆ°L0 ï¼Œè€ŒL0éœ€è¦å¯¹è¿™äº›æŒ‡ä»¤è¿›è¡Œæ¨¡æ‹Ÿã€‚è¿™é‡Œåªè®²L2æƒ…å†µä¸‹çš„VMExitã€‚</p>
<p>L2çš„VMExitæœ‰ä¸¤ç§å¯èƒ½çš„åŸå› ï¼Œ</p>
<ul>
<li>ä¸€ç§æ˜¯å¤–éƒ¨ä¸­æ–­ï¼Œéå±è”½ä¸­æ–­ï¼ˆNMIï¼‰ï¼Œè¿˜æœ‰åœ¨VMCS<sub>0-&gt;2</sub>ä¸­è®°å½•çš„ï¼Œä½†æ˜¯åœ¨VMCS<sub>1-&gt;2</sub>ä¸­æ²¡æœ‰è®°å½•çš„ä¼šå¯¼è‡´VMExitçš„äº‹ä»¶ï¼Œè¿™äº›äº‹ä»¶åªéœ€è¦ç”±L0æ¥å¤„ç†å®Œæˆä¹‹åç›´æ¥æ¢å¤L2å³å¯ã€‚</li>
<li>å¦ä¸€ç§æ˜¯ç”±äºåœ¨VMCS<sub>1-&gt;2</sub>ä¸­è®°å½•çš„ä¼šå¯¼è‡´VMExitçš„äº‹ä»¶ã€‚è¿™ç§æƒ…å†µä¸‹é€€å‡ºåˆ°L0ï¼ŒL0å†å°†é€€å‡ºçš„åŸå› å†™å…¥åˆ°VMCS<sub>1-&gt;2</sub>ä¸­ï¼Œç„¶åæ¢å¤è¿è¡ŒL1ï¼Œè¿™æ ·L1æ¢å¤ä¹‹åå°±ä¼šè®¤ä¸ºæ˜¯L2é€€å‡ºå¯¼è‡´çš„äº‹ä»¶ï¼Œç„¶ååœ¨L1ä¸­å¤„ç†å®Œäº†ä¹‹åè¦æ¢å¤è¿è¡ŒL2ï¼Œä¼šæ‰§è¡ŒVMrunæˆ–è€…VMresumeæŒ‡ä»¤ï¼Œè¿™æ˜¯ç‰¹æƒæŒ‡ä»¤ï¼Œæ‰€ä»¥åˆä¼šå¯¼è‡´VMexitè¿›å…¥åˆ°L0ï¼ŒL0åˆ©ç”¨VMCS<sub>0-&gt;2</sub>å¸®å¿™æ¨¡æ‹Ÿï¼Œç›´æ¥è¿è¡ŒL2ã€‚</li>
</ul>
<h2 id="åµŒå¥—æƒ…å†µä¸‹çš„å†…å­˜è™šæ‹ŸåŒ–"><a href="#åµŒå¥—æƒ…å†µä¸‹çš„å†…å­˜è™šæ‹ŸåŒ–" class="headerlink" title="åµŒå¥—æƒ…å†µä¸‹çš„å†…å­˜è™šæ‹ŸåŒ–"></a>åµŒå¥—æƒ…å†µä¸‹çš„å†…å­˜è™šæ‹ŸåŒ–</h2><p>ä½†æ˜¯å¯¹äºåµŒå¥—æƒ…å†µä¸‹çš„å†…å­˜è™šæ‹ŸåŒ–ï¼Œç”±äºç¡¬ä»¶æœ€å¤šåªæ”¯æŒä¸¤æ®µpage walkï¼Œå³stage1å’Œstage2ï¼ŒåµŒå¥—çš„æƒ…å†µä¸‹å¯èƒ½æœ‰ä¸‰æ®µï¼Œç”šè‡³æ›´å¤šæ®µçš„page walkï¼Œæ‰€ä»¥éœ€è¦å¯¹é™¤äº†stage1ä»¥å¤–çš„page walkå‹ç¼©æˆä¸€æ®µã€‚</p>
<p><strong>å½±å­é¡µè¡¨</strong>ï¼šå½“å¤„ç†å™¨ä¸æ”¯æŒè™šæ‹ŸåŒ–ç¡¬ä»¶ç‰¹æ€§çš„æ—¶å€™ï¼Œæœ€æ—©æ˜¯ç”¨å½±å­é¡µè¡¨ã€‚æˆ‘ä»¬éƒ½çŸ¥é“ï¼Œintelæ˜¯ç”¨cr3å¯„å­˜å™¨æ¥è®°å½•åœ°å€ç¿»è¯‘çš„æ—¶å€™çš„é¡µè¡¨çš„ç‰©ç†åœ°å€çš„ï¼Œä½†æ˜¯åœ¨è™šæ‹ŸåŒ–çš„ç¯å¢ƒä¸‹ï¼Œå¦‚æœåªç”¨åŸæœ¬çš„é¡µè¡¨å»åšåœ°å€ç¿»è¯‘ï¼Œåªèƒ½è®²GVAç¿»è¯‘æˆGPAï¼Œä½†æ˜¯è¿™å¹¶ä¸æ˜¯çœŸå®çš„ç‰©ç†åœ°å€ï¼Œæ‰€ä»¥å½±å­é¡µè¡¨å°±æ­¤è¯ç”Ÿäº†ï¼Œå®ƒæ—¨åœ¨æŠŠæ‰€æœ‰è™šæ‹Ÿæœºå†…éƒ¨å¯¹äºé¡µè¡¨çš„æ“ä½œï¼ˆåŒ…æ‹¬ç¼ºé¡µä¸­æ–­ï¼ŒINVLPGæŒ‡ä»¤å’Œä¸Šä¸‹æ–‡åˆ‡æ¢ç­‰ç­‰ï¼‰ï¼Œéƒ½è¢«VMMæ‹¦æˆªï¼Œå¹¶åœ¨VMMç”Ÿæˆä¸€ä¸ªç›¸åº”çš„å½±å­é¡µè¡¨ï¼Œå¯¹å½±å­é¡µè¡¨è¿›è¡Œä¿®æ”¹ï¼Œç„¶åæŠŠå½±å­é¡µè¡¨çš„åŸºå€æ›¿æ¢CR3å¯„å­˜å™¨çš„é¡µè¡¨åŸºå€ï¼Œè¿™æ ·è™šæ‹Ÿæœºæ¢å¤è¿è¡Œçš„æ—¶å€™ï¼Œå°±èƒ½æ­£ç¡®æŠŠGVAç¿»è¯‘æˆHPAäº†ã€‚</p>
<p>åœ¨è®²å‹ç¼©è¿‡ç¨‹ä¹‹å‰ï¼Œéœ€è¦äº†è§£intel EPTçš„ç‰¹æ€§å¯ä»¥åœ¨L0å’ŒL1çš„hypervisorä¸­é€‰æ‹©å¼€å¯æˆ–è€…ä¸å¼€å¯ï¼Œæ‰€ä»¥å°±æœ‰å››ç§é€‰æ‹©ï¼Œè¿™ä¸»è¦æ˜¯ç”±äºL1çš„vcpuæ˜¯ç”±L0è™šæ‹ŸåŒ–å‡ºæ¥çš„ï¼Œä»–å¯ä»¥åœ¨é‡Œé¢å†³å®švcpuçš„ç‰¹æ€§æ˜¯å¦æ”¯æŒVMX.</p>
<table>
<thead>
<tr>
<th></th>
<th>æƒ…å†µ1</th>
<th>æƒ…å†µ2</th>
<th>æƒ…å†µ3</th>
<th>æƒ…å†µ4</th>
</tr>
</thead>
<tbody><tr>
<td>L1</td>
<td>å½±å­é¡µè¡¨</td>
<td>å½±å­é¡µè¡¨</td>
<td>EPT</td>
<td>EPT</td>
</tr>
<tr>
<td>L0</td>
<td>å½±å­é¡µè¡¨</td>
<td>EPT</td>
<td>EPT</td>
<td>å½±å­é¡µè¡¨</td>
</tr>
</tbody></table>
<p>ç¬¬å››ç§æƒ…å†µæ¯”è¾ƒç¬¨æ¯”ï¼Œæœ‰EPTäº†éè¦æ•´ä¸ªå½±å­é¡µè¡¨å¢åŠ overheadï¼Œæ­£å¸¸æƒ…å†µä¸‹è‚¯å®šæ²¡äººç”¨å•Šï¼Œå°±ä¸è®²äº†ï¼Œè®²å‰é¢ä¸‰ç§ï¼Œåˆ†åˆ«å¯¹åº”ä¸‹å›¾ä¸­çš„1,2,3.</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20210818191252056.png" alt="image-20210818191252056"></p>
<p>å¦‚å›¾æ‰€ç¤ºï¼ŒSPTï¼ˆshadow page tableï¼‰ï¼ŒGPTï¼ˆguest page tableï¼‰ï¼ŒEPTï¼ˆextend page tableï¼‰ã€‚</p>
<ul>
<li>1.å½±å­é¡µè¡¨+å½±å­é¡µè¡¨çš„å½¢å¼ï¼šL0ä¸ºäº†è¿è¡ŒL1åˆ›å»ºäº†SPT01ï¼ŒL1ä¸ºäº†è¿è¡ŒL2åˆ›å»ºäº†SPT12ï¼Œä½†æ˜¯L0åŒæ—¶è¦ä¸ºL2çš„è¿è¡Œï¼Œéœ€è¦ä¸ºL2å‡†å¤‡SPT02ã€‚è¿™æ ·å°±èƒ½å°†L2çš„GVAé€šè¿‡SPT02çš„åŸºå€æ›¿æ¢CR3ï¼Œå°±èƒ½ç›´æ¥å°†GVAç¿»è¯‘æˆHVAäº†ã€‚</li>
<li>2.å½±å­é¡µè¡¨+EPTï¼šL1ä¸ºè¿è¡ŒL2å‡†å¤‡äº†SPT12ï¼Œé€šè¿‡CR3å°†L2çš„GVAç›´æ¥ç¿»è¯‘æˆL1çš„GPAï¼Œç„¶åL1çš„GPAç»è¿‡EPTç¿»è¯‘æˆL0çš„HPAã€‚</li>
<li>3.EPT+EPTï¼šL0æŠŠä¸¤ä¸ªEPTå‹ç¼©æˆä¸€ä¸ªEPTï¼Œç¬¬ä¸€é˜¶æ®µä¸ºç”¨L2è‡ªèº«çš„é¡µè¡¨å°†L2çš„GVAè½¬æ¢æˆL2çš„GPAï¼Œç„¶åç¬¬äºŒé˜¶æ®µå°†L2çš„GPAç›´æ¥è½¬æ¢æˆL0çš„HPAã€‚</li>
</ul>
<p><strong>ç¼ºé¡µä¸­æ–­</strong>ï¼šå½“L2å‘ç”Ÿç¼ºé¡µä¸­æ–­ä¹‹åï¼Œæ ¹æ®å¦‚ä¸Šä¸‰ç§æƒ…å†µå½¢æˆä¸‰ç§ä¸åŒçš„è§£å†³è·¯å¾„ã€‚</p>
<ul>
<li>å½±å­é¡µè¡¨+å½±å­é¡µè¡¨ï¼šæ‰€æœ‰çš„L2ä¸­ä¿®æ”¹é¡µè¡¨çš„æ“ä½œéƒ½éœ€è¦è¢«L0æ‹¦æˆªï¼Œç„¶åç”Ÿæˆå’Œä¿®æ”¹ç›¸åº”çš„SPT02ï¼Œå†æ¢å¤è¿è¡Œã€‚</li>
<li>å½±å­é¡µè¡¨+EPTï¼šæ‰€æœ‰L2çš„ä¿®æ”¹é¡µè¡¨æ“ä½œï¼Œéƒ½è¦å‘ç”ŸVMexitåˆ°L0ï¼Œä½†æ˜¯ç”±äºè¯¥äº‹ä»¶éœ€è¦ç”±L1å¤„ç†ï¼Œæ‰€ä»¥L0éœ€è¦æŠŠä¿®å¤é¡µè¡¨è¿™ä¸ªäº‹ä»¶æ³¨å…¥åˆ°L1ï¼ŒL1å¤„ç†å®Œæˆä¹‹åå†æ¢å¤è¿è¡ŒL2ï¼ˆæ­¤æ—¶åˆä¼šå‘ç”ŸVMexitï¼Œåˆ°L0ï¼Œç„¶åL0è¿è¡ŒL2ï¼‰ã€‚æ‰€ä»¥å®ƒç”šè‡³æ¯”å½±å­é¡µè¡¨+å½±å­é¡µè¡¨çš„å½¢å¼æ›´æ…¢ã€‚</li>
<li>EPT+EPTï¼šL2ç¼ºé¡µé¦–å…ˆç”±è‡ªå·±kernelä¿®å¤ï¼Œå½“GPTä¿®å¤å®Œæˆä¹‹åå†æ‰§è¡Œè®¿å­˜ï¼Œä¼šå¯¼è‡´EPTç¼ºé¡µï¼Œå‘ç”ŸVMexitåˆ°L0ï¼Œç”±äºEPTéœ€è¦ç”±EPT12å’ŒEPT01åˆå¹¶å½¢æˆï¼Œæ‰€ä»¥é¦–å…ˆæ£€æŸ¥EPT12æ˜¯å¦æœ‰ç¼ºå¤±ï¼Œå¦‚æœæœ‰åˆ™L0å°†EPTç¼ºå¤±äº‹ä»¶æ³¨å…¥åˆ°L1ï¼Œç„¶åè¿è¡ŒL1å¤„ç†ï¼ˆè¿™é‡Œæœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯æ‰€æœ‰çš„EPT12ä¿®æ”¹ï¼Œéƒ½è¦å¯¼è‡´EPT02çš„ä¿®æ”¹ï¼Œæ‰€ä»¥L0ä¸ºäº†æ‹¦æˆªEPT12çš„ä¿®æ”¹ï¼Œå°†L0ä¸­çš„å­˜å‚¨EPT12çš„å†…å­˜åŒºåŸŸçš„EPT01è®¾ç½®ä¸ºåªè¯»ï¼ˆè®¾ç½®çš„æ˜¯EPT01ï¼Œè®¾ç½®çš„åŒºåŸŸå­˜å‚¨äº†EPT12ï¼‰ï¼Œè¿™æ ·L1åœ¨è¿è¡Œçš„æ—¶å€™å°±ä¼šå¯¼è‡´å†…å­˜è®¿é—®é”™è¯¯ï¼Œç„¶åL0æ¥å¸®å¿™ä¿®æ”¹ï¼‰ï¼ŒL1å½“ç„¶å¤„ç†ä¸äº†ï¼Œå› ä¸ºæ˜¯åªè¯»æƒé™ï¼Œæ‰€ä»¥åˆå‘ç”Ÿå†™å†…å­˜æ—¶é—´ï¼Œé™·å…¥åˆ°L0ï¼ŒL0å¤„ç†å¸®å¿™å†™äº†ä¹‹åæ¢å¤åˆ°L1ï¼ŒL1å¤„ç†å®Œäº†è¿è¡Œvmresumeï¼Œåˆé€€å‡ºåˆ°L0ï¼Œç„¶åL0ç›´æ¥è¿è¡ŒL2ï¼ŒL2åˆè¿è¡Œä¹‹å‰å‡ºé”™æŒ‡ä»¤ï¼Œå‘ç°åˆEPTå‡ºé”™é€€å‡ºåˆ°L0ï¼ŒL0ç»§ç»­æ£€æŸ¥å‘ç°æ˜¯EPT01æ²¡æœ‰é…ç½®ï¼Œæ‰€ä»¥ä»–åˆé…ç½®EPT01ï¼Œç„¶åæ¢å¤L2è¿è¡Œã€‚ï¼ˆå¾ˆç»•ï¼Œä½†æ˜¯æ²¡å¾—åŠæ³•ã€‚ã€‚ã€‚ï¼‰</li>
</ul>
<p><strong>TLBé—®é¢˜</strong>ï¼šç¡¬ä»¶ä¸Šæœ‰VPIDæœºåˆ¶ï¼Œä½†æ˜¯åœ¨åµŒå¥—è™šæ‹ŸåŒ–çš„æƒ…å†µä¸‹ï¼Œéœ€è¦æŠŠL1ä½¿ç”¨çš„VPIDï¼Œæ˜ å°„è¿›L0ä½¿ç”¨çš„VPIDä¸­ï¼Œä¿è¯æ²¡æœ‰å†²çªï¼ˆpaperå°±ç®€å•æäº†ä¸€ä¸‹ï¼Œå…·ä½“éœ€è¦çœ‹æºç ï¼Œå›å¤´å†æ¥æ”¹è¿™é‡Œï¼Œå…ˆè¿™ä¹ˆå†™ç€ã€‚ï¼‰</p>
<h2 id="åµŒå¥—æƒ…å†µä¸‹çš„IOè™šæ‹ŸåŒ–"><a href="#åµŒå¥—æƒ…å†µä¸‹çš„IOè™šæ‹ŸåŒ–" class="headerlink" title="åµŒå¥—æƒ…å†µä¸‹çš„IOè™šæ‹ŸåŒ–"></a>åµŒå¥—æƒ…å†µä¸‹çš„IOè™šæ‹ŸåŒ–</h2><p>comming soon</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>xMPï¼šSelective Memory Protection for Kernel and User Space</title>
    <url>/2021/08/17/paper_reading/%E8%99%9A%E6%8B%9F%E5%8C%96/xmp/</url>
    <content><![CDATA[<h1 id="éœ€è¦çš„èƒŒæ™¯çŸ¥è¯†"><a href="#éœ€è¦çš„èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="éœ€è¦çš„èƒŒæ™¯çŸ¥è¯†"></a>éœ€è¦çš„èƒŒæ™¯çŸ¥è¯†</h1><h2 id="altp2m"><a href="#altp2m" class="headerlink" title="altp2m"></a>altp2m</h2><ul>
<li><p>p2m: guest Physical memory to machine physical</p>
<p>p2mä»£è¡¨ä»å®¢æˆ·æœºç‰©ç†åœ°å€åˆ°æœºå™¨çœŸå®ç‰©ç†åœ°å€çš„å†…å­˜ç®¡ç†å±‚ã€‚è¿™ä¸€å±‚æ˜¯ä¸ºäº†å¤šä¸ªVMä¹‹é—´çš„éš”ç¦»ã€‚åœ¨XENä¸­ï¼Œè¿™ä¸€å±‚å«Hardware Assisted Paging(hap).</p>
</li>
<li><p>altp2m</p>
<p>â€‹    è€Œ altp2må…è®¸ä¸ºæ¯ä¸ªVMåˆ›å»ºå¤šä¸ªEPTè¡¨ï¼Œå¹¶ä¸”Intelå·²ç»æ”¯æŒäº†è¿™ç§ç‰¹æ€§ï¼Œåœ¨VMCSç»“æ„ä¸­æœ€å¤šå…è®¸æœ‰512ä¸ªEPTæŒ‡é’ˆã€‚</p>
<p>â€‹    å› ä¸ºå½“VMçš„æŸä¸ªè®¿é—®é¡µé¢çš„æƒé™å‡ºé—®é¢˜äº†çš„æ—¶å€™ï¼Œä¼šé™·å…¥çš„VMMï¼Œåœ¨VMå†…éƒ¨å¹¶ä¸çŸ¥é“å¤–é¢åšäº†ä»€ä¹ˆäº‹æƒ…ã€‚è€Œæœ‰çš„æ—¶å€™å¯¹äºå¤šä¸ªvcpuçš„ç³»ç»Ÿæ¥è¯´ï¼Œå¯¹äºä¸€å—é¡µé¢è®¿é—®å‡ºç°äº†æƒé™é—®é¢˜ï¼Œå¯èƒ½è¦æ”¾æ¾å¯¹äºè¯¥é¡µé¢çš„æƒé™ï¼Œä½†æ˜¯è¿™ä¼šå¯¼è‡´åˆ«çš„vcpuå¯èƒ½ä¼šå› ä¸ºç«äº‰å…³ç³»è®¿é—®åˆ°å®½æ¾æƒé™åçš„æƒé™ï¼Œè¿™å°±ä¼šå¯¼è‡´æœ‰å®‰å…¨é—®é¢˜ï¼Œäºæ˜¯å…è®¸ä¸ºä¸åŒçš„vcpuè®¾ç½®ä¸åŒçš„stage2é¡µè¡¨ï¼Œå°±å¯ä»¥é¿å…è¿™ç§é—®é¢˜ã€‚å½“ç„¶ä¹Ÿå¯ä»¥åœ¨è®¿é—®çš„æ—¶å€™æš‚åœåˆ«çš„vcpuï¼Œè¿™ç§æ–¹æ¡ˆä¼šå¯¼è‡´å¾ˆå¤šçš„overheadã€‚ä¹Ÿå¯ä»¥é‡‡ç”¨è½¯ä»¶æ¨¡æ‹Ÿçš„æ–¹å¼ï¼Œæ•è·çš„è®¿é—®çš„å¼‚å¸¸ï¼Œç„¶ååœ¨éœ€è¦æ”¾æ¾æƒé™çš„åœ°æ–¹ï¼Œé™·å…¥åˆ°VMMè¿›è¡Œæ¨¡æ‹Ÿã€‚ï¼ˆè¿™ç§æ–¹å¼å¯¹äºXENå¥½åƒä¸å¤ªå‹å¥½ã€‚åŸè¯æ˜¯è¿™æ ·çš„ï¼šThis solution, while supported in Xen, is not particularly ideal either as Xenâ€™s emulator is incomplete and is known to have issues that can lead to guest instability. ï¼‰</p>
<p>â€‹    åˆ©ç”¨è¿™ç§ç‰¹æ€§ï¼Œå¯ä»¥å°†VMæ˜ å°„åˆ°ä¸åŒçš„ç‰©ç†é¡µï¼Œä¹Ÿå¯ä»¥å°†VMå¯¹åŒä¸€ç‰©ç†é¡µæœ‰ä¸åŒçš„æƒé™ã€‚æ€»ä¹‹å°±æ˜¯å…è®¸stage2çš„é¡µè¡¨æ›´åŠ çµæ´»ï¼Œå¹¶ä¸”æœ‰å¤šä¸ªã€‚</p>
</li>
</ul>
<h2 id="VE-Virtualization-Exception"><a href="#VE-Virtualization-Exception" class="headerlink" title="#VE:Virtualization Exception"></a>#VE:Virtualization Exception</h2><p>â€‹	#VEæ˜¯intelçš„CPUæä¾›çš„ä¸€ä¸ªç‰¹æ€§ã€‚åŸæœ¬ä¸€äº›å¼‚å¸¸çš„æ“ä½œä¼šå¯¼è‡´VM exitï¼Œç°åœ¨å…è®¸å°†ä¸€äº›è®¾å®šçš„æƒ…å½¢ä¸å†å¯¼è‡´VM exitï¼Œè€Œæ˜¯å‡ºå‘ä¸€ä¸ª#VEï¼Œç„¶åå†guestä¸­è¿›è¡Œå¤„ç†ï¼Œå‡å°‘å¼€é”€ã€‚</p>
<p>â€‹	å¼€å¯#VEéœ€è¦è®¾ç½®<code> EPT-violation #VEâ€ VM-execution control</code> ã€‚å½“å‘ç”ŸVEçš„æ—¶å€™ï¼ŒCPUä¼šå°†å…³äºå¼‚å¸¸çš„ä¿¡æ¯ä¿å­˜åˆ°<code> virtualization-exception information area</code>ã€‚ä¸€äº›VMMå…è®¸guestè®¿é—®è¿™ä¸ªareaï¼Œå¹¶æ”¹ä¸€äº›è¿™ä¸ªareaçš„è®¾ç½®ï¼Œæ¥é˜²æ­¢å‘ç”ŸVM exitã€‚</p>
<p>â€‹	ç‰¹åˆ«çš„ï¼ŒEPTçš„è®¿é—®å†æ²¡è®¾ç½®VEæ—¶å€™éƒ½ä¼šå¯¼è‡´VM exitã€‚å¦‚æœè®¾ç½®äº†VEï¼Œä¸€äº›ç‰¹å®šçš„EPTè¿è§„è¡Œä¸ºå°±ä¼šè§¦å‘VEã€‚page entryçš„ç¬¬63ä½bitè®¾ç½®åˆ™è¡¨æ˜æŠ‘åˆ¶VEã€‚ä¸€äº›EPTè¿è§„çš„æƒ…å½¢èƒ½å¤Ÿè®¾ç½®ä¸ºVEå‚è€ƒæ‰‹å†Œ å·3-25.5.7ã€‚</p>
<p>â€‹	å…·ä½“æ¥è¯´ï¼Œå¦‚æœVMCSä¸­çš„å¼‚å¸¸ä½å›¾çš„ç¬¬20ä½ï¼ˆ#VEï¼‰ä¸º1ï¼Œåˆ™è¯¥VEä¼šå¯¼è‡´VM exitï¼Œå¹¶å°†ä¿¡æ¯å­˜å…¥VMCSä¸­VM exitåŒºåŸŸã€‚å¦‚æœè¯¥ä½ä¸º0å¹¶ä¸”æ˜¯æ²¡æœ‰å¯¼è‡´VM exitçš„æƒ…å†µåˆ™ç›´æ¥åœ¨guestä¸­ä½¿ç”¨IDTè¡¨ä¸­çš„20å·ä¸­æ–­ï¼Œå¦‚æœå¯¼è‡´VM exitï¼Œåˆ™ä¼šåœ¨<code> IDT-vectoring information field</code> ä¸­å­˜å…¥å¼‚å¸¸ä¿¡æ¯ã€‚</p>
<h2 id="VMFUNC"><a href="#VMFUNC" class="headerlink" title="VMFUNC"></a>VMFUNC</h2><p>â€‹	VMFUNCæ˜¯ä¸€æ¡Intel CPUæä¾›çš„æŒ‡ä»¤ã€‚è¯¦æƒ…å‚è€ƒæ‰‹å†Œå·3-25.5.6</p>
<p>â€‹	ç›¸è¾ƒäºhypercallä½¿ç”¨çš„VMCALLæŒ‡ä»¤è€Œè¨€ï¼ŒVMFUNCæ˜¯åœ¨guestä¸­è¿è¡ŒVMMçš„å‡½æ•°ï¼Œä¸ä¼šå¯¼è‡´VM exitã€‚ è€Œhypercallæ˜¯å‘VMMè¯·æ±‚æœåŠ¡ï¼Œä¼šå¯¼è‡´VM exitï¼Œå°†æ§åˆ¶æƒè½¬è‡³VMMã€‚</p>
<h2 id="MPK-Memory-Protection-Key"><a href="#MPK-Memory-Protection-Key" class="headerlink" title="MPK:Memory-Protection Key"></a>MPK:Memory-Protection Key</h2><p>â€‹	MPKæ˜¯Intel CPUæä¾›çš„ä¸€ç§ç‰¹æ€§ï¼Œç”¨ä»¥é¡µçº§ç²’åº¦çš„ä¿æŠ¤ã€‚å®ƒåªé’ˆå¯¹æ•°æ®è·å–çš„æƒé™ï¼ˆaccessableï¼Œwritableï¼‰ï¼Œæ²¡æœ‰é’ˆå¯¹æŒ‡ä»¤è·å–ã€‚å¹¶ä¸”åªæœ‰64ä½æ—¶å€™æœ‰MPKï¼Œ32ä½æ²¡æœ‰ã€‚è¯¥ç‰¹æ€§ä½¿å¾—èƒ½å¤Ÿç»™ç”¨æˆ·æ€æä¾›ç”³è¯·ä¿æŠ¤ï¼Œè€Œä¸ç”¨é™·å…¥å†…æ ¸ä¿®æ”¹é¡µè¡¨é¡¹ï¼Œå‡å°äº†å¼€é”€ã€‚</p>
<p>â€‹	MPKæœ€å¤šæä¾›16ä¸ªkeyï¼ˆstage1 page entryä¸­çš„ï¼ˆ59-62ï¼‰4ä¸ªbitä½ã€‚ï¼‰ã€‚å¯¹äºç”¨æˆ·æ€ï¼šCR4.PKEå†³å®šäº†ä»ç”¨æˆ·æ€åœ°å€è·å–é¡µé¢çš„MPKå¼€å¯ã€‚PKRUå¯„å­˜å™¨ï¼ˆ32ä½ï¼‰ä¸­å­˜æ”¾äº†ä¸åŒçš„keyçš„æƒé™ã€‚å¯¹äºå†…æ ¸æ€ï¼šCR4.PKSå†³å®šäº†ä»å†…æ ¸æ€åœ°å€è·å–é¡µé¢çš„MPKçš„å¼€å¯ï¼ŒIA32_PKRS MSRå¯„å­˜å™¨(64ä½å¯„å­˜å™¨ï¼Œä½†æ˜¯ä½32ä½å­˜æ”¾äº†æƒé™ï¼Œé«˜32ä½å¿…é¡»ä¸º0)å­˜æ”¾äº†ä¸åŒkeyçš„æƒé™ã€‚</p>
<p>â€‹	å¯¹äºæ¯ä¸ªkeyçš„æƒé™ï¼Œç”¨ä¸¤ä¸ªbitè¡¨ç¤ºï¼Œæ‰€ä»¥16ä¸ªkeyå°±æ˜¯32ä½ã€‚ å¶æ•°ä½æ˜¯access-disable bit,å¥‡æ•°ä½æ˜¯write-disable bitã€‚</p>
<p>â€‹	kernelæä¾›äº†syscallç»™ç”¨æˆ·æ€ç”¨ä»¥ç”³è¯·MPKã€‚è¯¦æƒ…è§</p>
<h2 id="EPTP-switch"><a href="#EPTP-switch" class="headerlink" title="EPTP switch"></a>EPTP switch</h2><p>â€‹	EPTP switching æ˜¯VMFUNC 0.è¿™ä¸ªå‡½æ•°å…è®¸åœ¨guestä¸­ä¸ºè‡ªå·±åˆ‡æ¢EPTè¡¨ï¼Œä½†æ˜¯è¿™äº›EPTè¡¨æ˜¯æå‰åœ¨hypervisorä¸­é…ç½®å¥½çš„ã€‚è¯¦æƒ…è§æ‰‹å†Œå·3-25.5.6.3</p>
<p>â€‹	å¯„å­˜å™¨ECXç”¨ä»¥é€‰æ‹©EPTPã€‚Intelç°åœ¨æœ€å¤šæ”¯æŒ512ä¸ªEPTPï¼Œæ‰€ä»¥ECXè¶…è¿‡512å°±ä¼šå¯¼è‡´VM exitã€‚</p>
<h1 id="Impletment"><a href="#Impletment" class="headerlink" title="Impletment"></a>Impletment</h1><h2 id="buddy-allocator"><a href="#buddy-allocator" class="headerlink" title="buddy allocator"></a>buddy allocator</h2><p>â€‹	å¯¹äºå†…å­˜åˆ†é…å™¨ä¸­çš„buddy allocatorï¼Œå¢åŠ äº†__GFP_XMPæ ‡å¿—ä½ï¼Œç”¨ä»¥ç”³è¯·xMP domainåŒºåŸŸçš„é¡µã€‚é€šè¿‡8ä¸ªbitæ¥åˆ†é…256ä¸ªdomainã€‚åˆ©ç”¨altp2må¯ä»¥åˆ‡æ¢æ¯ä¸ªdomainçš„viewï¼ˆä¸åŒæƒé™ï¼‰</p>
<h2 id="slab-allocator"><a href="#slab-allocator" class="headerlink" title="slab allocator"></a>slab allocator</h2><p>â€‹	slabæ˜¯å»ºç«‹åœ¨buddyä¹‹ä¸Šï¼Œæ›´åŠ ç»†ç²’åº¦çš„åˆ†é…å™¨ã€‚å®ƒå°†ä¸€é¡µåˆ†æˆäº†å¤šä¸ªéƒ¨åˆ†ï¼Œåˆ†é…ç»™ä¸€äº›ç‰¹å®šçš„ç»“æ„ï¼Œå¹¶ä¸”æœ‰ä¸“é—¨çš„slab cacheç”¨äºåˆ†é…å’Œé‡Šæ”¾å†…æ ¸çš„æ•°æ®ç»“æ„ï¼ˆä¾‹å¦‚task_structï¼‰ã€‚</p>
<p>â€‹	xMPå…è®¸åœ¨ä½¿ç”¨slabçš„æ—¶å€™ï¼Œå°†slabæ”¾åˆ°xMP domainä¸­ï¼Œå› ä¸ºä»–æ˜¯å»ºç«‹åœ¨buddyä¹‹ä¸Šçš„ã€‚æ¯å½“slab cache è¦ç”³è¯·æ–°çš„é¡µæ—¶ï¼Œå°±å¯ä»¥åˆ©ç”¨xMPçš„æ¥å£ç”³è¯·xMP domainçš„é¡µã€‚</p>
<h2 id="Switches-across-Execution-Contexts"><a href="#Switches-across-Execution-Contexts" class="headerlink" title="Switches across Execution Contexts"></a>Switches across Execution Contexts</h2><h3 id="ä¸Šä¸‹æ–‡åˆ‡æ¢"><a href="#ä¸Šä¸‹æ–‡åˆ‡æ¢" class="headerlink" title="ä¸Šä¸‹æ–‡åˆ‡æ¢"></a>ä¸Šä¸‹æ–‡åˆ‡æ¢</h3><p>â€‹	åœ¨task_structä¸­å¢åŠ äº†domian indexå­—æ®µï¼Œç”¨äºè¯†åˆ«å½“å‰threadå¤„äºä½•ç§xMP viewã€‚è¯¥å­—æ®µåˆå§‹å€¼ä¸ºæœ€ä¸¥æ ¼çš„domain viewã€‚ å½“è¦è¿›å…¥domainåŒºåŸŸçš„æ—¶å€™ä¼šåˆ‡æ¢indexå€¼ï¼Œä»è€Œåˆ‡æ¢æƒé™ã€‚ä¹‹åå†ä¸Šä¸‹æ–‡åˆ‡æ¢çš„æ—¶å€™indexå€¼ç›¸åº”çš„ä¼šä¿å­˜ã€‚</p>
<h3 id="ç¡¬ä¸­æ–­"><a href="#ç¡¬ä¸­æ–­" class="headerlink" title="ç¡¬ä¸­æ–­"></a>ç¡¬ä¸­æ–­</h3><p>â€‹	åœ¨ç¡¬ä»¶ä¸­æ–­çš„æ—¶å€™ï¼Œå°†viewåˆ‡æ¢æˆæœ€ä¸¥æ ¼çš„domainï¼Œé˜²æ­¢æ½œåœ¨çš„ä¸­æ–­å¤„ç†ç¨‹åºé—®é¢˜è®¿é—®å—ä¿æŠ¤çš„å†…å­˜ã€‚ç„¶åå½“ç»“æŸä¸­æ–­è¿”å›æ—¶ï¼Œå¦‚æœè¦è®¿é—®xMP domainçš„å†…å®¹ï¼Œä¼šäº§ç”Ÿä¸€ä¸ª#VEï¼ˆåŸæœ¬å› ä¸ºæƒé™é—®é¢˜ä¼šé™·å…¥VMMï¼‰ï¼Œç„¶å#VE handler å¤„ç†ï¼ŒéªŒè¯thread è®¿é—®domainçš„åˆæ³•æ€§ï¼Œç„¶ååˆ‡æ¢domain viewï¼Œç„¶åç»§ç»­è¿è¡Œã€‚</p>
<h3 id="è½¯ä¸­æ–­"><a href="#è½¯ä¸­æ–­" class="headerlink" title="è½¯ä¸­æ–­"></a>è½¯ä¸­æ–­</h3><p>â€‹	è½¯ä¸­æ–­æŒ‡çš„æ˜¯ç¡¬ä»¶ä¸­æ–­ä¸­æ–­ä¹‹åï¼Œä¸­æ–­çš„ä¸‹åŠéƒ¨åˆ†æœºåˆ¶ï¼Œè¿™éƒ¨åˆ†kernelç”±è½¯ä»¶å®ç°ã€‚ï¼ˆè½¯ä»¶ä¸­æ–­å’Œè½¯ä¸­æ–­åœ¨ä¸­æ–‡ä¸Šæœ‰åŒºåˆ«ï¼Œå› ä¸ºç¿»è¯‘é—®é¢˜ï¼‰äºŒè€…åŒºåˆ«å‚è€ƒ</p>
<p>[çŸ¥ä¹]: <a href="https://zhuanlan.zhihu.com/p/80371745">https://zhuanlan.zhihu.com/p/80371745</a>	â€œçŸ¥ä¹çš„è§£ç­”â€</p>
<p>â€‹	è¿™éƒ¨åˆ†åˆ©ç”¨Linuxçš„ï¼ˆCONFIG_RCU_NOCB_CPUï¼‰ï¼Œä¸ç”¨è½¯ä¸­æ–­å¤„ç†ï¼Œè€Œæ˜¯èµ·å¦ä¸€ä¸ªçº¿ç¨‹æ¥å¤„ç†ï¼Œè¿™æ ·å°±å¯ä»¥æ ¹æ®ä¸åŒçš„çº¿ç¨‹å¯èƒ½è¦åœ¨callbackä¸­è®¿é—®xMP domainï¼Œå°±å¯ä»¥åˆ†åˆ«ç»™æ¯ä¸ªçº¿ç¨‹å¤„ç†irqæ—¶å€™èµ·çš„çº¿ç¨‹è¿›è¡Œé…ç½®ã€‚ï¼ˆè¿™éƒ¨åˆ†è¿˜ä¸æ˜¯ç‰¹åˆ«æ˜ç™½ï¼Œå…ˆè¿™ä¹ˆå†™ï¼‰</p>
<h3 id="User-space-API"><a href="#User-space-API" class="headerlink" title="User space API"></a>User space API</h3><p>â€‹	åˆ›å»ºäº†å››ä¸ªç³»ç»Ÿè°ƒç”¨ï¼Œç±»ä¼¼MPKçš„ç³»ç»Ÿè°ƒç”¨ï¼Œåˆ›å»ºsys_xmp_{alloc,free,mprotect}ï¼Œä½†æ˜¯ä»–ä¸èƒ½åƒMPKé‚£æ ·åœ¨ç”¨æˆ·ç©ºé—´ä½¿ç”¨VMFUNCæŒ‡ä»¤ï¼Œæ‰€ä»¥æ–°å»ºäº†ä¸€ä¸ªç³»ç»Ÿè°ƒç”¨sys_xmp_enterï¼Œç”¨ä»¥è¿›å…¥xMP domainï¼Œå¹¶æ›´æ–°domain viewã€‚</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
  <entry>
    <title>V-Shuttleï¼šScalable and Semantics-Aware Hypervisor Virtual Device Fuzzing</title>
    <url>/2021/08/17/paper_reading/%E8%99%9A%E6%8B%9F%E5%8C%96/V-shuffle/</url>
    <content><![CDATA[<h1 id="V-Shuttle-Scalable-and-Semantics-Aware-Hypervisor-Virtual-Device-Fuzzing"><a href="#V-Shuttle-Scalable-and-Semantics-Aware-Hypervisor-Virtual-Device-Fuzzing" class="headerlink" title="V-Shuttle: Scalable and Semantics-Aware Hypervisor Virtual Device Fuzzing"></a>V-Shuttle: Scalable and Semantics-Aware Hypervisor Virtual Device Fuzzing</h1><h2 id="2-èƒŒæ™¯çŸ¥è¯†"><a href="#2-èƒŒæ™¯çŸ¥è¯†" class="headerlink" title="2.èƒŒæ™¯çŸ¥è¯†"></a>2.èƒŒæ™¯çŸ¥è¯†</h2><h3 id="2-1-è™šæ‹Ÿè®¾å¤‡"><a href="#2-1-è™šæ‹Ÿè®¾å¤‡" class="headerlink" title="2.1 è™šæ‹Ÿè®¾å¤‡"></a>2.1 è™šæ‹Ÿè®¾å¤‡</h3><p>â€‹	 æ‰€è°“è™šæ‹Ÿè®¾å¤‡ï¼Œå°±æ˜¯æä¾›ç»™guestçš„å¤–å›´ä»¿çœŸè®¾å¤‡ã€‚guestä¸­çš„é©±åŠ¨å¯ä»¥å¤„ç†è¿™äº›è™šæ‹Ÿè®¾å¤‡ï¼Œå°±å¥½åƒä»–ä»¬å¤„ç†ç‰©ç†è®¾å¤‡ä¸€æ ·ã€‚æ¯ä¸€ä¸ªè®¾å¤‡çš„åè®®è§„å®šäº†å¯„å­˜å™¨çº§åˆ«çš„ç¡¬ä»¶æ¥å£ï¼Œç”¨ä»¥è®¾å¤‡å’Œosä¹‹é—´çš„äº¤äº’ã€‚æ€»çš„æ¥è¯´è™šæ‹ŸåŒ–è®¾è®¡è™šæ‹Ÿè®¾å¤‡æ˜¯æ ¹æ®SPECæ¥è®¾è®¡çš„ï¼Œä½†æ˜¯è¿™ä¼šæä¾›ä¸€ç§æ”»å‡»hypervisorçš„æ–¹å¼ã€‚</p>
<h3 id="2-2-é©±åŠ¨ä¸è®¾å¤‡äº¤äº’"><a href="#2-2-é©±åŠ¨ä¸è®¾å¤‡äº¤äº’" class="headerlink" title="2.2 é©±åŠ¨ä¸è®¾å¤‡äº¤äº’"></a>2.2 é©±åŠ¨ä¸è®¾å¤‡äº¤äº’</h3><p>â€‹	æ€»çš„æ¥è¯´ï¼Œä¸€ä¸ªè™šæ‹Ÿè®¾å¤‡æš´éœ²äº†ä¸‰ç§é‡è¦çš„äº¤äº’æ–¹å¼ï¼ŒMMIO,PIO,DMAï¼ˆIOMMUï¼‰ã€‚ï¼ˆè¿™ä¸‰ä¸ªå°±ä¸ç»†è¯´äº†ï¼Œå…·ä½“åŸç†çœ‹ç‹æŸç”Ÿã€è°¢å¹¿å†›æ’°å†™çš„ã€Šæ·±åº¦æ¢ç´¢Linuxç³»ç»Ÿè™šæ‹ŸåŒ–ï¼šåŸç†ä¸å®ç°ã€‹ä¸€ä¹¦ç¬¬ä¸‰ç« ï¼‰ã€‚</p>
<p>â€‹	åœ¨æœ€å¼€å§‹è®¾å¤‡æ‰§è¡Œçš„æ—¶å€™ï¼Œguestçš„é©±åŠ¨ä¼šå†™å…¥ä¸€äº›æ•°æ®åˆ°MMIOæˆ–è€…PIO regionsï¼Œä»è€Œåšä¸€äº›åˆå§‹åŒ–ç›¸å…³çš„å·¥ä½œï¼Œæ¯”å¦‚è®¾ç½®è®¾å¤‡çŠ¶æ€ï¼Œå¯„å­˜å™¨åœ°å€åˆå§‹åŒ–ç­‰ç­‰ã€‚å®Œæˆåˆå§‹åŒ–ä¹‹åï¼Œè®¾å¤‡è¿›å…¥readyçŠ¶æ€ï¼Œå¯ä»¥è¿›è¡Œå¤„ç†äº¤äº’æ•°æ®ã€‚æœ€åˆå§‹çš„æ•°æ®äº¤äº’æœºåˆ¶æ˜¯DMAï¼Œå®ƒå…è®¸è®¾å¤‡å’Œguestä¹‹é—´äº¤æ¢å¤§é‡å¤æ‚çš„æ•°æ®ã€‚ç”±äºæ•°æ®å¤„ç†éƒ¨åˆ†æ˜¯è®¾å¤‡é©±åŠ¨çš„ä¸»è¦code partï¼Œæ‰€ä»¥è¿™ä¸€éƒ¨åˆ†ä¹Ÿæ¯”åˆ«çš„éƒ¨åˆ†æ›´åŠ å±é™©ï¼Œæ›´å®¹æ˜“å—æ”»å‡»ã€‚</p>
<h3 id="2-3-æ ¸å¿ƒæŒ‘æˆ˜-åµŒå¥—çš„ç»“æ„ä½“"><a href="#2-3-æ ¸å¿ƒæŒ‘æˆ˜-åµŒå¥—çš„ç»“æ„ä½“" class="headerlink" title="2.3 æ ¸å¿ƒæŒ‘æˆ˜-åµŒå¥—çš„ç»“æ„ä½“"></a>2.3 æ ¸å¿ƒæŒ‘æˆ˜-åµŒå¥—çš„ç»“æ„ä½“</h3><p>â€‹	hypervisoræ˜¯è¢«ç”¨äºguest memoryå’Œè®¾å¤‡é©±åŠ¨äº¤äº’çš„ã€‚è¿™ç§è½¬æ¢æ“ä½œæ˜¯ç”¨ç‰¹å®šçš„å’ŒDMAç›¸å…³çš„APIï¼Œæ¯”å¦‚QEMUé‡Œçš„<code>pci_dma_read</code> å’Œ<code>pci_dma_write</code>ã€‚<code>pci_dma_read</code>ä»guestçš„å†…å­˜å¤åˆ¶äº†ä¸€ä¸ªblockçš„æ•°æ®åˆ°hostçš„bufferï¼Œwriteåˆ™ç›¸åã€‚é€šè¿‡æŒ‡å®šçš„åœ°å€å‚æ•°ï¼ŒDMAæ“ä½œå¯ä»¥è®¿é—®ä»»æ„ä½ç½®çš„guestçš„ç‰©ç†å†…å­˜ã€‚</p>
<p>â€‹	æˆ‘ä»¬è§‚å¯Ÿåˆ°é€šè¿‡DMAçš„æœºåˆ¶è®¿é—®çš„ä¸€äº›æ•°æ®ç»“æ„é€šå¸¸è¢«ç»„ç»‡æˆnested structuresã€‚<img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211122154306324.png" alt="image-20211122154306324"></p>
<p>â€‹	å¦‚å›¾ã€‚è¿™äº›ç»“æ„ä½“æœ‰å¾ˆå¤šç§ç±»å’Œå¾ˆå¤šå±‚ï¼Œæ‰€ä»¥hypervisoré€šè¿‡æ ‘å½¢ç»“æ„ç»„ç»‡è¿™äº›structureï¼Œè¿™äº›structureå¼€å§‹äºä¸€ä¸ªroot nodeã€‚è¿™äº›ç‰¹å®šå¯¼è‡´fuzzçš„ä¸€äº›é—®é¢˜ï¼š</p>
<p>â€‹	1ï¼‰Nested Form Constructionã€‚</p>
<p>å¯¹äºfuzzæ¥è¯´ï¼Œæ„å»ºå¤æ‚çš„å¤šå±‚æ•°æ®å¯¹è±¡äºç»“æ„ï¼Œæˆ–è€…å­ç»“æ„æ˜¯å¾ˆå›°éš¾çš„ï¼Œå› ä¸ºè¿™äº›å¯¹è±¡å¯ä»¥æ˜¯ä»»æ„å±‚æ¬¡çš„ã€‚å…¶ä¸€ï¼Œæ•°æ®çš„åˆ†å±‚ç»“æ„ï¼Œæ ‘çš„ç›¸äº’åµŒå¥—ç­‰ç­‰å¯¼è‡´çš„å¤æ‚ï¼Œfuzzæ–¹æ³•å¾ˆéš¾æ„é€ è¿™ç§æ•°æ®ï¼›å…¶äºŒï¼Œæ¯ä¸ªnodeå†…éƒ¨çš„æŒ‡é’ˆå’Œæ•°æ®çš„åç§»ä¹Ÿä¸æ˜¯å›ºå®šçš„ï¼Œè€Œfuzz mutatorä¼šæŠŠè¿™äº›nodeä¸€è§†åŒä»ï¼Œä»è€Œå¯¼è‡´ä¸å®¹æ˜“å˜å¼‚æ•°æ®ã€‚å¹¶ä¸”ä¹Ÿç”±äºç¼ºå°‘æ•°æ®è¯­ä¹‰ï¼ˆsemanticsï¼‰ï¼Œæ›´å¯¼è‡´äº†fuzzçš„å›°éš¾ã€‚</p>
<p>â€‹	2ï¼‰Node Type Awarenessã€‚</p>
<p>ç”±äºè®¾å¤‡æ ¹æ®è§„èŒƒæ”¯æŒå„ç§æ•°æ®ç±»å‹ï¼Œå› æ­¤éœ€è¦å…³äºåµŒå¥—èŠ‚ç‚¹çš„ç»†ç²’åº¦è¯­ä¹‰çŸ¥è¯†ã€‚ä¸åŒnodeä¹‹é—´çš„è¿æ¥ä¹Ÿæ˜¯å°¤ä¸ºé‡è¦ï¼Œæœ‰äº›è¿æ¥æ˜¯å›ºå®šçš„ï¼Œæ‰€ä»¥éœ€è¦æˆ‘ä»¬åœ¨nodeä¹‹ä¸­å»ºç«‹æ­£ç¡®çš„è¿æ¥æ–¹å¼ã€‚æœ‰äº›æŒ‡é’ˆå…³ç³»ç”šè‡³å¯èƒ½åœ¨è¿è¡Œæ—¶å€™æ‰çŸ¥é“ï¼Œå› ä¸ºå¾ˆå¤šfieldå¯ä»¥æŒ‡å‘ä¸åŒç§ç±»çš„æ•°æ®ã€‚æ‰€ä»¥åœ¨node levelï¼Œfuzzeréœ€è¦çŸ¥é“å…·ä½“çš„æŒ‡é’ˆè¯­ï¼Œä»è€Œèƒ½å¤Ÿæ„é€ æ­£ç¡®çš„æ•°æ®ç»“æ„ï¼Œè¿›å…¥æ·±å±‚æ¬¡çš„fuzzï¼Œè€Œä¸æ˜¯åœ¨ç¨‹åºå¼€å§‹é˜¶æ®µå°±å¯¼è‡´crashã€‚</p>
<p>â€‹	ä¸ºäº†æ›´å¥½çš„è¯´æ˜è¿™äº›nested structureæ˜¯å¦‚ä½•è¢«hypervisoræ”¯æŒçš„ï¼Œæ¥ä¸‹æ¥è®²ä¸€äº›hypervisorå¤„ç†nested structureçš„é€šå¸¸æƒ…å†µã€‚</p>
<p>â€‹	1ï¼‰ä»rootèŠ‚ç‚¹å¼€å§‹ï¼Œhypervisorå¼€å§‹è·å¾—äº†ä¸€ä¸ªæŒ‡é’ˆï¼ˆä¸€èˆ¬ç”±address registerè·å¾—ï¼‰ï¼Œè¯¥æŒ‡é’ˆæŒ‡å‘ä¸€ä¸ªå¤„ç†guest memoryä¸­çš„æ•°æ®ç»“æ„ Aã€‚</p>
<p>â€‹	2ï¼‰hyervisoråŠ¨æ€åœ°allocate buffï¼Œè¯¥buffæ˜¯ç”¨ä»¥å­˜å‚¨Açš„å‰¯æœ¬ã€‚</p>
<p>â€‹	3ï¼‰hypervisor é€šè¿‡pci_dma_readæ‹·è´Aåˆ°buffä¸­ã€‚</p>
<p>â€‹	4ï¼‰å½“Aä¸­æœ‰æŒ‡é’ˆæŒ‡å‘åˆ«çš„ç»“æ„Bçš„æ—¶å€™ï¼Œhypervisorç”¨åŒæ ·çš„æ–¹æ³•ï¼Œæ„é€ ä¸€ä¸ªå‰¯æœ¬Bçš„buffã€‚</p>
<p>â€‹	5ï¼‰å†æ¬¡åˆ©ç”¨pci_dma_readæ‹·è´Båˆ°buffä¸­ã€‚</p>
<p>å¦‚æ­¤åå¤ï¼Œä»è€Œé€’å½’åœ°è·å–ä¸€ä¸ªstructureã€‚ç„¶åç”¨ä¸Šå›¾åšä¸€ä¸ªä¾‹å­ã€‚</p>
<p>ä¸€ä¸ªç›´è§‚åœ°æ–¹æ³•æ¥å¤„ç†è¿™äº›æ•°æ®ç»“æ„å°±æ˜¯ç”¨structure-aware fuzzingã€‚è¿™äº›æ–¹æ³•éœ€è¦å¼€å‘è€…æ„é€ ä¸€ä¸ªè§„èŒƒçš„æ¨¡å‹ã€‚å¹¶ä¸”è¿˜éœ€è¦æŠŠè¿™äº›æ•°æ®ç»“æ„è¿æ¥èµ·æ¥ï¼Œæ‰€ä»¥ä¼šå¾ˆè´¹æ—¶ï¼Œå¹¶ä¸”è¿˜å®¹æ˜“å‡ºé”™ã€‚å¹¶ä¸”è¿™äº›æ•°æ®ç»“æ„çš„SPECä¹Ÿå¾ˆåºå¤§ï¼Œéœ€è¦å¤§é‡å·¥ä½œæ¥å®šä¹‰ã€‚æ‰‹å·¥çš„å·¥ä½œä¹Ÿå¾ˆå®¹æ˜“å‡ºé”™ã€‚å¹¶ä¸”å¼€å‘äººå‘˜å¯èƒ½ä¼šå¢åŠ æ–°çš„æœºåˆ¶ï¼Œå› æ­¤è¿™äº›æ–¹æ³•éƒ½ä¸å¤ªé€‚åˆå¤§èŒƒå›´çš„hypervisor fuzzã€‚</p>
<h2 id="3-V-SHUTTLE-DESIGN"><a href="#3-V-SHUTTLE-DESIGN" class="headerlink" title="3. V-SHUTTLE DESIGN"></a>3. V-SHUTTLE DESIGN</h2><p>V-shuttleæ˜¯ä¸€ä¸ªè½»é‡çº§çš„ï¼Œå¯åº¦é‡çš„ï¼Œè¯­ä¹‰æ„ŸçŸ¥çš„hypervisor fuzz framworkï¼Œå¹¶ä¸”ç»“åˆäº†civerage-guided fuzzå’Œé™æ€åˆ†æã€‚ä¸ºäº†å®šä½å‰é¢æ‰€è¯´çš„challenge, V-shuttleç”¨äº†ä¸¤ç§æ–¹æ³•ï¼š1ï¼‰é‡å®šå‘DMAç›¸å…³çš„å‡½æ•°ã€‚2ï¼‰é€šè¿‡seedpoolsçš„è¯­ä¹‰æ„ŸçŸ¥fuzzã€‚</p>
<h3 id="3-1-Threat-model"><a href="#3-1-Threat-model" class="headerlink" title="3.1 Threat model"></a>3.1 Threat model</h3><p>å‡è®¾æ”»å‡»è€…æ˜¯ä¸€ä¸ªprivileged guest userï¼ŒåŒæ—¶æ‹¥æœ‰VMå†…çš„æ‰€æœ‰å†…å­˜æƒé™ï¼Œç”±æ­¤å¯ä»¥å‘deviceè¾“é€äºŒè¿›åˆ¶æ•°æ®ã€‚</p>
<h3 id="3-2-System-overview"><a href="#3-2-System-overview" class="headerlink" title="3.2 System overview"></a>3.2 System overview</h3><p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123195225888.png" alt="image-20211123195225888"></p>
<p>å®ƒåˆ©ç”¨é›†æˆåœ¨hypervisorä¸­çš„fuzzä»£ç†ï¼Œå‘è™šæ‹Ÿè®¾å¤‡å–‚æµ‹è¯•æ•°æ®ï¼ŒæŒç»­å‘è™šæ‹Ÿè®¾å¤‡å‘é€è¯»å†™è¯·æ±‚ã€‚ä¸»è¦ç”±ä¸¤éƒ¨åˆ†ï¼Œfuzzerå’Œfuzzing agentã€‚</p>
<h4 id="fuzzer"><a href="#fuzzer" class="headerlink" title="fuzzer"></a>fuzzer</h4><p>fuzzeråœ¨hypervisorä¹‹å¤–ï¼Œå¹¶ä¸”å¯ç”¨æŒä¹…æ¨¡å¼ï¼Œå³ä¸ç”¨æ¯æ¬¡æµ‹è¯•éƒ½æ–°å¯åŠ¨ä¸€ä¸ªæ–°çš„å®ä¾‹ã€‚å› ä¸º1ï¼‰é‡å¯ä¸€ä¸ªhypervisorè¿›ç¨‹æˆ–è€…æ¢å¤ä¸€ä¸ªå¿«ç…§æ˜¯æœ‰å¼€é”€çš„ã€‚2ï¼‰hypervisoræ˜¯event-based systemï¼Œå®ƒè®¾è®¡çš„ç›®çš„å°±æ˜¯é•¿æ—¶é—´çš„äº¤äº’ã€‚å¹¶ä¸”å¤§å¤šæ•°çš„BUGæ˜¯é€šè¿‡å¯¹å·²å‘ç°çš„åˆ†æ”¯è¿›è¡Œæ·±å±‚æ¬¡çš„fuzzå‘ç°çš„ï¼Œè¿™äº›æ·±å±‚æ¬¡çŠ¶æ€å¾ˆå¯èƒ½ä¾èµ–äºä¹‹å‰å¾ˆå¤šçŠ¶æ€çš„äº¤äº’æ„å»ºå‡ºæ¥çš„ã€‚</p>
<h4 id="fuzzing-agent"><a href="#fuzzing-agent" class="headerlink" title="fuzzing agent"></a>fuzzing agent</h4><p>å®ƒæ˜¯è¢«æ”¾ç½®åœ¨hypervisorä¸­çš„æ ¸å¿ƒç»„ä»¶ã€‚1ï¼‰é©±åŠ¨fuzzing loopå’Œï¼ˆfuzzer å’Œ deviceï¼‰çš„äº¤äº’ ã€‚2ï¼‰ç®¡ç†DMA&#x2F;MMIO çš„ä¸Šä¸‹æ–‡åˆ†é…ã€‚ä¸ºäº†é€‚åº”ä¼ ç»Ÿçš„application-fuzzçš„æ–¹æ³•ã€‚æŠŠguest systemä¸­çš„æ•°æ®äº¤äº’é‡å®šå‘åˆ°äº†fuzzed inputä¸­ã€‚ç„¶åfuzzing agentæ¨¡æ‹Ÿæ”»å‡»è€…æ§åˆ¶çš„æ¶æ„guest kernel driverï¼Œæ‹¦æˆªæ‰€æœ‰deviceå‘å‡ºçš„DMAå’ŒIO è¯»å†™æŒ‡ä»¤ï¼Œæ‰€æœ‰ä»hypervisorçš„è¯»å†™æ“ä½œéƒ½è¢«å‘é€åˆ°äº†ä¸€ä¸ªfuzzing agentä¸­çš„æ³¨å†Œå‡½æ•°é‡Œã€‚è¯¥æ³¨å†Œå‡½æ•°ä¼šæ‰§è¡Œæ“ä½œå¹¶è¿”å›fuzzç”Ÿæˆçš„æ•°æ®ç»™deviceã€‚æ‰€ä»¥å¢åŠ æ–°è®¾å¤‡çš„æ—¶å€™ï¼Œæ²¡å¿…è¦é¢å¤–çš„laborï¼Œå› ä¸ºå®ƒæ˜¯åµŒå…¥åœ¨hypervisorä¸­çš„ã€‚</p>
<h3 id="3-3-DMA-é‡å®šå‘"><a href="#3-3-DMA-é‡å®šå‘" class="headerlink" title="3.3 DMA é‡å®šå‘"></a>3.3 DMA é‡å®šå‘</h3><p>ç”±äºç»™å¤§é‡çš„deviceåˆ›å»ºåˆæ³•çš„æ•°æ®ç»“æ„å·¥ä½œé‡å¾ˆå¤§ï¼Œå¹¶ä¸”å¾ˆå¤æ‚ï¼Œæ‰€ä»¥è®¾è®¡äº†DMAé‡å®šå‘çš„æ–¹æ³•ã€‚é€šè¿‡æ‹¦æˆªè®¾å¤‡è¯·æ±‚guest memoryï¼Œæ¥æ‰å¹³åŒ–åµŒå¥—ç»“æ„ã€‚ä»–æŠŠDMAä¼ è¾“è½¬åŒ–æˆfuzz inputçš„è¯»å–ï¼Œå³æŠŠæ‰€æœ‰çš„DMAç›¸å…³çš„APIä¸­ä»¥åŠä»–ä»¬çš„åŒ…è£…å‡½æ•°ä¸­éƒ½æ’å…¥å®ï¼Œä»è€Œæ‰€æœ‰çš„APIéƒ½è¢«æ›¿æ¢æˆä»æ–‡ä»¶ä¸­è¯»å–æ•°æ®ï¼Œä»è€Œæ˜¯è¯»å–fuzzing inputã€‚ä¸‹å›¾ç»™äº†ä¸ªä¾‹å­ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123201912737.png" alt="image-20211123201912737"></p>
<p>è€Œå…³æ³¨äºDMAæ˜¯å› ä¸ºä»–ä»¬è´Ÿè´£guestå’Œhostä¹‹é—´çš„æ•°æ®äº¤äº’ï¼Œä¹Ÿæ˜¯æ„å»ºè¿™äº›åµŒå¥—æ•°æ®ç»“æ„çš„å…³é”®æœºåˆ¶ã€‚åŒæ—¶è¿™æ ·ä¹Ÿæ¶ˆé™¤äº†DMAçš„å¯»å€æ“ä½œã€‚å¹¶ä¸”ç”±äºå®Œå…¨æ§åˆ¶DMAæœºåˆ¶ï¼Œä»»ä½•çš„DMAè¯·æ±‚éƒ½èƒ½å¤Ÿç”¨ä¼ ç»Ÿcoverage-guided fuzzerï¼Œä¸è®ºæ•°æ®ç»“æ„ä¸­çš„æŒ‡é’ˆæŒ‡å‘å“ªé‡Œï¼Œå³ä½¿ä»–ä»¬æ˜¯0. ä»å›¾ä¸Šå¯ä»¥çœ‹å‡ºåŸæœ¬éœ€è¦buffer_addrï¼Œç°åœ¨åªéœ€è¦ä»æ–‡ä»¶ä¸­è¯»å–ï¼Œæ‰€ä»¥ä»»æ„åœ°å€éƒ½è¡Œã€‚å¹¶ä¸”V-shuttleåªæ˜¯æ“ä½œè®¾å¤‡ä»guestä¸­è¯»å–çš„æ•°æ®ï¼Œå¹¶ä¸ç®¡å†™å…¥çš„æ•°æ®ï¼Œå› ä¸ºä¸€èˆ¬æ¥è¯´æ”»å‡»è€…éƒ½æ˜¯å‘è®¾å¤‡æ¥inputä¸€äº›æ•°æ®æ¥æ”»å‡»çš„ï¼Œæ‰€ä»¥ä¸ç®¡ä»–ä»¬æ”¶åˆ°çš„ã€‚</p>
<p>å½“æ”¶åˆ°deviceå‘guest memoryä¸­çš„read è¯·æ±‚ï¼š</p>
<p>â€‹	1ï¼‰V-thuttleç¡®ä¿DMAè¯»å–å‡½æ•°è°ƒç”¨æºè‡ªäºæ­£åœ¨ç›‘è§†çš„ç›®æ ‡è®¾å¤‡ï¼Œå› ä¸ºå¯¹å…¶ä»–æ¥è‡ªç³»ç»Ÿç»„ä»¶çš„DMAä¼ è¾“è¯·æ±‚ä¸æ„Ÿå…´è¶£ï¼Œè¿™äº›è¯·æ±‚ä¸å—guestæ§åˆ¶ã€‚<br>â€‹	2ï¼‰ç»™å®šçš„host çš„bufferå’Œ buffer sizeï¼ŒV-shuttleä»seed fileä¸­é€‰å®šé€‚åˆçš„æ•°æ®ï¼Œè€Œä¸æ˜¯å»è¯»guest å†…å­˜ã€‚ä¸‹å›¾ç»™äº†å¤§è‡´ç¤ºæ„å›¾</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123202951628.png" alt="image-20211123202951628"></p>
<p>ç›¸æ¯”äºä¼ ç»Ÿçš„åœ¨guestä¸­æ„å»ºæ•°æ®ç»“æ„ï¼ŒV-shuttleä»hypervisorä¸­æ„å»ºæµ‹è¯•æ•°æ®ï¼Œä»è€ŒæŠŠæ‰€æœ‰çš„å¤šç»´æ•°æ®ç»“æ„å˜æˆäº†ä¸€ç»´ï¼Œå¹¶ä¸”ä¿è¯äº†nested structureçš„è¯­ä¹‰ã€‚è¿™æ ·æ‰€æœ‰çš„åº•å±‚ä»£ç éƒ½å¯ä»¥è®¿é—®ã€‚å¯¹äºæ¯ä¸€æ¬¡çš„æ¨¡ç³Šè¿­ä»£ï¼Œæ¨¡ç³Šå™¨å¼•æ“é¦–å…ˆé€šè¿‡çªå˜çš„æ–¹å¼ç”ŸæˆDMAæ•°æ®åºåˆ—ï¼Œç„¶åè®¾å¤‡å¼€å§‹éå†æ ‘ï¼Œç„¶åæ¯ä¸ªDMAè¯·æ±‚éƒ½ä»fileä¸­è·å–inputã€‚æ¶ˆé™¤äº†æ¯ä¸ªèŠ‚ç‚¹ä¸­çš„æŒ‡é’ˆï¼ŒåŒæ—¶ä»ç„¶ä¿æŒæ¯ä¸ªèŠ‚ç‚¹éšå«çš„æŒ‡é’ˆä¾èµ–ä¿¡æ¯ï¼Œæ‰€ä»¥è¿™ä¸ä¼šç ´åè®¾å¤‡çš„æ­£å¸¸è¿›è¡Œã€‚</p>
<h3 id="3-4-Semantics-Aware-Fuzzing-via-SeedPools"><a href="#3-4-Semantics-Aware-Fuzzing-via-SeedPools" class="headerlink" title="3.4 Semantics-Aware Fuzzing via SeedPools"></a>3.4 Semantics-Aware Fuzzing via SeedPools</h3><p>ä½†æ˜¯ä¸Šé¢çš„æ–¹æ³•ä¹Ÿå­˜åœ¨ä¸€ä¸ªé—®é¢˜ï¼Œå°±æ˜¯å®ƒå¹¶æ²¡æœ‰æŠŠnode typeç»™è€ƒè™‘è¿›å»ï¼Œæ‰€ä»¥æ•ˆç‡ä¼šæ¯”è¾ƒä½ã€‚è€Œä¸”æœ‰äº›node typeæ˜¯åŠ¨æ€å†³å®šçš„ï¼Œæ‰€ä»¥æœ‰äº›æ—¶å€™æ§åˆ¶æµä¹Ÿæ˜¯åŠ¨æ€æ”¹å˜çš„ã€‚å¹¶ä¸”ä¸€äº›èŠ‚ç‚¹ä¹‹é—´è¿æ¥çš„è¯­ä¹‰ä¹Ÿå¾ˆå®¹æ˜“åœ¨è¿­ä»£çš„æ—¶å€™æ¶ˆå¤±ã€‚ï¼ˆæœ‰ä¸ªä¾‹å­æ²¡çœ‹æ‡‚ï¼‰ï¼Œç„¶åå°±ç»™æ¯ä¸ªfuzzæ•°æ®åŠ äº†ä¸€ä¸ªtype_idï¼Œè¿™æ ·åŒä¸€ç±»çš„nodeå°±å¯ä»¥æ›´å¥½çš„å¼‚å˜è¿­ä»£ã€‚å¦‚ä¸‹å›¾ï¼ŒæŠŠæ¥å£ä¸­åŠ äº†ä¸€ä¸ªå‚æ•°ã€‚</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123205350914.png" alt="image-20211123205350914"></p>
<p>ç”±æ­¤ï¼Œå°±èƒ½å¤ŸæŠŠæ•°æ®ç»“æ„ä¹‹é—´è¿›è¡Œè§£è€¦åˆï¼Œç„¶åæ¯ä¸ªç»“æ„çš„æ•°é‡åˆæ˜¯æœ‰é™çš„ï¼Œæ‰€ä»¥ç‹¬ç«‹åœ°è¿›è¡Œgenerateã€‚</p>
<p>1ï¼‰å¯¹DMAå¯¹è±¡è¿›è¡Œé™æ€åˆ†æã€‚å¤§æ¦‚å°±æ˜¯backward data flow analysisï¼ˆä»–ä»¬callè¿™ä¸ªå«live-variable analysisï¼‰ï¼Œé€šè¿‡ä¸€äº›å‡½æ•°ï¼ˆæ¯”å¦‚pic_dma_readï¼‰ï¼Œå»åå‘æ‰¾è¿™äº›æ•°æ®çš„typeã€‚ï¼ˆè¿™å—å±å®ä¸æ˜¯æˆ‘çš„é•¿é¡¹ï¼Œå°±è´´åŸæ–‡æŠŠ<br>Therefore, we define a DMA object as a hostâ€™s structure that holds the copy of the guestâ€™s data through DMA. Each DMA object represents a unique type of node. Aiming to label all the DMA objects, V-Shuttle performs static analysis on the hypervisorâ€™s source code. In particular, V-Shuttle utilizes a live-variable analysis, which is a special type of data flow analysis. Considering the hostâ€™s buffer field of DMA operations (e.g., pci_dma_read, and its wrapped function) as the source, we do the backward data flow analysis from the source to its declaration or definition (the DMA object). After collecting all the DMA objects, we assign unique IDs to each of them. These labeled objects help us identify the node type of each DMA request at runtime and ensure that each type of DMA object can be correctly groupedï¼‰</p>
<p>2ï¼‰é€šè¿‡æ¯æ¬¡è¯»å–inputå¢åŠ çš„type_idè¿›è¡Œç‰¹å®šçš„è¯»å–ã€‚</p>
<p>3ï¼‰åŒæ—¶ä¸ºäº†è§£å†³å¤šç§ç±»å‹çš„inputï¼Œå°±æ‰©å±•äº†AFLï¼Œå¢åŠ äº†seedpoolï¼Œè¿™æ ·å°±fuzzeråœ¨æ¯ä¸ªseed queueä¸Šå˜å¼‚ï¼Œç”±æ­¤å¯¹æ¯ä¸ªtypeçš„structureå•ç‹¬å˜å¼‚å‡ºinputã€‚ç„¶åæ ¹æ®coverageçš„feedbackåé¦ˆï¼Œå°±fuzzingå°±å¯ä»¥çŸ¥é“å¦‚ä½•ç»™æ¯ä¸€ç§ç±»å‹çš„typeå˜å¼‚ç”Ÿæˆinputã€‚</p>
<p>4ï¼‰è¯­ä¹‰æ„ŸçŸ¥ fuzzingè¿‡ç¨‹ã€‚ä¼ªç®—æ³•å¦‚ä¸‹ï¼š</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123221219163.png" alt="image-20211123221219163"></p>
<p>è¿™é‡Œç»™äº†ä¸€ä¸ªexampleï¼šUSB-UHCIï¼š</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123221601596.png" alt="image-20211123221601596"></p>
<h3 id="3-5-lightweight-fuzzing-loop"><a href="#3-5-lightweight-fuzzing-loop" class="headerlink" title="3.5 lightweight fuzzing loop"></a>3.5 lightweight fuzzing loop</h3><p>è¿‡å»çš„æ–¹å¼é€šè¿‡åœ¨guest osä¸­å¢åŠ ä»£ç†æ¥å®ç°ï¼Œè¿™æ ·åœ¨vmexitçš„æ—¶å€™ä¼šé€ æˆå¾ˆå¤§çš„å¼€é”€ï¼Œä½†æ˜¯æ­¤æ–¹æ³•ä¸ä¼š</p>
<p><strong>ç¯å¢ƒä¸»è¦åŠŸèƒ½æ¨¡å‹</strong>ï¼š</p>
<p><img src="https://raw.githubusercontent.com/unsatisfying/picture-server/main/img/image-20211123222556008.png" alt="image-20211123222556008"></p>
<h2 id="5-evaluation"><a href="#5-evaluation" class="headerlink" title="5 evaluation"></a>5 evaluation</h2><p>æµ‹è¯•äº†Qemu5.1.0å’ŒVirtualBox6.1.14ï¼Œ</p>
]]></content>
      <categories>
        <category>paper</category>
      </categories>
      <tags>
        <tag>virtualization</tag>
      </tags>
  </entry>
</search>
